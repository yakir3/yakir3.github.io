{"meta":{"version":1,"warehouse":"4.0.1"},"models":{"Asset":[{"_id":"themes/next/source/404.html","path":"404.html","modified":0,"renderable":1},{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/js/algolia-search.js","path":"js/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/bookmark.js","path":"js/bookmark.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/local-search.js","path":"js/local-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/images/android-chrome-192x192.png","path":"images/android-chrome-192x192.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/android-chrome-512x512.png","path":"images/android-chrome-512x512.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon.png","path":"images/apple-touch-icon.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.jpg","path":"images/avatar.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/images/background.jpeg","path":"images/background.jpeg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16.png","path":"images/favicon-16x16.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32.png","path":"images/favicon-32x32.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon.ico","path":"images/favicon.ico","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/lib/anime.min.js","path":"lib/anime.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/pisces.js","path":"js/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/LICENSE","path":"lib/pace/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/README.md","path":"lib/pace/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","path":"lib/pace/pace-theme-barber-shop.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","path":"lib/pace/pace-theme-big-counter.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","path":"lib/pace/pace-theme-bounce.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","path":"lib/pace/pace-theme-center-atom.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","path":"lib/pace/pace-theme-center-circle.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","path":"lib/pace/pace-theme-center-radar.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","path":"lib/pace/pace-theme-center-simple.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","path":"lib/pace/pace-theme-corner-indicator.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","path":"lib/pace/pace-theme-fill-left.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","path":"lib/pace/pace-theme-flash.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-flat-top.min.css","path":"lib/pace/pace-theme-flat-top.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","path":"lib/pace/pace-theme-loading-bar.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","path":"lib/pace/pace-theme-mac-osx.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-material.min.css","path":"lib/pace/pace-theme-material.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","path":"lib/pace/pace-theme-minimal.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/pace/pace.min.js","path":"lib/pace/pace.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/all.min.css","path":"lib/font-awesome/css/all.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","path":"lib/font-awesome/webfonts/fa-brands-400.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","path":"lib/font-awesome/webfonts/fa-solid-900.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","path":"lib/font-awesome/webfonts/fa-regular-400.woff2","modified":0,"renderable":1},{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0}],"Cache":[{"_id":"source/_data/footer.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1651584022236},{"_id":"source/_posts/alicloud-ram-sts/ram3.png","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1651584022283},{"_id":"source/CNAME","hash":"d51215c5b96a0da78f3308a910cdce7d308f31cb","modified":1724935490658},{"_id":"source/404/index.md","hash":"8078cc5eedf9fabf7b3a01b1b53de6875de460e7","modified":1724935503324},{"_id":"source/_data/variables.styl","hash":"299faf0840683fe8c7dd03a6b5a1a19b17a78a50","modified":1651584022236},{"_id":"source/_data/styles.styl","hash":"5464f2cffbf3c43f263b50e9b78295ecfd0e4f3f","modified":1651584022236},{"_id":"source/about/index.md","hash":"ffe179638a71cebe2e2d690fa0ef257e8980b5f6","modified":1651584022289},{"_id":"source/musiclist/index.md","hash":"5559c04d7214d767e6d72a5b02b9f8fb1ff06ef1","modified":1651584022289},{"_id":"source/categories/index.md","hash":"bb2c12cfe473b1b2307363df8645fd8f0765fbda","modified":1651584022289},{"_id":"source/tags/index.md","hash":"84321ecec46e86680db98ff973026bb4a4347d93","modified":1651584022289},{"_id":"source/_posts/First-Article.md","hash":"d51dec81dbea0d7b99ee1a1a7d7038b2b6fcfb35","modified":1705850923148},{"_id":"source/_posts/alicloud-vpc.md","hash":"4d6c44f51a8ea484d29e7a7b7c7fe0ec40ee278a","modified":1705851068717},{"_id":"source/_posts/docker.md","hash":"fbe66c696d1b0cfcb8fcdb73a3be0e44880fee48","modified":1705851220702},{"_id":"source/_posts/gatewayGrayRelease.md","hash":"31652f43911c4393452edb8f6760e2b09ae39ea9","modified":1705850957071},{"_id":"source/_posts/alicloud-ack-sls-deploy.md","hash":"d9a9c759b1944b796e6870cf3f5771cae43ebf56","modified":1705850923149},{"_id":"source/_posts/alicloud-ram-sts.md","hash":"2cec9abec7496ecd7b55a36c3240cafa57fb3472","modified":1705851092930},{"_id":"source/_posts/git-flow.md","hash":"bcb5241410542e1533befb37fe5a1a3911b25a4b","modified":1705850923152},{"_id":"source/_posts/k8s-ack-learn.md","hash":"a936263d2fcd209f9099d4469e23326d38aa6ebc","modified":1705850923153},{"_id":"source/_posts/helm-deploy.md","hash":"7cb29b61ac268c774e09c6f1a5804f7718e97a43","modified":1705850923152},{"_id":"source/_posts/k8s-rbac.md","hash":"c666c3095387898bbbaafb07318b6961967d08f5","modified":1705850923155},{"_id":"source/_posts/k8s-networkpolicy.md","hash":"01e8e271dbef7aa0fbdfc6c92bc2dde56a9e4ca4","modified":1705851000082},{"_id":"source/_posts/.DS_Store","hash":"7635756b78eb8de40954402fd8d57154a4a72644","modified":1654010449392},{"_id":"source/_posts/kube-eventer.md","hash":"ebe7d74fe4a18e6b324023d76d3b5d2e8c8c3707","modified":1705850923156},{"_id":"source/_posts/observability-fluentd-component.md","hash":"3fcfecdb6b31e09d8490bd2a56ca45e996353224","modified":1705850923158},{"_id":"source/_posts/observability-prometheus-component.md","hash":"93181a61d9712cf682d6e2d48cb4f1a3d769de65","modified":1705850923159},{"_id":"source/_posts/prometheus-grafana-notice.md","hash":"ab282d9fb123fe35af2c4a17afd279fbe95c9920","modified":1705851017732},{"_id":"source/_posts/rabbitmq.md","hash":"429a5392ea04fe323abdb5335d0f3444bfbe681f","modified":1705850923161},{"_id":"source/_posts/ubuntuk8sdeploy.md","hash":"c94077952f0352c0c615b32f9e7ec83ee5a623cb","modified":1705850923162},{"_id":"source/_posts/k8s-network.md","hash":"24f889fcb858471ef961385945e89e54c15c57af","modified":1705850923154},{"_id":"source/_posts/openssl-basic.md","hash":"373e45cf42020ab413b9c547a71308cfe640e232","modified":1705850923160},{"_id":"source/_posts/k8s-network/k8s-nw2.png","hash":"69e0e6620d6d22f2b648b709a49b8dd35041b330","modified":1675869690477},{"_id":"source/_posts/k8s-network/k8s-nw1.png","hash":"391065f8d0bb31b5532d644ef00754cc784cc07d","modified":1675869677601},{"_id":"source/_posts/k8s-network/k8s-nw3.png","hash":"947cc0578cae966815d91c328c6c7d28daf5dff0","modified":1675869696507},{"_id":"source/_posts/k8s-network/k8s-nw8.png","hash":"bbbfb00a31db94cb4ee22af8f05282601eec5681","modified":1675869727798},{"_id":"source/_posts/k8s-ack-learn/.DS_Store","hash":"1a61ae9dbef0d9879707cd241742be82601c8bf6","modified":1654010619084},{"_id":"source/_posts/k8s-ack-learn/k8s4.png","hash":"6aa83ddbf3e30faf0470132a1eed2082d59ef9f9","modified":1653920162553},{"_id":"source/_posts/rabbitmq/rbmq3.png","hash":"18703c0eaba69f5c3ffe7ac1974f2942f94aabb7","modified":1654518818846},{"_id":"source/_posts/rabbitmq/rbmq5.png","hash":"66b61a85a11a414b98118a09f7802fe63cb2b6ed","modified":1654518818847},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls10.png","hash":"2f8532ccf93fca2a54aeb0b7aa065b470aa482ec","modified":1653920126350},{"_id":"source/_posts/git-flow/gf3.png","hash":"e7d9aa0ab06fc65ae32203b98a354baa1cace26e","modified":1651670077948},{"_id":"source/_posts/helm-deploy/helm3.png","hash":"d3c7998f0a1eea7a45b89f7501d8c0c2184d91d2","modified":1651671979708},{"_id":"source/_posts/helm-deploy/helm2.png","hash":"6f9e17f844e5d17aad5496b36c36e0ff4b361d06","modified":1651671979708},{"_id":"source/_posts/k8s-network/k8s-nw6.png","hash":"044a7ba37a744ebad84deb2218c6540872f34278","modified":1675869715825},{"_id":"source/_posts/k8s-rbac/634be995b5bc.png","hash":"9f543f1ed29803038c5466b3046b48f4f46bb412","modified":1651584022239},{"_id":"source/_posts/k8s-ack-learn/k8s2.png","hash":"a302084342d68c89523f7f689a43ae4767a06c19","modified":1653920171784},{"_id":"source/_posts/observability-fluentd-component/fluent1.png","hash":"8e69e636606804c0dae89683e378d425d52bd912","modified":1657547848157},{"_id":"source/_posts/observability-fluentd-component/fluent3.png","hash":"85db7a11048d6c414d02544b8fbb7c21aae64054","modified":1657547848159},{"_id":"source/_posts/observability-fluentd-component/fluent4.png","hash":"96055366019a53214a52f767312f703fce248703","modified":1657547848160},{"_id":"source/_posts/prometheus-grafana-notice/2.png","hash":"756e78903b14556b0235e5f6f37fc7e0ac639370","modified":1651584022271},{"_id":"source/_posts/rabbitmq/rbmq1.png","hash":"f30671f3bfb12fb7a34404a22f643a11002390bb","modified":1654518818843},{"_id":"source/_posts/rabbitmq/rbmq10.png","hash":"f1a32d7f9c94def34fc8b104e29e6f43a00e41fa","modified":1654518818843},{"_id":"source/_posts/rabbitmq/rbmq11.png","hash":"441c484b202c39a5b77f401cad6b4a089697702d","modified":1654518818844},{"_id":"source/_posts/rabbitmq/rbmq12.png","hash":"44dc4f502174980bb2b10a00026a1dc6f92cba87","modified":1654518818845},{"_id":"source/_posts/rabbitmq/rbmq4.png","hash":"a3cfcf7bbb46f44c1671443a440366e9520c80cf","modified":1654518818846},{"_id":"source/_posts/rabbitmq/rbmq7.png","hash":"2dea294cb0dc369002f2872455223978f1f7b2c9","modified":1654518818848},{"_id":"source/_posts/alicloud-vpc/vpc1.png","hash":"15bfeea34245e4f5510c5e157070ca032e711ceb","modified":1651679770021},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls12.png","hash":"a3a6908911b93afe3c68cff3026b3334ab457bb1","modified":1653920140862},{"_id":"source/_posts/git-flow/gf12.png","hash":"0a5e4f151242bc29662a43161454b7f2d161458d","modified":1651670077945},{"_id":"source/_posts/git-flow/gf15.png","hash":"54182efd66a40daa1d36b580052edbb296cd8ab2","modified":1651670077947},{"_id":"source/_posts/rabbitmq/rbmq9.png","hash":"1c76e0c1d88db133937bd3f3912a277d830941f6","modified":1654518818849},{"_id":"source/_posts/git-flow/gf8.png","hash":"07444a7a4bbe315081f434a30678f0cc39ba2474","modified":1651670077952},{"_id":"source/_posts/helm-deploy/helm4.png","hash":"bc6b76c4aaf08c5776f11fbf996cc186a7047382","modified":1651671979709},{"_id":"source/_posts/k8s-networkpolicy/2afdc3d69fa9.png","hash":"ee2ec4d29d2516159aeeea040d6f7ddc5f07718f","modified":1651584022251},{"_id":"source/_posts/k8s-network/k8s-nw7.png","hash":"97626dafbe2d67b3f8943cebb33174b4bfe0d790","modified":1675869721653},{"_id":"source/_posts/k8s-ack-learn/k8s1.png","hash":"9547deb721fcaaed961f6ef664dfc950a04fc8f7","modified":1653920177727},{"_id":"source/_posts/k8s-ack-learn/k8s3.png","hash":"18aa943783a1351824bbdb78ae3e0127a9390c42","modified":1653920162163},{"_id":"source/_posts/observability-fluentd-component/fluent2.png","hash":"545be7c6e1000b1ecaf45326bcbe356be3c77110","modified":1657547848158},{"_id":"source/_posts/prometheus-grafana-notice/10.png","hash":"98ebeaf917ff2eaa08e1461eb93ff99b8bbac6cd","modified":1651584022257},{"_id":"source/_posts/prometheus-grafana-notice/8.png","hash":"368f23564344b0e005ccd37d8979488b72214257","modified":1651584022279},{"_id":"source/_posts/rabbitmq/rbmq2.png","hash":"4a7e45905a42332b23da28402bcc306af55b2bf6","modified":1654518818845},{"_id":"source/_posts/alicloud-vpc/vpc2.png","hash":"7ccbcbba992ce1eb64b025e48ff00eeec47884a5","modified":1651679770021},{"_id":"source/_posts/rabbitmq/rbmq6.png","hash":"43c99df943628a5272bd83313f78b3043c3ab388","modified":1654518818847},{"_id":"source/_posts/alicloud-ram-sts/ram2.png","hash":"99f25eec2df909cc9e07d7195c342624b50d58d8","modified":1651584022283},{"_id":"source/_posts/alicloud-ram-sts/ram8.png","hash":"740b8967bcc256d5247207e83af79e11221d24be","modified":1651584022289},{"_id":"source/_posts/alicloud-ram-sts/ram6.png","hash":"781469a74ebe155ab4a9ca08eb0023482ff3297e","modified":1651584022287},{"_id":"source/_posts/rabbitmq/rbmq8.png","hash":"0185b410014d47066a51e10f8ac7555e5081beab","modified":1654518818848},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls11.png","hash":"31a758e6e7e9a06a35ae0265bd84aedc708661a3","modified":1653920109284},{"_id":"source/_posts/git-flow/gf4.png","hash":"29ca4a085f45728fc270a44e40cd151adfba1a8a","modified":1651670077950},{"_id":"source/_posts/git-flow/gf5.png","hash":"2c349dd6d441189d569759b2152fb4f71e77791d","modified":1651670077950},{"_id":"source/_posts/k8s-network/k8s-nw5.png","hash":"61528716079e575ffab68afecd42eb64e3b3b0ef","modified":1675869710256},{"_id":"source/_posts/k8s-rbac/1572c2ebc891.png","hash":"57f775f88760fdcea12d1143ec21d682960c9e52","modified":1651584022237},{"_id":"source/_posts/k8s-rbac/c31775e8bbe3.png","hash":"a58d8da564b0b4a01447cb0521bbd4198fd3bea2","modified":1651584022242},{"_id":"source/_posts/k8s-rbac/ab8f20ce2acc.png","hash":"af7e38d63e99daa064a42d7f0777863c01eb49b6","modified":1651584022241},{"_id":"source/_posts/prometheus-grafana-notice/1.png","hash":"63c1e5df5faa1a140d3054728da94b29cf70cb75","modified":1651584022256},{"_id":"source/_posts/prometheus-grafana-notice/16.png","hash":"3c5c7cf44aeb7a025d21e6ebd96c204d91c65bcb","modified":1651584022266},{"_id":"source/_posts/prometheus-grafana-notice/3.png","hash":"bd5b4a8679b5b6bb03cf4a6848b3116ea2db722a","modified":1651584022272},{"_id":"source/_posts/prometheus-grafana-notice/5.png","hash":"fcee6b78b57dac400c5bb2fa82c5446140504ad1","modified":1651584022275},{"_id":"source/_posts/prometheus-grafana-notice/6.png","hash":"82f9cea0d6b7b8a86c1efffd9addf06172c465ab","modified":1651584022276},{"_id":"source/_posts/alicloud-ram-sts/ram1.png","hash":"3f81fb567b165494d7b1eb1b25c052bda32c742a","modified":1651584022282},{"_id":"source/_posts/alicloud-vpc/vpc3.png","hash":"a52347fe4ed962a47d1a3d4f0f20cd197ab138a6","modified":1651679770022},{"_id":"source/_posts/alicloud-ram-sts/ram5.png","hash":"b2c5cf28a5480294fabfca8db9f717d6d6487b66","modified":1651584022286},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls1.png","hash":"0a654c70f52a6403542f3fe2b3369b88239ef1dc","modified":1653920103686},{"_id":"source/_posts/alicloud-ram-sts/ram7.png","hash":"043b10ad0217c47f6835bbcb7b9d5f5a9cd5f988","modified":1651584022288},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls14.png","hash":"d9cbed932627cf66058634461b79765fa67aad48","modified":1653920143429},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls13.png","hash":"5c75193323836115fdb0fadf2c0e43e9072f72b9","modified":1653920125517},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls3.png","hash":"a67f569c44b641ab5facc083aa7a7a02b5f6889c","modified":1653920115325},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls15.png","hash":"c9212adc1447f708fa092fe1b21b7cd0df2ab0ce","modified":1653920158973},{"_id":"source/_posts/git-flow/gf6.png","hash":"8447116a852a91d68acd947993405b6cf415381d","modified":1651670077951},{"_id":"source/_posts/k8s-rbac/de4222775e67.png","hash":"99be909dcafe21213c13265bd3636ade2f77a415","modified":1651584022249},{"_id":"source/_posts/k8s-rbac/gaisu.png","hash":"c58ef01e18142f1ce637217762542a73367e483e","modified":1651584022250},{"_id":"source/_posts/prometheus-grafana-notice/11.png","hash":"dcc4ad85ab1f4edbc0aa094b53b1d0e8493d8c88","modified":1651584022258},{"_id":"source/_posts/prometheus-grafana-notice/9.png","hash":"7f74a9f47a2d9d83fc82b884b17b8c93a1d05924","modified":1651584022280},{"_id":"source/_posts/git-flow/gf11.png","hash":"3245ba84de0a8fbf411987e2a5901ed9ec2cf6cc","modified":1651670077945},{"_id":"source/_posts/git-flow/gf2.png","hash":"13a289912911701423f80d6083c9af797acc19f5","modified":1651670077947},{"_id":"source/_posts/k8s-networkpolicy/6bbe6aab7201.png","hash":"93e7a9dd7e4b7efe65eceb19d9ca28fba17950a7","modified":1651584022253},{"_id":"source/_posts/helm-deploy/helm5.png","hash":"701a5e3cfd12b99d0db435681a4517428a266325","modified":1651671979709},{"_id":"source/_posts/k8s-networkpolicy/7b70de99e5f7.png","hash":"fd04d7733c5b1447e9c0508d92807fbf9c2421e1","modified":1651584022255},{"_id":"source/_posts/k8s-rbac/7528aa1bf3da.png","hash":"9c579e40e532170a13b32abec1ebaf39378670e1","modified":1651584022241},{"_id":"source/_posts/k8s-rbac/21812e1bbfad.png","hash":"ce2e8a583d00ee261c661986dc611400c87ba818","modified":1651584022239},{"_id":"source/_posts/prometheus-grafana-notice/15.png","hash":"9bcf9769e3261a8ca84251085db63ca00078ea38","modified":1651584022265},{"_id":"source/_posts/prometheus-grafana-notice/13.png","hash":"b46a01d70f0397d238893562c74177e2620e96fa","modified":1651584022262},{"_id":"source/_posts/prometheus-grafana-notice/7.png","hash":"d46ccdd0c1fec9379f28dc153dfcd53aaa3e75d6","modified":1651584022278},{"_id":"source/_posts/alicloud-ram-sts/ram4.png","hash":"d7c69a6cd55e5c6761f8d10f97df6fec7ca192d0","modified":1651584022284},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls16.png","hash":"10b6bbc9aca654654d36d546848c36c7e893a83e","modified":1653920107322},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls5.png","hash":"10797ce6eeb03d68022ed53cf543d7bc88ef6522","modified":1653920112638},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls6.png","hash":"4dfbdbb054223b440881864813745ea01b1085e4","modified":1653920135134},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls7.png","hash":"9b5a20e762e7f096539bb4bdc0780babd7524762","modified":1653920146971},{"_id":"source/_posts/git-flow/gf14.png","hash":"a55c37098012fe7c2357f160f18b46fa3375befd","modified":1651670077946},{"_id":"source/_posts/git-flow/gf13.png","hash":"67bcb850aae40f8cfa0f0f004faf78c84a27ae36","modified":1651670077946},{"_id":"source/_posts/git-flow/gf7.png","hash":"977bd10d62f62daf2f10692e75df6c011bf7c1fe","modified":1651670077952},{"_id":"source/_posts/prometheus-grafana-notice/14.png","hash":"501f84e8376fedc0036539ba36fd9e69c0906b47","modified":1651584022264},{"_id":"source/_posts/alicloud-vpc/vpc4.png","hash":"9334c5fb57bb6b8991b3b8ef86794ee8f5c27247","modified":1651679770022},{"_id":"source/_posts/git-flow/gf1.png","hash":"4ef3ab2f2f41d15d31e6f1845403bbfabb59d9df","modified":1651670077943},{"_id":"source/_posts/k8s-rbac/d6da8c845c41.png","hash":"b614ff7f3d18a32abedd27f042286d3e911400e3","modified":1651584022245},{"_id":"source/_posts/prometheus-grafana-notice/12.png","hash":"49545c7daa918e583dc69dbd75d33b9fe0d2ded1","modified":1651584022260},{"_id":"source/_posts/prometheus-grafana-notice/4.png","hash":"34b58260b8187846fab853620311e97d3b50033a","modified":1651584022274},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls2.png","hash":"fd46498cc37b4852ca2b8be3f412d75c1de791e9","modified":1653920139411},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls4.png","hash":"685f32a6227218888bbb828665a0d29ff08e11ce","modified":1653920131705},{"_id":"source/_posts/git-flow/gf10.png","hash":"b23b6cb991497506195c01c55fc54fa5a912d339","modified":1651670077944},{"_id":"source/_posts/openssl-basic/openssl-1.jpeg","hash":"f6a7f58030452e9791c4d9e7ec374d7b563c77df","modified":1670511255571},{"_id":"source/_posts/git-flow/gf9.png","hash":"699f349910e318ba1d8cdd63be891ac58b2d5747","modified":1651670077953},{"_id":"themes/next/.gitattributes","hash":"a54f902957d49356376b59287b894b1a3d7a003f","modified":1651584022289},{"_id":"themes/next/.eslintrc.json","hash":"cc5f297f0322672fe3f684f823bc4659e4a54c41","modified":1651584022289},{"_id":"themes/next/.travis.yml","hash":"ecca3b919a5b15886e3eca58aa84aafc395590da","modified":1651584022290},{"_id":"themes/next/.editorconfig","hash":"8570735a8d8d034a3a175afd1dd40b39140b3e6a","modified":1651584022289},{"_id":"themes/next/.stylintrc","hash":"2cf4d637b56d8eb423f59656a11f6403aa90f550","modified":1651584022289},{"_id":"themes/next/README.md","hash":"9b4b7d66aca47f9c65d6321b14eef48d95c4dff1","modified":1651584022290},{"_id":"themes/next/crowdin.yml","hash":"e026078448c77dcdd9ef50256bb6635a8f83dca6","modified":1651584022290},{"_id":"themes/next/package.json","hash":"62fad6de02adbbba9fb096cbe2dcc15fe25f2435","modified":1651584022299},{"_id":"themes/next/LICENSE.md","hash":"18144d8ed58c75af66cb419d54f3f63374cd5c5b","modified":1651584022290},{"_id":"themes/next/_config.yml","hash":"34c938e0ca5b9ba59cacc10d5497cb34fc11f5f0","modified":1651584022290},{"_id":"themes/next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1651584022290},{"_id":"themes/next/gulpfile.js","hash":"1b4fc262b89948937b9e3794de812a7c1f2f3592","modified":1651584022292},{"_id":"themes/next/docs/ALGOLIA-SEARCH.md","hash":"c7a994b9542040317d8f99affa1405c143a94a38","modified":1651584022290},{"_id":"themes/next/docs/DATA-FILES.md","hash":"cddbdc91ee9e65c37a50bec12194f93d36161616","modified":1651584022290},{"_id":"themes/next/docs/INSTALLATION.md","hash":"af88bcce035780aaa061261ed9d0d6c697678618","modified":1651584022291},{"_id":"themes/next/docs/LICENSE.txt","hash":"368bf2c29d70f27d8726dd914f1b3211cae4bbab","modified":1651584022291},{"_id":"themes/next/docs/AUTHORS.md","hash":"10135a2f78ac40e9f46b3add3e360c025400752f","modified":1651584022290},{"_id":"themes/next/docs/LEANCLOUD-COUNTER-SECURITY.md","hash":"94dc3404ccb0e5f663af2aa883c1af1d6eae553d","modified":1651584022291},{"_id":"themes/next/docs/MATH.md","hash":"d645b025ec7fb9fbf799b9bb76af33b9f5b9ed93","modified":1651584022291},{"_id":"themes/next/docs/UPDATE-FROM-5.1.X.md","hash":"8b6e4b2c9cfcb969833092bdeaed78534082e3e6","modified":1651584022291},{"_id":"themes/next/languages/ar.yml","hash":"9815e84e53d750c8bcbd9193c2d44d8d910e3444","modified":1651584022292},{"_id":"themes/next/languages/de.yml","hash":"74c59f2744217003b717b59d96e275b54635abf5","modified":1651584022293},{"_id":"themes/next/languages/default.yml","hash":"45bc5118828bdc72dcaa25282cd367c8622758cb","modified":1651584022293},{"_id":"themes/next/languages/es.yml","hash":"c64cf05f356096f1464b4b1439da3c6c9b941062","modified":1651584022293},{"_id":"themes/next/languages/en.yml","hash":"45bc5118828bdc72dcaa25282cd367c8622758cb","modified":1651584022293},{"_id":"themes/next/languages/fr.yml","hash":"752bf309f46a2cd43890b82300b342d7218d625f","modified":1651584022293},{"_id":"themes/next/languages/hu.yml","hash":"b1ebb77a5fd101195b79f94de293bcf9001d996f","modified":1651584022293},{"_id":"themes/next/languages/fa.yml","hash":"3676b32fda37e122f3c1a655085a1868fb6ad66b","modified":1651584022293},{"_id":"themes/next/languages/id.yml","hash":"572ed855d47aafe26f58c73b1394530754881ec2","modified":1651584022293},{"_id":"themes/next/languages/pt-BR.yml","hash":"67555b1ba31a0242b12fc6ce3add28531160e35b","modified":1651584022293},{"_id":"themes/next/languages/it.yml","hash":"44759f779ce9c260b895532de1d209ad4bd144bf","modified":1651584022293},{"_id":"themes/next/languages/ja.yml","hash":"0cf0baa663d530f22ff380a051881216d6adcdd8","modified":1651584022293},{"_id":"themes/next/languages/pt.yml","hash":"718d131f42f214842337776e1eaddd1e9a584054","modified":1651584022294},{"_id":"themes/next/languages/ru.yml","hash":"e993d5ca072f7f6887e30fc0c19b4da791ca7a88","modified":1651584022294},{"_id":"themes/next/languages/nl.yml","hash":"5af3473d9f22897204afabc08bb984b247493330","modified":1651584022293},{"_id":"themes/next/languages/tr.yml","hash":"2b041eeb8bd096f549464f191cfc1ea0181daca4","modified":1651584022294},{"_id":"themes/next/languages/uk.yml","hash":"3a6d635b1035423b22fc86d9455dba9003724de9","modified":1651584022294},{"_id":"themes/next/languages/vi.yml","hash":"93393b01df148dcbf0863f6eee8e404e2d94ef9e","modified":1651584022294},{"_id":"themes/next/languages/ko.yml","hash":"0feea9e43cd399f3610b94d755a39fff1d371e97","modified":1651584022293},{"_id":"themes/next/languages/zh-CN.yml","hash":"bd5106b400ddd02ad81bd3d0a47e7ea6704dc008","modified":1651584022294},{"_id":"themes/next/languages/zh-HK.yml","hash":"3789f94010f948e9f23e21235ef422a191753c65","modified":1651584022294},{"_id":"themes/next/languages/zh-TW.yml","hash":"8c09da7c4ec3fca2c6ee897b2eea260596a2baa1","modified":1651584022294},{"_id":"themes/next/layout/_layout.swig","hash":"6a6e92a4664cdb981890a27ac11fd057f44de1d5","modified":1651584022294},{"_id":"themes/next/layout/category.swig","hash":"1bde61cf4d2d171647311a0ac2c5c7933f6a53b0","modified":1651584022299},{"_id":"themes/next/layout/archive.swig","hash":"e4e31317a8df68f23156cfc49e9b1aa9a12ad2ed","modified":1651584022298},{"_id":"themes/next/scripts/renderer.js","hash":"49a65df2028a1bc24814dc72fa50d52231ca4f05","modified":1651584022301},{"_id":"themes/next/layout/index.swig","hash":"7f403a18a68e6d662ae3e154b2c1d3bbe0801a23","modified":1651584022299},{"_id":"themes/next/layout/post.swig","hash":"2f6d992ced7e067521fdce05ffe4fd75481f41c5","modified":1651584022299},{"_id":"themes/next/layout/page.swig","hash":"aa9ce35a7880cd043ab3241bcd7707da18079cad","modified":1651584022299},{"_id":"themes/next/layout/tag-color.swig","hash":"5826fca287979119e35f4d194e1aa17413503bd4","modified":1651584022299},{"_id":"themes/next/layout/tag.swig","hash":"0dfb653bd5de980426d55a0606d1ab122bd8c017","modified":1651584022299},{"_id":"themes/next/docs/ru/DATA-FILES.md","hash":"0bd2d696f62a997a11a7d84fec0130122234174e","modified":1651584022291},{"_id":"themes/next/source/.DS_Store","hash":"f131619ff937b89bd60097b66ac9f16b740fe029","modified":1724936654496},{"_id":"themes/next/docs/ru/INSTALLATION.md","hash":"9c4fe2873123bf9ceacab5c50d17d8a0f1baef27","modified":1651584022291},{"_id":"themes/next/docs/ru/UPDATE-FROM-5.1.X.md","hash":"5237a368ab99123749d724b6c379415f2c142a96","modified":1651584022291},{"_id":"themes/next/docs/zh-CN/CONTRIBUTING.md","hash":"d3f03be036b75dc71cf3c366cd75aee7c127c874","modified":1651584022292},{"_id":"themes/next/docs/zh-CN/ALGOLIA-SEARCH.md","hash":"34b88784ec120dfdc20fa82aadeb5f64ef614d14","modified":1651584022292},{"_id":"themes/next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"fb23b85db6f7d8279d73ae1f41631f92f64fc864","modified":1651584022292},{"_id":"themes/next/docs/zh-CN/DATA-FILES.md","hash":"ca1030efdfca5e20f9db2e7a428998e66a24c0d0","modified":1651584022292},{"_id":"themes/next/source/404.html","hash":"cb36e99331f1059bcd0f0f67763e6689e22eba9a","modified":1724935547213},{"_id":"themes/next/docs/zh-CN/INSTALLATION.md","hash":"579c7bd8341873fb8be4732476d412814f1a3df7","modified":1651584022292},{"_id":"themes/next/docs/ru/README.md","hash":"85dd68ed1250897a8e4a444a53a68c1d49eb7e11","modified":1651584022291},{"_id":"themes/next/docs/zh-CN/MATH.md","hash":"b92585d251f1f9ebe401abb5d932cb920f9b8b10","modified":1651584022292},{"_id":"themes/next/docs/zh-CN/README.md","hash":"c038629ff8f3f24e8593c4c8ecf0bef3a35c750d","modified":1651584022292},{"_id":"themes/next/docs/zh-CN/UPDATE-FROM-5.1.X.md","hash":"d9ce7331c1236bbe0a551d56cef2405e47e65325","modified":1651584022292},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"9c8dc0b8170679cdc1ee9ee8dbcbaebf3f42897b","modified":1651584022294},{"_id":"themes/next/layout/_macro/post.swig","hash":"f56c340777b8c530ef0ca2ff1e606a703d1c0acc","modified":1651584022294},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"6cc5719d5db80d70a7db9e53c7e031b1b021e145","modified":1651584022294},{"_id":"themes/next/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md","hash":"8b18f84503a361fc712b0fe4d4568e2f086ca97d","modified":1651584022292},{"_id":"themes/next/layout/_scripts/index.swig","hash":"cea942b450bcb0f352da78d76dc6d6f1d23d5029","modified":1651584022296},{"_id":"themes/next/layout/_scripts/three.swig","hash":"a4f42f2301866bd25a784a2281069d8b66836d0b","modified":1651584022296},{"_id":"themes/next/layout/_scripts/pjax.swig","hash":"4d2c93c66e069852bb0e3ea2e268d213d07bfa3f","modified":1651584022296},{"_id":"themes/next/layout/_partials/comments.swig","hash":"db6ab5421b5f4b7cb32ac73ad0e053fdf065f83e","modified":1651584022294},{"_id":"themes/next/layout/_partials/languages.swig","hash":"ba9e272f1065b8f0e8848648caa7dea3f02c6be1","modified":1651584022295},{"_id":"themes/next/layout/_partials/footer.swig","hash":"4369b313cbbeae742cb35f86d23d99d4285f7359","modified":1651584022294},{"_id":"themes/next/layout/_scripts/noscript.swig","hash":"d1f2bfde6f1da51a2b35a7ab9e7e8eb6eefd1c6b","modified":1651584022296},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9876dbfc15713c7a47d4bcaa301f4757bd978269","modified":1651584022295},{"_id":"themes/next/layout/_partials/widgets.swig","hash":"83a40ce83dfd5cada417444fb2d6f5470aae6bb0","modified":1651584022296},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"ef38c213679e7b6d2a4116f56c9e55d678446069","modified":1651584022296},{"_id":"themes/next/scripts/events/index.js","hash":"5743cde07f3d2aa11532a168a652e52ec28514fd","modified":1651584022299},{"_id":"themes/next/scripts/filters/default-injects.js","hash":"aec50ed57b9d5d3faf2db3c88374f107203617e0","modified":1651584022300},{"_id":"themes/next/layout/_third-party/index.swig","hash":"70c3c01dd181de81270c57f3d99b6d8f4c723404","modified":1651584022297},{"_id":"themes/next/layout/_third-party/baidu-push.swig","hash":"b782eb2e34c0c15440837040b5d65b093ab6ec04","modified":1651584022297},{"_id":"themes/next/scripts/filters/front-matter.js","hash":"703bdd142a671b4b67d3d9dfb4a19d1dd7e7e8f7","modified":1651584022300},{"_id":"themes/next/scripts/filters/locals.js","hash":"b193a936ee63451f09f8886343dcfdca577c0141","modified":1651584022300},{"_id":"themes/next/scripts/filters/minify.js","hash":"19985723b9f677ff775f3b17dcebf314819a76ac","modified":1651584022300},{"_id":"themes/next/scripts/filters/post.js","hash":"44ba9b1c0bdda57590b53141306bb90adf0678db","modified":1651584022300},{"_id":"themes/next/scripts/helpers/font.js","hash":"40cf00e9f2b7aa6e5f33d412e03ed10304b15fd7","modified":1651584022301},{"_id":"themes/next/scripts/helpers/engine.js","hash":"bdb424c3cc0d145bd0c6015bb1d2443c8a9c6cda","modified":1651584022301},{"_id":"themes/next/scripts/helpers/next-url.js","hash":"958e86b2bd24e4fdfcbf9ce73e998efe3491a71f","modified":1651584022301},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"2731e262a6b88eaee2a3ca61e6a3583a7f594702","modified":1651584022298},{"_id":"themes/next/layout/_third-party/quicklink.swig","hash":"311e5eceec9e949f1ea8d623b083cec0b8700ff2","modified":1651584022298},{"_id":"themes/next/scripts/tags/button.js","hash":"8c6b45f36e324820c919a822674703769e6da32c","modified":1651584022301},{"_id":"themes/next/scripts/helpers/next-config.js","hash":"5e11f30ddb5093a88a687446617a46b048fa02e5","modified":1651584022301},{"_id":"themes/next/scripts/tags/note.js","hash":"0a02bb4c15aec41f6d5f1271cdb5c65889e265d9","modified":1651584022301},{"_id":"themes/next/scripts/tags/label.js","hash":"fc5b267d903facb7a35001792db28b801cccb1f8","modified":1651584022301},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"f1826ade2d135e2f60e2d95cb035383685b3370c","modified":1651584022301},{"_id":"themes/next/scripts/tags/pdf.js","hash":"8c613b39e7bff735473e35244b5629d02ee20618","modified":1651584022301},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"d902fd313e8d35c3cc36f237607c2a0536c9edf1","modified":1651584022301},{"_id":"themes/next/scripts/tags/caniuse.js","hash":"94e0bbc7999b359baa42fa3731bdcf89c79ae2b3","modified":1651584022301},{"_id":"themes/next/scripts/tags/tabs.js","hash":"93d8a734a3035c1d3f04933167b500517557ba3e","modified":1651584022302},{"_id":"themes/next/scripts/tags/mermaid.js","hash":"983c6c4adea86160ecc0ba2204bc312aa338121d","modified":1651584022301},{"_id":"themes/next/scripts/tags/video.js","hash":"e5ff4c44faee604dd3ea9db6b222828c4750c227","modified":1651584022302},{"_id":"themes/next/source/css/_colors.styl","hash":"a8442520f719d3d7a19811cb3b85bcfd4a596e1f","modified":1651584022302},{"_id":"themes/next/source/css/_mixins.styl","hash":"e31a557f8879c2f4d8d5567ee1800b3e03f91f6e","modified":1651584022306},{"_id":"themes/next/source/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1651584022310},{"_id":"themes/next/source/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1651584022310},{"_id":"themes/next/source/css/main.styl","hash":"a3a3bbb5a973052f0186b3523911cb2539ff7b88","modified":1651584022308},{"_id":"themes/next/source/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1651584022311},{"_id":"themes/next/source/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1651584022311},{"_id":"themes/next/source/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1651584022311},{"_id":"themes/next/source/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1651584022308},{"_id":"themes/next/source/images/android-chrome-192x192.png","hash":"cceef8d2b5000ccaf07441815a928ed569d7befe","modified":1724907808000},{"_id":"themes/next/source/images/apple-touch-icon.png","hash":"45a73040134a7034b8245bd3d59bedbd045ea31f","modified":1724907808000},{"_id":"themes/next/source/images/android-chrome-512x512.png","hash":"9e228026245f101325ff9a0b1022d92d9b47c7be","modified":1724907808000},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1651584022309},{"_id":"themes/next/source/js/utils.js","hash":"730cca7f164eaf258661a61ff3f769851ff1e5da","modified":1651584022311},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1651584022309},{"_id":"themes/next/source/images/.DS_Store","hash":"9bef97296eecc43d0d791ae05c95093deb65b286","modified":1724936701718},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1651584022310},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1651584022310},{"_id":"themes/next/source/images/favicon-16x16.png","hash":"8b5ca499cc5685f629f28219c10056466842aedf","modified":1724907808000},{"_id":"themes/next/source/images/favicon.ico","hash":"bd55b6d87a8138974a88950eba2d1c7d1c3f048b","modified":1724907808000},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1651584022310},{"_id":"themes/next/source/images/favicon-32x32.png","hash":"c0d78017d384b14a506b643d5da5922cd9c874f4","modified":1724907808000},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1651584022310},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1651584022310},{"_id":"themes/next/source/images/logo.svg","hash":"264fd86714b6f257a4cdafa42fc8e8d01432f1fb","modified":1651584022310},{"_id":"themes/next/source/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1651584022311},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1651584022296},{"_id":"themes/next/layout/_scripts/pages/schedule.swig","hash":"077b5d66f6309f2e7dcf08645058ff2e03143e6c","modified":1651584022296},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1651584022296},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1651584022296},{"_id":"themes/next/layout/_partials/head/head-unique.swig","hash":"000bad572d76ee95d9c0a78f9ccdc8d97cc7d4b4","modified":1651584022294},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1651584022296},{"_id":"themes/next/layout/_partials/header/brand.swig","hash":"c70f8e71e026e878a4e9d5ab3bbbf9b0b23c240c","modified":1651584022295},{"_id":"themes/next/layout/_partials/head/head.swig","hash":"810d544019e4a8651b756dd23e5592ee851eda71","modified":1651584022295},{"_id":"themes/next/layout/_partials/header/menu-item.swig","hash":"9440d8a3a181698b80e1fa47f5104f4565d8cdf3","modified":1651584022295},{"_id":"themes/next/layout/_partials/header/menu.swig","hash":"d31f896680a6c2f2c3f5128b4d4dd46c87ce2130","modified":1651584022295},{"_id":"themes/next/layout/_partials/header/sub-menu.swig","hash":"ae2261bea836581918a1c2b0d1028a78718434e0","modified":1651584022295},{"_id":"themes/next/layout/_partials/header/index.swig","hash":"7dbe93b8297b746afb89700b4d29289556e85267","modified":1651584022295},{"_id":"themes/next/layout/_partials/page/page-header.swig","hash":"9b7a66791d7822c52117fe167612265356512477","modified":1651584022295},{"_id":"themes/next/layout/_partials/page/breadcrumb.swig","hash":"c851717497ca64789f2176c9ecd1dedab237b752","modified":1651584022295},{"_id":"themes/next/layout/_partials/post/post-copyright.swig","hash":"954ad71536b6eb08bd1f30ac6e2f5493b69d1c04","modified":1651584022295},{"_id":"themes/next/layout/_partials/post/post-followme.swig","hash":"ceba16b9bd3a0c5c8811af7e7e49d0f9dcb2f41e","modified":1651584022295},{"_id":"themes/next/layout/_partials/post/post-related.swig","hash":"f79c44692451db26efce704813f7a8872b7e63a0","modified":1651584022295},{"_id":"themes/next/layout/_partials/post/post-footer.swig","hash":"8f14f3f8a1b2998d5114cc56b680fb5c419a6b07","modified":1651584022295},{"_id":"themes/next/layout/_partials/search/algolia-search.swig","hash":"48430bd03b8f19c9b8cdb2642005ed67d56c6e0b","modified":1651584022295},{"_id":"themes/next/layout/_partials/search/index.swig","hash":"2be50f9bfb1c56b85b3b6910a7df27f51143632c","modified":1651584022296},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"f48a6a8eba04eb962470ce76dd731e13074d4c45","modified":1651584022296},{"_id":"themes/next/layout/_partials/post/post-reward.swig","hash":"2b1a73556595c37951e39574df5a3f20b2edeaef","modified":1651584022295},{"_id":"themes/next/layout/_partials/sidebar/site-overview.swig","hash":"47043445214a28a0bda3a30e4742bf16c0a98b64","modified":1651584022296},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"4790058691b7d36cf6d2d6b4e93795a7b8d608ad","modified":1651584022297},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"2fa2b51d56bfac6a1ea76d651c93b9c20b01c09b","modified":1651584022297},{"_id":"themes/next/layout/_third-party/analytics/growingio.swig","hash":"5adea065641e8c55994dd2328ddae53215604928","modified":1651584022297},{"_id":"themes/next/layout/_third-party/chat/tidio.swig","hash":"cba0e6e0fad08568a9e74ba9a5bee5341cfc04c1","modified":1651584022297},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"1472cabb0181f60a6a0b7fec8899a4d03dfb2040","modified":1651584022297},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"b14908644225d78c864cd0a9b60c52407de56183","modified":1651584022297},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"f39a5bf3ce9ee9adad282501235e0c588e4356ec","modified":1651584022297},{"_id":"themes/next/layout/_third-party/comments/disqusjs.swig","hash":"82f5b6822aa5ec958aa987b101ef860494c6cf1f","modified":1651584022297},{"_id":"themes/next/layout/_third-party/chat/chatra.swig","hash":"f910618292c63871ca2e6c6e66c491f344fa7b1f","modified":1651584022297},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"f7a9eca599a682479e8ca863db59be7c9c7508c8","modified":1651584022297},{"_id":"themes/next/layout/_third-party/comments/gitalk.swig","hash":"d6ceb70648555338a80ae5724b778c8c58d7060d","modified":1651584022297},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"be0a8eccf1f6dc21154af297fc79555343031277","modified":1651584022297},{"_id":"themes/next/layout/_third-party/math/index.swig","hash":"6c5976621efd5db5f7c4c6b4f11bc79d6554885f","modified":1651584022297},{"_id":"themes/next/layout/_third-party/math/mathjax.swig","hash":"ecf751321e799f0fb3bf94d049e535130e2547aa","modified":1651584022298},{"_id":"themes/next/layout/_third-party/math/katex.swig","hash":"4791c977a730f29c846efcf6c9c15131b9400ead","modified":1651584022298},{"_id":"themes/next/layout/_third-party/statistics/cnzz-analytics.swig","hash":"a17ace37876822327a2f9306a472974442c9005d","modified":1651584022298},{"_id":"themes/next/layout/_third-party/statistics/busuanzi-counter.swig","hash":"4b1986e43d6abce13450d2b41a736dd6a5620a10","modified":1651584022298},{"_id":"themes/next/layout/_third-party/statistics/firestore.swig","hash":"b26ac2bfbe91dd88267f8b96aee6bb222b265b7a","modified":1651584022298},{"_id":"themes/next/layout/_third-party/statistics/lean-analytics.swig","hash":"d56d5af427cdfecc33a0f62ee62c056b4e33d095","modified":1651584022298},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"767b6c714c22588bcd26ba70b0fc19b6810cbacd","modified":1651584022298},{"_id":"themes/next/scripts/events/lib/config.js","hash":"d34c6040b13649714939f59be5175e137de65ede","modified":1651584022299},{"_id":"themes/next/layout/_third-party/statistics/index.swig","hash":"5f6a966c509680dbfa70433f9d658cee59c304d7","modified":1651584022298},{"_id":"themes/next/layout/_third-party/tags/pdf.swig","hash":"d30b0e255a8092043bac46441243f943ed6fb09b","modified":1651584022298},{"_id":"themes/next/layout/_third-party/search/swiftype.swig","hash":"ba0dbc06b9d244073a1c681ff7a722dcbf920b51","modified":1651584022298},{"_id":"themes/next/scripts/events/lib/injects-point.js","hash":"6661c1c91c7cbdefc6a5e6a034b443b8811235a1","modified":1651584022299},{"_id":"themes/next/scripts/filters/comment/changyan.js","hash":"a54708fd9309b4357c423a3730eb67f395344a5e","modified":1651584022300},{"_id":"themes/next/scripts/filters/comment/common.js","hash":"2486f3e0150c753e5f3af1a3665d074704b8ee2c","modified":1651584022300},{"_id":"themes/next/scripts/filters/comment/default-config.js","hash":"7f2d93af012c1e14b8596fecbfc7febb43d9b7f5","modified":1651584022300},{"_id":"themes/next/scripts/events/lib/injects.js","hash":"f233d8d0103ae7f9b861344aa65c1a3c1de8a845","modified":1651584022299},{"_id":"themes/next/scripts/filters/comment/gitalk.js","hash":"e51dc3072c1ba0ea3008f09ecae8b46242ec6021","modified":1651584022300},{"_id":"themes/next/layout/_third-party/tags/mermaid.swig","hash":"f3c43664a071ff3c0b28bd7e59b5523446829576","modified":1651584022298},{"_id":"themes/next/scripts/filters/comment/disqusjs.js","hash":"7f8b92913d21070b489457fa5ed996d2a55f2c32","modified":1651584022300},{"_id":"themes/next/scripts/filters/comment/valine.js","hash":"6cbd85f9433c06bae22225ccf75ac55e04f2d106","modified":1651584022300},{"_id":"themes/next/scripts/filters/comment/livere.js","hash":"d5fefc31fba4ab0188305b1af1feb61da49fdeb0","modified":1651584022300},{"_id":"themes/next/scripts/filters/comment/disqus.js","hash":"4c0c99c7e0f00849003dfce02a131104fb671137","modified":1651584022300},{"_id":"themes/next/layout/_third-party/search/algolia-search.swig","hash":"d35a999d67f4c302f76fdf13744ceef3c6506481","modified":1651584022298},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"612ec843372dae709acb17112c1145a53450cc59","modified":1651584022308},{"_id":"themes/next/source/css/_variables/base.styl","hash":"66c09b8c9e5287521200b162a9c4e4305135afa1","modified":1651584022308},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"f70be8e229da7e1715c11dd0e975a2e71e453ac8","modified":1651584022308},{"_id":"themes/next/source/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1651584022311},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"f4e694e5db81e57442c7e34505a416d818b3044a","modified":1651584022308},{"_id":"themes/next/source/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1651584022312},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1651584022312},{"_id":"themes/next/source/lib/pace/README.md","hash":"168f57bb63563b9671d0c4f10c0940e7eec261f0","modified":1651584022312},{"_id":"themes/next/source/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1651584022311},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1651584022312},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1651584022312},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1651584022312},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"62df49459d552bbf73841753da8011a1f5e875c8","modified":1651584022308},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1651584022312},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1651584022312},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1651584022313},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1651584022312},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1651584022313},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1651584022313},{"_id":"themes/next/source/lib/pace/pace-theme-flat-top.min.css","hash":"5e1c97e232b46e48592a8e4983ae5a89e0a7da6a","modified":1651584022313},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1651584022313},{"_id":"themes/next/source/lib/pace/pace-theme-material.min.css","hash":"f1ff83985c090f3a3236554c5ef69542dcceb049","modified":1651584022313},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1651584022313},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1651584022313},{"_id":"themes/next/source/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1651584022313},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1651584022313},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"ca5e70662dcfb261c25191cc5db5084dcf661c76","modified":1651584022302},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"8e7b57a72e757cf95278239641726bb2d5b869d1","modified":1651584022302},{"_id":"themes/next/source/css/_common/outline/mobile.styl","hash":"681d33e3bc85bdca407d93b134c089264837378c","modified":1651584022304},{"_id":"themes/next/source/css/_common/components/reading-progress.styl","hash":"2e3bf7baf383c9073ec5e67f157d3cb3823c0957","modified":1651584022303},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"0b2c4b78eead410020d7c4ded59c75592a648df8","modified":1651584022305},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"a1690e035b505d28bdef2b4424c13fc6312ab049","modified":1651584022304},{"_id":"themes/next/source/css/_common/scaffolding/buttons.styl","hash":"a2e9e00962e43e98ec2614d6d248ef1773bb9b78","modified":1651584022305},{"_id":"themes/next/source/css/_common/scaffolding/comments.styl","hash":"b1f0fab7344a20ed6748b04065b141ad423cf4d9","modified":1651584022305},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1651584022305},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1651584022306},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"a47725574e1bee3bc3b63b0ff2039cc982b17eff","modified":1651584022302},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1651584022313},{"_id":"themes/next/source/css/_common/scaffolding/toggles.styl","hash":"179e33b8ac7f4d8a8e76736a7e4f965fe9ab8b42","modified":1651584022306},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"18ce72d90459c9aa66910ac64eae115f2dde3767","modified":1651584022306},{"_id":"themes/next/source/css/_schemes/Muse/_header.styl","hash":"f0131db6275ceaecae7e1a6a3798b8f89f6c850d","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"4d1c17345d2d39ef7698f7acf82dfc0f59308c34","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Muse/_sidebar.styl","hash":"2b2e7b5cea7783c9c8bb92655e26a67c266886f0","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"93db5dafe9294542a6b5f647643cb9deaced8e06","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"f6516d0f7d89dc7b6c6e143a5af54b926f585d82","modified":1651584022306},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expand.styl","hash":"6136da4bbb7e70cec99f5c7ae8c7e74f5e7c261a","modified":1651584022306},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"7104b9cef90ca3b140d7a7afcf15540a250218fc","modified":1651584022306},{"_id":"themes/next/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Mist/_layout.styl","hash":"bb7ace23345364eb14983e860a7172e1683a4c94","modified":1651584022306},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"a717969829fa6ef88225095737df3f8ee86c286b","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"7785bd756e0c4acede3a47fec1ed7b55988385a5","modified":1651584022306},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"85da2f3006f4bef9a2199416ecfab4d288f848c4","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"e740deadcfc4f29c5cb01e40f9df6277262ba4e3","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"44f47c88c06d89d06f220f102649057118715828","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Pisces/_header.styl","hash":"e282df938bd029f391c466168d0e68389978f120","modified":1651584022307},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1651584022307},{"_id":"themes/next/source/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1651584022311},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1651584022312},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"70a4324b70501132855b5e59029acfc5d3da1ebd","modified":1651584022307},{"_id":"themes/next/source/css/_common/components/pages/breadcrumb.styl","hash":"fafc96c86926b22afba8bb9418c05e6afbc05a57","modified":1651584022302},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1651584022302},{"_id":"themes/next/source/css/_common/scaffolding/pagination.styl","hash":"8f58570a1bbc34c4989a47a1b7d42a8030f38b06","modified":1651584022305},{"_id":"themes/next/source/css/_common/components/pages/tag-cloud.styl","hash":"d21d4ac1982c13d02f125a67c065412085a92ff2","modified":1651584022302},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"e75693f33dbc92afc55489438267869ae2f3db54","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"2bd0eb1512415325653b26d62a4463e6de83c5ac","modified":1651584022302},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"902569a9dea90548bec21a823dd3efd94ff7c133","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"e771dcb0b4673e063c0f3e2d73e7336ac05bcd57","modified":1651584022302},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"ded41fd9d20a5e8db66aaff7cc50f105f5ef2952","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f49ca072b5a800f735e8f01fc3518f885951dd8e","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"72d495a88f7d6515af425c12cbc67308a57d88ea","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/post/post-header.styl","hash":"65cb6edb69e94e70e3291e9132408361148d41d5","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"6a97bcfa635d637dc59005be3b931109e0d1ead5","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/post/post-followme.styl","hash":"1e4190c10c9e0c9ce92653b0dbcec21754b0b69d","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"d114b2a531129e739a27ba6271cfe6857aa9a865","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"99e12c9ce3d14d4837e3d3f12fc867ba9c565317","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"f5c2788a78790aca1a2f37f7149d6058afb539e0","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/third-party/gitalk.styl","hash":"8a7fc03a568b95be8d3337195e38bc7ec5ba2b23","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/third-party/related-posts.styl","hash":"e2992846b39bf3857b5104675af02ba73e72eed5","modified":1651584022304},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"cea1527ce53d0c475c16ae594dd9d87595273ae1","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/third-party/search.styl","hash":"9f0b93d109c9aec79450c8a0cf4a4eab717d674d","modified":1651584022304},{"_id":"themes/next/source/css/_common/components/third-party/math.styl","hash":"b49e9fbd3c182b8fc066b8c2caf248e3eb748619","modified":1651584022303},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"9a878d0119785a2316f42aebcceaa05a120b9a7a","modified":1651584022304},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"5b5649b9749e3fd8b63aef22ceeece0a6e1df605","modified":1651584022303},{"_id":"themes/next/source/css/_common/outline/footer/footer.styl","hash":"454a4aebfabb4469b92a8cbb49f46c49ac9bf165","modified":1651584022304},{"_id":"themes/next/source/css/_common/outline/header/bookmark.styl","hash":"e2d606f1ac343e9be4f15dbbaf3464bc4df8bf81","modified":1651584022304},{"_id":"themes/next/source/css/_common/outline/header/github-banner.styl","hash":"e7a9fdb6478b8674b1cdf94de4f8052843fb71d9","modified":1651584022304},{"_id":"themes/next/source/css/_common/outline/header/headerband.styl","hash":"0caf32492692ba8e854da43697a2ec8a41612194","modified":1651584022304},{"_id":"themes/next/source/css/_common/outline/header/header.styl","hash":"a793cfff86ad4af818faef04c18013077873f8f0","modified":1651584022304},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"2cb1876e9e0c9ac32160888af27b1178dbcb0616","modified":1651584022304},{"_id":"themes/next/source/css/_common/outline/header/site-nav.styl","hash":"b2fc519828fe89a1f8f03ff7b809ad68cd46f3d7","modified":1651584022304},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"fa0222197b5eee47e18ac864cdc6eac75678b8fe","modified":1651584022304},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"1f0e7fbe80956f47087c2458ea880acf7a83078b","modified":1651584022305},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"b6ee998e33337e9ade63f201d00f3cc4ddd367b8","modified":1651584022305},{"_id":"themes/next/source/css/_common/outline/header/site-meta.styl","hash":"45a239edca44acecf971d99b04f30a1aafbf6906","modified":1651584022304},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"a960a2dd587b15d3b3fe1b59525d6fa971c6a6ec","modified":1651584022305},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-dimmer.styl","hash":"9b479c2f9a9bfed77885e5093b8245cc5d768ec7","modified":1651584022305},{"_id":"themes/next/source/css/_common/outline/header/menu.styl","hash":"5f432a6ed9ca80a413c68b00e93d4a411abf280a","modified":1651584022304},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar.styl","hash":"a9cd93c36bae5af9223e7804963096274e8a4f03","modified":1651584022305},{"_id":"themes/next/source/css/_common/outline/sidebar/site-state.styl","hash":"2a47f8a6bb589c2fb635e6c1e4a2563c7f63c407","modified":1651584022305},{"_id":"themes/next/source/css/_common/scaffolding/highlight/theme.styl","hash":"3b3acc5caa0b95a2598bef4eeacb21bab21bea56","modified":1651584022305},{"_id":"themes/next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"f71a3e86c05ea668b008cf05a81f67d92b6d65e4","modified":1651584022305},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"b3220db827e1adbca7880c2bb23e78fa7cbe95cb","modified":1651584022305},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"a05a4031e799bc864a4536f9ef61fe643cd421af","modified":1651584022305},{"_id":"themes/next/source/css/_common/scaffolding/highlight/highlight.styl","hash":"35c871a809afa8306c8cde13651010e282548bc6","modified":1651584022305},{"_id":"themes/next/source/css/_common/scaffolding/highlight/diff.styl","hash":"d3f73688bb7423e3ab0de1efdf6db46db5e34f80","modified":1651584022305},{"_id":"themes/next/source/css/_common/scaffolding/tags/label.styl","hash":"d7fce4b51b5f4b7c31d93a9edb6c6ce740aa0d6b","modified":1651584022306},{"_id":"themes/next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"1d2778ca5aeeeafaa690dc2766b01b352ab76a02","modified":1651584022306},{"_id":"source/_posts/k8s-rbac/de3ebdd4f016.png","hash":"b6a766011b329f668f083b6714e9842f565c3e73","modified":1651584022247},{"_id":"themes/next/source/css/_common/scaffolding/tags/note.styl","hash":"e4d9a77ffe98e851c1202676940097ba28253313","modified":1651584022306},{"_id":"themes/next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"709d10f763e357e1472d6471f8be384ec9e2d983","modified":1651584022306},{"_id":"themes/next/source/css/_common/scaffolding/tags/tabs.styl","hash":"f23670f1d8e749f3e83766d446790d8fd9620278","modified":1651584022306},{"_id":"themes/next/source/css/_common/scaffolding/tags/pdf.styl","hash":"b49c64f8e9a6ca1c45c0ba98febf1974fdd03616","modified":1651584022306},{"_id":"themes/next/source/css/_common/scaffolding/tags/tags.styl","hash":"9e4c0653cfd3cc6908fa0d97581bcf80861fb1e7","modified":1651584022306},{"_id":"themes/next/source/images/avatar.jpg","hash":"ebb2d834abbab660efa98d2db960aaf4270476f1","modified":1651584022308},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1651584022312},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1651584022312},{"_id":"source/_posts/k8s-network/k8s-nw4.png","hash":"2ce625b08cdf95ae45190ae29c6329887da573b0","modified":1675869703683},{"_id":"themes/next/source/images/background.jpeg","hash":"b9e6ecf7699b5fd7c95f50d56d2b48afe62e4488","modified":1651584022309},{"_id":"source/_posts/prometheus-grafana-notice/17.png","hash":"4233ab5fda184bb53e8a7eb413ca09bcbb9f0e54","modified":1651584022270},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls9.png","hash":"18695f8a86c0a8049b1f3804572808eceaf0ee06","modified":1653920123512},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls8.png","hash":"f5de58a056403ff94e0cafc3b578f531e8020572","modified":1653920156300},{"_id":"source/_posts/helm-deploy/helm1.png","hash":"2ab9276bbc7a6e87221fbd9bf589ee074d4c651c","modified":1651671979707},{"_id":"public/404.html","hash":"c22de48b6a94cbb09c2cc7ae281100525590d007","modified":1724936763262},{"_id":"public/atom.xml","hash":"92a6b2fa4704be6a917bbf23ceb739d979cf45de","modified":1724936763262},{"_id":"public/search.xml","hash":"88fc544f451794b890d7b7a188d914a6fa80d147","modified":1724936763262},{"_id":"public/musiclist/index.html","hash":"8e2101f2a799c84f3dd01ccf033818425897cade","modified":1724936763262},{"_id":"public/tags/index.html","hash":"299e7d9bb5ad166db14d15d8a87d6659bfc46ceb","modified":1724936763262},{"_id":"public/categories/index.html","hash":"c2ea962e70e3719f2c746060331c4f0fd5373783","modified":1724936763262},{"_id":"public/about/index.html","hash":"6d9fc299dbeedb0c0beb48d7db4c381566f715bb","modified":1724936763262},{"_id":"public/posts/c018.html","hash":"a89ee8df3c90327eb9c0d99b1356ff5fb54851e7","modified":1724936763262},{"_id":"public/posts/5d90.html","hash":"6bdb66589841b6a3db8882708cb0c60dc3eebb16","modified":1724936763262},{"_id":"public/posts/b8bc.html","hash":"111cc623e1aec16b3d384abac9b6cbad76139f57","modified":1724936763262},{"_id":"public/posts/2ead.html","hash":"c46ff72be882f4999db9725a01eed754077e4fd0","modified":1724936763262},{"_id":"public/posts/41fe.html","hash":"c79285951efec1fe2f728bbae5055c662cf58132","modified":1724936763262},{"_id":"public/posts/6bfb.html","hash":"d1ce21d4d3eafd1785134857f81c00d962ee3556","modified":1724936763262},{"_id":"public/posts/28d6.html","hash":"c8d911abe154f6510054433846d3ce3cac1eefba","modified":1724936763262},{"_id":"public/posts/9bae.html","hash":"bb6aa6d4a73cadf34ded281cf79c40396944f0b4","modified":1724936763262},{"_id":"public/posts/dc02.html","hash":"3145e973d440f8c1686ec3fb035b8d14750fc60a","modified":1724936763262},{"_id":"public/posts/754e.html","hash":"954404a22b4b70b0da88381a2ba070844450ded2","modified":1724936763262},{"_id":"public/posts/4a2a.html","hash":"9af8746d505b975637dc349721f28fb155b70730","modified":1724936763262},{"_id":"public/posts/539.html","hash":"70c4e8e9317f4157c4f2d3da62bf270ad0d3889c","modified":1724936763262},{"_id":"public/posts/64a8.html","hash":"9303fff29b220bf2e8d5df8de6413448484942dd","modified":1724936763262},{"_id":"public/posts/9a8h.html","hash":"1a6473f7d0838f23cec2bfa9e01fa27932e46304","modified":1724936763262},{"_id":"public/posts/fdc.html","hash":"4c262d22191761186973cf524de6a2b522411c4b","modified":1724936763262},{"_id":"public/posts/8aa0.html","hash":"40910a9136a9a64aac830274b727bdfc1832d2d3","modified":1724936763262},{"_id":"public/posts/fa45.html","hash":"8b03c25a622570d35d61b8a2615fe2dc4eac71fd","modified":1724936763262},{"_id":"public/posts/3eeb.html","hash":"f53b03304e96a09d8b13270b0bf2085beb411914","modified":1724936763262},{"_id":"public/posts/ce0f.html","hash":"59559538ff7c0b6a022c9471e38e2d0d8a0a04fe","modified":1724936763262},{"_id":"public/categories/alicloud/index.html","hash":"b2c370374664a3b245562b071a02dcbc0a5c0a2d","modified":1724936763262},{"_id":"public/categories/container/index.html","hash":"a5cfecd79edd92af99b1f8e99c2dce3eacd0f914","modified":1724936763262},{"_id":"public/categories/cncf/index.html","hash":"9a4039849d6c3a1f08fd9a565baf23de60b79a25","modified":1724936763262},{"_id":"public/categories/operations/index.html","hash":"a47cd6223895cdca85a6cdd906d722d0b2762fdf","modified":1724936763262},{"_id":"public/categories/alicloud/network/index.html","hash":"6b737efb249f32135a53760a16567d103516d2ea","modified":1724936763262},{"_id":"public/categories/alicloud/cncf/index.html","hash":"c6368df37b36addc239e7884042a6a08490296d5","modified":1724936763262},{"_id":"public/categories/cncf/alicloud/index.html","hash":"4482c83801549ff22db384ad5977e1ac60801db7","modified":1724936763262},{"_id":"public/categories/middleware/index.html","hash":"32d2dcc8631215b7a281bb0ebd7f7603c83bdff1","modified":1724936763262},{"_id":"public/archives/index.html","hash":"1265b52a1257111abaa0bdca8b6c175228279317","modified":1724936763262},{"_id":"public/archives/page/2/index.html","hash":"1d33d8ce2a09bb9fa2aa99999e5c090116dfa992","modified":1724936763262},{"_id":"public/archives/2022/index.html","hash":"7077e635886f265ecfb722d31ddda8a50ab706b4","modified":1724936763262},{"_id":"public/archives/2022/page/2/index.html","hash":"ad4c8f9f3920360dcf87b726fbe1b5c1b0d9e1d2","modified":1724936763262},{"_id":"public/archives/2022/02/index.html","hash":"3bc9b36da50eed8a32c59cb5e2f0e9aed188cb46","modified":1724936763262},{"_id":"public/archives/2022/03/index.html","hash":"a2b1b749f4e9d7dc3378b8d61d9dfef5f2215dcd","modified":1724936763262},{"_id":"public/archives/2022/05/index.html","hash":"bc93b0618c3e051eb06b3ab906cdbe72664f273f","modified":1724936763262},{"_id":"public/archives/2022/06/index.html","hash":"d8528a8036f92ae0cb46e73eb8841597ff344ffd","modified":1724936763262},{"_id":"public/archives/2022/07/index.html","hash":"e389b188f7b5eade9d611e1ae3be41e1c83824f1","modified":1724936763262},{"_id":"public/archives/2022/09/index.html","hash":"05ef72a1c1922db27fe5a463dd9b4db259715e84","modified":1724936763262},{"_id":"public/archives/2022/12/index.html","hash":"5ae1232fbb1b11a173c194153479b4fec5f27a42","modified":1724936763262},{"_id":"public/archives/2023/index.html","hash":"743fc3f7b8f7e2be6ceb61776a7432ba64dffe1f","modified":1724936763262},{"_id":"public/archives/2023/02/index.html","hash":"9626d3a7bd174ca8fd108f6b39c6bb6abad68d43","modified":1724936763262},{"_id":"public/archives/2024/index.html","hash":"64e7b9002de9d56ae2bc1c668f13d3fc74752452","modified":1724936763262},{"_id":"public/archives/2024/01/index.html","hash":"045f2ece0a909c24537f7d0408044a21e2090820","modified":1724936763262},{"_id":"public/tags/ack/index.html","hash":"fb3a82229349518da7f86238733e14b1624abbad","modified":1724936763262},{"_id":"public/tags/ram/index.html","hash":"64682532639812dd2f17ae33da25c960257d2998","modified":1724936763262},{"_id":"public/tags/vpc/index.html","hash":"6b1a89433b33365b24283be40868568fad6a0b6a","modified":1724936763262},{"_id":"public/tags/docker/index.html","hash":"639835c524dd9a87695313f938e36692d7622b72","modified":1724936763262},{"_id":"public/tags/istio/index.html","hash":"2db02c65303c0a3408643c6a97784035d61f6647","modified":1724936763262},{"_id":"public/tags/git/index.html","hash":"ab5739a74e6d4cbc4909eb74faa52f6641587b12","modified":1724936763262},{"_id":"public/tags/alicloud/index.html","hash":"5f13a84b61e09ae05fe2f43590f8f216bae07809","modified":1724936763262},{"_id":"public/tags/kubernetes/index.html","hash":"44e25850bc9dcd3bcd17d6637f5bb34b6ba183c8","modified":1724936763262},{"_id":"public/tags/observability/index.html","hash":"4f8a8393b2bd1be83e645cb62b1121634a15ac9d","modified":1724936763262},{"_id":"public/tags/openssl/index.html","hash":"beffb1a6d462f89a2cdf447d5df6b008963c98ab","modified":1724936763262},{"_id":"public/tags/linux/index.html","hash":"04c439d0d455fc8b3cc57df7b6c2e0b6e4752457","modified":1724936763262},{"_id":"public/posts/fdc/ram3.png","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1724936763262},{"_id":"public/tags/rabbitmq/index.html","hash":"48d7ba5daf06a646a12e4478d8c6597f18190338","modified":1724936763262},{"_id":"public/page/2/index.html","hash":"3525f71c1fde52fa934b6bc646c6b0004154f572","modified":1724936763262},{"_id":"public/index.html","hash":"311ff8f3d7bc9885daf0ee4e13cce99376107905","modified":1724936763262},{"_id":"public/images/android-chrome-512x512.png","hash":"9e228026245f101325ff9a0b1022d92d9b47c7be","modified":1724936763262},{"_id":"public/images/apple-touch-icon.png","hash":"45a73040134a7034b8245bd3d59bedbd045ea31f","modified":1724936763262},{"_id":"public/images/android-chrome-192x192.png","hash":"cceef8d2b5000ccaf07441815a928ed569d7befe","modified":1724936763262},{"_id":"public/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1724936763262},{"_id":"public/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1724936763262},{"_id":"public/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1724936763262},{"_id":"public/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1724936763262},{"_id":"public/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1724936763262},{"_id":"public/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1724936763262},{"_id":"public/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1724936763262},{"_id":"public/images/favicon-32x32.png","hash":"c0d78017d384b14a506b643d5da5922cd9c874f4","modified":1724936763262},{"_id":"public/images/favicon-16x16.png","hash":"8b5ca499cc5685f629f28219c10056466842aedf","modified":1724936763262},{"_id":"public/images/logo.svg","hash":"264fd86714b6f257a4cdafa42fc8e8d01432f1fb","modified":1724936763262},{"_id":"public/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1724936763262},{"_id":"public/images/favicon.ico","hash":"bd55b6d87a8138974a88950eba2d1c7d1c3f048b","modified":1724936763262},{"_id":"public/CNAME","hash":"d51215c5b96a0da78f3308a910cdce7d308f31cb","modified":1724936763262},{"_id":"public/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1724936763262},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1724936763262},{"_id":"public/posts/754e/k8s4.png","hash":"6aa83ddbf3e30faf0470132a1eed2082d59ef9f9","modified":1724936763262},{"_id":"public/posts/5d90/k8s-nw1.png","hash":"391065f8d0bb31b5532d644ef00754cc784cc07d","modified":1724936763262},{"_id":"public/posts/5d90/k8s-nw2.png","hash":"69e0e6620d6d22f2b648b709a49b8dd35041b330","modified":1724936763262},{"_id":"public/posts/5d90/k8s-nw3.png","hash":"947cc0578cae966815d91c328c6c7d28daf5dff0","modified":1724936763262},{"_id":"public/posts/5d90/k8s-nw8.png","hash":"bbbfb00a31db94cb4ee22af8f05282601eec5681","modified":1724936763262},{"_id":"public/posts/9bae/rbmq3.png","hash":"18703c0eaba69f5c3ffe7ac1974f2942f94aabb7","modified":1724936763262},{"_id":"public/posts/9bae/rbmq5.png","hash":"66b61a85a11a414b98118a09f7802fe63cb2b6ed","modified":1724936763262},{"_id":"public/images/avatar.jpg","hash":"ebb2d834abbab660efa98d2db960aaf4270476f1","modified":1724936763262},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1724936763262},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1724936763262},{"_id":"public/assets/js/Meting.min.js","hash":"a0585220b918d78649a7893279e1ec4fb5abe835","modified":1724936763262},{"_id":"public/assets/css/APlayer.min.css","hash":"07372a2ba507388d0fed166d761b1c2c2a659dce","modified":1724936763262},{"_id":"public/assets/js/APlayer.min.js","hash":"22caa28ff6b41a16ff40f15d38f1739e22359478","modified":1724936763262},{"_id":"public/posts/4a2a/acksls10.png","hash":"2f8532ccf93fca2a54aeb0b7aa065b470aa482ec","modified":1724936763262},{"_id":"public/posts/ce0f/helm3.png","hash":"d3c7998f0a1eea7a45b89f7501d8c0c2184d91d2","modified":1724936763262},{"_id":"public/posts/ce0f/helm2.png","hash":"6f9e17f844e5d17aad5496b36c36e0ff4b361d06","modified":1724936763262},{"_id":"public/posts/754e/k8s2.png","hash":"a302084342d68c89523f7f689a43ae4767a06c19","modified":1724936763262},{"_id":"public/posts/539/gf3.png","hash":"e7d9aa0ab06fc65ae32203b98a354baa1cace26e","modified":1724936763262},{"_id":"public/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1724936763262},{"_id":"public/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1724936763262},{"_id":"public/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1724936763262},{"_id":"public/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1724936763262},{"_id":"public/css/main.css","hash":"f0faaa06e3c39e0907eb2281ec1caf2a759f00ae","modified":1724936763262},{"_id":"public/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1724936763262},{"_id":"public/js/utils.js","hash":"730cca7f164eaf258661a61ff3f769851ff1e5da","modified":1724936763262},{"_id":"public/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1724936763262},{"_id":"public/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1724936763262},{"_id":"public/lib/pace/README.html","hash":"b1db0e6c71c25fbdc5a161e1bd70382846ce99ab","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1724936763262},{"_id":"public/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-material.min.css","hash":"f1ff83985c090f3a3236554c5ef69542dcceb049","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1724936763262},{"_id":"public/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-flat-top.min.css","hash":"5e1c97e232b46e48592a8e4983ae5a89e0a7da6a","modified":1724936763262},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1724936763262},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1724936763262},{"_id":"public/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1724936763262},{"_id":"public/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1724936763262},{"_id":"public/posts/41fe/fluent1.png","hash":"8e69e636606804c0dae89683e378d425d52bd912","modified":1724936763262},{"_id":"public/posts/41fe/fluent3.png","hash":"85db7a11048d6c414d02544b8fbb7c21aae64054","modified":1724936763262},{"_id":"public/posts/41fe/fluent4.png","hash":"96055366019a53214a52f767312f703fce248703","modified":1724936763262},{"_id":"public/posts/fa45/634be995b5bc.png","hash":"9f543f1ed29803038c5466b3046b48f4f46bb412","modified":1724936763262},{"_id":"public/posts/5d90/k8s-nw6.png","hash":"044a7ba37a744ebad84deb2218c6540872f34278","modified":1724936763262},{"_id":"public/posts/9bae/rbmq1.png","hash":"f30671f3bfb12fb7a34404a22f643a11002390bb","modified":1724936763262},{"_id":"public/posts/9bae/rbmq10.png","hash":"f1a32d7f9c94def34fc8b104e29e6f43a00e41fa","modified":1724936763262},{"_id":"public/posts/9bae/rbmq12.png","hash":"44dc4f502174980bb2b10a00026a1dc6f92cba87","modified":1724936763262},{"_id":"public/posts/9bae/rbmq11.png","hash":"441c484b202c39a5b77f401cad6b4a089697702d","modified":1724936763262},{"_id":"public/posts/9bae/rbmq4.png","hash":"a3cfcf7bbb46f44c1671443a440366e9520c80cf","modified":1724936763262},{"_id":"public/posts/9bae/rbmq7.png","hash":"2dea294cb0dc369002f2872455223978f1f7b2c9","modified":1724936763262},{"_id":"public/posts/9bae/rbmq9.png","hash":"1c76e0c1d88db133937bd3f3912a277d830941f6","modified":1724936763262},{"_id":"public/posts/9a8h/2.png","hash":"756e78903b14556b0235e5f6f37fc7e0ac639370","modified":1724936763262},{"_id":"public/posts/64a8/vpc1.png","hash":"15bfeea34245e4f5510c5e157070ca032e711ceb","modified":1724936763262},{"_id":"public/posts/4a2a/acksls12.png","hash":"a3a6908911b93afe3c68cff3026b3334ab457bb1","modified":1724936763262},{"_id":"public/posts/ce0f/helm4.png","hash":"bc6b76c4aaf08c5776f11fbf996cc186a7047382","modified":1724936763262},{"_id":"public/posts/754e/k8s1.png","hash":"9547deb721fcaaed961f6ef664dfc950a04fc8f7","modified":1724936763262},{"_id":"public/posts/754e/k8s3.png","hash":"18aa943783a1351824bbdb78ae3e0127a9390c42","modified":1724936763262},{"_id":"public/posts/539/gf12.png","hash":"0a5e4f151242bc29662a43161454b7f2d161458d","modified":1724936763262},{"_id":"public/posts/539/gf15.png","hash":"54182efd66a40daa1d36b580052edbb296cd8ab2","modified":1724936763262},{"_id":"public/posts/539/gf8.png","hash":"07444a7a4bbe315081f434a30678f0cc39ba2474","modified":1724936763262},{"_id":"public/posts/8aa0/2afdc3d69fa9.png","hash":"ee2ec4d29d2516159aeeea040d6f7ddc5f07718f","modified":1724936763262},{"_id":"public/posts/41fe/fluent2.png","hash":"545be7c6e1000b1ecaf45326bcbe356be3c77110","modified":1724936763262},{"_id":"public/posts/5d90/k8s-nw7.png","hash":"97626dafbe2d67b3f8943cebb33174b4bfe0d790","modified":1724936763262},{"_id":"public/posts/9bae/rbmq2.png","hash":"4a7e45905a42332b23da28402bcc306af55b2bf6","modified":1724936763262},{"_id":"public/posts/9bae/rbmq8.png","hash":"0185b410014d47066a51e10f8ac7555e5081beab","modified":1724936763262},{"_id":"public/posts/9bae/rbmq6.png","hash":"43c99df943628a5272bd83313f78b3043c3ab388","modified":1724936763262},{"_id":"public/posts/9a8h/10.png","hash":"98ebeaf917ff2eaa08e1461eb93ff99b8bbac6cd","modified":1724936763262},{"_id":"public/posts/9a8h/8.png","hash":"368f23564344b0e005ccd37d8979488b72214257","modified":1724936763262},{"_id":"public/posts/fdc/ram2.png","hash":"99f25eec2df909cc9e07d7195c342624b50d58d8","modified":1724936763262},{"_id":"public/posts/64a8/vpc2.png","hash":"7ccbcbba992ce1eb64b025e48ff00eeec47884a5","modified":1724936763262},{"_id":"public/posts/fdc/ram6.png","hash":"781469a74ebe155ab4a9ca08eb0023482ff3297e","modified":1724936763262},{"_id":"public/posts/fdc/ram8.png","hash":"740b8967bcc256d5247207e83af79e11221d24be","modified":1724936763262},{"_id":"public/posts/4a2a/acksls11.png","hash":"31a758e6e7e9a06a35ae0265bd84aedc708661a3","modified":1724936763262},{"_id":"public/posts/539/gf5.png","hash":"2c349dd6d441189d569759b2152fb4f71e77791d","modified":1724936763262},{"_id":"public/posts/539/gf4.png","hash":"29ca4a085f45728fc270a44e40cd151adfba1a8a","modified":1724936763262},{"_id":"public/posts/fa45/1572c2ebc891.png","hash":"57f775f88760fdcea12d1143ec21d682960c9e52","modified":1724936763262},{"_id":"public/posts/fa45/ab8f20ce2acc.png","hash":"af7e38d63e99daa064a42d7f0777863c01eb49b6","modified":1724936763262},{"_id":"public/posts/fa45/c31775e8bbe3.png","hash":"a58d8da564b0b4a01447cb0521bbd4198fd3bea2","modified":1724936763262},{"_id":"public/posts/5d90/k8s-nw5.png","hash":"61528716079e575ffab68afecd42eb64e3b3b0ef","modified":1724936763262},{"_id":"public/posts/9a8h/1.png","hash":"63c1e5df5faa1a140d3054728da94b29cf70cb75","modified":1724936763262},{"_id":"public/posts/9a8h/3.png","hash":"bd5b4a8679b5b6bb03cf4a6848b3116ea2db722a","modified":1724936763262},{"_id":"public/posts/9a8h/16.png","hash":"3c5c7cf44aeb7a025d21e6ebd96c204d91c65bcb","modified":1724936763262},{"_id":"public/posts/9a8h/5.png","hash":"fcee6b78b57dac400c5bb2fa82c5446140504ad1","modified":1724936763262},{"_id":"public/posts/9a8h/6.png","hash":"82f9cea0d6b7b8a86c1efffd9addf06172c465ab","modified":1724936763262},{"_id":"public/posts/64a8/vpc3.png","hash":"a52347fe4ed962a47d1a3d4f0f20cd197ab138a6","modified":1724936763262},{"_id":"public/posts/fdc/ram1.png","hash":"3f81fb567b165494d7b1eb1b25c052bda32c742a","modified":1724936763262},{"_id":"public/posts/fdc/ram7.png","hash":"043b10ad0217c47f6835bbcb7b9d5f5a9cd5f988","modified":1724936763262},{"_id":"public/posts/fdc/ram5.png","hash":"b2c5cf28a5480294fabfca8db9f717d6d6487b66","modified":1724936763262},{"_id":"public/posts/4a2a/acksls1.png","hash":"0a654c70f52a6403542f3fe2b3369b88239ef1dc","modified":1724936763262},{"_id":"public/posts/4a2a/acksls13.png","hash":"5c75193323836115fdb0fadf2c0e43e9072f72b9","modified":1724936763262},{"_id":"public/posts/4a2a/acksls14.png","hash":"d9cbed932627cf66058634461b79765fa67aad48","modified":1724936763262},{"_id":"public/posts/4a2a/acksls15.png","hash":"c9212adc1447f708fa092fe1b21b7cd0df2ab0ce","modified":1724936763262},{"_id":"public/posts/4a2a/acksls3.png","hash":"a67f569c44b641ab5facc083aa7a7a02b5f6889c","modified":1724936763262},{"_id":"public/posts/539/gf6.png","hash":"8447116a852a91d68acd947993405b6cf415381d","modified":1724936763262},{"_id":"public/posts/fa45/gaisu.png","hash":"c58ef01e18142f1ce637217762542a73367e483e","modified":1724936763262},{"_id":"public/posts/fa45/de4222775e67.png","hash":"99be909dcafe21213c13265bd3636ade2f77a415","modified":1724936763262},{"_id":"public/posts/9a8h/11.png","hash":"dcc4ad85ab1f4edbc0aa094b53b1d0e8493d8c88","modified":1724936763262},{"_id":"public/posts/9a8h/9.png","hash":"7f74a9f47a2d9d83fc82b884b17b8c93a1d05924","modified":1724936763262},{"_id":"public/images/background.jpeg","hash":"b9e6ecf7699b5fd7c95f50d56d2b48afe62e4488","modified":1724936763262},{"_id":"public/posts/ce0f/helm5.png","hash":"701a5e3cfd12b99d0db435681a4517428a266325","modified":1724936763262},{"_id":"public/posts/539/gf11.png","hash":"3245ba84de0a8fbf411987e2a5901ed9ec2cf6cc","modified":1724936763262},{"_id":"public/posts/539/gf2.png","hash":"13a289912911701423f80d6083c9af797acc19f5","modified":1724936763262},{"_id":"public/posts/8aa0/7b70de99e5f7.png","hash":"fd04d7733c5b1447e9c0508d92807fbf9c2421e1","modified":1724936763262},{"_id":"public/posts/8aa0/6bbe6aab7201.png","hash":"93e7a9dd7e4b7efe65eceb19d9ca28fba17950a7","modified":1724936763262},{"_id":"public/posts/fa45/7528aa1bf3da.png","hash":"9c579e40e532170a13b32abec1ebaf39378670e1","modified":1724936763262},{"_id":"public/posts/fa45/21812e1bbfad.png","hash":"ce2e8a583d00ee261c661986dc611400c87ba818","modified":1724936763262},{"_id":"public/posts/9a8h/13.png","hash":"b46a01d70f0397d238893562c74177e2620e96fa","modified":1724936763262},{"_id":"public/posts/9a8h/15.png","hash":"9bcf9769e3261a8ca84251085db63ca00078ea38","modified":1724936763262},{"_id":"public/posts/9a8h/7.png","hash":"d46ccdd0c1fec9379f28dc153dfcd53aaa3e75d6","modified":1724936763262},{"_id":"public/posts/fdc/ram4.png","hash":"d7c69a6cd55e5c6761f8d10f97df6fec7ca192d0","modified":1724936763262},{"_id":"public/posts/4a2a/acksls16.png","hash":"10b6bbc9aca654654d36d546848c36c7e893a83e","modified":1724936763262},{"_id":"public/posts/4a2a/acksls5.png","hash":"10797ce6eeb03d68022ed53cf543d7bc88ef6522","modified":1724936763262},{"_id":"public/posts/4a2a/acksls6.png","hash":"4dfbdbb054223b440881864813745ea01b1085e4","modified":1724936763262},{"_id":"public/posts/4a2a/acksls7.png","hash":"9b5a20e762e7f096539bb4bdc0780babd7524762","modified":1724936763262},{"_id":"public/posts/539/gf13.png","hash":"67bcb850aae40f8cfa0f0f004faf78c84a27ae36","modified":1724936763262},{"_id":"public/posts/539/gf14.png","hash":"a55c37098012fe7c2357f160f18b46fa3375befd","modified":1724936763262},{"_id":"public/posts/539/gf7.png","hash":"977bd10d62f62daf2f10692e75df6c011bf7c1fe","modified":1724936763262},{"_id":"public/posts/9a8h/14.png","hash":"501f84e8376fedc0036539ba36fd9e69c0906b47","modified":1724936763262},{"_id":"public/posts/64a8/vpc4.png","hash":"9334c5fb57bb6b8991b3b8ef86794ee8f5c27247","modified":1724936763262},{"_id":"public/posts/539/gf1.png","hash":"4ef3ab2f2f41d15d31e6f1845403bbfabb59d9df","modified":1724936763262},{"_id":"public/posts/fa45/d6da8c845c41.png","hash":"b614ff7f3d18a32abedd27f042286d3e911400e3","modified":1724936763262},{"_id":"public/posts/9a8h/12.png","hash":"49545c7daa918e583dc69dbd75d33b9fe0d2ded1","modified":1724936763262},{"_id":"public/posts/9a8h/4.png","hash":"34b58260b8187846fab853620311e97d3b50033a","modified":1724936763262},{"_id":"public/posts/4a2a/acksls2.png","hash":"fd46498cc37b4852ca2b8be3f412d75c1de791e9","modified":1724936763262},{"_id":"public/posts/4a2a/acksls4.png","hash":"685f32a6227218888bbb828665a0d29ff08e11ce","modified":1724936763262},{"_id":"public/posts/539/gf10.png","hash":"b23b6cb991497506195c01c55fc54fa5a912d339","modified":1724936763262},{"_id":"public/posts/b8bc/openssl-1.jpeg","hash":"f6a7f58030452e9791c4d9e7ec374d7b563c77df","modified":1724936763262},{"_id":"public/posts/539/gf9.png","hash":"699f349910e318ba1d8cdd63be891ac58b2d5747","modified":1724936763262},{"_id":"public/posts/fa45/de3ebdd4f016.png","hash":"b6a766011b329f668f083b6714e9842f565c3e73","modified":1724936763262},{"_id":"public/posts/5d90/k8s-nw4.png","hash":"2ce625b08cdf95ae45190ae29c6329887da573b0","modified":1724936763262},{"_id":"public/posts/9a8h/17.png","hash":"4233ab5fda184bb53e8a7eb413ca09bcbb9f0e54","modified":1724936763262},{"_id":"public/posts/4a2a/acksls9.png","hash":"18695f8a86c0a8049b1f3804572808eceaf0ee06","modified":1724936763262},{"_id":"public/posts/4a2a/acksls8.png","hash":"f5de58a056403ff94e0cafc3b578f531e8020572","modified":1724936763262},{"_id":"public/posts/ce0f/helm1.png","hash":"2ab9276bbc7a6e87221fbd9bf589ee074d4c651c","modified":1724936763262}],"Category":[{"name":"Alicloud","_id":"cm0fat8zi0004s0njgieg3w5h"},{"name":"Container","_id":"cm0fat8zn000ns0njdxr37li7"},{"name":"CNCF","_id":"cm0fat8zn000ss0njdmbp1ahq"},{"name":"Operations","_id":"cm0fat8zn000ws0njb5pid2pg"},{"name":"Network","parent":"cm0fat8zi0004s0njgieg3w5h","_id":"cm0fat8zo0012s0nj6aop0rhb"},{"name":"CNCF","parent":"cm0fat8zi0004s0njgieg3w5h","_id":"cm0fat8zo0019s0nja09050r2"},{"name":"Alicloud","parent":"cm0fat8zn000ss0njdmbp1ahq","_id":"cm0fat8zo001fs0nj6mwx7xvx"},{"name":"Middleware","_id":"cm0fat8zr0029s0nj7ukk0alx"}],"Data":[{"_id":"footer","data":""},{"_id":"styles","data":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n"},{"_id":"variables","data":""}],"Page":[{"title":"404","date":"2022-03-07T15:53:45.000Z","layout":"false","_content":"<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>(404) The page you were looking for doesn't exist.</title>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"//cloud.typography.com/746852/739588/css/fonts.css\" />\n  <style type=\"text/css\">\n    html,\n    body {\n      margin: 0;\n      padding: 0;\n      height: 100%;\n    }\n\n    body {\n      font-family: \"Whitney SSm A\", \"Whitney SSm B\", \"Helvetica Neue\", Helvetica, Arial, Sans-Serif;\n      background-color: #2D72D9;\n      color: #fff;\n      -moz-font-smoothing: antialiased;\n      -webkit-font-smoothing: antialiased;\n    }\n\n    .error-container {\n      text-align: center;\n      height: 100%;\n    }\n\n    @media (max-width: 480px) {\n      .error-container {\n        position: relative;\n        top: 50%;\n        height: initial;\n        -webkit-transform: translateY(-50%);\n        -ms-transform: translateY(-50%);\n        transform: translateY(-50%);\n      }\n    }\n\n    .error-container h1 {\n      margin: 0;\n      font-size: 130px;\n      font-weight: 300;\n    }\n\n    @media (min-width: 480px) {\n      .error-container h1 {\n        position: relative;\n        top: 50%;\n        -webkit-transform: translateY(-50%);\n        -ms-transform: translateY(-50%);\n        transform: translateY(-50%);\n      }\n    }\n\n    @media (min-width: 768px) {\n      .error-container h1 {\n        font-size: 220px;\n      }\n    }\n\n    .return {\n      color: rgba(255, 255, 255, 0.6);\n      font-weight: 400;\n      letter-spacing: -0.04em;\n      margin: 0;\n    }\n\n    @media (min-width: 480px) {\n      .return {\n        position: absolute;\n        width: 100%;\n        bottom: 30px;\n      }\n    }\n\n    .return a {\n      padding-bottom: 1px;\n      color: #fff;\n      text-decoration: none;\n      border-bottom: 1px solid rgba(255, 255, 255, 0.6);\n      -webkit-transition: border-color 0.1s ease-in;\n      transition: border-color 0.1s ease-in;\n    }\n\n    .return a:hover {\n      border-bottom-color: #fff;\n    }\n  </style>\n</head>\n\n<body>\n\n<div class=\"error-container\">\n  <h1>404</h1>\n  <p class=\"return\">Take me back to <a href=\"/\">yakir.top</a></p>\n</div>\n\n</body>\n</html>\n","source":"404/index.md","raw":"---\ntitle: 404\ndate: 2022-03-07 23:53:45\nlayout: false\npermalink: /404\n---\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>(404) The page you were looking for doesn't exist.</title>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"//cloud.typography.com/746852/739588/css/fonts.css\" />\n  <style type=\"text/css\">\n    html,\n    body {\n      margin: 0;\n      padding: 0;\n      height: 100%;\n    }\n\n    body {\n      font-family: \"Whitney SSm A\", \"Whitney SSm B\", \"Helvetica Neue\", Helvetica, Arial, Sans-Serif;\n      background-color: #2D72D9;\n      color: #fff;\n      -moz-font-smoothing: antialiased;\n      -webkit-font-smoothing: antialiased;\n    }\n\n    .error-container {\n      text-align: center;\n      height: 100%;\n    }\n\n    @media (max-width: 480px) {\n      .error-container {\n        position: relative;\n        top: 50%;\n        height: initial;\n        -webkit-transform: translateY(-50%);\n        -ms-transform: translateY(-50%);\n        transform: translateY(-50%);\n      }\n    }\n\n    .error-container h1 {\n      margin: 0;\n      font-size: 130px;\n      font-weight: 300;\n    }\n\n    @media (min-width: 480px) {\n      .error-container h1 {\n        position: relative;\n        top: 50%;\n        -webkit-transform: translateY(-50%);\n        -ms-transform: translateY(-50%);\n        transform: translateY(-50%);\n      }\n    }\n\n    @media (min-width: 768px) {\n      .error-container h1 {\n        font-size: 220px;\n      }\n    }\n\n    .return {\n      color: rgba(255, 255, 255, 0.6);\n      font-weight: 400;\n      letter-spacing: -0.04em;\n      margin: 0;\n    }\n\n    @media (min-width: 480px) {\n      .return {\n        position: absolute;\n        width: 100%;\n        bottom: 30px;\n      }\n    }\n\n    .return a {\n      padding-bottom: 1px;\n      color: #fff;\n      text-decoration: none;\n      border-bottom: 1px solid rgba(255, 255, 255, 0.6);\n      -webkit-transition: border-color 0.1s ease-in;\n      transition: border-color 0.1s ease-in;\n    }\n\n    .return a:hover {\n      border-bottom-color: #fff;\n    }\n  </style>\n</head>\n\n<body>\n\n<div class=\"error-container\">\n  <h1>404</h1>\n  <p class=\"return\">Take me back to <a href=\"/\">yakir.top</a></p>\n</div>\n\n</body>\n</html>\n","updated":"2024-08-29T12:45:03.324Z","path":"/404.html","comments":1,"_id":"cm0fat8ze0000s0nj6dzxgfu2","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>(404) The page you were looking for doesn't exist.</title>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"//cloud.typography.com/746852/739588/css/fonts.css\">\n  <style type=\"text/css\">\n    html,\n    body {\n      margin: 0;\n      padding: 0;\n      height: 100%;\n    }\n\n<pre><code>body &#123;\n  font-family: &quot;Whitney SSm A&quot;, &quot;Whitney SSm B&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, Sans-Serif;\n  background-color: #2D72D9;\n  color: #fff;\n  -moz-font-smoothing: antialiased;\n  -webkit-font-smoothing: antialiased;\n&#125;\n\n.error-container &#123;\n  text-align: center;\n  height: 100%;\n&#125;\n\n@media (max-width: 480px) &#123;\n  .error-container &#123;\n    position: relative;\n    top: 50%;\n    height: initial;\n    -webkit-transform: translateY(-50%);\n    -ms-transform: translateY(-50%);\n    transform: translateY(-50%);\n  &#125;\n&#125;\n\n.error-container h1 &#123;\n  margin: 0;\n  font-size: 130px;\n  font-weight: 300;\n&#125;\n\n@media (min-width: 480px) &#123;\n  .error-container h1 &#123;\n    position: relative;\n    top: 50%;\n    -webkit-transform: translateY(-50%);\n    -ms-transform: translateY(-50%);\n    transform: translateY(-50%);\n  &#125;\n&#125;\n\n@media (min-width: 768px) &#123;\n  .error-container h1 &#123;\n    font-size: 220px;\n  &#125;\n&#125;\n\n.return &#123;\n  color: rgba(255, 255, 255, 0.6);\n  font-weight: 400;\n  letter-spacing: -0.04em;\n  margin: 0;\n&#125;\n\n@media (min-width: 480px) &#123;\n  .return &#123;\n    position: absolute;\n    width: 100%;\n    bottom: 30px;\n  &#125;\n&#125;\n\n.return a &#123;\n  padding-bottom: 1px;\n  color: #fff;\n  text-decoration: none;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.6);\n  -webkit-transition: border-color 0.1s ease-in;\n  transition: border-color 0.1s ease-in;\n&#125;\n\n.return a:hover &#123;\n  border-bottom-color: #fff;\n&#125;\n</code></pre>\n<p>  </style><p></p>\n</head>\n\n<body>\n\n<div class=\"error-container\">\n  <h1>404</h1>\n  <p class=\"return\">Take me back to <a href=\"/\">yakir.top</a></p>\n</div>\n\n</body>\n</html>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":1365,"excerpt":"","more":"<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>(404) The page you were looking for doesn't exist.</title>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"//cloud.typography.com/746852/739588/css/fonts.css\">\n  <style type=\"text/css\">\n    html,\n    body {\n      margin: 0;\n      padding: 0;\n      height: 100%;\n    }\n\n<pre><code>body &#123;\n  font-family: &quot;Whitney SSm A&quot;, &quot;Whitney SSm B&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, Sans-Serif;\n  background-color: #2D72D9;\n  color: #fff;\n  -moz-font-smoothing: antialiased;\n  -webkit-font-smoothing: antialiased;\n&#125;\n\n.error-container &#123;\n  text-align: center;\n  height: 100%;\n&#125;\n\n@media (max-width: 480px) &#123;\n  .error-container &#123;\n    position: relative;\n    top: 50%;\n    height: initial;\n    -webkit-transform: translateY(-50%);\n    -ms-transform: translateY(-50%);\n    transform: translateY(-50%);\n  &#125;\n&#125;\n\n.error-container h1 &#123;\n  margin: 0;\n  font-size: 130px;\n  font-weight: 300;\n&#125;\n\n@media (min-width: 480px) &#123;\n  .error-container h1 &#123;\n    position: relative;\n    top: 50%;\n    -webkit-transform: translateY(-50%);\n    -ms-transform: translateY(-50%);\n    transform: translateY(-50%);\n  &#125;\n&#125;\n\n@media (min-width: 768px) &#123;\n  .error-container h1 &#123;\n    font-size: 220px;\n  &#125;\n&#125;\n\n.return &#123;\n  color: rgba(255, 255, 255, 0.6);\n  font-weight: 400;\n  letter-spacing: -0.04em;\n  margin: 0;\n&#125;\n\n@media (min-width: 480px) &#123;\n  .return &#123;\n    position: absolute;\n    width: 100%;\n    bottom: 30px;\n  &#125;\n&#125;\n\n.return a &#123;\n  padding-bottom: 1px;\n  color: #fff;\n  text-decoration: none;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.6);\n  -webkit-transition: border-color 0.1s ease-in;\n  transition: border-color 0.1s ease-in;\n&#125;\n\n.return a:hover &#123;\n  border-bottom-color: #fff;\n&#125;\n</code></pre>\n<p>  </style><p></p>\n</head>\n\n<body>\n\n<div class=\"error-container\">\n  <h1>404</h1>\n  <p class=\"return\">Take me back to <a href=\"/\">yakir.top</a></p>\n</div>\n\n</body>\n</html>\n"},{"title":"","date":"2022-03-08T14:53:42.000Z","type":"musiclist","_content":"{% meting \"1781370591\" \"tencent\" \"playlist\" \"theme:#FF4081\" \"mode:circulation\" \"mutex:true\" \"listmaxheight:340px\" \"preload:auto\" %}\n","source":"musiclist/index.md","raw":"---\ntitle: \ndate: 2022-03-08 22:53:42\ntype: musiclist\n---\n{% meting \"1781370591\" \"tencent\" \"playlist\" \"theme:#FF4081\" \"mode:circulation\" \"mutex:true\" \"listmaxheight:340px\" \"preload:auto\" %}\n","updated":"2022-05-03T13:20:22.289Z","path":"musiclist/index.html","comments":1,"layout":"page","_id":"cm0fat8zh0002s0nj4kx88mks","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script>\n    <div id=\"aplayer-mCmSfYzR\" class=\"aplayer aplayer-tag-marker meting-tag-marker\" data-id=\"1781370591\" data-server=\"tencent\" data-type=\"playlist\" data-mode=\"circulation\" data-autoplay=\"false\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#FF4081\"></div>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":0,"excerpt":"","more":"\n    <div id=\"aplayer-mCmSfYzR\" class=\"aplayer aplayer-tag-marker meting-tag-marker\" data-id=\"1781370591\" data-server=\"tencent\" data-type=\"playlist\" data-mode=\"circulation\" data-autoplay=\"false\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#FF4081\"></div>\n"},{"title":"","date":"2022-03-01T15:40:17.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: \ndate: 2022-03-01 23:40:17\ntype: categories\n---\n","updated":"2022-05-03T13:20:22.289Z","path":"categories/index.html","comments":1,"layout":"page","_id":"cm0fat8zj0006s0nj5yrsffbj","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script>","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":0,"excerpt":"","more":""},{"title":"","date":"2022-03-01T15:42:07.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: \ndate: 2022-03-01 23:42:07\ntype: tags\n---\n","updated":"2022-05-03T13:20:22.289Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cm0fat8zj0008s0njhhbzcyv1","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script>","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":0,"excerpt":"","more":""},{"title":"","date":"2022-03-01T16:17:07.000Z","_content":"### \n\n\n\nGitbub https://github.com/yakir3\n\nGithubPages + Hexo + Next \n","source":"about/index.md","raw":"---\ntitle: \ndate: 2022-03-02 00:17:07\n---\n### \n\n\n\nGitbub https://github.com/yakir3\n\nGithubPages + Hexo + Next \n","updated":"2022-05-03T13:20:22.289Z","path":"about/index.html","comments":1,"layout":"page","_id":"cm0fat8zk000as0nj41955b4z","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>Gitbub <a href=\"https://github.com/yakir3\">https://github.com/yakir3</a></p>\n<p>GithubPages + Hexo + Next </p>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":75,"excerpt":"","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>Gitbub <a href=\"https://github.com/yakir3\">https://github.com/yakir3</a></p>\n<p>GithubPages + Hexo + Next </p>\n"}],"Post":[{"title":"ACK  SLS","abbrlink":"4a2a","date":"2022-05-31T14:38:39.000Z","_content":"## \n**ACK Logtail**\n\n- LogtailACK \n{% asset_img acksls1.png %}\n\n<!--more-->\n- LogtailACK-->  -->  --> logtail-ds \n{% asset_img acksls2.png %}\n\n- SLS Project\n\n{% asset_img acksls3.png %}\n\n\n## \n### 2.1 ACK \n> volumeMountsvolumes \n\n#### 1\n\n- \n\n{% asset_img acksls4.png %}\n\n- \n\n{% asset_img acksls5.png %}\n{% asset_img acksls6.png %}\n\n#### 2YAML Deployment / Pod\n\n- \n> - name: aliyun_logs_{Logstore}   \n>    value: {}  \n\n\n- \n\nPod \n```yaml\napiVersion: v1\nkind: Pod\nspec:\n  containers:\n  - name: my-demo-app\n    env:\n    #########   ###########\n    - name: aliyun_logs_log-stdout\n      value: stdout\n    - name: aliyun_logs_log-varlog\n      value: /var/log/*.log\n    - name: aliyun_logs_mytag1_tags\n      value: tag1=v1\n    ###############################\n    ######### volume mount ###########\n    volumeMounts:\n    - name: volumn-sls-mydemo\n      mountPath: /var/log\n  volumes:\n  - name: volumn-sls-mydemo\n    emptyDir: {}\n  ###############################\n```\ndeployment \n```yaml\napiVersion: apps/v1\nkind: Deployment\nspec:\n  template:\n    spec:\n      containers:\n        - args: xxx-args\n          env:\n            - name: aliyun_logs_app-110760134-domain-event-center\n              value: stdout\n          image: xxx-image\n```\nlogstore \n```yaml\n#A \n#########   ###########\n    - name: aliyun_logs_app1-stdout\n      value: stdout\n    - name: aliyun_logs_app1-stdout_logstore\n      value: stdout-logstore\n      \n      \n#B \n#########   ###########\n    - name: aliyun_logs_app2-stdout\n      value: stdout\n    - name: aliyun_logs_app2-stdout_logstore\n      value: stdout-logstore\n```\n\n#### 3\n\n- SLS Project\n\n{% asset_img acksls7.png %}\n\n- \n\n{% asset_img acksls8.png %}\n\n#### 4\n\n- \n> ****\n> **    namespace logstore __tag__ **\n> **    tag tag **\n> {% asset_img acksls9.png %}\n\n> Alicloud[https://help.aliyun.com/document_detail/87540.html](https://help.aliyun.com/document_detail/87540.html)\n\n\n\n### 2.2 DaemonSet \n#### 1DaemonSet \n> \n\n- SLS  **Kubenetes - **\n\n{% asset_img acksls10.png %}\n\n- / Project store\n\n{% asset_img acksls11.png %}\n\n- \n\n{% asset_img acksls12.png %}\n\n- \n\n{% asset_img acksls13.png %}\n```json\n{\n  \"inputs\": [\n    {\n      \"detail\": {\n        \"IncludeLabel\": {},\n        \"ExcludeLabel\": {\"io.kubernetes.container.name\": \"camel-k-operator\"},\n        \"IncludeEnv\": {\"CAMEL_K_INTEGRATION\": \"\"},\n      },\n      \"type\": \"service_docker_stdout\"\n    }\n  ]\n}\n```\n\n- SLS Project\n\n{% asset_img acksls14.png %}\n{% asset_img acksls15.png %}\n\n- 1 min\n\n{% asset_img acksls16.png %}\n\n#### 2DaemonSet CRD \n> Edas \n\n[https://help.aliyun.com/document_detail/74878.htm](https://help.aliyun.com/document_detail/74878.htm)\n\n### 2.3 Sidecar \n#### 1Sidecar \n[https://help.aliyun.com/document_detail/100575.htm](https://help.aliyun.com/document_detail/100575.htm)\n\n#### 2Sidecar CRD \n[https://help.aliyun.com/document_detail/100575.htm](https://help.aliyun.com/document_detail/100575.htm)\n\n> Alicloud[https://help.aliyun.com/document_detail/66654.html](https://help.aliyun.com/document_detail/66654.html)\n\n","source":"_posts/alicloud-ack-sls-deploy.md","raw":"---\ntitle: ACK  SLS\ncategories:\n  - Alicloud\ntags:\n  - ACK\nabbrlink: 4a2a\ndate: 2022-05-31 22:38:39\n---\n## \n**ACK Logtail**\n\n- LogtailACK \n{% asset_img acksls1.png %}\n\n<!--more-->\n- LogtailACK-->  -->  --> logtail-ds \n{% asset_img acksls2.png %}\n\n- SLS Project\n\n{% asset_img acksls3.png %}\n\n\n## \n### 2.1 ACK \n> volumeMountsvolumes \n\n#### 1\n\n- \n\n{% asset_img acksls4.png %}\n\n- \n\n{% asset_img acksls5.png %}\n{% asset_img acksls6.png %}\n\n#### 2YAML Deployment / Pod\n\n- \n> - name: aliyun_logs_{Logstore}   \n>    value: {}  \n\n\n- \n\nPod \n```yaml\napiVersion: v1\nkind: Pod\nspec:\n  containers:\n  - name: my-demo-app\n    env:\n    #########   ###########\n    - name: aliyun_logs_log-stdout\n      value: stdout\n    - name: aliyun_logs_log-varlog\n      value: /var/log/*.log\n    - name: aliyun_logs_mytag1_tags\n      value: tag1=v1\n    ###############################\n    ######### volume mount ###########\n    volumeMounts:\n    - name: volumn-sls-mydemo\n      mountPath: /var/log\n  volumes:\n  - name: volumn-sls-mydemo\n    emptyDir: {}\n  ###############################\n```\ndeployment \n```yaml\napiVersion: apps/v1\nkind: Deployment\nspec:\n  template:\n    spec:\n      containers:\n        - args: xxx-args\n          env:\n            - name: aliyun_logs_app-110760134-domain-event-center\n              value: stdout\n          image: xxx-image\n```\nlogstore \n```yaml\n#A \n#########   ###########\n    - name: aliyun_logs_app1-stdout\n      value: stdout\n    - name: aliyun_logs_app1-stdout_logstore\n      value: stdout-logstore\n      \n      \n#B \n#########   ###########\n    - name: aliyun_logs_app2-stdout\n      value: stdout\n    - name: aliyun_logs_app2-stdout_logstore\n      value: stdout-logstore\n```\n\n#### 3\n\n- SLS Project\n\n{% asset_img acksls7.png %}\n\n- \n\n{% asset_img acksls8.png %}\n\n#### 4\n\n- \n> ****\n> **    namespace logstore __tag__ **\n> **    tag tag **\n> {% asset_img acksls9.png %}\n\n> Alicloud[https://help.aliyun.com/document_detail/87540.html](https://help.aliyun.com/document_detail/87540.html)\n\n\n\n### 2.2 DaemonSet \n#### 1DaemonSet \n> \n\n- SLS  **Kubenetes - **\n\n{% asset_img acksls10.png %}\n\n- / Project store\n\n{% asset_img acksls11.png %}\n\n- \n\n{% asset_img acksls12.png %}\n\n- \n\n{% asset_img acksls13.png %}\n```json\n{\n  \"inputs\": [\n    {\n      \"detail\": {\n        \"IncludeLabel\": {},\n        \"ExcludeLabel\": {\"io.kubernetes.container.name\": \"camel-k-operator\"},\n        \"IncludeEnv\": {\"CAMEL_K_INTEGRATION\": \"\"},\n      },\n      \"type\": \"service_docker_stdout\"\n    }\n  ]\n}\n```\n\n- SLS Project\n\n{% asset_img acksls14.png %}\n{% asset_img acksls15.png %}\n\n- 1 min\n\n{% asset_img acksls16.png %}\n\n#### 2DaemonSet CRD \n> Edas \n\n[https://help.aliyun.com/document_detail/74878.htm](https://help.aliyun.com/document_detail/74878.htm)\n\n### 2.3 Sidecar \n#### 1Sidecar \n[https://help.aliyun.com/document_detail/100575.htm](https://help.aliyun.com/document_detail/100575.htm)\n\n#### 2Sidecar CRD \n[https://help.aliyun.com/document_detail/100575.htm](https://help.aliyun.com/document_detail/100575.htm)\n\n> Alicloud[https://help.aliyun.com/document_detail/66654.html](https://help.aliyun.com/document_detail/66654.html)\n\n","slug":"alicloud-ack-sls-deploy","published":1,"updated":"2024-01-21T15:28:43.149Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zg0001s0njgl080pl2","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong>ACK Logtail</strong></p>\n<ul>\n<li>LogtailACK <img data-src=\"/posts/4a2a/acksls1.png\" class></li>\n</ul>\n<span id=\"more\"></span>\n<ul>\n<li><p>LogtailACK&gt;  &gt;  &gt; logtail-ds </p>\n<img data-src=\"/posts/4a2a/acksls2.png\" class>\n</li>\n<li><p>SLS Project</p>\n</li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls3.png\" class>\n\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"2-1-ACK-\"><a href=\"#2-1-ACK-\" class=\"headerlink\" title=\"2.1 ACK \"></a>2.1 ACK </h3><blockquote>\n<p>volumeMountsvolumes </p>\n</blockquote>\n<h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h4><ul>\n<li></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls4.png\" class>\n\n<ul>\n<li></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls5.png\" class>\n<img data-src=\"/posts/4a2a/acksls6.png\" class>\n\n<h4 id=\"2YAML-Deployment-x2F-Pod\"><a href=\"#2YAML-Deployment-x2F-Pod\" class=\"headerlink\" title=\"2YAML Deployment &#x2F; Pod\"></a>2YAML Deployment &#x2F; Pod</h4><ul>\n<li><p></p>\n<blockquote>\n<ul>\n<li>name: aliyun_logs_{Logstore}<br> value: {}</li>\n</ul>\n</blockquote>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p>Pod </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">my-demo-app</span></span><br><span class=\"line\">    <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"comment\">#########   ###########</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_log-stdout</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">stdout</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_log-varlog</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">/var/log/*.log</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_mytag1_tags</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">tag1=v1</span></span><br><span class=\"line\">    <span class=\"comment\">###############################</span></span><br><span class=\"line\">    <span class=\"comment\">######### volume mount ###########</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">volumn-sls-mydemo</span></span><br><span class=\"line\">      <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/log</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">volumn-sls-mydemo</span></span><br><span class=\"line\">    <span class=\"attr\">emptyDir:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"comment\">###############################</span></span><br></pre></td></tr></table></figure>\n<p>deployment </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">args:</span> <span class=\"string\">xxx-args</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_app-110760134-domain-event-center</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">stdout</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">xxx-image</span></span><br></pre></td></tr></table></figure>\n<p>logstore </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#A </span></span><br><span class=\"line\"><span class=\"comment\">#########   ###########</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_app1-stdout</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">stdout</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_app1-stdout_logstore</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">stdout-logstore</span></span><br><span class=\"line\">      </span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"comment\">#B </span></span><br><span class=\"line\"><span class=\"comment\">#########   ###########</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_app2-stdout</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">stdout</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_app2-stdout_logstore</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">stdout-logstore</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><ul>\n<li>SLS Project</li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls7.png\" class>\n\n<ul>\n<li></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls8.png\" class>\n\n<h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><ul>\n<li><blockquote>\n<p><strong></strong><br>**    namespace logstore __tag__ **<br>**    tag tag **</p>\n<img data-src=\"/posts/4a2a/acksls9.png\" class></blockquote>\n</li>\n</ul>\n<blockquote>\n<p>Alicloud<a href=\"https://help.aliyun.com/document_detail/87540.html\">https://help.aliyun.com/document_detail&#x2F;87540.html</a></p>\n</blockquote>\n<h3 id=\"2-2-DaemonSet-\"><a href=\"#2-2-DaemonSet-\" class=\"headerlink\" title=\"2.2 DaemonSet \"></a>2.2 DaemonSet </h3><h4 id=\"1DaemonSet-\"><a href=\"#1DaemonSet-\" class=\"headerlink\" title=\"1DaemonSet \"></a>1DaemonSet </h4><blockquote>\n<p></p>\n</blockquote>\n<ul>\n<li>SLS  <strong>Kubenetes - </strong></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls10.png\" class>\n\n<ul>\n<li>&#x2F; Project store</li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls11.png\" class>\n\n<ul>\n<li></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls12.png\" class>\n\n<ul>\n<li></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls13.png\" class>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;inputs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;detail&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;IncludeLabel&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;ExcludeLabel&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;io.kubernetes.container.name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;camel-k-operator&quot;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;IncludeEnv&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;CAMEL_K_INTEGRATION&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;service_docker_stdout&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>SLS Project</li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls14.png\" class>\n<img data-src=\"/posts/4a2a/acksls15.png\" class>\n\n<ul>\n<li>1 min</li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls16.png\" class>\n\n<h4 id=\"2DaemonSet-CRD-\"><a href=\"#2DaemonSet-CRD-\" class=\"headerlink\" title=\"2DaemonSet CRD \"></a>2DaemonSet CRD </h4><blockquote>\n<p>Edas </p>\n</blockquote>\n<p><a href=\"https://help.aliyun.com/document_detail/74878.htm\">https://help.aliyun.com/document_detail&#x2F;74878.htm</a></p>\n<h3 id=\"2-3-Sidecar-\"><a href=\"#2-3-Sidecar-\" class=\"headerlink\" title=\"2.3 Sidecar \"></a>2.3 Sidecar </h3><h4 id=\"1Sidecar-\"><a href=\"#1Sidecar-\" class=\"headerlink\" title=\"1Sidecar \"></a>1Sidecar </h4><p><a href=\"https://help.aliyun.com/document_detail/100575.htm\">https://help.aliyun.com/document_detail&#x2F;100575.htm</a></p>\n<h4 id=\"2Sidecar-CRD-\"><a href=\"#2Sidecar-CRD-\" class=\"headerlink\" title=\"2Sidecar CRD \"></a>2Sidecar CRD </h4><p><a href=\"https://help.aliyun.com/document_detail/100575.htm\">https://help.aliyun.com/document_detail&#x2F;100575.htm</a></p>\n<blockquote>\n<p>Alicloud<a href=\"https://help.aliyun.com/document_detail/66654.html\">https://help.aliyun.com/document_detail&#x2F;66654.html</a></p>\n</blockquote>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":2420,"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong>ACK Logtail</strong></p>\n<ul>\n<li>LogtailACK <img data-src=\"/posts/4a2a/acksls1.png\" class></li>\n</ul>","more":"<ul>\n<li><p>LogtailACK&gt;  &gt;  &gt; logtail-ds </p>\n<img data-src=\"/posts/4a2a/acksls2.png\" class>\n</li>\n<li><p>SLS Project</p>\n</li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls3.png\" class>\n\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"2-1-ACK-\"><a href=\"#2-1-ACK-\" class=\"headerlink\" title=\"2.1 ACK \"></a>2.1 ACK </h3><blockquote>\n<p>volumeMountsvolumes </p>\n</blockquote>\n<h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h4><ul>\n<li></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls4.png\" class>\n\n<ul>\n<li></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls5.png\" class>\n<img data-src=\"/posts/4a2a/acksls6.png\" class>\n\n<h4 id=\"2YAML-Deployment-x2F-Pod\"><a href=\"#2YAML-Deployment-x2F-Pod\" class=\"headerlink\" title=\"2YAML Deployment &#x2F; Pod\"></a>2YAML Deployment &#x2F; Pod</h4><ul>\n<li><p></p>\n<blockquote>\n<ul>\n<li>name: aliyun_logs_{Logstore}<br> value: {}</li>\n</ul>\n</blockquote>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p>Pod </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">my-demo-app</span></span><br><span class=\"line\">    <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"comment\">#########   ###########</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_log-stdout</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">stdout</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_log-varlog</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">/var/log/*.log</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_mytag1_tags</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">tag1=v1</span></span><br><span class=\"line\">    <span class=\"comment\">###############################</span></span><br><span class=\"line\">    <span class=\"comment\">######### volume mount ###########</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">volumn-sls-mydemo</span></span><br><span class=\"line\">      <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/log</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">volumn-sls-mydemo</span></span><br><span class=\"line\">    <span class=\"attr\">emptyDir:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"comment\">###############################</span></span><br></pre></td></tr></table></figure>\n<p>deployment </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">args:</span> <span class=\"string\">xxx-args</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_app-110760134-domain-event-center</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">stdout</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">xxx-image</span></span><br></pre></td></tr></table></figure>\n<p>logstore </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#A </span></span><br><span class=\"line\"><span class=\"comment\">#########   ###########</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_app1-stdout</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">stdout</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_app1-stdout_logstore</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">stdout-logstore</span></span><br><span class=\"line\">      </span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"comment\">#B </span></span><br><span class=\"line\"><span class=\"comment\">#########   ###########</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_app2-stdout</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">stdout</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">aliyun_logs_app2-stdout_logstore</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">stdout-logstore</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><ul>\n<li>SLS Project</li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls7.png\" class>\n\n<ul>\n<li></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls8.png\" class>\n\n<h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><ul>\n<li><blockquote>\n<p><strong></strong><br>**    namespace logstore __tag__ **<br>**    tag tag **</p>\n<img data-src=\"/posts/4a2a/acksls9.png\" class></blockquote>\n</li>\n</ul>\n<blockquote>\n<p>Alicloud<a href=\"https://help.aliyun.com/document_detail/87540.html\">https://help.aliyun.com/document_detail&#x2F;87540.html</a></p>\n</blockquote>\n<h3 id=\"2-2-DaemonSet-\"><a href=\"#2-2-DaemonSet-\" class=\"headerlink\" title=\"2.2 DaemonSet \"></a>2.2 DaemonSet </h3><h4 id=\"1DaemonSet-\"><a href=\"#1DaemonSet-\" class=\"headerlink\" title=\"1DaemonSet \"></a>1DaemonSet </h4><blockquote>\n<p></p>\n</blockquote>\n<ul>\n<li>SLS  <strong>Kubenetes - </strong></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls10.png\" class>\n\n<ul>\n<li>&#x2F; Project store</li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls11.png\" class>\n\n<ul>\n<li></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls12.png\" class>\n\n<ul>\n<li></li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls13.png\" class>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;inputs&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;detail&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;IncludeLabel&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;ExcludeLabel&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;io.kubernetes.container.name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;camel-k-operator&quot;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;IncludeEnv&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;CAMEL_K_INTEGRATION&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;service_docker_stdout&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>SLS Project</li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls14.png\" class>\n<img data-src=\"/posts/4a2a/acksls15.png\" class>\n\n<ul>\n<li>1 min</li>\n</ul>\n<img data-src=\"/posts/4a2a/acksls16.png\" class>\n\n<h4 id=\"2DaemonSet-CRD-\"><a href=\"#2DaemonSet-CRD-\" class=\"headerlink\" title=\"2DaemonSet CRD \"></a>2DaemonSet CRD </h4><blockquote>\n<p>Edas </p>\n</blockquote>\n<p><a href=\"https://help.aliyun.com/document_detail/74878.htm\">https://help.aliyun.com/document_detail&#x2F;74878.htm</a></p>\n<h3 id=\"2-3-Sidecar-\"><a href=\"#2-3-Sidecar-\" class=\"headerlink\" title=\"2.3 Sidecar \"></a>2.3 Sidecar </h3><h4 id=\"1Sidecar-\"><a href=\"#1Sidecar-\" class=\"headerlink\" title=\"1Sidecar \"></a>1Sidecar </h4><p><a href=\"https://help.aliyun.com/document_detail/100575.htm\">https://help.aliyun.com/document_detail&#x2F;100575.htm</a></p>\n<h4 id=\"2Sidecar-CRD-\"><a href=\"#2Sidecar-CRD-\" class=\"headerlink\" title=\"2Sidecar CRD \"></a>2Sidecar CRD </h4><p><a href=\"https://help.aliyun.com/document_detail/100575.htm\">https://help.aliyun.com/document_detail&#x2F;100575.htm</a></p>\n<blockquote>\n<p>Alicloud<a href=\"https://help.aliyun.com/document_detail/66654.html\">https://help.aliyun.com/document_detail&#x2F;66654.html</a></p>\n</blockquote>"},{"title":"Alicloud-RAM  STS ","abbrlink":"fdc","date":"2022-03-20T15:37:32.000Z","_content":"### \nOpenApi\n\n-  AK+SK AK\n- AlicloudRAM/AlicloudECS/SSO AssumeRole STS AK+SK+STSToken \n\n### \n\n1. STS\n- AlicloudSTSSecurity Token ServiceAlicloudRAMRAMRAMRAMSTSSTS Token\n\n<!--more-->\n[https://help.aliyun.com/document_detail/28756.html](https://help.aliyun.com/document_detail/28756.html)\n\n2. RAM\n- RAMAlicloudAccessKeyAPI\n- **RAM**RAMSTStokenArnRAMAlicloudarn\n- RAMPolicy\n\n{% asset_img ram1.png %}\n\n> RAM\n> - **Alicloud**RAMRAMAlicloudAlicloud\n> - **Alicloud**\n>    - \n>    - \n>    - AlicloudECS/RAMRDSKMS\n> \n{% asset_img ram2.png %}\n> - ****AlicloudSSO\n> \n> **RAM Alicloud OSS**\n> - RAM[https://help.aliyun.com/document_detail/116819.html](https://help.aliyun.com/document_detail/116819.html)\n> - OSS Alicloud [https://help.aliyun.com/document_detail/100624.html](https://help.aliyun.com/document_detail/100624.html)\n\n\n### STSOSS\n1\ndevops_test@xxx.onaliyun.com\nAKxxxxx\nSKxxxxx\nARNacs:ram::xxxxx:role/xxx-sts\nOSS Bucketoss-test\nOSSdir111/dir111_secondline1/\n\n2\n\n- RAMAK SK \n- STS\n\n{% asset_img ram3.png %}\n\n- OSSPolicy[https://help.aliyun.com/document_detail/266627.html](https://help.aliyun.com/document_detail/266627.html)\n\n{% asset_img ram4.png %}\n\n- RAMPolicy\n\n{% asset_img ram5.png %}\n\n{% asset_img ram6.png %}\n\n3RAMossutilossbrowser\n\n- ossutil[https://help.aliyun.com/document_detail/50451.html](https://help.aliyun.com/document_detail/50451.html)\n\n{% asset_img ram7.png %}\n\n- ossbrowser[https://help.aliyun.com/document_detail/92268.html](https://help.aliyun.com/document_detail/92268.html)\n\n\n4ARN\n\n> \n> 1. /AssumeRoleSTSSTS**AliyunSTSAssumeRoleAccess**RAM\n> 1. STSAK+SK+token\n> 1. STSPolicy Policy\n> - STSPolicy\n> - SDK/APIpolicy_text[https://help.aliyun.com/document_detail/100624.html](https://help.aliyun.com/document_detail/100624.html)\n> {% asset_img ram8.png %}\n\n\n### \n\n1. oss bucketSTS ARN\n\n2. \n+ oss bucket\n+ endpoint: oss bucket\n+ bucket-name: oss bucket\n+ OSS RAM\n\n3. RAMPolicyoss RAMRAMARN\n","source":"_posts/alicloud-ram-sts.md","raw":"---\ntitle: Alicloud-RAM  STS \ncategories:\n  - Alicloud\ntags:\n  - RAM\nabbrlink: fdc\ndate: 2022-03-20 23:37:32\n---\n### \nOpenApi\n\n-  AK+SK AK\n- AlicloudRAM/AlicloudECS/SSO AssumeRole STS AK+SK+STSToken \n\n### \n\n1. STS\n- AlicloudSTSSecurity Token ServiceAlicloudRAMRAMRAMRAMSTSSTS Token\n\n<!--more-->\n[https://help.aliyun.com/document_detail/28756.html](https://help.aliyun.com/document_detail/28756.html)\n\n2. RAM\n- RAMAlicloudAccessKeyAPI\n- **RAM**RAMSTStokenArnRAMAlicloudarn\n- RAMPolicy\n\n{% asset_img ram1.png %}\n\n> RAM\n> - **Alicloud**RAMRAMAlicloudAlicloud\n> - **Alicloud**\n>    - \n>    - \n>    - AlicloudECS/RAMRDSKMS\n> \n{% asset_img ram2.png %}\n> - ****AlicloudSSO\n> \n> **RAM Alicloud OSS**\n> - RAM[https://help.aliyun.com/document_detail/116819.html](https://help.aliyun.com/document_detail/116819.html)\n> - OSS Alicloud [https://help.aliyun.com/document_detail/100624.html](https://help.aliyun.com/document_detail/100624.html)\n\n\n### STSOSS\n1\ndevops_test@xxx.onaliyun.com\nAKxxxxx\nSKxxxxx\nARNacs:ram::xxxxx:role/xxx-sts\nOSS Bucketoss-test\nOSSdir111/dir111_secondline1/\n\n2\n\n- RAMAK SK \n- STS\n\n{% asset_img ram3.png %}\n\n- OSSPolicy[https://help.aliyun.com/document_detail/266627.html](https://help.aliyun.com/document_detail/266627.html)\n\n{% asset_img ram4.png %}\n\n- RAMPolicy\n\n{% asset_img ram5.png %}\n\n{% asset_img ram6.png %}\n\n3RAMossutilossbrowser\n\n- ossutil[https://help.aliyun.com/document_detail/50451.html](https://help.aliyun.com/document_detail/50451.html)\n\n{% asset_img ram7.png %}\n\n- ossbrowser[https://help.aliyun.com/document_detail/92268.html](https://help.aliyun.com/document_detail/92268.html)\n\n\n4ARN\n\n> \n> 1. /AssumeRoleSTSSTS**AliyunSTSAssumeRoleAccess**RAM\n> 1. STSAK+SK+token\n> 1. STSPolicy Policy\n> - STSPolicy\n> - SDK/APIpolicy_text[https://help.aliyun.com/document_detail/100624.html](https://help.aliyun.com/document_detail/100624.html)\n> {% asset_img ram8.png %}\n\n\n### \n\n1. oss bucketSTS ARN\n\n2. \n+ oss bucket\n+ endpoint: oss bucket\n+ bucket-name: oss bucket\n+ OSS RAM\n\n3. RAMPolicyoss RAMRAMARN\n","slug":"alicloud-ram-sts","published":1,"updated":"2024-01-21T15:31:32.930Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zh0003s0njgnlk7dhl","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>OpenApi</p>\n<ul>\n<li> AK+SK AK</li>\n<li>AlicloudRAM&#x2F;AlicloudECS&#x2F;SSO AssumeRole STS AK+SK+STSToken </li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li>STS</li>\n</ol>\n<ul>\n<li>AlicloudSTSSecurity Token ServiceAlicloudRAMRAMRAMRAMSTSSTS Token</li>\n</ul>\n<span id=\"more\"></span>\n<p><a href=\"https://help.aliyun.com/document_detail/28756.html\">https://help.aliyun.com/document_detail&#x2F;28756.html</a></p>\n<ol start=\"2\">\n<li>RAM</li>\n</ol>\n<ul>\n<li>RAMAlicloudAccessKeyAPI</li>\n<li><strong>RAM</strong>RAMSTStokenArnRAMAlicloudarn</li>\n<li>RAMPolicy</li>\n</ul>\n<img data-src=\"/posts/fdc/ram1.png\" class>\n\n<blockquote>\n<p>RAM</p>\n<ul>\n<li><strong>Alicloud</strong>RAMRAMAlicloudAlicloud</li>\n<li><strong>Alicloud</strong><ul>\n<li></li>\n<li></li>\n<li>AlicloudECS&#x2F;RAMRDSKMS</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<img data-src=\"/posts/fdc/ram2.png\" class>\n<blockquote>\n<ul>\n<li><strong></strong>AlicloudSSO</li>\n</ul>\n<p><strong>RAM Alicloud OSS</strong></p>\n<ul>\n<li>RAM<a href=\"https://help.aliyun.com/document_detail/116819.html\">https://help.aliyun.com/document_detail&#x2F;116819.html</a></li>\n<li>OSS Alicloud <a href=\"https://help.aliyun.com/document_detail/100624.html\">https://help.aliyun.com/document_detail&#x2F;100624.html</a></li>\n</ul>\n</blockquote>\n<h3 id=\"STSOSS\"><a href=\"#STSOSS\" class=\"headerlink\" title=\"STSOSS\"></a>STSOSS</h3><p>1<br><a href=\"mailto:&#100;&#101;&#118;&#111;&#x70;&#x73;&#x5f;&#116;&#x65;&#115;&#x74;&#x40;&#x78;&#120;&#120;&#46;&#111;&#x6e;&#97;&#x6c;&#105;&#121;&#117;&#x6e;&#46;&#x63;&#111;&#x6d;\">&#100;&#101;&#118;&#111;&#x70;&#x73;&#x5f;&#116;&#x65;&#115;&#x74;&#x40;&#x78;&#120;&#120;&#46;&#111;&#x6e;&#97;&#x6c;&#105;&#121;&#117;&#x6e;&#46;&#x63;&#111;&#x6d;</a><br>AKxxxxx<br>SKxxxxx<br>ARNacs:ram::xxxxx:role&#x2F;xxx-sts<br>OSS Bucketoss-test<br>OSSdir111&#x2F;dir111_secondline1&#x2F;</p>\n<p>2</p>\n<ul>\n<li>RAMAK SK </li>\n<li>STS</li>\n</ul>\n<img data-src=\"/posts/fdc/ram3.png\" class>\n\n<ul>\n<li>OSSPolicy<a href=\"https://help.aliyun.com/document_detail/266627.html\">https://help.aliyun.com/document_detail&#x2F;266627.html</a></li>\n</ul>\n<img data-src=\"/posts/fdc/ram4.png\" class>\n\n<ul>\n<li>RAMPolicy</li>\n</ul>\n<img data-src=\"/posts/fdc/ram5.png\" class>\n\n<img data-src=\"/posts/fdc/ram6.png\" class>\n\n<p>3RAMossutilossbrowser</p>\n<ul>\n<li>ossutil<a href=\"https://help.aliyun.com/document_detail/50451.html\">https://help.aliyun.com/document_detail&#x2F;50451.html</a></li>\n</ul>\n<img data-src=\"/posts/fdc/ram7.png\" class>\n\n<ul>\n<li>ossbrowser<a href=\"https://help.aliyun.com/document_detail/92268.html\">https://help.aliyun.com/document_detail&#x2F;92268.html</a></li>\n</ul>\n<p>4ARN</p>\n<blockquote>\n<p></p>\n<ol>\n<li>&#x2F;AssumeRoleSTSSTS<strong>AliyunSTSAssumeRoleAccess</strong>RAM</li>\n<li>STSAK+SK+token</li>\n<li>STSPolicy Policy</li>\n</ol>\n<ul>\n<li>STSPolicy</li>\n<li>SDK&#x2F;APIpolicy_text<a href=\"https://help.aliyun.com/document_detail/100624.html\">https://help.aliyun.com/document_detail&#x2F;100624.html</a><img data-src=\"/posts/fdc/ram8.png\" class></li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li><p>oss bucketSTS ARN</p>\n</li>\n<li><p></p>\n</li>\n</ol>\n<ul>\n<li>oss bucket</li>\n<li>endpoint: oss bucket</li>\n<li>bucket-name: oss bucket</li>\n<li>OSS RAM</li>\n</ul>\n<ol start=\"3\">\n<li>RAMPolicyoss RAMRAMARN</li>\n</ol>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":2543,"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>OpenApi</p>\n<ul>\n<li> AK+SK AK</li>\n<li>AlicloudRAM&#x2F;AlicloudECS&#x2F;SSO AssumeRole STS AK+SK+STSToken </li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li>STS</li>\n</ol>\n<ul>\n<li>AlicloudSTSSecurity Token ServiceAlicloudRAMRAMRAMRAMSTSSTS Token</li>\n</ul>","more":"<p><a href=\"https://help.aliyun.com/document_detail/28756.html\">https://help.aliyun.com/document_detail&#x2F;28756.html</a></p>\n<ol start=\"2\">\n<li>RAM</li>\n</ol>\n<ul>\n<li>RAMAlicloudAccessKeyAPI</li>\n<li><strong>RAM</strong>RAMSTStokenArnRAMAlicloudarn</li>\n<li>RAMPolicy</li>\n</ul>\n<img data-src=\"/posts/fdc/ram1.png\" class>\n\n<blockquote>\n<p>RAM</p>\n<ul>\n<li><strong>Alicloud</strong>RAMRAMAlicloudAlicloud</li>\n<li><strong>Alicloud</strong><ul>\n<li></li>\n<li></li>\n<li>AlicloudECS&#x2F;RAMRDSKMS</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<img data-src=\"/posts/fdc/ram2.png\" class>\n<blockquote>\n<ul>\n<li><strong></strong>AlicloudSSO</li>\n</ul>\n<p><strong>RAM Alicloud OSS</strong></p>\n<ul>\n<li>RAM<a href=\"https://help.aliyun.com/document_detail/116819.html\">https://help.aliyun.com/document_detail&#x2F;116819.html</a></li>\n<li>OSS Alicloud <a href=\"https://help.aliyun.com/document_detail/100624.html\">https://help.aliyun.com/document_detail&#x2F;100624.html</a></li>\n</ul>\n</blockquote>\n<h3 id=\"STSOSS\"><a href=\"#STSOSS\" class=\"headerlink\" title=\"STSOSS\"></a>STSOSS</h3><p>1<br><a href=\"mailto:&#100;&#101;&#118;&#111;&#x70;&#x73;&#x5f;&#116;&#x65;&#115;&#x74;&#x40;&#x78;&#120;&#120;&#46;&#111;&#x6e;&#97;&#x6c;&#105;&#121;&#117;&#x6e;&#46;&#x63;&#111;&#x6d;\">&#100;&#101;&#118;&#111;&#x70;&#x73;&#x5f;&#116;&#x65;&#115;&#x74;&#x40;&#x78;&#120;&#120;&#46;&#111;&#x6e;&#97;&#x6c;&#105;&#121;&#117;&#x6e;&#46;&#x63;&#111;&#x6d;</a><br>AKxxxxx<br>SKxxxxx<br>ARNacs:ram::xxxxx:role&#x2F;xxx-sts<br>OSS Bucketoss-test<br>OSSdir111&#x2F;dir111_secondline1&#x2F;</p>\n<p>2</p>\n<ul>\n<li>RAMAK SK </li>\n<li>STS</li>\n</ul>\n<img data-src=\"/posts/fdc/ram3.png\" class>\n\n<ul>\n<li>OSSPolicy<a href=\"https://help.aliyun.com/document_detail/266627.html\">https://help.aliyun.com/document_detail&#x2F;266627.html</a></li>\n</ul>\n<img data-src=\"/posts/fdc/ram4.png\" class>\n\n<ul>\n<li>RAMPolicy</li>\n</ul>\n<img data-src=\"/posts/fdc/ram5.png\" class>\n\n<img data-src=\"/posts/fdc/ram6.png\" class>\n\n<p>3RAMossutilossbrowser</p>\n<ul>\n<li>ossutil<a href=\"https://help.aliyun.com/document_detail/50451.html\">https://help.aliyun.com/document_detail&#x2F;50451.html</a></li>\n</ul>\n<img data-src=\"/posts/fdc/ram7.png\" class>\n\n<ul>\n<li>ossbrowser<a href=\"https://help.aliyun.com/document_detail/92268.html\">https://help.aliyun.com/document_detail&#x2F;92268.html</a></li>\n</ul>\n<p>4ARN</p>\n<blockquote>\n<p></p>\n<ol>\n<li>&#x2F;AssumeRoleSTSSTS<strong>AliyunSTSAssumeRoleAccess</strong>RAM</li>\n<li>STSAK+SK+token</li>\n<li>STSPolicy Policy</li>\n</ol>\n<ul>\n<li>STSPolicy</li>\n<li>SDK&#x2F;APIpolicy_text<a href=\"https://help.aliyun.com/document_detail/100624.html\">https://help.aliyun.com/document_detail&#x2F;100624.html</a><img data-src=\"/posts/fdc/ram8.png\" class></li>\n</ul>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li><p>oss bucketSTS ARN</p>\n</li>\n<li><p></p>\n</li>\n</ol>\n<ul>\n<li>oss bucket</li>\n<li>endpoint: oss bucket</li>\n<li>bucket-name: oss bucket</li>\n<li>OSS RAM</li>\n</ul>\n<ol start=\"3\">\n<li>RAMPolicyoss RAMRAMARN</li>\n</ol>"},{"title":"VPC ","abbrlink":"64a8","date":"2022-05-04T14:17:00.000Z","_content":"### \n#### 1\n\n- /IDC IP IP \n- /VPC \n- VPC/ \n\n#### 2\nACK \n\n1. RDSECS VPC\n1. ****\n\n<!--more-->\n\n \n\n\n- VPC192.168.0.0/1610.0.0.0/8172.16.0.0/12\n- <= VPC\n\n{% asset_img vpc1.png%}\n\n- VPCVPC \n- \n- ACK \n   - Terway 10.1.0.0/16VPC-vswitch192.168.0.0/24Pod 192.168.10.0/24Service \n   - Terway 10.16.0.0/8VPC-vswitch + Pod192.168.0.0/24Service \n\n\n#### **\n\n-  192.168.0.0/1610.0.0.0/0172.16.0.0/12 VPC \n   - \n   - \n- \n\n- Terway \n   - \n{% asset_img vpc2.png %}\n\n   - \n{% asset_img vpc3.png %}\n\n\n### \n#### 11\n{% asset_img vpc4.png %}\n\n- VPC10.0.0.0/8 VPC\n- 4 \n   - test-swc-10_200_0_0_20   1\n   - test-swc-10_200_16_0_20  2\n   - test-swc-10_200_64_0_19  1\n   - test-swc-10_200_96_0_19  2\n- CIDR\n   - Node CIDR\n      - 10.200.0.0/20\n      - 10.200.16.0/20\n   - Pod CIDR\n      - 10.200.64.0/19\n      - 10.200.96.0/19\n   - Service CIDR\n      - 172.31.0.0/16\n> \n> - Node Pod Node Pod \n> - Service VPC  VPC Kubernetes \n\n#### 2\n\n- [](https://help.aliyun.com/document_detail/189596.html)\n\n- VPN\n   - [IPSec VPN ](https://cloud.tencent.com/developer/article/1824924)\n   - [Alicloud](https://help.aliyun.com/document_detail/65072.html)\n\n- [](https://www.bejson.com/convert/subnetmask/)\n\n- \n\n![.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/21956377/1646207048171-c0f5a83d-b982-4e85-ab78-f724882be069.png#clientId=ufadced67-c1c1-4&from=ui&id=u1dc1cab7&margin=%5Bobject%20Object%5D&name=%E6%80%BB%E4%BD%93%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84.png&originHeight=1993&originWidth=4131&originalType=binary&ratio=1&size=515776&status=done&style=none&taskId=uffed0b55-26c9-4f1d-b577-67c4f6f81ec)\n\n","source":"_posts/alicloud-vpc.md","raw":"---\ntitle: VPC \ncategories:\n  - Alicloud\n  - Network\ntags:\n  - VPC\nabbrlink: 64a8\ndate: 2022-05-04 22:17:00\n---\n### \n#### 1\n\n- /IDC IP IP \n- /VPC \n- VPC/ \n\n#### 2\nACK \n\n1. RDSECS VPC\n1. ****\n\n<!--more-->\n\n \n\n\n- VPC192.168.0.0/1610.0.0.0/8172.16.0.0/12\n- <= VPC\n\n{% asset_img vpc1.png%}\n\n- VPCVPC \n- \n- ACK \n   - Terway 10.1.0.0/16VPC-vswitch192.168.0.0/24Pod 192.168.10.0/24Service \n   - Terway 10.16.0.0/8VPC-vswitch + Pod192.168.0.0/24Service \n\n\n#### **\n\n-  192.168.0.0/1610.0.0.0/0172.16.0.0/12 VPC \n   - \n   - \n- \n\n- Terway \n   - \n{% asset_img vpc2.png %}\n\n   - \n{% asset_img vpc3.png %}\n\n\n### \n#### 11\n{% asset_img vpc4.png %}\n\n- VPC10.0.0.0/8 VPC\n- 4 \n   - test-swc-10_200_0_0_20   1\n   - test-swc-10_200_16_0_20  2\n   - test-swc-10_200_64_0_19  1\n   - test-swc-10_200_96_0_19  2\n- CIDR\n   - Node CIDR\n      - 10.200.0.0/20\n      - 10.200.16.0/20\n   - Pod CIDR\n      - 10.200.64.0/19\n      - 10.200.96.0/19\n   - Service CIDR\n      - 172.31.0.0/16\n> \n> - Node Pod Node Pod \n> - Service VPC  VPC Kubernetes \n\n#### 2\n\n- [](https://help.aliyun.com/document_detail/189596.html)\n\n- VPN\n   - [IPSec VPN ](https://cloud.tencent.com/developer/article/1824924)\n   - [Alicloud](https://help.aliyun.com/document_detail/65072.html)\n\n- [](https://www.bejson.com/convert/subnetmask/)\n\n- \n\n![.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/21956377/1646207048171-c0f5a83d-b982-4e85-ab78-f724882be069.png#clientId=ufadced67-c1c1-4&from=ui&id=u1dc1cab7&margin=%5Bobject%20Object%5D&name=%E6%80%BB%E4%BD%93%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84.png&originHeight=1993&originWidth=4131&originalType=binary&ratio=1&size=515776&status=done&style=none&taskId=uffed0b55-26c9-4f1d-b577-67c4f6f81ec)\n\n","slug":"alicloud-vpc","published":1,"updated":"2024-01-21T15:31:08.717Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zj0007s0nj78qnen2i","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h4><ul>\n<li>&#x2F;IDC IP IP </li>\n<li>&#x2F;VPC </li>\n<li>VPC&#x2F; </li>\n</ul>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><p>ACK </p>\n<ol>\n<li>RDSECS VPC</li>\n<li><strong></strong></li>\n</ol>\n<span id=\"more\"></span>\n\n<p> <br></p>\n<ul>\n<li>VPC192.168.0.0&#x2F;1610.0.0.0&#x2F;8172.16.0.0&#x2F;12</li>\n<li>&lt;&#x3D; VPC</li>\n</ul>\n<img data-src=\"/posts/64a8/vpc1.png\" class>\n\n<ul>\n<li>VPCVPC </li>\n<li></li>\n<li>ACK <ul>\n<li>Terway 10.1.0.0&#x2F;16VPC-vswitch192.168.0.0&#x2F;24Pod 192.168.10.0&#x2F;24Service </li>\n<li>Terway 10.16.0.0&#x2F;8VPC-vswitch + Pod192.168.0.0&#x2F;24Service </li>\n</ul>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"**\"></a>**</h4><ul>\n<li><p> 192.168.0.0&#x2F;1610.0.0.0&#x2F;0172.16.0.0&#x2F;12 VPC </p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n</li>\n<li><p></p>\n</li>\n<li><p>Terway </p>\n<ul>\n<li><p></p>\n<img data-src=\"/posts/64a8/vpc2.png\" class>\n</li>\n<li><p></p>\n</li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/64a8/vpc3.png\" class>\n\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"11\"><a href=\"#11\" class=\"headerlink\" title=\"11\"></a>11</h4><img data-src=\"/posts/64a8/vpc4.png\" class>\n\n<ul>\n<li>VPC10.0.0.0&#x2F;8 VPC</li>\n<li>4 <ul>\n<li>test-swc-10_200_0_0_20   1</li>\n<li>test-swc-10_200_16_0_20  2</li>\n<li>test-swc-10_200_64_0_19  1</li>\n<li>test-swc-10_200_96_0_19  2</li>\n</ul>\n</li>\n<li>CIDR<ul>\n<li>Node CIDR<ul>\n<li>10.200.0.0&#x2F;20</li>\n<li>10.200.16.0&#x2F;20</li>\n</ul>\n</li>\n<li>Pod CIDR<ul>\n<li>10.200.64.0&#x2F;19</li>\n<li>10.200.96.0&#x2F;19</li>\n</ul>\n</li>\n<li>Service CIDR<ul>\n<li>172.31.0.0&#x2F;16<blockquote>\n<p></p>\n<ul>\n<li>Node Pod Node Pod </li>\n<li>Service VPC  VPC Kubernetes </li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><ul>\n<li><p><a href=\"https://help.aliyun.com/document_detail/189596.html\"></a></p>\n</li>\n<li><p>VPN</p>\n<ul>\n<li><a href=\"https://cloud.tencent.com/developer/article/1824924\">IPSec VPN </a></li>\n<li><a href=\"https://help.aliyun.com/document_detail/65072.html\">Alicloud</a></li>\n</ul>\n</li>\n<li><p><a href=\"https://www.bejson.com/convert/subnetmask/\"></a></p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p><img data-src=\"https://intranetproxy.alipay.com/skylark/lark/0/2022/png/21956377/1646207048171-c0f5a83d-b982-4e85-ab78-f724882be069.png#clientId=ufadced67-c1c1-4&from=ui&id=u1dc1cab7&margin=%5Bobject%20Object%5D&name=%E6%80%BB%E4%BD%93%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84.png&originHeight=1993&originWidth=4131&originalType=binary&ratio=1&size=515776&status=done&style=none&taskId=uffed0b55-26c9-4f1d-b577-67c4f6f81ec\" alt=\".png\"></p>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":1369,"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h4><ul>\n<li>&#x2F;IDC IP IP </li>\n<li>&#x2F;VPC </li>\n<li>VPC&#x2F; </li>\n</ul>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><p>ACK </p>\n<ol>\n<li>RDSECS VPC</li>\n<li><strong></strong></li>\n</ol>","more":"<p> <br></p>\n<ul>\n<li>VPC192.168.0.0&#x2F;1610.0.0.0&#x2F;8172.16.0.0&#x2F;12</li>\n<li>&lt;&#x3D; VPC</li>\n</ul>\n<img data-src=\"/posts/64a8/vpc1.png\" class>\n\n<ul>\n<li>VPCVPC </li>\n<li></li>\n<li>ACK <ul>\n<li>Terway 10.1.0.0&#x2F;16VPC-vswitch192.168.0.0&#x2F;24Pod 192.168.10.0&#x2F;24Service </li>\n<li>Terway 10.16.0.0&#x2F;8VPC-vswitch + Pod192.168.0.0&#x2F;24Service </li>\n</ul>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"**\"></a>**</h4><ul>\n<li><p> 192.168.0.0&#x2F;1610.0.0.0&#x2F;0172.16.0.0&#x2F;12 VPC </p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n</li>\n<li><p></p>\n</li>\n<li><p>Terway </p>\n<ul>\n<li><p></p>\n<img data-src=\"/posts/64a8/vpc2.png\" class>\n</li>\n<li><p></p>\n</li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/64a8/vpc3.png\" class>\n\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"11\"><a href=\"#11\" class=\"headerlink\" title=\"11\"></a>11</h4><img data-src=\"/posts/64a8/vpc4.png\" class>\n\n<ul>\n<li>VPC10.0.0.0&#x2F;8 VPC</li>\n<li>4 <ul>\n<li>test-swc-10_200_0_0_20   1</li>\n<li>test-swc-10_200_16_0_20  2</li>\n<li>test-swc-10_200_64_0_19  1</li>\n<li>test-swc-10_200_96_0_19  2</li>\n</ul>\n</li>\n<li>CIDR<ul>\n<li>Node CIDR<ul>\n<li>10.200.0.0&#x2F;20</li>\n<li>10.200.16.0&#x2F;20</li>\n</ul>\n</li>\n<li>Pod CIDR<ul>\n<li>10.200.64.0&#x2F;19</li>\n<li>10.200.96.0&#x2F;19</li>\n</ul>\n</li>\n<li>Service CIDR<ul>\n<li>172.31.0.0&#x2F;16<blockquote>\n<p></p>\n<ul>\n<li>Node Pod Node Pod </li>\n<li>Service VPC  VPC Kubernetes </li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><ul>\n<li><p><a href=\"https://help.aliyun.com/document_detail/189596.html\"></a></p>\n</li>\n<li><p>VPN</p>\n<ul>\n<li><a href=\"https://cloud.tencent.com/developer/article/1824924\">IPSec VPN </a></li>\n<li><a href=\"https://help.aliyun.com/document_detail/65072.html\">Alicloud</a></li>\n</ul>\n</li>\n<li><p><a href=\"https://www.bejson.com/convert/subnetmask/\"></a></p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p><img data-src=\"https://intranetproxy.alipay.com/skylark/lark/0/2022/png/21956377/1646207048171-c0f5a83d-b982-4e85-ab78-f724882be069.png#clientId=ufadced67-c1c1-4&from=ui&id=u1dc1cab7&margin=%5Bobject%20Object%5D&name=%E6%80%BB%E4%BD%93%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84.png&originHeight=1993&originWidth=4131&originalType=binary&ratio=1&size=515776&status=done&style=none&taskId=uffed0b55-26c9-4f1d-b577-67c4f6f81ec\" alt=\".png\"></p>"},{"title":"Hello World","abbrlink":"3eeb","date":"2022-02-27T15:30:35.000Z","_content":"## Hello World!\n\n### For test.\n\n```\n# /bin/bash\necho test\n```\n\nTo Google [](https://www.google.com)\n","source":"_posts/First-Article.md","raw":"---\ntitle: Hello World\nabbrlink: 3eeb\ndate: 2022-02-27 23:30:35\ntags:\n---\n## Hello World!\n\n### For test.\n\n```\n# /bin/bash\necho test\n```\n\nTo Google [](https://www.google.com)\n","slug":"First-Article","published":1,"updated":"2024-01-21T15:28:43.148Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zj0009s0njb24s1qg6","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h2 id=\"Hello-World\"><a href=\"#Hello-World\" class=\"headerlink\" title=\"Hello World!\"></a>Hello World!</h2><h3 id=\"For-test\"><a href=\"#For-test\" class=\"headerlink\" title=\"For test.\"></a>For test.</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># /bin/bash</span><br><span class=\"line\">echo test</span><br></pre></td></tr></table></figure>\n\n<p>To Google <a href=\"https://www.google.com/\"></a></p>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":49,"excerpt":"","more":"<h2 id=\"Hello-World\"><a href=\"#Hello-World\" class=\"headerlink\" title=\"Hello World!\"></a>Hello World!</h2><h3 id=\"For-test\"><a href=\"#For-test\" class=\"headerlink\" title=\"For test.\"></a>For test.</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># /bin/bash</span><br><span class=\"line\">echo test</span><br></pre></td></tr></table></figure>\n\n<p>To Google <a href=\"https://www.google.com/\"></a></p>\n"},{"title":"Docker","abbrlink":"c018","date":"2024-01-21T14:49:15.000Z","_content":"### Docker Engine\n#### Install\n```shell\n# install docker engine\nhttps://docs.docker.com/engine/install/debian/\n\n```\n\n#### Storage\n##### Overview\n```shell\n# show docker volume info\ndocker volume ls\nDRIVER    VOLUME NAME\nlocal     jenkins_home\nlocal     yakir-test\n\n\n# how to use\n# default volume, directory = /var/lib/docker/volumes/\n-v yakir-test:/container-app/my-app\n--volume yakir-test:/container-app/my-app\n--mount\n# bind mounts\n-v /local_path/app.conf:/container-app/app.conf\n--volume /local_path/app.conf:/container-app/app.conf\n--mount\n# memory volume\n--tmpfs\n\n```\n<!--more-->\n##### Volumes\n```shell\n# create volume\ndocker volume create yakir-test\n\n\n# start container with volume\ndocker run -d --name test \\\n### \n# option1\n-v yakir-test:/app \\\n--volume yakir-test:/app \\\n# anonymous mode\n--volume /app\n# option2\n--mount source=yakir-test,target=/app \\\n# readonly mode\n--mount source=yakir-test,destination=/usr/share/nginx/html,readonly \\\n--mount 'type=volume,source=nfsvolume,target=/app,volume-driver=local,volume-opt=type=nfs,volume-opt=device=:/var/docker-nfs,volume-opt=o=addr=10.0.0.10' \\\n###\nnginx:latest\n\n\n# use a volume with docker-ompose\nservices:\n  frontend:\n    image: node:lts\n    volumes:\n      - yakir-test:/home/node/app\nvolumes:\n  yakir-test:\n     # external: true\n\n\n# show and remove volume\ndocker inspect volume yakir-test\ndocker stop test\ndocker volume rm yakir-test\n\n```\n\n##### Bind mounts\n```shell\n# start container with bind mounts\ndocker run -d --name test \\\n###\n# option1\n-v /opt/app.conf:/app/app.conf \\\n# option2\n--mount type=bind,source=\"$(pwd)\"/target,target=/app/ \\\n--mount type=bind,source=\"$(pwd)\"/target,target=/app/,readonly \\\n# bind propagation\n--mount type=bind,source=\"$(pwd)\"/target,target=/app2,readonly,bind-propagation=rslave \\\n###\nnginx:latest\n\n\n# use bind mounts with docker-compose\nservices:\n  frontend:\n    image: node:lts\n    volumes:\n      - type: bind\n        source: ./static\n        target: /opt/app/static\nvolumes:\n  myapp:\n\n\n# show and remove container\ndocker inspect test --format '{{ json .Mounts }}'\ndocker stop test\ndocker rm test\n\n```\n\n##### tmpfs mounts\n```shell\n# start container with tmpfs\ndocker run -it --name tmptest \\\n###\n# option1\n--tmpfs /app\n# option2\n--mount type=tmpfs,target=/app \\\n# specify tmpfs options\n--mount type=tmpfs,destination=/app,tmpfs-mode=1770,tmpfs-size=104857600 \\\n###\nnginx:latest\n\n\n# show and remove container\ndocker inspect tmptest --format '{{ json .Mounts }}'\ndocker stop tmptest\ndocker rm tmptest\n\n```\n\n##### Storage drivers\n###### Btrfs\n```shell\n# stop docker\nsystemctl stop docker.service\n\n# backup and empty contents\ncp -au /var/lib/docker/ /var/lib/docker.bk\nrm -rf /var/lib/docker/*\n\n# format block device as a btrfs filesystem\nmkfs.btrfs -f /dev/xvdf\n\n# mount the btrfs filesystem on /var/lib/docker mount point\nmount -t btrfs /dev/xvdf /var/lib/docker\ncp -au /var/lib/docker.bk/* /var/lib/docker/\n\n# configure Docker to use the btrfs storage driver\nvim /etc/docker/daemon.json\n{\n  \"storage-driver\": \"btrfs\"\n}\nsystemctl start docker.service\n\n# verify\ndocker info --format '{{ json .Driver }}'\n\"btrfs\"\n```\n\n###### OverlayFS\n```shell\n# stop docker\nsystemctl stop docker.service\n\n# backup and empty contents\ncp -au /var/lib/docker/ /var/lib/docker.bk\nrm -rf /var/lib/docker/*\n\n# options: separate backing filesystem, mount into /var/lib/docker and make sure to add mount to /etc/fstab to make it.  \n\n# configure Docker to use the btrfs storage driver\nvim /etc/docker/daemon.json\n{\n  \"storage-driver\": \"overlay2\"\n}\nsystemctl start docker.service\n\n# verify\ndocker info --format '{{ json .Driver }}'    \n\"overlay2\"\nmount |grep overlay |grep docker\n```\n\n###### ZFS\n```shell\n# stop docker\nsystemctl stop docker.service\n\n# backup and empty contents\ncp -auR /var/lib/docker/ /var/lib/docker.bk\nrm -rf /var/lib/docker/*\n\n# create a new zpool on block device and mount into /var/lib/docker\nzpool create -f zpool-docker -m /var/lib/docker /dev/xvdf\n# add zpoll\nzpool add zpool-docker /dev/xvdh\n# verify zpool\nzfs list\nNAME           USED  AVAIL  REFER  MOUNTPOINT\nzpool-docker    55K  96.4G    19K  /var/lib/docker\n\n# configure Docker to use the btrfs storage driver\nvim /etc/docker/daemon.json\n{\n  \"storage-driver\": \"zfs\"\n}\nsystemctl start docker.service\n\n# verify\ndocker info --format '{{ json .Driver }}'    \n\"zfs\"\n```\n\n###### containerd snapshotters\n```shell\n# configure Docker to use the btrfs storage driver\nvim /etc/docker/daemon.json\n{\n  \"features\": {\n    \"containerd-snapshotter\": true\n  }\n}\nsystemctl restart docker.service\n\n# verify\ndocker info -f '{{ .DriverStatus }}'\n[[driver-type io.containerd.snapshotter.v1]]\n\n```\n\n#### Networking\n##### Overview\n\n```shell\n# show docker network info\ndocker network ls\nNETWORK ID     NAME      DRIVER    SCOPE\nb2adc1fcf214   bridge    bridge    local\n2ed9fbc8db3e   host      host      local\nf1b2d749ed2c   none      null      local\n\n# how to use\n# bridge\n--net bridge\n# host\n--net host\n# none\n--net none\n# container\n--net container:container_name|container_id\n\n```\n\n##### Networking drivers\n###### Bridge\n```shell\n# bridge\n IP  docker0 \n\n# 1. container namespace\nxxx\n\n# 2.daemon  veth pair veth pair \n#  docker0  vethxxx\n# \nbrctl show\nbridge name     bridge id               STP enabled     interfaces\ndocker0         8000.0242db01d347       no              vethccab668\n#  vethxxx \nip addr |grep vethccab668\n#  container  namespace  eth0 \ndocker run --rm -dit busybox sh ip addr\n\n# 3.daemon  docker0  IP  docker0  IP \ndocker inspect test |grep Gateway\n            \"Gateway\": \"172.17.0.1\",\n\n```\n\n###### Overlay\n```shell\n#  docker  docker swarm \n```\n\n###### Host\n```shell\n# host\n IP \n\n# test\ndocker run --rm -dit --net host busybox ip addr\n```\n\n###### IPvlan\n```shell\n# ipvlan\nipvlan_mode: l2, l3(default), l3s\nipvlan_flag: bridge(default), private, vepa\nparent: eth0\n\n# l2 mode: \ndocker network create -d ipvlan \\\n     --subnet=192.168.1.0/24 \\\n     --gateway=192.168.1.1 \\\n     -o ipvlan_mode=l2 \\\n     -o parent=eth0 test_l2_net\n# test\ndocker run --net=test_l2_net --name=ipv1 -dit alpine /bin/sh\ndocker run --net=test_l2_net --name=ipv2 -it --rm alpine /bin/sh\nping -c 4 ipv1\n\n# l3 mode\ndocker network create -d ipvlan \\\n     --subnet=192.168.1.0/24 \\\n     --subnet=10.10.1.0/24 \\\n     -o ipvlan_mode=l3 test_l3_net\n# test\ndocker run --net=test_l3_net --ip=192.168.1.10 -dit busybox /bin/sh\ndocker run --net=test_l3_net --ip=10.10.1.10 -dit busybox /bin/sh\n\ndocker run --net=test_l3_net --ip=192.168.1.9 -it --rm busybox ping -c 2 10.10.1.10\ndocker run --net=test_l3_net --ip=10.10.1.9 -it --rm busybox ping -c 2 192.168.1.10\n\n```\n\n###### Macvlan\n```shell\n# macvlan\n\n# bridge mode\ndocker network create -d macvlan \\\n  --subnet=172.16.86.0/24 \\\n  --gateway=172.16.86.1 \\\n  -o parent=eth0 pub_net\n\n\n# 802.1Q trunk bridge mode\ndocker network create -d macvlan \\\n    --subnet=192.168.50.0/24 \\\n    --gateway=192.168.50.1 \\\n    -o parent=eth0.50 macvlan50\n\ndocker network create -d macvlan \\\n    --subnet=192.168.60.0/24 \\\n    --gateway=192.168.60.1 \\\n    -o parent=eth0.60 macvlan60\n\n# https://zhuanlan.zhihu.com/p/616504632\n```\n\n###### None\n```shell\n# none\n veth pair \n\n# verify\ndocker run --rm -dit --net none busybox ip addr\n```\n\n###### Container\n```shell\n# container\n IP\n\n# verify\ndocker run -dit --name test --rm busybox sh\ndocker run -it --name c1 --net container:test --rm busybox ip addr\ndocker run -it --name c2 --net container:test --rm busybox ip addr\n```\n\n###### \n```shell\n# user-defined \n docker0  container name host  daemon  DNS server --name  container name \n\n# \ndocker network create yakir-test\n# \nip addr\n    inet 172.19.0.1/16 brd 172.19.255.255 scope global br-8cb8260a95cf\nbrctl show\nbr-8cb8260a95cf         8000.024272aa9d38       no              veth556b81b\n# verify\ndocker run -dit --name test1 --net yakir-test --rm busybox sh\ndocker run -it --name test2 --net yakir-test --rm busybox ping -c 4 test1\n\n# \ndocker run -dit --name test3 --net yakir-test --rm busybox sh\ndocker network connect yakir-test test3 \ndocker exec -it test3 ip addr\n531: eth0@if532: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue \n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n533: eth1@if534: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue \n    link/ether 02:42:ac:13:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.19.0.2/16 brd 172.19.255.255 scope global eth1\n       valid_lft forever preferred_lft forever\n\n```\n\n##### Daemon\n```shell\n# configuration file\n/etc/docker/daemon.json\n~/.config/docker/daemon.json\n# configuration using flags\ndockerd --debug \\\n  --tls=true \\\n  --tlscert=/var/docker/server.pem \\\n  --tlskey=/var/docker/serverkey.pem \\\n  --host tcp://192.168.10.1:2376\n\n\n# default data directory\n/var/lib/docker\n\n\n# systemd\ncat /lib/systemd/system/docker.service\n\n\n```\n\n#### Docker Build && Compose\n##### Dockerfile\n```shell\n\n# \n1.  base \n2. \n3. \n4. \n5. \n6.  Dockerfile entrypoint / +\n7.  cache \n8.  git /\n9.  .dockerignore \n```\n\n##### docker-compose\n```shell\n\n```\n\n#### Command\n[[containerRuntime#docker & podman|Docker Command]]\n\n\n\n>Reference:\n>1. [Docker Official Documentation](https://docs.docker.com/)\n>2. [Docker network-drivers](https://docs.docker.com/network/drivers/)\n>3. [Dockerfile reference](https://docs.docker.com/engine/reference/builder/)\n","source":"_posts/docker.md","raw":"---\ntitle: Docker\ncategories:\n  - Container\ntags:\n  - Docker\nabbrlink: c018\ndate: 2024-01-21 22:49:15\n---\n### Docker Engine\n#### Install\n```shell\n# install docker engine\nhttps://docs.docker.com/engine/install/debian/\n\n```\n\n#### Storage\n##### Overview\n```shell\n# show docker volume info\ndocker volume ls\nDRIVER    VOLUME NAME\nlocal     jenkins_home\nlocal     yakir-test\n\n\n# how to use\n# default volume, directory = /var/lib/docker/volumes/\n-v yakir-test:/container-app/my-app\n--volume yakir-test:/container-app/my-app\n--mount\n# bind mounts\n-v /local_path/app.conf:/container-app/app.conf\n--volume /local_path/app.conf:/container-app/app.conf\n--mount\n# memory volume\n--tmpfs\n\n```\n<!--more-->\n##### Volumes\n```shell\n# create volume\ndocker volume create yakir-test\n\n\n# start container with volume\ndocker run -d --name test \\\n### \n# option1\n-v yakir-test:/app \\\n--volume yakir-test:/app \\\n# anonymous mode\n--volume /app\n# option2\n--mount source=yakir-test,target=/app \\\n# readonly mode\n--mount source=yakir-test,destination=/usr/share/nginx/html,readonly \\\n--mount 'type=volume,source=nfsvolume,target=/app,volume-driver=local,volume-opt=type=nfs,volume-opt=device=:/var/docker-nfs,volume-opt=o=addr=10.0.0.10' \\\n###\nnginx:latest\n\n\n# use a volume with docker-ompose\nservices:\n  frontend:\n    image: node:lts\n    volumes:\n      - yakir-test:/home/node/app\nvolumes:\n  yakir-test:\n     # external: true\n\n\n# show and remove volume\ndocker inspect volume yakir-test\ndocker stop test\ndocker volume rm yakir-test\n\n```\n\n##### Bind mounts\n```shell\n# start container with bind mounts\ndocker run -d --name test \\\n###\n# option1\n-v /opt/app.conf:/app/app.conf \\\n# option2\n--mount type=bind,source=\"$(pwd)\"/target,target=/app/ \\\n--mount type=bind,source=\"$(pwd)\"/target,target=/app/,readonly \\\n# bind propagation\n--mount type=bind,source=\"$(pwd)\"/target,target=/app2,readonly,bind-propagation=rslave \\\n###\nnginx:latest\n\n\n# use bind mounts with docker-compose\nservices:\n  frontend:\n    image: node:lts\n    volumes:\n      - type: bind\n        source: ./static\n        target: /opt/app/static\nvolumes:\n  myapp:\n\n\n# show and remove container\ndocker inspect test --format '{{ json .Mounts }}'\ndocker stop test\ndocker rm test\n\n```\n\n##### tmpfs mounts\n```shell\n# start container with tmpfs\ndocker run -it --name tmptest \\\n###\n# option1\n--tmpfs /app\n# option2\n--mount type=tmpfs,target=/app \\\n# specify tmpfs options\n--mount type=tmpfs,destination=/app,tmpfs-mode=1770,tmpfs-size=104857600 \\\n###\nnginx:latest\n\n\n# show and remove container\ndocker inspect tmptest --format '{{ json .Mounts }}'\ndocker stop tmptest\ndocker rm tmptest\n\n```\n\n##### Storage drivers\n###### Btrfs\n```shell\n# stop docker\nsystemctl stop docker.service\n\n# backup and empty contents\ncp -au /var/lib/docker/ /var/lib/docker.bk\nrm -rf /var/lib/docker/*\n\n# format block device as a btrfs filesystem\nmkfs.btrfs -f /dev/xvdf\n\n# mount the btrfs filesystem on /var/lib/docker mount point\nmount -t btrfs /dev/xvdf /var/lib/docker\ncp -au /var/lib/docker.bk/* /var/lib/docker/\n\n# configure Docker to use the btrfs storage driver\nvim /etc/docker/daemon.json\n{\n  \"storage-driver\": \"btrfs\"\n}\nsystemctl start docker.service\n\n# verify\ndocker info --format '{{ json .Driver }}'\n\"btrfs\"\n```\n\n###### OverlayFS\n```shell\n# stop docker\nsystemctl stop docker.service\n\n# backup and empty contents\ncp -au /var/lib/docker/ /var/lib/docker.bk\nrm -rf /var/lib/docker/*\n\n# options: separate backing filesystem, mount into /var/lib/docker and make sure to add mount to /etc/fstab to make it.  \n\n# configure Docker to use the btrfs storage driver\nvim /etc/docker/daemon.json\n{\n  \"storage-driver\": \"overlay2\"\n}\nsystemctl start docker.service\n\n# verify\ndocker info --format '{{ json .Driver }}'    \n\"overlay2\"\nmount |grep overlay |grep docker\n```\n\n###### ZFS\n```shell\n# stop docker\nsystemctl stop docker.service\n\n# backup and empty contents\ncp -auR /var/lib/docker/ /var/lib/docker.bk\nrm -rf /var/lib/docker/*\n\n# create a new zpool on block device and mount into /var/lib/docker\nzpool create -f zpool-docker -m /var/lib/docker /dev/xvdf\n# add zpoll\nzpool add zpool-docker /dev/xvdh\n# verify zpool\nzfs list\nNAME           USED  AVAIL  REFER  MOUNTPOINT\nzpool-docker    55K  96.4G    19K  /var/lib/docker\n\n# configure Docker to use the btrfs storage driver\nvim /etc/docker/daemon.json\n{\n  \"storage-driver\": \"zfs\"\n}\nsystemctl start docker.service\n\n# verify\ndocker info --format '{{ json .Driver }}'    \n\"zfs\"\n```\n\n###### containerd snapshotters\n```shell\n# configure Docker to use the btrfs storage driver\nvim /etc/docker/daemon.json\n{\n  \"features\": {\n    \"containerd-snapshotter\": true\n  }\n}\nsystemctl restart docker.service\n\n# verify\ndocker info -f '{{ .DriverStatus }}'\n[[driver-type io.containerd.snapshotter.v1]]\n\n```\n\n#### Networking\n##### Overview\n\n```shell\n# show docker network info\ndocker network ls\nNETWORK ID     NAME      DRIVER    SCOPE\nb2adc1fcf214   bridge    bridge    local\n2ed9fbc8db3e   host      host      local\nf1b2d749ed2c   none      null      local\n\n# how to use\n# bridge\n--net bridge\n# host\n--net host\n# none\n--net none\n# container\n--net container:container_name|container_id\n\n```\n\n##### Networking drivers\n###### Bridge\n```shell\n# bridge\n IP  docker0 \n\n# 1. container namespace\nxxx\n\n# 2.daemon  veth pair veth pair \n#  docker0  vethxxx\n# \nbrctl show\nbridge name     bridge id               STP enabled     interfaces\ndocker0         8000.0242db01d347       no              vethccab668\n#  vethxxx \nip addr |grep vethccab668\n#  container  namespace  eth0 \ndocker run --rm -dit busybox sh ip addr\n\n# 3.daemon  docker0  IP  docker0  IP \ndocker inspect test |grep Gateway\n            \"Gateway\": \"172.17.0.1\",\n\n```\n\n###### Overlay\n```shell\n#  docker  docker swarm \n```\n\n###### Host\n```shell\n# host\n IP \n\n# test\ndocker run --rm -dit --net host busybox ip addr\n```\n\n###### IPvlan\n```shell\n# ipvlan\nipvlan_mode: l2, l3(default), l3s\nipvlan_flag: bridge(default), private, vepa\nparent: eth0\n\n# l2 mode: \ndocker network create -d ipvlan \\\n     --subnet=192.168.1.0/24 \\\n     --gateway=192.168.1.1 \\\n     -o ipvlan_mode=l2 \\\n     -o parent=eth0 test_l2_net\n# test\ndocker run --net=test_l2_net --name=ipv1 -dit alpine /bin/sh\ndocker run --net=test_l2_net --name=ipv2 -it --rm alpine /bin/sh\nping -c 4 ipv1\n\n# l3 mode\ndocker network create -d ipvlan \\\n     --subnet=192.168.1.0/24 \\\n     --subnet=10.10.1.0/24 \\\n     -o ipvlan_mode=l3 test_l3_net\n# test\ndocker run --net=test_l3_net --ip=192.168.1.10 -dit busybox /bin/sh\ndocker run --net=test_l3_net --ip=10.10.1.10 -dit busybox /bin/sh\n\ndocker run --net=test_l3_net --ip=192.168.1.9 -it --rm busybox ping -c 2 10.10.1.10\ndocker run --net=test_l3_net --ip=10.10.1.9 -it --rm busybox ping -c 2 192.168.1.10\n\n```\n\n###### Macvlan\n```shell\n# macvlan\n\n# bridge mode\ndocker network create -d macvlan \\\n  --subnet=172.16.86.0/24 \\\n  --gateway=172.16.86.1 \\\n  -o parent=eth0 pub_net\n\n\n# 802.1Q trunk bridge mode\ndocker network create -d macvlan \\\n    --subnet=192.168.50.0/24 \\\n    --gateway=192.168.50.1 \\\n    -o parent=eth0.50 macvlan50\n\ndocker network create -d macvlan \\\n    --subnet=192.168.60.0/24 \\\n    --gateway=192.168.60.1 \\\n    -o parent=eth0.60 macvlan60\n\n# https://zhuanlan.zhihu.com/p/616504632\n```\n\n###### None\n```shell\n# none\n veth pair \n\n# verify\ndocker run --rm -dit --net none busybox ip addr\n```\n\n###### Container\n```shell\n# container\n IP\n\n# verify\ndocker run -dit --name test --rm busybox sh\ndocker run -it --name c1 --net container:test --rm busybox ip addr\ndocker run -it --name c2 --net container:test --rm busybox ip addr\n```\n\n###### \n```shell\n# user-defined \n docker0  container name host  daemon  DNS server --name  container name \n\n# \ndocker network create yakir-test\n# \nip addr\n    inet 172.19.0.1/16 brd 172.19.255.255 scope global br-8cb8260a95cf\nbrctl show\nbr-8cb8260a95cf         8000.024272aa9d38       no              veth556b81b\n# verify\ndocker run -dit --name test1 --net yakir-test --rm busybox sh\ndocker run -it --name test2 --net yakir-test --rm busybox ping -c 4 test1\n\n# \ndocker run -dit --name test3 --net yakir-test --rm busybox sh\ndocker network connect yakir-test test3 \ndocker exec -it test3 ip addr\n531: eth0@if532: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue \n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n533: eth1@if534: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue \n    link/ether 02:42:ac:13:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.19.0.2/16 brd 172.19.255.255 scope global eth1\n       valid_lft forever preferred_lft forever\n\n```\n\n##### Daemon\n```shell\n# configuration file\n/etc/docker/daemon.json\n~/.config/docker/daemon.json\n# configuration using flags\ndockerd --debug \\\n  --tls=true \\\n  --tlscert=/var/docker/server.pem \\\n  --tlskey=/var/docker/serverkey.pem \\\n  --host tcp://192.168.10.1:2376\n\n\n# default data directory\n/var/lib/docker\n\n\n# systemd\ncat /lib/systemd/system/docker.service\n\n\n```\n\n#### Docker Build && Compose\n##### Dockerfile\n```shell\n\n# \n1.  base \n2. \n3. \n4. \n5. \n6.  Dockerfile entrypoint / +\n7.  cache \n8.  git /\n9.  .dockerignore \n```\n\n##### docker-compose\n```shell\n\n```\n\n#### Command\n[[containerRuntime#docker & podman|Docker Command]]\n\n\n\n>Reference:\n>1. [Docker Official Documentation](https://docs.docker.com/)\n>2. [Docker network-drivers](https://docs.docker.com/network/drivers/)\n>3. [Dockerfile reference](https://docs.docker.com/engine/reference/builder/)\n","slug":"docker","published":1,"updated":"2024-01-21T15:33:40.702Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zk000bs0nj1p9k5py2","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"Docker-Engine\"><a href=\"#Docker-Engine\" class=\"headerlink\" title=\"Docker Engine\"></a>Docker Engine</h3><h4 id=\"Install\"><a href=\"#Install\" class=\"headerlink\" title=\"Install\"></a>Install</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">install docker engine</span></span><br><span class=\"line\">https://docs.docker.com/engine/install/debian/</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Storage\"><a href=\"#Storage\" class=\"headerlink\" title=\"Storage\"></a>Storage</h4><h5 id=\"Overview\"><a href=\"#Overview\" class=\"headerlink\" title=\"Overview\"></a>Overview</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">show docker volume info</span></span><br><span class=\"line\">docker volume ls</span><br><span class=\"line\">DRIVER    VOLUME NAME</span><br><span class=\"line\">local     jenkins_home</span><br><span class=\"line\">local     yakir-test</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">how to use</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">default volume, directory = /var/lib/docker/volumes/</span></span><br><span class=\"line\">-v yakir-test:/container-app/my-app</span><br><span class=\"line\">--volume yakir-test:/container-app/my-app</span><br><span class=\"line\">--mount</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">bind</span> mounts</span></span><br><span class=\"line\">-v /local_path/app.conf:/container-app/app.conf</span><br><span class=\"line\">--volume /local_path/app.conf:/container-app/app.conf</span><br><span class=\"line\">--mount</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">memory volume</span></span><br><span class=\"line\">--tmpfs</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<span id=\"more\"></span>\n<h5 id=\"Volumes\"><a href=\"#Volumes\" class=\"headerlink\" title=\"Volumes\"></a>Volumes</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">create volume</span></span><br><span class=\"line\">docker volume create yakir-test</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">start container with volume</span></span><br><span class=\"line\">docker run -d --name test \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span> </span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option1</span></span><br><span class=\"line\">-v yakir-test:/app \\</span><br><span class=\"line\">--volume yakir-test:/app \\</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">anonymous mode</span></span><br><span class=\"line\">--volume /app</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option2</span></span><br><span class=\"line\">--mount source=yakir-test,target=/app \\</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">readonly</span> mode</span></span><br><span class=\"line\">--mount source=yakir-test,destination=/usr/share/nginx/html,readonly \\</span><br><span class=\"line\">--mount &#x27;type=volume,source=nfsvolume,target=/app,volume-driver=local,volume-opt=type=nfs,volume-opt=device=:/var/docker-nfs,volume-opt=o=addr=10.0.0.10&#x27; \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span></span><br><span class=\"line\">nginx:latest</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">use a volume with docker-ompose</span></span><br><span class=\"line\">services:</span><br><span class=\"line\">  frontend:</span><br><span class=\"line\">    image: node:lts</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - yakir-test:/home/node/app</span><br><span class=\"line\">volumes:</span><br><span class=\"line\">  yakir-test:</span><br><span class=\"line\">     # external: true</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">show and remove volume</span></span><br><span class=\"line\">docker inspect volume yakir-test</span><br><span class=\"line\">docker stop test</span><br><span class=\"line\">docker volume rm yakir-test</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Bind-mounts\"><a href=\"#Bind-mounts\" class=\"headerlink\" title=\"Bind mounts\"></a>Bind mounts</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">start container with <span class=\"built_in\">bind</span> mounts</span></span><br><span class=\"line\">docker run -d --name test \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option1</span></span><br><span class=\"line\">-v /opt/app.conf:/app/app.conf \\</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option2</span></span><br><span class=\"line\">--mount type=bind,source=&quot;$(pwd)&quot;/target,target=/app/ \\</span><br><span class=\"line\">--mount type=bind,source=&quot;$(pwd)&quot;/target,target=/app/,readonly \\</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">bind</span> propagation</span></span><br><span class=\"line\">--mount type=bind,source=&quot;$(pwd)&quot;/target,target=/app2,readonly,bind-propagation=rslave \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span></span><br><span class=\"line\">nginx:latest</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">use <span class=\"built_in\">bind</span> mounts with docker-compose</span></span><br><span class=\"line\">services:</span><br><span class=\"line\">  frontend:</span><br><span class=\"line\">    image: node:lts</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - type: bind</span><br><span class=\"line\">        source: ./static</span><br><span class=\"line\">        target: /opt/app/static</span><br><span class=\"line\">volumes:</span><br><span class=\"line\">  myapp:</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">show and remove container</span></span><br><span class=\"line\">docker inspect test --format &#x27;&#123;&#123; json .Mounts &#125;&#125;&#x27;</span><br><span class=\"line\">docker stop test</span><br><span class=\"line\">docker rm test</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"tmpfs-mounts\"><a href=\"#tmpfs-mounts\" class=\"headerlink\" title=\"tmpfs mounts\"></a>tmpfs mounts</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">start container with tmpfs</span></span><br><span class=\"line\">docker run -it --name tmptest \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option1</span></span><br><span class=\"line\">--tmpfs /app</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option2</span></span><br><span class=\"line\">--mount type=tmpfs,target=/app \\</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">specify tmpfs options</span></span><br><span class=\"line\">--mount type=tmpfs,destination=/app,tmpfs-mode=1770,tmpfs-size=104857600 \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span></span><br><span class=\"line\">nginx:latest</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">show and remove container</span></span><br><span class=\"line\">docker inspect tmptest --format &#x27;&#123;&#123; json .Mounts &#125;&#125;&#x27;</span><br><span class=\"line\">docker stop tmptest</span><br><span class=\"line\">docker rm tmptest</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Storage-drivers\"><a href=\"#Storage-drivers\" class=\"headerlink\" title=\"Storage drivers\"></a>Storage drivers</h5><h6 id=\"Btrfs\"><a href=\"#Btrfs\" class=\"headerlink\" title=\"Btrfs\"></a>Btrfs</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">stop docker</span></span><br><span class=\"line\">systemctl stop docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">backup and empty contents</span></span><br><span class=\"line\">cp -au /var/lib/docker/ /var/lib/docker.bk</span><br><span class=\"line\">rm -rf /var/lib/docker/*</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">format block device as a btrfs filesystem</span></span><br><span class=\"line\">mkfs.btrfs -f /dev/xvdf</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">mount the btrfs filesystem on /var/lib/docker mount point</span></span><br><span class=\"line\">mount -t btrfs /dev/xvdf /var/lib/docker</span><br><span class=\"line\">cp -au /var/lib/docker.bk/* /var/lib/docker/</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configure Docker to use the btrfs storage driver</span></span><br><span class=\"line\">vim /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;storage-driver&quot;: &quot;btrfs&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">systemctl start docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker info --format &#x27;&#123;&#123; json .Driver &#125;&#125;&#x27;</span><br><span class=\"line\">&quot;btrfs&quot;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"OverlayFS\"><a href=\"#OverlayFS\" class=\"headerlink\" title=\"OverlayFS\"></a>OverlayFS</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">stop docker</span></span><br><span class=\"line\">systemctl stop docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">backup and empty contents</span></span><br><span class=\"line\">cp -au /var/lib/docker/ /var/lib/docker.bk</span><br><span class=\"line\">rm -rf /var/lib/docker/*</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">options: separate backing filesystem, mount into /var/lib/docker and make sure to add mount to /etc/fstab to make it.</span>  </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configure Docker to use the btrfs storage driver</span></span><br><span class=\"line\">vim /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">systemctl start docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker info --format &#x27;&#123;&#123; json .Driver &#125;&#125;&#x27;    </span><br><span class=\"line\">&quot;overlay2&quot;</span><br><span class=\"line\">mount |grep overlay |grep docker</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"ZFS\"><a href=\"#ZFS\" class=\"headerlink\" title=\"ZFS\"></a>ZFS</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">stop docker</span></span><br><span class=\"line\">systemctl stop docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">backup and empty contents</span></span><br><span class=\"line\">cp -auR /var/lib/docker/ /var/lib/docker.bk</span><br><span class=\"line\">rm -rf /var/lib/docker/*</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">create a new zpool on block device and mount into /var/lib/docker</span></span><br><span class=\"line\">zpool create -f zpool-docker -m /var/lib/docker /dev/xvdf</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">add zpoll</span></span><br><span class=\"line\">zpool add zpool-docker /dev/xvdh</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify zpool</span></span><br><span class=\"line\">zfs list</span><br><span class=\"line\">NAME           USED  AVAIL  REFER  MOUNTPOINT</span><br><span class=\"line\">zpool-docker    55K  96.4G    19K  /var/lib/docker</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configure Docker to use the btrfs storage driver</span></span><br><span class=\"line\">vim /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;storage-driver&quot;: &quot;zfs&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">systemctl start docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker info --format &#x27;&#123;&#123; json .Driver &#125;&#125;&#x27;    </span><br><span class=\"line\">&quot;zfs&quot;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"containerd-snapshotters\"><a href=\"#containerd-snapshotters\" class=\"headerlink\" title=\"containerd snapshotters\"></a>containerd snapshotters</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configure Docker to use the btrfs storage driver</span></span><br><span class=\"line\">vim /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;features&quot;: &#123;</span><br><span class=\"line\">    &quot;containerd-snapshotter&quot;: true</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">systemctl restart docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker info -f &#x27;&#123;&#123; .DriverStatus &#125;&#125;&#x27;</span><br><span class=\"line\">[[driver-type io.containerd.snapshotter.v1]]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Networking\"><a href=\"#Networking\" class=\"headerlink\" title=\"Networking\"></a>Networking</h4><h5 id=\"Overview-1\"><a href=\"#Overview-1\" class=\"headerlink\" title=\"Overview\"></a>Overview</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">show docker network info</span></span><br><span class=\"line\">docker network ls</span><br><span class=\"line\">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class=\"line\">b2adc1fcf214   bridge    bridge    local</span><br><span class=\"line\">2ed9fbc8db3e   host      host      local</span><br><span class=\"line\">f1b2d749ed2c   none      null      local</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">how to use</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge</span></span><br><span class=\"line\">--net bridge</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">host</span></span><br><span class=\"line\">--net host</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">none</span></span><br><span class=\"line\">--net none</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">container</span></span><br><span class=\"line\">--net container:container_name|container_id</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Networking-drivers\"><a href=\"#Networking-drivers\" class=\"headerlink\" title=\"Networking drivers\"></a>Networking drivers</h5><h6 id=\"Bridge\"><a href=\"#Bridge\" class=\"headerlink\" title=\"Bridge\"></a>Bridge</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge</span></span><br><span class=\"line\"> IP  docker0 </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1. container namespace</span></span><br><span class=\"line\">xxx</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2.daemon  veth pair veth pair </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> docker0  vethxxx</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">brctl show</span><br><span class=\"line\">bridge name     bridge id               STP enabled     interfaces</span><br><span class=\"line\">docker0         8000.0242db01d347       no              vethccab668</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> vethxxx </span></span><br><span class=\"line\">ip addr |grep vethccab668</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> container  namespace  eth0 </span></span><br><span class=\"line\">docker run --rm -dit busybox sh ip addr</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3.daemon  docker0  IP  docker0  IP </span></span><br><span class=\"line\">docker inspect test |grep Gateway</span><br><span class=\"line\">            &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Overlay\"><a href=\"#Overlay\" class=\"headerlink\" title=\"Overlay\"></a>Overlay</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> docker  docker swarm </span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Host\"><a href=\"#Host\" class=\"headerlink\" title=\"Host\"></a>Host</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">host</span></span><br><span class=\"line\"> IP </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">test</span></span></span><br><span class=\"line\">docker run --rm -dit --net host busybox ip addr</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"IPvlan\"><a href=\"#IPvlan\" class=\"headerlink\" title=\"IPvlan\"></a>IPvlan</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ipvlan</span></span><br><span class=\"line\">ipvlan_mode: l2, l3(default), l3s</span><br><span class=\"line\">ipvlan_flag: bridge(default), private, vepa</span><br><span class=\"line\">parent: eth0</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">l2 mode: </span></span><br><span class=\"line\">docker network create -d ipvlan \\</span><br><span class=\"line\">     --subnet=192.168.1.0/24 \\</span><br><span class=\"line\">     --gateway=192.168.1.1 \\</span><br><span class=\"line\">     -o ipvlan_mode=l2 \\</span><br><span class=\"line\">     -o parent=eth0 test_l2_net</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">test</span></span></span><br><span class=\"line\">docker run --net=test_l2_net --name=ipv1 -dit alpine /bin/sh</span><br><span class=\"line\">docker run --net=test_l2_net --name=ipv2 -it --rm alpine /bin/sh</span><br><span class=\"line\">ping -c 4 ipv1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">l3 mode</span></span><br><span class=\"line\">docker network create -d ipvlan \\</span><br><span class=\"line\">     --subnet=192.168.1.0/24 \\</span><br><span class=\"line\">     --subnet=10.10.1.0/24 \\</span><br><span class=\"line\">     -o ipvlan_mode=l3 test_l3_net</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">test</span></span></span><br><span class=\"line\">docker run --net=test_l3_net --ip=192.168.1.10 -dit busybox /bin/sh</span><br><span class=\"line\">docker run --net=test_l3_net --ip=10.10.1.10 -dit busybox /bin/sh</span><br><span class=\"line\"></span><br><span class=\"line\">docker run --net=test_l3_net --ip=192.168.1.9 -it --rm busybox ping -c 2 10.10.1.10</span><br><span class=\"line\">docker run --net=test_l3_net --ip=10.10.1.9 -it --rm busybox ping -c 2 192.168.1.10</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Macvlan\"><a href=\"#Macvlan\" class=\"headerlink\" title=\"Macvlan\"></a>Macvlan</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">macvlan</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge mode</span></span><br><span class=\"line\">docker network create -d macvlan \\</span><br><span class=\"line\">  --subnet=172.16.86.0/24 \\</span><br><span class=\"line\">  --gateway=172.16.86.1 \\</span><br><span class=\"line\">  -o parent=eth0 pub_net</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">802.1Q trunk bridge mode</span></span><br><span class=\"line\">docker network create -d macvlan \\</span><br><span class=\"line\">    --subnet=192.168.50.0/24 \\</span><br><span class=\"line\">    --gateway=192.168.50.1 \\</span><br><span class=\"line\">    -o parent=eth0.50 macvlan50</span><br><span class=\"line\"></span><br><span class=\"line\">docker network create -d macvlan \\</span><br><span class=\"line\">    --subnet=192.168.60.0/24 \\</span><br><span class=\"line\">    --gateway=192.168.60.1 \\</span><br><span class=\"line\">    -o parent=eth0.60 macvlan60</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">https://zhuanlan.zhihu.com/p/616504632</span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"None\"><a href=\"#None\" class=\"headerlink\" title=\"None\"></a>None</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">none</span></span><br><span class=\"line\"> veth pair </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker run --rm -dit --net none busybox ip addr</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Container\"><a href=\"#Container\" class=\"headerlink\" title=\"Container\"></a>Container</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">container</span></span><br><span class=\"line\"> IP</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker run -dit --name test --rm busybox sh</span><br><span class=\"line\">docker run -it --name c1 --net container:test --rm busybox ip addr</span><br><span class=\"line\">docker run -it --name c2 --net container:test --rm busybox ip addr</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">user-defined</span> </span><br><span class=\"line\"> docker0  container name host  daemon  DNS server --name  container name </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker network create yakir-test</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">ip addr</span><br><span class=\"line\">    inet 172.19.0.1/16 brd 172.19.255.255 scope global br-8cb8260a95cf</span><br><span class=\"line\">brctl show</span><br><span class=\"line\">br-8cb8260a95cf         8000.024272aa9d38       no              veth556b81b</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker run -dit --name test1 --net yakir-test --rm busybox sh</span><br><span class=\"line\">docker run -it --name test2 --net yakir-test --rm busybox ping -c 4 test1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run -dit --name test3 --net yakir-test --rm busybox sh</span><br><span class=\"line\">docker network connect yakir-test test3 </span><br><span class=\"line\">docker exec -it test3 ip addr</span><br><span class=\"line\">531: eth0@if532: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class=\"line\">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">533: eth1@if534: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class=\"line\">    link/ether 02:42:ac:13:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.19.0.2/16 brd 172.19.255.255 scope global eth1</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Daemon\"><a href=\"#Daemon\" class=\"headerlink\" title=\"Daemon\"></a>Daemon</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configuration file</span></span><br><span class=\"line\">/etc/docker/daemon.json</span><br><span class=\"line\">~/.config/docker/daemon.json</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configuration using flags</span></span><br><span class=\"line\">dockerd --debug \\</span><br><span class=\"line\">  --tls=true \\</span><br><span class=\"line\">  --tlscert=/var/docker/server.pem \\</span><br><span class=\"line\">  --tlskey=/var/docker/serverkey.pem \\</span><br><span class=\"line\">  --host tcp://192.168.10.1:2376</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">default data directory</span></span><br><span class=\"line\">/var/lib/docker</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">systemd</span></span><br><span class=\"line\">cat /lib/systemd/system/docker.service</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Docker-Build-amp-amp-Compose\"><a href=\"#Docker-Build-amp-amp-Compose\" class=\"headerlink\" title=\"Docker Build &amp;&amp; Compose\"></a>Docker Build &amp;&amp; Compose</h4><h5 id=\"Dockerfile\"><a href=\"#Dockerfile\" class=\"headerlink\" title=\"Dockerfile\"></a>Dockerfile</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">1.  base </span><br><span class=\"line\">2. </span><br><span class=\"line\">3. </span><br><span class=\"line\">4. </span><br><span class=\"line\">5. </span><br><span class=\"line\">6.  Dockerfile entrypoint / +</span><br><span class=\"line\">7.  cache </span><br><span class=\"line\">8.  git /</span><br><span class=\"line\">9.  .dockerignore </span><br></pre></td></tr></table></figure>\n\n<h5 id=\"docker-compose\"><a href=\"#docker-compose\" class=\"headerlink\" title=\"docker-compose\"></a>docker-compose</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Command\"><a href=\"#Command\" class=\"headerlink\" title=\"Command\"></a>Command</h4><p>[[containerRuntime#docker &amp; podman|Docker Command]]</p>\n<blockquote>\n<p>Reference:</p>\n<ol>\n<li><a href=\"https://docs.docker.com/\">Docker Official Documentation</a></li>\n<li><a href=\"https://docs.docker.com/network/drivers/\">Docker network-drivers</a></li>\n<li><a href=\"https://docs.docker.com/engine/reference/builder/\">Dockerfile reference</a></li>\n</ol>\n</blockquote>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":8702,"excerpt":"<h3 id=\"Docker-Engine\"><a href=\"#Docker-Engine\" class=\"headerlink\" title=\"Docker Engine\"></a>Docker Engine</h3><h4 id=\"Install\"><a href=\"#Install\" class=\"headerlink\" title=\"Install\"></a>Install</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">install docker engine</span></span><br><span class=\"line\">https://docs.docker.com/engine/install/debian/</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Storage\"><a href=\"#Storage\" class=\"headerlink\" title=\"Storage\"></a>Storage</h4><h5 id=\"Overview\"><a href=\"#Overview\" class=\"headerlink\" title=\"Overview\"></a>Overview</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">show docker volume info</span></span><br><span class=\"line\">docker volume ls</span><br><span class=\"line\">DRIVER    VOLUME NAME</span><br><span class=\"line\">local     jenkins_home</span><br><span class=\"line\">local     yakir-test</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">how to use</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">default volume, directory = /var/lib/docker/volumes/</span></span><br><span class=\"line\">-v yakir-test:/container-app/my-app</span><br><span class=\"line\">--volume yakir-test:/container-app/my-app</span><br><span class=\"line\">--mount</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">bind</span> mounts</span></span><br><span class=\"line\">-v /local_path/app.conf:/container-app/app.conf</span><br><span class=\"line\">--volume /local_path/app.conf:/container-app/app.conf</span><br><span class=\"line\">--mount</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">memory volume</span></span><br><span class=\"line\">--tmpfs</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","more":"<h5 id=\"Volumes\"><a href=\"#Volumes\" class=\"headerlink\" title=\"Volumes\"></a>Volumes</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">create volume</span></span><br><span class=\"line\">docker volume create yakir-test</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">start container with volume</span></span><br><span class=\"line\">docker run -d --name test \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span> </span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option1</span></span><br><span class=\"line\">-v yakir-test:/app \\</span><br><span class=\"line\">--volume yakir-test:/app \\</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">anonymous mode</span></span><br><span class=\"line\">--volume /app</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option2</span></span><br><span class=\"line\">--mount source=yakir-test,target=/app \\</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">readonly</span> mode</span></span><br><span class=\"line\">--mount source=yakir-test,destination=/usr/share/nginx/html,readonly \\</span><br><span class=\"line\">--mount &#x27;type=volume,source=nfsvolume,target=/app,volume-driver=local,volume-opt=type=nfs,volume-opt=device=:/var/docker-nfs,volume-opt=o=addr=10.0.0.10&#x27; \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span></span><br><span class=\"line\">nginx:latest</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">use a volume with docker-ompose</span></span><br><span class=\"line\">services:</span><br><span class=\"line\">  frontend:</span><br><span class=\"line\">    image: node:lts</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - yakir-test:/home/node/app</span><br><span class=\"line\">volumes:</span><br><span class=\"line\">  yakir-test:</span><br><span class=\"line\">     # external: true</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">show and remove volume</span></span><br><span class=\"line\">docker inspect volume yakir-test</span><br><span class=\"line\">docker stop test</span><br><span class=\"line\">docker volume rm yakir-test</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Bind-mounts\"><a href=\"#Bind-mounts\" class=\"headerlink\" title=\"Bind mounts\"></a>Bind mounts</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">start container with <span class=\"built_in\">bind</span> mounts</span></span><br><span class=\"line\">docker run -d --name test \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option1</span></span><br><span class=\"line\">-v /opt/app.conf:/app/app.conf \\</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option2</span></span><br><span class=\"line\">--mount type=bind,source=&quot;$(pwd)&quot;/target,target=/app/ \\</span><br><span class=\"line\">--mount type=bind,source=&quot;$(pwd)&quot;/target,target=/app/,readonly \\</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">bind</span> propagation</span></span><br><span class=\"line\">--mount type=bind,source=&quot;$(pwd)&quot;/target,target=/app2,readonly,bind-propagation=rslave \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span></span><br><span class=\"line\">nginx:latest</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">use <span class=\"built_in\">bind</span> mounts with docker-compose</span></span><br><span class=\"line\">services:</span><br><span class=\"line\">  frontend:</span><br><span class=\"line\">    image: node:lts</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - type: bind</span><br><span class=\"line\">        source: ./static</span><br><span class=\"line\">        target: /opt/app/static</span><br><span class=\"line\">volumes:</span><br><span class=\"line\">  myapp:</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">show and remove container</span></span><br><span class=\"line\">docker inspect test --format &#x27;&#123;&#123; json .Mounts &#125;&#125;&#x27;</span><br><span class=\"line\">docker stop test</span><br><span class=\"line\">docker rm test</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"tmpfs-mounts\"><a href=\"#tmpfs-mounts\" class=\"headerlink\" title=\"tmpfs mounts\"></a>tmpfs mounts</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">start container with tmpfs</span></span><br><span class=\"line\">docker run -it --name tmptest \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option1</span></span><br><span class=\"line\">--tmpfs /app</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">option2</span></span><br><span class=\"line\">--mount type=tmpfs,target=/app \\</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">specify tmpfs options</span></span><br><span class=\"line\">--mount type=tmpfs,destination=/app,tmpfs-mode=1770,tmpfs-size=104857600 \\</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##</span></span></span><br><span class=\"line\">nginx:latest</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">show and remove container</span></span><br><span class=\"line\">docker inspect tmptest --format &#x27;&#123;&#123; json .Mounts &#125;&#125;&#x27;</span><br><span class=\"line\">docker stop tmptest</span><br><span class=\"line\">docker rm tmptest</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Storage-drivers\"><a href=\"#Storage-drivers\" class=\"headerlink\" title=\"Storage drivers\"></a>Storage drivers</h5><h6 id=\"Btrfs\"><a href=\"#Btrfs\" class=\"headerlink\" title=\"Btrfs\"></a>Btrfs</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">stop docker</span></span><br><span class=\"line\">systemctl stop docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">backup and empty contents</span></span><br><span class=\"line\">cp -au /var/lib/docker/ /var/lib/docker.bk</span><br><span class=\"line\">rm -rf /var/lib/docker/*</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">format block device as a btrfs filesystem</span></span><br><span class=\"line\">mkfs.btrfs -f /dev/xvdf</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">mount the btrfs filesystem on /var/lib/docker mount point</span></span><br><span class=\"line\">mount -t btrfs /dev/xvdf /var/lib/docker</span><br><span class=\"line\">cp -au /var/lib/docker.bk/* /var/lib/docker/</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configure Docker to use the btrfs storage driver</span></span><br><span class=\"line\">vim /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;storage-driver&quot;: &quot;btrfs&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">systemctl start docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker info --format &#x27;&#123;&#123; json .Driver &#125;&#125;&#x27;</span><br><span class=\"line\">&quot;btrfs&quot;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"OverlayFS\"><a href=\"#OverlayFS\" class=\"headerlink\" title=\"OverlayFS\"></a>OverlayFS</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">stop docker</span></span><br><span class=\"line\">systemctl stop docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">backup and empty contents</span></span><br><span class=\"line\">cp -au /var/lib/docker/ /var/lib/docker.bk</span><br><span class=\"line\">rm -rf /var/lib/docker/*</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">options: separate backing filesystem, mount into /var/lib/docker and make sure to add mount to /etc/fstab to make it.</span>  </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configure Docker to use the btrfs storage driver</span></span><br><span class=\"line\">vim /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">systemctl start docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker info --format &#x27;&#123;&#123; json .Driver &#125;&#125;&#x27;    </span><br><span class=\"line\">&quot;overlay2&quot;</span><br><span class=\"line\">mount |grep overlay |grep docker</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"ZFS\"><a href=\"#ZFS\" class=\"headerlink\" title=\"ZFS\"></a>ZFS</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">stop docker</span></span><br><span class=\"line\">systemctl stop docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">backup and empty contents</span></span><br><span class=\"line\">cp -auR /var/lib/docker/ /var/lib/docker.bk</span><br><span class=\"line\">rm -rf /var/lib/docker/*</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">create a new zpool on block device and mount into /var/lib/docker</span></span><br><span class=\"line\">zpool create -f zpool-docker -m /var/lib/docker /dev/xvdf</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">add zpoll</span></span><br><span class=\"line\">zpool add zpool-docker /dev/xvdh</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify zpool</span></span><br><span class=\"line\">zfs list</span><br><span class=\"line\">NAME           USED  AVAIL  REFER  MOUNTPOINT</span><br><span class=\"line\">zpool-docker    55K  96.4G    19K  /var/lib/docker</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configure Docker to use the btrfs storage driver</span></span><br><span class=\"line\">vim /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;storage-driver&quot;: &quot;zfs&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">systemctl start docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker info --format &#x27;&#123;&#123; json .Driver &#125;&#125;&#x27;    </span><br><span class=\"line\">&quot;zfs&quot;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"containerd-snapshotters\"><a href=\"#containerd-snapshotters\" class=\"headerlink\" title=\"containerd snapshotters\"></a>containerd snapshotters</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configure Docker to use the btrfs storage driver</span></span><br><span class=\"line\">vim /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;features&quot;: &#123;</span><br><span class=\"line\">    &quot;containerd-snapshotter&quot;: true</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">systemctl restart docker.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker info -f &#x27;&#123;&#123; .DriverStatus &#125;&#125;&#x27;</span><br><span class=\"line\">[[driver-type io.containerd.snapshotter.v1]]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Networking\"><a href=\"#Networking\" class=\"headerlink\" title=\"Networking\"></a>Networking</h4><h5 id=\"Overview-1\"><a href=\"#Overview-1\" class=\"headerlink\" title=\"Overview\"></a>Overview</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">show docker network info</span></span><br><span class=\"line\">docker network ls</span><br><span class=\"line\">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class=\"line\">b2adc1fcf214   bridge    bridge    local</span><br><span class=\"line\">2ed9fbc8db3e   host      host      local</span><br><span class=\"line\">f1b2d749ed2c   none      null      local</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">how to use</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge</span></span><br><span class=\"line\">--net bridge</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">host</span></span><br><span class=\"line\">--net host</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">none</span></span><br><span class=\"line\">--net none</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">container</span></span><br><span class=\"line\">--net container:container_name|container_id</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Networking-drivers\"><a href=\"#Networking-drivers\" class=\"headerlink\" title=\"Networking drivers\"></a>Networking drivers</h5><h6 id=\"Bridge\"><a href=\"#Bridge\" class=\"headerlink\" title=\"Bridge\"></a>Bridge</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge</span></span><br><span class=\"line\"> IP  docker0 </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1. container namespace</span></span><br><span class=\"line\">xxx</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2.daemon  veth pair veth pair </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> docker0  vethxxx</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">brctl show</span><br><span class=\"line\">bridge name     bridge id               STP enabled     interfaces</span><br><span class=\"line\">docker0         8000.0242db01d347       no              vethccab668</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> vethxxx </span></span><br><span class=\"line\">ip addr |grep vethccab668</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> container  namespace  eth0 </span></span><br><span class=\"line\">docker run --rm -dit busybox sh ip addr</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3.daemon  docker0  IP  docker0  IP </span></span><br><span class=\"line\">docker inspect test |grep Gateway</span><br><span class=\"line\">            &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Overlay\"><a href=\"#Overlay\" class=\"headerlink\" title=\"Overlay\"></a>Overlay</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> docker  docker swarm </span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Host\"><a href=\"#Host\" class=\"headerlink\" title=\"Host\"></a>Host</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">host</span></span><br><span class=\"line\"> IP </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">test</span></span></span><br><span class=\"line\">docker run --rm -dit --net host busybox ip addr</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"IPvlan\"><a href=\"#IPvlan\" class=\"headerlink\" title=\"IPvlan\"></a>IPvlan</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ipvlan</span></span><br><span class=\"line\">ipvlan_mode: l2, l3(default), l3s</span><br><span class=\"line\">ipvlan_flag: bridge(default), private, vepa</span><br><span class=\"line\">parent: eth0</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">l2 mode: </span></span><br><span class=\"line\">docker network create -d ipvlan \\</span><br><span class=\"line\">     --subnet=192.168.1.0/24 \\</span><br><span class=\"line\">     --gateway=192.168.1.1 \\</span><br><span class=\"line\">     -o ipvlan_mode=l2 \\</span><br><span class=\"line\">     -o parent=eth0 test_l2_net</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">test</span></span></span><br><span class=\"line\">docker run --net=test_l2_net --name=ipv1 -dit alpine /bin/sh</span><br><span class=\"line\">docker run --net=test_l2_net --name=ipv2 -it --rm alpine /bin/sh</span><br><span class=\"line\">ping -c 4 ipv1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">l3 mode</span></span><br><span class=\"line\">docker network create -d ipvlan \\</span><br><span class=\"line\">     --subnet=192.168.1.0/24 \\</span><br><span class=\"line\">     --subnet=10.10.1.0/24 \\</span><br><span class=\"line\">     -o ipvlan_mode=l3 test_l3_net</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">test</span></span></span><br><span class=\"line\">docker run --net=test_l3_net --ip=192.168.1.10 -dit busybox /bin/sh</span><br><span class=\"line\">docker run --net=test_l3_net --ip=10.10.1.10 -dit busybox /bin/sh</span><br><span class=\"line\"></span><br><span class=\"line\">docker run --net=test_l3_net --ip=192.168.1.9 -it --rm busybox ping -c 2 10.10.1.10</span><br><span class=\"line\">docker run --net=test_l3_net --ip=10.10.1.9 -it --rm busybox ping -c 2 192.168.1.10</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Macvlan\"><a href=\"#Macvlan\" class=\"headerlink\" title=\"Macvlan\"></a>Macvlan</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">macvlan</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge mode</span></span><br><span class=\"line\">docker network create -d macvlan \\</span><br><span class=\"line\">  --subnet=172.16.86.0/24 \\</span><br><span class=\"line\">  --gateway=172.16.86.1 \\</span><br><span class=\"line\">  -o parent=eth0 pub_net</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">802.1Q trunk bridge mode</span></span><br><span class=\"line\">docker network create -d macvlan \\</span><br><span class=\"line\">    --subnet=192.168.50.0/24 \\</span><br><span class=\"line\">    --gateway=192.168.50.1 \\</span><br><span class=\"line\">    -o parent=eth0.50 macvlan50</span><br><span class=\"line\"></span><br><span class=\"line\">docker network create -d macvlan \\</span><br><span class=\"line\">    --subnet=192.168.60.0/24 \\</span><br><span class=\"line\">    --gateway=192.168.60.1 \\</span><br><span class=\"line\">    -o parent=eth0.60 macvlan60</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">https://zhuanlan.zhihu.com/p/616504632</span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"None\"><a href=\"#None\" class=\"headerlink\" title=\"None\"></a>None</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">none</span></span><br><span class=\"line\"> veth pair </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker run --rm -dit --net none busybox ip addr</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Container\"><a href=\"#Container\" class=\"headerlink\" title=\"Container\"></a>Container</h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">container</span></span><br><span class=\"line\"> IP</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker run -dit --name test --rm busybox sh</span><br><span class=\"line\">docker run -it --name c1 --net container:test --rm busybox ip addr</span><br><span class=\"line\">docker run -it --name c2 --net container:test --rm busybox ip addr</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">user-defined</span> </span><br><span class=\"line\"> docker0  container name host  daemon  DNS server --name  container name </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker network create yakir-test</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">ip addr</span><br><span class=\"line\">    inet 172.19.0.1/16 brd 172.19.255.255 scope global br-8cb8260a95cf</span><br><span class=\"line\">brctl show</span><br><span class=\"line\">br-8cb8260a95cf         8000.024272aa9d38       no              veth556b81b</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">verify</span></span><br><span class=\"line\">docker run -dit --name test1 --net yakir-test --rm busybox sh</span><br><span class=\"line\">docker run -it --name test2 --net yakir-test --rm busybox ping -c 4 test1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run -dit --name test3 --net yakir-test --rm busybox sh</span><br><span class=\"line\">docker network connect yakir-test test3 </span><br><span class=\"line\">docker exec -it test3 ip addr</span><br><span class=\"line\">531: eth0@if532: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class=\"line\">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">533: eth1@if534: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class=\"line\">    link/ether 02:42:ac:13:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.19.0.2/16 brd 172.19.255.255 scope global eth1</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Daemon\"><a href=\"#Daemon\" class=\"headerlink\" title=\"Daemon\"></a>Daemon</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configuration file</span></span><br><span class=\"line\">/etc/docker/daemon.json</span><br><span class=\"line\">~/.config/docker/daemon.json</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">configuration using flags</span></span><br><span class=\"line\">dockerd --debug \\</span><br><span class=\"line\">  --tls=true \\</span><br><span class=\"line\">  --tlscert=/var/docker/server.pem \\</span><br><span class=\"line\">  --tlskey=/var/docker/serverkey.pem \\</span><br><span class=\"line\">  --host tcp://192.168.10.1:2376</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">default data directory</span></span><br><span class=\"line\">/var/lib/docker</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">systemd</span></span><br><span class=\"line\">cat /lib/systemd/system/docker.service</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Docker-Build-amp-amp-Compose\"><a href=\"#Docker-Build-amp-amp-Compose\" class=\"headerlink\" title=\"Docker Build &amp;&amp; Compose\"></a>Docker Build &amp;&amp; Compose</h4><h5 id=\"Dockerfile\"><a href=\"#Dockerfile\" class=\"headerlink\" title=\"Dockerfile\"></a>Dockerfile</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">1.  base </span><br><span class=\"line\">2. </span><br><span class=\"line\">3. </span><br><span class=\"line\">4. </span><br><span class=\"line\">5. </span><br><span class=\"line\">6.  Dockerfile entrypoint / +</span><br><span class=\"line\">7.  cache </span><br><span class=\"line\">8.  git /</span><br><span class=\"line\">9.  .dockerignore </span><br></pre></td></tr></table></figure>\n\n<h5 id=\"docker-compose\"><a href=\"#docker-compose\" class=\"headerlink\" title=\"docker-compose\"></a>docker-compose</h5><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Command\"><a href=\"#Command\" class=\"headerlink\" title=\"Command\"></a>Command</h4><p>[[containerRuntime#docker &amp; podman|Docker Command]]</p>\n<blockquote>\n<p>Reference:</p>\n<ol>\n<li><a href=\"https://docs.docker.com/\">Docker Official Documentation</a></li>\n<li><a href=\"https://docs.docker.com/network/drivers/\">Docker network-drivers</a></li>\n<li><a href=\"https://docs.docker.com/engine/reference/builder/\">Dockerfile reference</a></li>\n</ol>\n</blockquote>"},{"title":"","abbrlink":"dc02","date":"2022-06-06T12:28:44.000Z","_content":"### \n\n#### Alicloud Ingress \n****\n\n1.  Ingress \n1.  cookie  A/B \n\n\n****\n\n1.  Deployment  Service\n\n Edas  service SLB  app1 \n\n| **** | **** | **** |\n| --- | --- | --- |\n| Edas  | app1-test | app1-new-test |\n| Deployment | app1-test-group-x-xxx | app1-new-test-group-x-xxx |\n| Service | app1-svc | app1-new-svc |\n\n<!--more-->\n\n2.  ingress\n```\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    #  cookie \n    nginx.ingress.kubernetes.io/service-match: |\n      new-nginx: cookie(\"foo\", /^aBc123.*/)\n  name: gray-release\n  namespace: default\nspec:\n  rules:\n  - host: www.yakir.com\n    http:\n      paths:\n      # \n      - backend:\n          service:\n            name: old-nginx\n            port:\n              number: 80\n        path: /\n        pathType: ImplementationSpecific\n      # \n      - backend:\n          service:\n            name: new-nginx\n            port:\n              number: 80\n        path: /\n        pathType: ImplementationSpecific\n```\n\n3. \n\n\n\n#### Istio \n****\n\n1.  istio \n```\n#  istio\ncurl -L https://istio.io/downloadIstio | sh -\n\n#  istio \ncd istio-1.13.3/\n./bin/istioctl install --set profile=demo\n\n# default demo \n./bin/istioctl profile list\nIstio configuration profiles:\n    default\n    demo\n    empty\n    external\n    minimal\n    openshift\n    preview\n    remote\n\n```\n\n2.  cookie  A/B \n\n****\n\n1.  Deployment  Service\n\n2.  istio \n\nistio-gateway.yaml  kubectl apply -f istio-gateway.yaml && kubectl apply -f virtualservice.yaml \n```\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-gateway-test\nspec:\n  selector:\n    istio: ingressgateway # use istio default controller\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    tls:\n      httpsRedirect: true\n    hosts:\n    - \"*.yakir.com\"\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    tls:\n      mode: SIMPLE\n      credentialName: yakir-com.cert\n    hosts:\n    - \"*.yakir.com\"\n```\n```\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: virtual-service-test\nspec:\n  hosts:\n  - yakir.yakir.com\n  gateways:\n  - istio-gateway-test\n  http:\n  - match:\n    - headers:\n        cookie:\n          regex: \"^(.*?;)?(foo=aBc123.*)(;.*)?$\"\n    route:\n    - destination:\n        host: new-nginx-svc\n        port:\n          number: 80\n  - route:\n    - destination:\n        host: old-nginx-svc\n        port:\n          number: 80\n```\n\n3. \n\n\n> istio  https \n> 1.  yakir.com  kubectl cli \n>  ->   crtkey TLS \n> 2. istio gateway  https  secret  \n\n\n\n#### \n\n\n-  CI/CD  + Edas  + Service app1-testapp1-test-new\n-  app1  Service Service cookie  Service\n\n-  owner  WAF  ingress  istio \n\n~~~~\n\n-  Deployment Service DestinationRule  Deployment\n\n Deployment  label  DestinationRule \n```\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: virtual-service-test\nspec:\n  hosts:\n  - yakir.yakir.com\n  gateways:\n  - istio-gateway-test\n  http:\n  #  host subsets \n  - match:\n    - headers:\n        cookie:\n          regex: \"^(.*?;)?(foo=aBc123.*)(;.*)?$\"\n    route:\n    - destination:\n        host: test-nginx-svc\n        subset: new\n        port:\n          number: 80\n  - route:\n    - destination:\n        host: test-nginx-svc\n        subset: old\n        port:\n          number: 80\n```\n```\nkind: DestinationRule\nmetadata:\n  name: destination-rule-test\nspec:\n  host: test-nginx-svc\n  #  label  Deployment\n  subsets:\n  - name: old\n    labels:\n      edas.oam.acversion: \"3\"\n  - name: new\n    labels:\n      edas.oam.acversion: \"4\"\n```\n\n\n#### ***\n****\n CRD  ingress \nistio \n SLB \n\n\n****\nAlicloud Ingress[https://help.aliyun.com/document_detail/200941.html#section-t2t-eik-oyr](https://help.aliyun.com/document_detail/200941.html#section-t2t-eik-oyr)\nIstio [https://istio.io/latest/zh/docs/concepts/traffic-management/](https://istio.io/latest/zh/docs/concepts/traffic-management/)\n\n","source":"_posts/gatewayGrayRelease.md","raw":"---\ntitle: \ncategories:\n  - CNCF\n  - Alicloud\ntags:\n  - Istio\nabbrlink: dc02\ndate: 2022-06-06 20:28:44\n---\n### \n\n#### Alicloud Ingress \n****\n\n1.  Ingress \n1.  cookie  A/B \n\n\n****\n\n1.  Deployment  Service\n\n Edas  service SLB  app1 \n\n| **** | **** | **** |\n| --- | --- | --- |\n| Edas  | app1-test | app1-new-test |\n| Deployment | app1-test-group-x-xxx | app1-new-test-group-x-xxx |\n| Service | app1-svc | app1-new-svc |\n\n<!--more-->\n\n2.  ingress\n```\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    #  cookie \n    nginx.ingress.kubernetes.io/service-match: |\n      new-nginx: cookie(\"foo\", /^aBc123.*/)\n  name: gray-release\n  namespace: default\nspec:\n  rules:\n  - host: www.yakir.com\n    http:\n      paths:\n      # \n      - backend:\n          service:\n            name: old-nginx\n            port:\n              number: 80\n        path: /\n        pathType: ImplementationSpecific\n      # \n      - backend:\n          service:\n            name: new-nginx\n            port:\n              number: 80\n        path: /\n        pathType: ImplementationSpecific\n```\n\n3. \n\n\n\n#### Istio \n****\n\n1.  istio \n```\n#  istio\ncurl -L https://istio.io/downloadIstio | sh -\n\n#  istio \ncd istio-1.13.3/\n./bin/istioctl install --set profile=demo\n\n# default demo \n./bin/istioctl profile list\nIstio configuration profiles:\n    default\n    demo\n    empty\n    external\n    minimal\n    openshift\n    preview\n    remote\n\n```\n\n2.  cookie  A/B \n\n****\n\n1.  Deployment  Service\n\n2.  istio \n\nistio-gateway.yaml  kubectl apply -f istio-gateway.yaml && kubectl apply -f virtualservice.yaml \n```\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-gateway-test\nspec:\n  selector:\n    istio: ingressgateway # use istio default controller\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    tls:\n      httpsRedirect: true\n    hosts:\n    - \"*.yakir.com\"\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    tls:\n      mode: SIMPLE\n      credentialName: yakir-com.cert\n    hosts:\n    - \"*.yakir.com\"\n```\n```\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: virtual-service-test\nspec:\n  hosts:\n  - yakir.yakir.com\n  gateways:\n  - istio-gateway-test\n  http:\n  - match:\n    - headers:\n        cookie:\n          regex: \"^(.*?;)?(foo=aBc123.*)(;.*)?$\"\n    route:\n    - destination:\n        host: new-nginx-svc\n        port:\n          number: 80\n  - route:\n    - destination:\n        host: old-nginx-svc\n        port:\n          number: 80\n```\n\n3. \n\n\n> istio  https \n> 1.  yakir.com  kubectl cli \n>  ->   crtkey TLS \n> 2. istio gateway  https  secret  \n\n\n\n#### \n\n\n-  CI/CD  + Edas  + Service app1-testapp1-test-new\n-  app1  Service Service cookie  Service\n\n-  owner  WAF  ingress  istio \n\n~~~~\n\n-  Deployment Service DestinationRule  Deployment\n\n Deployment  label  DestinationRule \n```\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: virtual-service-test\nspec:\n  hosts:\n  - yakir.yakir.com\n  gateways:\n  - istio-gateway-test\n  http:\n  #  host subsets \n  - match:\n    - headers:\n        cookie:\n          regex: \"^(.*?;)?(foo=aBc123.*)(;.*)?$\"\n    route:\n    - destination:\n        host: test-nginx-svc\n        subset: new\n        port:\n          number: 80\n  - route:\n    - destination:\n        host: test-nginx-svc\n        subset: old\n        port:\n          number: 80\n```\n```\nkind: DestinationRule\nmetadata:\n  name: destination-rule-test\nspec:\n  host: test-nginx-svc\n  #  label  Deployment\n  subsets:\n  - name: old\n    labels:\n      edas.oam.acversion: \"3\"\n  - name: new\n    labels:\n      edas.oam.acversion: \"4\"\n```\n\n\n#### ***\n****\n CRD  ingress \nistio \n SLB \n\n\n****\nAlicloud Ingress[https://help.aliyun.com/document_detail/200941.html#section-t2t-eik-oyr](https://help.aliyun.com/document_detail/200941.html#section-t2t-eik-oyr)\nIstio [https://istio.io/latest/zh/docs/concepts/traffic-management/](https://istio.io/latest/zh/docs/concepts/traffic-management/)\n\n","slug":"gatewayGrayRelease","published":1,"updated":"2024-01-21T15:29:17.071Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zl000fs0nj7p6m6d3k","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"Alicloud-Ingress-\"><a href=\"#Alicloud-Ingress-\" class=\"headerlink\" title=\"Alicloud Ingress \"></a>Alicloud Ingress </h4><p><strong></strong></p>\n<ol>\n<li> Ingress </li>\n<li> cookie  A&#x2F;B </li>\n</ol>\n<p><strong></strong></p>\n<ol>\n<li> Deployment  Service</li>\n</ol>\n<p> Edas  service SLB  app1 </p>\n<table>\n<thead>\n<tr>\n<th><strong></strong></th>\n<th><strong></strong></th>\n<th><strong></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Edas </td>\n<td>app1-test</td>\n<td>app1-new-test</td>\n</tr>\n<tr>\n<td>Deployment</td>\n<td>app1-test-group-x-xxx</td>\n<td>app1-new-test-group-x-xxx</td>\n</tr>\n<tr>\n<td>Service</td>\n<td>app1-svc</td>\n<td>app1-new-svc</td>\n</tr>\n</tbody></table>\n<span id=\"more\"></span>\n\n<ol start=\"2\">\n<li><p> ingress</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    #  cookie </span><br><span class=\"line\">    nginx.ingress.kubernetes.io/service-match: |</span><br><span class=\"line\">      new-nginx: cookie(&quot;foo&quot;, /^aBc123.*/)</span><br><span class=\"line\">  name: gray-release</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">  - host: www.yakir.com</span><br><span class=\"line\">    http:</span><br><span class=\"line\">      paths:</span><br><span class=\"line\">      # </span><br><span class=\"line\">      - backend:</span><br><span class=\"line\">          service:</span><br><span class=\"line\">            name: old-nginx</span><br><span class=\"line\">            port:</span><br><span class=\"line\">              number: 80</span><br><span class=\"line\">        path: /</span><br><span class=\"line\">        pathType: ImplementationSpecific</span><br><span class=\"line\">      # </span><br><span class=\"line\">      - backend:</span><br><span class=\"line\">          service:</span><br><span class=\"line\">            name: new-nginx</span><br><span class=\"line\">            port:</span><br><span class=\"line\">              number: 80</span><br><span class=\"line\">        path: /</span><br><span class=\"line\">        pathType: ImplementationSpecific</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><br></p>\n</li>\n</ol>\n<h4 id=\"Istio-\"><a href=\"#Istio-\" class=\"headerlink\" title=\"Istio \"></a>Istio </h4><p><strong></strong></p>\n<ol>\n<li><p> istio </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#  istio</span><br><span class=\"line\">curl -L https://istio.io/downloadIstio | sh -</span><br><span class=\"line\"></span><br><span class=\"line\">#  istio </span><br><span class=\"line\">cd istio-1.13.3/</span><br><span class=\"line\">./bin/istioctl install --set profile=demo</span><br><span class=\"line\"></span><br><span class=\"line\"># default demo </span><br><span class=\"line\">./bin/istioctl profile list</span><br><span class=\"line\">Istio configuration profiles:</span><br><span class=\"line\">    default</span><br><span class=\"line\">    demo</span><br><span class=\"line\">    empty</span><br><span class=\"line\">    external</span><br><span class=\"line\">    minimal</span><br><span class=\"line\">    openshift</span><br><span class=\"line\">    preview</span><br><span class=\"line\">    remote</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p> cookie  A&#x2F;B </p>\n</li>\n</ol>\n<p><strong></strong></p>\n<ol>\n<li><p> Deployment  Service</p>\n</li>\n<li><p> istio </p>\n</li>\n</ol>\n<p>istio-gateway.yaml  kubectl apply -f istio-gateway.yaml &amp;&amp; kubectl apply -f virtualservice.yaml </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.istio.io/v1alpha3</span><br><span class=\"line\">kind: Gateway</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: istio-gateway-test</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    istio: ingressgateway # use istio default controller</span><br><span class=\"line\">  servers:</span><br><span class=\"line\">  - port:</span><br><span class=\"line\">      number: 80</span><br><span class=\"line\">      name: http</span><br><span class=\"line\">      protocol: HTTP</span><br><span class=\"line\">    tls:</span><br><span class=\"line\">      httpsRedirect: true</span><br><span class=\"line\">    hosts:</span><br><span class=\"line\">    - &quot;*.yakir.com&quot;</span><br><span class=\"line\">  - port:</span><br><span class=\"line\">      number: 443</span><br><span class=\"line\">      name: https</span><br><span class=\"line\">      protocol: HTTPS</span><br><span class=\"line\">    tls:</span><br><span class=\"line\">      mode: SIMPLE</span><br><span class=\"line\">      credentialName: yakir-com.cert</span><br><span class=\"line\">    hosts:</span><br><span class=\"line\">    - &quot;*.yakir.com&quot;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.istio.io/v1alpha3</span><br><span class=\"line\">kind: VirtualService</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: virtual-service-test</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  hosts:</span><br><span class=\"line\">  - yakir.yakir.com</span><br><span class=\"line\">  gateways:</span><br><span class=\"line\">  - istio-gateway-test</span><br><span class=\"line\">  http:</span><br><span class=\"line\">  - match:</span><br><span class=\"line\">    - headers:</span><br><span class=\"line\">        cookie:</span><br><span class=\"line\">          regex: &quot;^(.*?;)?(foo=aBc123.*)(;.*)?$&quot;</span><br><span class=\"line\">    route:</span><br><span class=\"line\">    - destination:</span><br><span class=\"line\">        host: new-nginx-svc</span><br><span class=\"line\">        port:</span><br><span class=\"line\">          number: 80</span><br><span class=\"line\">  - route:</span><br><span class=\"line\">    - destination:</span><br><span class=\"line\">        host: old-nginx-svc</span><br><span class=\"line\">        port:</span><br><span class=\"line\">          number: 80</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><br></li>\n</ol>\n<blockquote>\n<p>istio  https </p>\n<ol>\n<li> yakir.com  kubectl cli <br> -&gt;   crtkey TLS </li>\n<li>istio gateway  https  secret  </li>\n</ol>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li><p> CI&#x2F;CD  + Edas  + Service app1-testapp1-test-new</p>\n</li>\n<li><p> app1  Service Service cookie  Service</p>\n</li>\n<li><p> owner  WAF  ingress  istio </p>\n</li>\n</ul>\n<p><del></del></p>\n<ul>\n<li> Deployment Service DestinationRule  Deployment</li>\n</ul>\n<p> Deployment  label  DestinationRule </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.istio.io/v1alpha3</span><br><span class=\"line\">kind: VirtualService</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: virtual-service-test</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  hosts:</span><br><span class=\"line\">  - yakir.yakir.com</span><br><span class=\"line\">  gateways:</span><br><span class=\"line\">  - istio-gateway-test</span><br><span class=\"line\">  http:</span><br><span class=\"line\">  #  host subsets </span><br><span class=\"line\">  - match:</span><br><span class=\"line\">    - headers:</span><br><span class=\"line\">        cookie:</span><br><span class=\"line\">          regex: &quot;^(.*?;)?(foo=aBc123.*)(;.*)?$&quot;</span><br><span class=\"line\">    route:</span><br><span class=\"line\">    - destination:</span><br><span class=\"line\">        host: test-nginx-svc</span><br><span class=\"line\">        subset: new</span><br><span class=\"line\">        port:</span><br><span class=\"line\">          number: 80</span><br><span class=\"line\">  - route:</span><br><span class=\"line\">    - destination:</span><br><span class=\"line\">        host: test-nginx-svc</span><br><span class=\"line\">        subset: old</span><br><span class=\"line\">        port:</span><br><span class=\"line\">          number: 80</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kind: DestinationRule</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: destination-rule-test</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  host: test-nginx-svc</span><br><span class=\"line\">  #  label  Deployment</span><br><span class=\"line\">  subsets:</span><br><span class=\"line\">  - name: old</span><br><span class=\"line\">    labels:</span><br><span class=\"line\">      edas.oam.acversion: &quot;3&quot;</span><br><span class=\"line\">  - name: new</span><br><span class=\"line\">    labels:</span><br><span class=\"line\">      edas.oam.acversion: &quot;4&quot;</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"***\"></a>***</h4><p><strong></strong><br> CRD  ingress <br>istio <br> SLB </p>\n<p><strong></strong><br>Alicloud Ingress<a href=\"https://help.aliyun.com/document_detail/200941.html#section-t2t-eik-oyr\">https://help.aliyun.com/document_detail&#x2F;200941.html#section-t2t-eik-oyr</a><br>Istio <a href=\"https://istio.io/latest/zh/docs/concepts/traffic-management/\">https://istio.io/latest/zh/docs/concepts/traffic-management/</a></p>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":3459,"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"Alicloud-Ingress-\"><a href=\"#Alicloud-Ingress-\" class=\"headerlink\" title=\"Alicloud Ingress \"></a>Alicloud Ingress </h4><p><strong></strong></p>\n<ol>\n<li> Ingress </li>\n<li> cookie  A&#x2F;B </li>\n</ol>\n<p><strong></strong></p>\n<ol>\n<li> Deployment  Service</li>\n</ol>\n<p> Edas  service SLB  app1 </p>\n<table>\n<thead>\n<tr>\n<th><strong></strong></th>\n<th><strong></strong></th>\n<th><strong></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Edas </td>\n<td>app1-test</td>\n<td>app1-new-test</td>\n</tr>\n<tr>\n<td>Deployment</td>\n<td>app1-test-group-x-xxx</td>\n<td>app1-new-test-group-x-xxx</td>\n</tr>\n<tr>\n<td>Service</td>\n<td>app1-svc</td>\n<td>app1-new-svc</td>\n</tr>\n</tbody></table>","more":"<ol start=\"2\">\n<li><p> ingress</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    #  cookie </span><br><span class=\"line\">    nginx.ingress.kubernetes.io/service-match: |</span><br><span class=\"line\">      new-nginx: cookie(&quot;foo&quot;, /^aBc123.*/)</span><br><span class=\"line\">  name: gray-release</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">  - host: www.yakir.com</span><br><span class=\"line\">    http:</span><br><span class=\"line\">      paths:</span><br><span class=\"line\">      # </span><br><span class=\"line\">      - backend:</span><br><span class=\"line\">          service:</span><br><span class=\"line\">            name: old-nginx</span><br><span class=\"line\">            port:</span><br><span class=\"line\">              number: 80</span><br><span class=\"line\">        path: /</span><br><span class=\"line\">        pathType: ImplementationSpecific</span><br><span class=\"line\">      # </span><br><span class=\"line\">      - backend:</span><br><span class=\"line\">          service:</span><br><span class=\"line\">            name: new-nginx</span><br><span class=\"line\">            port:</span><br><span class=\"line\">              number: 80</span><br><span class=\"line\">        path: /</span><br><span class=\"line\">        pathType: ImplementationSpecific</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><br></p>\n</li>\n</ol>\n<h4 id=\"Istio-\"><a href=\"#Istio-\" class=\"headerlink\" title=\"Istio \"></a>Istio </h4><p><strong></strong></p>\n<ol>\n<li><p> istio </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#  istio</span><br><span class=\"line\">curl -L https://istio.io/downloadIstio | sh -</span><br><span class=\"line\"></span><br><span class=\"line\">#  istio </span><br><span class=\"line\">cd istio-1.13.3/</span><br><span class=\"line\">./bin/istioctl install --set profile=demo</span><br><span class=\"line\"></span><br><span class=\"line\"># default demo </span><br><span class=\"line\">./bin/istioctl profile list</span><br><span class=\"line\">Istio configuration profiles:</span><br><span class=\"line\">    default</span><br><span class=\"line\">    demo</span><br><span class=\"line\">    empty</span><br><span class=\"line\">    external</span><br><span class=\"line\">    minimal</span><br><span class=\"line\">    openshift</span><br><span class=\"line\">    preview</span><br><span class=\"line\">    remote</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p> cookie  A&#x2F;B </p>\n</li>\n</ol>\n<p><strong></strong></p>\n<ol>\n<li><p> Deployment  Service</p>\n</li>\n<li><p> istio </p>\n</li>\n</ol>\n<p>istio-gateway.yaml  kubectl apply -f istio-gateway.yaml &amp;&amp; kubectl apply -f virtualservice.yaml </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.istio.io/v1alpha3</span><br><span class=\"line\">kind: Gateway</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: istio-gateway-test</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    istio: ingressgateway # use istio default controller</span><br><span class=\"line\">  servers:</span><br><span class=\"line\">  - port:</span><br><span class=\"line\">      number: 80</span><br><span class=\"line\">      name: http</span><br><span class=\"line\">      protocol: HTTP</span><br><span class=\"line\">    tls:</span><br><span class=\"line\">      httpsRedirect: true</span><br><span class=\"line\">    hosts:</span><br><span class=\"line\">    - &quot;*.yakir.com&quot;</span><br><span class=\"line\">  - port:</span><br><span class=\"line\">      number: 443</span><br><span class=\"line\">      name: https</span><br><span class=\"line\">      protocol: HTTPS</span><br><span class=\"line\">    tls:</span><br><span class=\"line\">      mode: SIMPLE</span><br><span class=\"line\">      credentialName: yakir-com.cert</span><br><span class=\"line\">    hosts:</span><br><span class=\"line\">    - &quot;*.yakir.com&quot;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.istio.io/v1alpha3</span><br><span class=\"line\">kind: VirtualService</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: virtual-service-test</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  hosts:</span><br><span class=\"line\">  - yakir.yakir.com</span><br><span class=\"line\">  gateways:</span><br><span class=\"line\">  - istio-gateway-test</span><br><span class=\"line\">  http:</span><br><span class=\"line\">  - match:</span><br><span class=\"line\">    - headers:</span><br><span class=\"line\">        cookie:</span><br><span class=\"line\">          regex: &quot;^(.*?;)?(foo=aBc123.*)(;.*)?$&quot;</span><br><span class=\"line\">    route:</span><br><span class=\"line\">    - destination:</span><br><span class=\"line\">        host: new-nginx-svc</span><br><span class=\"line\">        port:</span><br><span class=\"line\">          number: 80</span><br><span class=\"line\">  - route:</span><br><span class=\"line\">    - destination:</span><br><span class=\"line\">        host: old-nginx-svc</span><br><span class=\"line\">        port:</span><br><span class=\"line\">          number: 80</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><br></li>\n</ol>\n<blockquote>\n<p>istio  https </p>\n<ol>\n<li> yakir.com  kubectl cli <br> -&gt;   crtkey TLS </li>\n<li>istio gateway  https  secret  </li>\n</ol>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li><p> CI&#x2F;CD  + Edas  + Service app1-testapp1-test-new</p>\n</li>\n<li><p> app1  Service Service cookie  Service</p>\n</li>\n<li><p> owner  WAF  ingress  istio </p>\n</li>\n</ul>\n<p><del></del></p>\n<ul>\n<li> Deployment Service DestinationRule  Deployment</li>\n</ul>\n<p> Deployment  label  DestinationRule </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.istio.io/v1alpha3</span><br><span class=\"line\">kind: VirtualService</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: virtual-service-test</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  hosts:</span><br><span class=\"line\">  - yakir.yakir.com</span><br><span class=\"line\">  gateways:</span><br><span class=\"line\">  - istio-gateway-test</span><br><span class=\"line\">  http:</span><br><span class=\"line\">  #  host subsets </span><br><span class=\"line\">  - match:</span><br><span class=\"line\">    - headers:</span><br><span class=\"line\">        cookie:</span><br><span class=\"line\">          regex: &quot;^(.*?;)?(foo=aBc123.*)(;.*)?$&quot;</span><br><span class=\"line\">    route:</span><br><span class=\"line\">    - destination:</span><br><span class=\"line\">        host: test-nginx-svc</span><br><span class=\"line\">        subset: new</span><br><span class=\"line\">        port:</span><br><span class=\"line\">          number: 80</span><br><span class=\"line\">  - route:</span><br><span class=\"line\">    - destination:</span><br><span class=\"line\">        host: test-nginx-svc</span><br><span class=\"line\">        subset: old</span><br><span class=\"line\">        port:</span><br><span class=\"line\">          number: 80</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kind: DestinationRule</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: destination-rule-test</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  host: test-nginx-svc</span><br><span class=\"line\">  #  label  Deployment</span><br><span class=\"line\">  subsets:</span><br><span class=\"line\">  - name: old</span><br><span class=\"line\">    labels:</span><br><span class=\"line\">      edas.oam.acversion: &quot;3&quot;</span><br><span class=\"line\">  - name: new</span><br><span class=\"line\">    labels:</span><br><span class=\"line\">      edas.oam.acversion: &quot;4&quot;</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"***\"></a>***</h4><p><strong></strong><br> CRD  ingress <br>istio <br> SLB </p>\n<p><strong></strong><br>Alicloud Ingress<a href=\"https://help.aliyun.com/document_detail/200941.html#section-t2t-eik-oyr\">https://help.aliyun.com/document_detail&#x2F;200941.html#section-t2t-eik-oyr</a><br>Istio <a href=\"https://istio.io/latest/zh/docs/concepts/traffic-management/\">https://istio.io/latest/zh/docs/concepts/traffic-management/</a></p>"},{"title":"Git Flow ","abbrlink":"539","date":"2022-05-04T13:14:23.000Z","_content":"### gitflowgit\n1. GitFlow\n- masterdevelopfeaturereleasehotfixsupport\n- masterdevelopfeaturereleasehotfix\n   - pushgitlabgithub\n   - git\n\n<!--more-->\n2. GitFlow\n\n{% asset_img gf1.png %}\n{% asset_img gf2.png %}\n\n- master \n\n{% asset_img gf3.png %}\n\n   - hotfix/release \n   - mastertag\n\n- develop \n   - master\n   - featuredevelop\n   - releasedelevoprelease\n   - release/hotfixdevelop\n\n- feature \n\n{% asset_img gf4.png %}\n\n   - developdevelop\n   - feature\n\n- release \n\n{% asset_img gf5.png %}\n\n   - featuredevelopdevelop\n   - BUGbugfix-*bugdevelop/mastermastertag\n   - releasedevelopreleaserelease\n\n- hotfix \n\n{% asset_img gf6.png %}\n\n   - masterBUG\n   - bugdevelop/masterhotfixreleasemastertag\n   - bug\n\n3. \n- \n   - buildmaventarget.idea.gitignore\n   - gitflow\n   - develop\n- \n   - master    develop\n   - tagv*. release* release v1.0.0. release\n   - feature-** jiraAone\n   - release-** releaserelease-1.0.0releasebugbugfix-*\n   - masterbughotfix-** jiraAone\n\n### \n\n- git flow init develop\n\n{% asset_img gf7.png %}\n{% asset_img gf8.png %}\n\n- githubsshdevelop\n\n{% asset_img gf9.png %}\n\n- tmpclone\n\n{% asset_img gf10.png %}\n\n- developfeature\n\n{% asset_img gf11.png %}\n{% asset_img gf12.png %}\n\n- trackgit push\n\n{% asset_img gf13.png %}\n{% asset_img gf14.png %}\n\n- developfeature-F\n\n{% asset_img gf15.png %}\nfinishdeveloprelease\n\n","source":"_posts/git-flow.md","raw":"---\ntitle: Git Flow \ncategories:\n  - Operations\ntags:\n  - git\nabbrlink: '539'\ndate: 2022-05-04 21:14:23\n---\n### gitflowgit\n1. GitFlow\n- masterdevelopfeaturereleasehotfixsupport\n- masterdevelopfeaturereleasehotfix\n   - pushgitlabgithub\n   - git\n\n<!--more-->\n2. GitFlow\n\n{% asset_img gf1.png %}\n{% asset_img gf2.png %}\n\n- master \n\n{% asset_img gf3.png %}\n\n   - hotfix/release \n   - mastertag\n\n- develop \n   - master\n   - featuredevelop\n   - releasedelevoprelease\n   - release/hotfixdevelop\n\n- feature \n\n{% asset_img gf4.png %}\n\n   - developdevelop\n   - feature\n\n- release \n\n{% asset_img gf5.png %}\n\n   - featuredevelopdevelop\n   - BUGbugfix-*bugdevelop/mastermastertag\n   - releasedevelopreleaserelease\n\n- hotfix \n\n{% asset_img gf6.png %}\n\n   - masterBUG\n   - bugdevelop/masterhotfixreleasemastertag\n   - bug\n\n3. \n- \n   - buildmaventarget.idea.gitignore\n   - gitflow\n   - develop\n- \n   - master    develop\n   - tagv*. release* release v1.0.0. release\n   - feature-** jiraAone\n   - release-** releaserelease-1.0.0releasebugbugfix-*\n   - masterbughotfix-** jiraAone\n\n### \n\n- git flow init develop\n\n{% asset_img gf7.png %}\n{% asset_img gf8.png %}\n\n- githubsshdevelop\n\n{% asset_img gf9.png %}\n\n- tmpclone\n\n{% asset_img gf10.png %}\n\n- developfeature\n\n{% asset_img gf11.png %}\n{% asset_img gf12.png %}\n\n- trackgit push\n\n{% asset_img gf13.png %}\n{% asset_img gf14.png %}\n\n- developfeature-F\n\n{% asset_img gf15.png %}\nfinishdeveloprelease\n\n","slug":"git-flow","published":1,"updated":"2024-01-21T15:28:43.152Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zl000gs0njfffade4a","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"gitflowgit\"><a href=\"#gitflowgit\" class=\"headerlink\" title=\"gitflowgit\"></a>gitflowgit</h3><ol>\n<li>GitFlow</li>\n</ol>\n<ul>\n<li>masterdevelopfeaturereleasehotfixsupport</li>\n<li>masterdevelopfeaturereleasehotfix<ul>\n<li>pushgitlabgithub</li>\n<li>git</li>\n</ul>\n</li>\n</ul>\n<span id=\"more\"></span>\n<ol start=\"2\">\n<li>GitFlow</li>\n</ol>\n<img data-src=\"/posts/539/gf1.png\" class>\n<img data-src=\"/posts/539/gf2.png\" class>\n\n<ul>\n<li>master</li>\n</ul>\n<img data-src=\"/posts/539/gf3.png\" class>\n\n<ul>\n<li><p>hotfix&#x2F;release </p>\n</li>\n<li><p>mastertag</p>\n</li>\n<li><p>develop </p>\n<ul>\n<li>master</li>\n<li>featuredevelop</li>\n<li>releasedelevoprelease</li>\n<li>release&#x2F;hotfixdevelop</li>\n</ul>\n</li>\n<li><p>feature</p>\n</li>\n</ul>\n<img data-src=\"/posts/539/gf4.png\" class>\n\n<ul>\n<li><p>developdevelop</p>\n</li>\n<li><p>feature</p>\n</li>\n<li><p>release</p>\n</li>\n</ul>\n<img data-src=\"/posts/539/gf5.png\" class>\n\n<ul>\n<li><p>featuredevelopdevelop</p>\n</li>\n<li><p>BUGbugfix-*bugdevelop&#x2F;mastermastertag</p>\n</li>\n<li><p>releasedevelopreleaserelease</p>\n</li>\n<li><p>hotfix</p>\n</li>\n</ul>\n<img data-src=\"/posts/539/gf6.png\" class>\n\n<ul>\n<li>masterBUG</li>\n<li>bugdevelop&#x2F;masterhotfixreleasemastertag</li>\n<li>bug</li>\n</ul>\n<ol start=\"3\">\n<li></li>\n</ol>\n<ul>\n<li><ul>\n<li>buildmaventarget.idea.gitignore</li>\n<li>gitflow</li>\n<li>develop</li>\n</ul>\n</li>\n<li><ul>\n<li>master    develop</li>\n<li>tagv*. release* release v1.0.0. release</li>\n<li>feature-<em></em> jiraAone</li>\n<li>release-<em></em> releaserelease-1.0.0releasebugbugfix-*</li>\n<li>masterbughotfix-<em></em> jiraAone</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>git flow init develop</li>\n</ul>\n<img data-src=\"/posts/539/gf7.png\" class>\n<img data-src=\"/posts/539/gf8.png\" class>\n\n<ul>\n<li>githubsshdevelop</li>\n</ul>\n<img data-src=\"/posts/539/gf9.png\" class>\n\n<ul>\n<li>tmpclone</li>\n</ul>\n<img data-src=\"/posts/539/gf10.png\" class>\n\n<ul>\n<li>developfeature</li>\n</ul>\n<img data-src=\"/posts/539/gf11.png\" class>\n<img data-src=\"/posts/539/gf12.png\" class>\n\n<ul>\n<li>trackgit push</li>\n</ul>\n<img data-src=\"/posts/539/gf13.png\" class>\n<img data-src=\"/posts/539/gf14.png\" class>\n\n<ul>\n<li>developfeature-F</li>\n</ul>\n<img data-src=\"/posts/539/gf15.png\" class>\n<p>finishdeveloprelease</p>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":1751,"excerpt":"<h3 id=\"gitflowgit\"><a href=\"#gitflowgit\" class=\"headerlink\" title=\"gitflowgit\"></a>gitflowgit</h3><ol>\n<li>GitFlow</li>\n</ol>\n<ul>\n<li>masterdevelopfeaturereleasehotfixsupport</li>\n<li>masterdevelopfeaturereleasehotfix<ul>\n<li>pushgitlabgithub</li>\n<li>git</li>\n</ul>\n</li>\n</ul>","more":"<ol start=\"2\">\n<li>GitFlow</li>\n</ol>\n<img data-src=\"/posts/539/gf1.png\" class>\n<img data-src=\"/posts/539/gf2.png\" class>\n\n<ul>\n<li>master</li>\n</ul>\n<img data-src=\"/posts/539/gf3.png\" class>\n\n<ul>\n<li><p>hotfix&#x2F;release </p>\n</li>\n<li><p>mastertag</p>\n</li>\n<li><p>develop </p>\n<ul>\n<li>master</li>\n<li>featuredevelop</li>\n<li>releasedelevoprelease</li>\n<li>release&#x2F;hotfixdevelop</li>\n</ul>\n</li>\n<li><p>feature</p>\n</li>\n</ul>\n<img data-src=\"/posts/539/gf4.png\" class>\n\n<ul>\n<li><p>developdevelop</p>\n</li>\n<li><p>feature</p>\n</li>\n<li><p>release</p>\n</li>\n</ul>\n<img data-src=\"/posts/539/gf5.png\" class>\n\n<ul>\n<li><p>featuredevelopdevelop</p>\n</li>\n<li><p>BUGbugfix-*bugdevelop&#x2F;mastermastertag</p>\n</li>\n<li><p>releasedevelopreleaserelease</p>\n</li>\n<li><p>hotfix</p>\n</li>\n</ul>\n<img data-src=\"/posts/539/gf6.png\" class>\n\n<ul>\n<li>masterBUG</li>\n<li>bugdevelop&#x2F;masterhotfixreleasemastertag</li>\n<li>bug</li>\n</ul>\n<ol start=\"3\">\n<li></li>\n</ol>\n<ul>\n<li><ul>\n<li>buildmaventarget.idea.gitignore</li>\n<li>gitflow</li>\n<li>develop</li>\n</ul>\n</li>\n<li><ul>\n<li>master    develop</li>\n<li>tagv*. release* release v1.0.0. release</li>\n<li>feature-<em></em> jiraAone</li>\n<li>release-<em></em> releaserelease-1.0.0releasebugbugfix-*</li>\n<li>masterbughotfix-<em></em> jiraAone</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>git flow init develop</li>\n</ul>\n<img data-src=\"/posts/539/gf7.png\" class>\n<img data-src=\"/posts/539/gf8.png\" class>\n\n<ul>\n<li>githubsshdevelop</li>\n</ul>\n<img data-src=\"/posts/539/gf9.png\" class>\n\n<ul>\n<li>tmpclone</li>\n</ul>\n<img data-src=\"/posts/539/gf10.png\" class>\n\n<ul>\n<li>developfeature</li>\n</ul>\n<img data-src=\"/posts/539/gf11.png\" class>\n<img data-src=\"/posts/539/gf12.png\" class>\n\n<ul>\n<li>trackgit push</li>\n</ul>\n<img data-src=\"/posts/539/gf13.png\" class>\n<img data-src=\"/posts/539/gf14.png\" class>\n\n<ul>\n<li>developfeature-F</li>\n</ul>\n<img data-src=\"/posts/539/gf15.png\" class>\n<p>finishdeveloprelease</p>"},{"title":"Helm ","abbrlink":"ce0f","date":"2022-05-04T13:46:04.000Z","_content":"### Helm \n#### 1Helm \n\n- [](https://helm.sh/zh/docs/intro/install/)kubernetes \n\n<!--more-->\n- Alicloudhelm \n```bash\n#  Helm \nhelm plugin install https://github.com/AliyunContainerService/helm-acr\n\n<!--more-->\n# \nexport HELM_REPO_USERNAME='<>'\nexport HELM_REPO_PASSWORD='<>'\nhelm repo add <> acr://registry-chart-test.cn-hangzhou.cr.aliyuncs.com/<>/<Chart> --username ${HELM_REPO_USERNAME} --password ${HELM_REPO_PASSWORD}\n#export HELM_REPO_USERNAME=devops@ib_daily\n#export HELM_REPO_PASSWORD=2RJPfCgHXroSYQga\n#helm repo add aliyun-acr-repo acr://registry-chart-test.cn-hangzhou.cr.aliyuncs.com/chart-test/app-test --username ${HELM_REPO_USERNAME} --password ${HELM_REPO_PASSWORD}\n\n# Chart\n# Chart\nhelm create <Chart >\n#helm create app-test\n# Chart \nhelm cm-push <Chart > <>\n#helm cm-push app-test aliyun-acr-repo\n# Chart \nhelm cm-push <Chart >-<Chart >.tgz <>\n\n# Chart\n#Chart Chart \nhelm repo update\n#helm repo update aliyun-acr-repo\n#Chart\nhelm fetch <>/<Chart > --version <Chart >\n#helm fetch aliyun-acr-repo/app-test --version=20211228100329-daily\n#Chart\nhelm install -f values.yaml <>/<Chart > --version <Chart >\n#helm install app-test aliyun-acr-repo/app-test --version 20211228100329-daily --namespace daily-apps\n```\n> helm install \n> - Namespace\n> - NetworkPolicy\n> - ResourceQuota\n> - LimitRange\n> - PodSecurityPolicy\n> - PodDisruptionBudget\n> - ServiceAccount\n> - Secret\n> - SecretList\n> - ConfigMap\n> - StorageClass\n> - PersistentVolume\n> - PersistentVolumeClaim\n> - CustomResourceDefinition\n> - ClusterRole\n> - ClusterRoleList\n> - ClusterRoleBinding\n> - ClusterRoleBindingList\n> - Role\n> - RoleList\n> - RoleBinding\n> - RoleBindingList\n> - Service\n> - DaemonSet\n> - Pod\n> - ReplicationController\n> - ReplicaSet\n> - Deployment\n> - HorizontalPodAutoscaler\n> - StatefulSet\n> - Job\n> - CronJob\n> - Ingress\n> - APIService\n\n[](https://helm.sh/zh/docs/helm/helm/)\n> - helm repo list\n> - /helm repo add xxx / helm repo remove xxx\n> - /chartshelm cm-push xxx / helm fetch/pull xxx\n> - /chartshelm install xxx /  helm uninstall xxx\n> - /helm upgrade xxx / helm rollback xxx <revision>\n> - charts helm create xxx\n> - charts / helm show values / helm get values\n\n\n- ACR \n> helm pull image ACR [ACR ](https://yuque.antfin.com/kifo8h/nee5aa/wgui7o)\n\n\n\n#### 2Helm \n> [Charts ](https://www.qikqiak.com/k8strain/helm/demo/)\n\n- \n\n- Chart.yamlchart  Values.yaml chartschart\n\n- templates Kubernetes Yaml deploymentpod \n   - confimap.yamldeployment.yaml \n   - _helpers.tpl\n\n- [](https://helm.sh/zh/docs/chart_template_guide/function_list/)[](https://helm.sh/zh/docs/chart_template_guide/control_structures/)\n\n- \n\n\n### app-test\n#### 1helmkubectlKubernetes \n\n#### 2app-test \n\n- helm create app-test\n\n- app-test \n\n{% asset_img helm1.png %}\n\n- \n```yaml\n# Chart.yaml\napiVersion: v2\nname: app-test\ndescription: application app-test for env daily\ntype: application\nversion: 20211215123042-daily\nappVersion: 20211215123042_daily\n```\n```yaml\n# values.yaml\nreplicaCount: 1\n\nimage:\n  repository: registry-chart-test.cn-hangzhou.cr.aliyuncs.com/ib-ibos/app-test\n  pullPolicy: IfNotPresent\n  tag: \"\"\n\nimagePullSecrets: []\nnameOverride: \"\"\nfullnameOverride: \"\"\n\nserviceAccount:\n  create: false\n  annotations: {}\n  name: \"\"\n\npodAnnotations: {}\n\npodSecurityContext: {}\n\nsecurityContext: {}\n\nservice:\n  type: ClusterIP\n  port: 8080\n  create: false\n\ningress:\n  enabled: false\n  className: \"\"\n  annotations: {}\n  hosts:\n    - host: reos.com.cn\n      paths:\n        - path: /\n          pathType: ImplementationSpecific\n  tls: []\n\nresources: {}\n\nautoscaling:\n  enabled: false\n  minReplicas: 1\n  maxReplicas: 100\n  targetCPUUtilizationPercentage: 80\n\nnodeSelector: {}\n\ntolerations: []\n\naffinity: {}\n```\n\n#### 3\n\n- ACR  [Helm](#ht9xj) \n\n{% asset_img helm2.png %}\n\n- \n   - \n```bash\nhelm install app-test aliyun-acr-repo/app-test --version 20211228100329-daily --namespace daily-apps\n```\n\n   - \n{% asset_img helm3.png %}\n{% asset_img helm4.png %}\n\n- \n{% asset_img helm5.png %}\n\n### \n\n- helm Kubernetes API Server EIP\n\n- AlicloudEdas \n   - helm Edas helm Edas \n   - Edas Deployment [https://help.aliyun.com/document_detail/202036.html](https://help.aliyun.com/document_detail/202036.html)Edas Edas \n\n- \n   - helm values  image->repository pull  helm push pull \n   - helm upgrade rollback \n\n- CI/CD \n   - helm  CI/CD \n","source":"_posts/helm-deploy.md","raw":"---\ntitle: Helm \ncategories:\n  - CNCF\ntags:\n  - Alicloud\nabbrlink: ce0f\ndate: 2022-05-04 21:46:04\n---\n### Helm \n#### 1Helm \n\n- [](https://helm.sh/zh/docs/intro/install/)kubernetes \n\n<!--more-->\n- Alicloudhelm \n```bash\n#  Helm \nhelm plugin install https://github.com/AliyunContainerService/helm-acr\n\n<!--more-->\n# \nexport HELM_REPO_USERNAME='<>'\nexport HELM_REPO_PASSWORD='<>'\nhelm repo add <> acr://registry-chart-test.cn-hangzhou.cr.aliyuncs.com/<>/<Chart> --username ${HELM_REPO_USERNAME} --password ${HELM_REPO_PASSWORD}\n#export HELM_REPO_USERNAME=devops@ib_daily\n#export HELM_REPO_PASSWORD=2RJPfCgHXroSYQga\n#helm repo add aliyun-acr-repo acr://registry-chart-test.cn-hangzhou.cr.aliyuncs.com/chart-test/app-test --username ${HELM_REPO_USERNAME} --password ${HELM_REPO_PASSWORD}\n\n# Chart\n# Chart\nhelm create <Chart >\n#helm create app-test\n# Chart \nhelm cm-push <Chart > <>\n#helm cm-push app-test aliyun-acr-repo\n# Chart \nhelm cm-push <Chart >-<Chart >.tgz <>\n\n# Chart\n#Chart Chart \nhelm repo update\n#helm repo update aliyun-acr-repo\n#Chart\nhelm fetch <>/<Chart > --version <Chart >\n#helm fetch aliyun-acr-repo/app-test --version=20211228100329-daily\n#Chart\nhelm install -f values.yaml <>/<Chart > --version <Chart >\n#helm install app-test aliyun-acr-repo/app-test --version 20211228100329-daily --namespace daily-apps\n```\n> helm install \n> - Namespace\n> - NetworkPolicy\n> - ResourceQuota\n> - LimitRange\n> - PodSecurityPolicy\n> - PodDisruptionBudget\n> - ServiceAccount\n> - Secret\n> - SecretList\n> - ConfigMap\n> - StorageClass\n> - PersistentVolume\n> - PersistentVolumeClaim\n> - CustomResourceDefinition\n> - ClusterRole\n> - ClusterRoleList\n> - ClusterRoleBinding\n> - ClusterRoleBindingList\n> - Role\n> - RoleList\n> - RoleBinding\n> - RoleBindingList\n> - Service\n> - DaemonSet\n> - Pod\n> - ReplicationController\n> - ReplicaSet\n> - Deployment\n> - HorizontalPodAutoscaler\n> - StatefulSet\n> - Job\n> - CronJob\n> - Ingress\n> - APIService\n\n[](https://helm.sh/zh/docs/helm/helm/)\n> - helm repo list\n> - /helm repo add xxx / helm repo remove xxx\n> - /chartshelm cm-push xxx / helm fetch/pull xxx\n> - /chartshelm install xxx /  helm uninstall xxx\n> - /helm upgrade xxx / helm rollback xxx <revision>\n> - charts helm create xxx\n> - charts / helm show values / helm get values\n\n\n- ACR \n> helm pull image ACR [ACR ](https://yuque.antfin.com/kifo8h/nee5aa/wgui7o)\n\n\n\n#### 2Helm \n> [Charts ](https://www.qikqiak.com/k8strain/helm/demo/)\n\n- \n\n- Chart.yamlchart  Values.yaml chartschart\n\n- templates Kubernetes Yaml deploymentpod \n   - confimap.yamldeployment.yaml \n   - _helpers.tpl\n\n- [](https://helm.sh/zh/docs/chart_template_guide/function_list/)[](https://helm.sh/zh/docs/chart_template_guide/control_structures/)\n\n- \n\n\n### app-test\n#### 1helmkubectlKubernetes \n\n#### 2app-test \n\n- helm create app-test\n\n- app-test \n\n{% asset_img helm1.png %}\n\n- \n```yaml\n# Chart.yaml\napiVersion: v2\nname: app-test\ndescription: application app-test for env daily\ntype: application\nversion: 20211215123042-daily\nappVersion: 20211215123042_daily\n```\n```yaml\n# values.yaml\nreplicaCount: 1\n\nimage:\n  repository: registry-chart-test.cn-hangzhou.cr.aliyuncs.com/ib-ibos/app-test\n  pullPolicy: IfNotPresent\n  tag: \"\"\n\nimagePullSecrets: []\nnameOverride: \"\"\nfullnameOverride: \"\"\n\nserviceAccount:\n  create: false\n  annotations: {}\n  name: \"\"\n\npodAnnotations: {}\n\npodSecurityContext: {}\n\nsecurityContext: {}\n\nservice:\n  type: ClusterIP\n  port: 8080\n  create: false\n\ningress:\n  enabled: false\n  className: \"\"\n  annotations: {}\n  hosts:\n    - host: reos.com.cn\n      paths:\n        - path: /\n          pathType: ImplementationSpecific\n  tls: []\n\nresources: {}\n\nautoscaling:\n  enabled: false\n  minReplicas: 1\n  maxReplicas: 100\n  targetCPUUtilizationPercentage: 80\n\nnodeSelector: {}\n\ntolerations: []\n\naffinity: {}\n```\n\n#### 3\n\n- ACR  [Helm](#ht9xj) \n\n{% asset_img helm2.png %}\n\n- \n   - \n```bash\nhelm install app-test aliyun-acr-repo/app-test --version 20211228100329-daily --namespace daily-apps\n```\n\n   - \n{% asset_img helm3.png %}\n{% asset_img helm4.png %}\n\n- \n{% asset_img helm5.png %}\n\n### \n\n- helm Kubernetes API Server EIP\n\n- AlicloudEdas \n   - helm Edas helm Edas \n   - Edas Deployment [https://help.aliyun.com/document_detail/202036.html](https://help.aliyun.com/document_detail/202036.html)Edas Edas \n\n- \n   - helm values  image->repository pull  helm push pull \n   - helm upgrade rollback \n\n- CI/CD \n   - helm  CI/CD \n","slug":"helm-deploy","published":1,"updated":"2024-01-21T15:28:43.152Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zl000ks0nj53b06id7","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"Helm-\"><a href=\"#Helm-\" class=\"headerlink\" title=\"Helm \"></a>Helm </h3><h4 id=\"1Helm-\"><a href=\"#1Helm-\" class=\"headerlink\" title=\"1Helm \"></a>1Helm </h4><ul>\n<li><a href=\"https://helm.sh/zh/docs/intro/install/\"></a>kubernetes </li>\n</ul>\n<span id=\"more\"></span>\n<ul>\n<li>Alicloudhelm <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  Helm </span></span><br><span class=\"line\">helm plugin install https://github.com/AliyunContainerService/helm-acr</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!--more--&gt;</span><br><span class=\"line\"><span class=\"comment\"># </span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HELM_REPO_USERNAME=<span class=\"string\">&#x27;&lt;&gt;&#x27;</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HELM_REPO_PASSWORD=<span class=\"string\">&#x27;&lt;&gt;&#x27;</span></span><br><span class=\"line\">helm repo add &lt;&gt; acr://registry-chart-test.cn-hangzhou.cr.aliyuncs.com/&lt;&gt;/&lt;Chart&gt; --username <span class=\"variable\">$&#123;HELM_REPO_USERNAME&#125;</span> --password <span class=\"variable\">$&#123;HELM_REPO_PASSWORD&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#export HELM_REPO_USERNAME=devops@ib_daily</span></span><br><span class=\"line\"><span class=\"comment\">#export HELM_REPO_PASSWORD=2RJPfCgHXroSYQga</span></span><br><span class=\"line\"><span class=\"comment\">#helm repo add aliyun-acr-repo acr://registry-chart-test.cn-hangzhou.cr.aliyuncs.com/chart-test/app-test --username $&#123;HELM_REPO_USERNAME&#125; --password $&#123;HELM_REPO_PASSWORD&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Chart</span></span><br><span class=\"line\"><span class=\"comment\"># Chart</span></span><br><span class=\"line\">helm create &lt;Chart &gt;</span><br><span class=\"line\"><span class=\"comment\">#helm create app-test</span></span><br><span class=\"line\"><span class=\"comment\"># Chart </span></span><br><span class=\"line\">helm cm-push &lt;Chart &gt; &lt;&gt;</span><br><span class=\"line\"><span class=\"comment\">#helm cm-push app-test aliyun-acr-repo</span></span><br><span class=\"line\"><span class=\"comment\"># Chart </span></span><br><span class=\"line\">helm cm-push &lt;Chart &gt;-&lt;Chart &gt;.tgz &lt;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Chart</span></span><br><span class=\"line\"><span class=\"comment\">#Chart Chart </span></span><br><span class=\"line\">helm repo update</span><br><span class=\"line\"><span class=\"comment\">#helm repo update aliyun-acr-repo</span></span><br><span class=\"line\"><span class=\"comment\">#Chart</span></span><br><span class=\"line\">helm fetch &lt;&gt;/&lt;Chart &gt; --version &lt;Chart &gt;</span><br><span class=\"line\"><span class=\"comment\">#helm fetch aliyun-acr-repo/app-test --version=20211228100329-daily</span></span><br><span class=\"line\"><span class=\"comment\">#Chart</span></span><br><span class=\"line\">helm install -f values.yaml &lt;&gt;/&lt;Chart &gt; --version &lt;Chart &gt;</span><br><span class=\"line\"><span class=\"comment\">#helm install app-test aliyun-acr-repo/app-test --version 20211228100329-daily --namespace daily-apps</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>helm install </p>\n<ul>\n<li>Namespace</li>\n<li>NetworkPolicy</li>\n<li>ResourceQuota</li>\n<li>LimitRange</li>\n<li>PodSecurityPolicy</li>\n<li>PodDisruptionBudget</li>\n<li>ServiceAccount</li>\n<li>Secret</li>\n<li>SecretList</li>\n<li>ConfigMap</li>\n<li>StorageClass</li>\n<li>PersistentVolume</li>\n<li>PersistentVolumeClaim</li>\n<li>CustomResourceDefinition</li>\n<li>ClusterRole</li>\n<li>ClusterRoleList</li>\n<li>ClusterRoleBinding</li>\n<li>ClusterRoleBindingList</li>\n<li>Role</li>\n<li>RoleList</li>\n<li>RoleBinding</li>\n<li>RoleBindingList</li>\n<li>Service</li>\n<li>DaemonSet</li>\n<li>Pod</li>\n<li>ReplicationController</li>\n<li>ReplicaSet</li>\n<li>Deployment</li>\n<li>HorizontalPodAutoscaler</li>\n<li>StatefulSet</li>\n<li>Job</li>\n<li>CronJob</li>\n<li>Ingress</li>\n<li>APIService</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n<p><a href=\"https://helm.sh/zh/docs/helm/helm/\"></a></p>\n<blockquote>\n<ul>\n<li>helm repo list</li>\n<li>&#x2F;helm repo add xxx &#x2F; helm repo remove xxx</li>\n<li>&#x2F;chartshelm cm-push xxx &#x2F; helm fetch&#x2F;pull xxx</li>\n<li>&#x2F;chartshelm install xxx &#x2F;  helm uninstall xxx</li>\n<li>&#x2F;helm upgrade xxx &#x2F; helm rollback xxx <revision></revision></li>\n<li>charts helm create xxx</li>\n<li>charts &#x2F; helm show values &#x2F; helm get values</li>\n</ul>\n</blockquote>\n<ul>\n<li>ACR <blockquote>\n<p>helm pull image ACR <a href=\"https://yuque.antfin.com/kifo8h/nee5aa/wgui7o\">ACR </a></p>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"2Helm-\"><a href=\"#2Helm-\" class=\"headerlink\" title=\"2Helm \"></a>2Helm </h4><blockquote>\n<p><a href=\"https://www.qikqiak.com/k8strain/helm/demo/\">Charts </a></p>\n</blockquote>\n<ul>\n<li><p></p>\n</li>\n<li><p>Chart.yamlchart  Values.yaml chartschart</p>\n</li>\n<li><p>templates Kubernetes Yaml deploymentpod </p>\n<ul>\n<li>confimap.yamldeployment.yaml </li>\n<li>_helpers.tpl</li>\n</ul>\n</li>\n<li><p><a href=\"https://helm.sh/zh/docs/chart_template_guide/function_list/\"></a><a href=\"https://helm.sh/zh/docs/chart_template_guide/control_structures/\"></a></p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<h3 id=\"app-test\"><a href=\"#app-test\" class=\"headerlink\" title=\"app-test\"></a>app-test</h3><h4 id=\"1helmkubectlKubernetes-\"><a href=\"#1helmkubectlKubernetes-\" class=\"headerlink\" title=\"1helmkubectlKubernetes \"></a>1helmkubectlKubernetes </h4><h4 id=\"2app-test\"><a href=\"#2app-test\" class=\"headerlink\" title=\"2app-test\"></a>2app-test</h4><ul>\n<li><p>helm create app-test</p>\n</li>\n<li><p>app-test </p>\n</li>\n</ul>\n<img data-src=\"/posts/ce0f/helm1.png\" class>\n\n<ul>\n<li><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Chart.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">app-test</span></span><br><span class=\"line\"><span class=\"attr\">description:</span> <span class=\"string\">application</span> <span class=\"string\">app-test</span> <span class=\"string\">for</span> <span class=\"string\">env</span> <span class=\"string\">daily</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">application</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">20211215123042</span><span class=\"string\">-daily</span></span><br><span class=\"line\"><span class=\"attr\">appVersion:</span> <span class=\"string\">20211215123042_daily</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># values.yaml</span></span><br><span class=\"line\"><span class=\"attr\">replicaCount:</span> <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">image:</span></span><br><span class=\"line\">  <span class=\"attr\">repository:</span> <span class=\"string\">registry-chart-test.cn-hangzhou.cr.aliyuncs.com/ib-ibos/app-test</span></span><br><span class=\"line\">  <span class=\"attr\">pullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">  <span class=\"attr\">tag:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">imagePullSecrets:</span> []</span><br><span class=\"line\"><span class=\"attr\">nameOverride:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"attr\">fullnameOverride:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">serviceAccount:</span></span><br><span class=\"line\">  <span class=\"attr\">create:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">podAnnotations:</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">podSecurityContext:</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">securityContext:</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">service:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">  <span class=\"attr\">create:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">className:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">hosts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">reos.com.cn</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">  <span class=\"attr\">tls:</span> []</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">autoscaling:</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">minReplicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">maxReplicas:</span> <span class=\"number\">100</span></span><br><span class=\"line\">  <span class=\"attr\">targetCPUUtilizationPercentage:</span> <span class=\"number\">80</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">nodeSelector:</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">tolerations:</span> []</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">affinity:</span> &#123;&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><ul>\n<li>ACR  <a href=\"#ht9xj\">Helm</a> </li>\n</ul>\n<img data-src=\"/posts/ce0f/helm2.png\" class>\n\n<ul>\n<li><ul>\n<li><p></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm install app-test aliyun-acr-repo/app-test --version 20211228100329-daily --namespace daily-apps</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n</li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/ce0f/helm3.png\" class>\n<img data-src=\"/posts/ce0f/helm4.png\" class>\n\n<ul>\n<li><img data-src=\"/posts/ce0f/helm5.png\" class></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>helm Kubernetes API Server EIP</p>\n</li>\n<li><p>AlicloudEdas </p>\n<ul>\n<li>helm Edas helm Edas </li>\n<li>Edas Deployment <a href=\"https://help.aliyun.com/document_detail/202036.html\">https://help.aliyun.com/document_detail&#x2F;202036.html</a>Edas Edas </li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>helm values  image-&gt;repository pull  helm push pull </li>\n<li>helm upgrade rollback </li>\n</ul>\n</li>\n<li><p>CI&#x2F;CD </p>\n<ul>\n<li>helm  CI&#x2F;CD </li>\n</ul>\n</li>\n</ul>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":4171,"excerpt":"<h3 id=\"Helm-\"><a href=\"#Helm-\" class=\"headerlink\" title=\"Helm \"></a>Helm </h3><h4 id=\"1Helm-\"><a href=\"#1Helm-\" class=\"headerlink\" title=\"1Helm \"></a>1Helm </h4><ul>\n<li><a href=\"https://helm.sh/zh/docs/intro/install/\"></a>kubernetes </li>\n</ul>","more":"<ul>\n<li>Alicloudhelm <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  Helm </span></span><br><span class=\"line\">helm plugin install https://github.com/AliyunContainerService/helm-acr</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!--more--&gt;</span><br><span class=\"line\"><span class=\"comment\"># </span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HELM_REPO_USERNAME=<span class=\"string\">&#x27;&lt;&gt;&#x27;</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> HELM_REPO_PASSWORD=<span class=\"string\">&#x27;&lt;&gt;&#x27;</span></span><br><span class=\"line\">helm repo add &lt;&gt; acr://registry-chart-test.cn-hangzhou.cr.aliyuncs.com/&lt;&gt;/&lt;Chart&gt; --username <span class=\"variable\">$&#123;HELM_REPO_USERNAME&#125;</span> --password <span class=\"variable\">$&#123;HELM_REPO_PASSWORD&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#export HELM_REPO_USERNAME=devops@ib_daily</span></span><br><span class=\"line\"><span class=\"comment\">#export HELM_REPO_PASSWORD=2RJPfCgHXroSYQga</span></span><br><span class=\"line\"><span class=\"comment\">#helm repo add aliyun-acr-repo acr://registry-chart-test.cn-hangzhou.cr.aliyuncs.com/chart-test/app-test --username $&#123;HELM_REPO_USERNAME&#125; --password $&#123;HELM_REPO_PASSWORD&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Chart</span></span><br><span class=\"line\"><span class=\"comment\"># Chart</span></span><br><span class=\"line\">helm create &lt;Chart &gt;</span><br><span class=\"line\"><span class=\"comment\">#helm create app-test</span></span><br><span class=\"line\"><span class=\"comment\"># Chart </span></span><br><span class=\"line\">helm cm-push &lt;Chart &gt; &lt;&gt;</span><br><span class=\"line\"><span class=\"comment\">#helm cm-push app-test aliyun-acr-repo</span></span><br><span class=\"line\"><span class=\"comment\"># Chart </span></span><br><span class=\"line\">helm cm-push &lt;Chart &gt;-&lt;Chart &gt;.tgz &lt;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Chart</span></span><br><span class=\"line\"><span class=\"comment\">#Chart Chart </span></span><br><span class=\"line\">helm repo update</span><br><span class=\"line\"><span class=\"comment\">#helm repo update aliyun-acr-repo</span></span><br><span class=\"line\"><span class=\"comment\">#Chart</span></span><br><span class=\"line\">helm fetch &lt;&gt;/&lt;Chart &gt; --version &lt;Chart &gt;</span><br><span class=\"line\"><span class=\"comment\">#helm fetch aliyun-acr-repo/app-test --version=20211228100329-daily</span></span><br><span class=\"line\"><span class=\"comment\">#Chart</span></span><br><span class=\"line\">helm install -f values.yaml &lt;&gt;/&lt;Chart &gt; --version &lt;Chart &gt;</span><br><span class=\"line\"><span class=\"comment\">#helm install app-test aliyun-acr-repo/app-test --version 20211228100329-daily --namespace daily-apps</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>helm install </p>\n<ul>\n<li>Namespace</li>\n<li>NetworkPolicy</li>\n<li>ResourceQuota</li>\n<li>LimitRange</li>\n<li>PodSecurityPolicy</li>\n<li>PodDisruptionBudget</li>\n<li>ServiceAccount</li>\n<li>Secret</li>\n<li>SecretList</li>\n<li>ConfigMap</li>\n<li>StorageClass</li>\n<li>PersistentVolume</li>\n<li>PersistentVolumeClaim</li>\n<li>CustomResourceDefinition</li>\n<li>ClusterRole</li>\n<li>ClusterRoleList</li>\n<li>ClusterRoleBinding</li>\n<li>ClusterRoleBindingList</li>\n<li>Role</li>\n<li>RoleList</li>\n<li>RoleBinding</li>\n<li>RoleBindingList</li>\n<li>Service</li>\n<li>DaemonSet</li>\n<li>Pod</li>\n<li>ReplicationController</li>\n<li>ReplicaSet</li>\n<li>Deployment</li>\n<li>HorizontalPodAutoscaler</li>\n<li>StatefulSet</li>\n<li>Job</li>\n<li>CronJob</li>\n<li>Ingress</li>\n<li>APIService</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n<p><a href=\"https://helm.sh/zh/docs/helm/helm/\"></a></p>\n<blockquote>\n<ul>\n<li>helm repo list</li>\n<li>&#x2F;helm repo add xxx &#x2F; helm repo remove xxx</li>\n<li>&#x2F;chartshelm cm-push xxx &#x2F; helm fetch&#x2F;pull xxx</li>\n<li>&#x2F;chartshelm install xxx &#x2F;  helm uninstall xxx</li>\n<li>&#x2F;helm upgrade xxx &#x2F; helm rollback xxx <revision></revision></li>\n<li>charts helm create xxx</li>\n<li>charts &#x2F; helm show values &#x2F; helm get values</li>\n</ul>\n</blockquote>\n<ul>\n<li>ACR <blockquote>\n<p>helm pull image ACR <a href=\"https://yuque.antfin.com/kifo8h/nee5aa/wgui7o\">ACR </a></p>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"2Helm-\"><a href=\"#2Helm-\" class=\"headerlink\" title=\"2Helm \"></a>2Helm </h4><blockquote>\n<p><a href=\"https://www.qikqiak.com/k8strain/helm/demo/\">Charts </a></p>\n</blockquote>\n<ul>\n<li><p></p>\n</li>\n<li><p>Chart.yamlchart  Values.yaml chartschart</p>\n</li>\n<li><p>templates Kubernetes Yaml deploymentpod </p>\n<ul>\n<li>confimap.yamldeployment.yaml </li>\n<li>_helpers.tpl</li>\n</ul>\n</li>\n<li><p><a href=\"https://helm.sh/zh/docs/chart_template_guide/function_list/\"></a><a href=\"https://helm.sh/zh/docs/chart_template_guide/control_structures/\"></a></p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<h3 id=\"app-test\"><a href=\"#app-test\" class=\"headerlink\" title=\"app-test\"></a>app-test</h3><h4 id=\"1helmkubectlKubernetes-\"><a href=\"#1helmkubectlKubernetes-\" class=\"headerlink\" title=\"1helmkubectlKubernetes \"></a>1helmkubectlKubernetes </h4><h4 id=\"2app-test\"><a href=\"#2app-test\" class=\"headerlink\" title=\"2app-test\"></a>2app-test</h4><ul>\n<li><p>helm create app-test</p>\n</li>\n<li><p>app-test </p>\n</li>\n</ul>\n<img data-src=\"/posts/ce0f/helm1.png\" class>\n\n<ul>\n<li><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Chart.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">app-test</span></span><br><span class=\"line\"><span class=\"attr\">description:</span> <span class=\"string\">application</span> <span class=\"string\">app-test</span> <span class=\"string\">for</span> <span class=\"string\">env</span> <span class=\"string\">daily</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">application</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">20211215123042</span><span class=\"string\">-daily</span></span><br><span class=\"line\"><span class=\"attr\">appVersion:</span> <span class=\"string\">20211215123042_daily</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># values.yaml</span></span><br><span class=\"line\"><span class=\"attr\">replicaCount:</span> <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">image:</span></span><br><span class=\"line\">  <span class=\"attr\">repository:</span> <span class=\"string\">registry-chart-test.cn-hangzhou.cr.aliyuncs.com/ib-ibos/app-test</span></span><br><span class=\"line\">  <span class=\"attr\">pullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">  <span class=\"attr\">tag:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">imagePullSecrets:</span> []</span><br><span class=\"line\"><span class=\"attr\">nameOverride:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"attr\">fullnameOverride:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">serviceAccount:</span></span><br><span class=\"line\">  <span class=\"attr\">create:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">podAnnotations:</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">podSecurityContext:</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">securityContext:</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">service:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">  <span class=\"attr\">create:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">className:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">hosts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">reos.com.cn</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">          <span class=\"attr\">pathType:</span> <span class=\"string\">ImplementationSpecific</span></span><br><span class=\"line\">  <span class=\"attr\">tls:</span> []</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">autoscaling:</span></span><br><span class=\"line\">  <span class=\"attr\">enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">minReplicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">maxReplicas:</span> <span class=\"number\">100</span></span><br><span class=\"line\">  <span class=\"attr\">targetCPUUtilizationPercentage:</span> <span class=\"number\">80</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">nodeSelector:</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">tolerations:</span> []</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">affinity:</span> &#123;&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><ul>\n<li>ACR  <a href=\"#ht9xj\">Helm</a> </li>\n</ul>\n<img data-src=\"/posts/ce0f/helm2.png\" class>\n\n<ul>\n<li><ul>\n<li><p></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm install app-test aliyun-acr-repo/app-test --version 20211228100329-daily --namespace daily-apps</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n</li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/ce0f/helm3.png\" class>\n<img data-src=\"/posts/ce0f/helm4.png\" class>\n\n<ul>\n<li><img data-src=\"/posts/ce0f/helm5.png\" class></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>helm Kubernetes API Server EIP</p>\n</li>\n<li><p>AlicloudEdas </p>\n<ul>\n<li>helm Edas helm Edas </li>\n<li>Edas Deployment <a href=\"https://help.aliyun.com/document_detail/202036.html\">https://help.aliyun.com/document_detail&#x2F;202036.html</a>Edas Edas </li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>helm values  image-&gt;repository pull  helm push pull </li>\n<li>helm upgrade rollback </li>\n</ul>\n</li>\n<li><p>CI&#x2F;CD </p>\n<ul>\n<li>helm  CI&#x2F;CD </li>\n</ul>\n</li>\n</ul>"},{"title":"Kubernetes & ACK ","abbrlink":"754e","date":"2022-05-31T15:04:28.000Z","_content":"### ACK\n[https://help.aliyun.com/document_detail/86500.html](https://help.aliyun.com/document_detail/86500.html)\n\n### RBAC\n[https://yuque.antfin.com/kifo8h/nee5aa/mvx5t5](https://yuque.antfin.com/kifo8h/nee5aa/mvx5t5)\n\n### \n#### CNI\n[https://help.aliyun.com/document_detail/195424.html](https://help.aliyun.com/document_detail/195424.html)\n\n<!--more-->\n\n#### Service\n\n- **ClusterIP**IP ServiceType\n\n- **NodePort**NodeIPNodePortNodePortClusterIPNodePort\n\n- **LoadBalancer**NodePortClusterIP\n\n- **Headless Service**ServiceclusterIPNoneHeadless ServiceServiceIPServiceDNSPodIPDNS\n\n- **ExternalName**ServiceServiceService\n\n> ****\n> - CIDRMasterNode ECSIP172.16.0.0/16 \n> - Pod CIDR10.16.0.0/12\n> - Service CIDR10.32.0.0/16\n> \n> **Service**\n> - ClusterIP10.32.230.55\n> - reos-app-file-base-svc:80 TCP\n> \n**Pod **\n> - IP10.16.1.4110.16.3.227\n> - 8080\n> \n**NodePortNodeClusterIP**\n> - NodeIP172.16.9.150172.16.9.64\n> - 3015230144\n> \n**LoadBanlancer **\n> - IP112.124.13.114\n> - 112.124.13.114:80\n> \n> ****\n> 1.  ServiceIP10.32.230.55:80  reos-app-file-base-svc:80Coredns\n> 1.  PodIP10.16.1.41:8080  10.16.3.227:8080\n> 1.  NodeIP172.16.9.150:30152  172.16.9.64:30144\n> 1.  SLB IP112.124.13.114:80  local --> Cluster\n> \n> **kubectl get endpoints/xxxxx -owide**\n{% asset_img k8s1.png %}\n\n\n#### Ingress Service 7\n /static/  /apis/  URL  Ingress \n{% asset_img k8s2.png %}\n\n#### CorednsDNS\n\n   -  Service  ClusterIP\n   -  StatefulSet  Pod  Pod  IP\n\n#### \n\n- Alicloud[VPC](https://help.aliyun.com/product/27706.html)[SLB](https://help.aliyun.com/product/27537.html)\n- [Terway  Flannel](https://help.aliyun.com/document_detail/97467.html)\n\n### \n{% asset_img k8s3.png %}\n#### CSI-Plugin \n\n- \n- \n- NAS \n- OSS \n- CPFS \n- \n- &\n\n#### FlexVolume \n\n- \n- NAS \n- OSS \n- CPFS \n- \n\n### \n#### \n\n-  Deployment\n-  StatefulSet\n   - Pod hostname\n-  DaemenSet\n   - \n   - \n-  Job\n   -  Pod \n   - JobJobJob\n-  CronJob\n   - \n- \n   - Poddocker \n- \n   -  Kubernetes API\n   - API \n\n#### ACR\n\n- kritis-validation-hook\n- aliyun-acr-credential-helper \n\n####  Configmap  Secret\n\n- \n   - /YAML  Configmap \n   - Pod \n- \n   - /YAML Secret \n   - Pod \n\n#### \n\n- Pod ****nodeSelector Pod Pod YAML  spec --> nodeSelector --> gourp \n- Descheduler Pod \n   - PodPod ReplicaSetReplication ControllerStatefulSetJob \n   - Pod Pod\n   - Pod \n   - Pod\n- URLURL curl \n- Helm \n   - ChartHelmAPT dpkg YUM rpm \n   - ReleaseChart Chart releaseMySQL Chart release \n   - Repository Chart \n   - Helm Helm CLI Tiller Repository HTTP\n- /YAML \n\n#### AHAS\n[https://help.aliyun.com/document_detail/193575.html](https://help.aliyun.com/document_detail/193575.html)\n\n\n### \n#### \n\n- \n   - Kube API Server\n   - Kube Controller Manager\n   - Cloud Controller ManagerAlicloud CLBVPC\n#### \n\n- \n   - appcenter\n   - progressive-delivery-tool\n#### \n\n- \n   - alicloud-monitor-controllerACK\n   - metrics-serverACKMetrics APIHPA\n- \n   - ack-node-problem-detectorACK\n   - ags-metrics-collector\n   - ack-arms-prometheusARMS Prometheus\n   - logtail-dsKubernetes\n   - logtail-windowsACKAlicloudSLSWindows\n#### \n\n- \n   - csi-pluginCSIAlicloud\n   - csi-provisionerCSIAlicloud\n   - storage-operator\n   - alicloud-disk-controller\n   - FlexvolumeFlexvolumeFlexvolumeAlicloud\n\n#### \n\n- \n   - CoreDNSACKDNSKubernetes DNS-Based Service Discovery\n   - Nginx Ingress ControllerNginx Ingress ControllerIngressIngress ControllerIngressService\n   - managed-kube-proxy-windowsACKkube-proxyWindowsServicePodServiceService\n- \n   - Terway :  AlicloudVPCCNIKubernetesNetworkPolicyTerway\n   - FlannelCNIAlicloudFlannelAlicloudVPCFlannel\n   - ACK NodeLocal DNSCacheNodeLocal DNSCacheDNS\n   - kube-flannel-ds-windowsACKWindowsL2Bridge\n\n{% asset_img k8s4.png %}\n\n#### [](https://help.aliyun.com/document_detail/277412.html#title-nq4-jps-k41)\n#### [](https://help.aliyun.com/document_detail/277412.html#title-iib-fx3-2hl)\n\n### \n#### [Kubernetes  NetworkPolicy ](https://yuque.antfin.com/kifo8h/nee5aa/bzg9vq)\n\n- Pod  Pod \n\n1 PodsPod \n2 namespace\n3IP  Pod  Node  Pod  IP\n\n- Pod   NetworkPolicy \n- NetworkPolicy PodPod /\n-  Pod PodEgress Pod Ingress\n- ACK Terway  Flannel \n\n","source":"_posts/k8s-ack-learn.md","raw":"---\ntitle: Kubernetes & ACK \ncategories:\n  - CNCF\ntags:\n  - Kubernetes\n  - Alicloud\nabbrlink: 754e\ndate: 2022-05-31 23:04:28\n---\n### ACK\n[https://help.aliyun.com/document_detail/86500.html](https://help.aliyun.com/document_detail/86500.html)\n\n### RBAC\n[https://yuque.antfin.com/kifo8h/nee5aa/mvx5t5](https://yuque.antfin.com/kifo8h/nee5aa/mvx5t5)\n\n### \n#### CNI\n[https://help.aliyun.com/document_detail/195424.html](https://help.aliyun.com/document_detail/195424.html)\n\n<!--more-->\n\n#### Service\n\n- **ClusterIP**IP ServiceType\n\n- **NodePort**NodeIPNodePortNodePortClusterIPNodePort\n\n- **LoadBalancer**NodePortClusterIP\n\n- **Headless Service**ServiceclusterIPNoneHeadless ServiceServiceIPServiceDNSPodIPDNS\n\n- **ExternalName**ServiceServiceService\n\n> ****\n> - CIDRMasterNode ECSIP172.16.0.0/16 \n> - Pod CIDR10.16.0.0/12\n> - Service CIDR10.32.0.0/16\n> \n> **Service**\n> - ClusterIP10.32.230.55\n> - reos-app-file-base-svc:80 TCP\n> \n**Pod **\n> - IP10.16.1.4110.16.3.227\n> - 8080\n> \n**NodePortNodeClusterIP**\n> - NodeIP172.16.9.150172.16.9.64\n> - 3015230144\n> \n**LoadBanlancer **\n> - IP112.124.13.114\n> - 112.124.13.114:80\n> \n> ****\n> 1.  ServiceIP10.32.230.55:80  reos-app-file-base-svc:80Coredns\n> 1.  PodIP10.16.1.41:8080  10.16.3.227:8080\n> 1.  NodeIP172.16.9.150:30152  172.16.9.64:30144\n> 1.  SLB IP112.124.13.114:80  local --> Cluster\n> \n> **kubectl get endpoints/xxxxx -owide**\n{% asset_img k8s1.png %}\n\n\n#### Ingress Service 7\n /static/  /apis/  URL  Ingress \n{% asset_img k8s2.png %}\n\n#### CorednsDNS\n\n   -  Service  ClusterIP\n   -  StatefulSet  Pod  Pod  IP\n\n#### \n\n- Alicloud[VPC](https://help.aliyun.com/product/27706.html)[SLB](https://help.aliyun.com/product/27537.html)\n- [Terway  Flannel](https://help.aliyun.com/document_detail/97467.html)\n\n### \n{% asset_img k8s3.png %}\n#### CSI-Plugin \n\n- \n- \n- NAS \n- OSS \n- CPFS \n- \n- &\n\n#### FlexVolume \n\n- \n- NAS \n- OSS \n- CPFS \n- \n\n### \n#### \n\n-  Deployment\n-  StatefulSet\n   - Pod hostname\n-  DaemenSet\n   - \n   - \n-  Job\n   -  Pod \n   - JobJobJob\n-  CronJob\n   - \n- \n   - Poddocker \n- \n   -  Kubernetes API\n   - API \n\n#### ACR\n\n- kritis-validation-hook\n- aliyun-acr-credential-helper \n\n####  Configmap  Secret\n\n- \n   - /YAML  Configmap \n   - Pod \n- \n   - /YAML Secret \n   - Pod \n\n#### \n\n- Pod ****nodeSelector Pod Pod YAML  spec --> nodeSelector --> gourp \n- Descheduler Pod \n   - PodPod ReplicaSetReplication ControllerStatefulSetJob \n   - Pod Pod\n   - Pod \n   - Pod\n- URLURL curl \n- Helm \n   - ChartHelmAPT dpkg YUM rpm \n   - ReleaseChart Chart releaseMySQL Chart release \n   - Repository Chart \n   - Helm Helm CLI Tiller Repository HTTP\n- /YAML \n\n#### AHAS\n[https://help.aliyun.com/document_detail/193575.html](https://help.aliyun.com/document_detail/193575.html)\n\n\n### \n#### \n\n- \n   - Kube API Server\n   - Kube Controller Manager\n   - Cloud Controller ManagerAlicloud CLBVPC\n#### \n\n- \n   - appcenter\n   - progressive-delivery-tool\n#### \n\n- \n   - alicloud-monitor-controllerACK\n   - metrics-serverACKMetrics APIHPA\n- \n   - ack-node-problem-detectorACK\n   - ags-metrics-collector\n   - ack-arms-prometheusARMS Prometheus\n   - logtail-dsKubernetes\n   - logtail-windowsACKAlicloudSLSWindows\n#### \n\n- \n   - csi-pluginCSIAlicloud\n   - csi-provisionerCSIAlicloud\n   - storage-operator\n   - alicloud-disk-controller\n   - FlexvolumeFlexvolumeFlexvolumeAlicloud\n\n#### \n\n- \n   - CoreDNSACKDNSKubernetes DNS-Based Service Discovery\n   - Nginx Ingress ControllerNginx Ingress ControllerIngressIngress ControllerIngressService\n   - managed-kube-proxy-windowsACKkube-proxyWindowsServicePodServiceService\n- \n   - Terway :  AlicloudVPCCNIKubernetesNetworkPolicyTerway\n   - FlannelCNIAlicloudFlannelAlicloudVPCFlannel\n   - ACK NodeLocal DNSCacheNodeLocal DNSCacheDNS\n   - kube-flannel-ds-windowsACKWindowsL2Bridge\n\n{% asset_img k8s4.png %}\n\n#### [](https://help.aliyun.com/document_detail/277412.html#title-nq4-jps-k41)\n#### [](https://help.aliyun.com/document_detail/277412.html#title-iib-fx3-2hl)\n\n### \n#### [Kubernetes  NetworkPolicy ](https://yuque.antfin.com/kifo8h/nee5aa/bzg9vq)\n\n- Pod  Pod \n\n1 PodsPod \n2 namespace\n3IP  Pod  Node  Pod  IP\n\n- Pod   NetworkPolicy \n- NetworkPolicy PodPod /\n-  Pod PodEgress Pod Ingress\n- ACK Terway  Flannel \n\n","slug":"k8s-ack-learn","published":1,"updated":"2024-01-21T15:28:43.153Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zm000ms0njbhzpcuxw","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"ACK\"><a href=\"#ACK\" class=\"headerlink\" title=\"ACK\"></a>ACK</h3><p><a href=\"https://help.aliyun.com/document_detail/86500.html\">https://help.aliyun.com/document_detail&#x2F;86500.html</a></p>\n<h3 id=\"RBAC\"><a href=\"#RBAC\" class=\"headerlink\" title=\"RBAC\"></a>RBAC</h3><p><a href=\"https://yuque.antfin.com/kifo8h/nee5aa/mvx5t5\">https://yuque.antfin.com/kifo8h/nee5aa/mvx5t5</a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"CNI\"><a href=\"#CNI\" class=\"headerlink\" title=\"CNI\"></a>CNI</h4><p><a href=\"https://help.aliyun.com/document_detail/195424.html\">https://help.aliyun.com/document_detail&#x2F;195424.html</a></p>\n<span id=\"more\"></span>\n\n<h4 id=\"Service\"><a href=\"#Service\" class=\"headerlink\" title=\"Service\"></a>Service</h4><ul>\n<li><p><strong>ClusterIP</strong>IP ServiceType</p>\n</li>\n<li><p><strong>NodePort</strong>NodeIPNodePortNodePortClusterIPNodePort</p>\n</li>\n<li><p><strong>LoadBalancer</strong>NodePortClusterIP</p>\n</li>\n<li><p><strong>Headless Service</strong>ServiceclusterIPNoneHeadless ServiceServiceIPServiceDNSPodIPDNS</p>\n</li>\n<li><p><strong>ExternalName</strong>ServiceServiceService</p>\n</li>\n</ul>\n<blockquote>\n<p><strong></strong></p>\n<ul>\n<li>CIDRMasterNode ECSIP172.16.0.0&#x2F;16 </li>\n<li>Pod CIDR10.16.0.0&#x2F;12</li>\n<li>Service CIDR10.32.0.0&#x2F;16</li>\n</ul>\n<p><strong>Service</strong></p>\n<ul>\n<li>ClusterIP10.32.230.55</li>\n<li>reos-app-file-base-svc:80 TCP</li>\n</ul>\n</blockquote>\n<p><strong>Pod </strong></p>\n<blockquote>\n<ul>\n<li>IP10.16.1.4110.16.3.227</li>\n<li>8080</li>\n</ul>\n</blockquote>\n<p><strong>NodePortNodeClusterIP</strong></p>\n<blockquote>\n<ul>\n<li>NodeIP172.16.9.150172.16.9.64</li>\n<li>3015230144</li>\n</ul>\n</blockquote>\n<p><strong>LoadBanlancer </strong></p>\n<blockquote>\n<ul>\n<li>IP112.124.13.114</li>\n<li>112.124.13.114:80</li>\n</ul>\n<p><strong></strong></p>\n<ol>\n<li> ServiceIP10.32.230.55:80  reos-app-file-base-svc:80Coredns</li>\n<li> PodIP10.16.1.41:8080  10.16.3.227:8080</li>\n<li> NodeIP172.16.9.150:30152  172.16.9.64:30144</li>\n<li> SLB IP112.124.13.114:80  local &gt; Cluster</li>\n</ol>\n<p><strong>kubectl get endpoints&#x2F;xxxxx -owide</strong></p>\n</blockquote>\n<img data-src=\"/posts/754e/k8s1.png\" class>\n\n\n<h4 id=\"Ingress-Service-7\"><a href=\"#Ingress-Service-7\" class=\"headerlink\" title=\"Ingress Service 7\"></a>Ingress Service 7</h4><p> &#x2F;static&#x2F;  &#x2F;apis&#x2F;  URL  Ingress </p>\n<img data-src=\"/posts/754e/k8s2.png\" class>\n\n<h4 id=\"CorednsDNS\"><a href=\"#CorednsDNS\" class=\"headerlink\" title=\"CorednsDNS\"></a>CorednsDNS</h4><ul>\n<li> Service  ClusterIP</li>\n<li> StatefulSet  Pod  Pod  IP</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>Alicloud<a href=\"https://help.aliyun.com/product/27706.html\">VPC</a><a href=\"https://help.aliyun.com/product/27537.html\">SLB</a></li>\n<li><a href=\"https://help.aliyun.com/document_detail/97467.html\">Terway  Flannel</a></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><img data-src=\"/posts/754e/k8s3.png\" class>\n<h4 id=\"CSI-Plugin-\"><a href=\"#CSI-Plugin-\" class=\"headerlink\" title=\"CSI-Plugin \"></a>CSI-Plugin </h4><ul>\n<li></li>\n<li></li>\n<li>NAS </li>\n<li>OSS </li>\n<li>CPFS </li>\n<li></li>\n<li>&amp;</li>\n</ul>\n<h4 id=\"FlexVolume-\"><a href=\"#FlexVolume-\" class=\"headerlink\" title=\"FlexVolume \"></a>FlexVolume </h4><ul>\n<li></li>\n<li>NAS </li>\n<li>OSS </li>\n<li>CPFS </li>\n<li></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li> Deployment</li>\n<li> StatefulSet<ul>\n<li>Pod hostname</li>\n</ul>\n</li>\n<li> DaemenSet<ul>\n<li></li>\n<li></li>\n</ul>\n</li>\n<li> Job<ul>\n<li> Pod </li>\n<li>JobJobJob</li>\n</ul>\n</li>\n<li> CronJob<ul>\n<li></li>\n</ul>\n</li>\n<li><ul>\n<li>Poddocker </li>\n</ul>\n</li>\n<li><ul>\n<li> Kubernetes API</li>\n<li>API </li>\n</ul>\n</li>\n</ul>\n<h4 id=\"ACR\"><a href=\"#ACR\" class=\"headerlink\" title=\"ACR\"></a>ACR</h4><ul>\n<li>kritis-validation-hook</li>\n<li>aliyun-acr-credential-helper</li>\n</ul>\n<h4 id=\"-Configmap--Secret\"><a href=\"#-Configmap--Secret\" class=\"headerlink\" title=\" Configmap  Secret\"></a> Configmap  Secret</h4><ul>\n<li><ul>\n<li>&#x2F;YAML  Configmap </li>\n<li>Pod </li>\n</ul>\n</li>\n<li><ul>\n<li>&#x2F;YAML Secret </li>\n<li>Pod </li>\n</ul>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>Pod <strong></strong>nodeSelector Pod Pod YAML  spec &gt; nodeSelector &gt; gourp </li>\n<li>Descheduler Pod <ul>\n<li>PodPod ReplicaSetReplication ControllerStatefulSetJob </li>\n<li>Pod Pod</li>\n<li>Pod </li>\n<li>Pod</li>\n</ul>\n</li>\n<li>URLURL curl </li>\n<li>Helm <ul>\n<li>ChartHelmAPT dpkg YUM rpm </li>\n<li>ReleaseChart Chart releaseMySQL Chart release </li>\n<li>Repository Chart </li>\n<li>Helm Helm CLI Tiller Repository HTTP</li>\n</ul>\n</li>\n<li>&#x2F;YAML </li>\n</ul>\n<h4 id=\"AHAS\"><a href=\"#AHAS\" class=\"headerlink\" title=\"AHAS\"></a>AHAS</h4><p><a href=\"https://help.aliyun.com/document_detail/193575.html\">https://help.aliyun.com/document_detail&#x2F;193575.html</a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><p></p>\n<ul>\n<li>Kube API Server</li>\n<li>Kube Controller Manager</li>\n<li>Cloud Controller ManagerAlicloud CLBVPC<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4></li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>appcenter</li>\n<li>progressive-delivery-tool<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4></li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>alicloud-monitor-controllerACK</li>\n<li>metrics-serverACKMetrics APIHPA</li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>ack-node-problem-detectorACK</li>\n<li>ags-metrics-collector</li>\n<li>ack-arms-prometheusARMS Prometheus</li>\n<li>logtail-dsKubernetes</li>\n<li>logtail-windowsACKAlicloudSLSWindows<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4></li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>csi-pluginCSIAlicloud</li>\n<li>csi-provisionerCSIAlicloud</li>\n<li>storage-operator</li>\n<li>alicloud-disk-controller</li>\n<li>FlexvolumeFlexvolumeFlexvolumeAlicloud</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><ul>\n<li>CoreDNSACKDNSKubernetes DNS-Based Service Discovery</li>\n<li>Nginx Ingress ControllerNginx Ingress ControllerIngressIngress ControllerIngressService</li>\n<li>managed-kube-proxy-windowsACKkube-proxyWindowsServicePodServiceService</li>\n</ul>\n</li>\n<li><ul>\n<li>Terway :  AlicloudVPCCNIKubernetesNetworkPolicyTerway</li>\n<li>FlannelCNIAlicloudFlannelAlicloudVPCFlannel</li>\n<li>ACK NodeLocal DNSCacheNodeLocal DNSCacheDNS</li>\n<li>kube-flannel-ds-windowsACKWindowsL2Bridge</li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/754e/k8s4.png\" class>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><a href=\"https://help.aliyun.com/document_detail/277412.html#title-nq4-jps-k41\"></a></h4><h4 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a><a href=\"https://help.aliyun.com/document_detail/277412.html#title-iib-fx3-2hl\"></a></h4><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"Kubernetes--NetworkPolicy-\"><a href=\"#Kubernetes--NetworkPolicy-\" class=\"headerlink\" title=\"Kubernetes  NetworkPolicy \"></a><a href=\"https://yuque.antfin.com/kifo8h/nee5aa/bzg9vq\">Kubernetes  NetworkPolicy </a></h4><ul>\n<li>Pod  Pod </li>\n</ul>\n<p>1 PodsPod <br>2 namespace<br>3IP  Pod  Node  Pod  IP</p>\n<ul>\n<li>Pod   NetworkPolicy </li>\n<li>NetworkPolicy PodPod &#x2F;</li>\n<li> Pod PodEgress Pod Ingress</li>\n<li>ACK Terway  Flannel </li>\n</ul>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":4901,"excerpt":"<h3 id=\"ACK\"><a href=\"#ACK\" class=\"headerlink\" title=\"ACK\"></a>ACK</h3><p><a href=\"https://help.aliyun.com/document_detail/86500.html\">https://help.aliyun.com/document_detail&#x2F;86500.html</a></p>\n<h3 id=\"RBAC\"><a href=\"#RBAC\" class=\"headerlink\" title=\"RBAC\"></a>RBAC</h3><p><a href=\"https://yuque.antfin.com/kifo8h/nee5aa/mvx5t5\">https://yuque.antfin.com/kifo8h/nee5aa/mvx5t5</a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"CNI\"><a href=\"#CNI\" class=\"headerlink\" title=\"CNI\"></a>CNI</h4><p><a href=\"https://help.aliyun.com/document_detail/195424.html\">https://help.aliyun.com/document_detail&#x2F;195424.html</a></p>","more":"<h4 id=\"Service\"><a href=\"#Service\" class=\"headerlink\" title=\"Service\"></a>Service</h4><ul>\n<li><p><strong>ClusterIP</strong>IP ServiceType</p>\n</li>\n<li><p><strong>NodePort</strong>NodeIPNodePortNodePortClusterIPNodePort</p>\n</li>\n<li><p><strong>LoadBalancer</strong>NodePortClusterIP</p>\n</li>\n<li><p><strong>Headless Service</strong>ServiceclusterIPNoneHeadless ServiceServiceIPServiceDNSPodIPDNS</p>\n</li>\n<li><p><strong>ExternalName</strong>ServiceServiceService</p>\n</li>\n</ul>\n<blockquote>\n<p><strong></strong></p>\n<ul>\n<li>CIDRMasterNode ECSIP172.16.0.0&#x2F;16 </li>\n<li>Pod CIDR10.16.0.0&#x2F;12</li>\n<li>Service CIDR10.32.0.0&#x2F;16</li>\n</ul>\n<p><strong>Service</strong></p>\n<ul>\n<li>ClusterIP10.32.230.55</li>\n<li>reos-app-file-base-svc:80 TCP</li>\n</ul>\n</blockquote>\n<p><strong>Pod </strong></p>\n<blockquote>\n<ul>\n<li>IP10.16.1.4110.16.3.227</li>\n<li>8080</li>\n</ul>\n</blockquote>\n<p><strong>NodePortNodeClusterIP</strong></p>\n<blockquote>\n<ul>\n<li>NodeIP172.16.9.150172.16.9.64</li>\n<li>3015230144</li>\n</ul>\n</blockquote>\n<p><strong>LoadBanlancer </strong></p>\n<blockquote>\n<ul>\n<li>IP112.124.13.114</li>\n<li>112.124.13.114:80</li>\n</ul>\n<p><strong></strong></p>\n<ol>\n<li> ServiceIP10.32.230.55:80  reos-app-file-base-svc:80Coredns</li>\n<li> PodIP10.16.1.41:8080  10.16.3.227:8080</li>\n<li> NodeIP172.16.9.150:30152  172.16.9.64:30144</li>\n<li> SLB IP112.124.13.114:80  local &gt; Cluster</li>\n</ol>\n<p><strong>kubectl get endpoints&#x2F;xxxxx -owide</strong></p>\n</blockquote>\n<img data-src=\"/posts/754e/k8s1.png\" class>\n\n\n<h4 id=\"Ingress-Service-7\"><a href=\"#Ingress-Service-7\" class=\"headerlink\" title=\"Ingress Service 7\"></a>Ingress Service 7</h4><p> &#x2F;static&#x2F;  &#x2F;apis&#x2F;  URL  Ingress </p>\n<img data-src=\"/posts/754e/k8s2.png\" class>\n\n<h4 id=\"CorednsDNS\"><a href=\"#CorednsDNS\" class=\"headerlink\" title=\"CorednsDNS\"></a>CorednsDNS</h4><ul>\n<li> Service  ClusterIP</li>\n<li> StatefulSet  Pod  Pod  IP</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>Alicloud<a href=\"https://help.aliyun.com/product/27706.html\">VPC</a><a href=\"https://help.aliyun.com/product/27537.html\">SLB</a></li>\n<li><a href=\"https://help.aliyun.com/document_detail/97467.html\">Terway  Flannel</a></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><img data-src=\"/posts/754e/k8s3.png\" class>\n<h4 id=\"CSI-Plugin-\"><a href=\"#CSI-Plugin-\" class=\"headerlink\" title=\"CSI-Plugin \"></a>CSI-Plugin </h4><ul>\n<li></li>\n<li></li>\n<li>NAS </li>\n<li>OSS </li>\n<li>CPFS </li>\n<li></li>\n<li>&amp;</li>\n</ul>\n<h4 id=\"FlexVolume-\"><a href=\"#FlexVolume-\" class=\"headerlink\" title=\"FlexVolume \"></a>FlexVolume </h4><ul>\n<li></li>\n<li>NAS </li>\n<li>OSS </li>\n<li>CPFS </li>\n<li></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li> Deployment</li>\n<li> StatefulSet<ul>\n<li>Pod hostname</li>\n</ul>\n</li>\n<li> DaemenSet<ul>\n<li></li>\n<li></li>\n</ul>\n</li>\n<li> Job<ul>\n<li> Pod </li>\n<li>JobJobJob</li>\n</ul>\n</li>\n<li> CronJob<ul>\n<li></li>\n</ul>\n</li>\n<li><ul>\n<li>Poddocker </li>\n</ul>\n</li>\n<li><ul>\n<li> Kubernetes API</li>\n<li>API </li>\n</ul>\n</li>\n</ul>\n<h4 id=\"ACR\"><a href=\"#ACR\" class=\"headerlink\" title=\"ACR\"></a>ACR</h4><ul>\n<li>kritis-validation-hook</li>\n<li>aliyun-acr-credential-helper</li>\n</ul>\n<h4 id=\"-Configmap--Secret\"><a href=\"#-Configmap--Secret\" class=\"headerlink\" title=\" Configmap  Secret\"></a> Configmap  Secret</h4><ul>\n<li><ul>\n<li>&#x2F;YAML  Configmap </li>\n<li>Pod </li>\n</ul>\n</li>\n<li><ul>\n<li>&#x2F;YAML Secret </li>\n<li>Pod </li>\n</ul>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>Pod <strong></strong>nodeSelector Pod Pod YAML  spec &gt; nodeSelector &gt; gourp </li>\n<li>Descheduler Pod <ul>\n<li>PodPod ReplicaSetReplication ControllerStatefulSetJob </li>\n<li>Pod Pod</li>\n<li>Pod </li>\n<li>Pod</li>\n</ul>\n</li>\n<li>URLURL curl </li>\n<li>Helm <ul>\n<li>ChartHelmAPT dpkg YUM rpm </li>\n<li>ReleaseChart Chart releaseMySQL Chart release </li>\n<li>Repository Chart </li>\n<li>Helm Helm CLI Tiller Repository HTTP</li>\n</ul>\n</li>\n<li>&#x2F;YAML </li>\n</ul>\n<h4 id=\"AHAS\"><a href=\"#AHAS\" class=\"headerlink\" title=\"AHAS\"></a>AHAS</h4><p><a href=\"https://help.aliyun.com/document_detail/193575.html\">https://help.aliyun.com/document_detail&#x2F;193575.html</a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><p></p>\n<ul>\n<li>Kube API Server</li>\n<li>Kube Controller Manager</li>\n<li>Cloud Controller ManagerAlicloud CLBVPC<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4></li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>appcenter</li>\n<li>progressive-delivery-tool<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4></li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>alicloud-monitor-controllerACK</li>\n<li>metrics-serverACKMetrics APIHPA</li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>ack-node-problem-detectorACK</li>\n<li>ags-metrics-collector</li>\n<li>ack-arms-prometheusARMS Prometheus</li>\n<li>logtail-dsKubernetes</li>\n<li>logtail-windowsACKAlicloudSLSWindows<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4></li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>csi-pluginCSIAlicloud</li>\n<li>csi-provisionerCSIAlicloud</li>\n<li>storage-operator</li>\n<li>alicloud-disk-controller</li>\n<li>FlexvolumeFlexvolumeFlexvolumeAlicloud</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><ul>\n<li>CoreDNSACKDNSKubernetes DNS-Based Service Discovery</li>\n<li>Nginx Ingress ControllerNginx Ingress ControllerIngressIngress ControllerIngressService</li>\n<li>managed-kube-proxy-windowsACKkube-proxyWindowsServicePodServiceService</li>\n</ul>\n</li>\n<li><ul>\n<li>Terway :  AlicloudVPCCNIKubernetesNetworkPolicyTerway</li>\n<li>FlannelCNIAlicloudFlannelAlicloudVPCFlannel</li>\n<li>ACK NodeLocal DNSCacheNodeLocal DNSCacheDNS</li>\n<li>kube-flannel-ds-windowsACKWindowsL2Bridge</li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/754e/k8s4.png\" class>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><a href=\"https://help.aliyun.com/document_detail/277412.html#title-nq4-jps-k41\"></a></h4><h4 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a><a href=\"https://help.aliyun.com/document_detail/277412.html#title-iib-fx3-2hl\"></a></h4><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"Kubernetes--NetworkPolicy-\"><a href=\"#Kubernetes--NetworkPolicy-\" class=\"headerlink\" title=\"Kubernetes  NetworkPolicy \"></a><a href=\"https://yuque.antfin.com/kifo8h/nee5aa/bzg9vq\">Kubernetes  NetworkPolicy </a></h4><ul>\n<li>Pod  Pod </li>\n</ul>\n<p>1 PodsPod <br>2 namespace<br>3IP  Pod  Node  Pod  IP</p>\n<ul>\n<li>Pod   NetworkPolicy </li>\n<li>NetworkPolicy PodPod &#x2F;</li>\n<li> Pod PodEgress Pod Ingress</li>\n<li>ACK Terway  Flannel </li>\n</ul>"},{"title":"NetworkPolicy ","abbrlink":"8aa0","date":"2022-03-07T14:01:06.000Z","_content":"### \n> ACK NetworkPolicy ACK \n#### 1ACK \n1. UAT/ ACK default namespace \n\n2. SLB namespace  + NetworkPolicy VPC NetworkPolicy IP \n\n#### 2\n1. namespace \n\n2. \n\n<!--more-->\n\n- SLB SLB \n- namespace VPC \n\n{% asset_img 7b70de99e5f7.png %}\n\n### \n#### 1CNI \nk8s  CNI CNICNI\n\n- PodIP\n- IP\n- Pod\n- Pod\n\nCNI CalicoFlannelTerwayWeave Net  Contiv\n\n\n#### 2TerwayFlannel\nACKTerwayFlannel\n\n- TerwayAlicloudACKTerwayAlicloudKubernetesTerwayIPAMNetwork PolicyFlannelTerway\n- FlannelFlannel CNIAlicloudVPCFlannelKubernetesNetwork Policy[Flannel](https://github.com/coreos/flannel)\n\n\n\n#### 3NetworkPolicy \n\n1.  CNIcontainer network interfaceAlicloudFlannelNetworkPolicyTerway\n2. ACK NetworkPolicy \n- Alicloud\n- kubectl \n   - Terway** NetworkPolicy** \n{% asset_img 2afdc3d69fa9.png %}\n\n   - ConfigMap --> eni-config \n{% asset_img 6bbe6aab7201.png %}\n\n\n3. \n- NetworkPolicy namespaceipBlockCIDRPods\n- NetworkPolicy Pod ingressegressiptables \n\n- \n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: test-network-policy\n  # namespace data\n  namespace: data\nspec:\n  # pod-\n  podSelector:\n    matchLabels:\n      role: \"data_centerevent\"\n      # role: \"\"  rolenamespacepod\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    #  172.17.0.0/16 172.17.1.0/24\n    - ipBlock:\n        cidr: 172.17.0.0/16\n        except:\n        - 172.17.1.0/24\n    # namespace\"project=apps_project\" namesapce Pod\n    - namespaceSelector:\n        matchLabels:\n          project: apps_project\n    # datanamespace\"role=apps\" Pod\n    - podSelector:\n        matchLabels:\n          role: apps\n    ports:\n    - protocol: TCP\n      port: 8080\n  egress:\n  # datanamespace\"role=data_centerevent\"PodCIDR\n  - to:\n    - ipBlock:\n        cidr: 10.0.0.0/24\n    ports:\n    - protocol: TCP\n      port: 6379\n```\n\n\n### \n#### \n\n- ACK CNI CNI \n- AlicloudACK CNI FlannelTerwayAlicloudACK Terway NetworkPolicy\n-  Terway \n\n\n#### \n\n- \n   - \n   - / SLB/IP \n\n\n#### \n1. Kubernetes [https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/](https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/)\n2. Alicloud[https://help.aliyun.com/document_detail/97621.html](https://help.aliyun.com/document_detail/97621.html)\n3. NetworkPolicy CNI [https://www.qikqiak.com/k8strain/network/networkpolicy/](https://www.qikqiak.com/k8strain/network/networkpolicy/)\n4. AlicloudTerway [https://help.aliyun.com/document_detail/86500.html](https://help.aliyun.com/document_detail/86500.html)\n","source":"_posts/k8s-networkpolicy.md","raw":"---\ntitle: NetworkPolicy \nabbrlink: 8aa0\ndate: 2022-03-07 22:01:06\ncategories:\n  - Alicloud\n  - CNCF\ntags:\n  - Kubernetes\n---\n### \n> ACK NetworkPolicy ACK \n#### 1ACK \n1. UAT/ ACK default namespace \n\n2. SLB namespace  + NetworkPolicy VPC NetworkPolicy IP \n\n#### 2\n1. namespace \n\n2. \n\n<!--more-->\n\n- SLB SLB \n- namespace VPC \n\n{% asset_img 7b70de99e5f7.png %}\n\n### \n#### 1CNI \nk8s  CNI CNICNI\n\n- PodIP\n- IP\n- Pod\n- Pod\n\nCNI CalicoFlannelTerwayWeave Net  Contiv\n\n\n#### 2TerwayFlannel\nACKTerwayFlannel\n\n- TerwayAlicloudACKTerwayAlicloudKubernetesTerwayIPAMNetwork PolicyFlannelTerway\n- FlannelFlannel CNIAlicloudVPCFlannelKubernetesNetwork Policy[Flannel](https://github.com/coreos/flannel)\n\n\n\n#### 3NetworkPolicy \n\n1.  CNIcontainer network interfaceAlicloudFlannelNetworkPolicyTerway\n2. ACK NetworkPolicy \n- Alicloud\n- kubectl \n   - Terway** NetworkPolicy** \n{% asset_img 2afdc3d69fa9.png %}\n\n   - ConfigMap --> eni-config \n{% asset_img 6bbe6aab7201.png %}\n\n\n3. \n- NetworkPolicy namespaceipBlockCIDRPods\n- NetworkPolicy Pod ingressegressiptables \n\n- \n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: test-network-policy\n  # namespace data\n  namespace: data\nspec:\n  # pod-\n  podSelector:\n    matchLabels:\n      role: \"data_centerevent\"\n      # role: \"\"  rolenamespacepod\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    #  172.17.0.0/16 172.17.1.0/24\n    - ipBlock:\n        cidr: 172.17.0.0/16\n        except:\n        - 172.17.1.0/24\n    # namespace\"project=apps_project\" namesapce Pod\n    - namespaceSelector:\n        matchLabels:\n          project: apps_project\n    # datanamespace\"role=apps\" Pod\n    - podSelector:\n        matchLabels:\n          role: apps\n    ports:\n    - protocol: TCP\n      port: 8080\n  egress:\n  # datanamespace\"role=data_centerevent\"PodCIDR\n  - to:\n    - ipBlock:\n        cidr: 10.0.0.0/24\n    ports:\n    - protocol: TCP\n      port: 6379\n```\n\n\n### \n#### \n\n- ACK CNI CNI \n- AlicloudACK CNI FlannelTerwayAlicloudACK Terway NetworkPolicy\n-  Terway \n\n\n#### \n\n- \n   - \n   - / SLB/IP \n\n\n#### \n1. Kubernetes [https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/](https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/)\n2. Alicloud[https://help.aliyun.com/document_detail/97621.html](https://help.aliyun.com/document_detail/97621.html)\n3. NetworkPolicy CNI [https://www.qikqiak.com/k8strain/network/networkpolicy/](https://www.qikqiak.com/k8strain/network/networkpolicy/)\n4. AlicloudTerway [https://help.aliyun.com/document_detail/86500.html](https://help.aliyun.com/document_detail/86500.html)\n","slug":"k8s-networkpolicy","published":1,"updated":"2024-01-21T15:30:00.082Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zn000qs0nj1nkr7p0e","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>ACK NetworkPolicy ACK </p>\n</blockquote>\n<h4 id=\"1ACK-\"><a href=\"#1ACK-\" class=\"headerlink\" title=\"1ACK \"></a>1ACK </h4><ol>\n<li><p>UAT&#x2F; ACK default namespace </p>\n</li>\n<li><p>SLB namespace  + NetworkPolicy VPC NetworkPolicy IP </p>\n</li>\n</ol>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><ol>\n<li><p>namespace </p>\n</li>\n<li><p></p>\n</li>\n</ol>\n<span id=\"more\"></span>\n<p></p>\n<ul>\n<li>SLB SLB </li>\n<li>namespace VPC </li>\n</ul>\n<img data-src=\"/posts/8aa0/7b70de99e5f7.png\" class>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1CNI-\"><a href=\"#1CNI-\" class=\"headerlink\" title=\"1CNI \"></a>1CNI </h4><p>k8s  CNI CNICNI</p>\n<ul>\n<li>PodIP</li>\n<li>IP</li>\n<li>Pod</li>\n<li>Pod</li>\n</ul>\n<p>CNI CalicoFlannelTerwayWeave Net  Contiv</p>\n<h4 id=\"2TerwayFlannel\"><a href=\"#2TerwayFlannel\" class=\"headerlink\" title=\"2TerwayFlannel\"></a>2TerwayFlannel</h4><p>ACKTerwayFlannel</p>\n<ul>\n<li>TerwayAlicloudACKTerwayAlicloudKubernetesTerwayIPAMNetwork PolicyFlannelTerway</li>\n<li>FlannelFlannel CNIAlicloudVPCFlannelKubernetesNetwork Policy<a href=\"https://github.com/coreos/flannel\">Flannel</a></li>\n</ul>\n<h4 id=\"3NetworkPolicy-\"><a href=\"#3NetworkPolicy-\" class=\"headerlink\" title=\"3NetworkPolicy \"></a>3NetworkPolicy </h4><ol>\n<li> CNIcontainer network interfaceAlicloudFlannelNetworkPolicyTerway</li>\n<li>ACK NetworkPolicy </li>\n</ol>\n<ul>\n<li>Alicloud</li>\n<li>kubectl <ul>\n<li><p>Terway** NetworkPolicy** </p>\n<img data-src=\"/posts/8aa0/2afdc3d69fa9.png\" class>\n</li>\n<li><p>ConfigMap &gt; eni-config </p>\n</li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/8aa0/6bbe6aab7201.png\" class>\n\n\n<ol start=\"3\">\n<li></li>\n</ol>\n<ul>\n<li><p>NetworkPolicy namespaceipBlockCIDRPods</p>\n</li>\n<li><p>NetworkPolicy Pod ingressegressiptables </p>\n</li>\n<li><p></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">test-network-policy</span></span><br><span class=\"line\">  <span class=\"comment\"># namespace data</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"comment\"># pod-</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">role:</span> <span class=\"string\">&quot;data_centerevent&quot;</span></span><br><span class=\"line\">      <span class=\"comment\"># role: &quot;&quot;  rolenamespacepod</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">from:</span></span><br><span class=\"line\">    <span class=\"comment\">#  172.17.0.0/16 172.17.1.0/24</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">172.17</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/16</span></span><br><span class=\"line\">        <span class=\"attr\">except:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"number\">172.17</span><span class=\"number\">.1</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"comment\"># namespace&quot;project=apps_project&quot; namesapce Pod</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">namespaceSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">project:</span> <span class=\"string\">apps_project</span></span><br><span class=\"line\">    <span class=\"comment\"># datanamespace&quot;role=apps&quot; Pod</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">role:</span> <span class=\"string\">apps</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">  <span class=\"attr\">egress:</span></span><br><span class=\"line\">  <span class=\"comment\"># datanamespace&quot;role=data_centerevent&quot;PodCIDR</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">to:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">10.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">6379</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>ACK CNI CNI </li>\n<li>AlicloudACK CNI FlannelTerwayAlicloudACK Terway NetworkPolicy</li>\n<li> Terway </li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><ul>\n<li></li>\n<li>&#x2F; SLB&#x2F;IP </li>\n</ul>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ol>\n<li>Kubernetes <a href=\"https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/\">https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/</a></li>\n<li>Alicloud<a href=\"https://help.aliyun.com/document_detail/97621.html\">https://help.aliyun.com/document_detail&#x2F;97621.html</a></li>\n<li>NetworkPolicy CNI <a href=\"https://www.qikqiak.com/k8strain/network/networkpolicy/\">https://www.qikqiak.com/k8strain/network/networkpolicy/</a></li>\n<li>AlicloudTerway <a href=\"https://help.aliyun.com/document_detail/86500.html\">https://help.aliyun.com/document_detail&#x2F;86500.html</a></li>\n</ol>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":3106,"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>ACK NetworkPolicy ACK </p>\n</blockquote>\n<h4 id=\"1ACK-\"><a href=\"#1ACK-\" class=\"headerlink\" title=\"1ACK \"></a>1ACK </h4><ol>\n<li><p>UAT&#x2F; ACK default namespace </p>\n</li>\n<li><p>SLB namespace  + NetworkPolicy VPC NetworkPolicy IP </p>\n</li>\n</ol>\n<h4 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h4><ol>\n<li><p>namespace </p>\n</li>\n<li><p></p>\n</li>\n</ol>","more":"<p></p>\n<ul>\n<li>SLB SLB </li>\n<li>namespace VPC </li>\n</ul>\n<img data-src=\"/posts/8aa0/7b70de99e5f7.png\" class>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1CNI-\"><a href=\"#1CNI-\" class=\"headerlink\" title=\"1CNI \"></a>1CNI </h4><p>k8s  CNI CNICNI</p>\n<ul>\n<li>PodIP</li>\n<li>IP</li>\n<li>Pod</li>\n<li>Pod</li>\n</ul>\n<p>CNI CalicoFlannelTerwayWeave Net  Contiv</p>\n<h4 id=\"2TerwayFlannel\"><a href=\"#2TerwayFlannel\" class=\"headerlink\" title=\"2TerwayFlannel\"></a>2TerwayFlannel</h4><p>ACKTerwayFlannel</p>\n<ul>\n<li>TerwayAlicloudACKTerwayAlicloudKubernetesTerwayIPAMNetwork PolicyFlannelTerway</li>\n<li>FlannelFlannel CNIAlicloudVPCFlannelKubernetesNetwork Policy<a href=\"https://github.com/coreos/flannel\">Flannel</a></li>\n</ul>\n<h4 id=\"3NetworkPolicy-\"><a href=\"#3NetworkPolicy-\" class=\"headerlink\" title=\"3NetworkPolicy \"></a>3NetworkPolicy </h4><ol>\n<li> CNIcontainer network interfaceAlicloudFlannelNetworkPolicyTerway</li>\n<li>ACK NetworkPolicy </li>\n</ol>\n<ul>\n<li>Alicloud</li>\n<li>kubectl <ul>\n<li><p>Terway** NetworkPolicy** </p>\n<img data-src=\"/posts/8aa0/2afdc3d69fa9.png\" class>\n</li>\n<li><p>ConfigMap &gt; eni-config </p>\n</li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/8aa0/6bbe6aab7201.png\" class>\n\n\n<ol start=\"3\">\n<li></li>\n</ol>\n<ul>\n<li><p>NetworkPolicy namespaceipBlockCIDRPods</p>\n</li>\n<li><p>NetworkPolicy Pod ingressegressiptables </p>\n</li>\n<li><p></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">test-network-policy</span></span><br><span class=\"line\">  <span class=\"comment\"># namespace data</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">data</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"comment\"># pod-</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">role:</span> <span class=\"string\">&quot;data_centerevent&quot;</span></span><br><span class=\"line\">      <span class=\"comment\"># role: &quot;&quot;  rolenamespacepod</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">from:</span></span><br><span class=\"line\">    <span class=\"comment\">#  172.17.0.0/16 172.17.1.0/24</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">172.17</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/16</span></span><br><span class=\"line\">        <span class=\"attr\">except:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"number\">172.17</span><span class=\"number\">.1</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"comment\"># namespace&quot;project=apps_project&quot; namesapce Pod</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">namespaceSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">project:</span> <span class=\"string\">apps_project</span></span><br><span class=\"line\">    <span class=\"comment\"># datanamespace&quot;role=apps&quot; Pod</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">role:</span> <span class=\"string\">apps</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">  <span class=\"attr\">egress:</span></span><br><span class=\"line\">  <span class=\"comment\"># datanamespace&quot;role=data_centerevent&quot;PodCIDR</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">to:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">ipBlock:</span></span><br><span class=\"line\">        <span class=\"attr\">cidr:</span> <span class=\"number\">10.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/24</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">6379</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>ACK CNI CNI </li>\n<li>AlicloudACK CNI FlannelTerwayAlicloudACK Terway NetworkPolicy</li>\n<li> Terway </li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><ul>\n<li></li>\n<li>&#x2F; SLB&#x2F;IP </li>\n</ul>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ol>\n<li>Kubernetes <a href=\"https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/\">https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/</a></li>\n<li>Alicloud<a href=\"https://help.aliyun.com/document_detail/97621.html\">https://help.aliyun.com/document_detail&#x2F;97621.html</a></li>\n<li>NetworkPolicy CNI <a href=\"https://www.qikqiak.com/k8strain/network/networkpolicy/\">https://www.qikqiak.com/k8strain/network/networkpolicy/</a></li>\n<li>AlicloudTerway <a href=\"https://help.aliyun.com/document_detail/86500.html\">https://help.aliyun.com/document_detail&#x2F;86500.html</a></li>\n</ol>"},{"title":"Kubernetes-","abbrlink":"5d90","date":"2023-02-08T15:20:49.000Z","_content":"### \n#### 1\n\n- Linux Network Namespace\n   - linux network interface deviceloopback devicebridge deviceveth devicetun/tap devicevxlan deviceip tunnel device \n   - linux  ip arp  ip  mac fdb mac  mac  \n   - linux  ethernet  ip icmp tcp/udp \n   - linux iptable netfilter  linux  firewall  ingress  engressnat \n<!--more-->\n\n{% asset_img k8s-nw1.png %}\n> linux  network namespace  pid namespace user namespace mount namespace ipc namespace uts namespace \n>  cgroup  cpumemoryio \n\n- Linux Bridge Device\n\nlinux  attach  linux linux bridgeiplinuxattachbridgeip()bridgeattachbridge\n{% asset_img k8s-nw2.png %}\n\n- Linux Veth Device\n\n peer  peer  peerveth pair  network namespace\n{% asset_img k8s-nw3.png %}\n\n#### 2k8s \n\n- \n\nkube-proxy --proxy-module=ipvs\niptables\nipvsv1.11 \n\n- \n\nunderlayflannel host-gwcalico bgp  ip_forword \noverlayflannel vxlancalico ipipflannel udp \n\n#### 3\n|  IP |  |  CIDR | CNI  | Flannel.1 vtep  |\n| --- | --- | --- | --- | --- |\n| 192.168.205.4 | master | 10.42.0.0/24 | 10.42.0.1 | 10.42.0.0\n| 192.168.205.3 | node1 | 10.42.1.0/24 | 10.42.1.1 | 10.42.1.0\n| 192.168.205.5 | node2 | 10.42.2.0/24 | 10.42.2.1 | 10.42.2.0\n\n\n### \n#### 1docker \n\n- bridge --net=bridge\n\n docker0  IP  IP\n> {% asset_img k8s-nw4.png %}\n>  bridge  network namespace \n> {% asset_img k8s-nw5.png %}\n\n\n- host --net=host\n\n\n{% asset_img k8s-nw6.png %}\n\n- contaniner --net=container:name or id\n\n Network namespacek8s  pod  network namespace  lo \n{% asset_img k8s-nw7.png %}\n\n- none  Network namespace  CPU \n\n#### 2docker \n\n- containernetwork namespacecontainerarpiptablecontainernetwork namespace\n- default netwok nemespacelinux bridgedocker0\n- containerveth paircontainernetwork namespaceattachnetworkwork namespacedocker0 linux bridge\n- (docker0 bridge)containercontainer\n\n{% asset_img k8s-nw8.png %}\n\n```shell\n## \n# bridge \n#k8s pod  infrastructure  network namespace  veth pair\nbrctl show\n\n# veth pair \nip addr\nip -d link show\n\n#\nroute -n\n\n# docker \ndocker ps/inspect/container\n```\n\n### Servicecluster ip \n#### 1cluster ip \nk8s  service cluster ip cluster ip  endpoints pod  cluster ip  cluster ip  endpoints  iptables  ipvs\n\n#### 2iptables \n\n-  service cluster ip  endpoints ip\n```shell\n# kubectl describe service nginx-test\nName:              nginx-test\nNamespace:         default\nLabels:            app=nginx-test\nAnnotations:       <none>\nSelector:          app=nginx-test\nType:              ClusterIP\nIP Family Policy:  SingleStack\nIP Families:       IPv4\nIP:                10.43.6.58\nIPs:               10.43.6.58\nPort:              80-80  80/TCP\nTargetPort:        80/TCP\nEndpoints:         10.42.1.6:80,10.42.2.6:80\n```\n\n-  iptables \n```shell\n# iptables -nvL -t nat |head\nChain PREROUTING (policy ACCEPT 0 packets, 0 bytes)\npkts bytes target     prot opt in     out     source               destination\n298 19090 KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */\n202 12456 CNI-HOSTPORT-DNAT  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL\n```\n PREROUTING chain  KUBE-SERVICES  target  PREROUTING chain  pod  curl http://10.43.6.58\n\n   - podcluster ip(**10.43.6.58**)\n   - podipnetwok namespace **docker0  cni0** ip\n   - podeth0 deviceeth0veth pairpod network namespaceattachnetwok namespace **docker0  cni0** bridge\n   - veth pairpod network namespaceattached**docker0  cni0** bridge\n   - **docker0  cni0** bridgehost network namesapce  PREROUTING chain\n\n-  KUBE-SERVICES target\n```shell\n# iptables -nvL -t nat | grep 10.43.6.58\n0     0 KUBE-SVC-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80\n\n# iptables -nvL -t nat | grep KUBE-SVC-7CWUT4JBGBRVUN2L -A 5\nChain KUBE-SVC-7CWUT4JBGBRVUN2L (1 references)\npkts bytes target     prot opt in     out     source               destination\n0     0 KUBE-SEP-U2YYZT2C3O6VM4EV  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -> 10.42.1.6:80 */ statistic mode random probability 0.50000000000\n0     0 KUBE-SEP-GWUIQWA2TNZI4ESX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -> 10.42.2.6:80 */\n```\n KUBE-SERVICES targetcluster ip 10.43.6.58 target  KUBE-SVC-7CWUT4JBGBRVUN2L\n**KUBE-SVC-7CWUT4JBGBRVUN2L **\n\n   - target  Pod KUBE-SEP-U2YYZT2C3O6VM4EV  KUBE-SEP-GWUIQWA2TNZI4ESX \n   -  KUBE-SEP-U2YYZT2C3O6VM4EV statistic mode random probability 0.50.5 iptable0.550%\n   -  KUBE-SEP-U2YYZT2C3O6VM4EV target  target 50%\n\n-  KUBE-SEP-U2YYZT2C3O6VM4EV  KUBE-SEP-GWUIQWA2TNZI4ESX \n```shell\n# iptables -nvL -t nat | grep KUBE-SEP-U2YYZT2C3O6VM4EV -A 3\nChain KUBE-SEP-U2YYZT2C3O6VM4EV (1 references)\npkts bytes target     prot opt in     out     source               destination\n0     0 KUBE-MARK-MASQ  all  --  *      *       10.42.1.6            0.0.0.0/0            /* default/nginx-test:80-80 */\n0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp to:10.42.1.6:80\n\n# iptables -nvL -t nat | grep KUBE-SEP-GWUIQWA2TNZI4ESX -A 3\nChain KUBE-SEP-GWUIQWA2TNZI4ESX (1 references)\npkts bytes target     prot opt in     out     source               destination\n0     0 KUBE-MARK-MASQ  all  --  *      *       10.42.2.6            0.0.0.0/0            /* default/nginx-test:80-80 */\n0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp to:10.42.2.6:80\n```\n2target\n\n   - MASQengress(source ip)ingress\n   - DNATcluster ipDANTpodip 10.42.1.610.42.2.6port80 port\n   - iptabletarget10.42.1.6:8010.42.1.6:8010.42.2.6:8050%\n   - iptablePREROUTING chainDNAT10.42.1.610.42.2.6ip(ippodiphost network namespace)Forwarding chainhost network namespace\n```shell\n# \n# ip route\ndefault via 192.168.205.1 dev enp0s1 proto dhcp src 192.168.205.4 metric 100\n10.42.0.0/24 dev cni0 proto kernel scope link src 10.42.0.1\n10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink\n10.42.2.0/24 via 10.42.2.0 dev flannel.1 onlink\n192.168.205.0/24 dev enp0s1 proto kernel scope link src 192.168.205.4 metric 100\n192.168.205.1 dev enp0s1 proto dhcp scope link src 192.168.205.4 metric 100\n\n# 10.42.1.610.42.2.6 flannel.1 vtep  node  pod\n```\n\n- clusterip  service \n   - pod network namespacehost netwok namespacedocker0\n   - host netwok namespace**PREROUTING chain**target\n   - targetiptableendpoint target\n   - endpoint targetDNATcluster ippodip\n   - cluster ipipdevice\n   - host(net.ipv4.ip_forward = 1)\n   - host netwok namespaceDNAThost network namespace\n\n#### 3ipvs \n\n- [https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393263&idx=1&sn=d6f27c502a007aa8be7e75b17afac42f&chksm=f1310b40c64682563cfbfd0688deb0fc9569eca3b13dc721bfe0ad7992183cabfba354e02050&scene=178&cur_album_id=2123526506718003213#rd](https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393263&idx=1&sn=d6f27c502a007aa8be7e75b17afac42f&chksm=f1310b40c64682563cfbfd0688deb0fc9569eca3b13dc721bfe0ad7992183cabfba354e02050&scene=178&cur_album_id=2123526506718003213#rd)\n- [https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/](https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/)\n\n### Servicenodeport \n#### 1nodeport ip \n --> cluster ip 30000-32767\n\n#### 2iptables \n\n-  service \n```shell\n# kubectl describe service nginx-test\nName:                     nginx-test\nNamespace:                default\nLabels:                   app=nginx-test\nAnnotations:              <none>\nSelector:                 app=nginx-test\nType:                     NodePort\nIP Family Policy:         SingleStack\nIP Families:              IPv4\nIP:                       10.43.6.58\nIPs:                      10.43.6.58\nPort:                     80-80  80/TCP\nTargetPort:               80/TCP\nNodePort:                 80-80  32506/TCP\nEndpoints:                10.42.1.6:80,10.42.2.6:80\nSession Affinity:         None\nExternal Traffic Policy:  Cluster\nEvents:                   <none>\n```\nnode portservicehostporthosthosthost network namespacePREROUTING chainhost network namespacePREROUTING chain\n\n-  iptables\n```shell\n# iptables -nvL -t nat |head\nChain PREROUTING (policy ACCEPT 0 packets, 0 bytes)\npkts bytes target     prot opt in     out     source               destination\n323 20898 KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */\n```\nPREROUTING chainKUBE-SERVICEStarget\n\n-  KUBE-SERVICES target\n```shell\n# iptables -nvL -t nat |grep KUBE-SERVICES -A 10\nChain KUBE-SERVICES (2 references)\npkts bytes target     prot opt in     out     source               destination\n0     0 KUBE-SVC-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80\n```\nKUBE-SERVICES target nginx-test-service host 32506  KUBE-NODEPORTS target\n```shell\n# iptables -nvL -t nat |grep KUBE-NODEPORTS -A 3\nChain KUBE-NODEPORTS (1 references)\npkts bytes target     prot opt in     out     source               destination\n2   124 KUBE-EXT-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp dpt:32506\n```\nKUBE-NODEPORTS target 32506  KUBE-EXT-7CWUT4JBGBRVUN2L  target \n\n-  KUBE-EXT-7CWUT4JBGBRVUN2L  target\n```shell\n# iptables -nvL -t nat |grep KUBE-EXT-7CWUT4JBGBRVUN2L -A 5\nChain KUBE-EXT-7CWUT4JBGBRVUN2L (1 references)\n pkts bytes target     prot opt in     out     source               destination\n    2   124 KUBE-MARK-MASQ  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* masquerade traffic for default/nginx-test:80-80 external destinations */\n    2   124 KUBE-SVC-7CWUT4JBGBRVUN2L  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\n# iptables -nvL -t nat |grep KUBE-MARK-MASQ -A 3\nChain KUBE-MARK-MASQ (20 references)\n pkts bytes target     prot opt in     out     source               destination\n    2   124 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            MARK or 0x4000\n\n# iptables -nvL -t nat |grep KUBE-SVC-7CWUT4JBGBRVUN2L -A 5\nChain KUBE-SVC-7CWUT4JBGBRVUN2L (2 references)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 KUBE-MARK-MASQ  tcp  --  *      *      !10.42.0.0/16         10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80\n    1    64 KUBE-SEP-U2YYZT2C3O6VM4EV  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -> 10.42.1.6:80 */ statistic mode random probability 0.50000000000\n    1    60 KUBE-SEP-GWUIQWA2TNZI4ESX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -> 10.42.2.6:80 */\n```\n KUBE-EXT-7CWUT4JBGBRVUN2L  target\n\n   - KUBE-MARK-MASQ  nat target\n   - KUBE-SVC-7CWUT4JBGBRVUN2L target  cluster ip  Pod\n\n- nodeport  service \n   - host netwok namespacePREROUTING chainKUBE-SERVICES target\n   - KUBE-SERVICES targetKUBE-NODEPORTS target\n   - KUBE-NODEPORTS targetprotKUBE-SVC-XXX target\n   - KUBE-SVC-XXX targetcluster-ipservice Pod \n\n#### 3ipvs \n\n- [https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393266&idx=1&sn=34d2a21b06d6e9ef4f4f7415f2cad567&chksm=f1310b5dc646824b45cbfc8cf25b0f2449f7223006b684da06ba58d95a2be7a3f0ad7aa6c4b9&scene=178&cur_album_id=2123526506718003213#rd](https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393266&idx=1&sn=34d2a21b06d6e9ef4f4f7415f2cad567&chksm=f1310b5dc646824b45cbfc8cf25b0f2449f7223006b684da06ba58d95a2be7a3f0ad7aa6c4b9&scene=178&cur_album_id=2123526506718003213#rd)\n- [https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/](https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/)\n\n\n### Serviceipvs  iptables \n>  ipvs  k8s \n> - linux 2.4.x\n> -  kube-proxy --proxy-mode=ipvs\n> -  ipvsadm  ipvs \n\n\n- linuxendpoint\n- iptablelinux netfilter/iptable\n- ipvslinux netfilter/iptableipsetipvs\n- iptablehostipatbleentryserviceendpoints10cluster ipserviceservice6endpointsKUBE-SERVICES target10entries(KUBE-SVC-XXX)10serviceKUBE-SVC-XXX target6KUBE-SEP-XXX6endpointsKUBE-SEP-XXX2enrtiesmark masqDNAT10*6*2=120entriesiptableapplicationserviceendpointsiptable entries\n- ipvshostiptableentryiptableipset(KUBE-CLUSTER-IPKUBE-NODE-PORT-TCP)serviceipsetiptableiptableentriesserviceendpoints\n- iptablerandomipvsround-robinleast connectionsource hashhttp://www.linuxvirtualserver.org/kubelet--ipvs-scheduler\n- iptablelinuxDNATipvsipvs\n- ipvshost netwok namespacekube-ipvs0cluster ipcluster-ipserviceINPUT chainipvs\n- iptablehost netwok namespace\n- iptablehost network namespacechainPREROUTING-->FORWARDING-->POSTROUTING PREROUTING chainmark masq\n\n- ipvshost network namespacechainPREROUTING-->INPUT-->POSTROUTING PREROUTING chainmark masq SNATINPUT chainipvs\n- iptableipvshost network namespace\n\n### flannel \n#### 1flannel underlay host-gw \n**underlay **\n\n- underlay \n\n- \n\n**service  Pod **\n```shell\n# kubectl describe service nginx-test\nName:              nginx-test\nNamespace:         default\nLabels:            app=nginx-test\nAnnotations:       <none>\nSelector:          app=nginx-test\nType:              ClusterIP\nIP Family Policy:  SingleStack\nIP Families:       IPv4\nIP:                10.43.6.58\nIPs:               10.43.6.58\nPort:              80-80  80/TCP\nTargetPort:        80/TCP\nEndpoints:         10.42.0.65:80,10.42.1.9:80\nSession Affinity:  None\nEvents:            <none>\n\n# kubectl get pod -owide\nNAME                          READY   STATUS    RESTARTS      AGE   IP           NODE     NOMINATED NODE   READINESS GATES\nnginx-test-7646687cc4-n8s9s   1/1     Running   6 (60m ago)   26d   10.42.0.65   master   <none>           <none>\nnginx-test-7646687cc4-z8xnq   1/1     Running   0             47s   10.42.1.9    node1    <none>           <none>\n```\n\n**10.42.0.6510.42.1.9**\n\n-  pod \n\npod **10.42.0.65**pod **10.42.1.9**pod **10.42.0.65**vethpod network namespace**10.42.0.1**network namespacecni0 linux bridgepod **10.42.0.65**vethattachcni0 bridgecni0 bridepodnetwork namesapcehostnetwork namespace\n\n-  pod \n\nip**10.42.1.9**pod **10.42.0.65**ip**192.168.205.4**(net.ipv4.ip_forward = 1)ip **10.42.1.9**ip**192.168.205.4**\n```shell\n# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# ip route\n10.42.1.0/24 via 192.168.205.3 enp0s1 ...\n```\n**10.42.1.0/24****192.168.205.3**pod **10.42.1.9**arpmac**192.168.205.3**podpodhostpodhostpodhostpodhostpodhostflannelunderlayhost gwk8s worker node(ip)\n\n-  pod \n\npod **10.42.1.9**host **192.168.205.3**()pod(net.ipv4.ip_forward = 1)ip **10.42.1.9 **ip**192.168.205.3**\n```shell\n# ip addr |grep 192.168.205.3\n    inet 192.168.205.3/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# ip route\n10.42.1.0/24 dev cni0 proto kernel scope link src 10.42.1.1\n```\n**10.42.1.0/24**cni0 cni  **10.42.1.1** linux bridgeveth pairhost network namespacepod**10.42.1.9**network namespacepodpod kubectl debug \n```shell\n# kubectl debug -it nginx-test-7646687cc4-z8xnq --image=busybox -- /bin/sh\n\n# ip addr\n# traceroute 10.42.1.9\n```\n\n**flannel underlayhost-gw **\n\n- podnetwork namespacehost network namespacecni0 linux bridge\n- podhostpodhost\n- podhostpodhost mac \n- podhostpod\n- (net.ipv4.ip_forward = 1)\n- podhost\n\n#### 2flannel overlay vxlan \n**overlay **\n\n- \n\nvxlan overlay  vlan  vlan 412bit4000 vlan vxlan header824bit1600 vxlan[vxlan](https://tools.ietf.org/html/rfc7348)\n\n- [](https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393268&idx=1&sn=ea7df945f11a57619a81df8599bcbe99&chksm=f1310b5bc646824daaf9ac6cb2dec4b8c8f54fdf4753b5379db991c88e4e5951ec928b9da2d9&scene=178&cur_album_id=2123526506718003213#rd)\n\n1. vxlan  vxlan  udp  payload  eth mtu 15001450\n2.vxlan  udp etcd  udp 84728472 udp port \n\n**service  Pod **\n```shell\n# kubectl describe service nginx-test\nName:              nginx-test\nNamespace:         default\nLabels:            app=nginx-test\nAnnotations:       <none>\nSelector:          app=nginx-test\nType:              ClusterIP\nIP Family Policy:  SingleStack\nIP Families:       IPv4\nIP:                10.43.6.58\nIPs:               10.43.6.58\nPort:              80-80  80/TCP\nTargetPort:        80/TCP\nEndpoints:         10.42.0.65:80,10.42.1.9:80\nSession Affinity:  None\nEvents:            <none>\n\n# kubectl get pod -owide\nNAME                          READY   STATUS    RESTARTS      AGE   IP           NODE     NOMINATED NODE   READINESS GATES\nnginx-test-7646687cc4-n8s9s   1/1     Running   6 (60m ago)   26d   10.42.0.65   master   <none>           <none>\nnginx-test-7646687cc4-z8xnq   1/1     Running   0             47s   10.42.1.9    node1    <none>           <none>\n```\n\n**kubectl debug  pod 10.42.0.65**\n```shell\n#kubectl debug -it nginx-test-7646687cc4-n8s9s --image=busybox -- /bin/sh\n/ # ping -c 3 10.42.1.9\nPING 10.42.1.9 (10.42.1.9): 56 data bytes\n64 bytes from 10.42.1.9: seq=0 ttl=62 time=1.447 ms\n64 bytes from 10.42.1.9: seq=1 ttl=62 time=2.732 ms\n64 bytes from 10.42.1.9: seq=2 ttl=62 time=0.880 ms\n/ # traceroute -n 10.42.1.9\ntraceroute to 10.42.1.9 (10.42.1.9), 30 hops max, 46 byte packets\n 1  10.42.0.1  0.027 ms  0.012 ms  0.009 ms\n 2  10.42.1.0  1.761 ms  1.440 ms  1.085 ms\n 3  10.42.1.9  1.453 ms  0.979 ms  0.976 ms\n```\n\n**10.42.0.6510.42.1.9**\n\n-  pod namespace network \n\nip**10.42.0.65**podnetwork namespacepod **10.42.1.9****10.42.0.65** pod network namespace**10.42.0.65** pod**192.168.205.4**network namespacelinux bridge cni0\n```shell\n# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# ip route\n10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink\n```\n**10.42.1.0/24**ip**10.42.1.0**flannel.1flannel.1 flannel vxlanvxlanethudp\".1\"vxlanid1vxlanetcdip**10.42.0.65**ip**10.42.1.9**macpod **10.42.0.65** network namespacevethmacmacip **10.42.1.0/32 **mac\n\n-  vtep  mac \n\n mac pod **10.42.0.65****192.168.205.4**arp**10.42.1.0/32**mac 62:c8:a9:ce:ca:4e\n```shell\n# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# ip neighbo |grep 10.42.1.0\n10.42.1.0 dev flannel.1 lladdr 62:c8:a9:ce:ca:4e PERMANENT\n\n# ip neighbo show dev flannel.1\n10.42.1.0 lladdr 62:c8:a9:ce:ca:4e PERMANENT\n10.42.2.0 lladdr ca:cb:1f:99:10:97 PERMANENT\n```\n mac flannel.1vxlanmacpod **10.42.0.65****192.168.205.4**flannel.1mac\n```shell\n# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# bridge fdb show |grep 62:c8:a9:ce:ca:4e\n62:c8:a9:ce:ca:4e dev flannel.1 dst 192.168.205.3 self permanent\n\n# bridge fdb show dev flannel.1\n62:c8:a9:ce:ca:4e dst 192.168.205.3 self permanent\nee:87:b2:4a:fd:62 dst 192.168.205.5 self permanent\n```\n flannel.1mac **62:c8:a9:ce:ca:4e**  **192.168.205.3**flannel.1(ip**10.42.0.65**ip**10.42.1.9**mac pod **10.42.0.65** network namespacevethmacmac**10.42.1.0/32** mac) upd  payload  **192.168.205.3 ** **8472 **pod **10.42.1.9 ** **192.168.205.3**flannel.18472upd\n\n- flannel.1  udp \n```shell\n# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         192.168.205.1   0.0.0.0         UG    100    0        0 enp0s1\n192.168.205.0   0.0.0.0         255.255.255.0   U     100    0        0 enp0s1\n192.168.205.1   0.0.0.0         255.255.255.255 UH    100    0        0 enp0s1\n```\nflannel.1  udp pod **10.42.0.65 ** **192.168.205.4**  **192.168.205.0/24**  enp0s1 \n\n   - udpip**192.168.205.4**ip**192.168.205.3**mac**192.168.205.4** macmac**192.168.205.3** mac8472vxlan id1.\n   - ip**10.42.0.65**ip**10.42.1.9**macpod **10.42.0.65** network namespacevethmacmac**10.42.1.0/32** mac\n   -  **192.168.205.3**\n\nflannel.1  udp  **192.168.205.3 **\n\n   - **192.168.205.3**8472udpvxlan id1linuxvxlanvxlan idvxlanvxlan1vxlan id1vxlan**192.168.205.3**flannel.1\n   - flannel.1vxlan udpupdipportmacpayload\n   - ip**10.42.0.65**ip**10.42.1.9**\n   - **192.168.205.3**linux bridge cni0cni0  linux bridge  veth pair  pod **10.42.1.9**\n```shell\n# ip addr |grep 192.168.205.3\n    inet 192.168.205.3/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# route -n\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n10.42.1.0       0.0.0.0         255.255.255.0   U     0      0        0 cni0\n```\n\n- host  flannel.1macfdb \n\nhostflannelflanneletcdhostcidrcidrflannel.1ipmachostcidrflannel.1ipmacflannelfdb **192.168.205.4 **\n```shell\n~# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# bridge fdb show dev flannel.1\n62:c8:a9:ce:ca:4e dst 192.168.205.3 self permanent\nee:87:b2:4a:fd:62 dst 192.168.205.5 self permanent\n\n# etcdctl ....\n```\n\n**flannel overlayvxlan **\n\n- flannel.xvxlanvxlanudpupd8472()\n- podnetwork namespacehostnetwork namespace\n- host network namespaceipvxlaniphostflannel.x\n- host network namespaceapripmac\n- host network namespacefbdipmacip\n- hostflannel.xipmacipupd\n   - udpiphost ipipmacipmachost ipmacmacfdbipmac8472()vxlan id1().\n   - ippod ipippod ipmacpod macmachost network namespaceipmac(podhostflannel.xip)\n- hosthost\n- host8472udpvxlan id.linux vxlanvxlan idvxlan\n- vxlanvxlan udpupdipportmacpayloadpod ippod ip\n- hostlinux bridge cni0\n- linux bridge cni0veth pairpod\n- hostflanneletcdvxlanhostmacfdb\n\n#### 3flannel underlay  overlay \n\n- host(net.ipv4.ip_forward = 1)\n- flannel underlay\n- flannel underlayworker nodepodunderlayworker node\n- flannel vxlan overlay  udp  worker nodeworker node\n- flannel vxlan overlaylinux vxlan\n- flannel underlayflannel vxlan overlay\n\n> #### \n> 1k8s \n> [https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0MDE3MjAzMg==&action=getalbum&album_id=2123526506718003213&scene=173&from_msgid=2648393229&from_itemidx=1&count=3&nolastread=1#wechat_redirect](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0MDE3MjAzMg==&action=getalbum&album_id=2123526506718003213&scene=173&from_msgid=2648393229&from_itemidx=1&count=3&nolastread=1#wechat_redirect)\n> 2iptables \n> [https://lixiangyun.gitbook.io/iptables_doc_zh_cn/](https://lixiangyun.gitbook.io/iptables_doc_zh_cn/)\n> [https://www.jianshu.com/p/ee4ee15d3658](https://www.jianshu.com/p/ee4ee15d3658)\n> 3Docker [https://developer.aliyun.com/article/974008#slide-4](https://developer.aliyun.com/article/974008#slide-4)\n> 4ipvs [https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/](https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/)\n\n\n","source":"_posts/k8s-network.md","raw":"---\ntitle: Kubernetes-\ncategories:\n  - CNCF\ntags:\n  - Kubernetes\nabbrlink: 5d90\ndate: 2023-02-08 23:20:49\n---\n### \n#### 1\n\n- Linux Network Namespace\n   - linux network interface deviceloopback devicebridge deviceveth devicetun/tap devicevxlan deviceip tunnel device \n   - linux  ip arp  ip  mac fdb mac  mac  \n   - linux  ethernet  ip icmp tcp/udp \n   - linux iptable netfilter  linux  firewall  ingress  engressnat \n<!--more-->\n\n{% asset_img k8s-nw1.png %}\n> linux  network namespace  pid namespace user namespace mount namespace ipc namespace uts namespace \n>  cgroup  cpumemoryio \n\n- Linux Bridge Device\n\nlinux  attach  linux linux bridgeiplinuxattachbridgeip()bridgeattachbridge\n{% asset_img k8s-nw2.png %}\n\n- Linux Veth Device\n\n peer  peer  peerveth pair  network namespace\n{% asset_img k8s-nw3.png %}\n\n#### 2k8s \n\n- \n\nkube-proxy --proxy-module=ipvs\niptables\nipvsv1.11 \n\n- \n\nunderlayflannel host-gwcalico bgp  ip_forword \noverlayflannel vxlancalico ipipflannel udp \n\n#### 3\n|  IP |  |  CIDR | CNI  | Flannel.1 vtep  |\n| --- | --- | --- | --- | --- |\n| 192.168.205.4 | master | 10.42.0.0/24 | 10.42.0.1 | 10.42.0.0\n| 192.168.205.3 | node1 | 10.42.1.0/24 | 10.42.1.1 | 10.42.1.0\n| 192.168.205.5 | node2 | 10.42.2.0/24 | 10.42.2.1 | 10.42.2.0\n\n\n### \n#### 1docker \n\n- bridge --net=bridge\n\n docker0  IP  IP\n> {% asset_img k8s-nw4.png %}\n>  bridge  network namespace \n> {% asset_img k8s-nw5.png %}\n\n\n- host --net=host\n\n\n{% asset_img k8s-nw6.png %}\n\n- contaniner --net=container:name or id\n\n Network namespacek8s  pod  network namespace  lo \n{% asset_img k8s-nw7.png %}\n\n- none  Network namespace  CPU \n\n#### 2docker \n\n- containernetwork namespacecontainerarpiptablecontainernetwork namespace\n- default netwok nemespacelinux bridgedocker0\n- containerveth paircontainernetwork namespaceattachnetworkwork namespacedocker0 linux bridge\n- (docker0 bridge)containercontainer\n\n{% asset_img k8s-nw8.png %}\n\n```shell\n## \n# bridge \n#k8s pod  infrastructure  network namespace  veth pair\nbrctl show\n\n# veth pair \nip addr\nip -d link show\n\n#\nroute -n\n\n# docker \ndocker ps/inspect/container\n```\n\n### Servicecluster ip \n#### 1cluster ip \nk8s  service cluster ip cluster ip  endpoints pod  cluster ip  cluster ip  endpoints  iptables  ipvs\n\n#### 2iptables \n\n-  service cluster ip  endpoints ip\n```shell\n# kubectl describe service nginx-test\nName:              nginx-test\nNamespace:         default\nLabels:            app=nginx-test\nAnnotations:       <none>\nSelector:          app=nginx-test\nType:              ClusterIP\nIP Family Policy:  SingleStack\nIP Families:       IPv4\nIP:                10.43.6.58\nIPs:               10.43.6.58\nPort:              80-80  80/TCP\nTargetPort:        80/TCP\nEndpoints:         10.42.1.6:80,10.42.2.6:80\n```\n\n-  iptables \n```shell\n# iptables -nvL -t nat |head\nChain PREROUTING (policy ACCEPT 0 packets, 0 bytes)\npkts bytes target     prot opt in     out     source               destination\n298 19090 KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */\n202 12456 CNI-HOSTPORT-DNAT  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL\n```\n PREROUTING chain  KUBE-SERVICES  target  PREROUTING chain  pod  curl http://10.43.6.58\n\n   - podcluster ip(**10.43.6.58**)\n   - podipnetwok namespace **docker0  cni0** ip\n   - podeth0 deviceeth0veth pairpod network namespaceattachnetwok namespace **docker0  cni0** bridge\n   - veth pairpod network namespaceattached**docker0  cni0** bridge\n   - **docker0  cni0** bridgehost network namesapce  PREROUTING chain\n\n-  KUBE-SERVICES target\n```shell\n# iptables -nvL -t nat | grep 10.43.6.58\n0     0 KUBE-SVC-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80\n\n# iptables -nvL -t nat | grep KUBE-SVC-7CWUT4JBGBRVUN2L -A 5\nChain KUBE-SVC-7CWUT4JBGBRVUN2L (1 references)\npkts bytes target     prot opt in     out     source               destination\n0     0 KUBE-SEP-U2YYZT2C3O6VM4EV  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -> 10.42.1.6:80 */ statistic mode random probability 0.50000000000\n0     0 KUBE-SEP-GWUIQWA2TNZI4ESX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -> 10.42.2.6:80 */\n```\n KUBE-SERVICES targetcluster ip 10.43.6.58 target  KUBE-SVC-7CWUT4JBGBRVUN2L\n**KUBE-SVC-7CWUT4JBGBRVUN2L **\n\n   - target  Pod KUBE-SEP-U2YYZT2C3O6VM4EV  KUBE-SEP-GWUIQWA2TNZI4ESX \n   -  KUBE-SEP-U2YYZT2C3O6VM4EV statistic mode random probability 0.50.5 iptable0.550%\n   -  KUBE-SEP-U2YYZT2C3O6VM4EV target  target 50%\n\n-  KUBE-SEP-U2YYZT2C3O6VM4EV  KUBE-SEP-GWUIQWA2TNZI4ESX \n```shell\n# iptables -nvL -t nat | grep KUBE-SEP-U2YYZT2C3O6VM4EV -A 3\nChain KUBE-SEP-U2YYZT2C3O6VM4EV (1 references)\npkts bytes target     prot opt in     out     source               destination\n0     0 KUBE-MARK-MASQ  all  --  *      *       10.42.1.6            0.0.0.0/0            /* default/nginx-test:80-80 */\n0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp to:10.42.1.6:80\n\n# iptables -nvL -t nat | grep KUBE-SEP-GWUIQWA2TNZI4ESX -A 3\nChain KUBE-SEP-GWUIQWA2TNZI4ESX (1 references)\npkts bytes target     prot opt in     out     source               destination\n0     0 KUBE-MARK-MASQ  all  --  *      *       10.42.2.6            0.0.0.0/0            /* default/nginx-test:80-80 */\n0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp to:10.42.2.6:80\n```\n2target\n\n   - MASQengress(source ip)ingress\n   - DNATcluster ipDANTpodip 10.42.1.610.42.2.6port80 port\n   - iptabletarget10.42.1.6:8010.42.1.6:8010.42.2.6:8050%\n   - iptablePREROUTING chainDNAT10.42.1.610.42.2.6ip(ippodiphost network namespace)Forwarding chainhost network namespace\n```shell\n# \n# ip route\ndefault via 192.168.205.1 dev enp0s1 proto dhcp src 192.168.205.4 metric 100\n10.42.0.0/24 dev cni0 proto kernel scope link src 10.42.0.1\n10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink\n10.42.2.0/24 via 10.42.2.0 dev flannel.1 onlink\n192.168.205.0/24 dev enp0s1 proto kernel scope link src 192.168.205.4 metric 100\n192.168.205.1 dev enp0s1 proto dhcp scope link src 192.168.205.4 metric 100\n\n# 10.42.1.610.42.2.6 flannel.1 vtep  node  pod\n```\n\n- clusterip  service \n   - pod network namespacehost netwok namespacedocker0\n   - host netwok namespace**PREROUTING chain**target\n   - targetiptableendpoint target\n   - endpoint targetDNATcluster ippodip\n   - cluster ipipdevice\n   - host(net.ipv4.ip_forward = 1)\n   - host netwok namespaceDNAThost network namespace\n\n#### 3ipvs \n\n- [https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393263&idx=1&sn=d6f27c502a007aa8be7e75b17afac42f&chksm=f1310b40c64682563cfbfd0688deb0fc9569eca3b13dc721bfe0ad7992183cabfba354e02050&scene=178&cur_album_id=2123526506718003213#rd](https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393263&idx=1&sn=d6f27c502a007aa8be7e75b17afac42f&chksm=f1310b40c64682563cfbfd0688deb0fc9569eca3b13dc721bfe0ad7992183cabfba354e02050&scene=178&cur_album_id=2123526506718003213#rd)\n- [https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/](https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/)\n\n### Servicenodeport \n#### 1nodeport ip \n --> cluster ip 30000-32767\n\n#### 2iptables \n\n-  service \n```shell\n# kubectl describe service nginx-test\nName:                     nginx-test\nNamespace:                default\nLabels:                   app=nginx-test\nAnnotations:              <none>\nSelector:                 app=nginx-test\nType:                     NodePort\nIP Family Policy:         SingleStack\nIP Families:              IPv4\nIP:                       10.43.6.58\nIPs:                      10.43.6.58\nPort:                     80-80  80/TCP\nTargetPort:               80/TCP\nNodePort:                 80-80  32506/TCP\nEndpoints:                10.42.1.6:80,10.42.2.6:80\nSession Affinity:         None\nExternal Traffic Policy:  Cluster\nEvents:                   <none>\n```\nnode portservicehostporthosthosthost network namespacePREROUTING chainhost network namespacePREROUTING chain\n\n-  iptables\n```shell\n# iptables -nvL -t nat |head\nChain PREROUTING (policy ACCEPT 0 packets, 0 bytes)\npkts bytes target     prot opt in     out     source               destination\n323 20898 KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */\n```\nPREROUTING chainKUBE-SERVICEStarget\n\n-  KUBE-SERVICES target\n```shell\n# iptables -nvL -t nat |grep KUBE-SERVICES -A 10\nChain KUBE-SERVICES (2 references)\npkts bytes target     prot opt in     out     source               destination\n0     0 KUBE-SVC-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80\n```\nKUBE-SERVICES target nginx-test-service host 32506  KUBE-NODEPORTS target\n```shell\n# iptables -nvL -t nat |grep KUBE-NODEPORTS -A 3\nChain KUBE-NODEPORTS (1 references)\npkts bytes target     prot opt in     out     source               destination\n2   124 KUBE-EXT-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp dpt:32506\n```\nKUBE-NODEPORTS target 32506  KUBE-EXT-7CWUT4JBGBRVUN2L  target \n\n-  KUBE-EXT-7CWUT4JBGBRVUN2L  target\n```shell\n# iptables -nvL -t nat |grep KUBE-EXT-7CWUT4JBGBRVUN2L -A 5\nChain KUBE-EXT-7CWUT4JBGBRVUN2L (1 references)\n pkts bytes target     prot opt in     out     source               destination\n    2   124 KUBE-MARK-MASQ  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* masquerade traffic for default/nginx-test:80-80 external destinations */\n    2   124 KUBE-SVC-7CWUT4JBGBRVUN2L  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\n# iptables -nvL -t nat |grep KUBE-MARK-MASQ -A 3\nChain KUBE-MARK-MASQ (20 references)\n pkts bytes target     prot opt in     out     source               destination\n    2   124 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            MARK or 0x4000\n\n# iptables -nvL -t nat |grep KUBE-SVC-7CWUT4JBGBRVUN2L -A 5\nChain KUBE-SVC-7CWUT4JBGBRVUN2L (2 references)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 KUBE-MARK-MASQ  tcp  --  *      *      !10.42.0.0/16         10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80\n    1    64 KUBE-SEP-U2YYZT2C3O6VM4EV  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -> 10.42.1.6:80 */ statistic mode random probability 0.50000000000\n    1    60 KUBE-SEP-GWUIQWA2TNZI4ESX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -> 10.42.2.6:80 */\n```\n KUBE-EXT-7CWUT4JBGBRVUN2L  target\n\n   - KUBE-MARK-MASQ  nat target\n   - KUBE-SVC-7CWUT4JBGBRVUN2L target  cluster ip  Pod\n\n- nodeport  service \n   - host netwok namespacePREROUTING chainKUBE-SERVICES target\n   - KUBE-SERVICES targetKUBE-NODEPORTS target\n   - KUBE-NODEPORTS targetprotKUBE-SVC-XXX target\n   - KUBE-SVC-XXX targetcluster-ipservice Pod \n\n#### 3ipvs \n\n- [https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393266&idx=1&sn=34d2a21b06d6e9ef4f4f7415f2cad567&chksm=f1310b5dc646824b45cbfc8cf25b0f2449f7223006b684da06ba58d95a2be7a3f0ad7aa6c4b9&scene=178&cur_album_id=2123526506718003213#rd](https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393266&idx=1&sn=34d2a21b06d6e9ef4f4f7415f2cad567&chksm=f1310b5dc646824b45cbfc8cf25b0f2449f7223006b684da06ba58d95a2be7a3f0ad7aa6c4b9&scene=178&cur_album_id=2123526506718003213#rd)\n- [https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/](https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/)\n\n\n### Serviceipvs  iptables \n>  ipvs  k8s \n> - linux 2.4.x\n> -  kube-proxy --proxy-mode=ipvs\n> -  ipvsadm  ipvs \n\n\n- linuxendpoint\n- iptablelinux netfilter/iptable\n- ipvslinux netfilter/iptableipsetipvs\n- iptablehostipatbleentryserviceendpoints10cluster ipserviceservice6endpointsKUBE-SERVICES target10entries(KUBE-SVC-XXX)10serviceKUBE-SVC-XXX target6KUBE-SEP-XXX6endpointsKUBE-SEP-XXX2enrtiesmark masqDNAT10*6*2=120entriesiptableapplicationserviceendpointsiptable entries\n- ipvshostiptableentryiptableipset(KUBE-CLUSTER-IPKUBE-NODE-PORT-TCP)serviceipsetiptableiptableentriesserviceendpoints\n- iptablerandomipvsround-robinleast connectionsource hashhttp://www.linuxvirtualserver.org/kubelet--ipvs-scheduler\n- iptablelinuxDNATipvsipvs\n- ipvshost netwok namespacekube-ipvs0cluster ipcluster-ipserviceINPUT chainipvs\n- iptablehost netwok namespace\n- iptablehost network namespacechainPREROUTING-->FORWARDING-->POSTROUTING PREROUTING chainmark masq\n\n- ipvshost network namespacechainPREROUTING-->INPUT-->POSTROUTING PREROUTING chainmark masq SNATINPUT chainipvs\n- iptableipvshost network namespace\n\n### flannel \n#### 1flannel underlay host-gw \n**underlay **\n\n- underlay \n\n- \n\n**service  Pod **\n```shell\n# kubectl describe service nginx-test\nName:              nginx-test\nNamespace:         default\nLabels:            app=nginx-test\nAnnotations:       <none>\nSelector:          app=nginx-test\nType:              ClusterIP\nIP Family Policy:  SingleStack\nIP Families:       IPv4\nIP:                10.43.6.58\nIPs:               10.43.6.58\nPort:              80-80  80/TCP\nTargetPort:        80/TCP\nEndpoints:         10.42.0.65:80,10.42.1.9:80\nSession Affinity:  None\nEvents:            <none>\n\n# kubectl get pod -owide\nNAME                          READY   STATUS    RESTARTS      AGE   IP           NODE     NOMINATED NODE   READINESS GATES\nnginx-test-7646687cc4-n8s9s   1/1     Running   6 (60m ago)   26d   10.42.0.65   master   <none>           <none>\nnginx-test-7646687cc4-z8xnq   1/1     Running   0             47s   10.42.1.9    node1    <none>           <none>\n```\n\n**10.42.0.6510.42.1.9**\n\n-  pod \n\npod **10.42.0.65**pod **10.42.1.9**pod **10.42.0.65**vethpod network namespace**10.42.0.1**network namespacecni0 linux bridgepod **10.42.0.65**vethattachcni0 bridgecni0 bridepodnetwork namesapcehostnetwork namespace\n\n-  pod \n\nip**10.42.1.9**pod **10.42.0.65**ip**192.168.205.4**(net.ipv4.ip_forward = 1)ip **10.42.1.9**ip**192.168.205.4**\n```shell\n# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# ip route\n10.42.1.0/24 via 192.168.205.3 enp0s1 ...\n```\n**10.42.1.0/24****192.168.205.3**pod **10.42.1.9**arpmac**192.168.205.3**podpodhostpodhostpodhostpodhostpodhostflannelunderlayhost gwk8s worker node(ip)\n\n-  pod \n\npod **10.42.1.9**host **192.168.205.3**()pod(net.ipv4.ip_forward = 1)ip **10.42.1.9 **ip**192.168.205.3**\n```shell\n# ip addr |grep 192.168.205.3\n    inet 192.168.205.3/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# ip route\n10.42.1.0/24 dev cni0 proto kernel scope link src 10.42.1.1\n```\n**10.42.1.0/24**cni0 cni  **10.42.1.1** linux bridgeveth pairhost network namespacepod**10.42.1.9**network namespacepodpod kubectl debug \n```shell\n# kubectl debug -it nginx-test-7646687cc4-z8xnq --image=busybox -- /bin/sh\n\n# ip addr\n# traceroute 10.42.1.9\n```\n\n**flannel underlayhost-gw **\n\n- podnetwork namespacehost network namespacecni0 linux bridge\n- podhostpodhost\n- podhostpodhost mac \n- podhostpod\n- (net.ipv4.ip_forward = 1)\n- podhost\n\n#### 2flannel overlay vxlan \n**overlay **\n\n- \n\nvxlan overlay  vlan  vlan 412bit4000 vlan vxlan header824bit1600 vxlan[vxlan](https://tools.ietf.org/html/rfc7348)\n\n- [](https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393268&idx=1&sn=ea7df945f11a57619a81df8599bcbe99&chksm=f1310b5bc646824daaf9ac6cb2dec4b8c8f54fdf4753b5379db991c88e4e5951ec928b9da2d9&scene=178&cur_album_id=2123526506718003213#rd)\n\n1. vxlan  vxlan  udp  payload  eth mtu 15001450\n2.vxlan  udp etcd  udp 84728472 udp port \n\n**service  Pod **\n```shell\n# kubectl describe service nginx-test\nName:              nginx-test\nNamespace:         default\nLabels:            app=nginx-test\nAnnotations:       <none>\nSelector:          app=nginx-test\nType:              ClusterIP\nIP Family Policy:  SingleStack\nIP Families:       IPv4\nIP:                10.43.6.58\nIPs:               10.43.6.58\nPort:              80-80  80/TCP\nTargetPort:        80/TCP\nEndpoints:         10.42.0.65:80,10.42.1.9:80\nSession Affinity:  None\nEvents:            <none>\n\n# kubectl get pod -owide\nNAME                          READY   STATUS    RESTARTS      AGE   IP           NODE     NOMINATED NODE   READINESS GATES\nnginx-test-7646687cc4-n8s9s   1/1     Running   6 (60m ago)   26d   10.42.0.65   master   <none>           <none>\nnginx-test-7646687cc4-z8xnq   1/1     Running   0             47s   10.42.1.9    node1    <none>           <none>\n```\n\n**kubectl debug  pod 10.42.0.65**\n```shell\n#kubectl debug -it nginx-test-7646687cc4-n8s9s --image=busybox -- /bin/sh\n/ # ping -c 3 10.42.1.9\nPING 10.42.1.9 (10.42.1.9): 56 data bytes\n64 bytes from 10.42.1.9: seq=0 ttl=62 time=1.447 ms\n64 bytes from 10.42.1.9: seq=1 ttl=62 time=2.732 ms\n64 bytes from 10.42.1.9: seq=2 ttl=62 time=0.880 ms\n/ # traceroute -n 10.42.1.9\ntraceroute to 10.42.1.9 (10.42.1.9), 30 hops max, 46 byte packets\n 1  10.42.0.1  0.027 ms  0.012 ms  0.009 ms\n 2  10.42.1.0  1.761 ms  1.440 ms  1.085 ms\n 3  10.42.1.9  1.453 ms  0.979 ms  0.976 ms\n```\n\n**10.42.0.6510.42.1.9**\n\n-  pod namespace network \n\nip**10.42.0.65**podnetwork namespacepod **10.42.1.9****10.42.0.65** pod network namespace**10.42.0.65** pod**192.168.205.4**network namespacelinux bridge cni0\n```shell\n# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# ip route\n10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink\n```\n**10.42.1.0/24**ip**10.42.1.0**flannel.1flannel.1 flannel vxlanvxlanethudp\".1\"vxlanid1vxlanetcdip**10.42.0.65**ip**10.42.1.9**macpod **10.42.0.65** network namespacevethmacmacip **10.42.1.0/32 **mac\n\n-  vtep  mac \n\n mac pod **10.42.0.65****192.168.205.4**arp**10.42.1.0/32**mac 62:c8:a9:ce:ca:4e\n```shell\n# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# ip neighbo |grep 10.42.1.0\n10.42.1.0 dev flannel.1 lladdr 62:c8:a9:ce:ca:4e PERMANENT\n\n# ip neighbo show dev flannel.1\n10.42.1.0 lladdr 62:c8:a9:ce:ca:4e PERMANENT\n10.42.2.0 lladdr ca:cb:1f:99:10:97 PERMANENT\n```\n mac flannel.1vxlanmacpod **10.42.0.65****192.168.205.4**flannel.1mac\n```shell\n# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# bridge fdb show |grep 62:c8:a9:ce:ca:4e\n62:c8:a9:ce:ca:4e dev flannel.1 dst 192.168.205.3 self permanent\n\n# bridge fdb show dev flannel.1\n62:c8:a9:ce:ca:4e dst 192.168.205.3 self permanent\nee:87:b2:4a:fd:62 dst 192.168.205.5 self permanent\n```\n flannel.1mac **62:c8:a9:ce:ca:4e**  **192.168.205.3**flannel.1(ip**10.42.0.65**ip**10.42.1.9**mac pod **10.42.0.65** network namespacevethmacmac**10.42.1.0/32** mac) upd  payload  **192.168.205.3 ** **8472 **pod **10.42.1.9 ** **192.168.205.3**flannel.18472upd\n\n- flannel.1  udp \n```shell\n# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         192.168.205.1   0.0.0.0         UG    100    0        0 enp0s1\n192.168.205.0   0.0.0.0         255.255.255.0   U     100    0        0 enp0s1\n192.168.205.1   0.0.0.0         255.255.255.255 UH    100    0        0 enp0s1\n```\nflannel.1  udp pod **10.42.0.65 ** **192.168.205.4**  **192.168.205.0/24**  enp0s1 \n\n   - udpip**192.168.205.4**ip**192.168.205.3**mac**192.168.205.4** macmac**192.168.205.3** mac8472vxlan id1.\n   - ip**10.42.0.65**ip**10.42.1.9**macpod **10.42.0.65** network namespacevethmacmac**10.42.1.0/32** mac\n   -  **192.168.205.3**\n\nflannel.1  udp  **192.168.205.3 **\n\n   - **192.168.205.3**8472udpvxlan id1linuxvxlanvxlan idvxlanvxlan1vxlan id1vxlan**192.168.205.3**flannel.1\n   - flannel.1vxlan udpupdipportmacpayload\n   - ip**10.42.0.65**ip**10.42.1.9**\n   - **192.168.205.3**linux bridge cni0cni0  linux bridge  veth pair  pod **10.42.1.9**\n```shell\n# ip addr |grep 192.168.205.3\n    inet 192.168.205.3/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# route -n\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n10.42.1.0       0.0.0.0         255.255.255.0   U     0      0        0 cni0\n```\n\n- host  flannel.1macfdb \n\nhostflannelflanneletcdhostcidrcidrflannel.1ipmachostcidrflannel.1ipmacflannelfdb **192.168.205.4 **\n```shell\n~# ip addr |grep 192.168.205.4\n    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1\n\n# bridge fdb show dev flannel.1\n62:c8:a9:ce:ca:4e dst 192.168.205.3 self permanent\nee:87:b2:4a:fd:62 dst 192.168.205.5 self permanent\n\n# etcdctl ....\n```\n\n**flannel overlayvxlan **\n\n- flannel.xvxlanvxlanudpupd8472()\n- podnetwork namespacehostnetwork namespace\n- host network namespaceipvxlaniphostflannel.x\n- host network namespaceapripmac\n- host network namespacefbdipmacip\n- hostflannel.xipmacipupd\n   - udpiphost ipipmacipmachost ipmacmacfdbipmac8472()vxlan id1().\n   - ippod ipippod ipmacpod macmachost network namespaceipmac(podhostflannel.xip)\n- hosthost\n- host8472udpvxlan id.linux vxlanvxlan idvxlan\n- vxlanvxlan udpupdipportmacpayloadpod ippod ip\n- hostlinux bridge cni0\n- linux bridge cni0veth pairpod\n- hostflanneletcdvxlanhostmacfdb\n\n#### 3flannel underlay  overlay \n\n- host(net.ipv4.ip_forward = 1)\n- flannel underlay\n- flannel underlayworker nodepodunderlayworker node\n- flannel vxlan overlay  udp  worker nodeworker node\n- flannel vxlan overlaylinux vxlan\n- flannel underlayflannel vxlan overlay\n\n> #### \n> 1k8s \n> [https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0MDE3MjAzMg==&action=getalbum&album_id=2123526506718003213&scene=173&from_msgid=2648393229&from_itemidx=1&count=3&nolastread=1#wechat_redirect](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0MDE3MjAzMg==&action=getalbum&album_id=2123526506718003213&scene=173&from_msgid=2648393229&from_itemidx=1&count=3&nolastread=1#wechat_redirect)\n> 2iptables \n> [https://lixiangyun.gitbook.io/iptables_doc_zh_cn/](https://lixiangyun.gitbook.io/iptables_doc_zh_cn/)\n> [https://www.jianshu.com/p/ee4ee15d3658](https://www.jianshu.com/p/ee4ee15d3658)\n> 3Docker [https://developer.aliyun.com/article/974008#slide-4](https://developer.aliyun.com/article/974008#slide-4)\n> 4ipvs [https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/](https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/)\n\n\n","slug":"k8s-network","published":1,"updated":"2024-01-21T15:28:43.154Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zp001ms0nj1dyrabyk","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h4><ul>\n<li>Linux Network Namespace<ul>\n<li>linux network interface deviceloopback devicebridge deviceveth devicetun&#x2F;tap devicevxlan deviceip tunnel device </li>\n<li>linux  ip arp  ip  mac fdb mac  mac  </li>\n<li>linux  ethernet  ip icmp tcp&#x2F;udp </li>\n<li>linux iptable netfilter  linux  firewall  ingress  engressnat <span id=\"more\"></span></li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/5d90/k8s-nw1.png\" class>\n<blockquote>\n<p>linux  network namespace  pid namespace user namespace mount namespace ipc namespace uts namespace <br> cgroup  cpumemoryio </p>\n</blockquote>\n<ul>\n<li>Linux Bridge Device</li>\n</ul>\n<p>linux  attach  linux linux bridgeiplinuxattachbridgeip()bridgeattachbridge</p>\n<img data-src=\"/posts/5d90/k8s-nw2.png\" class>\n\n<ul>\n<li>Linux Veth Device</li>\n</ul>\n<p> peer  peer  peerveth pair  network namespace</p>\n<img data-src=\"/posts/5d90/k8s-nw3.png\" class>\n\n<h4 id=\"2k8s-\"><a href=\"#2k8s-\" class=\"headerlink\" title=\"2k8s \"></a>2k8s </h4><ul>\n<li></li>\n</ul>\n<p>kube-proxy proxy-module&#x3D;ipvs<br>iptables<br>ipvsv1.11 </p>\n<ul>\n<li></li>\n</ul>\n<p>underlayflannel host-gwcalico bgp  ip_forword <br>overlayflannel vxlancalico ipipflannel udp </p>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><table>\n<thead>\n<tr>\n<th> IP</th>\n<th></th>\n<th> CIDR</th>\n<th>CNI </th>\n<th>Flannel.1 vtep </th>\n</tr>\n</thead>\n<tbody><tr>\n<td>192.168.205.4</td>\n<td>master</td>\n<td>10.42.0.0&#x2F;24</td>\n<td>10.42.0.1</td>\n<td>10.42.0.0</td>\n</tr>\n<tr>\n<td>192.168.205.3</td>\n<td>node1</td>\n<td>10.42.1.0&#x2F;24</td>\n<td>10.42.1.1</td>\n<td>10.42.1.0</td>\n</tr>\n<tr>\n<td>192.168.205.5</td>\n<td>node2</td>\n<td>10.42.2.0&#x2F;24</td>\n<td>10.42.2.1</td>\n<td>10.42.2.0</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1docker-\"><a href=\"#1docker-\" class=\"headerlink\" title=\"1docker \"></a>1docker </h4><ul>\n<li>bridge net&#x3D;bridge</li>\n</ul>\n<p> docker0  IP  IP</p>\n<blockquote>\n<img data-src=\"/posts/5d90/k8s-nw4.png\" class>\n<p> bridge  network namespace </p>\n<img data-src=\"/posts/5d90/k8s-nw5.png\" class>\n</blockquote>\n<ul>\n<li>host net&#x3D;host</li>\n</ul>\n<p></p>\n<img data-src=\"/posts/5d90/k8s-nw6.png\" class>\n\n<ul>\n<li>contaniner net&#x3D;container:name or id</li>\n</ul>\n<p> Network namespacek8s  pod  network namespace  lo </p>\n<img data-src=\"/posts/5d90/k8s-nw7.png\" class>\n\n<ul>\n<li>none  Network namespace  CPU </li>\n</ul>\n<h4 id=\"2docker-\"><a href=\"#2docker-\" class=\"headerlink\" title=\"2docker \"></a>2docker </h4><ul>\n<li>containernetwork namespacecontainerarpiptablecontainernetwork namespace</li>\n<li>default netwok nemespacelinux bridgedocker0</li>\n<li>containerveth paircontainernetwork namespaceattachnetworkwork namespacedocker0 linux bridge</li>\n<li>(docker0 bridge)containercontainer</li>\n</ul>\n<img data-src=\"/posts/5d90/k8s-nw8.png\" class>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># </span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> bridge </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">k8s pod  infrastructure  network namespace  veth pair</span></span><br><span class=\"line\">brctl show</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> veth pair </span></span><br><span class=\"line\">ip addr</span><br><span class=\"line\">ip -d link show</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">route -n</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> docker </span></span><br><span class=\"line\">docker ps/inspect/container</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Servicecluster-ip-\"><a href=\"#Servicecluster-ip-\" class=\"headerlink\" title=\"Servicecluster ip \"></a>Servicecluster ip </h3><h4 id=\"1cluster-ip-\"><a href=\"#1cluster-ip-\" class=\"headerlink\" title=\"1cluster ip \"></a>1cluster ip </h4><p>k8s  service cluster ip cluster ip  endpoints pod  cluster ip  cluster ip  endpoints  iptables  ipvs</p>\n<h4 id=\"2iptables-\"><a href=\"#2iptables-\" class=\"headerlink\" title=\"2iptables \"></a>2iptables </h4><ul>\n<li><p> service cluster ip  endpoints ip</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl describe service nginx-test</span></span><br><span class=\"line\">Name:              nginx-test</span><br><span class=\"line\">Namespace:         default</span><br><span class=\"line\">Labels:            app=nginx-test</span><br><span class=\"line\">Annotations:       &lt;none&gt;</span><br><span class=\"line\">Selector:          app=nginx-test</span><br><span class=\"line\">Type:              ClusterIP</span><br><span class=\"line\">IP Family Policy:  SingleStack</span><br><span class=\"line\">IP Families:       IPv4</span><br><span class=\"line\">IP:                10.43.6.58</span><br><span class=\"line\">IPs:               10.43.6.58</span><br><span class=\"line\">Port:              80-80  80/TCP</span><br><span class=\"line\">TargetPort:        80/TCP</span><br><span class=\"line\">Endpoints:         10.42.1.6:80,10.42.2.6:80</span><br></pre></td></tr></table></figure>\n</li>\n<li><p> iptables </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |<span class=\"built_in\">head</span></span></span><br><span class=\"line\">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">298 19090 KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span><br><span class=\"line\">202 12456 CNI-HOSTPORT-DNAT  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span><br></pre></td></tr></table></figure>\n<p> PREROUTING chain  KUBE-SERVICES  target  PREROUTING chain  pod  curl <a href=\"http://10.43.6.58\">http://10.43.6.58</a></p>\n<ul>\n<li>podcluster ip(<strong>10.43.6.58</strong>)</li>\n<li>podipnetwok namespace <strong>docker0  cni0</strong> ip</li>\n<li>podeth0 deviceeth0veth pairpod network namespaceattachnetwok namespace <strong>docker0  cni0</strong> bridge</li>\n<li>veth pairpod network namespaceattached<strong>docker0  cni0</strong> bridge</li>\n<li><strong>docker0  cni0</strong> bridgehost network namesapce  PREROUTING chain</li>\n</ul>\n</li>\n<li><p> KUBE-SERVICES target</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat | grep 10.43.6.58</span></span><br><span class=\"line\">0     0 KUBE-SVC-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat | grep KUBE-SVC-7CWUT4JBGBRVUN2L -A 5</span></span><br><span class=\"line\">Chain KUBE-SVC-7CWUT4JBGBRVUN2L (1 references)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">0     0 KUBE-SEP-U2YYZT2C3O6VM4EV  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -&gt; 10.42.1.6:80 */ statistic mode random probability 0.50000000000</span><br><span class=\"line\">0     0 KUBE-SEP-GWUIQWA2TNZI4ESX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -&gt; 10.42.2.6:80 */</span><br></pre></td></tr></table></figure>\n<p> KUBE-SERVICES targetcluster ip 10.43.6.58 target  KUBE-SVC-7CWUT4JBGBRVUN2L<br><strong>KUBE-SVC-7CWUT4JBGBRVUN2L </strong></p>\n<ul>\n<li>target  Pod KUBE-SEP-U2YYZT2C3O6VM4EV  KUBE-SEP-GWUIQWA2TNZI4ESX </li>\n<li> KUBE-SEP-U2YYZT2C3O6VM4EV statistic mode random probability 0.50.5 iptable0.550%</li>\n<li> KUBE-SEP-U2YYZT2C3O6VM4EV target  target 50%</li>\n</ul>\n</li>\n<li><p> KUBE-SEP-U2YYZT2C3O6VM4EV  KUBE-SEP-GWUIQWA2TNZI4ESX </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat | grep KUBE-SEP-U2YYZT2C3O6VM4EV -A 3</span></span><br><span class=\"line\">Chain KUBE-SEP-U2YYZT2C3O6VM4EV (1 references)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">0     0 KUBE-MARK-MASQ  all  --  *      *       10.42.1.6            0.0.0.0/0            /* default/nginx-test:80-80 */</span><br><span class=\"line\">0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp to:10.42.1.6:80</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat | grep KUBE-SEP-GWUIQWA2TNZI4ESX -A 3</span></span><br><span class=\"line\">Chain KUBE-SEP-GWUIQWA2TNZI4ESX (1 references)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">0     0 KUBE-MARK-MASQ  all  --  *      *       10.42.2.6            0.0.0.0/0            /* default/nginx-test:80-80 */</span><br><span class=\"line\">0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp to:10.42.2.6:80</span><br></pre></td></tr></table></figure>\n<p>2target</p>\n<ul>\n<li>MASQengress(source ip)ingress</li>\n<li>DNATcluster ipDANTpodip 10.42.1.610.42.2.6port80 port</li>\n<li>iptabletarget10.42.1.6:8010.42.1.6:8010.42.2.6:8050%</li>\n<li>iptablePREROUTING chainDNAT10.42.1.610.42.2.6ip(ippodiphost network namespace)Forwarding chainhost network namespace</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip route</span></span><br><span class=\"line\">default via 192.168.205.1 dev enp0s1 proto dhcp src 192.168.205.4 metric 100</span><br><span class=\"line\">10.42.0.0/24 dev cni0 proto kernel scope link src 10.42.0.1</span><br><span class=\"line\">10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink</span><br><span class=\"line\">10.42.2.0/24 via 10.42.2.0 dev flannel.1 onlink</span><br><span class=\"line\">192.168.205.0/24 dev enp0s1 proto kernel scope link src 192.168.205.4 metric 100</span><br><span class=\"line\">192.168.205.1 dev enp0s1 proto dhcp scope link src 192.168.205.4 metric 100</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">10.42.1.610.42.2.6 flannel.1 vtep  node  pod</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>clusterip  service <ul>\n<li>pod network namespacehost netwok namespacedocker0</li>\n<li>host netwok namespace<strong>PREROUTING chain</strong>target</li>\n<li>targetiptableendpoint target</li>\n<li>endpoint targetDNATcluster ippodip</li>\n<li>cluster ipipdevice</li>\n<li>host(net.ipv4.ip_forward &#x3D; 1)</li>\n<li>host netwok namespaceDNAThost network namespace</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"3ipvs-\"><a href=\"#3ipvs-\" class=\"headerlink\" title=\"3ipvs \"></a>3ipvs </h4><ul>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393263&idx=1&sn=d6f27c502a007aa8be7e75b17afac42f&chksm=f1310b40c64682563cfbfd0688deb0fc9569eca3b13dc721bfe0ad7992183cabfba354e02050&scene=178&cur_album_id=2123526506718003213#rd\">https://mp.weixin.qq.com/s?__biz&#x3D;MzI0MDE3MjAzMg&#x3D;&#x3D;&amp;mid&#x3D;2648393263&amp;idx&#x3D;1&amp;sn&#x3D;d6f27c502a007aa8be7e75b17afac42f&amp;chksm&#x3D;f1310b40c64682563cfbfd0688deb0fc9569eca3b13dc721bfe0ad7992183cabfba354e02050&amp;scene&#x3D;178&amp;cur_album_id&#x3D;2123526506718003213#rd</a></li>\n<li><a href=\"https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/\">https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/</a></li>\n</ul>\n<h3 id=\"Servicenodeport-\"><a href=\"#Servicenodeport-\" class=\"headerlink\" title=\"Servicenodeport \"></a>Servicenodeport </h3><h4 id=\"1nodeport-ip-\"><a href=\"#1nodeport-ip-\" class=\"headerlink\" title=\"1nodeport ip \"></a>1nodeport ip </h4><p> &gt; cluster ip 30000-32767</p>\n<h4 id=\"2iptables--1\"><a href=\"#2iptables--1\" class=\"headerlink\" title=\"2iptables \"></a>2iptables </h4><ul>\n<li><p> service </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl describe service nginx-test</span></span><br><span class=\"line\">Name:                     nginx-test</span><br><span class=\"line\">Namespace:                default</span><br><span class=\"line\">Labels:                   app=nginx-test</span><br><span class=\"line\">Annotations:              &lt;none&gt;</span><br><span class=\"line\">Selector:                 app=nginx-test</span><br><span class=\"line\">Type:                     NodePort</span><br><span class=\"line\">IP Family Policy:         SingleStack</span><br><span class=\"line\">IP Families:              IPv4</span><br><span class=\"line\">IP:                       10.43.6.58</span><br><span class=\"line\">IPs:                      10.43.6.58</span><br><span class=\"line\">Port:                     80-80  80/TCP</span><br><span class=\"line\">TargetPort:               80/TCP</span><br><span class=\"line\">NodePort:                 80-80  32506/TCP</span><br><span class=\"line\">Endpoints:                10.42.1.6:80,10.42.2.6:80</span><br><span class=\"line\">Session Affinity:         None</span><br><span class=\"line\">External Traffic Policy:  Cluster</span><br><span class=\"line\">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure>\n<p>node portservicehostporthosthosthost network namespacePREROUTING chainhost network namespacePREROUTING chain</p>\n</li>\n<li><p> iptables</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |<span class=\"built_in\">head</span></span></span><br><span class=\"line\">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">323 20898 KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span><br></pre></td></tr></table></figure>\n<p>PREROUTING chainKUBE-SERVICEStarget</p>\n</li>\n<li><p> KUBE-SERVICES target</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |grep KUBE-SERVICES -A 10</span></span><br><span class=\"line\">Chain KUBE-SERVICES (2 references)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">0     0 KUBE-SVC-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80</span><br></pre></td></tr></table></figure>\n<p>KUBE-SERVICES target nginx-test-service host 32506  KUBE-NODEPORTS target</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |grep KUBE-NODEPORTS -A 3</span></span><br><span class=\"line\">Chain KUBE-NODEPORTS (1 references)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">2   124 KUBE-EXT-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp dpt:32506</span><br></pre></td></tr></table></figure>\n<p>KUBE-NODEPORTS target 32506  KUBE-EXT-7CWUT4JBGBRVUN2L  target </p>\n</li>\n<li><p> KUBE-EXT-7CWUT4JBGBRVUN2L  target</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |grep KUBE-EXT-7CWUT4JBGBRVUN2L -A 5</span></span><br><span class=\"line\">Chain KUBE-EXT-7CWUT4JBGBRVUN2L (1 references)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">    2   124 KUBE-MARK-MASQ  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* masquerade traffic for default/nginx-test:80-80 external destinations */</span><br><span class=\"line\">    2   124 KUBE-SVC-7CWUT4JBGBRVUN2L  all  --  *      *       0.0.0.0/0            0.0.0.0/0</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |grep KUBE-MARK-MASQ -A 3</span></span><br><span class=\"line\">Chain KUBE-MARK-MASQ (20 references)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">    2   124 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            MARK or 0x4000</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |grep KUBE-SVC-7CWUT4JBGBRVUN2L -A 5</span></span><br><span class=\"line\">Chain KUBE-SVC-7CWUT4JBGBRVUN2L (2 references)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">    0     0 KUBE-MARK-MASQ  tcp  --  *      *      !10.42.0.0/16         10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80</span><br><span class=\"line\">    1    64 KUBE-SEP-U2YYZT2C3O6VM4EV  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -&gt; 10.42.1.6:80 */ statistic mode random probability 0.50000000000</span><br><span class=\"line\">    1    60 KUBE-SEP-GWUIQWA2TNZI4ESX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -&gt; 10.42.2.6:80 */</span><br></pre></td></tr></table></figure>\n<p> KUBE-EXT-7CWUT4JBGBRVUN2L  target</p>\n<ul>\n<li>KUBE-MARK-MASQ  nat target</li>\n<li>KUBE-SVC-7CWUT4JBGBRVUN2L target  cluster ip  Pod</li>\n</ul>\n</li>\n<li><p>nodeport  service </p>\n<ul>\n<li>host netwok namespacePREROUTING chainKUBE-SERVICES target</li>\n<li>KUBE-SERVICES targetKUBE-NODEPORTS target</li>\n<li>KUBE-NODEPORTS targetprotKUBE-SVC-XXX target</li>\n<li>KUBE-SVC-XXX targetcluster-ipservice Pod </li>\n</ul>\n</li>\n</ul>\n<h4 id=\"3ipvs--1\"><a href=\"#3ipvs--1\" class=\"headerlink\" title=\"3ipvs \"></a>3ipvs </h4><ul>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393266&idx=1&sn=34d2a21b06d6e9ef4f4f7415f2cad567&chksm=f1310b5dc646824b45cbfc8cf25b0f2449f7223006b684da06ba58d95a2be7a3f0ad7aa6c4b9&scene=178&cur_album_id=2123526506718003213#rd\">https://mp.weixin.qq.com/s?__biz&#x3D;MzI0MDE3MjAzMg&#x3D;&#x3D;&amp;mid&#x3D;2648393266&amp;idx&#x3D;1&amp;sn&#x3D;34d2a21b06d6e9ef4f4f7415f2cad567&amp;chksm&#x3D;f1310b5dc646824b45cbfc8cf25b0f2449f7223006b684da06ba58d95a2be7a3f0ad7aa6c4b9&amp;scene&#x3D;178&amp;cur_album_id&#x3D;2123526506718003213#rd</a></li>\n<li><a href=\"https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/\">https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/</a></li>\n</ul>\n<h3 id=\"Serviceipvs--iptables-\"><a href=\"#Serviceipvs--iptables-\" class=\"headerlink\" title=\"Serviceipvs  iptables \"></a>Serviceipvs  iptables </h3><blockquote>\n<p> ipvs  k8s </p>\n<ul>\n<li>linux 2.4.x</li>\n<li> kube-proxy proxy-mode&#x3D;ipvs</li>\n<li> ipvsadm  ipvs </li>\n</ul>\n</blockquote>\n<ul>\n<li><p>linuxendpoint</p>\n</li>\n<li><p>iptablelinux netfilter&#x2F;iptable</p>\n</li>\n<li><p>ipvslinux netfilter&#x2F;iptableipsetipvs</p>\n</li>\n<li><p>iptablehostipatbleentryserviceendpoints10cluster ipserviceservice6endpointsKUBE-SERVICES target10entries(KUBE-SVC-XXX)10serviceKUBE-SVC-XXX target6KUBE-SEP-XXX6endpointsKUBE-SEP-XXX2enrtiesmark masqDNAT10<em>6</em>2&#x3D;120entriesiptableapplicationserviceendpointsiptable entries</p>\n</li>\n<li><p>ipvshostiptableentryiptableipset(KUBE-CLUSTER-IPKUBE-NODE-PORT-TCP)serviceipsetiptableiptableentriesserviceendpoints</p>\n</li>\n<li><p>iptablerandomipvsround-robinleast connectionsource hash<a href=\"http://www.linuxvirtualserver.org/%EF%BC%89%EF%BC%8C%E5%B9%B6%E4%B8%94%E7%94%B1kubelet%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0--ipvs-scheduler%E6%8E%A7%E5%88%B6%E3%80%82\">http://www.linuxvirtualserver.org/kubelet--ipvs-scheduler</a></p>\n</li>\n<li><p>iptablelinuxDNATipvsipvs</p>\n</li>\n<li><p>ipvshost netwok namespacekube-ipvs0cluster ipcluster-ipserviceINPUT chainipvs</p>\n</li>\n<li><p>iptablehost netwok namespace</p>\n</li>\n<li><p>iptablehost network namespacechainPREROUTING&gt;FORWARDING&gt;POSTROUTING PREROUTING chainmark masq</p>\n</li>\n<li><p>ipvshost network namespacechainPREROUTING&gt;INPUT&gt;POSTROUTING PREROUTING chainmark masq SNATINPUT chainipvs</p>\n</li>\n<li><p>iptableipvshost network namespace</p>\n</li>\n</ul>\n<h3 id=\"flannel-\"><a href=\"#flannel-\" class=\"headerlink\" title=\"flannel \"></a>flannel </h3><h4 id=\"1flannel-underlay-host-gw-\"><a href=\"#1flannel-underlay-host-gw-\" class=\"headerlink\" title=\"1flannel underlay host-gw \"></a>1flannel underlay host-gw </h4><p><strong>underlay </strong></p>\n<ul>\n<li><p>underlay </p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p><strong>service  Pod </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl describe service nginx-test</span></span><br><span class=\"line\">Name:              nginx-test</span><br><span class=\"line\">Namespace:         default</span><br><span class=\"line\">Labels:            app=nginx-test</span><br><span class=\"line\">Annotations:       &lt;none&gt;</span><br><span class=\"line\">Selector:          app=nginx-test</span><br><span class=\"line\">Type:              ClusterIP</span><br><span class=\"line\">IP Family Policy:  SingleStack</span><br><span class=\"line\">IP Families:       IPv4</span><br><span class=\"line\">IP:                10.43.6.58</span><br><span class=\"line\">IPs:               10.43.6.58</span><br><span class=\"line\">Port:              80-80  80/TCP</span><br><span class=\"line\">TargetPort:        80/TCP</span><br><span class=\"line\">Endpoints:         10.42.0.65:80,10.42.1.9:80</span><br><span class=\"line\">Session Affinity:  None</span><br><span class=\"line\">Events:            &lt;none&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl get pod -owide</span></span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS      AGE   IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">nginx-test-7646687cc4-n8s9s   1/1     Running   6 (60m ago)   26d   10.42.0.65   master   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">nginx-test-7646687cc4-z8xnq   1/1     Running   0             47s   10.42.1.9    node1    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>\n\n<p><strong>10.42.0.6510.42.1.9</strong></p>\n<ul>\n<li> pod </li>\n</ul>\n<p>pod <strong>10.42.0.65</strong>pod <strong>10.42.1.9</strong>pod <strong>10.42.0.65</strong>vethpod network namespace<strong>10.42.0.1</strong>network namespacecni0 linux bridgepod <strong>10.42.0.65</strong>vethattachcni0 bridgecni0 bridepodnetwork namesapcehostnetwork namespace</p>\n<ul>\n<li> pod </li>\n</ul>\n<p>ip<strong>10.42.1.9</strong>pod <strong>10.42.0.65</strong>ip<strong>192.168.205.4</strong>(net.ipv4.ip_forward &#x3D; 1)ip <strong>10.42.1.9</strong>ip<strong>192.168.205.4</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip route</span></span><br><span class=\"line\">10.42.1.0/24 via 192.168.205.3 enp0s1 ...</span><br></pre></td></tr></table></figure>\n<p><strong>10.42.1.0&#x2F;24</strong><strong>192.168.205.3</strong>pod <strong>10.42.1.9</strong>arpmac<strong>192.168.205.3</strong>podpodhostpodhostpodhostpodhostpodhostflannelunderlayhost gwk8s worker node(ip)</p>\n<ul>\n<li> pod </li>\n</ul>\n<p>pod <strong>10.42.1.9</strong>host <strong>192.168.205.3</strong>()pod(net.ipv4.ip_forward &#x3D; 1)ip <strong>10.42.1.9 <strong>ip</strong>192.168.205.3</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.3</span></span><br><span class=\"line\">    inet 192.168.205.3/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip route</span></span><br><span class=\"line\">10.42.1.0/24 dev cni0 proto kernel scope link src 10.42.1.1</span><br></pre></td></tr></table></figure>\n<p><strong>10.42.1.0&#x2F;24</strong>cni0 cni  <strong>10.42.1.1</strong> linux bridgeveth pairhost network namespacepod<strong>10.42.1.9</strong>network namespacepodpod kubectl debug </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl debug -it nginx-test-7646687cc4-z8xnq --image=busybox -- /bin/sh</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">traceroute 10.42.1.9</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>flannel underlayhost-gw </strong></p>\n<ul>\n<li>podnetwork namespacehost network namespacecni0 linux bridge</li>\n<li>podhostpodhost</li>\n<li>podhostpodhost mac </li>\n<li>podhostpod</li>\n<li>(net.ipv4.ip_forward &#x3D; 1)</li>\n<li>podhost</li>\n</ul>\n<h4 id=\"2flannel-overlay-vxlan-\"><a href=\"#2flannel-overlay-vxlan-\" class=\"headerlink\" title=\"2flannel overlay vxlan \"></a>2flannel overlay vxlan </h4><p><strong>overlay </strong></p>\n<ul>\n<li></li>\n</ul>\n<p>vxlan overlay  vlan  vlan 412bit4000 vlan vxlan header824bit1600 vxlan<a href=\"https://tools.ietf.org/html/rfc7348\">vxlan</a></p>\n<ul>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393268&idx=1&sn=ea7df945f11a57619a81df8599bcbe99&chksm=f1310b5bc646824daaf9ac6cb2dec4b8c8f54fdf4753b5379db991c88e4e5951ec928b9da2d9&scene=178&cur_album_id=2123526506718003213#rd\"></a></li>\n</ul>\n<p>1. vxlan  vxlan  udp  payload  eth mtu 15001450<br>2.vxlan  udp etcd  udp 84728472 udp port </p>\n<p><strong>service  Pod </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl describe service nginx-test</span></span><br><span class=\"line\">Name:              nginx-test</span><br><span class=\"line\">Namespace:         default</span><br><span class=\"line\">Labels:            app=nginx-test</span><br><span class=\"line\">Annotations:       &lt;none&gt;</span><br><span class=\"line\">Selector:          app=nginx-test</span><br><span class=\"line\">Type:              ClusterIP</span><br><span class=\"line\">IP Family Policy:  SingleStack</span><br><span class=\"line\">IP Families:       IPv4</span><br><span class=\"line\">IP:                10.43.6.58</span><br><span class=\"line\">IPs:               10.43.6.58</span><br><span class=\"line\">Port:              80-80  80/TCP</span><br><span class=\"line\">TargetPort:        80/TCP</span><br><span class=\"line\">Endpoints:         10.42.0.65:80,10.42.1.9:80</span><br><span class=\"line\">Session Affinity:  None</span><br><span class=\"line\">Events:            &lt;none&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl get pod -owide</span></span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS      AGE   IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">nginx-test-7646687cc4-n8s9s   1/1     Running   6 (60m ago)   26d   10.42.0.65   master   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">nginx-test-7646687cc4-z8xnq   1/1     Running   0             47s   10.42.1.9    node1    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>\n\n<p><strong>kubectl debug  pod 10.42.0.65</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl debug -it nginx-test-7646687cc4-n8s9s --image=busybox -- /bin/sh</span></span><br><span class=\"line\">/ # ping -c 3 10.42.1.9</span><br><span class=\"line\">PING 10.42.1.9 (10.42.1.9): 56 data bytes</span><br><span class=\"line\">64 bytes from 10.42.1.9: seq=0 ttl=62 time=1.447 ms</span><br><span class=\"line\">64 bytes from 10.42.1.9: seq=1 ttl=62 time=2.732 ms</span><br><span class=\"line\">64 bytes from 10.42.1.9: seq=2 ttl=62 time=0.880 ms</span><br><span class=\"line\">/ # traceroute -n 10.42.1.9</span><br><span class=\"line\">traceroute to 10.42.1.9 (10.42.1.9), 30 hops max, 46 byte packets</span><br><span class=\"line\"> 1  10.42.0.1  0.027 ms  0.012 ms  0.009 ms</span><br><span class=\"line\"> 2  10.42.1.0  1.761 ms  1.440 ms  1.085 ms</span><br><span class=\"line\"> 3  10.42.1.9  1.453 ms  0.979 ms  0.976 ms</span><br></pre></td></tr></table></figure>\n\n<p><strong>10.42.0.6510.42.1.9</strong></p>\n<ul>\n<li> pod namespace network </li>\n</ul>\n<p>ip<strong>10.42.0.65</strong>podnetwork namespacepod <strong>10.42.1.9</strong><strong>10.42.0.65</strong> pod network namespace<strong>10.42.0.65</strong> pod<strong>192.168.205.4</strong>network namespacelinux bridge cni0</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip route</span></span><br><span class=\"line\">10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink</span><br></pre></td></tr></table></figure>\n<p><strong>10.42.1.0&#x2F;24</strong>ip<strong>10.42.1.0</strong>flannel.1flannel.1 flannel vxlanvxlanethudp.1vxlanid1vxlanetcdip<strong>10.42.0.65</strong>ip<strong>10.42.1.9</strong>macpod <strong>10.42.0.65</strong> network namespacevethmacmacip **10.42.1.0&#x2F;32 **mac</p>\n<ul>\n<li> vtep  mac </li>\n</ul>\n<p> mac pod <strong>10.42.0.65</strong><strong>192.168.205.4</strong>arp<strong>10.42.1.0&#x2F;32</strong>mac 62:c8:a9:ce:ca:4e</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip neighbo |grep 10.42.1.0</span></span><br><span class=\"line\">10.42.1.0 dev flannel.1 lladdr 62:c8:a9:ce:ca:4e PERMANENT</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip neighbo show dev flannel.1</span></span><br><span class=\"line\">10.42.1.0 lladdr 62:c8:a9:ce:ca:4e PERMANENT</span><br><span class=\"line\">10.42.2.0 lladdr ca:cb:1f:99:10:97 PERMANENT</span><br></pre></td></tr></table></figure>\n<p> mac flannel.1vxlanmacpod <strong>10.42.0.65</strong><strong>192.168.205.4</strong>flannel.1mac</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge fdb show |grep 62:c8:a9:ce:ca:4e</span></span><br><span class=\"line\">62:c8:a9:ce:ca:4e dev flannel.1 dst 192.168.205.3 self permanent</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge fdb show dev flannel.1</span></span><br><span class=\"line\">62:c8:a9:ce:ca:4e dst 192.168.205.3 self permanent</span><br><span class=\"line\">ee:87:b2:4a:fd:62 dst 192.168.205.5 self permanent</span><br></pre></td></tr></table></figure>\n<p> flannel.1mac <strong>62:c8:a9:ce:ca:4e</strong>  <strong>192.168.205.3</strong>flannel.1(ip<strong>10.42.0.65</strong>ip<strong>10.42.1.9</strong>mac pod <strong>10.42.0.65</strong> network namespacevethmacmac<strong>10.42.1.0&#x2F;32</strong> mac) upd  payload  **192.168.205.3 ** **8472 **pod **10.42.1.9 ** <strong>192.168.205.3</strong>flannel.18472upd</p>\n<ul>\n<li><p>flannel.1  udp </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">route -n</span></span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         192.168.205.1   0.0.0.0         UG    100    0        0 enp0s1</span><br><span class=\"line\">192.168.205.0   0.0.0.0         255.255.255.0   U     100    0        0 enp0s1</span><br><span class=\"line\">192.168.205.1   0.0.0.0         255.255.255.255 UH    100    0        0 enp0s1</span><br></pre></td></tr></table></figure>\n<p>flannel.1  udp pod **10.42.0.65 ** <strong>192.168.205.4</strong>  <strong>192.168.205.0&#x2F;24</strong>  enp0s1 </p>\n<ul>\n<li>udpip<strong>192.168.205.4</strong>ip<strong>192.168.205.3</strong>mac<strong>192.168.205.4</strong> macmac<strong>192.168.205.3</strong> mac8472vxlan id1.</li>\n<li>ip<strong>10.42.0.65</strong>ip<strong>10.42.1.9</strong>macpod <strong>10.42.0.65</strong> network namespacevethmacmac<strong>10.42.1.0&#x2F;32</strong> mac</li>\n<li> <strong>192.168.205.3</strong></li>\n</ul>\n</li>\n</ul>\n<p>flannel.1  udp  **192.168.205.3 **</p>\n<ul>\n<li><p><strong>192.168.205.3</strong>8472udpvxlan id1linuxvxlanvxlan idvxlanvxlan1vxlan id1vxlan<strong>192.168.205.3</strong>flannel.1</p>\n</li>\n<li><p>flannel.1vxlan udpupdipportmacpayload</p>\n</li>\n<li><p>ip<strong>10.42.0.65</strong>ip<strong>10.42.1.9</strong></p>\n</li>\n<li><p><strong>192.168.205.3</strong>linux bridge cni0cni0  linux bridge  veth pair  pod <strong>10.42.1.9</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.3</span></span><br><span class=\"line\">    inet 192.168.205.3/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">route -n</span></span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">10.42.1.0       0.0.0.0         255.255.255.0   U     0      0        0 cni0</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>host  flannel.1macfdb </p>\n</li>\n</ul>\n<p>hostflannelflanneletcdhostcidrcidrflannel.1ipmachostcidrflannel.1ipmacflannelfdb **192.168.205.4 **</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">~# </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge fdb show dev flannel.1</span></span><br><span class=\"line\">62:c8:a9:ce:ca:4e dst 192.168.205.3 self permanent</span><br><span class=\"line\">ee:87:b2:4a:fd:62 dst 192.168.205.5 self permanent</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">etcdctl ....</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>flannel overlayvxlan </strong></p>\n<ul>\n<li>flannel.xvxlanvxlanudpupd8472()</li>\n<li>podnetwork namespacehostnetwork namespace</li>\n<li>host network namespaceipvxlaniphostflannel.x</li>\n<li>host network namespaceapripmac</li>\n<li>host network namespacefbdipmacip</li>\n<li>hostflannel.xipmacipupd<ul>\n<li>udpiphost ipipmacipmachost ipmacmacfdbipmac8472()vxlan id1().</li>\n<li>ippod ipippod ipmacpod macmachost network namespaceipmac(podhostflannel.xip)</li>\n</ul>\n</li>\n<li>hosthost</li>\n<li>host8472udpvxlan id.linux vxlanvxlan idvxlan</li>\n<li>vxlanvxlan udpupdipportmacpayloadpod ippod ip</li>\n<li>hostlinux bridge cni0</li>\n<li>linux bridge cni0veth pairpod</li>\n<li>hostflanneletcdvxlanhostmacfdb</li>\n</ul>\n<h4 id=\"3flannel-underlay--overlay-\"><a href=\"#3flannel-underlay--overlay-\" class=\"headerlink\" title=\"3flannel underlay  overlay \"></a>3flannel underlay  overlay </h4><ul>\n<li>host(net.ipv4.ip_forward &#x3D; 1)</li>\n<li>flannel underlay</li>\n<li>flannel underlayworker nodepodunderlayworker node</li>\n<li>flannel vxlan overlay  udp  worker nodeworker node</li>\n<li>flannel vxlan overlaylinux vxlan</li>\n<li>flannel underlayflannel vxlan overlay</li>\n</ul>\n<blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>1k8s <br><a href=\"https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0MDE3MjAzMg==&action=getalbum&album_id=2123526506718003213&scene=173&from_msgid=2648393229&from_itemidx=1&count=3&nolastread=1#wechat_redirect\">https://mp.weixin.qq.com/mp/appmsgalbum?__biz&#x3D;MzI0MDE3MjAzMg&#x3D;&#x3D;&amp;action&#x3D;getalbum&amp;album_id&#x3D;2123526506718003213&amp;scene&#x3D;173&amp;from_msgid&#x3D;2648393229&amp;from_itemidx&#x3D;1&amp;count&#x3D;3&amp;nolastread&#x3D;1#wechat_redirect</a><br>2iptables <br><a href=\"https://lixiangyun.gitbook.io/iptables_doc_zh_cn/\">https://lixiangyun.gitbook.io/iptables_doc_zh_cn&#x2F;</a><br><a href=\"https://www.jianshu.com/p/ee4ee15d3658\">https://www.jianshu.com/p/ee4ee15d3658</a><br>3Docker <a href=\"https://developer.aliyun.com/article/974008#slide-4\">https://developer.aliyun.com/article/974008#slide-4</a><br>4ipvs <a href=\"https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/\">https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/</a></p>\n</blockquote>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":21199,"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h4><ul>\n<li>Linux Network Namespace<ul>\n<li>linux network interface deviceloopback devicebridge deviceveth devicetun&#x2F;tap devicevxlan deviceip tunnel device </li>\n<li>linux  ip arp  ip  mac fdb mac  mac  </li>\n<li>linux  ethernet  ip icmp tcp&#x2F;udp </li>\n<li>linux iptable netfilter  linux  firewall  ingress  engressnat </li></ul></li></ul>","more":"\n\n\n\n<img data-src=\"/posts/5d90/k8s-nw1.png\" class>\n<blockquote>\n<p>linux  network namespace  pid namespace user namespace mount namespace ipc namespace uts namespace <br> cgroup  cpumemoryio </p>\n</blockquote>\n<ul>\n<li>Linux Bridge Device</li>\n</ul>\n<p>linux  attach  linux linux bridgeiplinuxattachbridgeip()bridgeattachbridge</p>\n<img data-src=\"/posts/5d90/k8s-nw2.png\" class>\n\n<ul>\n<li>Linux Veth Device</li>\n</ul>\n<p> peer  peer  peerveth pair  network namespace</p>\n<img data-src=\"/posts/5d90/k8s-nw3.png\" class>\n\n<h4 id=\"2k8s-\"><a href=\"#2k8s-\" class=\"headerlink\" title=\"2k8s \"></a>2k8s </h4><ul>\n<li></li>\n</ul>\n<p>kube-proxy proxy-module&#x3D;ipvs<br>iptables<br>ipvsv1.11 </p>\n<ul>\n<li></li>\n</ul>\n<p>underlayflannel host-gwcalico bgp  ip_forword <br>overlayflannel vxlancalico ipipflannel udp </p>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><table>\n<thead>\n<tr>\n<th> IP</th>\n<th></th>\n<th> CIDR</th>\n<th>CNI </th>\n<th>Flannel.1 vtep </th>\n</tr>\n</thead>\n<tbody><tr>\n<td>192.168.205.4</td>\n<td>master</td>\n<td>10.42.0.0&#x2F;24</td>\n<td>10.42.0.1</td>\n<td>10.42.0.0</td>\n</tr>\n<tr>\n<td>192.168.205.3</td>\n<td>node1</td>\n<td>10.42.1.0&#x2F;24</td>\n<td>10.42.1.1</td>\n<td>10.42.1.0</td>\n</tr>\n<tr>\n<td>192.168.205.5</td>\n<td>node2</td>\n<td>10.42.2.0&#x2F;24</td>\n<td>10.42.2.1</td>\n<td>10.42.2.0</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1docker-\"><a href=\"#1docker-\" class=\"headerlink\" title=\"1docker \"></a>1docker </h4><ul>\n<li>bridge net&#x3D;bridge</li>\n</ul>\n<p> docker0  IP  IP</p>\n<blockquote>\n<img data-src=\"/posts/5d90/k8s-nw4.png\" class>\n<p> bridge  network namespace </p>\n<img data-src=\"/posts/5d90/k8s-nw5.png\" class>\n</blockquote>\n<ul>\n<li>host net&#x3D;host</li>\n</ul>\n<p></p>\n<img data-src=\"/posts/5d90/k8s-nw6.png\" class>\n\n<ul>\n<li>contaniner net&#x3D;container:name or id</li>\n</ul>\n<p> Network namespacek8s  pod  network namespace  lo </p>\n<img data-src=\"/posts/5d90/k8s-nw7.png\" class>\n\n<ul>\n<li>none  Network namespace  CPU </li>\n</ul>\n<h4 id=\"2docker-\"><a href=\"#2docker-\" class=\"headerlink\" title=\"2docker \"></a>2docker </h4><ul>\n<li>containernetwork namespacecontainerarpiptablecontainernetwork namespace</li>\n<li>default netwok nemespacelinux bridgedocker0</li>\n<li>containerveth paircontainernetwork namespaceattachnetworkwork namespacedocker0 linux bridge</li>\n<li>(docker0 bridge)containercontainer</li>\n</ul>\n<img data-src=\"/posts/5d90/k8s-nw8.png\" class>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># </span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> bridge </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">k8s pod  infrastructure  network namespace  veth pair</span></span><br><span class=\"line\">brctl show</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> veth pair </span></span><br><span class=\"line\">ip addr</span><br><span class=\"line\">ip -d link show</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">route -n</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> docker </span></span><br><span class=\"line\">docker ps/inspect/container</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Servicecluster-ip-\"><a href=\"#Servicecluster-ip-\" class=\"headerlink\" title=\"Servicecluster ip \"></a>Servicecluster ip </h3><h4 id=\"1cluster-ip-\"><a href=\"#1cluster-ip-\" class=\"headerlink\" title=\"1cluster ip \"></a>1cluster ip </h4><p>k8s  service cluster ip cluster ip  endpoints pod  cluster ip  cluster ip  endpoints  iptables  ipvs</p>\n<h4 id=\"2iptables-\"><a href=\"#2iptables-\" class=\"headerlink\" title=\"2iptables \"></a>2iptables </h4><ul>\n<li><p> service cluster ip  endpoints ip</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl describe service nginx-test</span></span><br><span class=\"line\">Name:              nginx-test</span><br><span class=\"line\">Namespace:         default</span><br><span class=\"line\">Labels:            app=nginx-test</span><br><span class=\"line\">Annotations:       &lt;none&gt;</span><br><span class=\"line\">Selector:          app=nginx-test</span><br><span class=\"line\">Type:              ClusterIP</span><br><span class=\"line\">IP Family Policy:  SingleStack</span><br><span class=\"line\">IP Families:       IPv4</span><br><span class=\"line\">IP:                10.43.6.58</span><br><span class=\"line\">IPs:               10.43.6.58</span><br><span class=\"line\">Port:              80-80  80/TCP</span><br><span class=\"line\">TargetPort:        80/TCP</span><br><span class=\"line\">Endpoints:         10.42.1.6:80,10.42.2.6:80</span><br></pre></td></tr></table></figure>\n</li>\n<li><p> iptables </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |<span class=\"built_in\">head</span></span></span><br><span class=\"line\">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">298 19090 KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span><br><span class=\"line\">202 12456 CNI-HOSTPORT-DNAT  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span><br></pre></td></tr></table></figure>\n<p> PREROUTING chain  KUBE-SERVICES  target  PREROUTING chain  pod  curl <a href=\"http://10.43.6.58\">http://10.43.6.58</a></p>\n<ul>\n<li>podcluster ip(<strong>10.43.6.58</strong>)</li>\n<li>podipnetwok namespace <strong>docker0  cni0</strong> ip</li>\n<li>podeth0 deviceeth0veth pairpod network namespaceattachnetwok namespace <strong>docker0  cni0</strong> bridge</li>\n<li>veth pairpod network namespaceattached<strong>docker0  cni0</strong> bridge</li>\n<li><strong>docker0  cni0</strong> bridgehost network namesapce  PREROUTING chain</li>\n</ul>\n</li>\n<li><p> KUBE-SERVICES target</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat | grep 10.43.6.58</span></span><br><span class=\"line\">0     0 KUBE-SVC-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat | grep KUBE-SVC-7CWUT4JBGBRVUN2L -A 5</span></span><br><span class=\"line\">Chain KUBE-SVC-7CWUT4JBGBRVUN2L (1 references)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">0     0 KUBE-SEP-U2YYZT2C3O6VM4EV  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -&gt; 10.42.1.6:80 */ statistic mode random probability 0.50000000000</span><br><span class=\"line\">0     0 KUBE-SEP-GWUIQWA2TNZI4ESX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -&gt; 10.42.2.6:80 */</span><br></pre></td></tr></table></figure>\n<p> KUBE-SERVICES targetcluster ip 10.43.6.58 target  KUBE-SVC-7CWUT4JBGBRVUN2L<br><strong>KUBE-SVC-7CWUT4JBGBRVUN2L </strong></p>\n<ul>\n<li>target  Pod KUBE-SEP-U2YYZT2C3O6VM4EV  KUBE-SEP-GWUIQWA2TNZI4ESX </li>\n<li> KUBE-SEP-U2YYZT2C3O6VM4EV statistic mode random probability 0.50.5 iptable0.550%</li>\n<li> KUBE-SEP-U2YYZT2C3O6VM4EV target  target 50%</li>\n</ul>\n</li>\n<li><p> KUBE-SEP-U2YYZT2C3O6VM4EV  KUBE-SEP-GWUIQWA2TNZI4ESX </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat | grep KUBE-SEP-U2YYZT2C3O6VM4EV -A 3</span></span><br><span class=\"line\">Chain KUBE-SEP-U2YYZT2C3O6VM4EV (1 references)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">0     0 KUBE-MARK-MASQ  all  --  *      *       10.42.1.6            0.0.0.0/0            /* default/nginx-test:80-80 */</span><br><span class=\"line\">0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp to:10.42.1.6:80</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat | grep KUBE-SEP-GWUIQWA2TNZI4ESX -A 3</span></span><br><span class=\"line\">Chain KUBE-SEP-GWUIQWA2TNZI4ESX (1 references)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">0     0 KUBE-MARK-MASQ  all  --  *      *       10.42.2.6            0.0.0.0/0            /* default/nginx-test:80-80 */</span><br><span class=\"line\">0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp to:10.42.2.6:80</span><br></pre></td></tr></table></figure>\n<p>2target</p>\n<ul>\n<li>MASQengress(source ip)ingress</li>\n<li>DNATcluster ipDANTpodip 10.42.1.610.42.2.6port80 port</li>\n<li>iptabletarget10.42.1.6:8010.42.1.6:8010.42.2.6:8050%</li>\n<li>iptablePREROUTING chainDNAT10.42.1.610.42.2.6ip(ippodiphost network namespace)Forwarding chainhost network namespace</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip route</span></span><br><span class=\"line\">default via 192.168.205.1 dev enp0s1 proto dhcp src 192.168.205.4 metric 100</span><br><span class=\"line\">10.42.0.0/24 dev cni0 proto kernel scope link src 10.42.0.1</span><br><span class=\"line\">10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink</span><br><span class=\"line\">10.42.2.0/24 via 10.42.2.0 dev flannel.1 onlink</span><br><span class=\"line\">192.168.205.0/24 dev enp0s1 proto kernel scope link src 192.168.205.4 metric 100</span><br><span class=\"line\">192.168.205.1 dev enp0s1 proto dhcp scope link src 192.168.205.4 metric 100</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">10.42.1.610.42.2.6 flannel.1 vtep  node  pod</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>clusterip  service <ul>\n<li>pod network namespacehost netwok namespacedocker0</li>\n<li>host netwok namespace<strong>PREROUTING chain</strong>target</li>\n<li>targetiptableendpoint target</li>\n<li>endpoint targetDNATcluster ippodip</li>\n<li>cluster ipipdevice</li>\n<li>host(net.ipv4.ip_forward &#x3D; 1)</li>\n<li>host netwok namespaceDNAThost network namespace</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"3ipvs-\"><a href=\"#3ipvs-\" class=\"headerlink\" title=\"3ipvs \"></a>3ipvs </h4><ul>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393263&idx=1&sn=d6f27c502a007aa8be7e75b17afac42f&chksm=f1310b40c64682563cfbfd0688deb0fc9569eca3b13dc721bfe0ad7992183cabfba354e02050&scene=178&cur_album_id=2123526506718003213#rd\">https://mp.weixin.qq.com/s?__biz&#x3D;MzI0MDE3MjAzMg&#x3D;&#x3D;&amp;mid&#x3D;2648393263&amp;idx&#x3D;1&amp;sn&#x3D;d6f27c502a007aa8be7e75b17afac42f&amp;chksm&#x3D;f1310b40c64682563cfbfd0688deb0fc9569eca3b13dc721bfe0ad7992183cabfba354e02050&amp;scene&#x3D;178&amp;cur_album_id&#x3D;2123526506718003213#rd</a></li>\n<li><a href=\"https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/\">https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/</a></li>\n</ul>\n<h3 id=\"Servicenodeport-\"><a href=\"#Servicenodeport-\" class=\"headerlink\" title=\"Servicenodeport \"></a>Servicenodeport </h3><h4 id=\"1nodeport-ip-\"><a href=\"#1nodeport-ip-\" class=\"headerlink\" title=\"1nodeport ip \"></a>1nodeport ip </h4><p> &gt; cluster ip 30000-32767</p>\n<h4 id=\"2iptables--1\"><a href=\"#2iptables--1\" class=\"headerlink\" title=\"2iptables \"></a>2iptables </h4><ul>\n<li><p> service </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl describe service nginx-test</span></span><br><span class=\"line\">Name:                     nginx-test</span><br><span class=\"line\">Namespace:                default</span><br><span class=\"line\">Labels:                   app=nginx-test</span><br><span class=\"line\">Annotations:              &lt;none&gt;</span><br><span class=\"line\">Selector:                 app=nginx-test</span><br><span class=\"line\">Type:                     NodePort</span><br><span class=\"line\">IP Family Policy:         SingleStack</span><br><span class=\"line\">IP Families:              IPv4</span><br><span class=\"line\">IP:                       10.43.6.58</span><br><span class=\"line\">IPs:                      10.43.6.58</span><br><span class=\"line\">Port:                     80-80  80/TCP</span><br><span class=\"line\">TargetPort:               80/TCP</span><br><span class=\"line\">NodePort:                 80-80  32506/TCP</span><br><span class=\"line\">Endpoints:                10.42.1.6:80,10.42.2.6:80</span><br><span class=\"line\">Session Affinity:         None</span><br><span class=\"line\">External Traffic Policy:  Cluster</span><br><span class=\"line\">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure>\n<p>node portservicehostporthosthosthost network namespacePREROUTING chainhost network namespacePREROUTING chain</p>\n</li>\n<li><p> iptables</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |<span class=\"built_in\">head</span></span></span><br><span class=\"line\">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">323 20898 KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span><br></pre></td></tr></table></figure>\n<p>PREROUTING chainKUBE-SERVICEStarget</p>\n</li>\n<li><p> KUBE-SERVICES target</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |grep KUBE-SERVICES -A 10</span></span><br><span class=\"line\">Chain KUBE-SERVICES (2 references)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">0     0 KUBE-SVC-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80</span><br></pre></td></tr></table></figure>\n<p>KUBE-SERVICES target nginx-test-service host 32506  KUBE-NODEPORTS target</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |grep KUBE-NODEPORTS -A 3</span></span><br><span class=\"line\">Chain KUBE-NODEPORTS (1 references)</span><br><span class=\"line\">pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">2   124 KUBE-EXT-7CWUT4JBGBRVUN2L  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 */ tcp dpt:32506</span><br></pre></td></tr></table></figure>\n<p>KUBE-NODEPORTS target 32506  KUBE-EXT-7CWUT4JBGBRVUN2L  target </p>\n</li>\n<li><p> KUBE-EXT-7CWUT4JBGBRVUN2L  target</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |grep KUBE-EXT-7CWUT4JBGBRVUN2L -A 5</span></span><br><span class=\"line\">Chain KUBE-EXT-7CWUT4JBGBRVUN2L (1 references)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">    2   124 KUBE-MARK-MASQ  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* masquerade traffic for default/nginx-test:80-80 external destinations */</span><br><span class=\"line\">    2   124 KUBE-SVC-7CWUT4JBGBRVUN2L  all  --  *      *       0.0.0.0/0            0.0.0.0/0</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |grep KUBE-MARK-MASQ -A 3</span></span><br><span class=\"line\">Chain KUBE-MARK-MASQ (20 references)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">    2   124 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            MARK or 0x4000</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">iptables -nvL -t nat |grep KUBE-SVC-7CWUT4JBGBRVUN2L -A 5</span></span><br><span class=\"line\">Chain KUBE-SVC-7CWUT4JBGBRVUN2L (2 references)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">    0     0 KUBE-MARK-MASQ  tcp  --  *      *      !10.42.0.0/16         10.43.6.58           /* default/nginx-test:80-80 cluster IP */ tcp dpt:80</span><br><span class=\"line\">    1    64 KUBE-SEP-U2YYZT2C3O6VM4EV  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -&gt; 10.42.1.6:80 */ statistic mode random probability 0.50000000000</span><br><span class=\"line\">    1    60 KUBE-SEP-GWUIQWA2TNZI4ESX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-test:80-80 -&gt; 10.42.2.6:80 */</span><br></pre></td></tr></table></figure>\n<p> KUBE-EXT-7CWUT4JBGBRVUN2L  target</p>\n<ul>\n<li>KUBE-MARK-MASQ  nat target</li>\n<li>KUBE-SVC-7CWUT4JBGBRVUN2L target  cluster ip  Pod</li>\n</ul>\n</li>\n<li><p>nodeport  service </p>\n<ul>\n<li>host netwok namespacePREROUTING chainKUBE-SERVICES target</li>\n<li>KUBE-SERVICES targetKUBE-NODEPORTS target</li>\n<li>KUBE-NODEPORTS targetprotKUBE-SVC-XXX target</li>\n<li>KUBE-SVC-XXX targetcluster-ipservice Pod </li>\n</ul>\n</li>\n</ul>\n<h4 id=\"3ipvs--1\"><a href=\"#3ipvs--1\" class=\"headerlink\" title=\"3ipvs \"></a>3ipvs </h4><ul>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393266&idx=1&sn=34d2a21b06d6e9ef4f4f7415f2cad567&chksm=f1310b5dc646824b45cbfc8cf25b0f2449f7223006b684da06ba58d95a2be7a3f0ad7aa6c4b9&scene=178&cur_album_id=2123526506718003213#rd\">https://mp.weixin.qq.com/s?__biz&#x3D;MzI0MDE3MjAzMg&#x3D;&#x3D;&amp;mid&#x3D;2648393266&amp;idx&#x3D;1&amp;sn&#x3D;34d2a21b06d6e9ef4f4f7415f2cad567&amp;chksm&#x3D;f1310b5dc646824b45cbfc8cf25b0f2449f7223006b684da06ba58d95a2be7a3f0ad7aa6c4b9&amp;scene&#x3D;178&amp;cur_album_id&#x3D;2123526506718003213#rd</a></li>\n<li><a href=\"https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/\">https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/</a></li>\n</ul>\n<h3 id=\"Serviceipvs--iptables-\"><a href=\"#Serviceipvs--iptables-\" class=\"headerlink\" title=\"Serviceipvs  iptables \"></a>Serviceipvs  iptables </h3><blockquote>\n<p> ipvs  k8s </p>\n<ul>\n<li>linux 2.4.x</li>\n<li> kube-proxy proxy-mode&#x3D;ipvs</li>\n<li> ipvsadm  ipvs </li>\n</ul>\n</blockquote>\n<ul>\n<li><p>linuxendpoint</p>\n</li>\n<li><p>iptablelinux netfilter&#x2F;iptable</p>\n</li>\n<li><p>ipvslinux netfilter&#x2F;iptableipsetipvs</p>\n</li>\n<li><p>iptablehostipatbleentryserviceendpoints10cluster ipserviceservice6endpointsKUBE-SERVICES target10entries(KUBE-SVC-XXX)10serviceKUBE-SVC-XXX target6KUBE-SEP-XXX6endpointsKUBE-SEP-XXX2enrtiesmark masqDNAT10<em>6</em>2&#x3D;120entriesiptableapplicationserviceendpointsiptable entries</p>\n</li>\n<li><p>ipvshostiptableentryiptableipset(KUBE-CLUSTER-IPKUBE-NODE-PORT-TCP)serviceipsetiptableiptableentriesserviceendpoints</p>\n</li>\n<li><p>iptablerandomipvsround-robinleast connectionsource hash<a href=\"http://www.linuxvirtualserver.org/%EF%BC%89%EF%BC%8C%E5%B9%B6%E4%B8%94%E7%94%B1kubelet%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0--ipvs-scheduler%E6%8E%A7%E5%88%B6%E3%80%82\">http://www.linuxvirtualserver.org/kubelet--ipvs-scheduler</a></p>\n</li>\n<li><p>iptablelinuxDNATipvsipvs</p>\n</li>\n<li><p>ipvshost netwok namespacekube-ipvs0cluster ipcluster-ipserviceINPUT chainipvs</p>\n</li>\n<li><p>iptablehost netwok namespace</p>\n</li>\n<li><p>iptablehost network namespacechainPREROUTING&gt;FORWARDING&gt;POSTROUTING PREROUTING chainmark masq</p>\n</li>\n<li><p>ipvshost network namespacechainPREROUTING&gt;INPUT&gt;POSTROUTING PREROUTING chainmark masq SNATINPUT chainipvs</p>\n</li>\n<li><p>iptableipvshost network namespace</p>\n</li>\n</ul>\n<h3 id=\"flannel-\"><a href=\"#flannel-\" class=\"headerlink\" title=\"flannel \"></a>flannel </h3><h4 id=\"1flannel-underlay-host-gw-\"><a href=\"#1flannel-underlay-host-gw-\" class=\"headerlink\" title=\"1flannel underlay host-gw \"></a>1flannel underlay host-gw </h4><p><strong>underlay </strong></p>\n<ul>\n<li><p>underlay </p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p><strong>service  Pod </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl describe service nginx-test</span></span><br><span class=\"line\">Name:              nginx-test</span><br><span class=\"line\">Namespace:         default</span><br><span class=\"line\">Labels:            app=nginx-test</span><br><span class=\"line\">Annotations:       &lt;none&gt;</span><br><span class=\"line\">Selector:          app=nginx-test</span><br><span class=\"line\">Type:              ClusterIP</span><br><span class=\"line\">IP Family Policy:  SingleStack</span><br><span class=\"line\">IP Families:       IPv4</span><br><span class=\"line\">IP:                10.43.6.58</span><br><span class=\"line\">IPs:               10.43.6.58</span><br><span class=\"line\">Port:              80-80  80/TCP</span><br><span class=\"line\">TargetPort:        80/TCP</span><br><span class=\"line\">Endpoints:         10.42.0.65:80,10.42.1.9:80</span><br><span class=\"line\">Session Affinity:  None</span><br><span class=\"line\">Events:            &lt;none&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl get pod -owide</span></span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS      AGE   IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">nginx-test-7646687cc4-n8s9s   1/1     Running   6 (60m ago)   26d   10.42.0.65   master   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">nginx-test-7646687cc4-z8xnq   1/1     Running   0             47s   10.42.1.9    node1    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>\n\n<p><strong>10.42.0.6510.42.1.9</strong></p>\n<ul>\n<li> pod </li>\n</ul>\n<p>pod <strong>10.42.0.65</strong>pod <strong>10.42.1.9</strong>pod <strong>10.42.0.65</strong>vethpod network namespace<strong>10.42.0.1</strong>network namespacecni0 linux bridgepod <strong>10.42.0.65</strong>vethattachcni0 bridgecni0 bridepodnetwork namesapcehostnetwork namespace</p>\n<ul>\n<li> pod </li>\n</ul>\n<p>ip<strong>10.42.1.9</strong>pod <strong>10.42.0.65</strong>ip<strong>192.168.205.4</strong>(net.ipv4.ip_forward &#x3D; 1)ip <strong>10.42.1.9</strong>ip<strong>192.168.205.4</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip route</span></span><br><span class=\"line\">10.42.1.0/24 via 192.168.205.3 enp0s1 ...</span><br></pre></td></tr></table></figure>\n<p><strong>10.42.1.0&#x2F;24</strong><strong>192.168.205.3</strong>pod <strong>10.42.1.9</strong>arpmac<strong>192.168.205.3</strong>podpodhostpodhostpodhostpodhostpodhostflannelunderlayhost gwk8s worker node(ip)</p>\n<ul>\n<li> pod </li>\n</ul>\n<p>pod <strong>10.42.1.9</strong>host <strong>192.168.205.3</strong>()pod(net.ipv4.ip_forward &#x3D; 1)ip <strong>10.42.1.9 <strong>ip</strong>192.168.205.3</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.3</span></span><br><span class=\"line\">    inet 192.168.205.3/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip route</span></span><br><span class=\"line\">10.42.1.0/24 dev cni0 proto kernel scope link src 10.42.1.1</span><br></pre></td></tr></table></figure>\n<p><strong>10.42.1.0&#x2F;24</strong>cni0 cni  <strong>10.42.1.1</strong> linux bridgeveth pairhost network namespacepod<strong>10.42.1.9</strong>network namespacepodpod kubectl debug </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl debug -it nginx-test-7646687cc4-z8xnq --image=busybox -- /bin/sh</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">traceroute 10.42.1.9</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>flannel underlayhost-gw </strong></p>\n<ul>\n<li>podnetwork namespacehost network namespacecni0 linux bridge</li>\n<li>podhostpodhost</li>\n<li>podhostpodhost mac </li>\n<li>podhostpod</li>\n<li>(net.ipv4.ip_forward &#x3D; 1)</li>\n<li>podhost</li>\n</ul>\n<h4 id=\"2flannel-overlay-vxlan-\"><a href=\"#2flannel-overlay-vxlan-\" class=\"headerlink\" title=\"2flannel overlay vxlan \"></a>2flannel overlay vxlan </h4><p><strong>overlay </strong></p>\n<ul>\n<li></li>\n</ul>\n<p>vxlan overlay  vlan  vlan 412bit4000 vlan vxlan header824bit1600 vxlan<a href=\"https://tools.ietf.org/html/rfc7348\">vxlan</a></p>\n<ul>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI0MDE3MjAzMg==&mid=2648393268&idx=1&sn=ea7df945f11a57619a81df8599bcbe99&chksm=f1310b5bc646824daaf9ac6cb2dec4b8c8f54fdf4753b5379db991c88e4e5951ec928b9da2d9&scene=178&cur_album_id=2123526506718003213#rd\"></a></li>\n</ul>\n<p>1. vxlan  vxlan  udp  payload  eth mtu 15001450<br>2.vxlan  udp etcd  udp 84728472 udp port </p>\n<p><strong>service  Pod </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl describe service nginx-test</span></span><br><span class=\"line\">Name:              nginx-test</span><br><span class=\"line\">Namespace:         default</span><br><span class=\"line\">Labels:            app=nginx-test</span><br><span class=\"line\">Annotations:       &lt;none&gt;</span><br><span class=\"line\">Selector:          app=nginx-test</span><br><span class=\"line\">Type:              ClusterIP</span><br><span class=\"line\">IP Family Policy:  SingleStack</span><br><span class=\"line\">IP Families:       IPv4</span><br><span class=\"line\">IP:                10.43.6.58</span><br><span class=\"line\">IPs:               10.43.6.58</span><br><span class=\"line\">Port:              80-80  80/TCP</span><br><span class=\"line\">TargetPort:        80/TCP</span><br><span class=\"line\">Endpoints:         10.42.0.65:80,10.42.1.9:80</span><br><span class=\"line\">Session Affinity:  None</span><br><span class=\"line\">Events:            &lt;none&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl get pod -owide</span></span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS      AGE   IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">nginx-test-7646687cc4-n8s9s   1/1     Running   6 (60m ago)   26d   10.42.0.65   master   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">nginx-test-7646687cc4-z8xnq   1/1     Running   0             47s   10.42.1.9    node1    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>\n\n<p><strong>kubectl debug  pod 10.42.0.65</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl debug -it nginx-test-7646687cc4-n8s9s --image=busybox -- /bin/sh</span></span><br><span class=\"line\">/ # ping -c 3 10.42.1.9</span><br><span class=\"line\">PING 10.42.1.9 (10.42.1.9): 56 data bytes</span><br><span class=\"line\">64 bytes from 10.42.1.9: seq=0 ttl=62 time=1.447 ms</span><br><span class=\"line\">64 bytes from 10.42.1.9: seq=1 ttl=62 time=2.732 ms</span><br><span class=\"line\">64 bytes from 10.42.1.9: seq=2 ttl=62 time=0.880 ms</span><br><span class=\"line\">/ # traceroute -n 10.42.1.9</span><br><span class=\"line\">traceroute to 10.42.1.9 (10.42.1.9), 30 hops max, 46 byte packets</span><br><span class=\"line\"> 1  10.42.0.1  0.027 ms  0.012 ms  0.009 ms</span><br><span class=\"line\"> 2  10.42.1.0  1.761 ms  1.440 ms  1.085 ms</span><br><span class=\"line\"> 3  10.42.1.9  1.453 ms  0.979 ms  0.976 ms</span><br></pre></td></tr></table></figure>\n\n<p><strong>10.42.0.6510.42.1.9</strong></p>\n<ul>\n<li> pod namespace network </li>\n</ul>\n<p>ip<strong>10.42.0.65</strong>podnetwork namespacepod <strong>10.42.1.9</strong><strong>10.42.0.65</strong> pod network namespace<strong>10.42.0.65</strong> pod<strong>192.168.205.4</strong>network namespacelinux bridge cni0</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip route</span></span><br><span class=\"line\">10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink</span><br></pre></td></tr></table></figure>\n<p><strong>10.42.1.0&#x2F;24</strong>ip<strong>10.42.1.0</strong>flannel.1flannel.1 flannel vxlanvxlanethudp.1vxlanid1vxlanetcdip<strong>10.42.0.65</strong>ip<strong>10.42.1.9</strong>macpod <strong>10.42.0.65</strong> network namespacevethmacmacip **10.42.1.0&#x2F;32 **mac</p>\n<ul>\n<li> vtep  mac </li>\n</ul>\n<p> mac pod <strong>10.42.0.65</strong><strong>192.168.205.4</strong>arp<strong>10.42.1.0&#x2F;32</strong>mac 62:c8:a9:ce:ca:4e</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip neighbo |grep 10.42.1.0</span></span><br><span class=\"line\">10.42.1.0 dev flannel.1 lladdr 62:c8:a9:ce:ca:4e PERMANENT</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip neighbo show dev flannel.1</span></span><br><span class=\"line\">10.42.1.0 lladdr 62:c8:a9:ce:ca:4e PERMANENT</span><br><span class=\"line\">10.42.2.0 lladdr ca:cb:1f:99:10:97 PERMANENT</span><br></pre></td></tr></table></figure>\n<p> mac flannel.1vxlanmacpod <strong>10.42.0.65</strong><strong>192.168.205.4</strong>flannel.1mac</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge fdb show |grep 62:c8:a9:ce:ca:4e</span></span><br><span class=\"line\">62:c8:a9:ce:ca:4e dev flannel.1 dst 192.168.205.3 self permanent</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge fdb show dev flannel.1</span></span><br><span class=\"line\">62:c8:a9:ce:ca:4e dst 192.168.205.3 self permanent</span><br><span class=\"line\">ee:87:b2:4a:fd:62 dst 192.168.205.5 self permanent</span><br></pre></td></tr></table></figure>\n<p> flannel.1mac <strong>62:c8:a9:ce:ca:4e</strong>  <strong>192.168.205.3</strong>flannel.1(ip<strong>10.42.0.65</strong>ip<strong>10.42.1.9</strong>mac pod <strong>10.42.0.65</strong> network namespacevethmacmac<strong>10.42.1.0&#x2F;32</strong> mac) upd  payload  **192.168.205.3 ** **8472 **pod **10.42.1.9 ** <strong>192.168.205.3</strong>flannel.18472upd</p>\n<ul>\n<li><p>flannel.1  udp </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">route -n</span></span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         192.168.205.1   0.0.0.0         UG    100    0        0 enp0s1</span><br><span class=\"line\">192.168.205.0   0.0.0.0         255.255.255.0   U     100    0        0 enp0s1</span><br><span class=\"line\">192.168.205.1   0.0.0.0         255.255.255.255 UH    100    0        0 enp0s1</span><br></pre></td></tr></table></figure>\n<p>flannel.1  udp pod **10.42.0.65 ** <strong>192.168.205.4</strong>  <strong>192.168.205.0&#x2F;24</strong>  enp0s1 </p>\n<ul>\n<li>udpip<strong>192.168.205.4</strong>ip<strong>192.168.205.3</strong>mac<strong>192.168.205.4</strong> macmac<strong>192.168.205.3</strong> mac8472vxlan id1.</li>\n<li>ip<strong>10.42.0.65</strong>ip<strong>10.42.1.9</strong>macpod <strong>10.42.0.65</strong> network namespacevethmacmac<strong>10.42.1.0&#x2F;32</strong> mac</li>\n<li> <strong>192.168.205.3</strong></li>\n</ul>\n</li>\n</ul>\n<p>flannel.1  udp  **192.168.205.3 **</p>\n<ul>\n<li><p><strong>192.168.205.3</strong>8472udpvxlan id1linuxvxlanvxlan idvxlanvxlan1vxlan id1vxlan<strong>192.168.205.3</strong>flannel.1</p>\n</li>\n<li><p>flannel.1vxlan udpupdipportmacpayload</p>\n</li>\n<li><p>ip<strong>10.42.0.65</strong>ip<strong>10.42.1.9</strong></p>\n</li>\n<li><p><strong>192.168.205.3</strong>linux bridge cni0cni0  linux bridge  veth pair  pod <strong>10.42.1.9</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ip addr |grep 192.168.205.3</span></span><br><span class=\"line\">    inet 192.168.205.3/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">route -n</span></span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">10.42.1.0       0.0.0.0         255.255.255.0   U     0      0        0 cni0</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>host  flannel.1macfdb </p>\n</li>\n</ul>\n<p>hostflannelflanneletcdhostcidrcidrflannel.1ipmachostcidrflannel.1ipmacflannelfdb **192.168.205.4 **</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">~# </span><span class=\"language-bash\">ip addr |grep 192.168.205.4</span></span><br><span class=\"line\">    inet 192.168.205.4/24 metric 100 brd 192.168.205.255 scope global dynamic enp0s1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">bridge fdb show dev flannel.1</span></span><br><span class=\"line\">62:c8:a9:ce:ca:4e dst 192.168.205.3 self permanent</span><br><span class=\"line\">ee:87:b2:4a:fd:62 dst 192.168.205.5 self permanent</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">etcdctl ....</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>flannel overlayvxlan </strong></p>\n<ul>\n<li>flannel.xvxlanvxlanudpupd8472()</li>\n<li>podnetwork namespacehostnetwork namespace</li>\n<li>host network namespaceipvxlaniphostflannel.x</li>\n<li>host network namespaceapripmac</li>\n<li>host network namespacefbdipmacip</li>\n<li>hostflannel.xipmacipupd<ul>\n<li>udpiphost ipipmacipmachost ipmacmacfdbipmac8472()vxlan id1().</li>\n<li>ippod ipippod ipmacpod macmachost network namespaceipmac(podhostflannel.xip)</li>\n</ul>\n</li>\n<li>hosthost</li>\n<li>host8472udpvxlan id.linux vxlanvxlan idvxlan</li>\n<li>vxlanvxlan udpupdipportmacpayloadpod ippod ip</li>\n<li>hostlinux bridge cni0</li>\n<li>linux bridge cni0veth pairpod</li>\n<li>hostflanneletcdvxlanhostmacfdb</li>\n</ul>\n<h4 id=\"3flannel-underlay--overlay-\"><a href=\"#3flannel-underlay--overlay-\" class=\"headerlink\" title=\"3flannel underlay  overlay \"></a>3flannel underlay  overlay </h4><ul>\n<li>host(net.ipv4.ip_forward &#x3D; 1)</li>\n<li>flannel underlay</li>\n<li>flannel underlayworker nodepodunderlayworker node</li>\n<li>flannel vxlan overlay  udp  worker nodeworker node</li>\n<li>flannel vxlan overlaylinux vxlan</li>\n<li>flannel underlayflannel vxlan overlay</li>\n</ul>\n<blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>1k8s <br><a href=\"https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0MDE3MjAzMg==&action=getalbum&album_id=2123526506718003213&scene=173&from_msgid=2648393229&from_itemidx=1&count=3&nolastread=1#wechat_redirect\">https://mp.weixin.qq.com/mp/appmsgalbum?__biz&#x3D;MzI0MDE3MjAzMg&#x3D;&#x3D;&amp;action&#x3D;getalbum&amp;album_id&#x3D;2123526506718003213&amp;scene&#x3D;173&amp;from_msgid&#x3D;2648393229&amp;from_itemidx&#x3D;1&amp;count&#x3D;3&amp;nolastread&#x3D;1#wechat_redirect</a><br>2iptables <br><a href=\"https://lixiangyun.gitbook.io/iptables_doc_zh_cn/\">https://lixiangyun.gitbook.io/iptables_doc_zh_cn&#x2F;</a><br><a href=\"https://www.jianshu.com/p/ee4ee15d3658\">https://www.jianshu.com/p/ee4ee15d3658</a><br>3Docker <a href=\"https://developer.aliyun.com/article/974008#slide-4\">https://developer.aliyun.com/article/974008#slide-4</a><br>4ipvs <a href=\"https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/\">https://icloudnative.io/posts/ipvs-how-kubernetes-services-direct-traffic-to-pods/</a></p>\n</blockquote>"},{"title":"Kubernetes-RBAC ","abbrlink":"fa45","date":"2022-03-01T15:55:02.000Z","_content":"### RBAC\n{% asset_img gaisu.png %}\n#### 1) RBAC  API \n\n- RoleClusterRolePod\n- ClusterRole\n   - Node\n   - /healthz\n   - Pods\n> secrets\n- RoleBinding\n- ClusterRoleBinding\n> UserGroupService AccountRoleBindingClusterRoleBinding\n\n\n**RoleClusterRole**\n- rulesAlicloudRAMPolicy\n- RoleClusterRole\n\n<!--more-->\n\n**RoleBindingClusterRoleBindingUserGroupServiceAccountRoleClusterRoleAlicloudRAMPolicyRAMRAM**\n- UserGroupServiceAccount  Kubernetes [https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2](https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2)\n- RoleBinding  namespace  Role  RoleBinding  ClusterRole  ClusterRole  RoleBinding  namespace\n-  ClusterRole  namespace ClusterRoleBinding\n- RoleBinding  ClusterRole  RoleBinding  namespace  ClusterRole  namespace  namespace \n\n#### 2) \n\n- EndpointURLpodGET /api/v1/namaspaces/{namespace}/pods/{podname}/log\n- RBAC/\n\nPodPod log resources\n```yaml\nrules:\n- apiGroups: [\"\"]\n   resources: [\"pods\",\"pods/log\"]\n   verbs: [\"get\",\"list\"]\n```\n\n- ResourceNameResourceNamegetdeleteupdatepatch\n\nmy-configmapConFigmapgetupdate\n```yaml\nrules:\n- apiGroups: [\"\"]\n   resources: [\"configmap\"]\n   resourceNames: [\"my-configmap\"]\n   verbs: [\"get\",\"update\"]\n```\n\n\n#### 3) rules \n+ apiGroupsAPI\"apiVersion: batch/v1\"\n+ resourcespodsdeplaymentsjobs\n+ resourceNames: resource\n+ verbs\n> api-resources\n> apiGroupsapi-resources\n>\n> [API GROUP](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#-strong-api-groups-strong-)\n> - kubectl explain xxx  xxx \"kubectl api-resources\"  NAME  VERSION v1 Core API \"\"  podsservices\n> - kubectl get --raw /apis/apps/v1\n> \n\n kubectl get --raw /apis/rbac.authorization.k8s.io/v1  RBAC  API \n{% asset_img c31775e8bbe3.png %}\n\n> /\n> - kubectl create -f xxx.yaml       -->   \n> - kubectl create --arg1=xxx --arg2=yyy     -->  kubectl edit\n\n\n### ServiceAccount \n#### 1)  serviceaccount \n1.  serviceaccount  camel-sva defalut namespace\nkubectl create serviceaccount camel-sva -n default\n{% asset_img 634be995b5bc.png %}\n\n2.  role  IntegrationKameletKameletBinding 3 curd \nkubectl create role camel-sva-role --verb=\\* --resource=integrations,kamelets,kameletbindings \n{% asset_img 21812e1bbfad.png %}\n\n3. \nkubectl create rolebinding camel-sva-rolebinding --role=camel-sva-role --serviceaccount=default:camel-sva\n{% asset_img 7528aa1bf3da.png %}\n\n4.  secret \nkubectl get secret/camel-sva-token-mdt28 -oyaml\n{% asset_img de3ebdd4f016.png %}\n token  base64  apiserver  kubectl get --raw /apis/ \n{% asset_img 1572c2ebc891.png %}\n\n#### 2)  kubeconfig \n1. \nkubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.crt --server=\"https://10.0.0.142:6443\" --embed-certs=true --kubeconfig=./camel-sva.conf\n\n2.  tokenbase64\nD=$(kubectl get secret camel-sva-token-mdt28 -o jsonpath={.data.token}|base64 -d)\n\n3.  token \nkubectl config set-credentials camel-sva --token=$D --kubeconfig=./camel-sva.conf\n\n4.  content \nkubectl config set-context camel-sva@kubernetes --cluster=kubernetes --user=camel-sva --kubeconfig=./camel-sva.conf\n\n5. \nkubectl config use-context camel-sva@kubernetes --kubeconfig=./camel-sva.conf\n\ncamel-sva.conf copy  kubeconfig\n{% asset_img d6da8c845c41.png %}\n kubectl \n{% asset_img de4222775e67.png %}\n\n#### 3) API \n{% asset_img ab8f20ce2acc.png %}\n\n\n### \n1. [https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#service-account-permissions](https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#service-account-permissions)\n2. [https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2](https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2)\n3. [https://zhuanlan.zhihu.com/p/97793056](https://zhuanlan.zhihu.com/p/97793056)\n","source":"_posts/k8s-rbac.md","raw":"---\ntitle: Kubernetes-RBAC \ncategories:\n  - CNCF\ntags:\n  - Alicloud\n  - Kubernetes\nabbrlink: fa45\ndate: 2022-03-01 23:55:02\n---\n### RBAC\n{% asset_img gaisu.png %}\n#### 1) RBAC  API \n\n- RoleClusterRolePod\n- ClusterRole\n   - Node\n   - /healthz\n   - Pods\n> secrets\n- RoleBinding\n- ClusterRoleBinding\n> UserGroupService AccountRoleBindingClusterRoleBinding\n\n\n**RoleClusterRole**\n- rulesAlicloudRAMPolicy\n- RoleClusterRole\n\n<!--more-->\n\n**RoleBindingClusterRoleBindingUserGroupServiceAccountRoleClusterRoleAlicloudRAMPolicyRAMRAM**\n- UserGroupServiceAccount  Kubernetes [https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2](https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2)\n- RoleBinding  namespace  Role  RoleBinding  ClusterRole  ClusterRole  RoleBinding  namespace\n-  ClusterRole  namespace ClusterRoleBinding\n- RoleBinding  ClusterRole  RoleBinding  namespace  ClusterRole  namespace  namespace \n\n#### 2) \n\n- EndpointURLpodGET /api/v1/namaspaces/{namespace}/pods/{podname}/log\n- RBAC/\n\nPodPod log resources\n```yaml\nrules:\n- apiGroups: [\"\"]\n   resources: [\"pods\",\"pods/log\"]\n   verbs: [\"get\",\"list\"]\n```\n\n- ResourceNameResourceNamegetdeleteupdatepatch\n\nmy-configmapConFigmapgetupdate\n```yaml\nrules:\n- apiGroups: [\"\"]\n   resources: [\"configmap\"]\n   resourceNames: [\"my-configmap\"]\n   verbs: [\"get\",\"update\"]\n```\n\n\n#### 3) rules \n+ apiGroupsAPI\"apiVersion: batch/v1\"\n+ resourcespodsdeplaymentsjobs\n+ resourceNames: resource\n+ verbs\n> api-resources\n> apiGroupsapi-resources\n>\n> [API GROUP](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#-strong-api-groups-strong-)\n> - kubectl explain xxx  xxx \"kubectl api-resources\"  NAME  VERSION v1 Core API \"\"  podsservices\n> - kubectl get --raw /apis/apps/v1\n> \n\n kubectl get --raw /apis/rbac.authorization.k8s.io/v1  RBAC  API \n{% asset_img c31775e8bbe3.png %}\n\n> /\n> - kubectl create -f xxx.yaml       -->   \n> - kubectl create --arg1=xxx --arg2=yyy     -->  kubectl edit\n\n\n### ServiceAccount \n#### 1)  serviceaccount \n1.  serviceaccount  camel-sva defalut namespace\nkubectl create serviceaccount camel-sva -n default\n{% asset_img 634be995b5bc.png %}\n\n2.  role  IntegrationKameletKameletBinding 3 curd \nkubectl create role camel-sva-role --verb=\\* --resource=integrations,kamelets,kameletbindings \n{% asset_img 21812e1bbfad.png %}\n\n3. \nkubectl create rolebinding camel-sva-rolebinding --role=camel-sva-role --serviceaccount=default:camel-sva\n{% asset_img 7528aa1bf3da.png %}\n\n4.  secret \nkubectl get secret/camel-sva-token-mdt28 -oyaml\n{% asset_img de3ebdd4f016.png %}\n token  base64  apiserver  kubectl get --raw /apis/ \n{% asset_img 1572c2ebc891.png %}\n\n#### 2)  kubeconfig \n1. \nkubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.crt --server=\"https://10.0.0.142:6443\" --embed-certs=true --kubeconfig=./camel-sva.conf\n\n2.  tokenbase64\nD=$(kubectl get secret camel-sva-token-mdt28 -o jsonpath={.data.token}|base64 -d)\n\n3.  token \nkubectl config set-credentials camel-sva --token=$D --kubeconfig=./camel-sva.conf\n\n4.  content \nkubectl config set-context camel-sva@kubernetes --cluster=kubernetes --user=camel-sva --kubeconfig=./camel-sva.conf\n\n5. \nkubectl config use-context camel-sva@kubernetes --kubeconfig=./camel-sva.conf\n\ncamel-sva.conf copy  kubeconfig\n{% asset_img d6da8c845c41.png %}\n kubectl \n{% asset_img de4222775e67.png %}\n\n#### 3) API \n{% asset_img ab8f20ce2acc.png %}\n\n\n### \n1. [https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#service-account-permissions](https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#service-account-permissions)\n2. [https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2](https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2)\n3. [https://zhuanlan.zhihu.com/p/97793056](https://zhuanlan.zhihu.com/p/97793056)\n","slug":"k8s-rbac","published":1,"updated":"2024-01-21T15:28:43.155Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zp001ns0nj9rlw9lar","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"RBAC\"><a href=\"#RBAC\" class=\"headerlink\" title=\"RBAC\"></a>RBAC</h3><img data-src=\"/posts/fa45/gaisu.png\" class>\n<h4 id=\"1-RBAC--API-\"><a href=\"#1-RBAC--API-\" class=\"headerlink\" title=\"1) RBAC  API \"></a>1) RBAC  API </h4><ul>\n<li>RoleClusterRolePod</li>\n<li>ClusterRole<ul>\n<li>Node</li>\n<li>&#x2F;healthz</li>\n<li>Pods<blockquote>\n<p>secrets</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>RoleBinding</li>\n<li>ClusterRoleBinding<blockquote>\n<p>UserGroupService AccountRoleBindingClusterRoleBinding</p>\n</blockquote>\n</li>\n</ul>\n<p><strong>RoleClusterRole</strong></p>\n<ul>\n<li>rulesAlicloudRAMPolicy</li>\n<li>RoleClusterRole</li>\n</ul>\n<span id=\"more\"></span>\n\n<p><strong>RoleBindingClusterRoleBindingUserGroupServiceAccountRoleClusterRoleAlicloudRAMPolicyRAMRAM</strong></p>\n<ul>\n<li>UserGroupServiceAccount  Kubernetes <a href=\"https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2\">https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2</a></li>\n<li>RoleBinding  namespace  Role  RoleBinding  ClusterRole  ClusterRole  RoleBinding  namespace</li>\n<li> ClusterRole  namespace ClusterRoleBinding</li>\n<li>RoleBinding  ClusterRole  RoleBinding  namespace  ClusterRole  namespace  namespace </li>\n</ul>\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2) \"></a>2) </h4><ul>\n<li>EndpointURLpodGET &#x2F;api&#x2F;v1&#x2F;namaspaces&#x2F;{namespace}&#x2F;pods&#x2F;{podname}&#x2F;log</li>\n<li>RBAC&#x2F;</li>\n</ul>\n<p>PodPod log resources</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">   <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>,<span class=\"string\">&quot;pods/log&quot;</span>]</span><br><span class=\"line\">   <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>ResourceNameResourceNamegetdeleteupdatepatch</li>\n</ul>\n<p>my-configmapConFigmapgetupdate</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">   <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;configmap&quot;</span>]</span><br><span class=\"line\">   <span class=\"attr\">resourceNames:</span> [<span class=\"string\">&quot;my-configmap&quot;</span>]</span><br><span class=\"line\">   <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;update&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"3-rules-\"><a href=\"#3-rules-\" class=\"headerlink\" title=\"3) rules \"></a>3) rules </h4><ul>\n<li>apiGroupsAPIapiVersion: batch&#x2F;v1</li>\n<li>resourcespodsdeplaymentsjobs</li>\n<li>resourceNames: resource</li>\n<li>verbs<blockquote>\n<p>api-resources<br>apiGroupsapi-resources</p>\n<p><a href=\"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#-strong-api-groups-strong-\">API GROUP</a></p>\n<ul>\n<li>kubectl explain xxx  xxx kubectl api-resources  NAME  VERSION v1 Core API   podsservices</li>\n<li>kubectl get raw &#x2F;apis&#x2F;apps&#x2F;v1</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n<p> kubectl get raw &#x2F;apis&#x2F;rbac.authorization.k8s.io&#x2F;v1  RBAC  API </p>\n<img data-src=\"/posts/fa45/c31775e8bbe3.png\" class>\n\n<blockquote>\n<p>&#x2F;</p>\n<ul>\n<li>kubectl create -f xxx.yaml       &gt;   </li>\n<li>kubectl create arg1&#x3D;xxx arg2&#x3D;yyy     &gt;  kubectl edit</li>\n</ul>\n</blockquote>\n<h3 id=\"ServiceAccount-\"><a href=\"#ServiceAccount-\" class=\"headerlink\" title=\"ServiceAccount \"></a>ServiceAccount </h3><h4 id=\"1--serviceaccount-\"><a href=\"#1--serviceaccount-\" class=\"headerlink\" title=\"1)  serviceaccount \"></a>1)  serviceaccount </h4><ol>\n<li><p> serviceaccount  camel-sva defalut namespace<br>kubectl create serviceaccount camel-sva -n default</p>\n<img data-src=\"/posts/fa45/634be995b5bc.png\" class>\n</li>\n<li><p> role  IntegrationKameletKameletBinding 3 curd <br>kubectl create role camel-sva-role verb&#x3D;* resource&#x3D;integrations,kamelets,kameletbindings </p>\n<img data-src=\"/posts/fa45/21812e1bbfad.png\" class>\n</li>\n<li><p><br>kubectl create rolebinding camel-sva-rolebinding role&#x3D;camel-sva-role serviceaccount&#x3D;default:camel-sva</p>\n<img data-src=\"/posts/fa45/7528aa1bf3da.png\" class>\n</li>\n<li><p> secret <br>kubectl get secret&#x2F;camel-sva-token-mdt28 -oyaml</p>\n<img data-src=\"/posts/fa45/de3ebdd4f016.png\" class>\n<p> token  base64  apiserver  kubectl get raw &#x2F;apis&#x2F; </p>\n<img data-src=\"/posts/fa45/1572c2ebc891.png\" class></li>\n</ol>\n<h4 id=\"2--kubeconfig-\"><a href=\"#2--kubeconfig-\" class=\"headerlink\" title=\"2)  kubeconfig \"></a>2)  kubeconfig </h4><ol>\n<li><p><br>kubectl config set-cluster kubernetes certificate-authority&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.crt server&#x3D;<a href=\"https://10.0.0.142:6443&quot;\">https://10.0.0.142:6443&quot;</a> embed-certs&#x3D;true kubeconfig&#x3D;.&#x2F;camel-sva.conf</p>\n</li>\n<li><p> tokenbase64<br>D&#x3D;$(kubectl get secret camel-sva-token-mdt28 -o jsonpath&#x3D;{.data.token}|base64 -d)</p>\n</li>\n<li><p> token <br>kubectl config set-credentials camel-sva token&#x3D;$D kubeconfig&#x3D;.&#x2F;camel-sva.conf</p>\n</li>\n<li><p> content <br>kubectl config set-context camel-sva@kubernetes cluster&#x3D;kubernetes user&#x3D;camel-sva kubeconfig&#x3D;.&#x2F;camel-sva.conf</p>\n</li>\n<li><p><br>kubectl config use-context camel-sva@kubernetes kubeconfig&#x3D;.&#x2F;camel-sva.conf</p>\n</li>\n</ol>\n<p>camel-sva.conf copy  kubeconfig</p>\n<img data-src=\"/posts/fa45/d6da8c845c41.png\" class>\n<p> kubectl </p>\n<img data-src=\"/posts/fa45/de4222775e67.png\" class>\n\n<h4 id=\"3-API-\"><a href=\"#3-API-\" class=\"headerlink\" title=\"3) API \"></a>3) API </h4><img data-src=\"/posts/fa45/ab8f20ce2acc.png\" class>\n\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li><a href=\"https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#service-account-permissions\">https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#service-account-permissions</a></li>\n<li><a href=\"https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2\">https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/97793056\">https://zhuanlan.zhihu.com/p/97793056</a></li>\n</ol>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":3912,"excerpt":"<h3 id=\"RBAC\"><a href=\"#RBAC\" class=\"headerlink\" title=\"RBAC\"></a>RBAC</h3><img data-src=\"/posts/fa45/gaisu.png\" class>\n<h4 id=\"1-RBAC--API-\"><a href=\"#1-RBAC--API-\" class=\"headerlink\" title=\"1) RBAC  API \"></a>1) RBAC  API </h4><ul>\n<li>RoleClusterRolePod</li>\n<li>ClusterRole<ul>\n<li>Node</li>\n<li>&#x2F;healthz</li>\n<li>Pods<blockquote>\n<p>secrets</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>RoleBinding</li>\n<li>ClusterRoleBinding<blockquote>\n<p>UserGroupService AccountRoleBindingClusterRoleBinding</p>\n</blockquote>\n</li>\n</ul>\n<p><strong>RoleClusterRole</strong></p>\n<ul>\n<li>rulesAlicloudRAMPolicy</li>\n<li>RoleClusterRole</li>\n</ul>","more":"<p><strong>RoleBindingClusterRoleBindingUserGroupServiceAccountRoleClusterRoleAlicloudRAMPolicyRAMRAM</strong></p>\n<ul>\n<li>UserGroupServiceAccount  Kubernetes <a href=\"https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2\">https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2</a></li>\n<li>RoleBinding  namespace  Role  RoleBinding  ClusterRole  ClusterRole  RoleBinding  namespace</li>\n<li> ClusterRole  namespace ClusterRoleBinding</li>\n<li>RoleBinding  ClusterRole  RoleBinding  namespace  ClusterRole  namespace  namespace </li>\n</ul>\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2) \"></a>2) </h4><ul>\n<li>EndpointURLpodGET &#x2F;api&#x2F;v1&#x2F;namaspaces&#x2F;{namespace}&#x2F;pods&#x2F;{podname}&#x2F;log</li>\n<li>RBAC&#x2F;</li>\n</ul>\n<p>PodPod log resources</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">   <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>,<span class=\"string\">&quot;pods/log&quot;</span>]</span><br><span class=\"line\">   <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>ResourceNameResourceNamegetdeleteupdatepatch</li>\n</ul>\n<p>my-configmapConFigmapgetupdate</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">   <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;configmap&quot;</span>]</span><br><span class=\"line\">   <span class=\"attr\">resourceNames:</span> [<span class=\"string\">&quot;my-configmap&quot;</span>]</span><br><span class=\"line\">   <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;update&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"3-rules-\"><a href=\"#3-rules-\" class=\"headerlink\" title=\"3) rules \"></a>3) rules </h4><ul>\n<li>apiGroupsAPIapiVersion: batch&#x2F;v1</li>\n<li>resourcespodsdeplaymentsjobs</li>\n<li>resourceNames: resource</li>\n<li>verbs<blockquote>\n<p>api-resources<br>apiGroupsapi-resources</p>\n<p><a href=\"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#-strong-api-groups-strong-\">API GROUP</a></p>\n<ul>\n<li>kubectl explain xxx  xxx kubectl api-resources  NAME  VERSION v1 Core API   podsservices</li>\n<li>kubectl get raw &#x2F;apis&#x2F;apps&#x2F;v1</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n<p> kubectl get raw &#x2F;apis&#x2F;rbac.authorization.k8s.io&#x2F;v1  RBAC  API </p>\n<img data-src=\"/posts/fa45/c31775e8bbe3.png\" class>\n\n<blockquote>\n<p>&#x2F;</p>\n<ul>\n<li>kubectl create -f xxx.yaml       &gt;   </li>\n<li>kubectl create arg1&#x3D;xxx arg2&#x3D;yyy     &gt;  kubectl edit</li>\n</ul>\n</blockquote>\n<h3 id=\"ServiceAccount-\"><a href=\"#ServiceAccount-\" class=\"headerlink\" title=\"ServiceAccount \"></a>ServiceAccount </h3><h4 id=\"1--serviceaccount-\"><a href=\"#1--serviceaccount-\" class=\"headerlink\" title=\"1)  serviceaccount \"></a>1)  serviceaccount </h4><ol>\n<li><p> serviceaccount  camel-sva defalut namespace<br>kubectl create serviceaccount camel-sva -n default</p>\n<img data-src=\"/posts/fa45/634be995b5bc.png\" class>\n</li>\n<li><p> role  IntegrationKameletKameletBinding 3 curd <br>kubectl create role camel-sva-role verb&#x3D;* resource&#x3D;integrations,kamelets,kameletbindings </p>\n<img data-src=\"/posts/fa45/21812e1bbfad.png\" class>\n</li>\n<li><p><br>kubectl create rolebinding camel-sva-rolebinding role&#x3D;camel-sva-role serviceaccount&#x3D;default:camel-sva</p>\n<img data-src=\"/posts/fa45/7528aa1bf3da.png\" class>\n</li>\n<li><p> secret <br>kubectl get secret&#x2F;camel-sva-token-mdt28 -oyaml</p>\n<img data-src=\"/posts/fa45/de3ebdd4f016.png\" class>\n<p> token  base64  apiserver  kubectl get raw &#x2F;apis&#x2F; </p>\n<img data-src=\"/posts/fa45/1572c2ebc891.png\" class></li>\n</ol>\n<h4 id=\"2--kubeconfig-\"><a href=\"#2--kubeconfig-\" class=\"headerlink\" title=\"2)  kubeconfig \"></a>2)  kubeconfig </h4><ol>\n<li><p><br>kubectl config set-cluster kubernetes certificate-authority&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.crt server&#x3D;<a href=\"https://10.0.0.142:6443&quot;\">https://10.0.0.142:6443&quot;</a> embed-certs&#x3D;true kubeconfig&#x3D;.&#x2F;camel-sva.conf</p>\n</li>\n<li><p> tokenbase64<br>D&#x3D;$(kubectl get secret camel-sva-token-mdt28 -o jsonpath&#x3D;{.data.token}|base64 -d)</p>\n</li>\n<li><p> token <br>kubectl config set-credentials camel-sva token&#x3D;$D kubeconfig&#x3D;.&#x2F;camel-sva.conf</p>\n</li>\n<li><p> content <br>kubectl config set-context camel-sva@kubernetes cluster&#x3D;kubernetes user&#x3D;camel-sva kubeconfig&#x3D;.&#x2F;camel-sva.conf</p>\n</li>\n<li><p><br>kubectl config use-context camel-sva@kubernetes kubeconfig&#x3D;.&#x2F;camel-sva.conf</p>\n</li>\n</ol>\n<p>camel-sva.conf copy  kubeconfig</p>\n<img data-src=\"/posts/fa45/d6da8c845c41.png\" class>\n<p> kubectl </p>\n<img data-src=\"/posts/fa45/de4222775e67.png\" class>\n\n<h4 id=\"3-API-\"><a href=\"#3-API-\" class=\"headerlink\" title=\"3) API \"></a>3) API </h4><img data-src=\"/posts/fa45/ab8f20ce2acc.png\" class>\n\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li><a href=\"https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#service-account-permissions\">https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#service-account-permissions</a></li>\n<li><a href=\"https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2\">https://www.qikqiak.com/k8strain2/security/rbac/#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/97793056\">https://zhuanlan.zhihu.com/p/97793056</a></li>\n</ol>"},{"title":"-Fluentd ","abbrlink":"41fe","date":"2022-07-11T13:56:17.000Z","_content":"### \n**Fluentd**\n Kubernetes  node  fluentd + Elasticsearch\n{% asset_img fluent1.png %}\n> fluentd source --> parser --> filter --> output\n\n\n**Elasticsearch**\n\n\n**Kibana** \n Web GUI Elasticsearch  \n\n> \n> -  agent daemonSet\n> -  Pod  sidecar \n> - \n\n<!--more-->\n\n###  / \n#### \n[https://docs.fluentd.org/installation/before-install](https://docs.fluentd.org/installation/before-install)\n\n#### \n[https://hub.docker.com/r/fluent/fluentd](https://hub.docker.com/r/fluent/fluentd)\n\n### \n> fluentd  tag \n> source -> parser -> filter -> output\n\n#### input \n\n- **http http **\n```shell\n# \nmkdir /tmp/fluentd && cd /tmp/fluentd\ncat > fluent.conf << EOF\n<source>\n  @type http\n  port 9880\n  bind 0.0.0.0\n</source>\n\n<match **>\n  @type stdout\n</match>\nEOF\n\n#  fluentd  fluent.conf \ndocker run -p 9880:9880 --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n\n#  http \ncurl -X POST 127.0.0.1:9880/yakir.test -d 'json={\"a\":\"aaa\"}'\n```\n\n- **tail**\n```shell\ncat > fluent.conf << EOF\n<source>\n  @type tail\n  path /var/log/httpd-access.log\n  path_key tailed_path\n  pos_file /var/log/td-agent/httpd-access.log.pos\n  tag apache.access\n  <parse>\n    @type apache2\n  </parse>\n</source>\nEOF\n\n# \ndocker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n```\n\n- **exec event**\n```shell\ncat > fluent.conf << EOF\n<source>\n  @type exec\n  tag yakir.test\n  command cat /proc/loadavg | cut -d ' ' -f 1,2,3\n  run_interval 10s\n\n  <parse>\n    @type tsv\n    keys avg1,avg5,avg15\n    delimiter \" \"\n  </parse>\n</source>\n\n<match **>\n  @type stdout\n</match>\nEOF\n\n# \ndocker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n2022-06-30 08:43:20.377146682 +0000 yakir.test: {\"avg1\":\"0.12\",\"avg5\":\"0.16\",\"avg15\":\"0.17\"}\n2022-06-30 08:43:30.347891525 +0000 yakir.test: {\"avg1\":\"0.10\",\"avg5\":\"0.15\",\"avg15\":\"0.17\"}\n```\n\n- **syslog rsyslog  rsyslog **\n```shell\ncat > fluent.conf << EOF\n<source>\n    @type syslog\n    port 5140\n    bind 0.0.0.0\n    tag system\n</source>\n\n<match **>\n  @type stdout\n</match>\nEOF\n\n#  udp \ndocker run -p 5140:5140/udp --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n\n#  rsyslog  fluent\ncat >> /etc/rsyslog.d/50-default.conf << \"EOF\"\n*.* @127.0.0.1:5140\nEOF\n\n# logger \nlogger -p mail.info 'this is info message'\nlogger -p mail.warning 'this is warning message'\n2022-07-04 10:27:48.000000000 +0000 system.mail.info: {\"host\":\"minikube\",\"ident\":\"root\",\"message\":\"this is info message\"}\n2022-07-04 10:28:11.000000000 +0000 system.mail.warn: {\"host\":\"minikube\",\"ident\":\"root\",\"message\":\"this is warning message\"}\n```\n\n- **dummy**\n```shell\ncat > fluent.conf << \"EOF\"\n<source>\n    @type dummy\n    dummy {\"foo\": \"bar\"}\n    size 3\n    rate 1\n    tag yakir.test\n    auto_increment_key primary_key\n    suspend true\n</source>\n\n<match **>\n  @type stdout\n</match>\nEOF\n\n#\nsize     # event \nrate     # event\nauto_increment_key   #\nsuspend              #\n\n# \ndocker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n2022-07-04 02:51:37.044796145 +0000 yakir.test: {\"foo\":\"bar\",\"primary_key\":0}\n2022-07-04 02:51:37.044834743 +0000 yakir.test: {\"foo\":\"bar\",\"primary_key\":1}\n```\n\n- **forward fluentd forward  event**\n```shell\n<source>\n  @type forward\n  port 24224\n  bind 0.0.0.0\n</source>\n```\n#### output \n\n- **file event **\n```shell\ncat > fluent.conf << \"EOF\"\n<source>\n  @type dummy\n  dummy {\"foo\": \"bar\"}\n  tag yakir.test\n  size 1\n  rate 1\n</source>\n\n<match yakir.**>\n  @type file\n  path /tmp/fluent/yakir\n  compress gzip\n  <buffer>\n    timekey 1d\n    timekey_use_utc true\n    timekey_wait 10m\n  </buffer>\n  \n  #@type file\n  #path /tmp/${tag[0]}/file.%Y-%m-%d-%H-%M-%S\n  #<buffer tag,time>\n  #  timekey 10\n  #  timekey_wait 10\n  #  timekey_use_utc true\n  #</buffer>\n</match>\nEOF\n\n# \npath placeholdertag  record /path/to/${tag}/${key1}/file.%Y%m%d\nappendflush  chuck  false\nformat  out_file\ninject  event  time  tag \nadd_path_suffix path \npath_suffixpath .log\ncompress\nrecompress buffer chunk  false\n\n# \ndocker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\ndocker exec -it fluent /bin/sh\ntail -2 /tmp/fluent/yakir/buffer.b5e2f5e063d4389bd9304563cf7f07656.log\n2022-07-04T07:42:34+00:00\tyakir.test\t{\"foo\":\"bar\"}\n2022-07-04T07:42:35+00:00\tyakir.test\t{\"foo\":\"bar\"}\n```\n\n- **buffer **\n```shell\n<buffer>\n  @type file\n</buffer>\n# @type filememory\n\n<buffer ARGUMENT_CHUNK_KEYS>\n  # ...\n</buffer>\n# buffer chunk keysbuffer  record  chunk key event  chunk file  buffer \n#  time  chunk key buffer \n# timekey   timekey_waitflush \n\n# \ntimekey_use_utc\ntimekey_zone\nchunk_limit_sizechunk  8MB\nchunk_limit_recordschunk event \ntotal_limit_size buffer \nchunk_full_thresholdchunk  chunk_limit_size * chunk_full_threshold  flush\nqueued_chunks_limit_size chunk  flush  chunk\ncompress text  gzip text\nflush_at_shutdown flush buffer  true buffer  false\nflush_interval flush \nretry_timeout flush  retry\nretry_forever flush true  retry_timeout \nretry_max_times\nretry_typeretry \nretry_wait\nretry_exponential_backoff_baseretry \nretry_max_interval retry \nretry_randomize retry \n```\n\n- **format **\n```shell\n<match>\n  ...\n  \n  <format>\n    @type json\n  </format>\n\n  <buffer>\n    ...\n  </buffer>\n  \n</match>\n\n```\n\n- **forward event  fluentd  fluentd **\n```shell\n<match yakir.*>\n  @type forward\n  send_timeout 60s\n  recover_wait 10s\n  hard_timeout 60s\n\n  <server>\n    name myserver1\n    host 192.168.1.3\n    port 24224\n    weight 60\n  </server>\n  <server>\n    name myserver2\n    host 192.168.1.4\n    port 24224\n    weight 60\n  </server>\n  ...\n\n  <secondary>\n    @type file\n    path /var/log/fluent/forward-failed\n  </secondary>\n</match>\n\n#server \nhost\nname\nport\nshared_key\nusername\npassword\nstandby  server  node  standby  node\nweight \n```\n\n- **copy event **\n```shell\ncat > fluent.conf << \"EOF\"\n<source>\n  @type dummy\n  dummy {\"foo\": \"bar\"}\n  tag yakir.test\n  size 1\n  rate 1\n</source>\n\n<match yakir.**>\n  @type copy\n  <store>\n    @type file\n    path /tmp/yakir/file.%Y%m%d\n    compress gzip\n  </store>\n  <store ignore_error>\n    @type stdout\n  </store>\n</match>\nEOF\n\n# \ncopy_mode \n  no_copy event\n  shallow\n  deepmsgpack-ruby\n  marshalmarshal\nstore  ignore_error  store \n\n```\n\n- **http http  eventpayload  format **\n```shell\n<match pattern>\n  @type http\n  endpoint http://logserver.com:9000/api\n  open_timeout 2\n\n  <format>\n    @type json\n  </format>\n  <buffer>\n    flush_interval 10s\n  </buffer>\n</match>\n\n#  post 2s json10s  endpointcontent-type  application/x-ndjson\n```\n\n- **stdout fluentd **\n```shell\n<source>\n  @type dummy\n  dummy {\"foo\": \"bar\"}\n  tag yakir.test\n  size 1\n  rate 1\n</source>\n\n<match yakir.**>\n  @type stdout\n</match>\n```\n\n- **ElasticsearchKafka**\n```shell\n# elasticsearch \n<match yakir.logs>\n  @type elasticsearch\n  host localhost\n  port 9200\n  logstash_format true\n</match>\n# \nhost elasticsearch \nport elasticsearch \nhostselasticsearch  ip1:port1,ip2:port2...\nuserpasswordelasticsearch \nscheme https  http http \npathREST \nindex_nameindex \nlogstash_formatindex  logstash logstash-%Y.%m.%d\nlogstash_prefixlogstash_format index logstash\n\n\n# kafka \n<match pattern>\n  @type kafka2\n\n  # list of seed brokers\n  brokers <broker1_host>:<broker1_port>,<broker2_host>:<broker2_port>\n  use_event_time true\n\n  # buffer settings\n  <buffer topic>\n    @type file\n    path /var/log/td-agent/buffer/td\n    flush_interval 3s\n  </buffer>\n\n  # data type settings\n  <format>\n    @type json\n  </format>\n\n  # topic settings\n  topic_key topic\n  default_topic messages\n\n  # producer settings\n  required_acks -1\n  compression_codec gzip\n</match>\n# \nbrokersKafka brokers \ntopic_keyrecord  key  Kafka  key\ndefault_topic topic_key topic \nformat \nuse_event_time fluentd event  Kafka  false\nrequired_acksproducer acks \ncompression_codec\n```\n\n- **webhdfs REST  event  HDFS Hadoop**\n```shell\n  <store>\n    @type webhdfs\n    host 1.1.1.1\n    port 50070\n    path \"/history/access.log.%Y%m%d_%H.#{Socket.gethostname}.log\"\n    <buffer>\n        flush_interval 60s\n    </buffer>\n  </store>\n```\n\n#### parser \n\n- **regexp time_key  event  time **\n> [http://fluentular.herokuapp.com/](http://fluentular.herokuapp.com/)\n\n```shell\n# \n<parse>\n  @type regexp\n  expression /^\\[(?<logtime>[^\\]]*)\\] (?<name>[^ ]*) (?<title>[^ ]*) (?<id>\\d*)$/\n  time_key logtime\n  time_format %Y-%m-%d %H:%M:%S %z\n  types id:integer\n</parse>\n\n# \n#\n[2013-02-28 12:00:00 +0900] alice engineer 1\n#\ntime:\n1362020400 (2013-02-28 12:00:00 +0900)\n\nrecord:\n{\n  \"name\" : \"alice\",\n  \"title\": \"engineer\",\n  \"id\"   : 1\n}\n```\n\n#### filter \n\n- **record_transformer event **\n```shell\n#  ruby \ncat > fluent.conf << \"EOF\"\n<source>\n  @type dummy\n  dummy {\"foo\":\"bar\", \"id1\": 100, \"id2\": 50}\n  tag yakir.test\n  size 1\n  rate 1\n</source>\n\n<filter>\n  @type record_transformer\n  enable_ruby true\n  <record>\n    hostname \"#{Socket.gethostname}\"\n    tag ${tag}\n    avg ${record[\"id1\"] / record[\"id2\"]}\n  </record>\n</filter>\n\n<match yakir.**>\n  @type stdout\n</match>\nEOF\n# \ndocker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n2022-07-04 10:12:53.028623276 +0000 yakir.test: {\"foo\":\"bar\",\"id1\":100,\"id2\":50,\"hostname\":\"7d5e83c528c7\",\"tag\":\"yakir.test\",\"avg\":2}\n\n\n# \n#\n<filter foo.bar>\n  @type record_transformer\n  <record>\n    message yay, ${record[\"message\"]}\n  </record>\n</filter>\n\n\n# \n#\n{ \"message\": \"hello world!\" }\n#\ntime:\n{ \"message\": \"yay, hello world!\" }\n\n```\n\n- **record **\n```shell\n# \n<record>\n  NEW_FIELD NEW_VALUE\n</record>\n\n# \nrecord record record[\"count\"]\ntag tag \ntime\nhostname#{Socket.gethostname}\ntag_parts[N]tag . tag  N \ntag_prefix[N] tag  0-N \ntag_suffix[N] tag  N-\n```\n\n### DaemonSet \n{% asset_img fluent2.png %}\n####  Elasticsearch  Kibana\n```shell\n#  namespace\nkubectl create ns logging\n\n#  ElasticsearchStatefulSet  Serviceservice \ncat > elasticsearch.yaml << \"EOF\"\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: es\n  namespace: logging\nspec:\n  serviceName: elasticsearch\n  replicas: 1\n  selector:\n    matchLabels:\n      app: elasticsearch\n  template:\n    metadata:\n      labels:\n        app: elasticsearch\n    spec:\n      # \n      initContainers:\n      - name: increase-vm-max-map\n        image: busybox\n        command: [\"sysctl\", \"-w\", \"vm.max_map_count=262144\"]\n        securityContext:\n          privileged: true\n      - name: increase-fd-ulimit\n        image: busybox\n        command: [\"sh\", \"-c\", \"ulimit -n 65536\"]\n        securityContext:\n          privileged: true\n      containers:\n      - name: elasticsearch\n        image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2\n        resources:\n          limits:\n            cpu: 1000m\n          requests:\n            cpu: 100m\n        ports:\n        - containerPort: 9200\n          name: rest\n          protocol: TCP\n        - containerPort: 9300\n          name: inter-node\n          protocol: TCP\n        volumeMounts:\n        - name: data\n          mountPath: /usr/share/elasticsearch/data\n        env:\n          - name: cluster.name\n            value: k8s-logs\n          - name: node.name\n            valueFrom:\n              fieldRef:\n                fieldPath: metadata.name\n          # ES \n          - name: cluster.initial_master_nodes\n            value: \"es-0\"\n          - name: discovery.zen.minimum_master_nodes\n            value: \"1\"\n          - name: discovery.seed_hosts\n            value: \"elasticsearch\"\n          - name: ES_JAVA_OPTS\n            value: \"-Xms512m -Xmx512m\"\n          - name: network.host\n            value: \"0.0.0.0\"\n      #  StorageClass \n      volumes:\n      - name: data\n        emptyDir: {}\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: elasticsearch\n  namespace: logging\n  labels:\n    app: elasticsearch\nspec:\n  selector:\n    app: elasticsearch\n  # StatefulSet  Pod  DNS  es-0.elasticsearch.logging.svc.cluster.local\n  clusterIP: None\n  ports:\n    - port: 9200\n      name: rest\n    - port: 9300\n      name: inter-node\nEOF\n\n#  Kibana \ncat > kibana.yaml << \"EOF\"\napiVersion: v1\nkind: Service\nmetadata:\n  name: kibana\n  namespace: logging\n  labels:\n    app: kibana\nspec:\n  selector:\n    app: kibana\n  ports:\n  - port: 5601\n  type: ClusterIP\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: kibana\n  namespace: logging\n  labels:\n    app: kibana\nspec:\n  selector:\n    matchLabels:\n      app: kibana\n  template:\n    metadata:\n      labels:\n        app: kibana\n    spec:\n      containers:\n      - name: kibana\n        image: docker.elastic.co/kibana/kibana:7.6.2\n        resources:\n          limits:\n            cpu: 1000m\n          requests:\n            cpu: 200m\n        env:\n        - name: ELASTICSEARCH_HOSTS\n          value: http://elasticsearch:9200\n        ports:\n        - containerPort: 5601\nEOF\n\n# \nkubectl apply -f elasticsearch.yaml\nkubectl apply -f kibana.yaml\nkubectl get pod,svc -n logging -owide\nNAME                          READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES\npod/es-0                      1/1     Running   0          4h54m   172.17.0.6   minikube   <none>           <none>\npod/kibana-6c84594848-mdp76   1/1     Running   0          158m    172.17.0.5   minikube   <none>           <none>\n\nNAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE     SELECTOR\nservice/elasticsearch   ClusterIP   None           <none>        9200/TCP,9300/TCP   4h50m   app=elasticsearch\nservice/kibana          ClusterIP   10.106.67.32   <none>        5601/TCP            158m    app=kibana\n\n# \nkubectl port-forward services/elasticsearch -n logging --address 127.0.0.1 9200:9200\ncurl http://127.0.0.1:9200/_cluster/state?pretty\ncurl 10.106.67.32:5601/app/kibana -I\n```\n\n####  Fluentd\n```shell\n# \n# git clone https://github.com/fluent/fluentd-kubernetes-daemonset.git\n\n# \n#Fluentd \ncat > fluentd-cfg.yaml << \"EOF\"\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: fluentd-config\n  namespace: logging\ndata:\n  system.conf: |-\n    <system>\n      root_dir /tmp/fluentd-buffers/\n    </system>\n  containers.input.conf: |-\n    <source>\n      @id fluentd-containers.log\n      @type tail                              # Fluentd \n      path /var/log/containers/*.log          # Docker\n      pos_file /var/log/es-containers.log.pos\n      tag raw.kubernetes.*                    # \n      read_from_head true\n      <parse>                                 # JSON\n        @type multi_format                    #  multi-format-parser \n        <pattern>\n          format json                         # JSON\n          time_key time                       # \n          time_format %Y-%m-%dT%H:%M:%S.%NZ   # \n        </pattern>\n        <pattern>\n          format /^(?<time>.+) (?<stream>stdout|stderr) [^ ]* (?<log>.*)$/\n          time_format %Y-%m-%dT%H:%M:%S.%N%:z\n        </pattern>\n      </parse>\n    </source>\n    # \n    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions\n    <match raw.kubernetes.**>           # tagraw.kubernetes.**\n      @id raw.kubernetes\n      @type detect_exceptions           # detect-exceptions\n      remove_tag_prefix raw             #  raw \n      message log\n      stream stream\n      multiline_flush_interval 5\n      max_bytes 500000\n      max_lines 1000\n    </match>\n\n    <filter **>  # \n      @id filter_concat\n      @type concat                # Fluentd Filter \n      key message\n      multiline_end_regexp /\\n$/  # \\n\n      separator \"\"\n    </filter>\n\n    #  Kubernetes metadata \n    <filter kubernetes.**>\n      @id filter_kubernetes_metadata\n      @type kubernetes_metadata\n    </filter>\n\n    #  ES  JSON \n    # https://github.com/repeatedly/fluent-plugin-multi-format-parser\n    <filter kubernetes.**>\n      @id filter_parser\n      @type parser                # multi-format-parser\n      key_name log                # \n      reserve_data true           # \n      remove_key_name_field true  # key_name \n      <parse>\n        @type multi_format\n        <pattern>\n          format json\n        </pattern>\n        <pattern>\n          format none\n        </pattern>\n      </parse>\n    </filter>\n\n    # \n    <filter kubernetes.**>\n      @type record_transformer\n      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash\n    </filter>\n\n    # logging=truePod\n    <filter kubernetes.**>\n      @id filter_log\n      @type grep\n      <regexp>\n        key $.kubernetes.labels.logging\n        pattern ^true$\n      </regexp>\n    </filter>\n\n  ######  ######\n  forward.input.conf: |-\n    # TCP\n    <source>\n      @id forward\n      @type forward\n    </source>\n\n  output.conf: |-\n    <match **>\n      @id elasticsearch\n      @type elasticsearch\n      @log_level info\n      include_tag_key true\n      host elasticsearch\n      port 9200\n      logstash_format true\n      logstash_prefix k8s  #  index  k8s\n      request_timeout    30s\n      <buffer>\n        @type file\n        path /var/log/fluentd-buffers/kubernetes.system.buffer\n        flush_mode interval\n        retry_type exponential_backoff\n        flush_thread_count 2\n        flush_interval 5s\n        retry_forever\n        retry_max_interval 30\n        chunk_limit_size 2M\n        queue_limit_length 8\n        overflow_action block\n      </buffer>\n    </match>\nEOF\n\n\ncat > fluentd-daemonset.yaml << \"EOF\"\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - \"namespaces\"\n  - \"pods\"\n  verbs:\n  - \"get\"\n  - \"watch\"\n  - \"list\"\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nsubjects:\n- kind: ServiceAccount\n  name: fluentd-es\n  namespace: logging\n  apiGroup: \"\"\nroleRef:\n  kind: ClusterRole\n  name: fluentd-es\n  apiGroup: \"\"\n---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nspec:\n  selector:\n    matchLabels:\n      k8s-app: fluentd-es\n  template:\n    metadata:\n      labels:\n        k8s-app: fluentd-es\n        kubernetes.io/cluster-service: \"true\"\n      # fluentd pod \n      annotations:\n        priorityClassName: system-cluster-critical\n    spec:\n      serviceAccountName: fluentd-es\n      containers:\n      - name: fluentd-es\n        image: quay.io/fluentd_elasticsearch/fluentd:v3.0.1\n        #image: fluent/fluentd-kubernetes-daemonset:v1.14.6-debian-elasticsearch7-1.1\n        env:\n        - name: FLUENTD_ARGS\n          value: --no-supervisor -q\n        resources:\n          limits:\n            memory: 500Mi\n          requests:\n            cpu: 100m\n            memory: 200Mi\n        volumeMounts:\n        - name: varlog\n          mountPath: /var/log\n        - name: varlibdockercontainers\n          mountPath: /var/lib/docker/containers\n          readOnly: true\n        - name: config-volume\n          mountPath: /etc/fluent/config.d\n      #  master  master \n      tolerations:\n      - operator: Exists\n      terminationGracePeriodSeconds: 30\n      # \n      volumes:\n      - name: varlog\n        hostPath:\n          path: /var/log\n      - name: varlibdockercontainers\n        hostPath:\n          path: /var/lib/docker/containers\n      - name: config-volume\n        configMap:\n          name: fluentd-config\nEOF\n\n# \nkubectl apply -f fluentd-cfg.yaml\nkubectl apply -f fluentd-daemonset.yaml\nkubectl get pod -n logging -owide\nNAME                          READY   STATUS    RESTARTS        AGE     IP           NODE       NOMINATED NODE   READINESS GATES\npod/fluentd-es-cfdcx          1/1     Running   0               91m     172.17.0.7   minikube   <none>           <none>\n\n```\n#### \n```shell\n# \ncat > stdin.yaml << \"EOF\"\napiVersion: v1\nkind: Pod\nmetadata:\n  name: counter1\n  labels:\n    # \n    logging: \"true\"\nspec:\n  containers:\n    - image: busybox\n      args: [\"/bin/sh\",\"-c\", 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 5; done']\n      name: counter\nEOF\n\n# sidecar \ncat > sidecar.yaml << \"EOF\"\napiVersion: v1\nkind: Pod\nmetadata:\n  name: counter2\n  labels:\n    logging: \"true\"\nspec:\n  containers:\n  - name: counter2\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - >\n      i=0;\n      while true;\n      do\n        echo \"$i: $(date)\" >> /var/log/1.log;\n        echo \"$(date) INFO $i\" >> /var/log/2.log;\n        i=$((i+1));\n        sleep 3;\n      done\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-log-1\n    image: busybox\n    args: [/bin/sh, -c, 'tail -n 1 -f /var/log/1.log']\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-log-2\n    image: busybox\n    args: [/bin/sh, -c, 'tail -n 1 -f /var/log/2.log']\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  restartPolicy: Never\n  volumes:\n  - name: varlog\n    emptyDir: {}\nEOF\n# kubectl logs counter2 count-log-2 -f --tail 3\n\n#  JSON \ncat > dummylogs.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dummylogs\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: dummylogs\n  template:\n    metadata:\n      labels:\n        app: dummylogs\n        logging: \"true\"  # \n    spec:\n      containers:\n      - name: dummy\n        image: cnych/dummylogs:latest\n        args:\n        - msg-processor\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dummylogs2\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: dummylogs2\n  template:\n    metadata:\n      labels:\n        app: dummylogs2\n        logging: \"true\"  # \n    spec:\n      containers:\n      - name: dummy\n        image: cnych/dummylogs:latest\n        args:\n        - msg-receiver-api\nEOF\n\n# \nkubectl apply -f counter.yaml\nkubectl apply -f dummylogs.yaml\n```\n#### Kibana  & Elasticsearch \n\n-  Kibana  & Elasticsearch \n```shell\nkubectl port-forward services/kibana -n logging --address 127.0.0.1 5601:5601\nkubectl port-forward services/elasticsearch -n logging --address 127.0.0.1 9200:9200\n```\n\n- \n\n{% asset_img fluent3.png %}\n{% asset_img fluent4.png %}\n\n- Kibana \n#### \n```shell\ncat > elastalert.yaml << \"EOF\"\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: elastalert-config\n  namespace: logging\n  labels:\n    app: elastalert\ndata:\n  elastalert_config: |-\n    ---\n    rules_folder: /opt/rules       # \n    scan_subdirectories: false\n    run_every:                     #  ES \n      minutes: 1\n    buffer_time:\n      minutes: 15\n    es_host: elasticsearch\n    es_port: 9200\n    writeback_index: elastalert\n    use_ssl: False\n    verify_certs: True\n    alert_time_limit:             # \n      minutes: 720\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: elastalert-rules\n  namespace: logging\n  labels:\n    app: elastalert\ndata:\n  rule_config.yaml: |-\n    name: dummylogs error     # \n    es_host: elasticsearch\n    es_port: 9200\n    type: any                 # \n    index: k8s-*              # es\n    filter:                   # \n    - query:\n        query_string:\n          query: \"LOGLEVEL:ERROR\"  # \n    alert:                         # \n    - \"email\"\n    smtp_host: 127.0.0.1\n    smtp_port: 587\n    smtp_auth_file: /opt/auth/smtp_auth_file.yaml\n    email_reply_to: xxx@gmail.com\n    from_addr: xxx@gmail.com\n    email:                  # \n    - \"xxx@gmail.com\"\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: elastalert\n  namespace: logging\n  labels:\n    app: elastalert\nspec:\n  selector:\n    matchLabels:\n      app: elastalert\n  template:\n    metadata:\n      labels:\n        app: elastalert\n    spec:\n      containers:\n      - name: elastalert\n        image: jertel/elastalert-docker:0.2.4\n        imagePullPolicy: IfNotPresent\n        volumeMounts:\n        - name: config\n          mountPath: /opt/config\n        - name: rules\n          mountPath: /opt/rules\n        - name: auth\n          mountPath: /opt/auth\n        resources:\n          limits:\n            cpu: 50m\n            memory: 256Mi\n          requests:\n            cpu: 50m\n            memory: 256Mi\n      volumes:\n      - name: auth\n        secret:\n          secretName: smtp-auth\n      - name: rules\n        configMap:\n          name: elastalert-rules\n      - name: config\n        configMap:\n          name: elastalert-config\n          items:\n          - key: elastalert_config\n            path: elastalert_config.yaml\nEOF\n\n# \ncat > smtp_auth_file.yaml << EOF\nuser: \"xxxxx@gmail.com\"\npassword: \"123xxx\"\nEOF\n\n# \nkubectl create secret generic smtp-auth --from-file=smtp_auth_file.yaml -n logging\nkubectl apply -f elastalert.yaml\nkubectl get pods -n logging -l app=elastalert\n# Kibana \n```\n\n### fluentd-operator \n#### CRD \n**fluentbit.fluent.io **\n\n- FluentBit Fluent Bit \n- ClusterFluentBitConfig Fluent Bit \n- ClusterInput Fluent Bit  input \n- ClusterFilter Fluent Bit  filter \n- ClusterParser Fluent Bit  parser \n- ClusterOutput Fluent Bit  output \n\n**fluentd.fluent.io **\n\n- Fluentd Fluentd \n- FluentdConfig Fluentd namespace \n- ClusterFluentdConfig Fluentd \n- Filter Fluentd namespace  filter \n- ClusterFilter Fluentd  filter \n- Output Fluentd namespace  output \n- ClusterOutput Fluentd  output \n\n####  CRD  fluent-operator\n```shell\n#  CRD  fluent-operator\ngit clone https://github.com/fluent/fluent-operator\ncd fluent-operator && kubectl apply -f manifests/setup/setup.yaml\n\n# \nkubectl get pod,crd -n fluent\nNAME                                   READY   STATUS    RESTARTS        AGE\npod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (5h20m ago)   22h\n\nNAME                                                                                        CREATED AT\ncustomresourcedefinition.apiextensions.k8s.io/clusterfilters.fluentbit.fluent.io            2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusterfilters.fluentd.fluent.io              2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusterfluentbitconfigs.fluentbit.fluent.io   2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusterfluentdconfigs.fluentd.fluent.io       2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusterinputs.fluentbit.fluent.io             2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusteroutputs.fluentbit.fluent.io            2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusteroutputs.fluentd.fluent.io              2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusterparsers.fluentbit.fluent.io            2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/filters.fluentd.fluent.io                     2022-07-05T07:45:27Z\ncustomresourcedefinition.apiextensions.k8s.io/fluentbits.fluentbit.fluent.io                2022-07-05T07:45:27Z\ncustomresourcedefinition.apiextensions.k8s.io/fluentdconfigs.fluentd.fluent.io              2022-07-05T07:45:27Z\ncustomresourcedefinition.apiextensions.k8s.io/fluentds.fluentd.fluent.io                    2022-07-05T07:45:27Z\ncustomresourcedefinition.apiextensions.k8s.io/outputs.fluentd.fluent.io                     2022-07-05T07:45:28Z\n```\n\n#### Fluent Bit Only \n```shell\n#  Fluent Bit \ncat > fluent-bit.yaml << \"EOF\"\napiVersion: fluentbit.fluent.io/v1alpha2\nkind: FluentBit\nmetadata:\n  name: fluent-bit\n  namespace: fluent\n  labels:\n    app.kubernetes.io/name: fluent-bit\nspec:\n  image: kubesphere/fluent-bit:v1.8.11\n  positionDB:\n    hostPath:\n      path: /var/lib/fluent-bit/\n  resources:\n    requests:\n      cpu: 10m\n      memory: 25Mi\n    limits:\n      cpu: 500m\n      memory: 200Mi\n  fluentBitConfigName: fluent-bit-config\n  tolerations:\n    - operator: Exists\n---\napiVersion: fluentbit.fluent.io/v1alpha2\nkind: ClusterFluentBitConfig\nmetadata:\n  name: fluent-bit-config\n  labels:\n    app.kubernetes.io/name: fluent-bit\nspec:\n  service:\n    parsersFile: parsers.conf\n  inputSelector:\n    matchLabels:\n      fluentbit.fluent.io/enabled: \"true\"\n      fluentbit.fluent.io/mode: \"k8s\"\n  filterSelector:\n    matchLabels:\n      fluentbit.fluent.io/enabled: \"true\"\n      fluentbit.fluent.io/mode: \"k8s\"\n  outputSelector:\n    matchLabels:\n      fluentbit.fluent.io/enabled: \"true\"\n      fluentbit.fluent.io/mode: \"k8s\"\n---\napiVersion: fluentbit.fluent.io/v1alpha2\nkind: ClusterInput\nmetadata:\n  name: tail\n  labels:\n    fluentbit.fluent.io/enabled: \"true\"\n    fluentbit.fluent.io/mode: \"k8s\"\nspec:\n  tail:\n    tag: kube.*\n    path: /var/log/containers/*.log\n    parser: docker\n    refreshIntervalSeconds: 10\n    memBufLimit: 5MB\n    skipLongLines: true\n    db: /fluent-bit/tail/pos.db\n    dbSync: Normal\n---\napiVersion: fluentbit.fluent.io/v1alpha2\nkind: ClusterOutput\nmetadata:\n  name: es\n  labels:\n    fluentbit.fluent.io/enabled: \"true\"\n    fluentbit.fluent.io/mode: \"k8s\"\nspec:\n  matchRegex: (?:kube|service)\\.(.*)\n  es:\n    host: elasticsearch\n    port: 9200\n    generateID: true\n    logstashPrefix: fluent-log-fb-only\n    logstashFormat: true\n    timeKey: \"@timestamp\"\nEOF\n#  output  elasticsearch \nkubectl apply -f elasticsearch.yaml\nkubectl apply -f fluent-bit.yaml\n\n# \nkubectl get pod,svc -n fluent\nNAME                                   READY   STATUS    RESTARTS      AGE\npod/es-0                               1/1     Running   1 (56m ago)   17h\npod/fluent-bit-rjqsd                   1/1     Running   0             2m34s\npod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (56m ago)   17h\nNAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE\nservice/elasticsearch   ClusterIP   None         <none>        9200/TCP,9300/TCP   17h\n\n#  Elasticsearch \nkubectl port-forward services/elasticsearch -n fluent --address 127.0.0.1 9200:9200\n#\ncurl \"127.0.0.1:9200/_cat/indices?pretty\"\nyellow open fluent-log-fb-only-2022.07.06 lLmstFnwQLa89Jb7TFe-0Q 1 1 152 0 155.2kb 155.2kb \n#\ncurl \"127.0.0.1:9200/fluent-log-fb-only-2022.07.06/_search?pretty\"\n...\n# ID \ncurl \"127.0.0.1:9200/fluent-log-fb-only-2022.07.06/_doc/b641529e-255c-f260-f911-f7d00d84e3fe?pretty\"\n{\n  \"_index\" : \"fluent-log-fb-only-2022.07.06\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"b641529e-255c-f260-f911-f7d00d84e3fe\",\n  \"_version\" : 1,\n  \"_seq_no\" : 94,\n  \"_primary_term\" : 1,\n  \"found\" : true,\n  \"_source\" : {\n    \"@timestamp\" : \"2022-07-06T02:57:38.035Z\",\n    \"log\" : \"[2022/07/06 02:57:38] [ info] [input:tail:tail.0] inotify_fs_add(): inode=2050771 watch_fd=3 name=/var/log/containers/dashboard-metrics-scraper-58549894f-q9lpg_kubernetes-dashboard_dashboard-metrics-scraper-51061ac5d9c2c7c2da734ab35b9252edb29f4101ade5679a22181d0d735dc364.log\\n\",\n    \"time\" : \"2022-07-06T02:57:38.035319145Z\",\n    \"kubernetes\" : {\n      \"pod_name\" : \"fluent-bit-8v2qn\",\n      \"namespace_name\" : \"fluent\",\n      \"container_name\" : \"fluent-bit\",\n      \"docker_id\" : \"098d8ac65b201686b7a2945df6ee1a919b7220b637aea4de6490d92569c9c455\",\n      \"container_image\" : \"kubesphere/fluent-bit:v1.8.11\"\n    }\n  }\n}\n```\n\n#### Fluent Bit + Fluentd \n```shell\n#  Fluent Bit output  forward  Fluentd\ncat >> fluent-bit.yaml << \"EOF\"\napiVersion: fluentbit.fluent.io/v1alpha2\nkind: ClusterOutput\nmetadata:\n  name: fluentd\n  labels:\n    fluentbit.fluent.io/enabled: \"true\"\n    fluentbit.fluent.io/component: logging\nspec:\n  matchRegex: (?:kube|service)\\.(.*)\n  forward:\n    host: fluentd.fluent.svc\n    port: 24224\nEOF\n\n#  Fluentd \ncat > fluentd.yaml << \"EOF\"\napiVersion: fluentd.fluent.io/v1alpha1\nkind: Fluentd\nmetadata:\n  name: fluentd\n  namespace: fluent\n  labels:\n    app.kubernetes.io/name: fluentd\nspec:\n  globalInputs:\n  - forward:\n      bind: 0.0.0.0\n      port: 24224\n  replicas: 1\n  image: kubesphere/fluentd:v1.14.4\n  fluentdCfgSelector:\n    matchLabels:\n      config.fluentd.fluent.io/enabled: \"true\"\nEOF\n\n#  Fluentd\n#1. ClusterFluentdConfig  kube-system  default  namesapce  ClusterOutput\ncat >> fluentd.yaml << \"EOF\"\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterFluentdConfig\nmetadata:\n  name: cluster-fluentd-config\n  labels:\n    config.fluentd.fluent.io/enabled: \"true\"\nspec:\n  watchedNamespaces:\n  - kube-system\n  - default\n  clusterOutputSelector:\n    matchLabels:\n      output.fluentd.fluent.io/scope: \"cluster\"\n      output.fluentd.fluent.io/enabled: \"true\"\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterOutput\nmetadata:\n  name: cluster-fluentd-output-es\n  labels:\n    output.fluentd.fluent.io/scope: \"cluster\"\n    output.fluentd.fluent.io/enabled: \"true\"\nspec:\n  outputs:\n  - elasticsearch:\n      host: elasticsearch-master.elastic.svc\n      port: 9200\n      logstashFormat: true\n      logstashPrefix: fluent-log-cluster-fd\nEOF\n#2. FluentdConfig + ClusterFluentdConfig  namespace  Output  ClusterOutput\ncat >> fluentd.yaml << \"EOF\"\napiVersion: fluentd.fluent.io/v1alpha1\nkind: FluentdConfig\nmetadata:\n  name: namespace-fluentd-config-user1\n  namespace: fluent\n  labels:\n    config.fluentd.fluent.io/enabled: \"true\"\nspec:\n  outputSelector:\n    matchLabels:\n      output.fluentd.fluent.io/enabled: \"true\"\n      output.fluentd.fluent.io/user: \"user1\"\n  clusterOutputSelector:\n    matchLabels:\n      output.fluentd.fluent.io/enabled: \"true\"\n      output.fluentd.fluent.io/user: \"user1\"\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterFluentdConfig\nmetadata:\n  name: cluster-fluentd-config-cluster-only\n  labels:\n    config.fluentd.fluent.io/enabled: \"true\"\nspec:\n  watchedNamespaces:\n  - kube-system\n  - kubesphere-system\n  clusterOutputSelector:\n    matchLabels:\n      output.fluentd.fluent.io/enabled: \"true\"\n      output.fluentd.fluent.io/scope: \"cluster-only\"\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: Output\nmetadata:\n  name: namespace-fluentd-output-user1\n  namespace: fluent\n  labels:\n    output.fluentd.fluent.io/enabled: \"true\"\n    output.fluentd.fluent.io/user: \"user1\"\nspec:\n  outputs:\n  - elasticsearch:\n      host: elasticsearch-master.elastic.svc\n      port: 9200\n      logstashFormat: true\n      logstashPrefix: fluent-log-user1-fd\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterOutput\nmetadata:\n  name: cluster-fluentd-output-user1\n  labels:\n    output.fluentd.fluent.io/enabled: \"true\"\n    output.fluentd.fluent.io/user: \"user1\"\nspec:\n  outputs:\n  - elasticsearch:\n      host: elasticsearch-master.elastic.svc\n      port: 9200\n      logstashFormat: true\n      logstashPrefix: fluent-log-cluster-user1-fd\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterOutput\nmetadata:\n  name: cluster-fluentd-output-cluster-only\n  labels:\n    output.fluentd.fluent.io/enabled: \"true\"\n    output.fluentd.fluent.io/scope: \"cluster-only\"\nspec:\n  outputs:\n  - elasticsearch:\n      host: elasticsearch-master.elastic.svc\n      port: 9200\n      logstashFormat: true\n      logstashPrefix: fluent-log-cluster-only-fd\nEOF\n\n# Fluentd  buffer \ncat >> fluentd.yaml << \"EOF\"\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterOutput\nmetadata:\n  name: cluster-fluentd-output-buffer\n  labels:\n    output.fluentd.fluent.io/type: \"buffer\"\n    output.fluentd.fluent.io/enabled: \"true\"\nspec:\n  outputs:\n  - stdout: {}\n    buffer:\n      type: file\n      path: /buffers/stdout.log\n  - elasticsearch:\n      host: elasticsearch-master.elastic.svc\n      port: 9200\n      logstashFormat: true\n      logstashPrefix: fluent-log-buffer-fd\n    buffer:\n      type: file\n      path: /buffers/es.log\nEOF\n\n```\n\n#### Fluentd Only \n```shell\ncat > fluentd.yaml << \"EOF\"\napiVersion: fluentd.fluent.io/v1alpha1\nkind: Fluentd\nmetadata:\n  name: fluentd-http\n  namespace: fluent\n  labels:\n    app.kubernetes.io/name: fluentd\nspec:\n  globalInputs:\n    - http:\n        bind: 0.0.0.0\n        port: 9880\n  replicas: 1\n  image: kubesphere/fluentd:v1.14.4\n  fluentdCfgSelector:\n    matchLabels:\n      config.fluentd.fluent.io/enabled: \"true\"\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: FluentdConfig\nmetadata:\n  name: fluentd-only-config\n  namespace: fluent\n  labels:\n    config.fluentd.fluent.io/enabled: \"true\"\nspec:\n  filterSelector:\n    matchLabels:\n      filter.fluentd.fluent.io/mode: \"fluentd-only\"\n      filter.fluentd.fluent.io/enabled: \"true\"\n  outputSelector:\n    matchLabels:\n      output.fluentd.fluent.io/mode: \"fluentd-only\"\n      output.fluentd.fluent.io/enabled: \"true\"\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: Filter\nmetadata:\n  name: fluentd-only-filter\n  namespace: fluent\n  labels:\n    filter.fluentd.fluent.io/mode: \"fluentd-only\"\n    filter.fluentd.fluent.io/enabled: \"true\"\nspec:\n  filters:\n    - stdout: {}\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: Output\nmetadata:\n  name: fluentd-only-stdout\n  namespace: fluent\n  labels:\n    output.fluentd.fluent.io/mode: \"fluentd-only\"\n    output.fluentd.fluent.io/enabled: \"true\"\nspec:\n  outputs:\n    - stdout: {}\nEOF\n\n# \nkubectl get all -n fluent\nNAME                                   READY   STATUS    RESTARTS       AGE\npod/es-0                               1/1     Running   1 (163m ago)   19h\npod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (163m ago)   19h\npod/fluentd-http-0                     1/1     Running   0              2m53s\n\nNAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE\nservice/elasticsearch   ClusterIP   None         <none>        9200/TCP,9300/TCP   19h\nservice/fluentd-http    ClusterIP   10.97.96.1   <none>        9880/TCP            2m54s\n\nNAME                              READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/fluent-operator   1/1     1            1           19h\n\nNAME                                         DESIRED   CURRENT   READY   AGE\nreplicaset.apps/fluent-operator-86858cfc87   1         1         1       19h\n\nNAME                            READY   AGE\nstatefulset.apps/es             1/1     19h\nstatefulset.apps/fluentd-http   1/1     2m54s\n```\n\n\n> \n> 1[https://www.qikqiak.com/post/install-efk-stack-on-k8s/](https://www.qikqiak.com/post/install-efk-stack-on-k8s/)\n> 2fluentd [https://docs.fluentd.org/](https://docs.fluentd.org/)\n> 3fluentd-operator [https://github.com/fluent/fluent-operator](https://github.com/fluent/fluent-operator)\n> 4fluent-operator-walkthrough[https://github.com/kubesphere-sigs/fluent-operator-walkthrough](https://github.com/kubesphere-sigs/fluent-operator-walkthrough)\n> 5KubeSphere[https://kubesphere.com.cn/blogs/fluent-operator-logging](https://kubesphere.com.cn/blogs/fluent-operator-logging)\n\n\n","source":"_posts/observability-fluentd-component.md","raw":"---\ntitle: -Fluentd \nabbrlink: 41fe\ndate: 2022-07-11 21:56:17\ncategories:\n  - CNCF\ntags:\n  - Observability\n---\n### \n**Fluentd**\n Kubernetes  node  fluentd + Elasticsearch\n{% asset_img fluent1.png %}\n> fluentd source --> parser --> filter --> output\n\n\n**Elasticsearch**\n\n\n**Kibana** \n Web GUI Elasticsearch  \n\n> \n> -  agent daemonSet\n> -  Pod  sidecar \n> - \n\n<!--more-->\n\n###  / \n#### \n[https://docs.fluentd.org/installation/before-install](https://docs.fluentd.org/installation/before-install)\n\n#### \n[https://hub.docker.com/r/fluent/fluentd](https://hub.docker.com/r/fluent/fluentd)\n\n### \n> fluentd  tag \n> source -> parser -> filter -> output\n\n#### input \n\n- **http http **\n```shell\n# \nmkdir /tmp/fluentd && cd /tmp/fluentd\ncat > fluent.conf << EOF\n<source>\n  @type http\n  port 9880\n  bind 0.0.0.0\n</source>\n\n<match **>\n  @type stdout\n</match>\nEOF\n\n#  fluentd  fluent.conf \ndocker run -p 9880:9880 --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n\n#  http \ncurl -X POST 127.0.0.1:9880/yakir.test -d 'json={\"a\":\"aaa\"}'\n```\n\n- **tail**\n```shell\ncat > fluent.conf << EOF\n<source>\n  @type tail\n  path /var/log/httpd-access.log\n  path_key tailed_path\n  pos_file /var/log/td-agent/httpd-access.log.pos\n  tag apache.access\n  <parse>\n    @type apache2\n  </parse>\n</source>\nEOF\n\n# \ndocker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n```\n\n- **exec event**\n```shell\ncat > fluent.conf << EOF\n<source>\n  @type exec\n  tag yakir.test\n  command cat /proc/loadavg | cut -d ' ' -f 1,2,3\n  run_interval 10s\n\n  <parse>\n    @type tsv\n    keys avg1,avg5,avg15\n    delimiter \" \"\n  </parse>\n</source>\n\n<match **>\n  @type stdout\n</match>\nEOF\n\n# \ndocker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n2022-06-30 08:43:20.377146682 +0000 yakir.test: {\"avg1\":\"0.12\",\"avg5\":\"0.16\",\"avg15\":\"0.17\"}\n2022-06-30 08:43:30.347891525 +0000 yakir.test: {\"avg1\":\"0.10\",\"avg5\":\"0.15\",\"avg15\":\"0.17\"}\n```\n\n- **syslog rsyslog  rsyslog **\n```shell\ncat > fluent.conf << EOF\n<source>\n    @type syslog\n    port 5140\n    bind 0.0.0.0\n    tag system\n</source>\n\n<match **>\n  @type stdout\n</match>\nEOF\n\n#  udp \ndocker run -p 5140:5140/udp --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n\n#  rsyslog  fluent\ncat >> /etc/rsyslog.d/50-default.conf << \"EOF\"\n*.* @127.0.0.1:5140\nEOF\n\n# logger \nlogger -p mail.info 'this is info message'\nlogger -p mail.warning 'this is warning message'\n2022-07-04 10:27:48.000000000 +0000 system.mail.info: {\"host\":\"minikube\",\"ident\":\"root\",\"message\":\"this is info message\"}\n2022-07-04 10:28:11.000000000 +0000 system.mail.warn: {\"host\":\"minikube\",\"ident\":\"root\",\"message\":\"this is warning message\"}\n```\n\n- **dummy**\n```shell\ncat > fluent.conf << \"EOF\"\n<source>\n    @type dummy\n    dummy {\"foo\": \"bar\"}\n    size 3\n    rate 1\n    tag yakir.test\n    auto_increment_key primary_key\n    suspend true\n</source>\n\n<match **>\n  @type stdout\n</match>\nEOF\n\n#\nsize     # event \nrate     # event\nauto_increment_key   #\nsuspend              #\n\n# \ndocker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n2022-07-04 02:51:37.044796145 +0000 yakir.test: {\"foo\":\"bar\",\"primary_key\":0}\n2022-07-04 02:51:37.044834743 +0000 yakir.test: {\"foo\":\"bar\",\"primary_key\":1}\n```\n\n- **forward fluentd forward  event**\n```shell\n<source>\n  @type forward\n  port 24224\n  bind 0.0.0.0\n</source>\n```\n#### output \n\n- **file event **\n```shell\ncat > fluent.conf << \"EOF\"\n<source>\n  @type dummy\n  dummy {\"foo\": \"bar\"}\n  tag yakir.test\n  size 1\n  rate 1\n</source>\n\n<match yakir.**>\n  @type file\n  path /tmp/fluent/yakir\n  compress gzip\n  <buffer>\n    timekey 1d\n    timekey_use_utc true\n    timekey_wait 10m\n  </buffer>\n  \n  #@type file\n  #path /tmp/${tag[0]}/file.%Y-%m-%d-%H-%M-%S\n  #<buffer tag,time>\n  #  timekey 10\n  #  timekey_wait 10\n  #  timekey_use_utc true\n  #</buffer>\n</match>\nEOF\n\n# \npath placeholdertag  record /path/to/${tag}/${key1}/file.%Y%m%d\nappendflush  chuck  false\nformat  out_file\ninject  event  time  tag \nadd_path_suffix path \npath_suffixpath .log\ncompress\nrecompress buffer chunk  false\n\n# \ndocker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\ndocker exec -it fluent /bin/sh\ntail -2 /tmp/fluent/yakir/buffer.b5e2f5e063d4389bd9304563cf7f07656.log\n2022-07-04T07:42:34+00:00\tyakir.test\t{\"foo\":\"bar\"}\n2022-07-04T07:42:35+00:00\tyakir.test\t{\"foo\":\"bar\"}\n```\n\n- **buffer **\n```shell\n<buffer>\n  @type file\n</buffer>\n# @type filememory\n\n<buffer ARGUMENT_CHUNK_KEYS>\n  # ...\n</buffer>\n# buffer chunk keysbuffer  record  chunk key event  chunk file  buffer \n#  time  chunk key buffer \n# timekey   timekey_waitflush \n\n# \ntimekey_use_utc\ntimekey_zone\nchunk_limit_sizechunk  8MB\nchunk_limit_recordschunk event \ntotal_limit_size buffer \nchunk_full_thresholdchunk  chunk_limit_size * chunk_full_threshold  flush\nqueued_chunks_limit_size chunk  flush  chunk\ncompress text  gzip text\nflush_at_shutdown flush buffer  true buffer  false\nflush_interval flush \nretry_timeout flush  retry\nretry_forever flush true  retry_timeout \nretry_max_times\nretry_typeretry \nretry_wait\nretry_exponential_backoff_baseretry \nretry_max_interval retry \nretry_randomize retry \n```\n\n- **format **\n```shell\n<match>\n  ...\n  \n  <format>\n    @type json\n  </format>\n\n  <buffer>\n    ...\n  </buffer>\n  \n</match>\n\n```\n\n- **forward event  fluentd  fluentd **\n```shell\n<match yakir.*>\n  @type forward\n  send_timeout 60s\n  recover_wait 10s\n  hard_timeout 60s\n\n  <server>\n    name myserver1\n    host 192.168.1.3\n    port 24224\n    weight 60\n  </server>\n  <server>\n    name myserver2\n    host 192.168.1.4\n    port 24224\n    weight 60\n  </server>\n  ...\n\n  <secondary>\n    @type file\n    path /var/log/fluent/forward-failed\n  </secondary>\n</match>\n\n#server \nhost\nname\nport\nshared_key\nusername\npassword\nstandby  server  node  standby  node\nweight \n```\n\n- **copy event **\n```shell\ncat > fluent.conf << \"EOF\"\n<source>\n  @type dummy\n  dummy {\"foo\": \"bar\"}\n  tag yakir.test\n  size 1\n  rate 1\n</source>\n\n<match yakir.**>\n  @type copy\n  <store>\n    @type file\n    path /tmp/yakir/file.%Y%m%d\n    compress gzip\n  </store>\n  <store ignore_error>\n    @type stdout\n  </store>\n</match>\nEOF\n\n# \ncopy_mode \n  no_copy event\n  shallow\n  deepmsgpack-ruby\n  marshalmarshal\nstore  ignore_error  store \n\n```\n\n- **http http  eventpayload  format **\n```shell\n<match pattern>\n  @type http\n  endpoint http://logserver.com:9000/api\n  open_timeout 2\n\n  <format>\n    @type json\n  </format>\n  <buffer>\n    flush_interval 10s\n  </buffer>\n</match>\n\n#  post 2s json10s  endpointcontent-type  application/x-ndjson\n```\n\n- **stdout fluentd **\n```shell\n<source>\n  @type dummy\n  dummy {\"foo\": \"bar\"}\n  tag yakir.test\n  size 1\n  rate 1\n</source>\n\n<match yakir.**>\n  @type stdout\n</match>\n```\n\n- **ElasticsearchKafka**\n```shell\n# elasticsearch \n<match yakir.logs>\n  @type elasticsearch\n  host localhost\n  port 9200\n  logstash_format true\n</match>\n# \nhost elasticsearch \nport elasticsearch \nhostselasticsearch  ip1:port1,ip2:port2...\nuserpasswordelasticsearch \nscheme https  http http \npathREST \nindex_nameindex \nlogstash_formatindex  logstash logstash-%Y.%m.%d\nlogstash_prefixlogstash_format index logstash\n\n\n# kafka \n<match pattern>\n  @type kafka2\n\n  # list of seed brokers\n  brokers <broker1_host>:<broker1_port>,<broker2_host>:<broker2_port>\n  use_event_time true\n\n  # buffer settings\n  <buffer topic>\n    @type file\n    path /var/log/td-agent/buffer/td\n    flush_interval 3s\n  </buffer>\n\n  # data type settings\n  <format>\n    @type json\n  </format>\n\n  # topic settings\n  topic_key topic\n  default_topic messages\n\n  # producer settings\n  required_acks -1\n  compression_codec gzip\n</match>\n# \nbrokersKafka brokers \ntopic_keyrecord  key  Kafka  key\ndefault_topic topic_key topic \nformat \nuse_event_time fluentd event  Kafka  false\nrequired_acksproducer acks \ncompression_codec\n```\n\n- **webhdfs REST  event  HDFS Hadoop**\n```shell\n  <store>\n    @type webhdfs\n    host 1.1.1.1\n    port 50070\n    path \"/history/access.log.%Y%m%d_%H.#{Socket.gethostname}.log\"\n    <buffer>\n        flush_interval 60s\n    </buffer>\n  </store>\n```\n\n#### parser \n\n- **regexp time_key  event  time **\n> [http://fluentular.herokuapp.com/](http://fluentular.herokuapp.com/)\n\n```shell\n# \n<parse>\n  @type regexp\n  expression /^\\[(?<logtime>[^\\]]*)\\] (?<name>[^ ]*) (?<title>[^ ]*) (?<id>\\d*)$/\n  time_key logtime\n  time_format %Y-%m-%d %H:%M:%S %z\n  types id:integer\n</parse>\n\n# \n#\n[2013-02-28 12:00:00 +0900] alice engineer 1\n#\ntime:\n1362020400 (2013-02-28 12:00:00 +0900)\n\nrecord:\n{\n  \"name\" : \"alice\",\n  \"title\": \"engineer\",\n  \"id\"   : 1\n}\n```\n\n#### filter \n\n- **record_transformer event **\n```shell\n#  ruby \ncat > fluent.conf << \"EOF\"\n<source>\n  @type dummy\n  dummy {\"foo\":\"bar\", \"id1\": 100, \"id2\": 50}\n  tag yakir.test\n  size 1\n  rate 1\n</source>\n\n<filter>\n  @type record_transformer\n  enable_ruby true\n  <record>\n    hostname \"#{Socket.gethostname}\"\n    tag ${tag}\n    avg ${record[\"id1\"] / record[\"id2\"]}\n  </record>\n</filter>\n\n<match yakir.**>\n  @type stdout\n</match>\nEOF\n# \ndocker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd\n2022-07-04 10:12:53.028623276 +0000 yakir.test: {\"foo\":\"bar\",\"id1\":100,\"id2\":50,\"hostname\":\"7d5e83c528c7\",\"tag\":\"yakir.test\",\"avg\":2}\n\n\n# \n#\n<filter foo.bar>\n  @type record_transformer\n  <record>\n    message yay, ${record[\"message\"]}\n  </record>\n</filter>\n\n\n# \n#\n{ \"message\": \"hello world!\" }\n#\ntime:\n{ \"message\": \"yay, hello world!\" }\n\n```\n\n- **record **\n```shell\n# \n<record>\n  NEW_FIELD NEW_VALUE\n</record>\n\n# \nrecord record record[\"count\"]\ntag tag \ntime\nhostname#{Socket.gethostname}\ntag_parts[N]tag . tag  N \ntag_prefix[N] tag  0-N \ntag_suffix[N] tag  N-\n```\n\n### DaemonSet \n{% asset_img fluent2.png %}\n####  Elasticsearch  Kibana\n```shell\n#  namespace\nkubectl create ns logging\n\n#  ElasticsearchStatefulSet  Serviceservice \ncat > elasticsearch.yaml << \"EOF\"\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: es\n  namespace: logging\nspec:\n  serviceName: elasticsearch\n  replicas: 1\n  selector:\n    matchLabels:\n      app: elasticsearch\n  template:\n    metadata:\n      labels:\n        app: elasticsearch\n    spec:\n      # \n      initContainers:\n      - name: increase-vm-max-map\n        image: busybox\n        command: [\"sysctl\", \"-w\", \"vm.max_map_count=262144\"]\n        securityContext:\n          privileged: true\n      - name: increase-fd-ulimit\n        image: busybox\n        command: [\"sh\", \"-c\", \"ulimit -n 65536\"]\n        securityContext:\n          privileged: true\n      containers:\n      - name: elasticsearch\n        image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2\n        resources:\n          limits:\n            cpu: 1000m\n          requests:\n            cpu: 100m\n        ports:\n        - containerPort: 9200\n          name: rest\n          protocol: TCP\n        - containerPort: 9300\n          name: inter-node\n          protocol: TCP\n        volumeMounts:\n        - name: data\n          mountPath: /usr/share/elasticsearch/data\n        env:\n          - name: cluster.name\n            value: k8s-logs\n          - name: node.name\n            valueFrom:\n              fieldRef:\n                fieldPath: metadata.name\n          # ES \n          - name: cluster.initial_master_nodes\n            value: \"es-0\"\n          - name: discovery.zen.minimum_master_nodes\n            value: \"1\"\n          - name: discovery.seed_hosts\n            value: \"elasticsearch\"\n          - name: ES_JAVA_OPTS\n            value: \"-Xms512m -Xmx512m\"\n          - name: network.host\n            value: \"0.0.0.0\"\n      #  StorageClass \n      volumes:\n      - name: data\n        emptyDir: {}\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: elasticsearch\n  namespace: logging\n  labels:\n    app: elasticsearch\nspec:\n  selector:\n    app: elasticsearch\n  # StatefulSet  Pod  DNS  es-0.elasticsearch.logging.svc.cluster.local\n  clusterIP: None\n  ports:\n    - port: 9200\n      name: rest\n    - port: 9300\n      name: inter-node\nEOF\n\n#  Kibana \ncat > kibana.yaml << \"EOF\"\napiVersion: v1\nkind: Service\nmetadata:\n  name: kibana\n  namespace: logging\n  labels:\n    app: kibana\nspec:\n  selector:\n    app: kibana\n  ports:\n  - port: 5601\n  type: ClusterIP\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: kibana\n  namespace: logging\n  labels:\n    app: kibana\nspec:\n  selector:\n    matchLabels:\n      app: kibana\n  template:\n    metadata:\n      labels:\n        app: kibana\n    spec:\n      containers:\n      - name: kibana\n        image: docker.elastic.co/kibana/kibana:7.6.2\n        resources:\n          limits:\n            cpu: 1000m\n          requests:\n            cpu: 200m\n        env:\n        - name: ELASTICSEARCH_HOSTS\n          value: http://elasticsearch:9200\n        ports:\n        - containerPort: 5601\nEOF\n\n# \nkubectl apply -f elasticsearch.yaml\nkubectl apply -f kibana.yaml\nkubectl get pod,svc -n logging -owide\nNAME                          READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES\npod/es-0                      1/1     Running   0          4h54m   172.17.0.6   minikube   <none>           <none>\npod/kibana-6c84594848-mdp76   1/1     Running   0          158m    172.17.0.5   minikube   <none>           <none>\n\nNAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE     SELECTOR\nservice/elasticsearch   ClusterIP   None           <none>        9200/TCP,9300/TCP   4h50m   app=elasticsearch\nservice/kibana          ClusterIP   10.106.67.32   <none>        5601/TCP            158m    app=kibana\n\n# \nkubectl port-forward services/elasticsearch -n logging --address 127.0.0.1 9200:9200\ncurl http://127.0.0.1:9200/_cluster/state?pretty\ncurl 10.106.67.32:5601/app/kibana -I\n```\n\n####  Fluentd\n```shell\n# \n# git clone https://github.com/fluent/fluentd-kubernetes-daemonset.git\n\n# \n#Fluentd \ncat > fluentd-cfg.yaml << \"EOF\"\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: fluentd-config\n  namespace: logging\ndata:\n  system.conf: |-\n    <system>\n      root_dir /tmp/fluentd-buffers/\n    </system>\n  containers.input.conf: |-\n    <source>\n      @id fluentd-containers.log\n      @type tail                              # Fluentd \n      path /var/log/containers/*.log          # Docker\n      pos_file /var/log/es-containers.log.pos\n      tag raw.kubernetes.*                    # \n      read_from_head true\n      <parse>                                 # JSON\n        @type multi_format                    #  multi-format-parser \n        <pattern>\n          format json                         # JSON\n          time_key time                       # \n          time_format %Y-%m-%dT%H:%M:%S.%NZ   # \n        </pattern>\n        <pattern>\n          format /^(?<time>.+) (?<stream>stdout|stderr) [^ ]* (?<log>.*)$/\n          time_format %Y-%m-%dT%H:%M:%S.%N%:z\n        </pattern>\n      </parse>\n    </source>\n    # \n    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions\n    <match raw.kubernetes.**>           # tagraw.kubernetes.**\n      @id raw.kubernetes\n      @type detect_exceptions           # detect-exceptions\n      remove_tag_prefix raw             #  raw \n      message log\n      stream stream\n      multiline_flush_interval 5\n      max_bytes 500000\n      max_lines 1000\n    </match>\n\n    <filter **>  # \n      @id filter_concat\n      @type concat                # Fluentd Filter \n      key message\n      multiline_end_regexp /\\n$/  # \\n\n      separator \"\"\n    </filter>\n\n    #  Kubernetes metadata \n    <filter kubernetes.**>\n      @id filter_kubernetes_metadata\n      @type kubernetes_metadata\n    </filter>\n\n    #  ES  JSON \n    # https://github.com/repeatedly/fluent-plugin-multi-format-parser\n    <filter kubernetes.**>\n      @id filter_parser\n      @type parser                # multi-format-parser\n      key_name log                # \n      reserve_data true           # \n      remove_key_name_field true  # key_name \n      <parse>\n        @type multi_format\n        <pattern>\n          format json\n        </pattern>\n        <pattern>\n          format none\n        </pattern>\n      </parse>\n    </filter>\n\n    # \n    <filter kubernetes.**>\n      @type record_transformer\n      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash\n    </filter>\n\n    # logging=truePod\n    <filter kubernetes.**>\n      @id filter_log\n      @type grep\n      <regexp>\n        key $.kubernetes.labels.logging\n        pattern ^true$\n      </regexp>\n    </filter>\n\n  ######  ######\n  forward.input.conf: |-\n    # TCP\n    <source>\n      @id forward\n      @type forward\n    </source>\n\n  output.conf: |-\n    <match **>\n      @id elasticsearch\n      @type elasticsearch\n      @log_level info\n      include_tag_key true\n      host elasticsearch\n      port 9200\n      logstash_format true\n      logstash_prefix k8s  #  index  k8s\n      request_timeout    30s\n      <buffer>\n        @type file\n        path /var/log/fluentd-buffers/kubernetes.system.buffer\n        flush_mode interval\n        retry_type exponential_backoff\n        flush_thread_count 2\n        flush_interval 5s\n        retry_forever\n        retry_max_interval 30\n        chunk_limit_size 2M\n        queue_limit_length 8\n        overflow_action block\n      </buffer>\n    </match>\nEOF\n\n\ncat > fluentd-daemonset.yaml << \"EOF\"\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - \"namespaces\"\n  - \"pods\"\n  verbs:\n  - \"get\"\n  - \"watch\"\n  - \"list\"\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nsubjects:\n- kind: ServiceAccount\n  name: fluentd-es\n  namespace: logging\n  apiGroup: \"\"\nroleRef:\n  kind: ClusterRole\n  name: fluentd-es\n  apiGroup: \"\"\n---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nspec:\n  selector:\n    matchLabels:\n      k8s-app: fluentd-es\n  template:\n    metadata:\n      labels:\n        k8s-app: fluentd-es\n        kubernetes.io/cluster-service: \"true\"\n      # fluentd pod \n      annotations:\n        priorityClassName: system-cluster-critical\n    spec:\n      serviceAccountName: fluentd-es\n      containers:\n      - name: fluentd-es\n        image: quay.io/fluentd_elasticsearch/fluentd:v3.0.1\n        #image: fluent/fluentd-kubernetes-daemonset:v1.14.6-debian-elasticsearch7-1.1\n        env:\n        - name: FLUENTD_ARGS\n          value: --no-supervisor -q\n        resources:\n          limits:\n            memory: 500Mi\n          requests:\n            cpu: 100m\n            memory: 200Mi\n        volumeMounts:\n        - name: varlog\n          mountPath: /var/log\n        - name: varlibdockercontainers\n          mountPath: /var/lib/docker/containers\n          readOnly: true\n        - name: config-volume\n          mountPath: /etc/fluent/config.d\n      #  master  master \n      tolerations:\n      - operator: Exists\n      terminationGracePeriodSeconds: 30\n      # \n      volumes:\n      - name: varlog\n        hostPath:\n          path: /var/log\n      - name: varlibdockercontainers\n        hostPath:\n          path: /var/lib/docker/containers\n      - name: config-volume\n        configMap:\n          name: fluentd-config\nEOF\n\n# \nkubectl apply -f fluentd-cfg.yaml\nkubectl apply -f fluentd-daemonset.yaml\nkubectl get pod -n logging -owide\nNAME                          READY   STATUS    RESTARTS        AGE     IP           NODE       NOMINATED NODE   READINESS GATES\npod/fluentd-es-cfdcx          1/1     Running   0               91m     172.17.0.7   minikube   <none>           <none>\n\n```\n#### \n```shell\n# \ncat > stdin.yaml << \"EOF\"\napiVersion: v1\nkind: Pod\nmetadata:\n  name: counter1\n  labels:\n    # \n    logging: \"true\"\nspec:\n  containers:\n    - image: busybox\n      args: [\"/bin/sh\",\"-c\", 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 5; done']\n      name: counter\nEOF\n\n# sidecar \ncat > sidecar.yaml << \"EOF\"\napiVersion: v1\nkind: Pod\nmetadata:\n  name: counter2\n  labels:\n    logging: \"true\"\nspec:\n  containers:\n  - name: counter2\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - >\n      i=0;\n      while true;\n      do\n        echo \"$i: $(date)\" >> /var/log/1.log;\n        echo \"$(date) INFO $i\" >> /var/log/2.log;\n        i=$((i+1));\n        sleep 3;\n      done\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-log-1\n    image: busybox\n    args: [/bin/sh, -c, 'tail -n 1 -f /var/log/1.log']\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-log-2\n    image: busybox\n    args: [/bin/sh, -c, 'tail -n 1 -f /var/log/2.log']\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  restartPolicy: Never\n  volumes:\n  - name: varlog\n    emptyDir: {}\nEOF\n# kubectl logs counter2 count-log-2 -f --tail 3\n\n#  JSON \ncat > dummylogs.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dummylogs\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: dummylogs\n  template:\n    metadata:\n      labels:\n        app: dummylogs\n        logging: \"true\"  # \n    spec:\n      containers:\n      - name: dummy\n        image: cnych/dummylogs:latest\n        args:\n        - msg-processor\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dummylogs2\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: dummylogs2\n  template:\n    metadata:\n      labels:\n        app: dummylogs2\n        logging: \"true\"  # \n    spec:\n      containers:\n      - name: dummy\n        image: cnych/dummylogs:latest\n        args:\n        - msg-receiver-api\nEOF\n\n# \nkubectl apply -f counter.yaml\nkubectl apply -f dummylogs.yaml\n```\n#### Kibana  & Elasticsearch \n\n-  Kibana  & Elasticsearch \n```shell\nkubectl port-forward services/kibana -n logging --address 127.0.0.1 5601:5601\nkubectl port-forward services/elasticsearch -n logging --address 127.0.0.1 9200:9200\n```\n\n- \n\n{% asset_img fluent3.png %}\n{% asset_img fluent4.png %}\n\n- Kibana \n#### \n```shell\ncat > elastalert.yaml << \"EOF\"\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: elastalert-config\n  namespace: logging\n  labels:\n    app: elastalert\ndata:\n  elastalert_config: |-\n    ---\n    rules_folder: /opt/rules       # \n    scan_subdirectories: false\n    run_every:                     #  ES \n      minutes: 1\n    buffer_time:\n      minutes: 15\n    es_host: elasticsearch\n    es_port: 9200\n    writeback_index: elastalert\n    use_ssl: False\n    verify_certs: True\n    alert_time_limit:             # \n      minutes: 720\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: elastalert-rules\n  namespace: logging\n  labels:\n    app: elastalert\ndata:\n  rule_config.yaml: |-\n    name: dummylogs error     # \n    es_host: elasticsearch\n    es_port: 9200\n    type: any                 # \n    index: k8s-*              # es\n    filter:                   # \n    - query:\n        query_string:\n          query: \"LOGLEVEL:ERROR\"  # \n    alert:                         # \n    - \"email\"\n    smtp_host: 127.0.0.1\n    smtp_port: 587\n    smtp_auth_file: /opt/auth/smtp_auth_file.yaml\n    email_reply_to: xxx@gmail.com\n    from_addr: xxx@gmail.com\n    email:                  # \n    - \"xxx@gmail.com\"\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: elastalert\n  namespace: logging\n  labels:\n    app: elastalert\nspec:\n  selector:\n    matchLabels:\n      app: elastalert\n  template:\n    metadata:\n      labels:\n        app: elastalert\n    spec:\n      containers:\n      - name: elastalert\n        image: jertel/elastalert-docker:0.2.4\n        imagePullPolicy: IfNotPresent\n        volumeMounts:\n        - name: config\n          mountPath: /opt/config\n        - name: rules\n          mountPath: /opt/rules\n        - name: auth\n          mountPath: /opt/auth\n        resources:\n          limits:\n            cpu: 50m\n            memory: 256Mi\n          requests:\n            cpu: 50m\n            memory: 256Mi\n      volumes:\n      - name: auth\n        secret:\n          secretName: smtp-auth\n      - name: rules\n        configMap:\n          name: elastalert-rules\n      - name: config\n        configMap:\n          name: elastalert-config\n          items:\n          - key: elastalert_config\n            path: elastalert_config.yaml\nEOF\n\n# \ncat > smtp_auth_file.yaml << EOF\nuser: \"xxxxx@gmail.com\"\npassword: \"123xxx\"\nEOF\n\n# \nkubectl create secret generic smtp-auth --from-file=smtp_auth_file.yaml -n logging\nkubectl apply -f elastalert.yaml\nkubectl get pods -n logging -l app=elastalert\n# Kibana \n```\n\n### fluentd-operator \n#### CRD \n**fluentbit.fluent.io **\n\n- FluentBit Fluent Bit \n- ClusterFluentBitConfig Fluent Bit \n- ClusterInput Fluent Bit  input \n- ClusterFilter Fluent Bit  filter \n- ClusterParser Fluent Bit  parser \n- ClusterOutput Fluent Bit  output \n\n**fluentd.fluent.io **\n\n- Fluentd Fluentd \n- FluentdConfig Fluentd namespace \n- ClusterFluentdConfig Fluentd \n- Filter Fluentd namespace  filter \n- ClusterFilter Fluentd  filter \n- Output Fluentd namespace  output \n- ClusterOutput Fluentd  output \n\n####  CRD  fluent-operator\n```shell\n#  CRD  fluent-operator\ngit clone https://github.com/fluent/fluent-operator\ncd fluent-operator && kubectl apply -f manifests/setup/setup.yaml\n\n# \nkubectl get pod,crd -n fluent\nNAME                                   READY   STATUS    RESTARTS        AGE\npod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (5h20m ago)   22h\n\nNAME                                                                                        CREATED AT\ncustomresourcedefinition.apiextensions.k8s.io/clusterfilters.fluentbit.fluent.io            2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusterfilters.fluentd.fluent.io              2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusterfluentbitconfigs.fluentbit.fluent.io   2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusterfluentdconfigs.fluentd.fluent.io       2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusterinputs.fluentbit.fluent.io             2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusteroutputs.fluentbit.fluent.io            2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusteroutputs.fluentd.fluent.io              2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/clusterparsers.fluentbit.fluent.io            2022-07-05T07:45:26Z\ncustomresourcedefinition.apiextensions.k8s.io/filters.fluentd.fluent.io                     2022-07-05T07:45:27Z\ncustomresourcedefinition.apiextensions.k8s.io/fluentbits.fluentbit.fluent.io                2022-07-05T07:45:27Z\ncustomresourcedefinition.apiextensions.k8s.io/fluentdconfigs.fluentd.fluent.io              2022-07-05T07:45:27Z\ncustomresourcedefinition.apiextensions.k8s.io/fluentds.fluentd.fluent.io                    2022-07-05T07:45:27Z\ncustomresourcedefinition.apiextensions.k8s.io/outputs.fluentd.fluent.io                     2022-07-05T07:45:28Z\n```\n\n#### Fluent Bit Only \n```shell\n#  Fluent Bit \ncat > fluent-bit.yaml << \"EOF\"\napiVersion: fluentbit.fluent.io/v1alpha2\nkind: FluentBit\nmetadata:\n  name: fluent-bit\n  namespace: fluent\n  labels:\n    app.kubernetes.io/name: fluent-bit\nspec:\n  image: kubesphere/fluent-bit:v1.8.11\n  positionDB:\n    hostPath:\n      path: /var/lib/fluent-bit/\n  resources:\n    requests:\n      cpu: 10m\n      memory: 25Mi\n    limits:\n      cpu: 500m\n      memory: 200Mi\n  fluentBitConfigName: fluent-bit-config\n  tolerations:\n    - operator: Exists\n---\napiVersion: fluentbit.fluent.io/v1alpha2\nkind: ClusterFluentBitConfig\nmetadata:\n  name: fluent-bit-config\n  labels:\n    app.kubernetes.io/name: fluent-bit\nspec:\n  service:\n    parsersFile: parsers.conf\n  inputSelector:\n    matchLabels:\n      fluentbit.fluent.io/enabled: \"true\"\n      fluentbit.fluent.io/mode: \"k8s\"\n  filterSelector:\n    matchLabels:\n      fluentbit.fluent.io/enabled: \"true\"\n      fluentbit.fluent.io/mode: \"k8s\"\n  outputSelector:\n    matchLabels:\n      fluentbit.fluent.io/enabled: \"true\"\n      fluentbit.fluent.io/mode: \"k8s\"\n---\napiVersion: fluentbit.fluent.io/v1alpha2\nkind: ClusterInput\nmetadata:\n  name: tail\n  labels:\n    fluentbit.fluent.io/enabled: \"true\"\n    fluentbit.fluent.io/mode: \"k8s\"\nspec:\n  tail:\n    tag: kube.*\n    path: /var/log/containers/*.log\n    parser: docker\n    refreshIntervalSeconds: 10\n    memBufLimit: 5MB\n    skipLongLines: true\n    db: /fluent-bit/tail/pos.db\n    dbSync: Normal\n---\napiVersion: fluentbit.fluent.io/v1alpha2\nkind: ClusterOutput\nmetadata:\n  name: es\n  labels:\n    fluentbit.fluent.io/enabled: \"true\"\n    fluentbit.fluent.io/mode: \"k8s\"\nspec:\n  matchRegex: (?:kube|service)\\.(.*)\n  es:\n    host: elasticsearch\n    port: 9200\n    generateID: true\n    logstashPrefix: fluent-log-fb-only\n    logstashFormat: true\n    timeKey: \"@timestamp\"\nEOF\n#  output  elasticsearch \nkubectl apply -f elasticsearch.yaml\nkubectl apply -f fluent-bit.yaml\n\n# \nkubectl get pod,svc -n fluent\nNAME                                   READY   STATUS    RESTARTS      AGE\npod/es-0                               1/1     Running   1 (56m ago)   17h\npod/fluent-bit-rjqsd                   1/1     Running   0             2m34s\npod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (56m ago)   17h\nNAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE\nservice/elasticsearch   ClusterIP   None         <none>        9200/TCP,9300/TCP   17h\n\n#  Elasticsearch \nkubectl port-forward services/elasticsearch -n fluent --address 127.0.0.1 9200:9200\n#\ncurl \"127.0.0.1:9200/_cat/indices?pretty\"\nyellow open fluent-log-fb-only-2022.07.06 lLmstFnwQLa89Jb7TFe-0Q 1 1 152 0 155.2kb 155.2kb \n#\ncurl \"127.0.0.1:9200/fluent-log-fb-only-2022.07.06/_search?pretty\"\n...\n# ID \ncurl \"127.0.0.1:9200/fluent-log-fb-only-2022.07.06/_doc/b641529e-255c-f260-f911-f7d00d84e3fe?pretty\"\n{\n  \"_index\" : \"fluent-log-fb-only-2022.07.06\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"b641529e-255c-f260-f911-f7d00d84e3fe\",\n  \"_version\" : 1,\n  \"_seq_no\" : 94,\n  \"_primary_term\" : 1,\n  \"found\" : true,\n  \"_source\" : {\n    \"@timestamp\" : \"2022-07-06T02:57:38.035Z\",\n    \"log\" : \"[2022/07/06 02:57:38] [ info] [input:tail:tail.0] inotify_fs_add(): inode=2050771 watch_fd=3 name=/var/log/containers/dashboard-metrics-scraper-58549894f-q9lpg_kubernetes-dashboard_dashboard-metrics-scraper-51061ac5d9c2c7c2da734ab35b9252edb29f4101ade5679a22181d0d735dc364.log\\n\",\n    \"time\" : \"2022-07-06T02:57:38.035319145Z\",\n    \"kubernetes\" : {\n      \"pod_name\" : \"fluent-bit-8v2qn\",\n      \"namespace_name\" : \"fluent\",\n      \"container_name\" : \"fluent-bit\",\n      \"docker_id\" : \"098d8ac65b201686b7a2945df6ee1a919b7220b637aea4de6490d92569c9c455\",\n      \"container_image\" : \"kubesphere/fluent-bit:v1.8.11\"\n    }\n  }\n}\n```\n\n#### Fluent Bit + Fluentd \n```shell\n#  Fluent Bit output  forward  Fluentd\ncat >> fluent-bit.yaml << \"EOF\"\napiVersion: fluentbit.fluent.io/v1alpha2\nkind: ClusterOutput\nmetadata:\n  name: fluentd\n  labels:\n    fluentbit.fluent.io/enabled: \"true\"\n    fluentbit.fluent.io/component: logging\nspec:\n  matchRegex: (?:kube|service)\\.(.*)\n  forward:\n    host: fluentd.fluent.svc\n    port: 24224\nEOF\n\n#  Fluentd \ncat > fluentd.yaml << \"EOF\"\napiVersion: fluentd.fluent.io/v1alpha1\nkind: Fluentd\nmetadata:\n  name: fluentd\n  namespace: fluent\n  labels:\n    app.kubernetes.io/name: fluentd\nspec:\n  globalInputs:\n  - forward:\n      bind: 0.0.0.0\n      port: 24224\n  replicas: 1\n  image: kubesphere/fluentd:v1.14.4\n  fluentdCfgSelector:\n    matchLabels:\n      config.fluentd.fluent.io/enabled: \"true\"\nEOF\n\n#  Fluentd\n#1. ClusterFluentdConfig  kube-system  default  namesapce  ClusterOutput\ncat >> fluentd.yaml << \"EOF\"\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterFluentdConfig\nmetadata:\n  name: cluster-fluentd-config\n  labels:\n    config.fluentd.fluent.io/enabled: \"true\"\nspec:\n  watchedNamespaces:\n  - kube-system\n  - default\n  clusterOutputSelector:\n    matchLabels:\n      output.fluentd.fluent.io/scope: \"cluster\"\n      output.fluentd.fluent.io/enabled: \"true\"\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterOutput\nmetadata:\n  name: cluster-fluentd-output-es\n  labels:\n    output.fluentd.fluent.io/scope: \"cluster\"\n    output.fluentd.fluent.io/enabled: \"true\"\nspec:\n  outputs:\n  - elasticsearch:\n      host: elasticsearch-master.elastic.svc\n      port: 9200\n      logstashFormat: true\n      logstashPrefix: fluent-log-cluster-fd\nEOF\n#2. FluentdConfig + ClusterFluentdConfig  namespace  Output  ClusterOutput\ncat >> fluentd.yaml << \"EOF\"\napiVersion: fluentd.fluent.io/v1alpha1\nkind: FluentdConfig\nmetadata:\n  name: namespace-fluentd-config-user1\n  namespace: fluent\n  labels:\n    config.fluentd.fluent.io/enabled: \"true\"\nspec:\n  outputSelector:\n    matchLabels:\n      output.fluentd.fluent.io/enabled: \"true\"\n      output.fluentd.fluent.io/user: \"user1\"\n  clusterOutputSelector:\n    matchLabels:\n      output.fluentd.fluent.io/enabled: \"true\"\n      output.fluentd.fluent.io/user: \"user1\"\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterFluentdConfig\nmetadata:\n  name: cluster-fluentd-config-cluster-only\n  labels:\n    config.fluentd.fluent.io/enabled: \"true\"\nspec:\n  watchedNamespaces:\n  - kube-system\n  - kubesphere-system\n  clusterOutputSelector:\n    matchLabels:\n      output.fluentd.fluent.io/enabled: \"true\"\n      output.fluentd.fluent.io/scope: \"cluster-only\"\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: Output\nmetadata:\n  name: namespace-fluentd-output-user1\n  namespace: fluent\n  labels:\n    output.fluentd.fluent.io/enabled: \"true\"\n    output.fluentd.fluent.io/user: \"user1\"\nspec:\n  outputs:\n  - elasticsearch:\n      host: elasticsearch-master.elastic.svc\n      port: 9200\n      logstashFormat: true\n      logstashPrefix: fluent-log-user1-fd\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterOutput\nmetadata:\n  name: cluster-fluentd-output-user1\n  labels:\n    output.fluentd.fluent.io/enabled: \"true\"\n    output.fluentd.fluent.io/user: \"user1\"\nspec:\n  outputs:\n  - elasticsearch:\n      host: elasticsearch-master.elastic.svc\n      port: 9200\n      logstashFormat: true\n      logstashPrefix: fluent-log-cluster-user1-fd\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterOutput\nmetadata:\n  name: cluster-fluentd-output-cluster-only\n  labels:\n    output.fluentd.fluent.io/enabled: \"true\"\n    output.fluentd.fluent.io/scope: \"cluster-only\"\nspec:\n  outputs:\n  - elasticsearch:\n      host: elasticsearch-master.elastic.svc\n      port: 9200\n      logstashFormat: true\n      logstashPrefix: fluent-log-cluster-only-fd\nEOF\n\n# Fluentd  buffer \ncat >> fluentd.yaml << \"EOF\"\napiVersion: fluentd.fluent.io/v1alpha1\nkind: ClusterOutput\nmetadata:\n  name: cluster-fluentd-output-buffer\n  labels:\n    output.fluentd.fluent.io/type: \"buffer\"\n    output.fluentd.fluent.io/enabled: \"true\"\nspec:\n  outputs:\n  - stdout: {}\n    buffer:\n      type: file\n      path: /buffers/stdout.log\n  - elasticsearch:\n      host: elasticsearch-master.elastic.svc\n      port: 9200\n      logstashFormat: true\n      logstashPrefix: fluent-log-buffer-fd\n    buffer:\n      type: file\n      path: /buffers/es.log\nEOF\n\n```\n\n#### Fluentd Only \n```shell\ncat > fluentd.yaml << \"EOF\"\napiVersion: fluentd.fluent.io/v1alpha1\nkind: Fluentd\nmetadata:\n  name: fluentd-http\n  namespace: fluent\n  labels:\n    app.kubernetes.io/name: fluentd\nspec:\n  globalInputs:\n    - http:\n        bind: 0.0.0.0\n        port: 9880\n  replicas: 1\n  image: kubesphere/fluentd:v1.14.4\n  fluentdCfgSelector:\n    matchLabels:\n      config.fluentd.fluent.io/enabled: \"true\"\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: FluentdConfig\nmetadata:\n  name: fluentd-only-config\n  namespace: fluent\n  labels:\n    config.fluentd.fluent.io/enabled: \"true\"\nspec:\n  filterSelector:\n    matchLabels:\n      filter.fluentd.fluent.io/mode: \"fluentd-only\"\n      filter.fluentd.fluent.io/enabled: \"true\"\n  outputSelector:\n    matchLabels:\n      output.fluentd.fluent.io/mode: \"fluentd-only\"\n      output.fluentd.fluent.io/enabled: \"true\"\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: Filter\nmetadata:\n  name: fluentd-only-filter\n  namespace: fluent\n  labels:\n    filter.fluentd.fluent.io/mode: \"fluentd-only\"\n    filter.fluentd.fluent.io/enabled: \"true\"\nspec:\n  filters:\n    - stdout: {}\n---\napiVersion: fluentd.fluent.io/v1alpha1\nkind: Output\nmetadata:\n  name: fluentd-only-stdout\n  namespace: fluent\n  labels:\n    output.fluentd.fluent.io/mode: \"fluentd-only\"\n    output.fluentd.fluent.io/enabled: \"true\"\nspec:\n  outputs:\n    - stdout: {}\nEOF\n\n# \nkubectl get all -n fluent\nNAME                                   READY   STATUS    RESTARTS       AGE\npod/es-0                               1/1     Running   1 (163m ago)   19h\npod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (163m ago)   19h\npod/fluentd-http-0                     1/1     Running   0              2m53s\n\nNAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE\nservice/elasticsearch   ClusterIP   None         <none>        9200/TCP,9300/TCP   19h\nservice/fluentd-http    ClusterIP   10.97.96.1   <none>        9880/TCP            2m54s\n\nNAME                              READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/fluent-operator   1/1     1            1           19h\n\nNAME                                         DESIRED   CURRENT   READY   AGE\nreplicaset.apps/fluent-operator-86858cfc87   1         1         1       19h\n\nNAME                            READY   AGE\nstatefulset.apps/es             1/1     19h\nstatefulset.apps/fluentd-http   1/1     2m54s\n```\n\n\n> \n> 1[https://www.qikqiak.com/post/install-efk-stack-on-k8s/](https://www.qikqiak.com/post/install-efk-stack-on-k8s/)\n> 2fluentd [https://docs.fluentd.org/](https://docs.fluentd.org/)\n> 3fluentd-operator [https://github.com/fluent/fluent-operator](https://github.com/fluent/fluent-operator)\n> 4fluent-operator-walkthrough[https://github.com/kubesphere-sigs/fluent-operator-walkthrough](https://github.com/kubesphere-sigs/fluent-operator-walkthrough)\n> 5KubeSphere[https://kubesphere.com.cn/blogs/fluent-operator-logging](https://kubesphere.com.cn/blogs/fluent-operator-logging)\n\n\n","slug":"observability-fluentd-component","published":1,"updated":"2024-01-21T15:28:43.158Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zq001ps0njgnra83jk","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>Fluentd</strong><br> Kubernetes  node  fluentd + Elasticsearch</p>\n<img data-src=\"/posts/41fe/fluent1.png\" class>\n<blockquote>\n<p>fluentd source &gt; parser &gt; filter &gt; output</p>\n</blockquote>\n<p><strong>Elasticsearch</strong><br></p>\n<p><strong>Kibana</strong><br> Web GUI Elasticsearch  </p>\n<blockquote>\n<p></p>\n<ul>\n<li> agent daemonSet</li>\n<li> Pod  sidecar </li>\n<li></li>\n</ul>\n</blockquote>\n<span id=\"more\"></span>\n\n<h3 id=\"-x2F-\"><a href=\"#-x2F-\" class=\"headerlink\" title=\" &#x2F; \"></a> &#x2F; </h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://docs.fluentd.org/installation/before-install\">https://docs.fluentd.org/installation/before-install</a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://hub.docker.com/r/fluent/fluentd\">https://hub.docker.com/r/fluent/fluentd</a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>fluentd  tag <br>source -&gt; parser -&gt; filter -&gt; output</p>\n</blockquote>\n<h4 id=\"input-\"><a href=\"#input-\" class=\"headerlink\" title=\"input \"></a>input </h4><ul>\n<li><p><strong>http http </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">mkdir /tmp/fluentd &amp;&amp; cd /tmp/fluentd</span><br><span class=\"line\">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type http</span><br><span class=\"line\">  port 9880</span><br><span class=\"line\">  bind 0.0.0.0</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match **&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> fluentd  fluent.conf </span></span><br><span class=\"line\">docker run -p 9880:9880 --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> http </span></span><br><span class=\"line\">curl -X POST 127.0.0.1:9880/yakir.test -d &#x27;json=&#123;&quot;a&quot;:&quot;aaa&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>tail</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type tail</span><br><span class=\"line\">  path /var/log/httpd-access.log</span><br><span class=\"line\">  path_key tailed_path</span><br><span class=\"line\">  pos_file /var/log/td-agent/httpd-access.log.pos</span><br><span class=\"line\">  tag apache.access</span><br><span class=\"line\">  &lt;parse&gt;</span><br><span class=\"line\">    @type apache2</span><br><span class=\"line\">  &lt;/parse&gt;</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>exec event</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type exec</span><br><span class=\"line\">  tag yakir.test</span><br><span class=\"line\">  command cat /proc/loadavg | cut -d &#x27; &#x27; -f 1,2,3</span><br><span class=\"line\">  run_interval 10s</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;parse&gt;</span><br><span class=\"line\">    @type tsv</span><br><span class=\"line\">    keys avg1,avg5,avg15</span><br><span class=\"line\">    delimiter &quot; &quot;</span><br><span class=\"line\">  &lt;/parse&gt;</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match **&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\">2022-06-30 08:43:20.377146682 +0000 yakir.test: &#123;&quot;avg1&quot;:&quot;0.12&quot;,&quot;avg5&quot;:&quot;0.16&quot;,&quot;avg15&quot;:&quot;0.17&quot;&#125;</span><br><span class=\"line\">2022-06-30 08:43:30.347891525 +0000 yakir.test: &#123;&quot;avg1&quot;:&quot;0.10&quot;,&quot;avg5&quot;:&quot;0.15&quot;,&quot;avg15&quot;:&quot;0.17&quot;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>syslog rsyslog  rsyslog </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">    @type syslog</span><br><span class=\"line\">    port 5140</span><br><span class=\"line\">    bind 0.0.0.0</span><br><span class=\"line\">    tag system</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match **&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> udp </span></span><br><span class=\"line\">docker run -p 5140:5140/udp --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> rsyslog  fluent</span></span><br><span class=\"line\">cat &gt;&gt; /etc/rsyslog.d/50-default.conf &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">*.* @127.0.0.1:5140</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">logger </span></span><br><span class=\"line\">logger -p mail.info &#x27;this is info message&#x27;</span><br><span class=\"line\">logger -p mail.warning &#x27;this is warning message&#x27;</span><br><span class=\"line\">2022-07-04 10:27:48.000000000 +0000 system.mail.info: &#123;&quot;host&quot;:&quot;minikube&quot;,&quot;ident&quot;:&quot;root&quot;,&quot;message&quot;:&quot;this is info message&quot;&#125;</span><br><span class=\"line\">2022-07-04 10:28:11.000000000 +0000 system.mail.warn: &#123;&quot;host&quot;:&quot;minikube&quot;,&quot;ident&quot;:&quot;root&quot;,&quot;message&quot;:&quot;this is warning message&quot;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>dummy</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">    @type dummy</span><br><span class=\"line\">    dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class=\"line\">    size 3</span><br><span class=\"line\">    rate 1</span><br><span class=\"line\">    tag yakir.test</span><br><span class=\"line\">    auto_increment_key primary_key</span><br><span class=\"line\">    suspend true</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match **&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">size     # event </span><br><span class=\"line\">rate     # event</span><br><span class=\"line\">auto_increment_key   #</span><br><span class=\"line\">suspend              #</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\">2022-07-04 02:51:37.044796145 +0000 yakir.test: &#123;&quot;foo&quot;:&quot;bar&quot;,&quot;primary_key&quot;:0&#125;</span><br><span class=\"line\">2022-07-04 02:51:37.044834743 +0000 yakir.test: &#123;&quot;foo&quot;:&quot;bar&quot;,&quot;primary_key&quot;:1&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>forward fluentd forward  event</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type forward</span><br><span class=\"line\">  port 24224</span><br><span class=\"line\">  bind 0.0.0.0</span><br><span class=\"line\">&lt;/source&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"output-\"><a href=\"#output-\" class=\"headerlink\" title=\"output \"></a>output </h4></li>\n<li><p><strong>file event </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type dummy</span><br><span class=\"line\">  dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class=\"line\">  tag yakir.test</span><br><span class=\"line\">  size 1</span><br><span class=\"line\">  rate 1</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match yakir.**&gt;</span><br><span class=\"line\">  @type file</span><br><span class=\"line\">  path /tmp/fluent/yakir</span><br><span class=\"line\">  compress gzip</span><br><span class=\"line\">  &lt;buffer&gt;</span><br><span class=\"line\">    timekey 1d</span><br><span class=\"line\">    timekey_use_utc true</span><br><span class=\"line\">    timekey_wait 10m</span><br><span class=\"line\">  &lt;/buffer&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">@<span class=\"built_in\">type</span> file</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">path /tmp/<span class=\"variable\">$&#123;tag[0]&#125;</span>/file.%Y-%m-%d-%H-%M-%S</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">&lt;buffer tag,time&gt;</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> timekey 10</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> timekey_wait 10</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> timekey_use_utc <span class=\"literal\">true</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">&lt;/buffer&gt;</span></span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">path placeholdertag  record /path/to/$&#123;tag&#125;/$&#123;key1&#125;/file.%Y%m%d</span><br><span class=\"line\">appendflush  chuck  false</span><br><span class=\"line\">format  out_file</span><br><span class=\"line\">inject  event  time  tag </span><br><span class=\"line\">add_path_suffix path </span><br><span class=\"line\">path_suffixpath .log</span><br><span class=\"line\">compress</span><br><span class=\"line\">recompress buffer chunk  false</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\">docker exec -it fluent /bin/sh</span><br><span class=\"line\">tail -2 /tmp/fluent/yakir/buffer.b5e2f5e063d4389bd9304563cf7f07656.log</span><br><span class=\"line\">2022-07-04T07:42:34+00:00\tyakir.test\t&#123;&quot;foo&quot;:&quot;bar&quot;&#125;</span><br><span class=\"line\">2022-07-04T07:42:35+00:00\tyakir.test\t&#123;&quot;foo&quot;:&quot;bar&quot;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>buffer </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;buffer&gt;</span><br><span class=\"line\">  @type file</span><br><span class=\"line\">&lt;/buffer&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">@<span class=\"built_in\">type</span> filememory</span></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;buffer ARGUMENT_CHUNK_KEYS&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">...</span></span><br><span class=\"line\">&lt;/buffer&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">buffer chunk keysbuffer  record  chunk key event  chunk file  buffer </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> time  chunk key buffer </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">timekey   timekey_waitflush </span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">timekey_use_utc</span><br><span class=\"line\">timekey_zone</span><br><span class=\"line\">chunk_limit_sizechunk  8MB</span><br><span class=\"line\">chunk_limit_recordschunk event </span><br><span class=\"line\">total_limit_size buffer </span><br><span class=\"line\">chunk_full_thresholdchunk  chunk_limit_size * chunk_full_threshold  flush</span><br><span class=\"line\">queued_chunks_limit_size chunk  flush  chunk</span><br><span class=\"line\">compress text  gzip text</span><br><span class=\"line\">flush_at_shutdown flush buffer  true buffer  false</span><br><span class=\"line\">flush_interval flush </span><br><span class=\"line\">retry_timeout flush  retry</span><br><span class=\"line\">retry_forever flush true  retry_timeout </span><br><span class=\"line\">retry_max_times</span><br><span class=\"line\">retry_typeretry </span><br><span class=\"line\">retry_wait</span><br><span class=\"line\">retry_exponential_backoff_baseretry </span><br><span class=\"line\">retry_max_interval retry </span><br><span class=\"line\">retry_randomize retry </span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>format </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;match&gt;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;format&gt;</span><br><span class=\"line\">    @type json</span><br><span class=\"line\">  &lt;/format&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;buffer&gt;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">  &lt;/buffer&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>forward event  fluentd  fluentd </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;match yakir.*&gt;</span><br><span class=\"line\">  @type forward</span><br><span class=\"line\">  send_timeout 60s</span><br><span class=\"line\">  recover_wait 10s</span><br><span class=\"line\">  hard_timeout 60s</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;server&gt;</span><br><span class=\"line\">    name myserver1</span><br><span class=\"line\">    host 192.168.1.3</span><br><span class=\"line\">    port 24224</span><br><span class=\"line\">    weight 60</span><br><span class=\"line\">  &lt;/server&gt;</span><br><span class=\"line\">  &lt;server&gt;</span><br><span class=\"line\">    name myserver2</span><br><span class=\"line\">    host 192.168.1.4</span><br><span class=\"line\">    port 24224</span><br><span class=\"line\">    weight 60</span><br><span class=\"line\">  &lt;/server&gt;</span><br><span class=\"line\">  ...</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;secondary&gt;</span><br><span class=\"line\">    @type file</span><br><span class=\"line\">    path /var/log/fluent/forward-failed</span><br><span class=\"line\">  &lt;/secondary&gt;</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">server </span></span><br><span class=\"line\">host</span><br><span class=\"line\">name</span><br><span class=\"line\">port</span><br><span class=\"line\">shared_key</span><br><span class=\"line\">username</span><br><span class=\"line\">password</span><br><span class=\"line\">standby  server  node  standby  node</span><br><span class=\"line\">weight </span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>copy event </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type dummy</span><br><span class=\"line\">  dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class=\"line\">  tag yakir.test</span><br><span class=\"line\">  size 1</span><br><span class=\"line\">  rate 1</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match yakir.**&gt;</span><br><span class=\"line\">  @type copy</span><br><span class=\"line\">  &lt;store&gt;</span><br><span class=\"line\">    @type file</span><br><span class=\"line\">    path /tmp/yakir/file.%Y%m%d</span><br><span class=\"line\">    compress gzip</span><br><span class=\"line\">  &lt;/store&gt;</span><br><span class=\"line\">  &lt;store ignore_error&gt;</span><br><span class=\"line\">    @type stdout</span><br><span class=\"line\">  &lt;/store&gt;</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">copy_mode </span><br><span class=\"line\">  no_copy event</span><br><span class=\"line\">  shallow</span><br><span class=\"line\">  deepmsgpack-ruby</span><br><span class=\"line\">  marshalmarshal</span><br><span class=\"line\">store  ignore_error  store </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>http http  eventpayload  format </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;match pattern&gt;</span><br><span class=\"line\">  @type http</span><br><span class=\"line\">  endpoint http://logserver.com:9000/api</span><br><span class=\"line\">  open_timeout 2</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;format&gt;</span><br><span class=\"line\">    @type json</span><br><span class=\"line\">  &lt;/format&gt;</span><br><span class=\"line\">  &lt;buffer&gt;</span><br><span class=\"line\">    flush_interval 10s</span><br><span class=\"line\">  &lt;/buffer&gt;</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> post 2s json10s  endpointcontent-type  application/x-ndjson</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>stdout fluentd </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type dummy</span><br><span class=\"line\">  dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class=\"line\">  tag yakir.test</span><br><span class=\"line\">  size 1</span><br><span class=\"line\">  rate 1</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match yakir.**&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ElasticsearchKafka</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">elasticsearch </span></span><br><span class=\"line\">&lt;match yakir.logs&gt;</span><br><span class=\"line\">  @type elasticsearch</span><br><span class=\"line\">  host localhost</span><br><span class=\"line\">  port 9200</span><br><span class=\"line\">  logstash_format true</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">host elasticsearch </span><br><span class=\"line\">port elasticsearch </span><br><span class=\"line\">hostselasticsearch  ip1:port1,ip2:port2...</span><br><span class=\"line\">userpasswordelasticsearch </span><br><span class=\"line\">scheme https  http http </span><br><span class=\"line\">pathREST </span><br><span class=\"line\">index_nameindex </span><br><span class=\"line\">logstash_formatindex  logstash logstash-%Y.%m.%d</span><br><span class=\"line\">logstash_prefixlogstash_format index logstash</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kafka </span></span><br><span class=\"line\">&lt;match pattern&gt;</span><br><span class=\"line\">  @type kafka2</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">list of seed brokers</span></span><br><span class=\"line\">  brokers &lt;broker1_host&gt;:&lt;broker1_port&gt;,&lt;broker2_host&gt;:&lt;broker2_port&gt;</span><br><span class=\"line\">  use_event_time true</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">buffer settings</span></span><br><span class=\"line\">  &lt;buffer topic&gt;</span><br><span class=\"line\">    @type file</span><br><span class=\"line\">    path /var/log/td-agent/buffer/td</span><br><span class=\"line\">    flush_interval 3s</span><br><span class=\"line\">  &lt;/buffer&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">data <span class=\"built_in\">type</span> settings</span></span><br><span class=\"line\">  &lt;format&gt;</span><br><span class=\"line\">    @type json</span><br><span class=\"line\">  &lt;/format&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">topic settings</span></span><br><span class=\"line\">  topic_key topic</span><br><span class=\"line\">  default_topic messages</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">producer settings</span></span><br><span class=\"line\">  required_acks -1</span><br><span class=\"line\">  compression_codec gzip</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">brokersKafka brokers </span><br><span class=\"line\">topic_keyrecord  key  Kafka  key</span><br><span class=\"line\">default_topic topic_key topic </span><br><span class=\"line\">format </span><br><span class=\"line\">use_event_time fluentd event  Kafka  false</span><br><span class=\"line\">required_acksproducer acks </span><br><span class=\"line\">compression_codec</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>webhdfs REST  event  HDFS Hadoop</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;store&gt;</span><br><span class=\"line\">  @type webhdfs</span><br><span class=\"line\">  host 1.1.1.1</span><br><span class=\"line\">  port 50070</span><br><span class=\"line\">  path &quot;/history/access.log.%Y%m%d_%H.#&#123;Socket.gethostname&#125;.log&quot;</span><br><span class=\"line\">  &lt;buffer&gt;</span><br><span class=\"line\">      flush_interval 60s</span><br><span class=\"line\">  &lt;/buffer&gt;</span><br><span class=\"line\">&lt;/store&gt;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"parser-\"><a href=\"#parser-\" class=\"headerlink\" title=\"parser \"></a>parser </h4><ul>\n<li><strong>regexp time_key  event  time </strong><blockquote>\n<p><a href=\"http://fluentular.herokuapp.com/\">http://fluentular.herokuapp.com/</a></p>\n</blockquote>\n</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">&lt;parse&gt;</span><br><span class=\"line\">  @type regexp</span><br><span class=\"line\">  expression /^\\[(?&lt;logtime&gt;[^\\]]*)\\] (?&lt;name&gt;[^ ]*) (?&lt;title&gt;[^ ]*) (?&lt;id&gt;\\d*)$/</span><br><span class=\"line\">  time_key logtime</span><br><span class=\"line\">  time_format %Y-%m-%d %H:%M:%S %z</span><br><span class=\"line\">  types id:integer</span><br><span class=\"line\">&lt;/parse&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">[2013-02-28 12:00:00 +0900] alice engineer 1</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">time:</span><br><span class=\"line\">1362020400 (2013-02-28 12:00:00 +0900)</span><br><span class=\"line\"></span><br><span class=\"line\">record:</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot; : &quot;alice&quot;,</span><br><span class=\"line\">  &quot;title&quot;: &quot;engineer&quot;,</span><br><span class=\"line\">  &quot;id&quot;   : 1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"filter-\"><a href=\"#filter-\" class=\"headerlink\" title=\"filter \"></a>filter </h4><ul>\n<li><p><strong>record_transformer event </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> ruby </span></span><br><span class=\"line\">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type dummy</span><br><span class=\"line\">  dummy &#123;&quot;foo&quot;:&quot;bar&quot;, &quot;id1&quot;: 100, &quot;id2&quot;: 50&#125;</span><br><span class=\"line\">  tag yakir.test</span><br><span class=\"line\">  size 1</span><br><span class=\"line\">  rate 1</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;filter&gt;</span><br><span class=\"line\">  @type record_transformer</span><br><span class=\"line\">  enable_ruby true</span><br><span class=\"line\">  &lt;record&gt;</span><br><span class=\"line\">    hostname &quot;#&#123;Socket.gethostname&#125;&quot;</span><br><span class=\"line\">    tag $&#123;tag&#125;</span><br><span class=\"line\">    avg $&#123;record[&quot;id1&quot;] / record[&quot;id2&quot;]&#125;</span><br><span class=\"line\">  &lt;/record&gt;</span><br><span class=\"line\">&lt;/filter&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match yakir.**&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\">2022-07-04 10:12:53.028623276 +0000 yakir.test: &#123;&quot;foo&quot;:&quot;bar&quot;,&quot;id1&quot;:100,&quot;id2&quot;:50,&quot;hostname&quot;:&quot;7d5e83c528c7&quot;,&quot;tag&quot;:&quot;yakir.test&quot;,&quot;avg&quot;:2&#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">&lt;filter foo.bar&gt;</span><br><span class=\"line\">  @type record_transformer</span><br><span class=\"line\">  &lt;record&gt;</span><br><span class=\"line\">    message yay, $&#123;record[&quot;message&quot;]&#125;</span><br><span class=\"line\">  &lt;/record&gt;</span><br><span class=\"line\">&lt;/filter&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">&#123; &quot;message&quot;: &quot;hello world!&quot; &#125;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">time:</span><br><span class=\"line\">&#123; &quot;message&quot;: &quot;yay, hello world!&quot; &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>record </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">&lt;record&gt;</span><br><span class=\"line\">  NEW_FIELD NEW_VALUE</span><br><span class=\"line\">&lt;/record&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">record record record[&quot;count&quot;]</span><br><span class=\"line\">tag tag </span><br><span class=\"line\">time</span><br><span class=\"line\">hostname#&#123;Socket.gethostname&#125;</span><br><span class=\"line\">tag_parts[N]tag . tag  N </span><br><span class=\"line\">tag_prefix[N] tag  0-N </span><br><span class=\"line\">tag_suffix[N] tag  N-</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"DaemonSet-\"><a href=\"#DaemonSet-\" class=\"headerlink\" title=\"DaemonSet \"></a>DaemonSet </h3><img data-src=\"/posts/41fe/fluent2.png\" class>\n<h4 id=\"-Elasticsearch--Kibana\"><a href=\"#-Elasticsearch--Kibana\" class=\"headerlink\" title=\" Elasticsearch  Kibana\"></a> Elasticsearch  Kibana</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> namespace</span></span><br><span class=\"line\">kubectl create ns logging</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> ElasticsearchStatefulSet  Serviceservice </span></span><br><span class=\"line\">cat &gt; elasticsearch.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: StatefulSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: es</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  serviceName: elasticsearch</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: elasticsearch</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: elasticsearch</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      # </span><br><span class=\"line\">      initContainers:</span><br><span class=\"line\">      - name: increase-vm-max-map</span><br><span class=\"line\">        image: busybox</span><br><span class=\"line\">        command: [&quot;sysctl&quot;, &quot;-w&quot;, &quot;vm.max_map_count=262144&quot;]</span><br><span class=\"line\">        securityContext:</span><br><span class=\"line\">          privileged: true</span><br><span class=\"line\">      - name: increase-fd-ulimit</span><br><span class=\"line\">        image: busybox</span><br><span class=\"line\">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;ulimit -n 65536&quot;]</span><br><span class=\"line\">        securityContext:</span><br><span class=\"line\">          privileged: true</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: elasticsearch</span><br><span class=\"line\">        image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 1000m</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9200</span><br><span class=\"line\">          name: rest</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        - containerPort: 9300</span><br><span class=\"line\">          name: inter-node</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: data</span><br><span class=\"line\">          mountPath: /usr/share/elasticsearch/data</span><br><span class=\"line\">        env:</span><br><span class=\"line\">          - name: cluster.name</span><br><span class=\"line\">            value: k8s-logs</span><br><span class=\"line\">          - name: node.name</span><br><span class=\"line\">            valueFrom:</span><br><span class=\"line\">              fieldRef:</span><br><span class=\"line\">                fieldPath: metadata.name</span><br><span class=\"line\">          # ES </span><br><span class=\"line\">          - name: cluster.initial_master_nodes</span><br><span class=\"line\">            value: &quot;es-0&quot;</span><br><span class=\"line\">          - name: discovery.zen.minimum_master_nodes</span><br><span class=\"line\">            value: &quot;1&quot;</span><br><span class=\"line\">          - name: discovery.seed_hosts</span><br><span class=\"line\">            value: &quot;elasticsearch&quot;</span><br><span class=\"line\">          - name: ES_JAVA_OPTS</span><br><span class=\"line\">            value: &quot;-Xms512m -Xmx512m&quot;</span><br><span class=\"line\">          - name: network.host</span><br><span class=\"line\">            value: &quot;0.0.0.0&quot;</span><br><span class=\"line\">      #  StorageClass </span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: data</span><br><span class=\"line\">        emptyDir: &#123;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: elasticsearch</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: elasticsearch</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: elasticsearch</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\"> StatefulSet  Pod  DNS  es-0.elasticsearch.logging.svc.cluster.local</span></span><br><span class=\"line\">  clusterIP: None</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: 9200</span><br><span class=\"line\">      name: rest</span><br><span class=\"line\">    - port: 9300</span><br><span class=\"line\">      name: inter-node</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Kibana </span></span><br><span class=\"line\">cat &gt; kibana.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kibana</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kibana</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: kibana</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 5601</span><br><span class=\"line\">  type: ClusterIP</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kibana</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kibana</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: kibana</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: kibana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: kibana</span><br><span class=\"line\">        image: docker.elastic.co/kibana/kibana:7.6.2</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 1000m</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 200m</span><br><span class=\"line\">        env:</span><br><span class=\"line\">        - name: ELASTICSEARCH_HOSTS</span><br><span class=\"line\">          value: http://elasticsearch:9200</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 5601</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl apply -f elasticsearch.yaml</span><br><span class=\"line\">kubectl apply -f kibana.yaml</span><br><span class=\"line\">kubectl get pod,svc -n logging -owide</span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">pod/es-0                      1/1     Running   0          4h54m   172.17.0.6   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">pod/kibana-6c84594848-mdp76   1/1     Running   0          158m    172.17.0.5   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE     SELECTOR</span><br><span class=\"line\">service/elasticsearch   ClusterIP   None           &lt;none&gt;        9200/TCP,9300/TCP   4h50m   app=elasticsearch</span><br><span class=\"line\">service/kibana          ClusterIP   10.106.67.32   &lt;none&gt;        5601/TCP            158m    app=kibana</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl port-forward services/elasticsearch -n logging --address 127.0.0.1 9200:9200</span><br><span class=\"line\">curl http://127.0.0.1:9200/_cluster/state?pretty</span><br><span class=\"line\">curl 10.106.67.32:5601/app/kibana -I</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"-Fluentd\"><a href=\"#-Fluentd\" class=\"headerlink\" title=\" Fluentd\"></a> Fluentd</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">git <span class=\"built_in\">clone</span> https://github.com/fluent/fluentd-kubernetes-daemonset.git</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Fluentd </span></span><br><span class=\"line\">cat &gt; fluentd-cfg.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-config</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">data:</span><br><span class=\"line\">  system.conf: |-</span><br><span class=\"line\">    &lt;system&gt;</span><br><span class=\"line\">      root_dir /tmp/fluentd-buffers/</span><br><span class=\"line\">    &lt;/system&gt;</span><br><span class=\"line\">  containers.input.conf: |-</span><br><span class=\"line\">    &lt;source&gt;</span><br><span class=\"line\">      @id fluentd-containers.log</span><br><span class=\"line\">      @type tail                              # Fluentd </span><br><span class=\"line\">      path /var/log/containers/*.log          # Docker</span><br><span class=\"line\">      pos_file /var/log/es-containers.log.pos</span><br><span class=\"line\">      tag raw.kubernetes.*                    # </span><br><span class=\"line\">      read_from_head true</span><br><span class=\"line\">      &lt;parse&gt;                                 # JSON</span><br><span class=\"line\">        @type multi_format                    #  multi-format-parser </span><br><span class=\"line\">        &lt;pattern&gt;</span><br><span class=\"line\">          format json                         # JSON</span><br><span class=\"line\">          time_key time                       # </span><br><span class=\"line\">          time_format %Y-%m-%dT%H:%M:%S.%NZ   # </span><br><span class=\"line\">        &lt;/pattern&gt;</span><br><span class=\"line\">        &lt;pattern&gt;</span><br><span class=\"line\">          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/</span><br><span class=\"line\">          time_format %Y-%m-%dT%H:%M:%S.%N%:z</span><br><span class=\"line\">        &lt;/pattern&gt;</span><br><span class=\"line\">      &lt;/parse&gt;</span><br><span class=\"line\">    &lt;/source&gt;</span><br><span class=\"line\">    # </span><br><span class=\"line\">    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions</span><br><span class=\"line\">    &lt;match raw.kubernetes.**&gt;           # tagraw.kubernetes.**</span><br><span class=\"line\">      @id raw.kubernetes</span><br><span class=\"line\">      @type detect_exceptions           # detect-exceptions</span><br><span class=\"line\">      remove_tag_prefix raw             #  raw </span><br><span class=\"line\">      message log</span><br><span class=\"line\">      stream stream</span><br><span class=\"line\">      multiline_flush_interval 5</span><br><span class=\"line\">      max_bytes 500000</span><br><span class=\"line\">      max_lines 1000</span><br><span class=\"line\">    &lt;/match&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;filter **&gt;  # </span><br><span class=\"line\">      @id filter_concat</span><br><span class=\"line\">      @type concat                # Fluentd Filter </span><br><span class=\"line\">      key message</span><br><span class=\"line\">      multiline_end_regexp /\\n$/  # \\n</span><br><span class=\"line\">      separator &quot;&quot;</span><br><span class=\"line\">    &lt;/filter&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    #  Kubernetes metadata </span><br><span class=\"line\">    &lt;filter kubernetes.**&gt;</span><br><span class=\"line\">      @id filter_kubernetes_metadata</span><br><span class=\"line\">      @type kubernetes_metadata</span><br><span class=\"line\">    &lt;/filter&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    #  ES  JSON </span><br><span class=\"line\">    # https://github.com/repeatedly/fluent-plugin-multi-format-parser</span><br><span class=\"line\">    &lt;filter kubernetes.**&gt;</span><br><span class=\"line\">      @id filter_parser</span><br><span class=\"line\">      @type parser                # multi-format-parser</span><br><span class=\"line\">      key_name log                # </span><br><span class=\"line\">      reserve_data true           # </span><br><span class=\"line\">      remove_key_name_field true  # key_name </span><br><span class=\"line\">      &lt;parse&gt;</span><br><span class=\"line\">        @type multi_format</span><br><span class=\"line\">        &lt;pattern&gt;</span><br><span class=\"line\">          format json</span><br><span class=\"line\">        &lt;/pattern&gt;</span><br><span class=\"line\">        &lt;pattern&gt;</span><br><span class=\"line\">          format none</span><br><span class=\"line\">        &lt;/pattern&gt;</span><br><span class=\"line\">      &lt;/parse&gt;</span><br><span class=\"line\">    &lt;/filter&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    &lt;filter kubernetes.**&gt;</span><br><span class=\"line\">      @type record_transformer</span><br><span class=\"line\">      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash</span><br><span class=\"line\">    &lt;/filter&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    # logging=truePod</span><br><span class=\"line\">    &lt;filter kubernetes.**&gt;</span><br><span class=\"line\">      @id filter_log</span><br><span class=\"line\">      @type grep</span><br><span class=\"line\">      &lt;regexp&gt;</span><br><span class=\"line\">        key $.kubernetes.labels.logging</span><br><span class=\"line\">        pattern ^true$</span><br><span class=\"line\">      &lt;/regexp&gt;</span><br><span class=\"line\">    &lt;/filter&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\"><span class=\"comment\">#####  ######</span></span></span><br><span class=\"line\">  forward.input.conf: |-</span><br><span class=\"line\">    # TCP</span><br><span class=\"line\">    &lt;source&gt;</span><br><span class=\"line\">      @id forward</span><br><span class=\"line\">      @type forward</span><br><span class=\"line\">    &lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  output.conf: |-</span><br><span class=\"line\">    &lt;match **&gt;</span><br><span class=\"line\">      @id elasticsearch</span><br><span class=\"line\">      @type elasticsearch</span><br><span class=\"line\">      @log_level info</span><br><span class=\"line\">      include_tag_key true</span><br><span class=\"line\">      host elasticsearch</span><br><span class=\"line\">      port 9200</span><br><span class=\"line\">      logstash_format true</span><br><span class=\"line\">      logstash_prefix k8s  #  index  k8s</span><br><span class=\"line\">      request_timeout    30s</span><br><span class=\"line\">      &lt;buffer&gt;</span><br><span class=\"line\">        @type file</span><br><span class=\"line\">        path /var/log/fluentd-buffers/kubernetes.system.buffer</span><br><span class=\"line\">        flush_mode interval</span><br><span class=\"line\">        retry_type exponential_backoff</span><br><span class=\"line\">        flush_thread_count 2</span><br><span class=\"line\">        flush_interval 5s</span><br><span class=\"line\">        retry_forever</span><br><span class=\"line\">        retry_max_interval 30</span><br><span class=\"line\">        chunk_limit_size 2M</span><br><span class=\"line\">        queue_limit_length 8</span><br><span class=\"line\">        overflow_action block</span><br><span class=\"line\">      &lt;/buffer&gt;</span><br><span class=\"line\">    &lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; fluentd-daemonset.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: fluentd-es</span><br><span class=\"line\">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class=\"line\">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: fluentd-es</span><br><span class=\"line\">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class=\"line\">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class=\"line\">rules:</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - &quot;&quot;</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - &quot;namespaces&quot;</span><br><span class=\"line\">  - &quot;pods&quot;</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - &quot;get&quot;</span><br><span class=\"line\">  - &quot;watch&quot;</span><br><span class=\"line\">  - &quot;list&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: fluentd-es</span><br><span class=\"line\">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class=\"line\">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  apiGroup: &quot;&quot;</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  apiGroup: &quot;&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: DaemonSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: fluentd-es</span><br><span class=\"line\">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class=\"line\">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      k8s-app: fluentd-es</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        k8s-app: fluentd-es</span><br><span class=\"line\">        kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class=\"line\">      # fluentd pod </span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        priorityClassName: system-cluster-critical</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      serviceAccountName: fluentd-es</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: fluentd-es</span><br><span class=\"line\">        image: quay.io/fluentd_elasticsearch/fluentd:v3.0.1</span><br><span class=\"line\">        #image: fluent/fluentd-kubernetes-daemonset:v1.14.6-debian-elasticsearch7-1.1</span><br><span class=\"line\">        env:</span><br><span class=\"line\">        - name: FLUENTD_ARGS</span><br><span class=\"line\">          value: --no-supervisor -q</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            memory: 500Mi</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 200Mi</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: varlog</span><br><span class=\"line\">          mountPath: /var/log</span><br><span class=\"line\">        - name: varlibdockercontainers</span><br><span class=\"line\">          mountPath: /var/lib/docker/containers</span><br><span class=\"line\">          readOnly: true</span><br><span class=\"line\">        - name: config-volume</span><br><span class=\"line\">          mountPath: /etc/fluent/config.d</span><br><span class=\"line\">      #  master  master </span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - operator: Exists</span><br><span class=\"line\">      terminationGracePeriodSeconds: 30</span><br><span class=\"line\">      # </span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: varlog</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          path: /var/log</span><br><span class=\"line\">      - name: varlibdockercontainers</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          path: /var/lib/docker/containers</span><br><span class=\"line\">      - name: config-volume</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: fluentd-config</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl apply -f fluentd-cfg.yaml</span><br><span class=\"line\">kubectl apply -f fluentd-daemonset.yaml</span><br><span class=\"line\">kubectl get pod -n logging -owide</span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS        AGE     IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">pod/fluentd-es-cfdcx          1/1     Running   0               91m     172.17.0.7   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat &gt; stdin.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: counter1</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    # </span><br><span class=\"line\">    logging: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">    - image: busybox</span><br><span class=\"line\">      args: [&quot;/bin/sh&quot;,&quot;-c&quot;, &#x27;i=0; while true; do echo &quot;$i: $(date)&quot;; i=$((i+1)); sleep 5; done&#x27;]</span><br><span class=\"line\">      name: counter</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">sidecar </span></span><br><span class=\"line\">cat &gt; sidecar.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: counter2</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    logging: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: counter2</span><br><span class=\"line\">    image: busybox</span><br><span class=\"line\">    args:</span><br><span class=\"line\">    - /bin/sh</span><br><span class=\"line\">    - -c</span><br><span class=\"line\">    - &gt;</span><br><span class=\"line\">      i=0;</span><br><span class=\"line\">      while true;</span><br><span class=\"line\">      do</span><br><span class=\"line\">        echo &quot;$i: $(date)&quot; &gt;&gt; /var/log/1.log;</span><br><span class=\"line\">        echo &quot;$(date) INFO $i&quot; &gt;&gt; /var/log/2.log;</span><br><span class=\"line\">        i=$((i+1));</span><br><span class=\"line\">        sleep 3;</span><br><span class=\"line\">      done</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: varlog</span><br><span class=\"line\">      mountPath: /var/log</span><br><span class=\"line\">  - name: count-log-1</span><br><span class=\"line\">    image: busybox</span><br><span class=\"line\">    args: [/bin/sh, -c, &#x27;tail -n 1 -f /var/log/1.log&#x27;]</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: varlog</span><br><span class=\"line\">      mountPath: /var/log</span><br><span class=\"line\">  - name: count-log-2</span><br><span class=\"line\">    image: busybox</span><br><span class=\"line\">    args: [/bin/sh, -c, &#x27;tail -n 1 -f /var/log/2.log&#x27;]</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: varlog</span><br><span class=\"line\">      mountPath: /var/log</span><br><span class=\"line\">  restartPolicy: Never</span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - name: varlog</span><br><span class=\"line\">    emptyDir: &#123;&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl logs counter2 count-log-2 -f --<span class=\"built_in\">tail</span> 3</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> JSON </span></span><br><span class=\"line\">cat &gt; dummylogs.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dummylogs</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: dummylogs</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: dummylogs</span><br><span class=\"line\">        logging: &quot;true&quot;  # </span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: dummy</span><br><span class=\"line\">        image: cnych/dummylogs:latest</span><br><span class=\"line\">        args:</span><br><span class=\"line\">        - msg-processor</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dummylogs2</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: dummylogs2</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: dummylogs2</span><br><span class=\"line\">        logging: &quot;true&quot;  # </span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: dummy</span><br><span class=\"line\">        image: cnych/dummylogs:latest</span><br><span class=\"line\">        args:</span><br><span class=\"line\">        - msg-receiver-api</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl apply -f counter.yaml</span><br><span class=\"line\">kubectl apply -f dummylogs.yaml</span><br></pre></td></tr></table></figure>\n<h4 id=\"Kibana-amp-Elasticsearch-\"><a href=\"#Kibana-amp-Elasticsearch-\" class=\"headerlink\" title=\"Kibana  &amp; Elasticsearch \"></a>Kibana  &amp; Elasticsearch </h4><ul>\n<li><p> Kibana  &amp; Elasticsearch </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl port-forward services/kibana -n logging --address 127.0.0.1 5601:5601</span><br><span class=\"line\">kubectl port-forward services/elasticsearch -n logging --address 127.0.0.1 9200:9200</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n</li>\n</ul>\n<img data-src=\"/posts/41fe/fluent3.png\" class>\n<img data-src=\"/posts/41fe/fluent4.png\" class>\n\n<ul>\n<li>Kibana <h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; elastalert.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: elastalert-config</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: elastalert</span><br><span class=\"line\">data:</span><br><span class=\"line\">  elastalert_config: |-</span><br><span class=\"line\">    ---</span><br><span class=\"line\">    rules_folder: /opt/rules       # </span><br><span class=\"line\">    scan_subdirectories: false</span><br><span class=\"line\">    run_every:                     #  ES </span><br><span class=\"line\">      minutes: 1</span><br><span class=\"line\">    buffer_time:</span><br><span class=\"line\">      minutes: 15</span><br><span class=\"line\">    es_host: elasticsearch</span><br><span class=\"line\">    es_port: 9200</span><br><span class=\"line\">    writeback_index: elastalert</span><br><span class=\"line\">    use_ssl: False</span><br><span class=\"line\">    verify_certs: True</span><br><span class=\"line\">    alert_time_limit:             # </span><br><span class=\"line\">      minutes: 720</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: elastalert-rules</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: elastalert</span><br><span class=\"line\">data:</span><br><span class=\"line\">  rule_config.yaml: |-</span><br><span class=\"line\">    name: dummylogs error     # </span><br><span class=\"line\">    es_host: elasticsearch</span><br><span class=\"line\">    es_port: 9200</span><br><span class=\"line\">    type: any                 # </span><br><span class=\"line\">    index: k8s-*              # es</span><br><span class=\"line\">    filter:                   # </span><br><span class=\"line\">    - query:</span><br><span class=\"line\">        query_string:</span><br><span class=\"line\">          query: &quot;LOGLEVEL:ERROR&quot;  # </span><br><span class=\"line\">    alert:                         # </span><br><span class=\"line\">    - &quot;email&quot;</span><br><span class=\"line\">    smtp_host: 127.0.0.1</span><br><span class=\"line\">    smtp_port: 587</span><br><span class=\"line\">    smtp_auth_file: /opt/auth/smtp_auth_file.yaml</span><br><span class=\"line\">    email_reply_to: xxx@gmail.com</span><br><span class=\"line\">    from_addr: xxx@gmail.com</span><br><span class=\"line\">    email:                  # </span><br><span class=\"line\">    - &quot;xxx@gmail.com&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: elastalert</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: elastalert</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: elastalert</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: elastalert</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: elastalert</span><br><span class=\"line\">        image: jertel/elastalert-docker:0.2.4</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: config</span><br><span class=\"line\">          mountPath: /opt/config</span><br><span class=\"line\">        - name: rules</span><br><span class=\"line\">          mountPath: /opt/rules</span><br><span class=\"line\">        - name: auth</span><br><span class=\"line\">          mountPath: /opt/auth</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 50m</span><br><span class=\"line\">            memory: 256Mi</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 50m</span><br><span class=\"line\">            memory: 256Mi</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: auth</span><br><span class=\"line\">        secret:</span><br><span class=\"line\">          secretName: smtp-auth</span><br><span class=\"line\">      - name: rules</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: elastalert-rules</span><br><span class=\"line\">      - name: config</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: elastalert-config</span><br><span class=\"line\">          items:</span><br><span class=\"line\">          - key: elastalert_config</span><br><span class=\"line\">            path: elastalert_config.yaml</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat &gt; smtp_auth_file.yaml &lt;&lt; EOF</span><br><span class=\"line\">user: &quot;xxxxx@gmail.com&quot;</span><br><span class=\"line\">password: &quot;123xxx&quot;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl create secret generic smtp-auth --from-file=smtp_auth_file.yaml -n logging</span><br><span class=\"line\">kubectl apply -f elastalert.yaml</span><br><span class=\"line\">kubectl get pods -n logging -l app=elastalert</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> Kibana </span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"fluentd-operator-\"><a href=\"#fluentd-operator-\" class=\"headerlink\" title=\"fluentd-operator \"></a>fluentd-operator </h3><h4 id=\"CRD-\"><a href=\"#CRD-\" class=\"headerlink\" title=\"CRD \"></a>CRD </h4><p><strong>fluentbit.fluent.io </strong></p>\n<ul>\n<li>FluentBit Fluent Bit </li>\n<li>ClusterFluentBitConfig Fluent Bit </li>\n<li>ClusterInput Fluent Bit  input </li>\n<li>ClusterFilter Fluent Bit  filter </li>\n<li>ClusterParser Fluent Bit  parser </li>\n<li>ClusterOutput Fluent Bit  output </li>\n</ul>\n<p><strong>fluentd.fluent.io </strong></p>\n<ul>\n<li>Fluentd Fluentd </li>\n<li>FluentdConfig Fluentd namespace </li>\n<li>ClusterFluentdConfig Fluentd </li>\n<li>Filter Fluentd namespace  filter </li>\n<li>ClusterFilter Fluentd  filter </li>\n<li>Output Fluentd namespace  output </li>\n<li>ClusterOutput Fluentd  output </li>\n</ul>\n<h4 id=\"-CRD--fluent-operator\"><a href=\"#-CRD--fluent-operator\" class=\"headerlink\" title=\" CRD  fluent-operator\"></a> CRD  fluent-operator</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CRD  fluent-operator</span></span><br><span class=\"line\">git clone https://github.com/fluent/fluent-operator</span><br><span class=\"line\">cd fluent-operator &amp;&amp; kubectl apply -f manifests/setup/setup.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get pod,crd -n fluent</span><br><span class=\"line\">NAME                                   READY   STATUS    RESTARTS        AGE</span><br><span class=\"line\">pod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (5h20m ago)   22h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                                                                        CREATED AT</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterfilters.fluentbit.fluent.io            2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterfilters.fluentd.fluent.io              2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterfluentbitconfigs.fluentbit.fluent.io   2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterfluentdconfigs.fluentd.fluent.io       2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterinputs.fluentbit.fluent.io             2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusteroutputs.fluentbit.fluent.io            2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusteroutputs.fluentd.fluent.io              2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterparsers.fluentbit.fluent.io            2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/filters.fluentd.fluent.io                     2022-07-05T07:45:27Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/fluentbits.fluentbit.fluent.io                2022-07-05T07:45:27Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/fluentdconfigs.fluentd.fluent.io              2022-07-05T07:45:27Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/fluentds.fluentd.fluent.io                    2022-07-05T07:45:27Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/outputs.fluentd.fluent.io                     2022-07-05T07:45:28Z</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Fluent-Bit-Only-\"><a href=\"#Fluent-Bit-Only-\" class=\"headerlink\" title=\"Fluent Bit Only \"></a>Fluent Bit Only </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Fluent Bit </span></span><br><span class=\"line\">cat &gt; fluent-bit.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class=\"line\">kind: FluentBit</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluent-bit</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: fluent-bit</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  image: kubesphere/fluent-bit:v1.8.11</span><br><span class=\"line\">  positionDB:</span><br><span class=\"line\">    hostPath:</span><br><span class=\"line\">      path: /var/lib/fluent-bit/</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      cpu: 10m</span><br><span class=\"line\">      memory: 25Mi</span><br><span class=\"line\">    limits:</span><br><span class=\"line\">      cpu: 500m</span><br><span class=\"line\">      memory: 200Mi</span><br><span class=\"line\">  fluentBitConfigName: fluent-bit-config</span><br><span class=\"line\">  tolerations:</span><br><span class=\"line\">    - operator: Exists</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class=\"line\">kind: ClusterFluentBitConfig</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluent-bit-config</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: fluent-bit</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  service:</span><br><span class=\"line\">    parsersFile: parsers.conf</span><br><span class=\"line\">  inputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class=\"line\">  filterSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class=\"line\">  outputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class=\"line\">kind: ClusterInput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: tail</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  tail:</span><br><span class=\"line\">    tag: kube.*</span><br><span class=\"line\">    path: /var/log/containers/*.log</span><br><span class=\"line\">    parser: docker</span><br><span class=\"line\">    refreshIntervalSeconds: 10</span><br><span class=\"line\">    memBufLimit: 5MB</span><br><span class=\"line\">    skipLongLines: true</span><br><span class=\"line\">    db: /fluent-bit/tail/pos.db</span><br><span class=\"line\">    dbSync: Normal</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: es</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  matchRegex: (?:kube|service)\\.(.*)</span><br><span class=\"line\">  es:</span><br><span class=\"line\">    host: elasticsearch</span><br><span class=\"line\">    port: 9200</span><br><span class=\"line\">    generateID: true</span><br><span class=\"line\">    logstashPrefix: fluent-log-fb-only</span><br><span class=\"line\">    logstashFormat: true</span><br><span class=\"line\">    timeKey: &quot;@timestamp&quot;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> output  elasticsearch </span></span><br><span class=\"line\">kubectl apply -f elasticsearch.yaml</span><br><span class=\"line\">kubectl apply -f fluent-bit.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get pod,svc -n fluent</span><br><span class=\"line\">NAME                                   READY   STATUS    RESTARTS      AGE</span><br><span class=\"line\">pod/es-0                               1/1     Running   1 (56m ago)   17h</span><br><span class=\"line\">pod/fluent-bit-rjqsd                   1/1     Running   0             2m34s</span><br><span class=\"line\">pod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (56m ago)   17h</span><br><span class=\"line\">NAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE</span><br><span class=\"line\">service/elasticsearch   ClusterIP   None         &lt;none&gt;        9200/TCP,9300/TCP   17h</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Elasticsearch </span></span><br><span class=\"line\">kubectl port-forward services/elasticsearch -n fluent --address 127.0.0.1 9200:9200</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">curl &quot;127.0.0.1:9200/_cat/indices?pretty&quot;</span><br><span class=\"line\">yellow open fluent-log-fb-only-2022.07.06 lLmstFnwQLa89Jb7TFe-0Q 1 1 152 0 155.2kb 155.2kb </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">curl &quot;127.0.0.1:9200/fluent-log-fb-only-2022.07.06/_search?pretty&quot;</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> ID </span></span><br><span class=\"line\">curl &quot;127.0.0.1:9200/fluent-log-fb-only-2022.07.06/_doc/b641529e-255c-f260-f911-f7d00d84e3fe?pretty&quot;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;_index&quot; : &quot;fluent-log-fb-only-2022.07.06&quot;,</span><br><span class=\"line\">  &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class=\"line\">  &quot;_id&quot; : &quot;b641529e-255c-f260-f911-f7d00d84e3fe&quot;,</span><br><span class=\"line\">  &quot;_version&quot; : 1,</span><br><span class=\"line\">  &quot;_seq_no&quot; : 94,</span><br><span class=\"line\">  &quot;_primary_term&quot; : 1,</span><br><span class=\"line\">  &quot;found&quot; : true,</span><br><span class=\"line\">  &quot;_source&quot; : &#123;</span><br><span class=\"line\">    &quot;@timestamp&quot; : &quot;2022-07-06T02:57:38.035Z&quot;,</span><br><span class=\"line\">    &quot;log&quot; : &quot;[2022/07/06 02:57:38] [ info] [input:tail:tail.0] inotify_fs_add(): inode=2050771 watch_fd=3 name=/var/log/containers/dashboard-metrics-scraper-58549894f-q9lpg_kubernetes-dashboard_dashboard-metrics-scraper-51061ac5d9c2c7c2da734ab35b9252edb29f4101ade5679a22181d0d735dc364.log\\n&quot;,</span><br><span class=\"line\">    &quot;time&quot; : &quot;2022-07-06T02:57:38.035319145Z&quot;,</span><br><span class=\"line\">    &quot;kubernetes&quot; : &#123;</span><br><span class=\"line\">      &quot;pod_name&quot; : &quot;fluent-bit-8v2qn&quot;,</span><br><span class=\"line\">      &quot;namespace_name&quot; : &quot;fluent&quot;,</span><br><span class=\"line\">      &quot;container_name&quot; : &quot;fluent-bit&quot;,</span><br><span class=\"line\">      &quot;docker_id&quot; : &quot;098d8ac65b201686b7a2945df6ee1a919b7220b637aea4de6490d92569c9c455&quot;,</span><br><span class=\"line\">      &quot;container_image&quot; : &quot;kubesphere/fluent-bit:v1.8.11&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Fluent-Bit-Fluentd-\"><a href=\"#Fluent-Bit-Fluentd-\" class=\"headerlink\" title=\"Fluent Bit + Fluentd \"></a>Fluent Bit + Fluentd </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Fluent Bit output  forward  Fluentd</span></span><br><span class=\"line\">cat &gt;&gt; fluent-bit.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    fluentbit.fluent.io/component: logging</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  matchRegex: (?:kube|service)\\.(.*)</span><br><span class=\"line\">  forward:</span><br><span class=\"line\">    host: fluentd.fluent.svc</span><br><span class=\"line\">    port: 24224</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Fluentd</span> </span><br><span class=\"line\">cat &gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: Fluentd</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: fluentd</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  globalInputs:</span><br><span class=\"line\">  - forward:</span><br><span class=\"line\">      bind: 0.0.0.0</span><br><span class=\"line\">      port: 24224</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  image: kubesphere/fluentd:v1.14.4</span><br><span class=\"line\">  fluentdCfgSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Fluentd</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">1. ClusterFluentdConfig  kube-system  default  namesapce  ClusterOutput</span></span><br><span class=\"line\">cat &gt;&gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterFluentdConfig</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-config</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  watchedNamespaces:</span><br><span class=\"line\">  - kube-system</span><br><span class=\"line\">  - default</span><br><span class=\"line\">  clusterOutputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      output.fluentd.fluent.io/scope: &quot;cluster&quot;</span><br><span class=\"line\">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-output-es</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/scope: &quot;cluster&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">  - elasticsearch:</span><br><span class=\"line\">      host: elasticsearch-master.elastic.svc</span><br><span class=\"line\">      port: 9200</span><br><span class=\"line\">      logstashFormat: true</span><br><span class=\"line\">      logstashPrefix: fluent-log-cluster-fd</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">2. FluentdConfig + ClusterFluentdConfig  namespace  Output  ClusterOutput</span></span><br><span class=\"line\">cat &gt;&gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: FluentdConfig</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: namespace-fluentd-config-user1</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class=\"line\">  clusterOutputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterFluentdConfig</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-config-cluster-only</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  watchedNamespaces:</span><br><span class=\"line\">  - kube-system</span><br><span class=\"line\">  - kubesphere-system</span><br><span class=\"line\">  clusterOutputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      output.fluentd.fluent.io/scope: &quot;cluster-only&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: Output</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: namespace-fluentd-output-user1</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">  - elasticsearch:</span><br><span class=\"line\">      host: elasticsearch-master.elastic.svc</span><br><span class=\"line\">      port: 9200</span><br><span class=\"line\">      logstashFormat: true</span><br><span class=\"line\">      logstashPrefix: fluent-log-user1-fd</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-output-user1</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">  - elasticsearch:</span><br><span class=\"line\">      host: elasticsearch-master.elastic.svc</span><br><span class=\"line\">      port: 9200</span><br><span class=\"line\">      logstashFormat: true</span><br><span class=\"line\">      logstashPrefix: fluent-log-cluster-user1-fd</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-output-cluster-only</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/scope: &quot;cluster-only&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">  - elasticsearch:</span><br><span class=\"line\">      host: elasticsearch-master.elastic.svc</span><br><span class=\"line\">      port: 9200</span><br><span class=\"line\">      logstashFormat: true</span><br><span class=\"line\">      logstashPrefix: fluent-log-cluster-only-fd</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Fluentd  buffer </span></span><br><span class=\"line\">cat &gt;&gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-output-buffer</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/type: &quot;buffer&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">  - stdout: &#123;&#125;</span><br><span class=\"line\">    buffer:</span><br><span class=\"line\">      type: file</span><br><span class=\"line\">      path: /buffers/stdout.log</span><br><span class=\"line\">  - elasticsearch:</span><br><span class=\"line\">      host: elasticsearch-master.elastic.svc</span><br><span class=\"line\">      port: 9200</span><br><span class=\"line\">      logstashFormat: true</span><br><span class=\"line\">      logstashPrefix: fluent-log-buffer-fd</span><br><span class=\"line\">    buffer:</span><br><span class=\"line\">      type: file</span><br><span class=\"line\">      path: /buffers/es.log</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Fluentd-Only-\"><a href=\"#Fluentd-Only-\" class=\"headerlink\" title=\"Fluentd Only \"></a>Fluentd Only </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: Fluentd</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-http</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: fluentd</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  globalInputs:</span><br><span class=\"line\">    - http:</span><br><span class=\"line\">        bind: 0.0.0.0</span><br><span class=\"line\">        port: 9880</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  image: kubesphere/fluentd:v1.14.4</span><br><span class=\"line\">  fluentdCfgSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: FluentdConfig</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-only-config</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  filterSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      filter.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class=\"line\">      filter.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">  outputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      output.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class=\"line\">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: Filter</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-only-filter</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    filter.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class=\"line\">    filter.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  filters:</span><br><span class=\"line\">    - stdout: &#123;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: Output</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-only-stdout</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">    - stdout: &#123;&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get all -n fluent</span><br><span class=\"line\">NAME                                   READY   STATUS    RESTARTS       AGE</span><br><span class=\"line\">pod/es-0                               1/1     Running   1 (163m ago)   19h</span><br><span class=\"line\">pod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (163m ago)   19h</span><br><span class=\"line\">pod/fluentd-http-0                     1/1     Running   0              2m53s</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE</span><br><span class=\"line\">service/elasticsearch   ClusterIP   None         &lt;none&gt;        9200/TCP,9300/TCP   19h</span><br><span class=\"line\">service/fluentd-http    ClusterIP   10.97.96.1   &lt;none&gt;        9880/TCP            2m54s</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">deployment.apps/fluent-operator   1/1     1            1           19h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                         DESIRED   CURRENT   READY   AGE</span><br><span class=\"line\">replicaset.apps/fluent-operator-86858cfc87   1         1         1       19h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                            READY   AGE</span><br><span class=\"line\">statefulset.apps/es             1/1     19h</span><br><span class=\"line\">statefulset.apps/fluentd-http   1/1     2m54s</span><br></pre></td></tr></table></figure>\n\n\n<blockquote>\n<p><br>1<a href=\"https://www.qikqiak.com/post/install-efk-stack-on-k8s/\">https://www.qikqiak.com/post/install-efk-stack-on-k8s/</a><br>2fluentd <a href=\"https://docs.fluentd.org/\">https://docs.fluentd.org/</a><br>3fluentd-operator <a href=\"https://github.com/fluent/fluent-operator\">https://github.com/fluent/fluent-operator</a><br>4fluent-operator-walkthrough<a href=\"https://github.com/kubesphere-sigs/fluent-operator-walkthrough\">https://github.com/kubesphere-sigs/fluent-operator-walkthrough</a><br>5KubeSphere<a href=\"https://kubesphere.com.cn/blogs/fluent-operator-logging\">https://kubesphere.com.cn/blogs/fluent-operator-logging</a></p>\n</blockquote>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":37149,"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><strong>Fluentd</strong><br> Kubernetes  node  fluentd + Elasticsearch</p>\n<img data-src=\"/posts/41fe/fluent1.png\" class>\n<blockquote>\n<p>fluentd source &gt; parser &gt; filter &gt; output</p>\n</blockquote>\n<p><strong>Elasticsearch</strong><br></p>\n<p><strong>Kibana</strong><br> Web GUI Elasticsearch  </p>\n<blockquote>\n<p></p>\n<ul>\n<li> agent daemonSet</li>\n<li> Pod  sidecar </li>\n<li></li>\n</ul>\n</blockquote>","more":"<h3 id=\"-x2F-\"><a href=\"#-x2F-\" class=\"headerlink\" title=\" &#x2F; \"></a> &#x2F; </h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://docs.fluentd.org/installation/before-install\">https://docs.fluentd.org/installation/before-install</a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://hub.docker.com/r/fluent/fluentd\">https://hub.docker.com/r/fluent/fluentd</a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p>fluentd  tag <br>source -&gt; parser -&gt; filter -&gt; output</p>\n</blockquote>\n<h4 id=\"input-\"><a href=\"#input-\" class=\"headerlink\" title=\"input \"></a>input </h4><ul>\n<li><p><strong>http http </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">mkdir /tmp/fluentd &amp;&amp; cd /tmp/fluentd</span><br><span class=\"line\">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type http</span><br><span class=\"line\">  port 9880</span><br><span class=\"line\">  bind 0.0.0.0</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match **&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> fluentd  fluent.conf </span></span><br><span class=\"line\">docker run -p 9880:9880 --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> http </span></span><br><span class=\"line\">curl -X POST 127.0.0.1:9880/yakir.test -d &#x27;json=&#123;&quot;a&quot;:&quot;aaa&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>tail</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type tail</span><br><span class=\"line\">  path /var/log/httpd-access.log</span><br><span class=\"line\">  path_key tailed_path</span><br><span class=\"line\">  pos_file /var/log/td-agent/httpd-access.log.pos</span><br><span class=\"line\">  tag apache.access</span><br><span class=\"line\">  &lt;parse&gt;</span><br><span class=\"line\">    @type apache2</span><br><span class=\"line\">  &lt;/parse&gt;</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>exec event</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type exec</span><br><span class=\"line\">  tag yakir.test</span><br><span class=\"line\">  command cat /proc/loadavg | cut -d &#x27; &#x27; -f 1,2,3</span><br><span class=\"line\">  run_interval 10s</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;parse&gt;</span><br><span class=\"line\">    @type tsv</span><br><span class=\"line\">    keys avg1,avg5,avg15</span><br><span class=\"line\">    delimiter &quot; &quot;</span><br><span class=\"line\">  &lt;/parse&gt;</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match **&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\">2022-06-30 08:43:20.377146682 +0000 yakir.test: &#123;&quot;avg1&quot;:&quot;0.12&quot;,&quot;avg5&quot;:&quot;0.16&quot;,&quot;avg15&quot;:&quot;0.17&quot;&#125;</span><br><span class=\"line\">2022-06-30 08:43:30.347891525 +0000 yakir.test: &#123;&quot;avg1&quot;:&quot;0.10&quot;,&quot;avg5&quot;:&quot;0.15&quot;,&quot;avg15&quot;:&quot;0.17&quot;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>syslog rsyslog  rsyslog </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">    @type syslog</span><br><span class=\"line\">    port 5140</span><br><span class=\"line\">    bind 0.0.0.0</span><br><span class=\"line\">    tag system</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match **&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> udp </span></span><br><span class=\"line\">docker run -p 5140:5140/udp --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> rsyslog  fluent</span></span><br><span class=\"line\">cat &gt;&gt; /etc/rsyslog.d/50-default.conf &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">*.* @127.0.0.1:5140</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">logger </span></span><br><span class=\"line\">logger -p mail.info &#x27;this is info message&#x27;</span><br><span class=\"line\">logger -p mail.warning &#x27;this is warning message&#x27;</span><br><span class=\"line\">2022-07-04 10:27:48.000000000 +0000 system.mail.info: &#123;&quot;host&quot;:&quot;minikube&quot;,&quot;ident&quot;:&quot;root&quot;,&quot;message&quot;:&quot;this is info message&quot;&#125;</span><br><span class=\"line\">2022-07-04 10:28:11.000000000 +0000 system.mail.warn: &#123;&quot;host&quot;:&quot;minikube&quot;,&quot;ident&quot;:&quot;root&quot;,&quot;message&quot;:&quot;this is warning message&quot;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>dummy</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">    @type dummy</span><br><span class=\"line\">    dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class=\"line\">    size 3</span><br><span class=\"line\">    rate 1</span><br><span class=\"line\">    tag yakir.test</span><br><span class=\"line\">    auto_increment_key primary_key</span><br><span class=\"line\">    suspend true</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match **&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">size     # event </span><br><span class=\"line\">rate     # event</span><br><span class=\"line\">auto_increment_key   #</span><br><span class=\"line\">suspend              #</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\">2022-07-04 02:51:37.044796145 +0000 yakir.test: &#123;&quot;foo&quot;:&quot;bar&quot;,&quot;primary_key&quot;:0&#125;</span><br><span class=\"line\">2022-07-04 02:51:37.044834743 +0000 yakir.test: &#123;&quot;foo&quot;:&quot;bar&quot;,&quot;primary_key&quot;:1&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>forward fluentd forward  event</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type forward</span><br><span class=\"line\">  port 24224</span><br><span class=\"line\">  bind 0.0.0.0</span><br><span class=\"line\">&lt;/source&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"output-\"><a href=\"#output-\" class=\"headerlink\" title=\"output \"></a>output </h4></li>\n<li><p><strong>file event </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type dummy</span><br><span class=\"line\">  dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class=\"line\">  tag yakir.test</span><br><span class=\"line\">  size 1</span><br><span class=\"line\">  rate 1</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match yakir.**&gt;</span><br><span class=\"line\">  @type file</span><br><span class=\"line\">  path /tmp/fluent/yakir</span><br><span class=\"line\">  compress gzip</span><br><span class=\"line\">  &lt;buffer&gt;</span><br><span class=\"line\">    timekey 1d</span><br><span class=\"line\">    timekey_use_utc true</span><br><span class=\"line\">    timekey_wait 10m</span><br><span class=\"line\">  &lt;/buffer&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">@<span class=\"built_in\">type</span> file</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">path /tmp/<span class=\"variable\">$&#123;tag[0]&#125;</span>/file.%Y-%m-%d-%H-%M-%S</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">&lt;buffer tag,time&gt;</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> timekey 10</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> timekey_wait 10</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> timekey_use_utc <span class=\"literal\">true</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">&lt;/buffer&gt;</span></span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">path placeholdertag  record /path/to/$&#123;tag&#125;/$&#123;key1&#125;/file.%Y%m%d</span><br><span class=\"line\">appendflush  chuck  false</span><br><span class=\"line\">format  out_file</span><br><span class=\"line\">inject  event  time  tag </span><br><span class=\"line\">add_path_suffix path </span><br><span class=\"line\">path_suffixpath .log</span><br><span class=\"line\">compress</span><br><span class=\"line\">recompress buffer chunk  false</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\">docker exec -it fluent /bin/sh</span><br><span class=\"line\">tail -2 /tmp/fluent/yakir/buffer.b5e2f5e063d4389bd9304563cf7f07656.log</span><br><span class=\"line\">2022-07-04T07:42:34+00:00\tyakir.test\t&#123;&quot;foo&quot;:&quot;bar&quot;&#125;</span><br><span class=\"line\">2022-07-04T07:42:35+00:00\tyakir.test\t&#123;&quot;foo&quot;:&quot;bar&quot;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>buffer </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;buffer&gt;</span><br><span class=\"line\">  @type file</span><br><span class=\"line\">&lt;/buffer&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">@<span class=\"built_in\">type</span> filememory</span></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;buffer ARGUMENT_CHUNK_KEYS&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">...</span></span><br><span class=\"line\">&lt;/buffer&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">buffer chunk keysbuffer  record  chunk key event  chunk file  buffer </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> time  chunk key buffer </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">timekey   timekey_waitflush </span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">timekey_use_utc</span><br><span class=\"line\">timekey_zone</span><br><span class=\"line\">chunk_limit_sizechunk  8MB</span><br><span class=\"line\">chunk_limit_recordschunk event </span><br><span class=\"line\">total_limit_size buffer </span><br><span class=\"line\">chunk_full_thresholdchunk  chunk_limit_size * chunk_full_threshold  flush</span><br><span class=\"line\">queued_chunks_limit_size chunk  flush  chunk</span><br><span class=\"line\">compress text  gzip text</span><br><span class=\"line\">flush_at_shutdown flush buffer  true buffer  false</span><br><span class=\"line\">flush_interval flush </span><br><span class=\"line\">retry_timeout flush  retry</span><br><span class=\"line\">retry_forever flush true  retry_timeout </span><br><span class=\"line\">retry_max_times</span><br><span class=\"line\">retry_typeretry </span><br><span class=\"line\">retry_wait</span><br><span class=\"line\">retry_exponential_backoff_baseretry </span><br><span class=\"line\">retry_max_interval retry </span><br><span class=\"line\">retry_randomize retry </span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>format </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;match&gt;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;format&gt;</span><br><span class=\"line\">    @type json</span><br><span class=\"line\">  &lt;/format&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;buffer&gt;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">  &lt;/buffer&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>forward event  fluentd  fluentd </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;match yakir.*&gt;</span><br><span class=\"line\">  @type forward</span><br><span class=\"line\">  send_timeout 60s</span><br><span class=\"line\">  recover_wait 10s</span><br><span class=\"line\">  hard_timeout 60s</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;server&gt;</span><br><span class=\"line\">    name myserver1</span><br><span class=\"line\">    host 192.168.1.3</span><br><span class=\"line\">    port 24224</span><br><span class=\"line\">    weight 60</span><br><span class=\"line\">  &lt;/server&gt;</span><br><span class=\"line\">  &lt;server&gt;</span><br><span class=\"line\">    name myserver2</span><br><span class=\"line\">    host 192.168.1.4</span><br><span class=\"line\">    port 24224</span><br><span class=\"line\">    weight 60</span><br><span class=\"line\">  &lt;/server&gt;</span><br><span class=\"line\">  ...</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;secondary&gt;</span><br><span class=\"line\">    @type file</span><br><span class=\"line\">    path /var/log/fluent/forward-failed</span><br><span class=\"line\">  &lt;/secondary&gt;</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">server </span></span><br><span class=\"line\">host</span><br><span class=\"line\">name</span><br><span class=\"line\">port</span><br><span class=\"line\">shared_key</span><br><span class=\"line\">username</span><br><span class=\"line\">password</span><br><span class=\"line\">standby  server  node  standby  node</span><br><span class=\"line\">weight </span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>copy event </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type dummy</span><br><span class=\"line\">  dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class=\"line\">  tag yakir.test</span><br><span class=\"line\">  size 1</span><br><span class=\"line\">  rate 1</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match yakir.**&gt;</span><br><span class=\"line\">  @type copy</span><br><span class=\"line\">  &lt;store&gt;</span><br><span class=\"line\">    @type file</span><br><span class=\"line\">    path /tmp/yakir/file.%Y%m%d</span><br><span class=\"line\">    compress gzip</span><br><span class=\"line\">  &lt;/store&gt;</span><br><span class=\"line\">  &lt;store ignore_error&gt;</span><br><span class=\"line\">    @type stdout</span><br><span class=\"line\">  &lt;/store&gt;</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">copy_mode </span><br><span class=\"line\">  no_copy event</span><br><span class=\"line\">  shallow</span><br><span class=\"line\">  deepmsgpack-ruby</span><br><span class=\"line\">  marshalmarshal</span><br><span class=\"line\">store  ignore_error  store </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>http http  eventpayload  format </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;match pattern&gt;</span><br><span class=\"line\">  @type http</span><br><span class=\"line\">  endpoint http://logserver.com:9000/api</span><br><span class=\"line\">  open_timeout 2</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;format&gt;</span><br><span class=\"line\">    @type json</span><br><span class=\"line\">  &lt;/format&gt;</span><br><span class=\"line\">  &lt;buffer&gt;</span><br><span class=\"line\">    flush_interval 10s</span><br><span class=\"line\">  &lt;/buffer&gt;</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> post 2s json10s  endpointcontent-type  application/x-ndjson</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>stdout fluentd </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type dummy</span><br><span class=\"line\">  dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class=\"line\">  tag yakir.test</span><br><span class=\"line\">  size 1</span><br><span class=\"line\">  rate 1</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match yakir.**&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ElasticsearchKafka</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">elasticsearch </span></span><br><span class=\"line\">&lt;match yakir.logs&gt;</span><br><span class=\"line\">  @type elasticsearch</span><br><span class=\"line\">  host localhost</span><br><span class=\"line\">  port 9200</span><br><span class=\"line\">  logstash_format true</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">host elasticsearch </span><br><span class=\"line\">port elasticsearch </span><br><span class=\"line\">hostselasticsearch  ip1:port1,ip2:port2...</span><br><span class=\"line\">userpasswordelasticsearch </span><br><span class=\"line\">scheme https  http http </span><br><span class=\"line\">pathREST </span><br><span class=\"line\">index_nameindex </span><br><span class=\"line\">logstash_formatindex  logstash logstash-%Y.%m.%d</span><br><span class=\"line\">logstash_prefixlogstash_format index logstash</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kafka </span></span><br><span class=\"line\">&lt;match pattern&gt;</span><br><span class=\"line\">  @type kafka2</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">list of seed brokers</span></span><br><span class=\"line\">  brokers &lt;broker1_host&gt;:&lt;broker1_port&gt;,&lt;broker2_host&gt;:&lt;broker2_port&gt;</span><br><span class=\"line\">  use_event_time true</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">buffer settings</span></span><br><span class=\"line\">  &lt;buffer topic&gt;</span><br><span class=\"line\">    @type file</span><br><span class=\"line\">    path /var/log/td-agent/buffer/td</span><br><span class=\"line\">    flush_interval 3s</span><br><span class=\"line\">  &lt;/buffer&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">data <span class=\"built_in\">type</span> settings</span></span><br><span class=\"line\">  &lt;format&gt;</span><br><span class=\"line\">    @type json</span><br><span class=\"line\">  &lt;/format&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">topic settings</span></span><br><span class=\"line\">  topic_key topic</span><br><span class=\"line\">  default_topic messages</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">producer settings</span></span><br><span class=\"line\">  required_acks -1</span><br><span class=\"line\">  compression_codec gzip</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">brokersKafka brokers </span><br><span class=\"line\">topic_keyrecord  key  Kafka  key</span><br><span class=\"line\">default_topic topic_key topic </span><br><span class=\"line\">format </span><br><span class=\"line\">use_event_time fluentd event  Kafka  false</span><br><span class=\"line\">required_acksproducer acks </span><br><span class=\"line\">compression_codec</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>webhdfs REST  event  HDFS Hadoop</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;store&gt;</span><br><span class=\"line\">  @type webhdfs</span><br><span class=\"line\">  host 1.1.1.1</span><br><span class=\"line\">  port 50070</span><br><span class=\"line\">  path &quot;/history/access.log.%Y%m%d_%H.#&#123;Socket.gethostname&#125;.log&quot;</span><br><span class=\"line\">  &lt;buffer&gt;</span><br><span class=\"line\">      flush_interval 60s</span><br><span class=\"line\">  &lt;/buffer&gt;</span><br><span class=\"line\">&lt;/store&gt;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"parser-\"><a href=\"#parser-\" class=\"headerlink\" title=\"parser \"></a>parser </h4><ul>\n<li><strong>regexp time_key  event  time </strong><blockquote>\n<p><a href=\"http://fluentular.herokuapp.com/\">http://fluentular.herokuapp.com/</a></p>\n</blockquote>\n</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">&lt;parse&gt;</span><br><span class=\"line\">  @type regexp</span><br><span class=\"line\">  expression /^\\[(?&lt;logtime&gt;[^\\]]*)\\] (?&lt;name&gt;[^ ]*) (?&lt;title&gt;[^ ]*) (?&lt;id&gt;\\d*)$/</span><br><span class=\"line\">  time_key logtime</span><br><span class=\"line\">  time_format %Y-%m-%d %H:%M:%S %z</span><br><span class=\"line\">  types id:integer</span><br><span class=\"line\">&lt;/parse&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">[2013-02-28 12:00:00 +0900] alice engineer 1</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">time:</span><br><span class=\"line\">1362020400 (2013-02-28 12:00:00 +0900)</span><br><span class=\"line\"></span><br><span class=\"line\">record:</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot; : &quot;alice&quot;,</span><br><span class=\"line\">  &quot;title&quot;: &quot;engineer&quot;,</span><br><span class=\"line\">  &quot;id&quot;   : 1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"filter-\"><a href=\"#filter-\" class=\"headerlink\" title=\"filter \"></a>filter </h4><ul>\n<li><p><strong>record_transformer event </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> ruby </span></span><br><span class=\"line\">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">&lt;source&gt;</span><br><span class=\"line\">  @type dummy</span><br><span class=\"line\">  dummy &#123;&quot;foo&quot;:&quot;bar&quot;, &quot;id1&quot;: 100, &quot;id2&quot;: 50&#125;</span><br><span class=\"line\">  tag yakir.test</span><br><span class=\"line\">  size 1</span><br><span class=\"line\">  rate 1</span><br><span class=\"line\">&lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;filter&gt;</span><br><span class=\"line\">  @type record_transformer</span><br><span class=\"line\">  enable_ruby true</span><br><span class=\"line\">  &lt;record&gt;</span><br><span class=\"line\">    hostname &quot;#&#123;Socket.gethostname&#125;&quot;</span><br><span class=\"line\">    tag $&#123;tag&#125;</span><br><span class=\"line\">    avg $&#123;record[&quot;id1&quot;] / record[&quot;id2&quot;]&#125;</span><br><span class=\"line\">  &lt;/record&gt;</span><br><span class=\"line\">&lt;/filter&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;match yakir.**&gt;</span><br><span class=\"line\">  @type stdout</span><br><span class=\"line\">&lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class=\"line\">2022-07-04 10:12:53.028623276 +0000 yakir.test: &#123;&quot;foo&quot;:&quot;bar&quot;,&quot;id1&quot;:100,&quot;id2&quot;:50,&quot;hostname&quot;:&quot;7d5e83c528c7&quot;,&quot;tag&quot;:&quot;yakir.test&quot;,&quot;avg&quot;:2&#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">&lt;filter foo.bar&gt;</span><br><span class=\"line\">  @type record_transformer</span><br><span class=\"line\">  &lt;record&gt;</span><br><span class=\"line\">    message yay, $&#123;record[&quot;message&quot;]&#125;</span><br><span class=\"line\">  &lt;/record&gt;</span><br><span class=\"line\">&lt;/filter&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">&#123; &quot;message&quot;: &quot;hello world!&quot; &#125;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">time:</span><br><span class=\"line\">&#123; &quot;message&quot;: &quot;yay, hello world!&quot; &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>record </strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">&lt;record&gt;</span><br><span class=\"line\">  NEW_FIELD NEW_VALUE</span><br><span class=\"line\">&lt;/record&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">record record record[&quot;count&quot;]</span><br><span class=\"line\">tag tag </span><br><span class=\"line\">time</span><br><span class=\"line\">hostname#&#123;Socket.gethostname&#125;</span><br><span class=\"line\">tag_parts[N]tag . tag  N </span><br><span class=\"line\">tag_prefix[N] tag  0-N </span><br><span class=\"line\">tag_suffix[N] tag  N-</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"DaemonSet-\"><a href=\"#DaemonSet-\" class=\"headerlink\" title=\"DaemonSet \"></a>DaemonSet </h3><img data-src=\"/posts/41fe/fluent2.png\" class>\n<h4 id=\"-Elasticsearch--Kibana\"><a href=\"#-Elasticsearch--Kibana\" class=\"headerlink\" title=\" Elasticsearch  Kibana\"></a> Elasticsearch  Kibana</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> namespace</span></span><br><span class=\"line\">kubectl create ns logging</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> ElasticsearchStatefulSet  Serviceservice </span></span><br><span class=\"line\">cat &gt; elasticsearch.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: StatefulSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: es</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  serviceName: elasticsearch</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: elasticsearch</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: elasticsearch</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      # </span><br><span class=\"line\">      initContainers:</span><br><span class=\"line\">      - name: increase-vm-max-map</span><br><span class=\"line\">        image: busybox</span><br><span class=\"line\">        command: [&quot;sysctl&quot;, &quot;-w&quot;, &quot;vm.max_map_count=262144&quot;]</span><br><span class=\"line\">        securityContext:</span><br><span class=\"line\">          privileged: true</span><br><span class=\"line\">      - name: increase-fd-ulimit</span><br><span class=\"line\">        image: busybox</span><br><span class=\"line\">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;ulimit -n 65536&quot;]</span><br><span class=\"line\">        securityContext:</span><br><span class=\"line\">          privileged: true</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: elasticsearch</span><br><span class=\"line\">        image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 1000m</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9200</span><br><span class=\"line\">          name: rest</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        - containerPort: 9300</span><br><span class=\"line\">          name: inter-node</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: data</span><br><span class=\"line\">          mountPath: /usr/share/elasticsearch/data</span><br><span class=\"line\">        env:</span><br><span class=\"line\">          - name: cluster.name</span><br><span class=\"line\">            value: k8s-logs</span><br><span class=\"line\">          - name: node.name</span><br><span class=\"line\">            valueFrom:</span><br><span class=\"line\">              fieldRef:</span><br><span class=\"line\">                fieldPath: metadata.name</span><br><span class=\"line\">          # ES </span><br><span class=\"line\">          - name: cluster.initial_master_nodes</span><br><span class=\"line\">            value: &quot;es-0&quot;</span><br><span class=\"line\">          - name: discovery.zen.minimum_master_nodes</span><br><span class=\"line\">            value: &quot;1&quot;</span><br><span class=\"line\">          - name: discovery.seed_hosts</span><br><span class=\"line\">            value: &quot;elasticsearch&quot;</span><br><span class=\"line\">          - name: ES_JAVA_OPTS</span><br><span class=\"line\">            value: &quot;-Xms512m -Xmx512m&quot;</span><br><span class=\"line\">          - name: network.host</span><br><span class=\"line\">            value: &quot;0.0.0.0&quot;</span><br><span class=\"line\">      #  StorageClass </span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: data</span><br><span class=\"line\">        emptyDir: &#123;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: elasticsearch</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: elasticsearch</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: elasticsearch</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\"> StatefulSet  Pod  DNS  es-0.elasticsearch.logging.svc.cluster.local</span></span><br><span class=\"line\">  clusterIP: None</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: 9200</span><br><span class=\"line\">      name: rest</span><br><span class=\"line\">    - port: 9300</span><br><span class=\"line\">      name: inter-node</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Kibana </span></span><br><span class=\"line\">cat &gt; kibana.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kibana</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kibana</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: kibana</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 5601</span><br><span class=\"line\">  type: ClusterIP</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kibana</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kibana</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: kibana</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: kibana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: kibana</span><br><span class=\"line\">        image: docker.elastic.co/kibana/kibana:7.6.2</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 1000m</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 200m</span><br><span class=\"line\">        env:</span><br><span class=\"line\">        - name: ELASTICSEARCH_HOSTS</span><br><span class=\"line\">          value: http://elasticsearch:9200</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 5601</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl apply -f elasticsearch.yaml</span><br><span class=\"line\">kubectl apply -f kibana.yaml</span><br><span class=\"line\">kubectl get pod,svc -n logging -owide</span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">pod/es-0                      1/1     Running   0          4h54m   172.17.0.6   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">pod/kibana-6c84594848-mdp76   1/1     Running   0          158m    172.17.0.5   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE     SELECTOR</span><br><span class=\"line\">service/elasticsearch   ClusterIP   None           &lt;none&gt;        9200/TCP,9300/TCP   4h50m   app=elasticsearch</span><br><span class=\"line\">service/kibana          ClusterIP   10.106.67.32   &lt;none&gt;        5601/TCP            158m    app=kibana</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl port-forward services/elasticsearch -n logging --address 127.0.0.1 9200:9200</span><br><span class=\"line\">curl http://127.0.0.1:9200/_cluster/state?pretty</span><br><span class=\"line\">curl 10.106.67.32:5601/app/kibana -I</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"-Fluentd\"><a href=\"#-Fluentd\" class=\"headerlink\" title=\" Fluentd\"></a> Fluentd</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">git <span class=\"built_in\">clone</span> https://github.com/fluent/fluentd-kubernetes-daemonset.git</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Fluentd </span></span><br><span class=\"line\">cat &gt; fluentd-cfg.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-config</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">data:</span><br><span class=\"line\">  system.conf: |-</span><br><span class=\"line\">    &lt;system&gt;</span><br><span class=\"line\">      root_dir /tmp/fluentd-buffers/</span><br><span class=\"line\">    &lt;/system&gt;</span><br><span class=\"line\">  containers.input.conf: |-</span><br><span class=\"line\">    &lt;source&gt;</span><br><span class=\"line\">      @id fluentd-containers.log</span><br><span class=\"line\">      @type tail                              # Fluentd </span><br><span class=\"line\">      path /var/log/containers/*.log          # Docker</span><br><span class=\"line\">      pos_file /var/log/es-containers.log.pos</span><br><span class=\"line\">      tag raw.kubernetes.*                    # </span><br><span class=\"line\">      read_from_head true</span><br><span class=\"line\">      &lt;parse&gt;                                 # JSON</span><br><span class=\"line\">        @type multi_format                    #  multi-format-parser </span><br><span class=\"line\">        &lt;pattern&gt;</span><br><span class=\"line\">          format json                         # JSON</span><br><span class=\"line\">          time_key time                       # </span><br><span class=\"line\">          time_format %Y-%m-%dT%H:%M:%S.%NZ   # </span><br><span class=\"line\">        &lt;/pattern&gt;</span><br><span class=\"line\">        &lt;pattern&gt;</span><br><span class=\"line\">          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/</span><br><span class=\"line\">          time_format %Y-%m-%dT%H:%M:%S.%N%:z</span><br><span class=\"line\">        &lt;/pattern&gt;</span><br><span class=\"line\">      &lt;/parse&gt;</span><br><span class=\"line\">    &lt;/source&gt;</span><br><span class=\"line\">    # </span><br><span class=\"line\">    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions</span><br><span class=\"line\">    &lt;match raw.kubernetes.**&gt;           # tagraw.kubernetes.**</span><br><span class=\"line\">      @id raw.kubernetes</span><br><span class=\"line\">      @type detect_exceptions           # detect-exceptions</span><br><span class=\"line\">      remove_tag_prefix raw             #  raw </span><br><span class=\"line\">      message log</span><br><span class=\"line\">      stream stream</span><br><span class=\"line\">      multiline_flush_interval 5</span><br><span class=\"line\">      max_bytes 500000</span><br><span class=\"line\">      max_lines 1000</span><br><span class=\"line\">    &lt;/match&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;filter **&gt;  # </span><br><span class=\"line\">      @id filter_concat</span><br><span class=\"line\">      @type concat                # Fluentd Filter </span><br><span class=\"line\">      key message</span><br><span class=\"line\">      multiline_end_regexp /\\n$/  # \\n</span><br><span class=\"line\">      separator &quot;&quot;</span><br><span class=\"line\">    &lt;/filter&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    #  Kubernetes metadata </span><br><span class=\"line\">    &lt;filter kubernetes.**&gt;</span><br><span class=\"line\">      @id filter_kubernetes_metadata</span><br><span class=\"line\">      @type kubernetes_metadata</span><br><span class=\"line\">    &lt;/filter&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    #  ES  JSON </span><br><span class=\"line\">    # https://github.com/repeatedly/fluent-plugin-multi-format-parser</span><br><span class=\"line\">    &lt;filter kubernetes.**&gt;</span><br><span class=\"line\">      @id filter_parser</span><br><span class=\"line\">      @type parser                # multi-format-parser</span><br><span class=\"line\">      key_name log                # </span><br><span class=\"line\">      reserve_data true           # </span><br><span class=\"line\">      remove_key_name_field true  # key_name </span><br><span class=\"line\">      &lt;parse&gt;</span><br><span class=\"line\">        @type multi_format</span><br><span class=\"line\">        &lt;pattern&gt;</span><br><span class=\"line\">          format json</span><br><span class=\"line\">        &lt;/pattern&gt;</span><br><span class=\"line\">        &lt;pattern&gt;</span><br><span class=\"line\">          format none</span><br><span class=\"line\">        &lt;/pattern&gt;</span><br><span class=\"line\">      &lt;/parse&gt;</span><br><span class=\"line\">    &lt;/filter&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    &lt;filter kubernetes.**&gt;</span><br><span class=\"line\">      @type record_transformer</span><br><span class=\"line\">      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash</span><br><span class=\"line\">    &lt;/filter&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    # logging=truePod</span><br><span class=\"line\">    &lt;filter kubernetes.**&gt;</span><br><span class=\"line\">      @id filter_log</span><br><span class=\"line\">      @type grep</span><br><span class=\"line\">      &lt;regexp&gt;</span><br><span class=\"line\">        key $.kubernetes.labels.logging</span><br><span class=\"line\">        pattern ^true$</span><br><span class=\"line\">      &lt;/regexp&gt;</span><br><span class=\"line\">    &lt;/filter&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\"><span class=\"comment\">#####  ######</span></span></span><br><span class=\"line\">  forward.input.conf: |-</span><br><span class=\"line\">    # TCP</span><br><span class=\"line\">    &lt;source&gt;</span><br><span class=\"line\">      @id forward</span><br><span class=\"line\">      @type forward</span><br><span class=\"line\">    &lt;/source&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  output.conf: |-</span><br><span class=\"line\">    &lt;match **&gt;</span><br><span class=\"line\">      @id elasticsearch</span><br><span class=\"line\">      @type elasticsearch</span><br><span class=\"line\">      @log_level info</span><br><span class=\"line\">      include_tag_key true</span><br><span class=\"line\">      host elasticsearch</span><br><span class=\"line\">      port 9200</span><br><span class=\"line\">      logstash_format true</span><br><span class=\"line\">      logstash_prefix k8s  #  index  k8s</span><br><span class=\"line\">      request_timeout    30s</span><br><span class=\"line\">      &lt;buffer&gt;</span><br><span class=\"line\">        @type file</span><br><span class=\"line\">        path /var/log/fluentd-buffers/kubernetes.system.buffer</span><br><span class=\"line\">        flush_mode interval</span><br><span class=\"line\">        retry_type exponential_backoff</span><br><span class=\"line\">        flush_thread_count 2</span><br><span class=\"line\">        flush_interval 5s</span><br><span class=\"line\">        retry_forever</span><br><span class=\"line\">        retry_max_interval 30</span><br><span class=\"line\">        chunk_limit_size 2M</span><br><span class=\"line\">        queue_limit_length 8</span><br><span class=\"line\">        overflow_action block</span><br><span class=\"line\">      &lt;/buffer&gt;</span><br><span class=\"line\">    &lt;/match&gt;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; fluentd-daemonset.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: fluentd-es</span><br><span class=\"line\">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class=\"line\">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: fluentd-es</span><br><span class=\"line\">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class=\"line\">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class=\"line\">rules:</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - &quot;&quot;</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - &quot;namespaces&quot;</span><br><span class=\"line\">  - &quot;pods&quot;</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - &quot;get&quot;</span><br><span class=\"line\">  - &quot;watch&quot;</span><br><span class=\"line\">  - &quot;list&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: fluentd-es</span><br><span class=\"line\">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class=\"line\">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  apiGroup: &quot;&quot;</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  apiGroup: &quot;&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: DaemonSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-es</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: fluentd-es</span><br><span class=\"line\">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class=\"line\">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      k8s-app: fluentd-es</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        k8s-app: fluentd-es</span><br><span class=\"line\">        kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class=\"line\">      # fluentd pod </span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        priorityClassName: system-cluster-critical</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      serviceAccountName: fluentd-es</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: fluentd-es</span><br><span class=\"line\">        image: quay.io/fluentd_elasticsearch/fluentd:v3.0.1</span><br><span class=\"line\">        #image: fluent/fluentd-kubernetes-daemonset:v1.14.6-debian-elasticsearch7-1.1</span><br><span class=\"line\">        env:</span><br><span class=\"line\">        - name: FLUENTD_ARGS</span><br><span class=\"line\">          value: --no-supervisor -q</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            memory: 500Mi</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 200Mi</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: varlog</span><br><span class=\"line\">          mountPath: /var/log</span><br><span class=\"line\">        - name: varlibdockercontainers</span><br><span class=\"line\">          mountPath: /var/lib/docker/containers</span><br><span class=\"line\">          readOnly: true</span><br><span class=\"line\">        - name: config-volume</span><br><span class=\"line\">          mountPath: /etc/fluent/config.d</span><br><span class=\"line\">      #  master  master </span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - operator: Exists</span><br><span class=\"line\">      terminationGracePeriodSeconds: 30</span><br><span class=\"line\">      # </span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: varlog</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          path: /var/log</span><br><span class=\"line\">      - name: varlibdockercontainers</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          path: /var/lib/docker/containers</span><br><span class=\"line\">      - name: config-volume</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: fluentd-config</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl apply -f fluentd-cfg.yaml</span><br><span class=\"line\">kubectl apply -f fluentd-daemonset.yaml</span><br><span class=\"line\">kubectl get pod -n logging -owide</span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS        AGE     IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">pod/fluentd-es-cfdcx          1/1     Running   0               91m     172.17.0.7   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat &gt; stdin.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: counter1</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    # </span><br><span class=\"line\">    logging: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">    - image: busybox</span><br><span class=\"line\">      args: [&quot;/bin/sh&quot;,&quot;-c&quot;, &#x27;i=0; while true; do echo &quot;$i: $(date)&quot;; i=$((i+1)); sleep 5; done&#x27;]</span><br><span class=\"line\">      name: counter</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">sidecar </span></span><br><span class=\"line\">cat &gt; sidecar.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: counter2</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    logging: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: counter2</span><br><span class=\"line\">    image: busybox</span><br><span class=\"line\">    args:</span><br><span class=\"line\">    - /bin/sh</span><br><span class=\"line\">    - -c</span><br><span class=\"line\">    - &gt;</span><br><span class=\"line\">      i=0;</span><br><span class=\"line\">      while true;</span><br><span class=\"line\">      do</span><br><span class=\"line\">        echo &quot;$i: $(date)&quot; &gt;&gt; /var/log/1.log;</span><br><span class=\"line\">        echo &quot;$(date) INFO $i&quot; &gt;&gt; /var/log/2.log;</span><br><span class=\"line\">        i=$((i+1));</span><br><span class=\"line\">        sleep 3;</span><br><span class=\"line\">      done</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: varlog</span><br><span class=\"line\">      mountPath: /var/log</span><br><span class=\"line\">  - name: count-log-1</span><br><span class=\"line\">    image: busybox</span><br><span class=\"line\">    args: [/bin/sh, -c, &#x27;tail -n 1 -f /var/log/1.log&#x27;]</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: varlog</span><br><span class=\"line\">      mountPath: /var/log</span><br><span class=\"line\">  - name: count-log-2</span><br><span class=\"line\">    image: busybox</span><br><span class=\"line\">    args: [/bin/sh, -c, &#x27;tail -n 1 -f /var/log/2.log&#x27;]</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: varlog</span><br><span class=\"line\">      mountPath: /var/log</span><br><span class=\"line\">  restartPolicy: Never</span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - name: varlog</span><br><span class=\"line\">    emptyDir: &#123;&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl logs counter2 count-log-2 -f --<span class=\"built_in\">tail</span> 3</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> JSON </span></span><br><span class=\"line\">cat &gt; dummylogs.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dummylogs</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: dummylogs</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: dummylogs</span><br><span class=\"line\">        logging: &quot;true&quot;  # </span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: dummy</span><br><span class=\"line\">        image: cnych/dummylogs:latest</span><br><span class=\"line\">        args:</span><br><span class=\"line\">        - msg-processor</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dummylogs2</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: dummylogs2</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: dummylogs2</span><br><span class=\"line\">        logging: &quot;true&quot;  # </span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: dummy</span><br><span class=\"line\">        image: cnych/dummylogs:latest</span><br><span class=\"line\">        args:</span><br><span class=\"line\">        - msg-receiver-api</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl apply -f counter.yaml</span><br><span class=\"line\">kubectl apply -f dummylogs.yaml</span><br></pre></td></tr></table></figure>\n<h4 id=\"Kibana-amp-Elasticsearch-\"><a href=\"#Kibana-amp-Elasticsearch-\" class=\"headerlink\" title=\"Kibana  &amp; Elasticsearch \"></a>Kibana  &amp; Elasticsearch </h4><ul>\n<li><p> Kibana  &amp; Elasticsearch </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl port-forward services/kibana -n logging --address 127.0.0.1 5601:5601</span><br><span class=\"line\">kubectl port-forward services/elasticsearch -n logging --address 127.0.0.1 9200:9200</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n</li>\n</ul>\n<img data-src=\"/posts/41fe/fluent3.png\" class>\n<img data-src=\"/posts/41fe/fluent4.png\" class>\n\n<ul>\n<li>Kibana <h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; elastalert.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: elastalert-config</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: elastalert</span><br><span class=\"line\">data:</span><br><span class=\"line\">  elastalert_config: |-</span><br><span class=\"line\">    ---</span><br><span class=\"line\">    rules_folder: /opt/rules       # </span><br><span class=\"line\">    scan_subdirectories: false</span><br><span class=\"line\">    run_every:                     #  ES </span><br><span class=\"line\">      minutes: 1</span><br><span class=\"line\">    buffer_time:</span><br><span class=\"line\">      minutes: 15</span><br><span class=\"line\">    es_host: elasticsearch</span><br><span class=\"line\">    es_port: 9200</span><br><span class=\"line\">    writeback_index: elastalert</span><br><span class=\"line\">    use_ssl: False</span><br><span class=\"line\">    verify_certs: True</span><br><span class=\"line\">    alert_time_limit:             # </span><br><span class=\"line\">      minutes: 720</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: elastalert-rules</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: elastalert</span><br><span class=\"line\">data:</span><br><span class=\"line\">  rule_config.yaml: |-</span><br><span class=\"line\">    name: dummylogs error     # </span><br><span class=\"line\">    es_host: elasticsearch</span><br><span class=\"line\">    es_port: 9200</span><br><span class=\"line\">    type: any                 # </span><br><span class=\"line\">    index: k8s-*              # es</span><br><span class=\"line\">    filter:                   # </span><br><span class=\"line\">    - query:</span><br><span class=\"line\">        query_string:</span><br><span class=\"line\">          query: &quot;LOGLEVEL:ERROR&quot;  # </span><br><span class=\"line\">    alert:                         # </span><br><span class=\"line\">    - &quot;email&quot;</span><br><span class=\"line\">    smtp_host: 127.0.0.1</span><br><span class=\"line\">    smtp_port: 587</span><br><span class=\"line\">    smtp_auth_file: /opt/auth/smtp_auth_file.yaml</span><br><span class=\"line\">    email_reply_to: xxx@gmail.com</span><br><span class=\"line\">    from_addr: xxx@gmail.com</span><br><span class=\"line\">    email:                  # </span><br><span class=\"line\">    - &quot;xxx@gmail.com&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: elastalert</span><br><span class=\"line\">  namespace: logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: elastalert</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: elastalert</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: elastalert</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: elastalert</span><br><span class=\"line\">        image: jertel/elastalert-docker:0.2.4</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: config</span><br><span class=\"line\">          mountPath: /opt/config</span><br><span class=\"line\">        - name: rules</span><br><span class=\"line\">          mountPath: /opt/rules</span><br><span class=\"line\">        - name: auth</span><br><span class=\"line\">          mountPath: /opt/auth</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 50m</span><br><span class=\"line\">            memory: 256Mi</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 50m</span><br><span class=\"line\">            memory: 256Mi</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: auth</span><br><span class=\"line\">        secret:</span><br><span class=\"line\">          secretName: smtp-auth</span><br><span class=\"line\">      - name: rules</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: elastalert-rules</span><br><span class=\"line\">      - name: config</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: elastalert-config</span><br><span class=\"line\">          items:</span><br><span class=\"line\">          - key: elastalert_config</span><br><span class=\"line\">            path: elastalert_config.yaml</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat &gt; smtp_auth_file.yaml &lt;&lt; EOF</span><br><span class=\"line\">user: &quot;xxxxx@gmail.com&quot;</span><br><span class=\"line\">password: &quot;123xxx&quot;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl create secret generic smtp-auth --from-file=smtp_auth_file.yaml -n logging</span><br><span class=\"line\">kubectl apply -f elastalert.yaml</span><br><span class=\"line\">kubectl get pods -n logging -l app=elastalert</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> Kibana </span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"fluentd-operator-\"><a href=\"#fluentd-operator-\" class=\"headerlink\" title=\"fluentd-operator \"></a>fluentd-operator </h3><h4 id=\"CRD-\"><a href=\"#CRD-\" class=\"headerlink\" title=\"CRD \"></a>CRD </h4><p><strong>fluentbit.fluent.io </strong></p>\n<ul>\n<li>FluentBit Fluent Bit </li>\n<li>ClusterFluentBitConfig Fluent Bit </li>\n<li>ClusterInput Fluent Bit  input </li>\n<li>ClusterFilter Fluent Bit  filter </li>\n<li>ClusterParser Fluent Bit  parser </li>\n<li>ClusterOutput Fluent Bit  output </li>\n</ul>\n<p><strong>fluentd.fluent.io </strong></p>\n<ul>\n<li>Fluentd Fluentd </li>\n<li>FluentdConfig Fluentd namespace </li>\n<li>ClusterFluentdConfig Fluentd </li>\n<li>Filter Fluentd namespace  filter </li>\n<li>ClusterFilter Fluentd  filter </li>\n<li>Output Fluentd namespace  output </li>\n<li>ClusterOutput Fluentd  output </li>\n</ul>\n<h4 id=\"-CRD--fluent-operator\"><a href=\"#-CRD--fluent-operator\" class=\"headerlink\" title=\" CRD  fluent-operator\"></a> CRD  fluent-operator</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CRD  fluent-operator</span></span><br><span class=\"line\">git clone https://github.com/fluent/fluent-operator</span><br><span class=\"line\">cd fluent-operator &amp;&amp; kubectl apply -f manifests/setup/setup.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get pod,crd -n fluent</span><br><span class=\"line\">NAME                                   READY   STATUS    RESTARTS        AGE</span><br><span class=\"line\">pod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (5h20m ago)   22h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                                                                        CREATED AT</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterfilters.fluentbit.fluent.io            2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterfilters.fluentd.fluent.io              2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterfluentbitconfigs.fluentbit.fluent.io   2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterfluentdconfigs.fluentd.fluent.io       2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterinputs.fluentbit.fluent.io             2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusteroutputs.fluentbit.fluent.io            2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusteroutputs.fluentd.fluent.io              2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterparsers.fluentbit.fluent.io            2022-07-05T07:45:26Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/filters.fluentd.fluent.io                     2022-07-05T07:45:27Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/fluentbits.fluentbit.fluent.io                2022-07-05T07:45:27Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/fluentdconfigs.fluentd.fluent.io              2022-07-05T07:45:27Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/fluentds.fluentd.fluent.io                    2022-07-05T07:45:27Z</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/outputs.fluentd.fluent.io                     2022-07-05T07:45:28Z</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Fluent-Bit-Only-\"><a href=\"#Fluent-Bit-Only-\" class=\"headerlink\" title=\"Fluent Bit Only \"></a>Fluent Bit Only </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Fluent Bit </span></span><br><span class=\"line\">cat &gt; fluent-bit.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class=\"line\">kind: FluentBit</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluent-bit</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: fluent-bit</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  image: kubesphere/fluent-bit:v1.8.11</span><br><span class=\"line\">  positionDB:</span><br><span class=\"line\">    hostPath:</span><br><span class=\"line\">      path: /var/lib/fluent-bit/</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      cpu: 10m</span><br><span class=\"line\">      memory: 25Mi</span><br><span class=\"line\">    limits:</span><br><span class=\"line\">      cpu: 500m</span><br><span class=\"line\">      memory: 200Mi</span><br><span class=\"line\">  fluentBitConfigName: fluent-bit-config</span><br><span class=\"line\">  tolerations:</span><br><span class=\"line\">    - operator: Exists</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class=\"line\">kind: ClusterFluentBitConfig</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluent-bit-config</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: fluent-bit</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  service:</span><br><span class=\"line\">    parsersFile: parsers.conf</span><br><span class=\"line\">  inputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class=\"line\">  filterSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class=\"line\">  outputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class=\"line\">kind: ClusterInput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: tail</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  tail:</span><br><span class=\"line\">    tag: kube.*</span><br><span class=\"line\">    path: /var/log/containers/*.log</span><br><span class=\"line\">    parser: docker</span><br><span class=\"line\">    refreshIntervalSeconds: 10</span><br><span class=\"line\">    memBufLimit: 5MB</span><br><span class=\"line\">    skipLongLines: true</span><br><span class=\"line\">    db: /fluent-bit/tail/pos.db</span><br><span class=\"line\">    dbSync: Normal</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: es</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  matchRegex: (?:kube|service)\\.(.*)</span><br><span class=\"line\">  es:</span><br><span class=\"line\">    host: elasticsearch</span><br><span class=\"line\">    port: 9200</span><br><span class=\"line\">    generateID: true</span><br><span class=\"line\">    logstashPrefix: fluent-log-fb-only</span><br><span class=\"line\">    logstashFormat: true</span><br><span class=\"line\">    timeKey: &quot;@timestamp&quot;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> output  elasticsearch </span></span><br><span class=\"line\">kubectl apply -f elasticsearch.yaml</span><br><span class=\"line\">kubectl apply -f fluent-bit.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get pod,svc -n fluent</span><br><span class=\"line\">NAME                                   READY   STATUS    RESTARTS      AGE</span><br><span class=\"line\">pod/es-0                               1/1     Running   1 (56m ago)   17h</span><br><span class=\"line\">pod/fluent-bit-rjqsd                   1/1     Running   0             2m34s</span><br><span class=\"line\">pod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (56m ago)   17h</span><br><span class=\"line\">NAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE</span><br><span class=\"line\">service/elasticsearch   ClusterIP   None         &lt;none&gt;        9200/TCP,9300/TCP   17h</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Elasticsearch </span></span><br><span class=\"line\">kubectl port-forward services/elasticsearch -n fluent --address 127.0.0.1 9200:9200</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">curl &quot;127.0.0.1:9200/_cat/indices?pretty&quot;</span><br><span class=\"line\">yellow open fluent-log-fb-only-2022.07.06 lLmstFnwQLa89Jb7TFe-0Q 1 1 152 0 155.2kb 155.2kb </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">curl &quot;127.0.0.1:9200/fluent-log-fb-only-2022.07.06/_search?pretty&quot;</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> ID </span></span><br><span class=\"line\">curl &quot;127.0.0.1:9200/fluent-log-fb-only-2022.07.06/_doc/b641529e-255c-f260-f911-f7d00d84e3fe?pretty&quot;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;_index&quot; : &quot;fluent-log-fb-only-2022.07.06&quot;,</span><br><span class=\"line\">  &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class=\"line\">  &quot;_id&quot; : &quot;b641529e-255c-f260-f911-f7d00d84e3fe&quot;,</span><br><span class=\"line\">  &quot;_version&quot; : 1,</span><br><span class=\"line\">  &quot;_seq_no&quot; : 94,</span><br><span class=\"line\">  &quot;_primary_term&quot; : 1,</span><br><span class=\"line\">  &quot;found&quot; : true,</span><br><span class=\"line\">  &quot;_source&quot; : &#123;</span><br><span class=\"line\">    &quot;@timestamp&quot; : &quot;2022-07-06T02:57:38.035Z&quot;,</span><br><span class=\"line\">    &quot;log&quot; : &quot;[2022/07/06 02:57:38] [ info] [input:tail:tail.0] inotify_fs_add(): inode=2050771 watch_fd=3 name=/var/log/containers/dashboard-metrics-scraper-58549894f-q9lpg_kubernetes-dashboard_dashboard-metrics-scraper-51061ac5d9c2c7c2da734ab35b9252edb29f4101ade5679a22181d0d735dc364.log\\n&quot;,</span><br><span class=\"line\">    &quot;time&quot; : &quot;2022-07-06T02:57:38.035319145Z&quot;,</span><br><span class=\"line\">    &quot;kubernetes&quot; : &#123;</span><br><span class=\"line\">      &quot;pod_name&quot; : &quot;fluent-bit-8v2qn&quot;,</span><br><span class=\"line\">      &quot;namespace_name&quot; : &quot;fluent&quot;,</span><br><span class=\"line\">      &quot;container_name&quot; : &quot;fluent-bit&quot;,</span><br><span class=\"line\">      &quot;docker_id&quot; : &quot;098d8ac65b201686b7a2945df6ee1a919b7220b637aea4de6490d92569c9c455&quot;,</span><br><span class=\"line\">      &quot;container_image&quot; : &quot;kubesphere/fluent-bit:v1.8.11&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Fluent-Bit-Fluentd-\"><a href=\"#Fluent-Bit-Fluentd-\" class=\"headerlink\" title=\"Fluent Bit + Fluentd \"></a>Fluent Bit + Fluentd </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Fluent Bit output  forward  Fluentd</span></span><br><span class=\"line\">cat &gt;&gt; fluent-bit.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    fluentbit.fluent.io/component: logging</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  matchRegex: (?:kube|service)\\.(.*)</span><br><span class=\"line\">  forward:</span><br><span class=\"line\">    host: fluentd.fluent.svc</span><br><span class=\"line\">    port: 24224</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Fluentd</span> </span><br><span class=\"line\">cat &gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: Fluentd</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: fluentd</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  globalInputs:</span><br><span class=\"line\">  - forward:</span><br><span class=\"line\">      bind: 0.0.0.0</span><br><span class=\"line\">      port: 24224</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  image: kubesphere/fluentd:v1.14.4</span><br><span class=\"line\">  fluentdCfgSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Fluentd</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">1. ClusterFluentdConfig  kube-system  default  namesapce  ClusterOutput</span></span><br><span class=\"line\">cat &gt;&gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterFluentdConfig</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-config</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  watchedNamespaces:</span><br><span class=\"line\">  - kube-system</span><br><span class=\"line\">  - default</span><br><span class=\"line\">  clusterOutputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      output.fluentd.fluent.io/scope: &quot;cluster&quot;</span><br><span class=\"line\">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-output-es</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/scope: &quot;cluster&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">  - elasticsearch:</span><br><span class=\"line\">      host: elasticsearch-master.elastic.svc</span><br><span class=\"line\">      port: 9200</span><br><span class=\"line\">      logstashFormat: true</span><br><span class=\"line\">      logstashPrefix: fluent-log-cluster-fd</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">2. FluentdConfig + ClusterFluentdConfig  namespace  Output  ClusterOutput</span></span><br><span class=\"line\">cat &gt;&gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: FluentdConfig</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: namespace-fluentd-config-user1</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class=\"line\">  clusterOutputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterFluentdConfig</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-config-cluster-only</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  watchedNamespaces:</span><br><span class=\"line\">  - kube-system</span><br><span class=\"line\">  - kubesphere-system</span><br><span class=\"line\">  clusterOutputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">      output.fluentd.fluent.io/scope: &quot;cluster-only&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: Output</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: namespace-fluentd-output-user1</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">  - elasticsearch:</span><br><span class=\"line\">      host: elasticsearch-master.elastic.svc</span><br><span class=\"line\">      port: 9200</span><br><span class=\"line\">      logstashFormat: true</span><br><span class=\"line\">      logstashPrefix: fluent-log-user1-fd</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-output-user1</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">  - elasticsearch:</span><br><span class=\"line\">      host: elasticsearch-master.elastic.svc</span><br><span class=\"line\">      port: 9200</span><br><span class=\"line\">      logstashFormat: true</span><br><span class=\"line\">      logstashPrefix: fluent-log-cluster-user1-fd</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-output-cluster-only</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/scope: &quot;cluster-only&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">  - elasticsearch:</span><br><span class=\"line\">      host: elasticsearch-master.elastic.svc</span><br><span class=\"line\">      port: 9200</span><br><span class=\"line\">      logstashFormat: true</span><br><span class=\"line\">      logstashPrefix: fluent-log-cluster-only-fd</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Fluentd  buffer </span></span><br><span class=\"line\">cat &gt;&gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: ClusterOutput</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: cluster-fluentd-output-buffer</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/type: &quot;buffer&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">  - stdout: &#123;&#125;</span><br><span class=\"line\">    buffer:</span><br><span class=\"line\">      type: file</span><br><span class=\"line\">      path: /buffers/stdout.log</span><br><span class=\"line\">  - elasticsearch:</span><br><span class=\"line\">      host: elasticsearch-master.elastic.svc</span><br><span class=\"line\">      port: 9200</span><br><span class=\"line\">      logstashFormat: true</span><br><span class=\"line\">      logstashPrefix: fluent-log-buffer-fd</span><br><span class=\"line\">    buffer:</span><br><span class=\"line\">      type: file</span><br><span class=\"line\">      path: /buffers/es.log</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Fluentd-Only-\"><a href=\"#Fluentd-Only-\" class=\"headerlink\" title=\"Fluentd Only \"></a>Fluentd Only </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: Fluentd</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-http</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: fluentd</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  globalInputs:</span><br><span class=\"line\">    - http:</span><br><span class=\"line\">        bind: 0.0.0.0</span><br><span class=\"line\">        port: 9880</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  image: kubesphere/fluentd:v1.14.4</span><br><span class=\"line\">  fluentdCfgSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: FluentdConfig</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-only-config</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  filterSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      filter.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class=\"line\">      filter.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">  outputSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      output.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class=\"line\">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: Filter</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-only-filter</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    filter.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class=\"line\">    filter.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  filters:</span><br><span class=\"line\">    - stdout: &#123;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class=\"line\">kind: Output</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: fluentd-only-stdout</span><br><span class=\"line\">  namespace: fluent</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    output.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class=\"line\">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  outputs:</span><br><span class=\"line\">    - stdout: &#123;&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get all -n fluent</span><br><span class=\"line\">NAME                                   READY   STATUS    RESTARTS       AGE</span><br><span class=\"line\">pod/es-0                               1/1     Running   1 (163m ago)   19h</span><br><span class=\"line\">pod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (163m ago)   19h</span><br><span class=\"line\">pod/fluentd-http-0                     1/1     Running   0              2m53s</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE</span><br><span class=\"line\">service/elasticsearch   ClusterIP   None         &lt;none&gt;        9200/TCP,9300/TCP   19h</span><br><span class=\"line\">service/fluentd-http    ClusterIP   10.97.96.1   &lt;none&gt;        9880/TCP            2m54s</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">deployment.apps/fluent-operator   1/1     1            1           19h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                         DESIRED   CURRENT   READY   AGE</span><br><span class=\"line\">replicaset.apps/fluent-operator-86858cfc87   1         1         1       19h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                            READY   AGE</span><br><span class=\"line\">statefulset.apps/es             1/1     19h</span><br><span class=\"line\">statefulset.apps/fluentd-http   1/1     2m54s</span><br></pre></td></tr></table></figure>\n\n\n<blockquote>\n<p><br>1<a href=\"https://www.qikqiak.com/post/install-efk-stack-on-k8s/\">https://www.qikqiak.com/post/install-efk-stack-on-k8s/</a><br>2fluentd <a href=\"https://docs.fluentd.org/\">https://docs.fluentd.org/</a><br>3fluentd-operator <a href=\"https://github.com/fluent/fluent-operator\">https://github.com/fluent/fluent-operator</a><br>4fluent-operator-walkthrough<a href=\"https://github.com/kubesphere-sigs/fluent-operator-walkthrough\">https://github.com/kubesphere-sigs/fluent-operator-walkthrough</a><br>5KubeSphere<a href=\"https://kubesphere.com.cn/blogs/fluent-operator-logging\">https://kubesphere.com.cn/blogs/fluent-operator-logging</a></p>\n</blockquote>"},{"title":"Openssl ","abbrlink":"b8bc","date":"2022-12-08T14:52:20.000Z","_content":"### \n> \n> [https://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html](https://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html)\n> [https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html](https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html)\n> [https://www.nixops.me/articles/ssl-cetificate-create-and-signed.html](https://www.nixops.me/articles/ssl-cetificate-create-and-signed.html)\n\n{% asset_img openssl-1.jpeg %}\n\n### \n#### 1 SSL \n```shell\n#  -des3\nopenssl genrsa -out a.com.key 2048\n\n\n#  csr \nopenssl genrsa -out a.com.key 2048 openssl req -new -sha256 -key a.com.key -out a.com.csr\n#  csr \nopenssl req -noout -text -in a.com.csr\n\n\n#  csr  CA  crt \n#  crt  key  web \n```\n<!--more-->\n\n#### 2/ CA \n\n- \n```shell\n#  csr \nopenssl x509 -req -days 3650 -in a.com.csr -extensions v3_ca -signkey a.com.key -out a.com.crt\n# +\nopenssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout a.com.key -out a.com.crt\n\n\n# \nopenssl req -x509 -days 3650 -new -newkey rsa:2048 -nodes -keyout a.com.key -out a.com.csr -subj \"/C=hk/ST=hk/L=hk/O=hk/OU=hk/CN=*.a.com\"\n# \nopenssl rsa -check -in a.com.key \nopenssl x509 -text -noout -in a.com.crt \n```\n\n-  CA \n```shell\n#  CA \nopenssl genrsa -out ca.key 2048\nopenssl req -x509 -sha256 -new -nodes -key ca.key -out ca.crt -days 36500 -subj \"/C=CN/ST=HK/L=HK/O=HK/OU=HK LTD/CN=a.com\"\n#  CA \nopenssl x509 -in ca.crt -text\n\n\n#  CA \nopenssl x509 -req -days 365 -sha256 -CA ca.crt -CAkey ca.key -CAcreateserial -in a.com.csr -out a.com.crt\n# \ncat ca.crt >> a.com.crt\n\n\n# \nopenssl x509 -noout -issuer -issuer_hash -in a.com.crt\n```\n\n#### 3 openssl \n```shell\n# \nopenssl genrsa -out yakir.key 2048 \nopenssl rsa -in yakir.key -text -noout\n\n# \nopenssl rsa -in yakir.key -pubout -out yakir.pub\nopenssl rsa -in yakir.pub -pubin -text -noout \n\n# \n#  1024  86 2048  214 \n# \nopenssl rsautl -encrypt -inkey yakir.pub -pubin -in file.txt -out file.bin \n# \nopenssl rsautl -decrypt -inkey yakir.key -in file.bin \n\n# \n# \nopenssl smime -encrypt -aes256 -in Large.zip -binary -outform DEM -out Encrypted.zip yakir.pub\n# \nopenssl smime -decrypt -in Encrypted.zip -binary -inform DEM -inkey yakir.key -out Large.zip \n```\n### \n#### 4\n> \n> - .DER .CER  \n> - .PEM .key  PEM \n> - .CRT \n> - .PFX .P12  PKCS12\n> - .JKS JAVA \n\n```shell\n# DER/CER/CRT  PEM\n# \nopenssl x509 -in cert.der -inform der -text -noout openssl x509 -in cert.der -inform der -outform pem -out cert.pem\n\n# PEM  DER/CER/CRT\nopenssl x509 -in cert.pem -text -noout openssl x509 -in cert.pem -outform der -out cert.der\n\n# PFX  PEM\nopenssl pkcs12 -info -nodes -in site.pfx openssl pkcs12 -in site.pfx -out site.pem -nodes\n\n# JKS  PEM\n#  JDK  keytool  openssl,  keytool  PKCS12 \nkeytool -importkeystore -srckeystore cert.jks -destkeystore cert.pkcs -srcstoretype JKS -deststoretype PKCS12\n#  openssl  pem \nopenssl pkcs12 -in cert.pkcs -out cert.pem\n```\n\n#### 5\n```shell\n# \nopenssl rsa -in cert.key -out nopass.key\n\n#  hash\nopenssl x509 -noout -hash -in cert.pem\n\n# \nopenssl s_client -connect www.baidu.com:443 -showcerts\n\n# \n# \nopenssl x509 -dates -noout -in file.pem # openssl x509 -startdate -noout -in file.pem # openssl x509 -enddate -noout -in file.pem # openssl x509 -checkend 86400 -noout -in file.pem #echo $?\n# \nopenssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2> /dev/null | openssl x509 -noout -dates\n# \nopenssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2>/dev/null |openssl x509 -enddate -noout |cut -d \"=\" -f 2\n# date \ndate --date=\"$(openssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2>/dev/null |openssl x509 -enddate -noout |cut -d \"=\" -f 2)\" --iso-8601\n\n#  SSL \n#  TLS 1.0 (tls1)TLS 1.1 (tls1_1) TLS 1.2 (tls1_2),  openssl  SSL V2 (ssl2)SSL V3 (ssl3)\nopenssl s_client -connect www.baidu.com:443 -tls1\n\n# \nopenssl s_client -connect www.baidu.com:443 -tls1_2 -cipher 'ECDHE-RSA-AES128-GCM-SHA256'\n```\n","source":"_posts/openssl-basic.md","raw":"---\ntitle: Openssl \ncategories:\n  - Operations\ntags:\n  - openssl\n  - Linux\nabbrlink: b8bc\ndate: 2022-12-08 22:52:20\n---\n### \n> \n> [https://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html](https://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html)\n> [https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html](https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html)\n> [https://www.nixops.me/articles/ssl-cetificate-create-and-signed.html](https://www.nixops.me/articles/ssl-cetificate-create-and-signed.html)\n\n{% asset_img openssl-1.jpeg %}\n\n### \n#### 1 SSL \n```shell\n#  -des3\nopenssl genrsa -out a.com.key 2048\n\n\n#  csr \nopenssl genrsa -out a.com.key 2048 openssl req -new -sha256 -key a.com.key -out a.com.csr\n#  csr \nopenssl req -noout -text -in a.com.csr\n\n\n#  csr  CA  crt \n#  crt  key  web \n```\n<!--more-->\n\n#### 2/ CA \n\n- \n```shell\n#  csr \nopenssl x509 -req -days 3650 -in a.com.csr -extensions v3_ca -signkey a.com.key -out a.com.crt\n# +\nopenssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout a.com.key -out a.com.crt\n\n\n# \nopenssl req -x509 -days 3650 -new -newkey rsa:2048 -nodes -keyout a.com.key -out a.com.csr -subj \"/C=hk/ST=hk/L=hk/O=hk/OU=hk/CN=*.a.com\"\n# \nopenssl rsa -check -in a.com.key \nopenssl x509 -text -noout -in a.com.crt \n```\n\n-  CA \n```shell\n#  CA \nopenssl genrsa -out ca.key 2048\nopenssl req -x509 -sha256 -new -nodes -key ca.key -out ca.crt -days 36500 -subj \"/C=CN/ST=HK/L=HK/O=HK/OU=HK LTD/CN=a.com\"\n#  CA \nopenssl x509 -in ca.crt -text\n\n\n#  CA \nopenssl x509 -req -days 365 -sha256 -CA ca.crt -CAkey ca.key -CAcreateserial -in a.com.csr -out a.com.crt\n# \ncat ca.crt >> a.com.crt\n\n\n# \nopenssl x509 -noout -issuer -issuer_hash -in a.com.crt\n```\n\n#### 3 openssl \n```shell\n# \nopenssl genrsa -out yakir.key 2048 \nopenssl rsa -in yakir.key -text -noout\n\n# \nopenssl rsa -in yakir.key -pubout -out yakir.pub\nopenssl rsa -in yakir.pub -pubin -text -noout \n\n# \n#  1024  86 2048  214 \n# \nopenssl rsautl -encrypt -inkey yakir.pub -pubin -in file.txt -out file.bin \n# \nopenssl rsautl -decrypt -inkey yakir.key -in file.bin \n\n# \n# \nopenssl smime -encrypt -aes256 -in Large.zip -binary -outform DEM -out Encrypted.zip yakir.pub\n# \nopenssl smime -decrypt -in Encrypted.zip -binary -inform DEM -inkey yakir.key -out Large.zip \n```\n### \n#### 4\n> \n> - .DER .CER  \n> - .PEM .key  PEM \n> - .CRT \n> - .PFX .P12  PKCS12\n> - .JKS JAVA \n\n```shell\n# DER/CER/CRT  PEM\n# \nopenssl x509 -in cert.der -inform der -text -noout openssl x509 -in cert.der -inform der -outform pem -out cert.pem\n\n# PEM  DER/CER/CRT\nopenssl x509 -in cert.pem -text -noout openssl x509 -in cert.pem -outform der -out cert.der\n\n# PFX  PEM\nopenssl pkcs12 -info -nodes -in site.pfx openssl pkcs12 -in site.pfx -out site.pem -nodes\n\n# JKS  PEM\n#  JDK  keytool  openssl,  keytool  PKCS12 \nkeytool -importkeystore -srckeystore cert.jks -destkeystore cert.pkcs -srcstoretype JKS -deststoretype PKCS12\n#  openssl  pem \nopenssl pkcs12 -in cert.pkcs -out cert.pem\n```\n\n#### 5\n```shell\n# \nopenssl rsa -in cert.key -out nopass.key\n\n#  hash\nopenssl x509 -noout -hash -in cert.pem\n\n# \nopenssl s_client -connect www.baidu.com:443 -showcerts\n\n# \n# \nopenssl x509 -dates -noout -in file.pem # openssl x509 -startdate -noout -in file.pem # openssl x509 -enddate -noout -in file.pem # openssl x509 -checkend 86400 -noout -in file.pem #echo $?\n# \nopenssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2> /dev/null | openssl x509 -noout -dates\n# \nopenssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2>/dev/null |openssl x509 -enddate -noout |cut -d \"=\" -f 2\n# date \ndate --date=\"$(openssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2>/dev/null |openssl x509 -enddate -noout |cut -d \"=\" -f 2)\" --iso-8601\n\n#  SSL \n#  TLS 1.0 (tls1)TLS 1.1 (tls1_1) TLS 1.2 (tls1_2),  openssl  SSL V2 (ssl2)SSL V3 (ssl3)\nopenssl s_client -connect www.baidu.com:443 -tls1\n\n# \nopenssl s_client -connect www.baidu.com:443 -tls1_2 -cipher 'ECDHE-RSA-AES128-GCM-SHA256'\n```\n","slug":"openssl-basic","published":1,"updated":"2024-01-21T15:28:43.160Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zq001rs0nj45ma5k69","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><br><a href=\"https://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html\">https://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html</a><br><a href=\"https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html\">https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html</a><br><a href=\"https://www.nixops.me/articles/ssl-cetificate-create-and-signed.html\">https://www.nixops.me/articles/ssl-cetificate-create-and-signed.html</a></p>\n</blockquote>\n<img data-src=\"/posts/b8bc/openssl-1.jpeg\" class>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1-SSL-\"><a href=\"#1-SSL-\" class=\"headerlink\" title=\"1 SSL \"></a>1 SSL </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> -des3</span></span><br><span class=\"line\">openssl genrsa -out a.com.key 2048</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> csr </span></span><br><span class=\"line\">openssl genrsa -out a.com.key 2048 openssl req -new -sha256 -key a.com.key -out a.com.csr</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> csr </span></span><br><span class=\"line\">openssl req -noout -text -in a.com.csr</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> csr  CA  crt </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> crt  key  web </span></span><br></pre></td></tr></table></figure>\n<span id=\"more\"></span>\n\n<h4 id=\"2-x2F--CA-\"><a href=\"#2-x2F--CA-\" class=\"headerlink\" title=\"2&#x2F; CA \"></a>2&#x2F; CA </h4><ul>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> csr </span></span><br><span class=\"line\">openssl x509 -req -days 3650 -in a.com.csr -extensions v3_ca -signkey a.com.key -out a.com.crt</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">+</span></span><br><span class=\"line\">openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout a.com.key -out a.com.crt</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl req -x509 -days 3650 -new -newkey rsa:2048 -nodes -keyout a.com.key -out a.com.csr -subj &quot;/C=hk/ST=hk/L=hk/O=hk/OU=hk/CN=*.a.com&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl rsa -check -in a.com.key </span><br><span class=\"line\">openssl x509 -text -noout -in a.com.crt </span><br></pre></td></tr></table></figure>\n</li>\n<li><p> CA </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CA </span></span><br><span class=\"line\">openssl genrsa -out ca.key 2048</span><br><span class=\"line\">openssl req -x509 -sha256 -new -nodes -key ca.key -out ca.crt -days 36500 -subj &quot;/C=CN/ST=HK/L=HK/O=HK/OU=HK LTD/CN=a.com&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CA </span></span><br><span class=\"line\">openssl x509 -in ca.crt -text</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CA </span></span><br><span class=\"line\">openssl x509 -req -days 365 -sha256 -CA ca.crt -CAkey ca.key -CAcreateserial -in a.com.csr -out a.com.crt</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat ca.crt &gt;&gt; a.com.crt</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl x509 -noout -issuer -issuer_hash -in a.com.crt</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"3-openssl-\"><a href=\"#3-openssl-\" class=\"headerlink\" title=\"3 openssl \"></a>3 openssl </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl genrsa -out yakir.key 2048 </span><br><span class=\"line\">openssl rsa -in yakir.key -text -noout</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl rsa -in yakir.key -pubout -out yakir.pub</span><br><span class=\"line\">openssl rsa -in yakir.pub -pubin -text -noout </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> 1024  86 2048  214 </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl rsautl -encrypt -inkey yakir.pub -pubin -in file.txt -out file.bin </span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl rsautl -decrypt -inkey yakir.key -in file.bin </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl smime -encrypt -aes256 -in Large.zip -binary -outform DEM -out Encrypted.zip yakir.pub</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl smime -decrypt -in Encrypted.zip -binary -inform DEM -inkey yakir.key -out Large.zip </span><br></pre></td></tr></table></figure>\n<h3 id><a href=\"#\" class=\"headerlink\" title></a></h3><h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><blockquote>\n<p></p>\n<ul>\n<li>.DER .CER  </li>\n<li>.PEM .key  PEM </li>\n<li>.CRT </li>\n<li>.PFX .P12  PKCS12</li>\n<li>.JKS JAVA </li>\n</ul>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">DER/CER/CRT  PEM</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl x509 -in cert.der -inform der -text -noout openssl x509 -in cert.der -inform der -outform pem -out cert.pem</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">PEM  DER/CER/CRT</span></span><br><span class=\"line\">openssl x509 -in cert.pem -text -noout openssl x509 -in cert.pem -outform der -out cert.der</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">PFX  PEM</span></span><br><span class=\"line\">openssl pkcs12 -info -nodes -in site.pfx openssl pkcs12 -in site.pfx -out site.pem -nodes</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">JKS  PEM</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> JDK  keytool  openssl,  keytool  PKCS12 </span></span><br><span class=\"line\">keytool -importkeystore -srckeystore cert.jks -destkeystore cert.pkcs -srcstoretype JKS -deststoretype PKCS12</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> openssl  pem </span></span><br><span class=\"line\">openssl pkcs12 -in cert.pkcs -out cert.pem</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5\"><a href=\"#5\" class=\"headerlink\" title=\"5\"></a>5</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl rsa -in cert.key -out nopass.key</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> <span class=\"built_in\">hash</span></span></span><br><span class=\"line\">openssl x509 -noout -hash -in cert.pem</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl s_client -connect www.baidu.com:443 -showcerts</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl x509 -dates -noout -in file.pem # openssl x509 -startdate -noout -in file.pem # openssl x509 -enddate -noout -in file.pem # openssl x509 -checkend 86400 -noout -in file.pem #echo $?</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2&gt; /dev/null | openssl x509 -noout -dates</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2&gt;/dev/null |openssl x509 -enddate -noout |cut -d &quot;=&quot; -f 2</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">date</span> </span></span><br><span class=\"line\">date --date=&quot;$(openssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2&gt;/dev/null |openssl x509 -enddate -noout |cut -d &quot;=&quot; -f 2)&quot; --iso-8601</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> SSL </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> TLS 1.0 (tls1)TLS 1.1 (tls1_1) TLS 1.2 (tls1_2),  openssl  SSL V2 (ssl2)SSL V3 (ssl3)</span></span><br><span class=\"line\">openssl s_client -connect www.baidu.com:443 -tls1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl s_client -connect www.baidu.com:443 -tls1_2 -cipher &#x27;ECDHE-RSA-AES128-GCM-SHA256&#x27;</span><br></pre></td></tr></table></figure>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":3719,"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><blockquote>\n<p><br><a href=\"https://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html\">https://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html</a><br><a href=\"https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html\">https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html</a><br><a href=\"https://www.nixops.me/articles/ssl-cetificate-create-and-signed.html\">https://www.nixops.me/articles/ssl-cetificate-create-and-signed.html</a></p>\n</blockquote>\n<img data-src=\"/posts/b8bc/openssl-1.jpeg\" class>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1-SSL-\"><a href=\"#1-SSL-\" class=\"headerlink\" title=\"1 SSL \"></a>1 SSL </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> -des3</span></span><br><span class=\"line\">openssl genrsa -out a.com.key 2048</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> csr </span></span><br><span class=\"line\">openssl genrsa -out a.com.key 2048 openssl req -new -sha256 -key a.com.key -out a.com.csr</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> csr </span></span><br><span class=\"line\">openssl req -noout -text -in a.com.csr</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> csr  CA  crt </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> crt  key  web </span></span><br></pre></td></tr></table></figure>","more":"<h4 id=\"2-x2F--CA-\"><a href=\"#2-x2F--CA-\" class=\"headerlink\" title=\"2&#x2F; CA \"></a>2&#x2F; CA </h4><ul>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> csr </span></span><br><span class=\"line\">openssl x509 -req -days 3650 -in a.com.csr -extensions v3_ca -signkey a.com.key -out a.com.crt</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">+</span></span><br><span class=\"line\">openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout a.com.key -out a.com.crt</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl req -x509 -days 3650 -new -newkey rsa:2048 -nodes -keyout a.com.key -out a.com.csr -subj &quot;/C=hk/ST=hk/L=hk/O=hk/OU=hk/CN=*.a.com&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl rsa -check -in a.com.key </span><br><span class=\"line\">openssl x509 -text -noout -in a.com.crt </span><br></pre></td></tr></table></figure>\n</li>\n<li><p> CA </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CA </span></span><br><span class=\"line\">openssl genrsa -out ca.key 2048</span><br><span class=\"line\">openssl req -x509 -sha256 -new -nodes -key ca.key -out ca.crt -days 36500 -subj &quot;/C=CN/ST=HK/L=HK/O=HK/OU=HK LTD/CN=a.com&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CA </span></span><br><span class=\"line\">openssl x509 -in ca.crt -text</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CA </span></span><br><span class=\"line\">openssl x509 -req -days 365 -sha256 -CA ca.crt -CAkey ca.key -CAcreateserial -in a.com.csr -out a.com.crt</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat ca.crt &gt;&gt; a.com.crt</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl x509 -noout -issuer -issuer_hash -in a.com.crt</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"3-openssl-\"><a href=\"#3-openssl-\" class=\"headerlink\" title=\"3 openssl \"></a>3 openssl </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl genrsa -out yakir.key 2048 </span><br><span class=\"line\">openssl rsa -in yakir.key -text -noout</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl rsa -in yakir.key -pubout -out yakir.pub</span><br><span class=\"line\">openssl rsa -in yakir.pub -pubin -text -noout </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> 1024  86 2048  214 </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl rsautl -encrypt -inkey yakir.pub -pubin -in file.txt -out file.bin </span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl rsautl -decrypt -inkey yakir.key -in file.bin </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl smime -encrypt -aes256 -in Large.zip -binary -outform DEM -out Encrypted.zip yakir.pub</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl smime -decrypt -in Encrypted.zip -binary -inform DEM -inkey yakir.key -out Large.zip </span><br></pre></td></tr></table></figure>\n<h3 id><a href=\"#\" class=\"headerlink\" title></a></h3><h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><blockquote>\n<p></p>\n<ul>\n<li>.DER .CER  </li>\n<li>.PEM .key  PEM </li>\n<li>.CRT </li>\n<li>.PFX .P12  PKCS12</li>\n<li>.JKS JAVA </li>\n</ul>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">DER/CER/CRT  PEM</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl x509 -in cert.der -inform der -text -noout openssl x509 -in cert.der -inform der -outform pem -out cert.pem</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">PEM  DER/CER/CRT</span></span><br><span class=\"line\">openssl x509 -in cert.pem -text -noout openssl x509 -in cert.pem -outform der -out cert.der</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">PFX  PEM</span></span><br><span class=\"line\">openssl pkcs12 -info -nodes -in site.pfx openssl pkcs12 -in site.pfx -out site.pem -nodes</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">JKS  PEM</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> JDK  keytool  openssl,  keytool  PKCS12 </span></span><br><span class=\"line\">keytool -importkeystore -srckeystore cert.jks -destkeystore cert.pkcs -srcstoretype JKS -deststoretype PKCS12</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> openssl  pem </span></span><br><span class=\"line\">openssl pkcs12 -in cert.pkcs -out cert.pem</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5\"><a href=\"#5\" class=\"headerlink\" title=\"5\"></a>5</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl rsa -in cert.key -out nopass.key</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> <span class=\"built_in\">hash</span></span></span><br><span class=\"line\">openssl x509 -noout -hash -in cert.pem</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl s_client -connect www.baidu.com:443 -showcerts</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl x509 -dates -noout -in file.pem # openssl x509 -startdate -noout -in file.pem # openssl x509 -enddate -noout -in file.pem # openssl x509 -checkend 86400 -noout -in file.pem #echo $?</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2&gt; /dev/null | openssl x509 -noout -dates</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2&gt;/dev/null |openssl x509 -enddate -noout |cut -d &quot;=&quot; -f 2</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">date</span> </span></span><br><span class=\"line\">date --date=&quot;$(openssl s_client -connect www.baidu.com:443 -servername www.baidu.com 2&gt;/dev/null |openssl x509 -enddate -noout |cut -d &quot;=&quot; -f 2)&quot; --iso-8601</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> SSL </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> TLS 1.0 (tls1)TLS 1.1 (tls1_1) TLS 1.2 (tls1_2),  openssl  SSL V2 (ssl2)SSL V3 (ssl3)</span></span><br><span class=\"line\">openssl s_client -connect www.baidu.com:443 -tls1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">openssl s_client -connect www.baidu.com:443 -tls1_2 -cipher &#x27;ECDHE-RSA-AES128-GCM-SHA256&#x27;</span><br></pre></td></tr></table></figure>"},{"title":"- Prometheus","abbrlink":"6bfb","date":"2022-06-28T14:02:38.000Z","_content":"#### \n**Prometheus Server**\n\n- \n-  Service Discovery \n-  Prometheus Server \n-  PromQL \n\n**Exporter**\n\n-  Prometheus  Endpoints node-exporter\n-  Prometheus  mysql-exporter\n\n**AlertManager**\n PromQL  mailwebhook \n\n**PushGateway**\n Prometheus Server  Exporter pull  Server  Exporter  PushGateway  \nPrometheus server  jobs  exporters  metrics Pushgateway  metrics Prometheus server  metrics\n> metrics cpu \n\n<!--more-->\n\n**Grafana**\n\n\n\n\n\n#### \n\n\n#### \n\n1.  node-export \n```shell\n# \ncat > node-exporter.yaml << \"EOF\"\nnode-exporter.yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: node-exporter\n  namespace: monitor\n  labels:\n    name: node-exporter\nspec:\n  selector:\n    matchLabels:\n     name: node-exporter\n  template:\n    metadata:\n      labels:\n        name: node-exporter\n    spec:\n      hostPID: true\n      hostIPC: true\n      hostNetwork: true\n      containers:\n      - name: node-exporter\n        image: prom/node-exporter:v0.16.0\n        ports:\n        - containerPort: 9100\n        resources:\n          requests:\n            cpu: 0.15 # 0.15cpu\n        securityContext:\n          privileged: true\t# \n        args:\n        - --path.procfs\n        - /host/proc\n        - --path.sysfs\n        - /host/sys\n        - --collector.filesystem.ignored-mount-points\n        - '\"^/(sys|proc|dev|host|etc)($|/)\"'\n        volumeMounts:\n        - name: dev\n          mountPath: /host/dev\n        - name: proc\n          mountPath: /host/proc\n        - name: sys\n          mountPath: /host/sys\n        - name: rootfs\n          mountPath: /rootfs\n      tolerations:\n      - key: \"node-role.kubernetes.io/master\"\n        operator: \"Exists\"\n        effect: \"NoSchedule\"\n      volumes:\n        - name: proc\n          hostPath:\n            path: /proc\n        - name: dev\n          hostPath:\n            path: /dev\n        - name: sys\n          hostPath:\n            path: /sys\n        - name: rootfs\n          hostPath:\n            path: /\nEOF\n\n#  namespace\nkubectl create ns monitor\n\n# \nkubectl apply -f node-exporter.yaml\nkubectl get pods -n monitor -o wide\n\n# \n#curl node_ip:9100/metrics\ncurl 192.168.49.2:9100/metrics\n```\n\n2. Prometheus Server \n```shell\n#  serviceaccount  rbac \ncat > prometheus-rbac.yaml << \"EOF\"\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: monitor-sa\n  namespace: monitor\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: monitor-sa-clusterrole\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - nodes\n  - services\n  - endpoints\n  - pods\n  - nodes/proxy\n  - nodes/metrics\n  - configmaps\n  verbs:\n  - get\n  - list\n  - watch\n- nonResourceURLs:\n  - /metrics\n  verbs:\n  - get\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: monitor-clusterrolebinding\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: monitor-sa-clusterrole\nsubjects:\n- kind: ServiceAccount\n  name: minitor-sa\n  namespace: minitor\nEOF\n\n\n#  Prometheus \n# Prometheus Server  minikube \nmkdir /data && chmod 777 /data\n\n\n#  configMap PrometheusAlertManager \ncat > prometheus-cfg.yaml << \"\"EOF\"\"\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  labels:\n    app: prometheus\n  name: prometheus-config\n  namespace: monitor\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 15s\t\t#\n      scrape_timeout: 10s\t\t\t#\n      evaluation_interval: 1m\t#\n      \n    # Prometheus  AlertManager \n    alerting:\n      alertmanagers:\n      - static_configs:\n        - targets: [\"localhost:9093\"]\n    \n    #  evaluation_interval \n    rule_files:\n    #- \"alertermanager_rules.yaml\"\n    - /etc/prometheus/rules.yaml\n      \n    scrape_configs:\t\t\t\t\t\t\t\t\t# targe target  job_name \n    - job_name: 'kubernetes-node'\n      kubernetes_sd_configs:\t\t\t\t# k8s \n      - role: node\t\t\t\t\t\t\t\t\t# node  kubelet  http  node \n      relabel_configs:\t\t\t\t\t\t\t#\n      - source_labels: [__address__]\t#\n        regex: '(.*):10250'\t\t\t\t\t\t#10250 url\n        replacement: '${1}:9100'\t\t\t# ip:9100 ip\n        target_label: __address__\t\t\t# url ${1} ip:9100\n        action: replace\t\t\t\t\t\t\t\t#\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\t#,regexinstance\n    - job_name: 'kubernetes-node-cadvisor'\t#  cAdvisor  kubelet  /metrics/cadvisor \n      kubernetes_sd_configs:\n      - role: node\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      relabel_configs:\n      - action: labelmap\t\t\t\t\t\t\t\t\t\t\t\t\t#\n        regex: __meta_kubernetes_node_label_(.+)\t#\n      - target_label: __address__\t\t\t\t\t\t\t\t\t#__address__=\"192.168.64.2:10250\"\n        replacement: kubernetes.default.svc:443\t\t#\n      - source_labels: [__meta_kubernetes_node_name]\n        regex: (.+)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t# __meta_kubernetes_node_name \n        target_label: __metrics_path__\t\t\t\t\t\t#__metrics_path__\n        replacement: /api/v1/nodes//proxy/metrics/cadvisor\n        # metrics  api/v1/nodes/k8s-master1/proxy/metrics/cadvisor\n        #${1} __meta_kubernetes_node_name \n        # url  https://kubernetes.default.svc:443/api/v1/nodes/k8s-master1/proxy/metrics/cadvisor\n    - job_name: 'kubernetes-apiserver'\n      kubernetes_sd_configs:\n      - role: endpoints\t\t\t\t# k8s  endpoint  apiserver 6443 \n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n        # endpoint ,endpoint ,endpoint \n        action: keep\t#\n        regex: default;kubernetes;https\t# service  kubernetes https  endpoint \n    - job_name: 'kubernetes-service-endpoints'\n      kubernetes_sd_configs:\n      - role: endpoints\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n        action: keep\n        regex: true\n        # \"prometheus.io/scrape: true\" annotationserviceprometheus.io/scrape = true annotationannotationregextrueregexkeep\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n        action: replace\n        target_label: __scheme__\n        regex: (https?)\n        #scheme__meta_kubernetes_service_annotation_prometheus_io_schemeprometheus.io/scheme annotationregex__scheme__\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n        action: replace\n        target_label: __metrics_path__\n        regex: (.+)\n        # path prometheus.io/path = /mymetrics\n      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]\n        action: replace\n        target_label: __address__\n        regex: ([^:]+)(?::\\d+)?;(\\d+)\n        replacement: $1:$2\n        #\n      - action: labelmap\n        regex: __meta_kubernetes_service_label_(.+)\n      - source_labels: [__meta_kubernetes_namespace]\n        action: replace\n        target_label: kubernetes_namespace\n      - source_labels: [__meta_kubernetes_service_name]\n        action: replace\n        target_label: kubernetes_name\nEOF\n\ncat > alertmanager-cfg.yaml << \"\"EOF\"\"\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: alert-config\n  namespace: monitor\ndata:\n  config.yml: |-\n    global:\n      # \n      resolve_timeout: 5m\n      # \n      smtp_smarthost: 'smtp.163.com:25'\n      smtp_from: 'xxx@163.com'\n      smtp_auth_username: 'xx@163.com'\n      smtp_auth_password: 'password'\n      smtp_hello: '163.com'\n      smtp_require_tls: false\n    # \n    route:\n      #  cluster=A  alertname=LatncyHigh \n      group_by: ['alertname', 'cluster']\n      # group_wait\n      group_wait: 30s\n\n      # 'group_interval'\n      group_interval: 5m\n\n      # 'repeat_interval'\n      repeat_interval: 5m\n\n      # receiverroute\n      receiver: default\n\n      # \n      routes:\n      - receiver: email\n        group_wait: 10s\n        match:\n          team: node\n    receivers:\n    - name: 'default'\n      email_configs:\n      - to: 'xxx@gmail.com'\n        send_resolved: true\n    - name: 'email'\n      email_configs:\n      - to: 'xxx@gmail.com'\n        send_resolved: true\nEOF\n#  configmap\nkubectl apply -f alertmanager-cfg.yaml\nkubectl apply -f prometheus-cfg.yaml\n\n\n#  Prometheus Server  AlertManager \ncat > prometheus-deployment.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: prometheus-server\n  namespace: monitor\n  labels:\n    app: prometheus\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: prometheus\n      component: server\n    #matchExpressions:\n    #- {key: app, operator: In, values: [prometheus]}\n    #- {key: component, operator: In, values: [server]}\n  template:\n    metadata:\n      labels:\n        app: prometheus\n        component: server\n      annotations:\n        prometheus.io/scrape: 'false'\n    spec:\n      serviceAccountName: monitor-sa\n      containers:\n      # Prometheus \n      - name: prometheus\n        image: prom/prometheus\n        imagePullPolicy: IfNotPresent\n        command:\n          - prometheus\n          - --config.file=/etc/prometheus/prometheus.yml\n          - --storage.tsdb.path=/prometheus\t#\n          - --storage.tsdb.retention=720h\t  #\n          - --web.enable-lifecycle\t\t\t\t\t#\n          - --web.enable-admin-api          # admin HTTP API \n        ports:\n        - containerPort: 9090\n          protocol: TCP\n        volumeMounts:\n        - mountPath: /etc/prometheus/\n          name: prometheus-config\n        - mountPath: /prometheus/\n          name: prometheus-storage-volume\n      # Prometheus \n      \n      # AlertManager \n      - name: alertmanager\n        image: prom/alertmanager\n        imagePullPolicy: IfNotPresent\n        args:\n        - --config.file=/etc/alertmanager/config.yml\n        - --storage.path=/alertmanager/data\n        ports:\n        - containerPort: 9093\n          name: http\n        volumeMounts:\n        - mountPath: /etc/alertmanager\n          name: alertcfg\n        resources:\n          requests:\n            cpu: 100m\n            memory: 256Mi\n          limits:\n            cpu: 100m\n            memory: 256Mi          \n      # AlertManager \n      volumes:\n      - name: prometheus-config\n        configMap:\n          name: prometheus-config\n      - name: prometheus-storage-volume\n        hostPath:\n         path: /data\n         type: Directory\n      - name: alertcfg\n        configMap:\n          name: alert-config\nEOF\nkubectl apply -f prometheus-deployment.yaml\n\n\n#  Service Prometheus Server \ncat > prometheus-svc.yaml << \"EOF\"\napiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus\n  namespace: monitor\n  labels:\n    app: prometheus\nspec:\n  type: NodePort\n  ports:\n    - port: 9090\n      targetPort: 9090\n      protocol: TCP\n      nodePort: 30009\n  selector:\n    app: prometheus\n    component: server\nEOF\nkubectl apply -f prometheus-svc.yaml\n#minikbube  Service \n#kubectl port-forward service/prometheus -n monitor --address 127.0.0.1 3009:9090\n```\n\n3. Alert \n- \n```shell\n#  ruls.yml  prometheus-cfg.yaml \nkind: ConfigMap\napiVersion: v1\nmetadata:\n  labels:\n    app: prometheus\n  name: prometheus-config\n  namespace: monitor\ndata:\n  prometheus.yml: |\n    ...\n  #  prometheus  /etc/prometheus \n  rules.yml: |\n    groups:\n    - name: test-rule\n      rules:\n      - alert: NodeMemoryUsage\n        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 > 20\n        for: 2m\n        labels:\n          team: node\n        annotations:\n          summary: \"{{.instance}}: High Memory usage detected\"\n          description: \"{{.instance}}: Memory usage is above 20% (current value is: {{  }}\"\n```\n\n- Prometheus \n```shell\n#  PrometheusAlertManager  Pod IP\ncurl -X POST http://172.17.0.5:9090/-/reload\ncurl -X POST http://172.17.0.5:9093/-/reload\n\n#  log\nkubectl logs --tail 10 -f prometheus-server-658b54bd7-9gvd9 -n monitor\n\n# \n#kubectl delete -f prometheus-cfg.yaml && kubectl delete -f prometheus-deployment.yaml\n#kubectl apply -f prometheus-cfg.yaml && kubectl apply -f prometheus-deployment.yaml\n```\n\n- emailwebhook\n\n4. Grafana \n```shell\ncat > grafana.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: monitoring-grafana\n  namespace: monitor\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      task: monitoring\n      k8s-app: grafana\n  template:\n    metadata:\n      labels:\n        task: monitoring\n        k8s-app: grafana\n    spec:\n      securityContext:\n        fsGroup: 472\n        runAsUser: 472\n      containers:\n      - name: grafana\n        image: grafana/grafana\n        ports:\n        - containerPort: 3000\n          protocol: TCP\n        volumeMounts:\n        - mountPath: /etc/ssl/certs\n          name: ca-certificates\n          readOnly: true\n        - mountPath: /var\n          name: grafana-storage\n        env:\n        - name: GF_SECURITY_ADMIN_USER\n          value: admin\n        - name: GF_SECURITY_ADMIN_PASSWORD\n          value: admin123\n      volumes:\n      - name: ca-certificates\n        hostPath:\n          path: /etc/ssl/certs\n      - name: grafana-storage\n        emptyDir: {}\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    kubernetes.io/cluster-service: 'true'\n    kubernetes.io/name: monitoring-grafana\n  name: monitoring-grafana\n  namespace: monitor\nspec:\n  type: NodePort\n  ports:\n  - port: 80\n    targetPort: 3000\n  selector:\n    k8s-app: grafana\nEOF\n\nkubectl apply -f grafana.yaml\nkubectl get pod,svc -n monitor\n\n\n#  Grafana\n# Prometheus \n# Kubernetes  https://grafana.com/grafana/dashboards/162/revisions\n# node node_exporter.json\n\n\n```\n\n#### Prometheus-Operator \n\n1.  prometheus-operatorcontroller\n```shell\n#  operator \ngit clone https://github.com/prometheus-operator/prometheus-operator && cd prometheus-operator\n#  CRD RBAC operator \nkubectl create -f bundle.yaml\n# \nkubectl get pod,svc -owide\nNAME                                       READY   STATUS    RESTARTS   AGE\npod/prometheus-operator-567cd8b6f6-xvhp5   1/1     Running   0          127m\nNAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nservice/prometheus-operator   ClusterIP   None             <none>        8080/TCP         127m\n#  CRD  API \nkubectl get --raw /apis/monitoring.coreos.com/v1\n```\n\n> : https://github.com/prometheus-operator/kube-prometheus, \n\n2.  prometheus serverCRD \n```shell\n#  prometheus-server \ncat > prometheus.yaml << \"EOF\"\napiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  name: prometheus\nspec:\n  serviceAccountName: prometheus\n  # ServiceMonitor\n  #ServiceMonitorSelector: {}\n  serviceMonitorSelector:\n    matchLabels:\n      team: frontend\n  resources:\n    requests:\n      memory: 200Mi\n  enableAdminAPI: false\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: default\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes\n  - services\n  - endpoints\n  - pods\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"\"]\n  resources:\n  - configmaps\n  verbs: [\"get\"]\n- nonResourceURLs: [\"/metrics\"]\n  verbs: [\"get\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus\nsubjects:\n- kind: ServiceAccount\n  name: prometheus\n  namespace: default\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus\nspec:\n  type: NodePort\n  ports:\n  - name: web\n    nodePort: 30900\n    port: 9090\n    protocol: TCP\n    targetPort: web\n  selector:\n    prometheus: prometheus\nEOF\n\n\n#  metrics \ncat > example.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: example-app\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: example-app\n  template:\n    metadata:\n      labels:\n        app: example-app\n    spec:\n      containers:\n      - name: example-app\n        image: zhangguanzhang/instrumented_app\n        ports:\n        - name: web\n          containerPort: 8080\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: example-app\n  labels:\n    app: example-app\nspec:\n  selector:\n    app: example-app\n  ports:\n  - name: web\n    port: 8080\nEOF\n```\n\n3.  ServiceMonitor CRD \n```shell\n#  ServiceMonitor\ncat > service-monitor.yaml << \"EOF\"\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: example-app\n  labels:\n    team: frontend\nspec:\n  #namespaceSelector:\n  #1.namespacens\n  #  matchNames:\n  #  - target_namespace_name\n  #2.ns\n  #  any:true\n  selector:\n    matchLabels:\n      app: example-app\n  endpoints:\n  - port: web\n  #BasicAuth(base64)\n  #- basicAuth:\n  #    password:\n  #      name: basic-auth\n  #      key: password\n  #    username:\n  #      name: basic-auth\n  #      key: user\n  #  port: web\nEOF\n```\n\n4. \n```shell\n# \nNAME                                       READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES\npod/example-app-745967cc67-qbh45           1/1     Running   0          95m    172.17.0.7   minikube   <none>           <none>\npod/prometheus-operator-567cd8b6f6-xvhp5   1/1     Running   0          139m   172.17.0.6   minikube   <none>           <none>\npod/prometheus-prometheus-0                2/2     Running   0          108m   172.17.0.3   minikube   <none>           <none>\n\nNAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE    SELECTOR\nservice/example-app           ClusterIP   10.100.248.130   <none>        8080/TCP         104m   app=example-app\nservice/kubernetes            ClusterIP   10.96.0.1        <none>        443/TCP          24d    <none>\nservice/prometheus            NodePort    10.101.76.214    <none>        9090:30900/TCP   28m    prometheus=prometheus\nservice/prometheus-operated   ClusterIP   None             <none>        9090/TCP         108m   app.kubernetes.io/name=prometheus\nservice/prometheus-operator   ClusterIP   None             <none>        8080/TCP         139m   app.kubernetes.io/component=controller,app.kubernetes.io/name=prometheus-operator\n\n# \n#minikube  \n#kubectl port-forward service/prometheus --address 127.0.0.1 9090:9090\n# 127.0.0.1:9090/targets\n```\n\n5. Etcdcontroller-manager \n-  Etcd\n```shell\n#1 etcd  secret\n#2 prometheus StatefulSet  secret\nkubectl get statefulsets -n monitoring\nNAME                READY   AGE\nalertmanager-main   3/3     3h25m\nprometheus-k8s      1/1     3h25m\n#3 ServiceMonitor \n#4 ServiceEndpoints \n```\n\n6.  AlertManagerPrometheusRule \n- AlertManager Prometheus Dashboard  Config \n```shell\nalerting:\n  alert_relabel_configs:\n  - separator: ;\n    regex: prometheus_replica\n    replacement: $1\n    action: labeldrop\n  alertmanagers:\n  - kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n        - monitoring\n    scheme: http\n    path_prefix: /\n    timeout: 10s\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_name]\n      separator: ;\n      regex: alertmanager-main\n      replacement: $1\n      action: keep\n    - source_labels: [__meta_kubernetes_endpoint_port_name]\n      separator: ;\n      regex: web\n      replacement: $1\n      action: keep\nrule_files:\n- /etc/prometheus/rules/prometheus-k8s-rulefiles-0/*.yaml\n```\n\n- \n```shell\n# Prometheus Rule\ncat > prometheus-rules.yaml << \"EOF\"\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: prometheus-k8s-rules\nspec:\n  groups:\n  - name: k8s.rules\n    rules:\n    - expr: |\n        sum(rate(container_cpu_usage_seconds_total{job=\"kubelet\", image!=\"\", container_name!=\"\"}[5m])) by (namespace)\n      record: namespace:container_cpu_usage_seconds_total:sum_rate\nEOF\n#  rule  prometheus  /etc/prometheus/rules/prometheus-k8s-rulefiles-0/ \n```\n\n- AlertManager  secret\n\n7. \n- annotations\n\nprometheus.io/scrape=true\nprometheus.io/port=xxx\n\n- PVPVC\n\n\n> Operator  CRD \n> - Prometheus\n> - ServiceMonitor\n> - PodMonitor\n> - AltertManager\n> - PrometheusRule\n\n\n> \n> 1[https://www.servicemesher.com/blog/prometheus-operator-manual/](https://www.servicemesher.com/blog/prometheus-operator-manual/)\n> 2[https://www.qikqiak.com/k8s-book/docs/52.Prometheus%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html](https://www.qikqiak.com/k8s-book/docs/52.Prometheus%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html)\n> \n> 1[https://github.com/prometheus-operator/prometheus-operator](https://github.com/prometheus-operator/prometheus-operator)\n> 2[https://github.com/prometheus-operator/kube-prometheus](https://github.com/prometheus-operator/kube-prometheus)\n> 3[https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/prometheus-alert-rule](https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/prometheus-alert-rule)\n\n\n","source":"_posts/observability-prometheus-component.md","raw":"---\ntitle: - Prometheus\ncategories:\n  - CNCF\ntags:\n  - Observability\nabbrlink: 6bfb\ndate: 2022-06-28 22:02:38\n---\n#### \n**Prometheus Server**\n\n- \n-  Service Discovery \n-  Prometheus Server \n-  PromQL \n\n**Exporter**\n\n-  Prometheus  Endpoints node-exporter\n-  Prometheus  mysql-exporter\n\n**AlertManager**\n PromQL  mailwebhook \n\n**PushGateway**\n Prometheus Server  Exporter pull  Server  Exporter  PushGateway  \nPrometheus server  jobs  exporters  metrics Pushgateway  metrics Prometheus server  metrics\n> metrics cpu \n\n<!--more-->\n\n**Grafana**\n\n\n\n\n\n#### \n\n\n#### \n\n1.  node-export \n```shell\n# \ncat > node-exporter.yaml << \"EOF\"\nnode-exporter.yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: node-exporter\n  namespace: monitor\n  labels:\n    name: node-exporter\nspec:\n  selector:\n    matchLabels:\n     name: node-exporter\n  template:\n    metadata:\n      labels:\n        name: node-exporter\n    spec:\n      hostPID: true\n      hostIPC: true\n      hostNetwork: true\n      containers:\n      - name: node-exporter\n        image: prom/node-exporter:v0.16.0\n        ports:\n        - containerPort: 9100\n        resources:\n          requests:\n            cpu: 0.15 # 0.15cpu\n        securityContext:\n          privileged: true\t# \n        args:\n        - --path.procfs\n        - /host/proc\n        - --path.sysfs\n        - /host/sys\n        - --collector.filesystem.ignored-mount-points\n        - '\"^/(sys|proc|dev|host|etc)($|/)\"'\n        volumeMounts:\n        - name: dev\n          mountPath: /host/dev\n        - name: proc\n          mountPath: /host/proc\n        - name: sys\n          mountPath: /host/sys\n        - name: rootfs\n          mountPath: /rootfs\n      tolerations:\n      - key: \"node-role.kubernetes.io/master\"\n        operator: \"Exists\"\n        effect: \"NoSchedule\"\n      volumes:\n        - name: proc\n          hostPath:\n            path: /proc\n        - name: dev\n          hostPath:\n            path: /dev\n        - name: sys\n          hostPath:\n            path: /sys\n        - name: rootfs\n          hostPath:\n            path: /\nEOF\n\n#  namespace\nkubectl create ns monitor\n\n# \nkubectl apply -f node-exporter.yaml\nkubectl get pods -n monitor -o wide\n\n# \n#curl node_ip:9100/metrics\ncurl 192.168.49.2:9100/metrics\n```\n\n2. Prometheus Server \n```shell\n#  serviceaccount  rbac \ncat > prometheus-rbac.yaml << \"EOF\"\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: monitor-sa\n  namespace: monitor\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: monitor-sa-clusterrole\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - nodes\n  - services\n  - endpoints\n  - pods\n  - nodes/proxy\n  - nodes/metrics\n  - configmaps\n  verbs:\n  - get\n  - list\n  - watch\n- nonResourceURLs:\n  - /metrics\n  verbs:\n  - get\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: monitor-clusterrolebinding\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: monitor-sa-clusterrole\nsubjects:\n- kind: ServiceAccount\n  name: minitor-sa\n  namespace: minitor\nEOF\n\n\n#  Prometheus \n# Prometheus Server  minikube \nmkdir /data && chmod 777 /data\n\n\n#  configMap PrometheusAlertManager \ncat > prometheus-cfg.yaml << \"\"EOF\"\"\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  labels:\n    app: prometheus\n  name: prometheus-config\n  namespace: monitor\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 15s\t\t#\n      scrape_timeout: 10s\t\t\t#\n      evaluation_interval: 1m\t#\n      \n    # Prometheus  AlertManager \n    alerting:\n      alertmanagers:\n      - static_configs:\n        - targets: [\"localhost:9093\"]\n    \n    #  evaluation_interval \n    rule_files:\n    #- \"alertermanager_rules.yaml\"\n    - /etc/prometheus/rules.yaml\n      \n    scrape_configs:\t\t\t\t\t\t\t\t\t# targe target  job_name \n    - job_name: 'kubernetes-node'\n      kubernetes_sd_configs:\t\t\t\t# k8s \n      - role: node\t\t\t\t\t\t\t\t\t# node  kubelet  http  node \n      relabel_configs:\t\t\t\t\t\t\t#\n      - source_labels: [__address__]\t#\n        regex: '(.*):10250'\t\t\t\t\t\t#10250 url\n        replacement: '${1}:9100'\t\t\t# ip:9100 ip\n        target_label: __address__\t\t\t# url ${1} ip:9100\n        action: replace\t\t\t\t\t\t\t\t#\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\t#,regexinstance\n    - job_name: 'kubernetes-node-cadvisor'\t#  cAdvisor  kubelet  /metrics/cadvisor \n      kubernetes_sd_configs:\n      - role: node\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      relabel_configs:\n      - action: labelmap\t\t\t\t\t\t\t\t\t\t\t\t\t#\n        regex: __meta_kubernetes_node_label_(.+)\t#\n      - target_label: __address__\t\t\t\t\t\t\t\t\t#__address__=\"192.168.64.2:10250\"\n        replacement: kubernetes.default.svc:443\t\t#\n      - source_labels: [__meta_kubernetes_node_name]\n        regex: (.+)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t# __meta_kubernetes_node_name \n        target_label: __metrics_path__\t\t\t\t\t\t#__metrics_path__\n        replacement: /api/v1/nodes//proxy/metrics/cadvisor\n        # metrics  api/v1/nodes/k8s-master1/proxy/metrics/cadvisor\n        #${1} __meta_kubernetes_node_name \n        # url  https://kubernetes.default.svc:443/api/v1/nodes/k8s-master1/proxy/metrics/cadvisor\n    - job_name: 'kubernetes-apiserver'\n      kubernetes_sd_configs:\n      - role: endpoints\t\t\t\t# k8s  endpoint  apiserver 6443 \n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n        # endpoint ,endpoint ,endpoint \n        action: keep\t#\n        regex: default;kubernetes;https\t# service  kubernetes https  endpoint \n    - job_name: 'kubernetes-service-endpoints'\n      kubernetes_sd_configs:\n      - role: endpoints\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n        action: keep\n        regex: true\n        # \"prometheus.io/scrape: true\" annotationserviceprometheus.io/scrape = true annotationannotationregextrueregexkeep\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n        action: replace\n        target_label: __scheme__\n        regex: (https?)\n        #scheme__meta_kubernetes_service_annotation_prometheus_io_schemeprometheus.io/scheme annotationregex__scheme__\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n        action: replace\n        target_label: __metrics_path__\n        regex: (.+)\n        # path prometheus.io/path = /mymetrics\n      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]\n        action: replace\n        target_label: __address__\n        regex: ([^:]+)(?::\\d+)?;(\\d+)\n        replacement: $1:$2\n        #\n      - action: labelmap\n        regex: __meta_kubernetes_service_label_(.+)\n      - source_labels: [__meta_kubernetes_namespace]\n        action: replace\n        target_label: kubernetes_namespace\n      - source_labels: [__meta_kubernetes_service_name]\n        action: replace\n        target_label: kubernetes_name\nEOF\n\ncat > alertmanager-cfg.yaml << \"\"EOF\"\"\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: alert-config\n  namespace: monitor\ndata:\n  config.yml: |-\n    global:\n      # \n      resolve_timeout: 5m\n      # \n      smtp_smarthost: 'smtp.163.com:25'\n      smtp_from: 'xxx@163.com'\n      smtp_auth_username: 'xx@163.com'\n      smtp_auth_password: 'password'\n      smtp_hello: '163.com'\n      smtp_require_tls: false\n    # \n    route:\n      #  cluster=A  alertname=LatncyHigh \n      group_by: ['alertname', 'cluster']\n      # group_wait\n      group_wait: 30s\n\n      # 'group_interval'\n      group_interval: 5m\n\n      # 'repeat_interval'\n      repeat_interval: 5m\n\n      # receiverroute\n      receiver: default\n\n      # \n      routes:\n      - receiver: email\n        group_wait: 10s\n        match:\n          team: node\n    receivers:\n    - name: 'default'\n      email_configs:\n      - to: 'xxx@gmail.com'\n        send_resolved: true\n    - name: 'email'\n      email_configs:\n      - to: 'xxx@gmail.com'\n        send_resolved: true\nEOF\n#  configmap\nkubectl apply -f alertmanager-cfg.yaml\nkubectl apply -f prometheus-cfg.yaml\n\n\n#  Prometheus Server  AlertManager \ncat > prometheus-deployment.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: prometheus-server\n  namespace: monitor\n  labels:\n    app: prometheus\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: prometheus\n      component: server\n    #matchExpressions:\n    #- {key: app, operator: In, values: [prometheus]}\n    #- {key: component, operator: In, values: [server]}\n  template:\n    metadata:\n      labels:\n        app: prometheus\n        component: server\n      annotations:\n        prometheus.io/scrape: 'false'\n    spec:\n      serviceAccountName: monitor-sa\n      containers:\n      # Prometheus \n      - name: prometheus\n        image: prom/prometheus\n        imagePullPolicy: IfNotPresent\n        command:\n          - prometheus\n          - --config.file=/etc/prometheus/prometheus.yml\n          - --storage.tsdb.path=/prometheus\t#\n          - --storage.tsdb.retention=720h\t  #\n          - --web.enable-lifecycle\t\t\t\t\t#\n          - --web.enable-admin-api          # admin HTTP API \n        ports:\n        - containerPort: 9090\n          protocol: TCP\n        volumeMounts:\n        - mountPath: /etc/prometheus/\n          name: prometheus-config\n        - mountPath: /prometheus/\n          name: prometheus-storage-volume\n      # Prometheus \n      \n      # AlertManager \n      - name: alertmanager\n        image: prom/alertmanager\n        imagePullPolicy: IfNotPresent\n        args:\n        - --config.file=/etc/alertmanager/config.yml\n        - --storage.path=/alertmanager/data\n        ports:\n        - containerPort: 9093\n          name: http\n        volumeMounts:\n        - mountPath: /etc/alertmanager\n          name: alertcfg\n        resources:\n          requests:\n            cpu: 100m\n            memory: 256Mi\n          limits:\n            cpu: 100m\n            memory: 256Mi          \n      # AlertManager \n      volumes:\n      - name: prometheus-config\n        configMap:\n          name: prometheus-config\n      - name: prometheus-storage-volume\n        hostPath:\n         path: /data\n         type: Directory\n      - name: alertcfg\n        configMap:\n          name: alert-config\nEOF\nkubectl apply -f prometheus-deployment.yaml\n\n\n#  Service Prometheus Server \ncat > prometheus-svc.yaml << \"EOF\"\napiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus\n  namespace: monitor\n  labels:\n    app: prometheus\nspec:\n  type: NodePort\n  ports:\n    - port: 9090\n      targetPort: 9090\n      protocol: TCP\n      nodePort: 30009\n  selector:\n    app: prometheus\n    component: server\nEOF\nkubectl apply -f prometheus-svc.yaml\n#minikbube  Service \n#kubectl port-forward service/prometheus -n monitor --address 127.0.0.1 3009:9090\n```\n\n3. Alert \n- \n```shell\n#  ruls.yml  prometheus-cfg.yaml \nkind: ConfigMap\napiVersion: v1\nmetadata:\n  labels:\n    app: prometheus\n  name: prometheus-config\n  namespace: monitor\ndata:\n  prometheus.yml: |\n    ...\n  #  prometheus  /etc/prometheus \n  rules.yml: |\n    groups:\n    - name: test-rule\n      rules:\n      - alert: NodeMemoryUsage\n        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 > 20\n        for: 2m\n        labels:\n          team: node\n        annotations:\n          summary: \"{{.instance}}: High Memory usage detected\"\n          description: \"{{.instance}}: Memory usage is above 20% (current value is: {{  }}\"\n```\n\n- Prometheus \n```shell\n#  PrometheusAlertManager  Pod IP\ncurl -X POST http://172.17.0.5:9090/-/reload\ncurl -X POST http://172.17.0.5:9093/-/reload\n\n#  log\nkubectl logs --tail 10 -f prometheus-server-658b54bd7-9gvd9 -n monitor\n\n# \n#kubectl delete -f prometheus-cfg.yaml && kubectl delete -f prometheus-deployment.yaml\n#kubectl apply -f prometheus-cfg.yaml && kubectl apply -f prometheus-deployment.yaml\n```\n\n- emailwebhook\n\n4. Grafana \n```shell\ncat > grafana.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: monitoring-grafana\n  namespace: monitor\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      task: monitoring\n      k8s-app: grafana\n  template:\n    metadata:\n      labels:\n        task: monitoring\n        k8s-app: grafana\n    spec:\n      securityContext:\n        fsGroup: 472\n        runAsUser: 472\n      containers:\n      - name: grafana\n        image: grafana/grafana\n        ports:\n        - containerPort: 3000\n          protocol: TCP\n        volumeMounts:\n        - mountPath: /etc/ssl/certs\n          name: ca-certificates\n          readOnly: true\n        - mountPath: /var\n          name: grafana-storage\n        env:\n        - name: GF_SECURITY_ADMIN_USER\n          value: admin\n        - name: GF_SECURITY_ADMIN_PASSWORD\n          value: admin123\n      volumes:\n      - name: ca-certificates\n        hostPath:\n          path: /etc/ssl/certs\n      - name: grafana-storage\n        emptyDir: {}\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    kubernetes.io/cluster-service: 'true'\n    kubernetes.io/name: monitoring-grafana\n  name: monitoring-grafana\n  namespace: monitor\nspec:\n  type: NodePort\n  ports:\n  - port: 80\n    targetPort: 3000\n  selector:\n    k8s-app: grafana\nEOF\n\nkubectl apply -f grafana.yaml\nkubectl get pod,svc -n monitor\n\n\n#  Grafana\n# Prometheus \n# Kubernetes  https://grafana.com/grafana/dashboards/162/revisions\n# node node_exporter.json\n\n\n```\n\n#### Prometheus-Operator \n\n1.  prometheus-operatorcontroller\n```shell\n#  operator \ngit clone https://github.com/prometheus-operator/prometheus-operator && cd prometheus-operator\n#  CRD RBAC operator \nkubectl create -f bundle.yaml\n# \nkubectl get pod,svc -owide\nNAME                                       READY   STATUS    RESTARTS   AGE\npod/prometheus-operator-567cd8b6f6-xvhp5   1/1     Running   0          127m\nNAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nservice/prometheus-operator   ClusterIP   None             <none>        8080/TCP         127m\n#  CRD  API \nkubectl get --raw /apis/monitoring.coreos.com/v1\n```\n\n> : https://github.com/prometheus-operator/kube-prometheus, \n\n2.  prometheus serverCRD \n```shell\n#  prometheus-server \ncat > prometheus.yaml << \"EOF\"\napiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  name: prometheus\nspec:\n  serviceAccountName: prometheus\n  # ServiceMonitor\n  #ServiceMonitorSelector: {}\n  serviceMonitorSelector:\n    matchLabels:\n      team: frontend\n  resources:\n    requests:\n      memory: 200Mi\n  enableAdminAPI: false\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: default\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes\n  - services\n  - endpoints\n  - pods\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"\"]\n  resources:\n  - configmaps\n  verbs: [\"get\"]\n- nonResourceURLs: [\"/metrics\"]\n  verbs: [\"get\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus\nsubjects:\n- kind: ServiceAccount\n  name: prometheus\n  namespace: default\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus\nspec:\n  type: NodePort\n  ports:\n  - name: web\n    nodePort: 30900\n    port: 9090\n    protocol: TCP\n    targetPort: web\n  selector:\n    prometheus: prometheus\nEOF\n\n\n#  metrics \ncat > example.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: example-app\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: example-app\n  template:\n    metadata:\n      labels:\n        app: example-app\n    spec:\n      containers:\n      - name: example-app\n        image: zhangguanzhang/instrumented_app\n        ports:\n        - name: web\n          containerPort: 8080\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: example-app\n  labels:\n    app: example-app\nspec:\n  selector:\n    app: example-app\n  ports:\n  - name: web\n    port: 8080\nEOF\n```\n\n3.  ServiceMonitor CRD \n```shell\n#  ServiceMonitor\ncat > service-monitor.yaml << \"EOF\"\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: example-app\n  labels:\n    team: frontend\nspec:\n  #namespaceSelector:\n  #1.namespacens\n  #  matchNames:\n  #  - target_namespace_name\n  #2.ns\n  #  any:true\n  selector:\n    matchLabels:\n      app: example-app\n  endpoints:\n  - port: web\n  #BasicAuth(base64)\n  #- basicAuth:\n  #    password:\n  #      name: basic-auth\n  #      key: password\n  #    username:\n  #      name: basic-auth\n  #      key: user\n  #  port: web\nEOF\n```\n\n4. \n```shell\n# \nNAME                                       READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES\npod/example-app-745967cc67-qbh45           1/1     Running   0          95m    172.17.0.7   minikube   <none>           <none>\npod/prometheus-operator-567cd8b6f6-xvhp5   1/1     Running   0          139m   172.17.0.6   minikube   <none>           <none>\npod/prometheus-prometheus-0                2/2     Running   0          108m   172.17.0.3   minikube   <none>           <none>\n\nNAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE    SELECTOR\nservice/example-app           ClusterIP   10.100.248.130   <none>        8080/TCP         104m   app=example-app\nservice/kubernetes            ClusterIP   10.96.0.1        <none>        443/TCP          24d    <none>\nservice/prometheus            NodePort    10.101.76.214    <none>        9090:30900/TCP   28m    prometheus=prometheus\nservice/prometheus-operated   ClusterIP   None             <none>        9090/TCP         108m   app.kubernetes.io/name=prometheus\nservice/prometheus-operator   ClusterIP   None             <none>        8080/TCP         139m   app.kubernetes.io/component=controller,app.kubernetes.io/name=prometheus-operator\n\n# \n#minikube  \n#kubectl port-forward service/prometheus --address 127.0.0.1 9090:9090\n# 127.0.0.1:9090/targets\n```\n\n5. Etcdcontroller-manager \n-  Etcd\n```shell\n#1 etcd  secret\n#2 prometheus StatefulSet  secret\nkubectl get statefulsets -n monitoring\nNAME                READY   AGE\nalertmanager-main   3/3     3h25m\nprometheus-k8s      1/1     3h25m\n#3 ServiceMonitor \n#4 ServiceEndpoints \n```\n\n6.  AlertManagerPrometheusRule \n- AlertManager Prometheus Dashboard  Config \n```shell\nalerting:\n  alert_relabel_configs:\n  - separator: ;\n    regex: prometheus_replica\n    replacement: $1\n    action: labeldrop\n  alertmanagers:\n  - kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n        - monitoring\n    scheme: http\n    path_prefix: /\n    timeout: 10s\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_name]\n      separator: ;\n      regex: alertmanager-main\n      replacement: $1\n      action: keep\n    - source_labels: [__meta_kubernetes_endpoint_port_name]\n      separator: ;\n      regex: web\n      replacement: $1\n      action: keep\nrule_files:\n- /etc/prometheus/rules/prometheus-k8s-rulefiles-0/*.yaml\n```\n\n- \n```shell\n# Prometheus Rule\ncat > prometheus-rules.yaml << \"EOF\"\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: prometheus-k8s-rules\nspec:\n  groups:\n  - name: k8s.rules\n    rules:\n    - expr: |\n        sum(rate(container_cpu_usage_seconds_total{job=\"kubelet\", image!=\"\", container_name!=\"\"}[5m])) by (namespace)\n      record: namespace:container_cpu_usage_seconds_total:sum_rate\nEOF\n#  rule  prometheus  /etc/prometheus/rules/prometheus-k8s-rulefiles-0/ \n```\n\n- AlertManager  secret\n\n7. \n- annotations\n\nprometheus.io/scrape=true\nprometheus.io/port=xxx\n\n- PVPVC\n\n\n> Operator  CRD \n> - Prometheus\n> - ServiceMonitor\n> - PodMonitor\n> - AltertManager\n> - PrometheusRule\n\n\n> \n> 1[https://www.servicemesher.com/blog/prometheus-operator-manual/](https://www.servicemesher.com/blog/prometheus-operator-manual/)\n> 2[https://www.qikqiak.com/k8s-book/docs/52.Prometheus%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html](https://www.qikqiak.com/k8s-book/docs/52.Prometheus%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html)\n> \n> 1[https://github.com/prometheus-operator/prometheus-operator](https://github.com/prometheus-operator/prometheus-operator)\n> 2[https://github.com/prometheus-operator/kube-prometheus](https://github.com/prometheus-operator/kube-prometheus)\n> 3[https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/prometheus-alert-rule](https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/prometheus-alert-rule)\n\n\n","slug":"observability-prometheus-component","published":1,"updated":"2024-01-21T15:28:43.159Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zq001vs0nj7ppme6tb","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong>Prometheus Server</strong></p>\n<ul>\n<li></li>\n<li> Service Discovery </li>\n<li> Prometheus Server </li>\n<li> PromQL </li>\n</ul>\n<p><strong>Exporter</strong></p>\n<ul>\n<li> Prometheus  Endpoints node-exporter</li>\n<li> Prometheus  mysql-exporter</li>\n</ul>\n<p><strong>AlertManager</strong><br> PromQL  mailwebhook </p>\n<p><strong>PushGateway</strong><br> Prometheus Server  Exporter pull  Server  Exporter  PushGateway <br>Prometheus server  jobs  exporters  metrics Pushgateway  metrics Prometheus server  metrics</p>\n<blockquote>\n<p>metrics cpu </p>\n</blockquote>\n<span id=\"more\"></span>\n\n<p><strong>Grafana</strong><br><br><br><br></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ol>\n<li><p> node-export </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat &gt; node-exporter.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">node-exporter.yaml</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: DaemonSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: node-exporter</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: node-exporter</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">     name: node-exporter</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        name: node-exporter</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      hostPID: true</span><br><span class=\"line\">      hostIPC: true</span><br><span class=\"line\">      hostNetwork: true</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: node-exporter</span><br><span class=\"line\">        image: prom/node-exporter:v0.16.0</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9100</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 0.15 # 0.15cpu</span><br><span class=\"line\">        securityContext:</span><br><span class=\"line\">          privileged: true\t# </span><br><span class=\"line\">        args:</span><br><span class=\"line\">        - --path.procfs</span><br><span class=\"line\">        - /host/proc</span><br><span class=\"line\">        - --path.sysfs</span><br><span class=\"line\">        - /host/sys</span><br><span class=\"line\">        - --collector.filesystem.ignored-mount-points</span><br><span class=\"line\">        - &#x27;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#x27;</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: dev</span><br><span class=\"line\">          mountPath: /host/dev</span><br><span class=\"line\">        - name: proc</span><br><span class=\"line\">          mountPath: /host/proc</span><br><span class=\"line\">        - name: sys</span><br><span class=\"line\">          mountPath: /host/sys</span><br><span class=\"line\">        - name: rootfs</span><br><span class=\"line\">          mountPath: /rootfs</span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - key: &quot;node-role.kubernetes.io/master&quot;</span><br><span class=\"line\">        operator: &quot;Exists&quot;</span><br><span class=\"line\">        effect: &quot;NoSchedule&quot;</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: proc</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /proc</span><br><span class=\"line\">        - name: dev</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /dev</span><br><span class=\"line\">        - name: sys</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /sys</span><br><span class=\"line\">        - name: rootfs</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> namespace</span></span><br><span class=\"line\">kubectl create ns monitor</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl apply -f node-exporter.yaml</span><br><span class=\"line\">kubectl get pods -n monitor -o wide</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">curl node_ip:9100/metrics</span></span><br><span class=\"line\">curl 192.168.49.2:9100/metrics</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Prometheus Server </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> serviceaccount  rbac </span></span><br><span class=\"line\">cat &gt; prometheus-rbac.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: monitor-sa</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: monitor-sa-clusterrole</span><br><span class=\"line\">rules:</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - &quot;&quot;</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - nodes</span><br><span class=\"line\">  - services</span><br><span class=\"line\">  - endpoints</span><br><span class=\"line\">  - pods</span><br><span class=\"line\">  - nodes/proxy</span><br><span class=\"line\">  - nodes/metrics</span><br><span class=\"line\">  - configmaps</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - get</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- nonResourceURLs:</span><br><span class=\"line\">  - /metrics</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - get</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: monitor-clusterrolebinding</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: monitor-sa-clusterrole</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: minitor-sa</span><br><span class=\"line\">  namespace: minitor</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Prometheus </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Prometheus Server  minikube </span></span><br><span class=\"line\">mkdir /data &amp;&amp; chmod 777 /data</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> configMap PrometheusAlertManager </span></span><br><span class=\"line\">cat &gt; prometheus-cfg.yaml &lt;&lt; &quot;&quot;EOF&quot;&quot;</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">  name: prometheus-config</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">data:</span><br><span class=\"line\">  prometheus.yml: |</span><br><span class=\"line\">    global:</span><br><span class=\"line\">      scrape_interval: 15s\t\t#</span><br><span class=\"line\">      scrape_timeout: 10s\t\t\t#</span><br><span class=\"line\">      evaluation_interval: 1m\t#</span><br><span class=\"line\">      </span><br><span class=\"line\">    # Prometheus  AlertManager </span><br><span class=\"line\">    alerting:</span><br><span class=\"line\">      alertmanagers:</span><br><span class=\"line\">      - static_configs:</span><br><span class=\"line\">        - targets: [&quot;localhost:9093&quot;]</span><br><span class=\"line\">    </span><br><span class=\"line\">    #  evaluation_interval </span><br><span class=\"line\">    rule_files:</span><br><span class=\"line\">    #- &quot;alertermanager_rules.yaml&quot;</span><br><span class=\"line\">    - /etc/prometheus/rules.yaml</span><br><span class=\"line\">      </span><br><span class=\"line\">    scrape_configs:\t\t\t\t\t\t\t\t\t# targe target  job_name </span><br><span class=\"line\">    - job_name: &#x27;kubernetes-node&#x27;</span><br><span class=\"line\">      kubernetes_sd_configs:\t\t\t\t# k8s </span><br><span class=\"line\">      - role: node\t\t\t\t\t\t\t\t\t# node  kubelet  http  node </span><br><span class=\"line\">      relabel_configs:\t\t\t\t\t\t\t#</span><br><span class=\"line\">      - source_labels: [__address__]\t#</span><br><span class=\"line\">        regex: &#x27;(.*):10250&#x27;\t\t\t\t\t\t#10250 url</span><br><span class=\"line\">        replacement: &#x27;$&#123;1&#125;:9100&#x27;\t\t\t# ip:9100 ip</span><br><span class=\"line\">        target_label: __address__\t\t\t# url $&#123;1&#125; ip:9100</span><br><span class=\"line\">        action: replace\t\t\t\t\t\t\t\t#</span><br><span class=\"line\">      - action: labelmap</span><br><span class=\"line\">        regex: __meta_kubernetes_node_label_(.+)\t#,regexinstance</span><br><span class=\"line\">    - job_name: &#x27;kubernetes-node-cadvisor&#x27;\t#  cAdvisor  kubelet  /metrics/cadvisor </span><br><span class=\"line\">      kubernetes_sd_configs:</span><br><span class=\"line\">      - role: node</span><br><span class=\"line\">      scheme: https</span><br><span class=\"line\">      tls_config:</span><br><span class=\"line\">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">      relabel_configs:</span><br><span class=\"line\">      - action: labelmap\t\t\t\t\t\t\t\t\t\t\t\t\t#</span><br><span class=\"line\">        regex: __meta_kubernetes_node_label_(.+)\t#</span><br><span class=\"line\">      - target_label: __address__\t\t\t\t\t\t\t\t\t#__address__=&quot;192.168.64.2:10250&quot;</span><br><span class=\"line\">        replacement: kubernetes.default.svc:443\t\t#</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class=\"line\">        regex: (.+)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t# __meta_kubernetes_node_name </span><br><span class=\"line\">        target_label: __metrics_path__\t\t\t\t\t\t#__metrics_path__</span><br><span class=\"line\">        replacement: /api/v1/nodes//proxy/metrics/cadvisor</span><br><span class=\"line\">        # metrics  api/v1/nodes/k8s-master1/proxy/metrics/cadvisor</span><br><span class=\"line\">        #$&#123;1&#125; __meta_kubernetes_node_name </span><br><span class=\"line\">        # url  https://kubernetes.default.svc:443/api/v1/nodes/k8s-master1/proxy/metrics/cadvisor</span><br><span class=\"line\">    - job_name: &#x27;kubernetes-apiserver&#x27;</span><br><span class=\"line\">      kubernetes_sd_configs:</span><br><span class=\"line\">      - role: endpoints\t\t\t\t# k8s  endpoint  apiserver 6443 </span><br><span class=\"line\">      scheme: https</span><br><span class=\"line\">      tls_config:</span><br><span class=\"line\">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">      relabel_configs:</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class=\"line\">        # endpoint ,endpoint ,endpoint </span><br><span class=\"line\">        action: keep\t#</span><br><span class=\"line\">        regex: default;kubernetes;https\t# service  kubernetes https  endpoint </span><br><span class=\"line\">    - job_name: &#x27;kubernetes-service-endpoints&#x27;</span><br><span class=\"line\">      kubernetes_sd_configs:</span><br><span class=\"line\">      - role: endpoints</span><br><span class=\"line\">      relabel_configs:</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><br><span class=\"line\">        action: keep</span><br><span class=\"line\">        regex: true</span><br><span class=\"line\">        # &quot;prometheus.io/scrape: true&quot; annotationserviceprometheus.io/scrape = true annotationannotationregextrueregexkeep</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class=\"line\">        action: replace</span><br><span class=\"line\">        target_label: __scheme__</span><br><span class=\"line\">        regex: (https?)</span><br><span class=\"line\">        #scheme__meta_kubernetes_service_annotation_prometheus_io_schemeprometheus.io/scheme annotationregex__scheme__</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class=\"line\">        action: replace</span><br><span class=\"line\">        target_label: __metrics_path__</span><br><span class=\"line\">        regex: (.+)</span><br><span class=\"line\">        # path prometheus.io/path = /mymetrics</span><br><span class=\"line\">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class=\"line\">        action: replace</span><br><span class=\"line\">        target_label: __address__</span><br><span class=\"line\">        regex: ([^:]+)(?::\\d+)?;(\\d+)</span><br><span class=\"line\">        replacement: $1:$2</span><br><span class=\"line\">        #</span><br><span class=\"line\">      - action: labelmap</span><br><span class=\"line\">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class=\"line\">        action: replace</span><br><span class=\"line\">        target_label: kubernetes_namespace</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class=\"line\">        action: replace</span><br><span class=\"line\">        target_label: kubernetes_name</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; alertmanager-cfg.yaml &lt;&lt; &quot;&quot;EOF&quot;&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: alert-config</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">data:</span><br><span class=\"line\">  config.yml: |-</span><br><span class=\"line\">    global:</span><br><span class=\"line\">      # </span><br><span class=\"line\">      resolve_timeout: 5m</span><br><span class=\"line\">      # </span><br><span class=\"line\">      smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span><br><span class=\"line\">      smtp_from: &#x27;xxx@163.com&#x27;</span><br><span class=\"line\">      smtp_auth_username: &#x27;xx@163.com&#x27;</span><br><span class=\"line\">      smtp_auth_password: &#x27;password&#x27;</span><br><span class=\"line\">      smtp_hello: &#x27;163.com&#x27;</span><br><span class=\"line\">      smtp_require_tls: false</span><br><span class=\"line\">    # </span><br><span class=\"line\">    route:</span><br><span class=\"line\">      #  cluster=A  alertname=LatncyHigh </span><br><span class=\"line\">      group_by: [&#x27;alertname&#x27;, &#x27;cluster&#x27;]</span><br><span class=\"line\">      # group_wait</span><br><span class=\"line\">      group_wait: 30s</span><br><span class=\"line\"></span><br><span class=\"line\">      # &#x27;group_interval&#x27;</span><br><span class=\"line\">      group_interval: 5m</span><br><span class=\"line\"></span><br><span class=\"line\">      # &#x27;repeat_interval&#x27;</span><br><span class=\"line\">      repeat_interval: 5m</span><br><span class=\"line\"></span><br><span class=\"line\">      # receiverroute</span><br><span class=\"line\">      receiver: default</span><br><span class=\"line\"></span><br><span class=\"line\">      # </span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - receiver: email</span><br><span class=\"line\">        group_wait: 10s</span><br><span class=\"line\">        match:</span><br><span class=\"line\">          team: node</span><br><span class=\"line\">    receivers:</span><br><span class=\"line\">    - name: &#x27;default&#x27;</span><br><span class=\"line\">      email_configs:</span><br><span class=\"line\">      - to: &#x27;xxx@gmail.com&#x27;</span><br><span class=\"line\">        send_resolved: true</span><br><span class=\"line\">    - name: &#x27;email&#x27;</span><br><span class=\"line\">      email_configs:</span><br><span class=\"line\">      - to: &#x27;xxx@gmail.com&#x27;</span><br><span class=\"line\">        send_resolved: true</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> configmap</span></span><br><span class=\"line\">kubectl apply -f alertmanager-cfg.yaml</span><br><span class=\"line\">kubectl apply -f prometheus-cfg.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Prometheus Server  AlertManager </span></span><br><span class=\"line\">cat &gt; prometheus-deployment.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus-server</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: prometheus</span><br><span class=\"line\">      component: server</span><br><span class=\"line\">    #matchExpressions:</span><br><span class=\"line\">    #- &#123;key: app, operator: In, values: [prometheus]&#125;</span><br><span class=\"line\">    #- &#123;key: component, operator: In, values: [server]&#125;</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: prometheus</span><br><span class=\"line\">        component: server</span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        prometheus.io/scrape: &#x27;false&#x27;</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      serviceAccountName: monitor-sa</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      # Prometheus </span><br><span class=\"line\">      - name: prometheus</span><br><span class=\"line\">        image: prom/prometheus</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        command:</span><br><span class=\"line\">          - prometheus</span><br><span class=\"line\">          - --config.file=/etc/prometheus/prometheus.yml</span><br><span class=\"line\">          - --storage.tsdb.path=/prometheus\t#</span><br><span class=\"line\">          - --storage.tsdb.retention=720h\t  #</span><br><span class=\"line\">          - --web.enable-lifecycle\t\t\t\t\t#</span><br><span class=\"line\">          - --web.enable-admin-api          # admin HTTP API </span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9090</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - mountPath: /etc/prometheus/</span><br><span class=\"line\">          name: prometheus-config</span><br><span class=\"line\">        - mountPath: /prometheus/</span><br><span class=\"line\">          name: prometheus-storage-volume</span><br><span class=\"line\">      # Prometheus </span><br><span class=\"line\">      </span><br><span class=\"line\">      # AlertManager </span><br><span class=\"line\">      - name: alertmanager</span><br><span class=\"line\">        image: prom/alertmanager</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        args:</span><br><span class=\"line\">        - --config.file=/etc/alertmanager/config.yml</span><br><span class=\"line\">        - --storage.path=/alertmanager/data</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9093</span><br><span class=\"line\">          name: http</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - mountPath: /etc/alertmanager</span><br><span class=\"line\">          name: alertcfg</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 256Mi</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 256Mi          </span><br><span class=\"line\">      # AlertManager </span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: prometheus-config</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: prometheus-config</span><br><span class=\"line\">      - name: prometheus-storage-volume</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">         path: /data</span><br><span class=\"line\">         type: Directory</span><br><span class=\"line\">      - name: alertcfg</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: alert-config</span><br><span class=\"line\">EOF</span><br><span class=\"line\">kubectl apply -f prometheus-deployment.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Service Prometheus Server </span></span><br><span class=\"line\">cat &gt; prometheus-svc.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: 9090</span><br><span class=\"line\">      targetPort: 9090</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      nodePort: 30009</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">    component: server</span><br><span class=\"line\">EOF</span><br><span class=\"line\">kubectl apply -f prometheus-svc.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">minikbube  Service </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl port-forward service/prometheus -n monitor --address 127.0.0.1 3009:9090</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Alert </p>\n</li>\n</ol>\n<ul>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> ruls.yml  prometheus-cfg.yaml </span></span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">  name: prometheus-config</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">data:</span><br><span class=\"line\">  prometheus.yml: |</span><br><span class=\"line\">    ...</span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> prometheus  /etc/prometheus </span></span><br><span class=\"line\">  rules.yml: |</span><br><span class=\"line\">    groups:</span><br><span class=\"line\">    - name: test-rule</span><br><span class=\"line\">      rules:</span><br><span class=\"line\">      - alert: NodeMemoryUsage</span><br><span class=\"line\">        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 20</span><br><span class=\"line\">        for: 2m</span><br><span class=\"line\">        labels:</span><br><span class=\"line\">          team: node</span><br><span class=\"line\">        annotations:</span><br><span class=\"line\">          summary: &quot;&#123;&#123;.instance&#125;&#125;: High Memory usage detected&quot;</span><br><span class=\"line\">          description: &quot;&#123;&#123;.instance&#125;&#125;: Memory usage is above 20% (current value is: &#123;&#123;  &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Prometheus </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> PrometheusAlertManager  Pod IP</span></span><br><span class=\"line\">curl -X POST http://172.17.0.5:9090/-/reload</span><br><span class=\"line\">curl -X POST http://172.17.0.5:9093/-/reload</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> <span class=\"built_in\">log</span></span></span><br><span class=\"line\">kubectl logs --tail 10 -f prometheus-server-658b54bd7-9gvd9 -n monitor</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl delete -f prometheus-cfg.yaml &amp;&amp; kubectl delete -f prometheus-deployment.yaml</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl apply -f prometheus-cfg.yaml &amp;&amp; kubectl apply -f prometheus-deployment.yaml</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>emailwebhook</p>\n</li>\n</ul>\n<ol start=\"4\">\n<li>Grafana <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; grafana.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: monitoring-grafana</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      task: monitoring</span><br><span class=\"line\">      k8s-app: grafana</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        task: monitoring</span><br><span class=\"line\">        k8s-app: grafana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      securityContext:</span><br><span class=\"line\">        fsGroup: 472</span><br><span class=\"line\">        runAsUser: 472</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: grafana</span><br><span class=\"line\">        image: grafana/grafana</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 3000</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - mountPath: /etc/ssl/certs</span><br><span class=\"line\">          name: ca-certificates</span><br><span class=\"line\">          readOnly: true</span><br><span class=\"line\">        - mountPath: /var</span><br><span class=\"line\">          name: grafana-storage</span><br><span class=\"line\">        env:</span><br><span class=\"line\">        - name: GF_SECURITY_ADMIN_USER</span><br><span class=\"line\">          value: admin</span><br><span class=\"line\">        - name: GF_SECURITY_ADMIN_PASSWORD</span><br><span class=\"line\">          value: admin123</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: ca-certificates</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          path: /etc/ssl/certs</span><br><span class=\"line\">      - name: grafana-storage</span><br><span class=\"line\">        emptyDir: &#123;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    kubernetes.io/cluster-service: &#x27;true&#x27;</span><br><span class=\"line\">    kubernetes.io/name: monitoring-grafana</span><br><span class=\"line\">  name: monitoring-grafana</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 80</span><br><span class=\"line\">    targetPort: 3000</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: grafana</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f grafana.yaml</span><br><span class=\"line\">kubectl get pod,svc -n monitor</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Grafana</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> Prometheus </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> Kubernetes  https://grafana.com/grafana/dashboards/162/revisions</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> node node_exporter.json</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ol>\n<h4 id=\"Prometheus-Operator-\"><a href=\"#Prometheus-Operator-\" class=\"headerlink\" title=\"Prometheus-Operator \"></a>Prometheus-Operator </h4><ol>\n<li> prometheus-operatorcontroller<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> operator </span></span><br><span class=\"line\">git clone https://github.com/prometheus-operator/prometheus-operator &amp;&amp; cd prometheus-operator</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CRD RBAC operator </span></span><br><span class=\"line\">kubectl create -f bundle.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get pod,svc -owide</span><br><span class=\"line\">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">pod/prometheus-operator-567cd8b6f6-xvhp5   1/1     Running   0          127m</span><br><span class=\"line\">NAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class=\"line\">service/prometheus-operator   ClusterIP   None             &lt;none&gt;        8080/TCP         127m</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CRD  API </span></span><br><span class=\"line\">kubectl get --raw /apis/monitoring.coreos.com/v1</span><br></pre></td></tr></table></figure></li>\n</ol>\n<blockquote>\n<p>: <a href=\"https://github.com/prometheus-operator/kube-prometheus\">https://github.com/prometheus-operator/kube-prometheus</a>, </p>\n</blockquote>\n<ol start=\"2\">\n<li><p> prometheus serverCRD </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> prometheus-server </span></span><br><span class=\"line\">cat &gt; prometheus.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: monitoring.coreos.com/v1</span><br><span class=\"line\">kind: Prometheus</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  serviceAccountName: prometheus</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\"> ServiceMonitor</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">ServiceMonitorSelector: &#123;&#125;</span></span><br><span class=\"line\">  serviceMonitorSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      team: frontend</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      memory: 200Mi</span><br><span class=\"line\">  enableAdminAPI: false</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">rules:</span><br><span class=\"line\">- apiGroups: [&quot;&quot;]</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - nodes</span><br><span class=\"line\">  - services</span><br><span class=\"line\">  - endpoints</span><br><span class=\"line\">  - pods</span><br><span class=\"line\">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class=\"line\">- apiGroups: [&quot;&quot;]</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - configmaps</span><br><span class=\"line\">  verbs: [&quot;get&quot;]</span><br><span class=\"line\">- nonResourceURLs: [&quot;/metrics&quot;]</span><br><span class=\"line\">  verbs: [&quot;get&quot;]</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: web</span><br><span class=\"line\">    nodePort: 30900</span><br><span class=\"line\">    port: 9090</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: web</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    prometheus: prometheus</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> metrics </span></span><br><span class=\"line\">cat &gt; example.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: example-app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: example-app</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: example-app</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: example-app</span><br><span class=\"line\">        image: zhangguanzhang/instrumented_app</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - name: web</span><br><span class=\"line\">          containerPort: 8080</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: example-app</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: example-app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: example-app</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: web</span><br><span class=\"line\">    port: 8080</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n<li><p> ServiceMonitor CRD </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> ServiceMonitor</span></span><br><span class=\"line\">cat &gt; service-monitor.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: monitoring.coreos.com/v1</span><br><span class=\"line\">kind: ServiceMonitor</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: example-app</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    team: frontend</span><br><span class=\"line\">spec:</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">namespaceSelector:</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">1.namespacens</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> matchNames:</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> - target_namespace_name</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">2.ns</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> any:<span class=\"literal\">true</span></span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: example-app</span><br><span class=\"line\">  endpoints:</span><br><span class=\"line\">  - port: web</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">BasicAuth(<span class=\"built_in\">base64</span>)</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">- basicAuth:</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">   password:</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">     name: basic-auth</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">     key: password</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">   username:</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">     name: basic-auth</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">     key: user</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> port: web</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">NAME                                       READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">pod/example-app-745967cc67-qbh45           1/1     Running   0          95m    172.17.0.7   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">pod/prometheus-operator-567cd8b6f6-xvhp5   1/1     Running   0          139m   172.17.0.6   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">pod/prometheus-prometheus-0                2/2     Running   0          108m   172.17.0.3   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE    SELECTOR</span><br><span class=\"line\">service/example-app           ClusterIP   10.100.248.130   &lt;none&gt;        8080/TCP         104m   app=example-app</span><br><span class=\"line\">service/kubernetes            ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          24d    &lt;none&gt;</span><br><span class=\"line\">service/prometheus            NodePort    10.101.76.214    &lt;none&gt;        9090:30900/TCP   28m    prometheus=prometheus</span><br><span class=\"line\">service/prometheus-operated   ClusterIP   None             &lt;none&gt;        9090/TCP         108m   app.kubernetes.io/name=prometheus</span><br><span class=\"line\">service/prometheus-operator   ClusterIP   None             &lt;none&gt;        8080/TCP         139m   app.kubernetes.io/component=controller,app.kubernetes.io/name=prometheus-operator</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">minikube </span> </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl port-forward service/prometheus --address 127.0.0.1 9090:9090</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> 127.0.0.1:9090/targets</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Etcdcontroller-manager </p>\n</li>\n</ol>\n<ul>\n<li> Etcd<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">1 etcd  secret</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">2 prometheus StatefulSet  secret</span></span><br><span class=\"line\">kubectl get statefulsets -n monitoring</span><br><span class=\"line\">NAME                READY   AGE</span><br><span class=\"line\">alertmanager-main   3/3     3h25m</span><br><span class=\"line\">prometheus-k8s      1/1     3h25m</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">3 ServiceMonitor </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">4 ServiceEndpoints </span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<ol start=\"6\">\n<li> AlertManagerPrometheusRule </li>\n</ol>\n<ul>\n<li><p>AlertManager Prometheus Dashboard  Config </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alerting:</span><br><span class=\"line\">  alert_relabel_configs:</span><br><span class=\"line\">  - separator: ;</span><br><span class=\"line\">    regex: prometheus_replica</span><br><span class=\"line\">    replacement: $1</span><br><span class=\"line\">    action: labeldrop</span><br><span class=\"line\">  alertmanagers:</span><br><span class=\"line\">  - kubernetes_sd_configs:</span><br><span class=\"line\">    - role: endpoints</span><br><span class=\"line\">      namespaces:</span><br><span class=\"line\">        names:</span><br><span class=\"line\">        - monitoring</span><br><span class=\"line\">    scheme: http</span><br><span class=\"line\">    path_prefix: /</span><br><span class=\"line\">    timeout: 10s</span><br><span class=\"line\">    relabel_configs:</span><br><span class=\"line\">    - source_labels: [__meta_kubernetes_service_name]</span><br><span class=\"line\">      separator: ;</span><br><span class=\"line\">      regex: alertmanager-main</span><br><span class=\"line\">      replacement: $1</span><br><span class=\"line\">      action: keep</span><br><span class=\"line\">    - source_labels: [__meta_kubernetes_endpoint_port_name]</span><br><span class=\"line\">      separator: ;</span><br><span class=\"line\">      regex: web</span><br><span class=\"line\">      replacement: $1</span><br><span class=\"line\">      action: keep</span><br><span class=\"line\">rule_files:</span><br><span class=\"line\">- /etc/prometheus/rules/prometheus-k8s-rulefiles-0/*.yaml</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Prometheus Rule</span></span><br><span class=\"line\">cat &gt; prometheus-rules.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: monitoring.coreos.com/v1</span><br><span class=\"line\">kind: PrometheusRule</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    prometheus: k8s</span><br><span class=\"line\">    role: alert-rules</span><br><span class=\"line\">  name: prometheus-k8s-rules</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  groups:</span><br><span class=\"line\">  - name: k8s.rules</span><br><span class=\"line\">    rules:</span><br><span class=\"line\">    - expr: |</span><br><span class=\"line\">        sum(rate(container_cpu_usage_seconds_total&#123;job=&quot;kubelet&quot;, image!=&quot;&quot;, container_name!=&quot;&quot;&#125;[5m])) by (namespace)</span><br><span class=\"line\">      record: namespace:container_cpu_usage_seconds_total:sum_rate</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> rule  prometheus  /etc/prometheus/rules/prometheus-k8s-rulefiles-0/ </span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>AlertManager  secret</p>\n</li>\n</ul>\n<ol start=\"7\">\n<li></li>\n</ol>\n<ul>\n<li>annotations</li>\n</ul>\n<p>prometheus.io&#x2F;scrape&#x3D;true<br>prometheus.io&#x2F;port&#x3D;xxx</p>\n<ul>\n<li>PVPVC</li>\n</ul>\n<blockquote>\n<p>Operator  CRD </p>\n<ul>\n<li>Prometheus</li>\n<li>ServiceMonitor</li>\n<li>PodMonitor</li>\n<li>AltertManager</li>\n<li>PrometheusRule</li>\n</ul>\n</blockquote>\n<blockquote>\n<p><br>1<a href=\"https://www.servicemesher.com/blog/prometheus-operator-manual/\">https://www.servicemesher.com/blog/prometheus-operator-manual/</a><br>2<a href=\"https://www.qikqiak.com/k8s-book/docs/52.Prometheus%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html\">https://www.qikqiak.com/k8s-book/docs/52.Prometheus%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html</a><br><br>1<a href=\"https://github.com/prometheus-operator/prometheus-operator\">https://github.com/prometheus-operator/prometheus-operator</a><br>2<a href=\"https://github.com/prometheus-operator/kube-prometheus\">https://github.com/prometheus-operator/kube-prometheus</a><br>3<a href=\"https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/prometheus-alert-rule\">https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/prometheus-alert-rule</a></p>\n</blockquote>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":18876,"excerpt":"<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><strong>Prometheus Server</strong></p>\n<ul>\n<li></li>\n<li> Service Discovery </li>\n<li> Prometheus Server </li>\n<li> PromQL </li>\n</ul>\n<p><strong>Exporter</strong></p>\n<ul>\n<li> Prometheus  Endpoints node-exporter</li>\n<li> Prometheus  mysql-exporter</li>\n</ul>\n<p><strong>AlertManager</strong><br> PromQL  mailwebhook </p>\n<p><strong>PushGateway</strong><br> Prometheus Server  Exporter pull  Server  Exporter  PushGateway <br>Prometheus server  jobs  exporters  metrics Pushgateway  metrics Prometheus server  metrics</p>\n<blockquote>\n<p>metrics cpu </p>\n</blockquote>","more":"<p><strong>Grafana</strong><br><br><br><br></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ol>\n<li><p> node-export </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat &gt; node-exporter.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">node-exporter.yaml</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: DaemonSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: node-exporter</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: node-exporter</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">     name: node-exporter</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        name: node-exporter</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      hostPID: true</span><br><span class=\"line\">      hostIPC: true</span><br><span class=\"line\">      hostNetwork: true</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: node-exporter</span><br><span class=\"line\">        image: prom/node-exporter:v0.16.0</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9100</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 0.15 # 0.15cpu</span><br><span class=\"line\">        securityContext:</span><br><span class=\"line\">          privileged: true\t# </span><br><span class=\"line\">        args:</span><br><span class=\"line\">        - --path.procfs</span><br><span class=\"line\">        - /host/proc</span><br><span class=\"line\">        - --path.sysfs</span><br><span class=\"line\">        - /host/sys</span><br><span class=\"line\">        - --collector.filesystem.ignored-mount-points</span><br><span class=\"line\">        - &#x27;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#x27;</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: dev</span><br><span class=\"line\">          mountPath: /host/dev</span><br><span class=\"line\">        - name: proc</span><br><span class=\"line\">          mountPath: /host/proc</span><br><span class=\"line\">        - name: sys</span><br><span class=\"line\">          mountPath: /host/sys</span><br><span class=\"line\">        - name: rootfs</span><br><span class=\"line\">          mountPath: /rootfs</span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - key: &quot;node-role.kubernetes.io/master&quot;</span><br><span class=\"line\">        operator: &quot;Exists&quot;</span><br><span class=\"line\">        effect: &quot;NoSchedule&quot;</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: proc</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /proc</span><br><span class=\"line\">        - name: dev</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /dev</span><br><span class=\"line\">        - name: sys</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /sys</span><br><span class=\"line\">        - name: rootfs</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> namespace</span></span><br><span class=\"line\">kubectl create ns monitor</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl apply -f node-exporter.yaml</span><br><span class=\"line\">kubectl get pods -n monitor -o wide</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">curl node_ip:9100/metrics</span></span><br><span class=\"line\">curl 192.168.49.2:9100/metrics</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Prometheus Server </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> serviceaccount  rbac </span></span><br><span class=\"line\">cat &gt; prometheus-rbac.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: monitor-sa</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: monitor-sa-clusterrole</span><br><span class=\"line\">rules:</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - &quot;&quot;</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - nodes</span><br><span class=\"line\">  - services</span><br><span class=\"line\">  - endpoints</span><br><span class=\"line\">  - pods</span><br><span class=\"line\">  - nodes/proxy</span><br><span class=\"line\">  - nodes/metrics</span><br><span class=\"line\">  - configmaps</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - get</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- nonResourceURLs:</span><br><span class=\"line\">  - /metrics</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - get</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: monitor-clusterrolebinding</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: monitor-sa-clusterrole</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: minitor-sa</span><br><span class=\"line\">  namespace: minitor</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Prometheus </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Prometheus Server  minikube </span></span><br><span class=\"line\">mkdir /data &amp;&amp; chmod 777 /data</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> configMap PrometheusAlertManager </span></span><br><span class=\"line\">cat &gt; prometheus-cfg.yaml &lt;&lt; &quot;&quot;EOF&quot;&quot;</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">  name: prometheus-config</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">data:</span><br><span class=\"line\">  prometheus.yml: |</span><br><span class=\"line\">    global:</span><br><span class=\"line\">      scrape_interval: 15s\t\t#</span><br><span class=\"line\">      scrape_timeout: 10s\t\t\t#</span><br><span class=\"line\">      evaluation_interval: 1m\t#</span><br><span class=\"line\">      </span><br><span class=\"line\">    # Prometheus  AlertManager </span><br><span class=\"line\">    alerting:</span><br><span class=\"line\">      alertmanagers:</span><br><span class=\"line\">      - static_configs:</span><br><span class=\"line\">        - targets: [&quot;localhost:9093&quot;]</span><br><span class=\"line\">    </span><br><span class=\"line\">    #  evaluation_interval </span><br><span class=\"line\">    rule_files:</span><br><span class=\"line\">    #- &quot;alertermanager_rules.yaml&quot;</span><br><span class=\"line\">    - /etc/prometheus/rules.yaml</span><br><span class=\"line\">      </span><br><span class=\"line\">    scrape_configs:\t\t\t\t\t\t\t\t\t# targe target  job_name </span><br><span class=\"line\">    - job_name: &#x27;kubernetes-node&#x27;</span><br><span class=\"line\">      kubernetes_sd_configs:\t\t\t\t# k8s </span><br><span class=\"line\">      - role: node\t\t\t\t\t\t\t\t\t# node  kubelet  http  node </span><br><span class=\"line\">      relabel_configs:\t\t\t\t\t\t\t#</span><br><span class=\"line\">      - source_labels: [__address__]\t#</span><br><span class=\"line\">        regex: &#x27;(.*):10250&#x27;\t\t\t\t\t\t#10250 url</span><br><span class=\"line\">        replacement: &#x27;$&#123;1&#125;:9100&#x27;\t\t\t# ip:9100 ip</span><br><span class=\"line\">        target_label: __address__\t\t\t# url $&#123;1&#125; ip:9100</span><br><span class=\"line\">        action: replace\t\t\t\t\t\t\t\t#</span><br><span class=\"line\">      - action: labelmap</span><br><span class=\"line\">        regex: __meta_kubernetes_node_label_(.+)\t#,regexinstance</span><br><span class=\"line\">    - job_name: &#x27;kubernetes-node-cadvisor&#x27;\t#  cAdvisor  kubelet  /metrics/cadvisor </span><br><span class=\"line\">      kubernetes_sd_configs:</span><br><span class=\"line\">      - role: node</span><br><span class=\"line\">      scheme: https</span><br><span class=\"line\">      tls_config:</span><br><span class=\"line\">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">      relabel_configs:</span><br><span class=\"line\">      - action: labelmap\t\t\t\t\t\t\t\t\t\t\t\t\t#</span><br><span class=\"line\">        regex: __meta_kubernetes_node_label_(.+)\t#</span><br><span class=\"line\">      - target_label: __address__\t\t\t\t\t\t\t\t\t#__address__=&quot;192.168.64.2:10250&quot;</span><br><span class=\"line\">        replacement: kubernetes.default.svc:443\t\t#</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class=\"line\">        regex: (.+)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t# __meta_kubernetes_node_name </span><br><span class=\"line\">        target_label: __metrics_path__\t\t\t\t\t\t#__metrics_path__</span><br><span class=\"line\">        replacement: /api/v1/nodes//proxy/metrics/cadvisor</span><br><span class=\"line\">        # metrics  api/v1/nodes/k8s-master1/proxy/metrics/cadvisor</span><br><span class=\"line\">        #$&#123;1&#125; __meta_kubernetes_node_name </span><br><span class=\"line\">        # url  https://kubernetes.default.svc:443/api/v1/nodes/k8s-master1/proxy/metrics/cadvisor</span><br><span class=\"line\">    - job_name: &#x27;kubernetes-apiserver&#x27;</span><br><span class=\"line\">      kubernetes_sd_configs:</span><br><span class=\"line\">      - role: endpoints\t\t\t\t# k8s  endpoint  apiserver 6443 </span><br><span class=\"line\">      scheme: https</span><br><span class=\"line\">      tls_config:</span><br><span class=\"line\">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">      relabel_configs:</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class=\"line\">        # endpoint ,endpoint ,endpoint </span><br><span class=\"line\">        action: keep\t#</span><br><span class=\"line\">        regex: default;kubernetes;https\t# service  kubernetes https  endpoint </span><br><span class=\"line\">    - job_name: &#x27;kubernetes-service-endpoints&#x27;</span><br><span class=\"line\">      kubernetes_sd_configs:</span><br><span class=\"line\">      - role: endpoints</span><br><span class=\"line\">      relabel_configs:</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><br><span class=\"line\">        action: keep</span><br><span class=\"line\">        regex: true</span><br><span class=\"line\">        # &quot;prometheus.io/scrape: true&quot; annotationserviceprometheus.io/scrape = true annotationannotationregextrueregexkeep</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class=\"line\">        action: replace</span><br><span class=\"line\">        target_label: __scheme__</span><br><span class=\"line\">        regex: (https?)</span><br><span class=\"line\">        #scheme__meta_kubernetes_service_annotation_prometheus_io_schemeprometheus.io/scheme annotationregex__scheme__</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class=\"line\">        action: replace</span><br><span class=\"line\">        target_label: __metrics_path__</span><br><span class=\"line\">        regex: (.+)</span><br><span class=\"line\">        # path prometheus.io/path = /mymetrics</span><br><span class=\"line\">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class=\"line\">        action: replace</span><br><span class=\"line\">        target_label: __address__</span><br><span class=\"line\">        regex: ([^:]+)(?::\\d+)?;(\\d+)</span><br><span class=\"line\">        replacement: $1:$2</span><br><span class=\"line\">        #</span><br><span class=\"line\">      - action: labelmap</span><br><span class=\"line\">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class=\"line\">        action: replace</span><br><span class=\"line\">        target_label: kubernetes_namespace</span><br><span class=\"line\">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class=\"line\">        action: replace</span><br><span class=\"line\">        target_label: kubernetes_name</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; alertmanager-cfg.yaml &lt;&lt; &quot;&quot;EOF&quot;&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: alert-config</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">data:</span><br><span class=\"line\">  config.yml: |-</span><br><span class=\"line\">    global:</span><br><span class=\"line\">      # </span><br><span class=\"line\">      resolve_timeout: 5m</span><br><span class=\"line\">      # </span><br><span class=\"line\">      smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span><br><span class=\"line\">      smtp_from: &#x27;xxx@163.com&#x27;</span><br><span class=\"line\">      smtp_auth_username: &#x27;xx@163.com&#x27;</span><br><span class=\"line\">      smtp_auth_password: &#x27;password&#x27;</span><br><span class=\"line\">      smtp_hello: &#x27;163.com&#x27;</span><br><span class=\"line\">      smtp_require_tls: false</span><br><span class=\"line\">    # </span><br><span class=\"line\">    route:</span><br><span class=\"line\">      #  cluster=A  alertname=LatncyHigh </span><br><span class=\"line\">      group_by: [&#x27;alertname&#x27;, &#x27;cluster&#x27;]</span><br><span class=\"line\">      # group_wait</span><br><span class=\"line\">      group_wait: 30s</span><br><span class=\"line\"></span><br><span class=\"line\">      # &#x27;group_interval&#x27;</span><br><span class=\"line\">      group_interval: 5m</span><br><span class=\"line\"></span><br><span class=\"line\">      # &#x27;repeat_interval&#x27;</span><br><span class=\"line\">      repeat_interval: 5m</span><br><span class=\"line\"></span><br><span class=\"line\">      # receiverroute</span><br><span class=\"line\">      receiver: default</span><br><span class=\"line\"></span><br><span class=\"line\">      # </span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - receiver: email</span><br><span class=\"line\">        group_wait: 10s</span><br><span class=\"line\">        match:</span><br><span class=\"line\">          team: node</span><br><span class=\"line\">    receivers:</span><br><span class=\"line\">    - name: &#x27;default&#x27;</span><br><span class=\"line\">      email_configs:</span><br><span class=\"line\">      - to: &#x27;xxx@gmail.com&#x27;</span><br><span class=\"line\">        send_resolved: true</span><br><span class=\"line\">    - name: &#x27;email&#x27;</span><br><span class=\"line\">      email_configs:</span><br><span class=\"line\">      - to: &#x27;xxx@gmail.com&#x27;</span><br><span class=\"line\">        send_resolved: true</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> configmap</span></span><br><span class=\"line\">kubectl apply -f alertmanager-cfg.yaml</span><br><span class=\"line\">kubectl apply -f prometheus-cfg.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Prometheus Server  AlertManager </span></span><br><span class=\"line\">cat &gt; prometheus-deployment.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus-server</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: prometheus</span><br><span class=\"line\">      component: server</span><br><span class=\"line\">    #matchExpressions:</span><br><span class=\"line\">    #- &#123;key: app, operator: In, values: [prometheus]&#125;</span><br><span class=\"line\">    #- &#123;key: component, operator: In, values: [server]&#125;</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: prometheus</span><br><span class=\"line\">        component: server</span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        prometheus.io/scrape: &#x27;false&#x27;</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      serviceAccountName: monitor-sa</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      # Prometheus </span><br><span class=\"line\">      - name: prometheus</span><br><span class=\"line\">        image: prom/prometheus</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        command:</span><br><span class=\"line\">          - prometheus</span><br><span class=\"line\">          - --config.file=/etc/prometheus/prometheus.yml</span><br><span class=\"line\">          - --storage.tsdb.path=/prometheus\t#</span><br><span class=\"line\">          - --storage.tsdb.retention=720h\t  #</span><br><span class=\"line\">          - --web.enable-lifecycle\t\t\t\t\t#</span><br><span class=\"line\">          - --web.enable-admin-api          # admin HTTP API </span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9090</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - mountPath: /etc/prometheus/</span><br><span class=\"line\">          name: prometheus-config</span><br><span class=\"line\">        - mountPath: /prometheus/</span><br><span class=\"line\">          name: prometheus-storage-volume</span><br><span class=\"line\">      # Prometheus </span><br><span class=\"line\">      </span><br><span class=\"line\">      # AlertManager </span><br><span class=\"line\">      - name: alertmanager</span><br><span class=\"line\">        image: prom/alertmanager</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        args:</span><br><span class=\"line\">        - --config.file=/etc/alertmanager/config.yml</span><br><span class=\"line\">        - --storage.path=/alertmanager/data</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9093</span><br><span class=\"line\">          name: http</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - mountPath: /etc/alertmanager</span><br><span class=\"line\">          name: alertcfg</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 256Mi</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 256Mi          </span><br><span class=\"line\">      # AlertManager </span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: prometheus-config</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: prometheus-config</span><br><span class=\"line\">      - name: prometheus-storage-volume</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">         path: /data</span><br><span class=\"line\">         type: Directory</span><br><span class=\"line\">      - name: alertcfg</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: alert-config</span><br><span class=\"line\">EOF</span><br><span class=\"line\">kubectl apply -f prometheus-deployment.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Service Prometheus Server </span></span><br><span class=\"line\">cat &gt; prometheus-svc.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: 9090</span><br><span class=\"line\">      targetPort: 9090</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      nodePort: 30009</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">    component: server</span><br><span class=\"line\">EOF</span><br><span class=\"line\">kubectl apply -f prometheus-svc.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">minikbube  Service </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl port-forward service/prometheus -n monitor --address 127.0.0.1 3009:9090</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Alert </p>\n</li>\n</ol>\n<ul>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> ruls.yml  prometheus-cfg.yaml </span></span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">  name: prometheus-config</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">data:</span><br><span class=\"line\">  prometheus.yml: |</span><br><span class=\"line\">    ...</span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> prometheus  /etc/prometheus </span></span><br><span class=\"line\">  rules.yml: |</span><br><span class=\"line\">    groups:</span><br><span class=\"line\">    - name: test-rule</span><br><span class=\"line\">      rules:</span><br><span class=\"line\">      - alert: NodeMemoryUsage</span><br><span class=\"line\">        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 20</span><br><span class=\"line\">        for: 2m</span><br><span class=\"line\">        labels:</span><br><span class=\"line\">          team: node</span><br><span class=\"line\">        annotations:</span><br><span class=\"line\">          summary: &quot;&#123;&#123;.instance&#125;&#125;: High Memory usage detected&quot;</span><br><span class=\"line\">          description: &quot;&#123;&#123;.instance&#125;&#125;: Memory usage is above 20% (current value is: &#123;&#123;  &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Prometheus </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> PrometheusAlertManager  Pod IP</span></span><br><span class=\"line\">curl -X POST http://172.17.0.5:9090/-/reload</span><br><span class=\"line\">curl -X POST http://172.17.0.5:9093/-/reload</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> <span class=\"built_in\">log</span></span></span><br><span class=\"line\">kubectl logs --tail 10 -f prometheus-server-658b54bd7-9gvd9 -n monitor</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl delete -f prometheus-cfg.yaml &amp;&amp; kubectl delete -f prometheus-deployment.yaml</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl apply -f prometheus-cfg.yaml &amp;&amp; kubectl apply -f prometheus-deployment.yaml</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>emailwebhook</p>\n</li>\n</ul>\n<ol start=\"4\">\n<li>Grafana <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; grafana.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: monitoring-grafana</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      task: monitoring</span><br><span class=\"line\">      k8s-app: grafana</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        task: monitoring</span><br><span class=\"line\">        k8s-app: grafana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      securityContext:</span><br><span class=\"line\">        fsGroup: 472</span><br><span class=\"line\">        runAsUser: 472</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: grafana</span><br><span class=\"line\">        image: grafana/grafana</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 3000</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - mountPath: /etc/ssl/certs</span><br><span class=\"line\">          name: ca-certificates</span><br><span class=\"line\">          readOnly: true</span><br><span class=\"line\">        - mountPath: /var</span><br><span class=\"line\">          name: grafana-storage</span><br><span class=\"line\">        env:</span><br><span class=\"line\">        - name: GF_SECURITY_ADMIN_USER</span><br><span class=\"line\">          value: admin</span><br><span class=\"line\">        - name: GF_SECURITY_ADMIN_PASSWORD</span><br><span class=\"line\">          value: admin123</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: ca-certificates</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          path: /etc/ssl/certs</span><br><span class=\"line\">      - name: grafana-storage</span><br><span class=\"line\">        emptyDir: &#123;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    kubernetes.io/cluster-service: &#x27;true&#x27;</span><br><span class=\"line\">    kubernetes.io/name: monitoring-grafana</span><br><span class=\"line\">  name: monitoring-grafana</span><br><span class=\"line\">  namespace: monitor</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 80</span><br><span class=\"line\">    targetPort: 3000</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: grafana</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f grafana.yaml</span><br><span class=\"line\">kubectl get pod,svc -n monitor</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Grafana</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> Prometheus </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> Kubernetes  https://grafana.com/grafana/dashboards/162/revisions</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> node node_exporter.json</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ol>\n<h4 id=\"Prometheus-Operator-\"><a href=\"#Prometheus-Operator-\" class=\"headerlink\" title=\"Prometheus-Operator \"></a>Prometheus-Operator </h4><ol>\n<li> prometheus-operatorcontroller<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> operator </span></span><br><span class=\"line\">git clone https://github.com/prometheus-operator/prometheus-operator &amp;&amp; cd prometheus-operator</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CRD RBAC operator </span></span><br><span class=\"line\">kubectl create -f bundle.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get pod,svc -owide</span><br><span class=\"line\">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">pod/prometheus-operator-567cd8b6f6-xvhp5   1/1     Running   0          127m</span><br><span class=\"line\">NAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class=\"line\">service/prometheus-operator   ClusterIP   None             &lt;none&gt;        8080/TCP         127m</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> CRD  API </span></span><br><span class=\"line\">kubectl get --raw /apis/monitoring.coreos.com/v1</span><br></pre></td></tr></table></figure></li>\n</ol>\n<blockquote>\n<p>: <a href=\"https://github.com/prometheus-operator/kube-prometheus\">https://github.com/prometheus-operator/kube-prometheus</a>, </p>\n</blockquote>\n<ol start=\"2\">\n<li><p> prometheus serverCRD </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> prometheus-server </span></span><br><span class=\"line\">cat &gt; prometheus.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: monitoring.coreos.com/v1</span><br><span class=\"line\">kind: Prometheus</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  serviceAccountName: prometheus</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\"> ServiceMonitor</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">ServiceMonitorSelector: &#123;&#125;</span></span><br><span class=\"line\">  serviceMonitorSelector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      team: frontend</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      memory: 200Mi</span><br><span class=\"line\">  enableAdminAPI: false</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">rules:</span><br><span class=\"line\">- apiGroups: [&quot;&quot;]</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - nodes</span><br><span class=\"line\">  - services</span><br><span class=\"line\">  - endpoints</span><br><span class=\"line\">  - pods</span><br><span class=\"line\">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class=\"line\">- apiGroups: [&quot;&quot;]</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - configmaps</span><br><span class=\"line\">  verbs: [&quot;get&quot;]</span><br><span class=\"line\">- nonResourceURLs: [&quot;/metrics&quot;]</span><br><span class=\"line\">  verbs: [&quot;get&quot;]</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: web</span><br><span class=\"line\">    nodePort: 30900</span><br><span class=\"line\">    port: 9090</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: web</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    prometheus: prometheus</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> metrics </span></span><br><span class=\"line\">cat &gt; example.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: example-app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: example-app</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: example-app</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: example-app</span><br><span class=\"line\">        image: zhangguanzhang/instrumented_app</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - name: web</span><br><span class=\"line\">          containerPort: 8080</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: example-app</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: example-app</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: example-app</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: web</span><br><span class=\"line\">    port: 8080</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n<li><p> ServiceMonitor CRD </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> ServiceMonitor</span></span><br><span class=\"line\">cat &gt; service-monitor.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: monitoring.coreos.com/v1</span><br><span class=\"line\">kind: ServiceMonitor</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: example-app</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    team: frontend</span><br><span class=\"line\">spec:</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">namespaceSelector:</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">1.namespacens</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> matchNames:</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> - target_namespace_name</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">2.ns</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> any:<span class=\"literal\">true</span></span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: example-app</span><br><span class=\"line\">  endpoints:</span><br><span class=\"line\">  - port: web</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">BasicAuth(<span class=\"built_in\">base64</span>)</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">- basicAuth:</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">   password:</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">     name: basic-auth</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">     key: password</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">   username:</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">     name: basic-auth</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">     key: user</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\"> port: web</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">NAME                                       READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">pod/example-app-745967cc67-qbh45           1/1     Running   0          95m    172.17.0.7   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">pod/prometheus-operator-567cd8b6f6-xvhp5   1/1     Running   0          139m   172.17.0.6   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">pod/prometheus-prometheus-0                2/2     Running   0          108m   172.17.0.3   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE    SELECTOR</span><br><span class=\"line\">service/example-app           ClusterIP   10.100.248.130   &lt;none&gt;        8080/TCP         104m   app=example-app</span><br><span class=\"line\">service/kubernetes            ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          24d    &lt;none&gt;</span><br><span class=\"line\">service/prometheus            NodePort    10.101.76.214    &lt;none&gt;        9090:30900/TCP   28m    prometheus=prometheus</span><br><span class=\"line\">service/prometheus-operated   ClusterIP   None             &lt;none&gt;        9090/TCP         108m   app.kubernetes.io/name=prometheus</span><br><span class=\"line\">service/prometheus-operator   ClusterIP   None             &lt;none&gt;        8080/TCP         139m   app.kubernetes.io/component=controller,app.kubernetes.io/name=prometheus-operator</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">minikube </span> </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl port-forward service/prometheus --address 127.0.0.1 9090:9090</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> 127.0.0.1:9090/targets</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Etcdcontroller-manager </p>\n</li>\n</ol>\n<ul>\n<li> Etcd<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">1 etcd  secret</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">2 prometheus StatefulSet  secret</span></span><br><span class=\"line\">kubectl get statefulsets -n monitoring</span><br><span class=\"line\">NAME                READY   AGE</span><br><span class=\"line\">alertmanager-main   3/3     3h25m</span><br><span class=\"line\">prometheus-k8s      1/1     3h25m</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">3 ServiceMonitor </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">4 ServiceEndpoints </span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<ol start=\"6\">\n<li> AlertManagerPrometheusRule </li>\n</ol>\n<ul>\n<li><p>AlertManager Prometheus Dashboard  Config </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alerting:</span><br><span class=\"line\">  alert_relabel_configs:</span><br><span class=\"line\">  - separator: ;</span><br><span class=\"line\">    regex: prometheus_replica</span><br><span class=\"line\">    replacement: $1</span><br><span class=\"line\">    action: labeldrop</span><br><span class=\"line\">  alertmanagers:</span><br><span class=\"line\">  - kubernetes_sd_configs:</span><br><span class=\"line\">    - role: endpoints</span><br><span class=\"line\">      namespaces:</span><br><span class=\"line\">        names:</span><br><span class=\"line\">        - monitoring</span><br><span class=\"line\">    scheme: http</span><br><span class=\"line\">    path_prefix: /</span><br><span class=\"line\">    timeout: 10s</span><br><span class=\"line\">    relabel_configs:</span><br><span class=\"line\">    - source_labels: [__meta_kubernetes_service_name]</span><br><span class=\"line\">      separator: ;</span><br><span class=\"line\">      regex: alertmanager-main</span><br><span class=\"line\">      replacement: $1</span><br><span class=\"line\">      action: keep</span><br><span class=\"line\">    - source_labels: [__meta_kubernetes_endpoint_port_name]</span><br><span class=\"line\">      separator: ;</span><br><span class=\"line\">      regex: web</span><br><span class=\"line\">      replacement: $1</span><br><span class=\"line\">      action: keep</span><br><span class=\"line\">rule_files:</span><br><span class=\"line\">- /etc/prometheus/rules/prometheus-k8s-rulefiles-0/*.yaml</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Prometheus Rule</span></span><br><span class=\"line\">cat &gt; prometheus-rules.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: monitoring.coreos.com/v1</span><br><span class=\"line\">kind: PrometheusRule</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    prometheus: k8s</span><br><span class=\"line\">    role: alert-rules</span><br><span class=\"line\">  name: prometheus-k8s-rules</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  groups:</span><br><span class=\"line\">  - name: k8s.rules</span><br><span class=\"line\">    rules:</span><br><span class=\"line\">    - expr: |</span><br><span class=\"line\">        sum(rate(container_cpu_usage_seconds_total&#123;job=&quot;kubelet&quot;, image!=&quot;&quot;, container_name!=&quot;&quot;&#125;[5m])) by (namespace)</span><br><span class=\"line\">      record: namespace:container_cpu_usage_seconds_total:sum_rate</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> rule  prometheus  /etc/prometheus/rules/prometheus-k8s-rulefiles-0/ </span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>AlertManager  secret</p>\n</li>\n</ul>\n<ol start=\"7\">\n<li></li>\n</ol>\n<ul>\n<li>annotations</li>\n</ul>\n<p>prometheus.io&#x2F;scrape&#x3D;true<br>prometheus.io&#x2F;port&#x3D;xxx</p>\n<ul>\n<li>PVPVC</li>\n</ul>\n<blockquote>\n<p>Operator  CRD </p>\n<ul>\n<li>Prometheus</li>\n<li>ServiceMonitor</li>\n<li>PodMonitor</li>\n<li>AltertManager</li>\n<li>PrometheusRule</li>\n</ul>\n</blockquote>\n<blockquote>\n<p><br>1<a href=\"https://www.servicemesher.com/blog/prometheus-operator-manual/\">https://www.servicemesher.com/blog/prometheus-operator-manual/</a><br>2<a href=\"https://www.qikqiak.com/k8s-book/docs/52.Prometheus%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html\">https://www.qikqiak.com/k8s-book/docs/52.Prometheus%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html</a><br><br>1<a href=\"https://github.com/prometheus-operator/prometheus-operator\">https://github.com/prometheus-operator/prometheus-operator</a><br>2<a href=\"https://github.com/prometheus-operator/kube-prometheus\">https://github.com/prometheus-operator/kube-prometheus</a><br>3<a href=\"https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/prometheus-alert-rule\">https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/prometheus-alert-rule</a></p>\n</blockquote>"},{"title":"Alicloud-Promotheus & Grafana ","abbrlink":"9a8h","date":"2022-03-16T15:21:06.000Z","_content":"### \n- ACK StatefulSet rabbitMQrabbitMQ management \n   - Prometheus +grafana \n   - Arms Prometheus \n\n### \n#### 1Prometheus \n\n-  **Prometheus**ACKPrometheus [ARMS Prometheus](https://help.aliyun.com/document_detail/161304.html)\n{% asset_img 1.png %}\n\n<!--more-->\n-   RabbitMQ\n{% asset_img 2.png %}\n{% asset_img 3.png %}\n\n- grafana  **curl  xxx:9419/metrics ** :\n{% asset_img 4.png %}\n\n\n#### 2grafana \n\n- Pometheus grafana \n{% asset_img 5.png %}\n\n- grafana Dashboardpanel\n{% asset_img 6.png %}\n{% asset_img 7.png %}\n{% asset_img 8.png %}\n\n- ACKACK  ** -- Prometheus --Cloud RABBITMQ** \n{% asset_img 9.png %}\n\n#### 3\n\n- webhook[https://help.aliyun.com/document_detail/251838.html](https://help.aliyun.com/document_detail/251838.html)\n\n-  **Prometheus** IM\n{% asset_img 10.png %}\n\n-  **ARMS -- Prometheus -- Prometheus** **Prometheus** \n{% asset_img 11.png %}\n{% asset_img 12.png %}\n\n-  **ARMS --  -- ** **** \n{% asset_img 13.png %}\n{% asset_img 14.png %}\n\n#### 4\n\n- PromQL sum by (queue)(rabbitmq_queue_messages_unacknowledged{app=\"rabbi-exporter\"}) >= 0\n\n\n\n-  **ARMS --  -- /** \n{% asset_img 15.png %}\n{% asset_img 16.png %}\n\n- \n{% asset_img 17.png %}\n\n### \n\n- ACK  RabbitMQ\n","source":"_posts/prometheus-grafana-notice.md","raw":"---\ntitle: Alicloud-Promotheus & Grafana \nabbrlink: 9a8h\ndate: 2022-03-16 23:21:06\ncategories:\n  - Alicloud\n  - CNCF\ntags:\n  - Kubernetes\n---\n### \n- ACK StatefulSet rabbitMQrabbitMQ management \n   - Prometheus +grafana \n   - Arms Prometheus \n\n### \n#### 1Prometheus \n\n-  **Prometheus**ACKPrometheus [ARMS Prometheus](https://help.aliyun.com/document_detail/161304.html)\n{% asset_img 1.png %}\n\n<!--more-->\n-   RabbitMQ\n{% asset_img 2.png %}\n{% asset_img 3.png %}\n\n- grafana  **curl  xxx:9419/metrics ** :\n{% asset_img 4.png %}\n\n\n#### 2grafana \n\n- Pometheus grafana \n{% asset_img 5.png %}\n\n- grafana Dashboardpanel\n{% asset_img 6.png %}\n{% asset_img 7.png %}\n{% asset_img 8.png %}\n\n- ACKACK  ** -- Prometheus --Cloud RABBITMQ** \n{% asset_img 9.png %}\n\n#### 3\n\n- webhook[https://help.aliyun.com/document_detail/251838.html](https://help.aliyun.com/document_detail/251838.html)\n\n-  **Prometheus** IM\n{% asset_img 10.png %}\n\n-  **ARMS -- Prometheus -- Prometheus** **Prometheus** \n{% asset_img 11.png %}\n{% asset_img 12.png %}\n\n-  **ARMS --  -- ** **** \n{% asset_img 13.png %}\n{% asset_img 14.png %}\n\n#### 4\n\n- PromQL sum by (queue)(rabbitmq_queue_messages_unacknowledged{app=\"rabbi-exporter\"}) >= 0\n\n\n\n-  **ARMS --  -- /** \n{% asset_img 15.png %}\n{% asset_img 16.png %}\n\n- \n{% asset_img 17.png %}\n\n### \n\n- ACK  RabbitMQ\n","slug":"prometheus-grafana-notice","published":1,"updated":"2024-01-21T15:30:17.732Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zq001xs0njexlfbxdk","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>ACK StatefulSet rabbitMQrabbitMQ management <ul>\n<li>Prometheus +grafana </li>\n<li>Arms Prometheus </li>\n</ul>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1Prometheus-\"><a href=\"#1Prometheus-\" class=\"headerlink\" title=\"1Prometheus \"></a>1Prometheus </h4><ul>\n<li> <strong>Prometheus</strong>ACKPrometheus <a href=\"https://help.aliyun.com/document_detail/161304.html\">ARMS Prometheus</a><img data-src=\"/posts/9a8h/1.png\" class></li>\n</ul>\n<span id=\"more\"></span>\n<ul>\n<li><p>  RabbitMQ</p>\n<img data-src=\"/posts/9a8h/2.png\" class>\n<img data-src=\"/posts/9a8h/3.png\" class>\n</li>\n<li><p>grafana  **curl  xxx:9419&#x2F;metrics ** :</p>\n<img data-src=\"/posts/9a8h/4.png\" class></li>\n</ul>\n<h4 id=\"2grafana-\"><a href=\"#2grafana-\" class=\"headerlink\" title=\"2grafana \"></a>2grafana </h4><ul>\n<li><p>Pometheus grafana </p>\n<img data-src=\"/posts/9a8h/5.png\" class>\n</li>\n<li><p>grafana Dashboardpanel</p>\n<img data-src=\"/posts/9a8h/6.png\" class>\n<img data-src=\"/posts/9a8h/7.png\" class>\n<img data-src=\"/posts/9a8h/8.png\" class>\n</li>\n<li><p>ACKACK  <strong>  Prometheus Cloud RABBITMQ</strong> </p>\n<img data-src=\"/posts/9a8h/9.png\" class></li>\n</ul>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><ul>\n<li><p>webhook<a href=\"https://help.aliyun.com/document_detail/251838.html\">https://help.aliyun.com/document_detail&#x2F;251838.html</a></p>\n</li>\n<li><p> <strong>Prometheus</strong> IM</p>\n<img data-src=\"/posts/9a8h/10.png\" class>\n</li>\n<li><p> <strong>ARMS  Prometheus  Prometheus</strong> <strong>Prometheus</strong> </p>\n<img data-src=\"/posts/9a8h/11.png\" class>\n<img data-src=\"/posts/9a8h/12.png\" class>\n</li>\n<li><p> <strong>ARMS    </strong> <strong></strong> </p>\n<img data-src=\"/posts/9a8h/13.png\" class>\n<img data-src=\"/posts/9a8h/14.png\" class></li>\n</ul>\n<h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><ul>\n<li>PromQL sum by (queue)(rabbitmq_queue_messages_unacknowledged{app&#x3D;rabbi-exporter}) &gt;&#x3D; 0</li>\n</ul>\n<p></p>\n<ul>\n<li><p> <strong>ARMS    &#x2F;</strong> </p>\n<img data-src=\"/posts/9a8h/15.png\" class>\n<img data-src=\"/posts/9a8h/16.png\" class>\n</li>\n<li><p></p>\n<img data-src=\"/posts/9a8h/17.png\" class></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>ACK  RabbitMQ</li>\n</ul>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":1125,"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>ACK StatefulSet rabbitMQrabbitMQ management <ul>\n<li>Prometheus +grafana </li>\n<li>Arms Prometheus </li>\n</ul>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1Prometheus-\"><a href=\"#1Prometheus-\" class=\"headerlink\" title=\"1Prometheus \"></a>1Prometheus </h4><ul>\n<li> <strong>Prometheus</strong>ACKPrometheus <a href=\"https://help.aliyun.com/document_detail/161304.html\">ARMS Prometheus</a><img data-src=\"/posts/9a8h/1.png\" class></li>\n</ul>","more":"<ul>\n<li><p>  RabbitMQ</p>\n<img data-src=\"/posts/9a8h/2.png\" class>\n<img data-src=\"/posts/9a8h/3.png\" class>\n</li>\n<li><p>grafana  **curl  xxx:9419&#x2F;metrics ** :</p>\n<img data-src=\"/posts/9a8h/4.png\" class></li>\n</ul>\n<h4 id=\"2grafana-\"><a href=\"#2grafana-\" class=\"headerlink\" title=\"2grafana \"></a>2grafana </h4><ul>\n<li><p>Pometheus grafana </p>\n<img data-src=\"/posts/9a8h/5.png\" class>\n</li>\n<li><p>grafana Dashboardpanel</p>\n<img data-src=\"/posts/9a8h/6.png\" class>\n<img data-src=\"/posts/9a8h/7.png\" class>\n<img data-src=\"/posts/9a8h/8.png\" class>\n</li>\n<li><p>ACKACK  <strong>  Prometheus Cloud RABBITMQ</strong> </p>\n<img data-src=\"/posts/9a8h/9.png\" class></li>\n</ul>\n<h4 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h4><ul>\n<li><p>webhook<a href=\"https://help.aliyun.com/document_detail/251838.html\">https://help.aliyun.com/document_detail&#x2F;251838.html</a></p>\n</li>\n<li><p> <strong>Prometheus</strong> IM</p>\n<img data-src=\"/posts/9a8h/10.png\" class>\n</li>\n<li><p> <strong>ARMS  Prometheus  Prometheus</strong> <strong>Prometheus</strong> </p>\n<img data-src=\"/posts/9a8h/11.png\" class>\n<img data-src=\"/posts/9a8h/12.png\" class>\n</li>\n<li><p> <strong>ARMS    </strong> <strong></strong> </p>\n<img data-src=\"/posts/9a8h/13.png\" class>\n<img data-src=\"/posts/9a8h/14.png\" class></li>\n</ul>\n<h4 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h4><ul>\n<li>PromQL sum by (queue)(rabbitmq_queue_messages_unacknowledged{app&#x3D;rabbi-exporter}) &gt;&#x3D; 0</li>\n</ul>\n<p></p>\n<ul>\n<li><p> <strong>ARMS    &#x2F;</strong> </p>\n<img data-src=\"/posts/9a8h/15.png\" class>\n<img data-src=\"/posts/9a8h/16.png\" class>\n</li>\n<li><p></p>\n<img data-src=\"/posts/9a8h/17.png\" class></li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>ACK  RabbitMQ</li>\n</ul>"},{"title":"Kubernetes - kube-eventer ","abbrlink":"2ead","date":"2022-09-30T13:42:20.000Z","_content":"### \n\n#### \n\n+ Kubernetes  Normal Warning\n\n+ kube-eventer Alicloud Kubernetes Kubernetes 1\n\n+ https://github.com/AliyunContainerService/kube-eventer\n\n#### \n\n|                                |                          |                |\n| -------------------------------- | -------------------------- | ---------------- |\n| Kubernetes                            |                        |  minikube  |\n| kube-eventer                     |  Kubernetes                 |           |\n| Kafka / Elasticsearch / influxDB |                  |  Kafka   |\n| kube-eventer-py                  |  telegram  |             |\n\n<!--more-->\n### \n\n#### 1minikube \n\nhttps://minikube.sigs.k8s.io/docs/start/\n\n#### 2Kafka\n\n helm  Kafka\n\n```shell\n#  helm \nhelm repo add bitnami https://charts.bitnami.com/bitnami\n\n#  Kafka chart \nmkdir /opt/helm_chats && cd /opt/helm_chats \nhelm pull bitnami/kafka && tar xf kafka-18.2.0.tgz && rm -rf kafka-18.2.0.tgz\n\n#  Kafka\n# \ncat ./values.yaml  \n...\n...\n# Kafka  Configmap \nconfig: |-\n  broker.id=0\n  listeners=INTERNAL://:9093,CLIENT://:9092\n  advertised.listeners=INTERNAL://yakir-kafka-0.yakir-kafka-headless.default.svc.cluster.local:9093,CLIENT://yakir-kafka-0.yakir-kafka-headless.default.svc.cluster.local:9092\n  listener.security.protocol.map=INTERNAL:PLAINTEXT,CLIENT:PLAINTEXT\n  num.network.threads=5\n  num.io.threads=10\n  socket.send.buffer.bytes=102400\n  socket.receive.buffer.bytes=102400\n  socket.request.max.bytes=104857600\n  log.dirs=/bitnami/kafka/data\n  num.partitions=1\n  num.recovery.threads.per.data.dir=1\n  offsets.topic.replication.factor=1\n  transaction.state.log.replication.factor=1\n  transaction.state.log.min.isr=1\n  log.flush.interval.messages=10000\n  log.flush.interval.ms=1000\n  log.retention.hours=168   # 7\n  log.retention.bytes=1073741824\n  log.segment.bytes=1073741824\n  log.retention.check.interval.ms=300000\n  zookeeper.connect=yakir-kafka-zookeeper\n  zookeeper.connection.timeout.ms=6000\n  group.initial.rebalance.delay.ms=0\n  allow.everyone.if.no.acl.found=true\n  auto.create.topics.enable=true\n  default.replication.factor=1\n  delete.topic.enable=true   #  topic \n  inter.broker.listener.name=INTERNAL\n  log.retention.check.intervals.ms=300000\n  max.partition.fetch.bytes=1048576\n  max.request.size=1048576\n  message.max.bytes=1000012\n  sasl.enabled.mechanisms=PLAIN,SCRAM-SHA-256,SCRAM-SHA-512\n  sasl.mechanism.inter.broker.protocol=\n  super.users=User:admin\n...\n...\npersistence:\n  enabled: true\n  existingClaim: \"\"\n  storageClass: \"standard\"   # \n...\n...\nzookeeper:\n  enabled: true\n  replicaCount: 1\n  auth:\n    client:\n      enabled: false\n      clientUser: \"\"\n      clientPassword: \"\"\n      serverUsers: \"\"\n      serverPasswords: \"\"\n  persistence:\n    enabled: true\n    storageClass: \"standard\"   # miniku \n\n\n# \nhelm install yakir-kafka .\n#  Running \nkubectl get pod  \nNAME                                  READY   STATUS    RESTARTS       AGE\nyakir-kafka-0                         1/1     Running   0              171m\nyakir-kafka-zookeeper-0               1/1     Running   6 (168m ago)   10d\n```\n\n#### 3kube-eventer \n\n+  YAML \n\n```shell\ncat > kube-eventer.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    name: kube-eventer\n  name: kube-eventer\n  namespace: kube-system\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: kube-eventer\n  template:\n    metadata:\n      labels:\n        app: kube-eventer\n      annotations:      \n        #scheduler.alpha.kubernetes.io/critical-pod: ''\n        priorityClassName: ''\n    spec:\n      dnsPolicy: ClusterFirstWithHostNet\n      serviceAccount: kube-eventer\n      containers:\n        - image: registry.aliyuncs.com/acs/kube-eventer-amd64:v1.2.0-484d9cd-aliyun\n          name: kube-eventer\n          command:\n            - \"/kube-eventer\"\n            - \"--source=kubernetes:https://kubernetes.default\"\n            # \n            - --sink=kafka:?brokers=yakir-kafka-headless.default:9092&eventstopic=yakirtopic\n          env:\n          # If TZ is assigned, set the TZ value as the time zone\n          - name: TZ\n            value: \"Asia/Shanghai\" \n          volumeMounts:\n            - name: localtime\n              mountPath: /etc/localtime\n              readOnly: true\n            - name: zoneinfo\n              mountPath: /usr/share/zoneinfo\n              readOnly: true\n          resources:\n            requests:\n              cpu: 100m\n              memory: 100Mi\n            limits:\n              cpu: 500m\n              memory: 250Mi\n      volumes:\n        - name: localtime\n          hostPath:\n            path: /etc/localtime\n        - name: zoneinfo\n          hostPath:\n            path: /usr/share/zoneinfo\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: kube-eventer\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n      - events\n    verbs:\n      - get\n      - list\n      - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: kube-eventer\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: kube-eventer\nsubjects:\n  - kind: ServiceAccount\n    name: kube-eventer\n    namespace: kube-system\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: kube-eventer\n  namespace: kube-system\nEOF\n\n#  kube-system namespace \nkubectl apply -f kube-eventer.yaml\n# \nkubectl get pod -n kube-system\nNAME                               READY   STATUS    RESTARTS        AGE\nkube-eventer-69455778cd-cvr9w      1/1     Running   0               8d\n```\n\n#### 4 telegram\n\n+ telegram \n\n> \n> \n> 1https://cloud.tencent.com/developer/article/1835051\n> \n> 2telegram python SDKhttps://github.com/python-telegram-bot/python-telegram-bot\n\n+ Python \n\n```python\n# telegrambot.py \nimport asyncio\nimport telegram\nimport json\nimport traceback\n\nTOKEN = \"xxxxxx\"\nchat_id = \"-xxx\"\nbot = telegram.Bot(token=TOKEN)\n\n\nclass FilterMsg(object):\n    def __init__(self, text):\n        self.event_value = json.loads(text['EventValue'])\n\n        self.data = dict()\n        self.data['kind'] = self.event_value['involvedObject']['kind']\n        self.data['namespace'] = self.event_value['involvedObject']['namespace']\n        self.data['reason'] = self.event_value['reason']\n        self.data['message'] = self.event_value['message']\n        self.data['first_timestamp'] = self.event_value['firstTimestamp']\n        self.data['last_timestamp'] = self.event_value['lastTimestamp']\n        self.data['count'] = self.event_value['count']\n        self.data['type'] = self.event_value['type']\n        self.data['event_time'] = self.event_value['eventTime']\n        self.data['pod_hostname'] = text['EventTags']['hostname']\n        self.data['pod_name'] = text['EventTags']['pod_name']\n\n    def convert(self):\n        msg_markdown = f\"\"\"\n        *Kubernetes Cluster Event*\n    `Kind: {self.data['kind']}`\n    `Namescodeace: {self.data['namespace']}`\n    `Reason: {self.data['reason']}`\n    `Timestamp: {self.data['first_timestamp']} to {self.data['last_timestamp']}`\n    `Count: {self.data['count']}`\n    `EventType: {self.data['type']}`\n    `EventTime: {self.data['event_time']}`\n    `PodHostname: {self.data['pod_hostname']}`\n    `PodName: {self.data['pod_name']}`\n    `Message: {self.data['message']}`\n\"\"\"\n        return msg_markdown\n\nasync def send_message(text):\n    try:\n        # Core: get message from Kafka,and filter message\n        convert_text = json.loads(text.decode('utf8').replace('\\\\n', ''))\n        msg_instance = FilterMsg(convert_text)\n        msg = msg_instance.convert()\n        send_result = bot.send_message(chat_id=chat_id, text=msg, parse_mode='MarkdownV2')\n        return send_result\n    except KeyError as e:\n        msg = \"Unknow message..\"\n        send_result = bot.send_message(chat_id=chat_id, text=msg)\n        return send_result\n    except Exception as e:\n        print(e.__str__())\n        #traceback.print_exc()\n        print('send message to telegram failed,please check.')\n\nif __name__ == '__main__':\n    text = b''\n    text = json.loads(text.decode('utf8').replace('\\\\n', ''))\n    send_result = asyncio.run(send_message(text))\n    print(send_result)\n\n# get_events.py \nfrom kafka import KafkaConsumer, TopicPartition\nfrom telegrambot import send_message\nimport asyncio\n\nclass KConsumer(object):\n    \"\"\"kafka consumer instance\"\"\"\n    def __init__(self, topic, group_id, bootstrap_servers, auto_offset_reset, enable_auto_commit=False):\n        \"\"\"\n        :param topic:\n        :param group_id:\n        :param bootstrap_servers:\n        \"\"\"\n        self.consumer = KafkaConsumer(\n            topic,\n            bootstrap_servers=bootstrap_servers,\n            group_id=group_id,\n            auto_offset_reset=auto_offset_reset,\n            enable_auto_commit=enable_auto_commit,\n            consumer_timeout_ms=10000\n        )\n        self.tp = TopicPartition(topic, 0)\n\n    def start_consumer(self):\n        while True:\n            try:\n                # 30s commit  offset\n                msg_list_dict = self.consumer.poll(timeout_ms=30000)\n                for tp, msg_list in msg_list_dict.items():\n                    for msg in msg_list: \n                        ### core operate,send message to telegram\n                        send_result = asyncio.run(send_message(msg.value))\n                        print(send_result)\n                #print(f\"current offset is {self.consumer.position(tp)}\")\n                self.consumer.commit()\n            except Exception as e:\n                print('ERROR: get cluster events failed,please check.')\n\n    def close_consumer(self):\n        try:\n            self.consumer.unsubscribe()\n            self.consumer.close()\n        except:\n            print(\"consumer stop failed,please check.\")\n\nif __name__ == '__main__':\n    # env\n    topic = 'yakirtopic'\n    bootstrap_servers = 'yakir-kafka-headless:9092'\n    group_id = 'yakir1.group'\n    auto_offset_reset = 'earliest'\n    enable_auto_commit = False\n\n    # start\n    consumer = KConsumer(topic, group_id=group_id, bootstrap_servers=bootstrap_servers, auto_offset_reset=auto_offset_reset, enable_auto_commit=enable_auto_commit)\n    consumer.start_consumer()\n    # stop\n    #consumer.close_consumer()\n```\n\n+ Dockerfile \n\n```dockerfile\nFROM python:3.8\n\n# Set an environment variable \nENV APP /app\n\n# Create the directory\nRUN mkdir $APP\nWORKDIR $APP\n\n# Expose the port uWSGI will listen on\n#EXPOSE 5000\n\n# Copy the requirements file in order to install\n# Python dependencies\n#COPY requirements.txt .\nCOPY . .\nRUN pip install --upgrade pip && pip install --no-cache-dir -r requirements.txt\n\n# Finally, we run uWSGI with the ini file\n#CMD [\"sleep\", \"infinity\"]\nCMD [\"python\", \"get_events.py\"]\n```\n\n+ \n\n```shell\n# \ncd /opt/yakir/kube-eventer-py/ && mkdir APP-META\nrm -f APP-META/*.py && cp *.py APP-META/\n\ncd APP-META && build -t kube-eventer-telegrambot:latest .\n\n# docker  kubectl\ncat > kube-eventer-telegrambot.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: yakir-kube-eventer\n  namespace: default\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: yakir-kube-eventer\n  template:\n    metadata:\n      labels:\n        app: yakir-kube-eventer\n    spec:\n      containers:\n        - image: kube-eventer-telegrambot:latest\n          name: yakir-kube-eventer\n          env:\n          - name: TZ\n            value: \"Asia/Shanghai\" \n      volumes:\n        - name: localtime\n          hostPath:\n            path: /etc/localtime\n        - name: zoneinfo\n          hostPath:\n            path: /usr/share/zoneinfo\nEOF\n# \nkubectl apply -f kube-eventer-telegrambot.yaml\nkubectl get pod                               \nNAME                                  READY   STATUS    RESTARTS        AGE\nyakir-kube-eventer-589bf867bc-tgs5l   1/1     Running   0               27\n```\n\n+ \n\n{% asset_img telegram.png %}\n\n### \nxxxx\n","source":"_posts/kube-eventer.md","raw":"---\ntitle: Kubernetes - kube-eventer \ncategories:\n  - CNCF\ntags:\n  - Kubernetes\nabbrlink: 2ead\ndate: 2022-09-30 21:42:20\n---\n### \n\n#### \n\n+ Kubernetes  Normal Warning\n\n+ kube-eventer Alicloud Kubernetes Kubernetes 1\n\n+ https://github.com/AliyunContainerService/kube-eventer\n\n#### \n\n|                                |                          |                |\n| -------------------------------- | -------------------------- | ---------------- |\n| Kubernetes                            |                        |  minikube  |\n| kube-eventer                     |  Kubernetes                 |           |\n| Kafka / Elasticsearch / influxDB |                  |  Kafka   |\n| kube-eventer-py                  |  telegram  |             |\n\n<!--more-->\n### \n\n#### 1minikube \n\nhttps://minikube.sigs.k8s.io/docs/start/\n\n#### 2Kafka\n\n helm  Kafka\n\n```shell\n#  helm \nhelm repo add bitnami https://charts.bitnami.com/bitnami\n\n#  Kafka chart \nmkdir /opt/helm_chats && cd /opt/helm_chats \nhelm pull bitnami/kafka && tar xf kafka-18.2.0.tgz && rm -rf kafka-18.2.0.tgz\n\n#  Kafka\n# \ncat ./values.yaml  \n...\n...\n# Kafka  Configmap \nconfig: |-\n  broker.id=0\n  listeners=INTERNAL://:9093,CLIENT://:9092\n  advertised.listeners=INTERNAL://yakir-kafka-0.yakir-kafka-headless.default.svc.cluster.local:9093,CLIENT://yakir-kafka-0.yakir-kafka-headless.default.svc.cluster.local:9092\n  listener.security.protocol.map=INTERNAL:PLAINTEXT,CLIENT:PLAINTEXT\n  num.network.threads=5\n  num.io.threads=10\n  socket.send.buffer.bytes=102400\n  socket.receive.buffer.bytes=102400\n  socket.request.max.bytes=104857600\n  log.dirs=/bitnami/kafka/data\n  num.partitions=1\n  num.recovery.threads.per.data.dir=1\n  offsets.topic.replication.factor=1\n  transaction.state.log.replication.factor=1\n  transaction.state.log.min.isr=1\n  log.flush.interval.messages=10000\n  log.flush.interval.ms=1000\n  log.retention.hours=168   # 7\n  log.retention.bytes=1073741824\n  log.segment.bytes=1073741824\n  log.retention.check.interval.ms=300000\n  zookeeper.connect=yakir-kafka-zookeeper\n  zookeeper.connection.timeout.ms=6000\n  group.initial.rebalance.delay.ms=0\n  allow.everyone.if.no.acl.found=true\n  auto.create.topics.enable=true\n  default.replication.factor=1\n  delete.topic.enable=true   #  topic \n  inter.broker.listener.name=INTERNAL\n  log.retention.check.intervals.ms=300000\n  max.partition.fetch.bytes=1048576\n  max.request.size=1048576\n  message.max.bytes=1000012\n  sasl.enabled.mechanisms=PLAIN,SCRAM-SHA-256,SCRAM-SHA-512\n  sasl.mechanism.inter.broker.protocol=\n  super.users=User:admin\n...\n...\npersistence:\n  enabled: true\n  existingClaim: \"\"\n  storageClass: \"standard\"   # \n...\n...\nzookeeper:\n  enabled: true\n  replicaCount: 1\n  auth:\n    client:\n      enabled: false\n      clientUser: \"\"\n      clientPassword: \"\"\n      serverUsers: \"\"\n      serverPasswords: \"\"\n  persistence:\n    enabled: true\n    storageClass: \"standard\"   # miniku \n\n\n# \nhelm install yakir-kafka .\n#  Running \nkubectl get pod  \nNAME                                  READY   STATUS    RESTARTS       AGE\nyakir-kafka-0                         1/1     Running   0              171m\nyakir-kafka-zookeeper-0               1/1     Running   6 (168m ago)   10d\n```\n\n#### 3kube-eventer \n\n+  YAML \n\n```shell\ncat > kube-eventer.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    name: kube-eventer\n  name: kube-eventer\n  namespace: kube-system\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: kube-eventer\n  template:\n    metadata:\n      labels:\n        app: kube-eventer\n      annotations:      \n        #scheduler.alpha.kubernetes.io/critical-pod: ''\n        priorityClassName: ''\n    spec:\n      dnsPolicy: ClusterFirstWithHostNet\n      serviceAccount: kube-eventer\n      containers:\n        - image: registry.aliyuncs.com/acs/kube-eventer-amd64:v1.2.0-484d9cd-aliyun\n          name: kube-eventer\n          command:\n            - \"/kube-eventer\"\n            - \"--source=kubernetes:https://kubernetes.default\"\n            # \n            - --sink=kafka:?brokers=yakir-kafka-headless.default:9092&eventstopic=yakirtopic\n          env:\n          # If TZ is assigned, set the TZ value as the time zone\n          - name: TZ\n            value: \"Asia/Shanghai\" \n          volumeMounts:\n            - name: localtime\n              mountPath: /etc/localtime\n              readOnly: true\n            - name: zoneinfo\n              mountPath: /usr/share/zoneinfo\n              readOnly: true\n          resources:\n            requests:\n              cpu: 100m\n              memory: 100Mi\n            limits:\n              cpu: 500m\n              memory: 250Mi\n      volumes:\n        - name: localtime\n          hostPath:\n            path: /etc/localtime\n        - name: zoneinfo\n          hostPath:\n            path: /usr/share/zoneinfo\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: kube-eventer\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n      - events\n    verbs:\n      - get\n      - list\n      - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: kube-eventer\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: kube-eventer\nsubjects:\n  - kind: ServiceAccount\n    name: kube-eventer\n    namespace: kube-system\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: kube-eventer\n  namespace: kube-system\nEOF\n\n#  kube-system namespace \nkubectl apply -f kube-eventer.yaml\n# \nkubectl get pod -n kube-system\nNAME                               READY   STATUS    RESTARTS        AGE\nkube-eventer-69455778cd-cvr9w      1/1     Running   0               8d\n```\n\n#### 4 telegram\n\n+ telegram \n\n> \n> \n> 1https://cloud.tencent.com/developer/article/1835051\n> \n> 2telegram python SDKhttps://github.com/python-telegram-bot/python-telegram-bot\n\n+ Python \n\n```python\n# telegrambot.py \nimport asyncio\nimport telegram\nimport json\nimport traceback\n\nTOKEN = \"xxxxxx\"\nchat_id = \"-xxx\"\nbot = telegram.Bot(token=TOKEN)\n\n\nclass FilterMsg(object):\n    def __init__(self, text):\n        self.event_value = json.loads(text['EventValue'])\n\n        self.data = dict()\n        self.data['kind'] = self.event_value['involvedObject']['kind']\n        self.data['namespace'] = self.event_value['involvedObject']['namespace']\n        self.data['reason'] = self.event_value['reason']\n        self.data['message'] = self.event_value['message']\n        self.data['first_timestamp'] = self.event_value['firstTimestamp']\n        self.data['last_timestamp'] = self.event_value['lastTimestamp']\n        self.data['count'] = self.event_value['count']\n        self.data['type'] = self.event_value['type']\n        self.data['event_time'] = self.event_value['eventTime']\n        self.data['pod_hostname'] = text['EventTags']['hostname']\n        self.data['pod_name'] = text['EventTags']['pod_name']\n\n    def convert(self):\n        msg_markdown = f\"\"\"\n        *Kubernetes Cluster Event*\n    `Kind: {self.data['kind']}`\n    `Namescodeace: {self.data['namespace']}`\n    `Reason: {self.data['reason']}`\n    `Timestamp: {self.data['first_timestamp']} to {self.data['last_timestamp']}`\n    `Count: {self.data['count']}`\n    `EventType: {self.data['type']}`\n    `EventTime: {self.data['event_time']}`\n    `PodHostname: {self.data['pod_hostname']}`\n    `PodName: {self.data['pod_name']}`\n    `Message: {self.data['message']}`\n\"\"\"\n        return msg_markdown\n\nasync def send_message(text):\n    try:\n        # Core: get message from Kafka,and filter message\n        convert_text = json.loads(text.decode('utf8').replace('\\\\n', ''))\n        msg_instance = FilterMsg(convert_text)\n        msg = msg_instance.convert()\n        send_result = bot.send_message(chat_id=chat_id, text=msg, parse_mode='MarkdownV2')\n        return send_result\n    except KeyError as e:\n        msg = \"Unknow message..\"\n        send_result = bot.send_message(chat_id=chat_id, text=msg)\n        return send_result\n    except Exception as e:\n        print(e.__str__())\n        #traceback.print_exc()\n        print('send message to telegram failed,please check.')\n\nif __name__ == '__main__':\n    text = b''\n    text = json.loads(text.decode('utf8').replace('\\\\n', ''))\n    send_result = asyncio.run(send_message(text))\n    print(send_result)\n\n# get_events.py \nfrom kafka import KafkaConsumer, TopicPartition\nfrom telegrambot import send_message\nimport asyncio\n\nclass KConsumer(object):\n    \"\"\"kafka consumer instance\"\"\"\n    def __init__(self, topic, group_id, bootstrap_servers, auto_offset_reset, enable_auto_commit=False):\n        \"\"\"\n        :param topic:\n        :param group_id:\n        :param bootstrap_servers:\n        \"\"\"\n        self.consumer = KafkaConsumer(\n            topic,\n            bootstrap_servers=bootstrap_servers,\n            group_id=group_id,\n            auto_offset_reset=auto_offset_reset,\n            enable_auto_commit=enable_auto_commit,\n            consumer_timeout_ms=10000\n        )\n        self.tp = TopicPartition(topic, 0)\n\n    def start_consumer(self):\n        while True:\n            try:\n                # 30s commit  offset\n                msg_list_dict = self.consumer.poll(timeout_ms=30000)\n                for tp, msg_list in msg_list_dict.items():\n                    for msg in msg_list: \n                        ### core operate,send message to telegram\n                        send_result = asyncio.run(send_message(msg.value))\n                        print(send_result)\n                #print(f\"current offset is {self.consumer.position(tp)}\")\n                self.consumer.commit()\n            except Exception as e:\n                print('ERROR: get cluster events failed,please check.')\n\n    def close_consumer(self):\n        try:\n            self.consumer.unsubscribe()\n            self.consumer.close()\n        except:\n            print(\"consumer stop failed,please check.\")\n\nif __name__ == '__main__':\n    # env\n    topic = 'yakirtopic'\n    bootstrap_servers = 'yakir-kafka-headless:9092'\n    group_id = 'yakir1.group'\n    auto_offset_reset = 'earliest'\n    enable_auto_commit = False\n\n    # start\n    consumer = KConsumer(topic, group_id=group_id, bootstrap_servers=bootstrap_servers, auto_offset_reset=auto_offset_reset, enable_auto_commit=enable_auto_commit)\n    consumer.start_consumer()\n    # stop\n    #consumer.close_consumer()\n```\n\n+ Dockerfile \n\n```dockerfile\nFROM python:3.8\n\n# Set an environment variable \nENV APP /app\n\n# Create the directory\nRUN mkdir $APP\nWORKDIR $APP\n\n# Expose the port uWSGI will listen on\n#EXPOSE 5000\n\n# Copy the requirements file in order to install\n# Python dependencies\n#COPY requirements.txt .\nCOPY . .\nRUN pip install --upgrade pip && pip install --no-cache-dir -r requirements.txt\n\n# Finally, we run uWSGI with the ini file\n#CMD [\"sleep\", \"infinity\"]\nCMD [\"python\", \"get_events.py\"]\n```\n\n+ \n\n```shell\n# \ncd /opt/yakir/kube-eventer-py/ && mkdir APP-META\nrm -f APP-META/*.py && cp *.py APP-META/\n\ncd APP-META && build -t kube-eventer-telegrambot:latest .\n\n# docker  kubectl\ncat > kube-eventer-telegrambot.yaml << \"EOF\"\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: yakir-kube-eventer\n  namespace: default\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: yakir-kube-eventer\n  template:\n    metadata:\n      labels:\n        app: yakir-kube-eventer\n    spec:\n      containers:\n        - image: kube-eventer-telegrambot:latest\n          name: yakir-kube-eventer\n          env:\n          - name: TZ\n            value: \"Asia/Shanghai\" \n      volumes:\n        - name: localtime\n          hostPath:\n            path: /etc/localtime\n        - name: zoneinfo\n          hostPath:\n            path: /usr/share/zoneinfo\nEOF\n# \nkubectl apply -f kube-eventer-telegrambot.yaml\nkubectl get pod                               \nNAME                                  READY   STATUS    RESTARTS        AGE\nyakir-kube-eventer-589bf867bc-tgs5l   1/1     Running   0               27\n```\n\n+ \n\n{% asset_img telegram.png %}\n\n### \nxxxx\n","slug":"kube-eventer","published":1,"updated":"2024-01-21T15:28:43.156Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zq001zs0nj772x7w9v","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><p>Kubernetes  Normal Warning</p>\n</li>\n<li><p>kube-eventer Alicloud Kubernetes Kubernetes 1</p>\n</li>\n<li><p><a href=\"https://github.com/AliyunContainerService/kube-eventer\">https://github.com/AliyunContainerService/kube-eventer</a></p>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Kubernetes </td>\n<td></td>\n<td> minikube </td>\n</tr>\n<tr>\n<td>kube-eventer</td>\n<td> Kubernetes </td>\n<td></td>\n</tr>\n<tr>\n<td>Kafka &#x2F; Elasticsearch &#x2F; influxDB</td>\n<td></td>\n<td> Kafka</td>\n</tr>\n<tr>\n<td>kube-eventer-py</td>\n<td> telegram </td>\n<td></td>\n</tr>\n</tbody></table>\n<span id=\"more\"></span>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1minikube-\"><a href=\"#1minikube-\" class=\"headerlink\" title=\"1minikube \"></a>1minikube </h4><p><a href=\"https://minikube.sigs.k8s.io/docs/start/\">https://minikube.sigs.k8s.io/docs/start/</a></p>\n<h4 id=\"2Kafka\"><a href=\"#2Kafka\" class=\"headerlink\" title=\"2Kafka\"></a>2Kafka</h4><p> helm  Kafka</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> helm </span></span><br><span class=\"line\">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Kafka chart </span></span><br><span class=\"line\">mkdir /opt/helm_chats &amp;&amp; cd /opt/helm_chats </span><br><span class=\"line\">helm pull bitnami/kafka &amp;&amp; tar xf kafka-18.2.0.tgz &amp;&amp; rm -rf kafka-18.2.0.tgz</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Kafka</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat ./values.yaml  </span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Kafka  Configmap </span></span><br><span class=\"line\">config: |-</span><br><span class=\"line\">  broker.id=0</span><br><span class=\"line\">  listeners=INTERNAL://:9093,CLIENT://:9092</span><br><span class=\"line\">  advertised.listeners=INTERNAL://yakir-kafka-0.yakir-kafka-headless.default.svc.cluster.local:9093,CLIENT://yakir-kafka-0.yakir-kafka-headless.default.svc.cluster.local:9092</span><br><span class=\"line\">  listener.security.protocol.map=INTERNAL:PLAINTEXT,CLIENT:PLAINTEXT</span><br><span class=\"line\">  num.network.threads=5</span><br><span class=\"line\">  num.io.threads=10</span><br><span class=\"line\">  socket.send.buffer.bytes=102400</span><br><span class=\"line\">  socket.receive.buffer.bytes=102400</span><br><span class=\"line\">  socket.request.max.bytes=104857600</span><br><span class=\"line\">  log.dirs=/bitnami/kafka/data</span><br><span class=\"line\">  num.partitions=1</span><br><span class=\"line\">  num.recovery.threads.per.data.dir=1</span><br><span class=\"line\">  offsets.topic.replication.factor=1</span><br><span class=\"line\">  transaction.state.log.replication.factor=1</span><br><span class=\"line\">  transaction.state.log.min.isr=1</span><br><span class=\"line\">  log.flush.interval.messages=10000</span><br><span class=\"line\">  log.flush.interval.ms=1000</span><br><span class=\"line\">  log.retention.hours=168   # 7</span><br><span class=\"line\">  log.retention.bytes=1073741824</span><br><span class=\"line\">  log.segment.bytes=1073741824</span><br><span class=\"line\">  log.retention.check.interval.ms=300000</span><br><span class=\"line\">  zookeeper.connect=yakir-kafka-zookeeper</span><br><span class=\"line\">  zookeeper.connection.timeout.ms=6000</span><br><span class=\"line\">  group.initial.rebalance.delay.ms=0</span><br><span class=\"line\">  allow.everyone.if.no.acl.found=true</span><br><span class=\"line\">  auto.create.topics.enable=true</span><br><span class=\"line\">  default.replication.factor=1</span><br><span class=\"line\">  delete.topic.enable=true   #  topic </span><br><span class=\"line\">  inter.broker.listener.name=INTERNAL</span><br><span class=\"line\">  log.retention.check.intervals.ms=300000</span><br><span class=\"line\">  max.partition.fetch.bytes=1048576</span><br><span class=\"line\">  max.request.size=1048576</span><br><span class=\"line\">  message.max.bytes=1000012</span><br><span class=\"line\">  sasl.enabled.mechanisms=PLAIN,SCRAM-SHA-256,SCRAM-SHA-512</span><br><span class=\"line\">  sasl.mechanism.inter.broker.protocol=</span><br><span class=\"line\">  super.users=User:admin</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">persistence:</span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  existingClaim: &quot;&quot;</span><br><span class=\"line\">  storageClass: &quot;standard&quot;   # </span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">zookeeper:</span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  replicaCount: 1</span><br><span class=\"line\">  auth:</span><br><span class=\"line\">    client:</span><br><span class=\"line\">      enabled: false</span><br><span class=\"line\">      clientUser: &quot;&quot;</span><br><span class=\"line\">      clientPassword: &quot;&quot;</span><br><span class=\"line\">      serverUsers: &quot;&quot;</span><br><span class=\"line\">      serverPasswords: &quot;&quot;</span><br><span class=\"line\">  persistence:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    storageClass: &quot;standard&quot;   # miniku </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">helm install yakir-kafka .</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Running </span></span><br><span class=\"line\">kubectl get pod  </span><br><span class=\"line\">NAME                                  READY   STATUS    RESTARTS       AGE</span><br><span class=\"line\">yakir-kafka-0                         1/1     Running   0              171m</span><br><span class=\"line\">yakir-kafka-zookeeper-0               1/1     Running   6 (168m ago)   10d</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3kube-eventer-\"><a href=\"#3kube-eventer-\" class=\"headerlink\" title=\"3kube-eventer \"></a>3kube-eventer </h4><ul>\n<li> YAML </li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; kube-eventer.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: kube-eventer</span><br><span class=\"line\">  name: kube-eventer</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: kube-eventer</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: kube-eventer</span><br><span class=\"line\">      annotations:      </span><br><span class=\"line\">        #scheduler.alpha.kubernetes.io/critical-pod: &#x27;&#x27;</span><br><span class=\"line\">        priorityClassName: &#x27;&#x27;</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      dnsPolicy: ClusterFirstWithHostNet</span><br><span class=\"line\">      serviceAccount: kube-eventer</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - image: registry.aliyuncs.com/acs/kube-eventer-amd64:v1.2.0-484d9cd-aliyun</span><br><span class=\"line\">          name: kube-eventer</span><br><span class=\"line\">          command:</span><br><span class=\"line\">            - &quot;/kube-eventer&quot;</span><br><span class=\"line\">            - &quot;--source=kubernetes:https://kubernetes.default&quot;</span><br><span class=\"line\">            # </span><br><span class=\"line\">            - --sink=kafka:?brokers=yakir-kafka-headless.default:9092&amp;eventstopic=yakirtopic</span><br><span class=\"line\">          env:</span><br><span class=\"line\">          # If TZ is assigned, set the TZ value as the time zone</span><br><span class=\"line\">          - name: TZ</span><br><span class=\"line\">            value: &quot;Asia/Shanghai&quot; </span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - name: localtime</span><br><span class=\"line\">              mountPath: /etc/localtime</span><br><span class=\"line\">              readOnly: true</span><br><span class=\"line\">            - name: zoneinfo</span><br><span class=\"line\">              mountPath: /usr/share/zoneinfo</span><br><span class=\"line\">              readOnly: true</span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            requests:</span><br><span class=\"line\">              cpu: 100m</span><br><span class=\"line\">              memory: 100Mi</span><br><span class=\"line\">            limits:</span><br><span class=\"line\">              cpu: 500m</span><br><span class=\"line\">              memory: 250Mi</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: localtime</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /etc/localtime</span><br><span class=\"line\">        - name: zoneinfo</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /usr/share/zoneinfo</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-eventer</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - configmaps</span><br><span class=\"line\">      - events</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">      - list</span><br><span class=\"line\">      - watch</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-eventer</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: kube-eventer</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: kube-eventer</span><br><span class=\"line\">    namespace: kube-system</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-eventer</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> kube-system namespace </span></span><br><span class=\"line\">kubectl apply -f kube-eventer.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get pod -n kube-system</span><br><span class=\"line\">NAME                               READY   STATUS    RESTARTS        AGE</span><br><span class=\"line\">kube-eventer-69455778cd-cvr9w      1/1     Running   0               8d</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-telegram\"><a href=\"#4-telegram\" class=\"headerlink\" title=\"4 telegram\"></a>4 telegram</h4><ul>\n<li>telegram </li>\n</ul>\n<blockquote>\n<p></p>\n<p>1<a href=\"https://cloud.tencent.com/developer/article/1835051\">https://cloud.tencent.com/developer/article/1835051</a></p>\n<p>2telegram python SDK<a href=\"https://github.com/python-telegram-bot/python-telegram-bot\">https://github.com/python-telegram-bot/python-telegram-bot</a></p>\n</blockquote>\n<ul>\n<li>Python </li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># telegrambot.py </span></span><br><span class=\"line\"><span class=\"keyword\">import</span> asyncio</span><br><span class=\"line\"><span class=\"keyword\">import</span> telegram</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">import</span> traceback</span><br><span class=\"line\"></span><br><span class=\"line\">TOKEN = <span class=\"string\">&quot;xxxxxx&quot;</span></span><br><span class=\"line\">chat_id = <span class=\"string\">&quot;-xxx&quot;</span></span><br><span class=\"line\">bot = telegram.Bot(token=TOKEN)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FilterMsg</span>(<span class=\"title class_ inherited__\">object</span>):</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self, text</span>):</span><br><span class=\"line\">        self.event_value = json.loads(text[<span class=\"string\">&#x27;EventValue&#x27;</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">        self.data = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;kind&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;involvedObject&#x27;</span>][<span class=\"string\">&#x27;kind&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;namespace&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;involvedObject&#x27;</span>][<span class=\"string\">&#x27;namespace&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;reason&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;reason&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;message&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;message&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;first_timestamp&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;firstTimestamp&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;last_timestamp&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;lastTimestamp&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;count&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;count&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;type&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;type&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;event_time&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;eventTime&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;pod_hostname&#x27;</span>] = text[<span class=\"string\">&#x27;EventTags&#x27;</span>][<span class=\"string\">&#x27;hostname&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;pod_name&#x27;</span>] = text[<span class=\"string\">&#x27;EventTags&#x27;</span>][<span class=\"string\">&#x27;pod_name&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">convert</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        msg_markdown = <span class=\"string\">f&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">        *Kubernetes Cluster Event*</span></span><br><span class=\"line\"><span class=\"string\">    `Kind: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;kind&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `Namescodeace: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;namespace&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `Reason: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;reason&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `Timestamp: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;first_timestamp&#x27;</span>]&#125;</span> to <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;last_timestamp&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `Count: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;count&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `EventType: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;type&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `EventTime: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;event_time&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `PodHostname: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;pod_hostname&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `PodName: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;pod_name&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `Message: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;message&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> msg_markdown</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">send_message</span>(<span class=\"params\">text</span>):</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        <span class=\"comment\"># Core: get message from Kafka,and filter message</span></span><br><span class=\"line\">        convert_text = json.loads(text.decode(<span class=\"string\">&#x27;utf8&#x27;</span>).replace(<span class=\"string\">&#x27;\\\\n&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>))</span><br><span class=\"line\">        msg_instance = FilterMsg(convert_text)</span><br><span class=\"line\">        msg = msg_instance.convert()</span><br><span class=\"line\">        send_result = bot.send_message(chat_id=chat_id, text=msg, parse_mode=<span class=\"string\">&#x27;MarkdownV2&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> send_result</span><br><span class=\"line\">    <span class=\"keyword\">except</span> KeyError <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">        msg = <span class=\"string\">&quot;Unknow message..&quot;</span></span><br><span class=\"line\">        send_result = bot.send_message(chat_id=chat_id, text=msg)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> send_result</span><br><span class=\"line\">    <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(e.__str__())</span><br><span class=\"line\">        <span class=\"comment\">#traceback.print_exc()</span></span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;send message to telegram failed,please check.&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    text = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">    text = json.loads(text.decode(<span class=\"string\">&#x27;utf8&#x27;</span>).replace(<span class=\"string\">&#x27;\\\\n&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>))</span><br><span class=\"line\">    send_result = asyncio.run(send_message(text))</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(send_result)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># get_events.py </span></span><br><span class=\"line\"><span class=\"keyword\">from</span> kafka <span class=\"keyword\">import</span> KafkaConsumer, TopicPartition</span><br><span class=\"line\"><span class=\"keyword\">from</span> telegrambot <span class=\"keyword\">import</span> send_message</span><br><span class=\"line\"><span class=\"keyword\">import</span> asyncio</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">KConsumer</span>(<span class=\"title class_ inherited__\">object</span>):</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;kafka consumer instance&quot;&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self, topic, group_id, bootstrap_servers, auto_offset_reset, enable_auto_commit=<span class=\"literal\">False</span></span>):</span><br><span class=\"line\">        <span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">        :param topic:</span></span><br><span class=\"line\"><span class=\"string\">        :param group_id:</span></span><br><span class=\"line\"><span class=\"string\">        :param bootstrap_servers:</span></span><br><span class=\"line\"><span class=\"string\">        &quot;&quot;&quot;</span></span><br><span class=\"line\">        self.consumer = KafkaConsumer(</span><br><span class=\"line\">            topic,</span><br><span class=\"line\">            bootstrap_servers=bootstrap_servers,</span><br><span class=\"line\">            group_id=group_id,</span><br><span class=\"line\">            auto_offset_reset=auto_offset_reset,</span><br><span class=\"line\">            enable_auto_commit=enable_auto_commit,</span><br><span class=\"line\">            consumer_timeout_ms=<span class=\"number\">10000</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        self.tp = TopicPartition(topic, <span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">start_consumer</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                <span class=\"comment\"># 30s commit  offset</span></span><br><span class=\"line\">                msg_list_dict = self.consumer.poll(timeout_ms=<span class=\"number\">30000</span>)</span><br><span class=\"line\">                <span class=\"keyword\">for</span> tp, msg_list <span class=\"keyword\">in</span> msg_list_dict.items():</span><br><span class=\"line\">                    <span class=\"keyword\">for</span> msg <span class=\"keyword\">in</span> msg_list: </span><br><span class=\"line\">                        <span class=\"comment\">### core operate,send message to telegram</span></span><br><span class=\"line\">                        send_result = asyncio.run(send_message(msg.value))</span><br><span class=\"line\">                        <span class=\"built_in\">print</span>(send_result)</span><br><span class=\"line\">                <span class=\"comment\">#print(f&quot;current offset is &#123;self.consumer.position(tp)&#125;&quot;)</span></span><br><span class=\"line\">                self.consumer.commit()</span><br><span class=\"line\">            <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">                <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;ERROR: get cluster events failed,please check.&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">close_consumer</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            self.consumer.unsubscribe()</span><br><span class=\"line\">            self.consumer.close()</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&quot;consumer stop failed,please check.&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    <span class=\"comment\"># env</span></span><br><span class=\"line\">    topic = <span class=\"string\">&#x27;yakirtopic&#x27;</span></span><br><span class=\"line\">    bootstrap_servers = <span class=\"string\">&#x27;yakir-kafka-headless:9092&#x27;</span></span><br><span class=\"line\">    group_id = <span class=\"string\">&#x27;yakir1.group&#x27;</span></span><br><span class=\"line\">    auto_offset_reset = <span class=\"string\">&#x27;earliest&#x27;</span></span><br><span class=\"line\">    enable_auto_commit = <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># start</span></span><br><span class=\"line\">    consumer = KConsumer(topic, group_id=group_id, bootstrap_servers=bootstrap_servers, auto_offset_reset=auto_offset_reset, enable_auto_commit=enable_auto_commit)</span><br><span class=\"line\">    consumer.start_consumer()</span><br><span class=\"line\">    <span class=\"comment\"># stop</span></span><br><span class=\"line\">    <span class=\"comment\">#consumer.close_consumer()</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Dockerfile </li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> python:<span class=\"number\">3.8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Set an environment variable </span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> APP /app</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create the directory</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> <span class=\"built_in\">mkdir</span> <span class=\"variable\">$APP</span></span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> <span class=\"variable\">$APP</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Expose the port uWSGI will listen on</span></span><br><span class=\"line\"><span class=\"comment\">#EXPOSE 5000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Copy the requirements file in order to install</span></span><br><span class=\"line\"><span class=\"comment\"># Python dependencies</span></span><br><span class=\"line\"><span class=\"comment\">#COPY requirements.txt .</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> . .</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> pip install --upgrade pip &amp;&amp; pip install --no-cache-dir -r requirements.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Finally, we run uWSGI with the ini file</span></span><br><span class=\"line\"><span class=\"comment\">#CMD [&quot;sleep&quot;, &quot;infinity&quot;]</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;python&quot;</span>, <span class=\"string\">&quot;get_events.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cd /opt/yakir/kube-eventer-py/ &amp;&amp; mkdir APP-META</span><br><span class=\"line\">rm -f APP-META/*.py &amp;&amp; cp *.py APP-META/</span><br><span class=\"line\"></span><br><span class=\"line\">cd APP-META &amp;&amp; build -t kube-eventer-telegrambot:latest .</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">docker  kubectl</span></span><br><span class=\"line\">cat &gt; kube-eventer-telegrambot.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: yakir-kube-eventer</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: yakir-kube-eventer</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: yakir-kube-eventer</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - image: kube-eventer-telegrambot:latest</span><br><span class=\"line\">          name: yakir-kube-eventer</span><br><span class=\"line\">          env:</span><br><span class=\"line\">          - name: TZ</span><br><span class=\"line\">            value: &quot;Asia/Shanghai&quot; </span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: localtime</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /etc/localtime</span><br><span class=\"line\">        - name: zoneinfo</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /usr/share/zoneinfo</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl apply -f kube-eventer-telegrambot.yaml</span><br><span class=\"line\">kubectl get pod                               </span><br><span class=\"line\">NAME                                  READY   STATUS    RESTARTS        AGE</span><br><span class=\"line\">yakir-kube-eventer-589bf867bc-tgs5l   1/1     Running   0               27</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>xxxx</p>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":10759,"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><p>Kubernetes  Normal Warning</p>\n</li>\n<li><p>kube-eventer Alicloud Kubernetes Kubernetes 1</p>\n</li>\n<li><p><a href=\"https://github.com/AliyunContainerService/kube-eventer\">https://github.com/AliyunContainerService/kube-eventer</a></p>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Kubernetes </td>\n<td></td>\n<td> minikube </td>\n</tr>\n<tr>\n<td>kube-eventer</td>\n<td> Kubernetes </td>\n<td></td>\n</tr>\n<tr>\n<td>Kafka &#x2F; Elasticsearch &#x2F; influxDB</td>\n<td></td>\n<td> Kafka</td>\n</tr>\n<tr>\n<td>kube-eventer-py</td>\n<td> telegram </td>\n<td></td>\n</tr>\n</tbody></table>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1minikube-\"><a href=\"#1minikube-\" class=\"headerlink\" title=\"1minikube \"></a>1minikube </h4><p><a href=\"https://minikube.sigs.k8s.io/docs/start/\">https://minikube.sigs.k8s.io/docs/start/</a></p>\n<h4 id=\"2Kafka\"><a href=\"#2Kafka\" class=\"headerlink\" title=\"2Kafka\"></a>2Kafka</h4><p> helm  Kafka</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> helm </span></span><br><span class=\"line\">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Kafka chart </span></span><br><span class=\"line\">mkdir /opt/helm_chats &amp;&amp; cd /opt/helm_chats </span><br><span class=\"line\">helm pull bitnami/kafka &amp;&amp; tar xf kafka-18.2.0.tgz &amp;&amp; rm -rf kafka-18.2.0.tgz</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Kafka</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat ./values.yaml  </span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Kafka  Configmap </span></span><br><span class=\"line\">config: |-</span><br><span class=\"line\">  broker.id=0</span><br><span class=\"line\">  listeners=INTERNAL://:9093,CLIENT://:9092</span><br><span class=\"line\">  advertised.listeners=INTERNAL://yakir-kafka-0.yakir-kafka-headless.default.svc.cluster.local:9093,CLIENT://yakir-kafka-0.yakir-kafka-headless.default.svc.cluster.local:9092</span><br><span class=\"line\">  listener.security.protocol.map=INTERNAL:PLAINTEXT,CLIENT:PLAINTEXT</span><br><span class=\"line\">  num.network.threads=5</span><br><span class=\"line\">  num.io.threads=10</span><br><span class=\"line\">  socket.send.buffer.bytes=102400</span><br><span class=\"line\">  socket.receive.buffer.bytes=102400</span><br><span class=\"line\">  socket.request.max.bytes=104857600</span><br><span class=\"line\">  log.dirs=/bitnami/kafka/data</span><br><span class=\"line\">  num.partitions=1</span><br><span class=\"line\">  num.recovery.threads.per.data.dir=1</span><br><span class=\"line\">  offsets.topic.replication.factor=1</span><br><span class=\"line\">  transaction.state.log.replication.factor=1</span><br><span class=\"line\">  transaction.state.log.min.isr=1</span><br><span class=\"line\">  log.flush.interval.messages=10000</span><br><span class=\"line\">  log.flush.interval.ms=1000</span><br><span class=\"line\">  log.retention.hours=168   # 7</span><br><span class=\"line\">  log.retention.bytes=1073741824</span><br><span class=\"line\">  log.segment.bytes=1073741824</span><br><span class=\"line\">  log.retention.check.interval.ms=300000</span><br><span class=\"line\">  zookeeper.connect=yakir-kafka-zookeeper</span><br><span class=\"line\">  zookeeper.connection.timeout.ms=6000</span><br><span class=\"line\">  group.initial.rebalance.delay.ms=0</span><br><span class=\"line\">  allow.everyone.if.no.acl.found=true</span><br><span class=\"line\">  auto.create.topics.enable=true</span><br><span class=\"line\">  default.replication.factor=1</span><br><span class=\"line\">  delete.topic.enable=true   #  topic </span><br><span class=\"line\">  inter.broker.listener.name=INTERNAL</span><br><span class=\"line\">  log.retention.check.intervals.ms=300000</span><br><span class=\"line\">  max.partition.fetch.bytes=1048576</span><br><span class=\"line\">  max.request.size=1048576</span><br><span class=\"line\">  message.max.bytes=1000012</span><br><span class=\"line\">  sasl.enabled.mechanisms=PLAIN,SCRAM-SHA-256,SCRAM-SHA-512</span><br><span class=\"line\">  sasl.mechanism.inter.broker.protocol=</span><br><span class=\"line\">  super.users=User:admin</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">persistence:</span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  existingClaim: &quot;&quot;</span><br><span class=\"line\">  storageClass: &quot;standard&quot;   # </span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">zookeeper:</span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  replicaCount: 1</span><br><span class=\"line\">  auth:</span><br><span class=\"line\">    client:</span><br><span class=\"line\">      enabled: false</span><br><span class=\"line\">      clientUser: &quot;&quot;</span><br><span class=\"line\">      clientPassword: &quot;&quot;</span><br><span class=\"line\">      serverUsers: &quot;&quot;</span><br><span class=\"line\">      serverPasswords: &quot;&quot;</span><br><span class=\"line\">  persistence:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    storageClass: &quot;standard&quot;   # miniku </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">helm install yakir-kafka .</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Running </span></span><br><span class=\"line\">kubectl get pod  </span><br><span class=\"line\">NAME                                  READY   STATUS    RESTARTS       AGE</span><br><span class=\"line\">yakir-kafka-0                         1/1     Running   0              171m</span><br><span class=\"line\">yakir-kafka-zookeeper-0               1/1     Running   6 (168m ago)   10d</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3kube-eventer-\"><a href=\"#3kube-eventer-\" class=\"headerlink\" title=\"3kube-eventer \"></a>3kube-eventer </h4><ul>\n<li> YAML </li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; kube-eventer.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: kube-eventer</span><br><span class=\"line\">  name: kube-eventer</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: kube-eventer</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: kube-eventer</span><br><span class=\"line\">      annotations:      </span><br><span class=\"line\">        #scheduler.alpha.kubernetes.io/critical-pod: &#x27;&#x27;</span><br><span class=\"line\">        priorityClassName: &#x27;&#x27;</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      dnsPolicy: ClusterFirstWithHostNet</span><br><span class=\"line\">      serviceAccount: kube-eventer</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - image: registry.aliyuncs.com/acs/kube-eventer-amd64:v1.2.0-484d9cd-aliyun</span><br><span class=\"line\">          name: kube-eventer</span><br><span class=\"line\">          command:</span><br><span class=\"line\">            - &quot;/kube-eventer&quot;</span><br><span class=\"line\">            - &quot;--source=kubernetes:https://kubernetes.default&quot;</span><br><span class=\"line\">            # </span><br><span class=\"line\">            - --sink=kafka:?brokers=yakir-kafka-headless.default:9092&amp;eventstopic=yakirtopic</span><br><span class=\"line\">          env:</span><br><span class=\"line\">          # If TZ is assigned, set the TZ value as the time zone</span><br><span class=\"line\">          - name: TZ</span><br><span class=\"line\">            value: &quot;Asia/Shanghai&quot; </span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - name: localtime</span><br><span class=\"line\">              mountPath: /etc/localtime</span><br><span class=\"line\">              readOnly: true</span><br><span class=\"line\">            - name: zoneinfo</span><br><span class=\"line\">              mountPath: /usr/share/zoneinfo</span><br><span class=\"line\">              readOnly: true</span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            requests:</span><br><span class=\"line\">              cpu: 100m</span><br><span class=\"line\">              memory: 100Mi</span><br><span class=\"line\">            limits:</span><br><span class=\"line\">              cpu: 500m</span><br><span class=\"line\">              memory: 250Mi</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: localtime</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /etc/localtime</span><br><span class=\"line\">        - name: zoneinfo</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /usr/share/zoneinfo</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-eventer</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - configmaps</span><br><span class=\"line\">      - events</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">      - list</span><br><span class=\"line\">      - watch</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-eventer</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: kube-eventer</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: kube-eventer</span><br><span class=\"line\">    namespace: kube-system</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-eventer</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> kube-system namespace </span></span><br><span class=\"line\">kubectl apply -f kube-eventer.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get pod -n kube-system</span><br><span class=\"line\">NAME                               READY   STATUS    RESTARTS        AGE</span><br><span class=\"line\">kube-eventer-69455778cd-cvr9w      1/1     Running   0               8d</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-telegram\"><a href=\"#4-telegram\" class=\"headerlink\" title=\"4 telegram\"></a>4 telegram</h4><ul>\n<li>telegram </li>\n</ul>\n<blockquote>\n<p></p>\n<p>1<a href=\"https://cloud.tencent.com/developer/article/1835051\">https://cloud.tencent.com/developer/article/1835051</a></p>\n<p>2telegram python SDK<a href=\"https://github.com/python-telegram-bot/python-telegram-bot\">https://github.com/python-telegram-bot/python-telegram-bot</a></p>\n</blockquote>\n<ul>\n<li>Python </li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># telegrambot.py </span></span><br><span class=\"line\"><span class=\"keyword\">import</span> asyncio</span><br><span class=\"line\"><span class=\"keyword\">import</span> telegram</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">import</span> traceback</span><br><span class=\"line\"></span><br><span class=\"line\">TOKEN = <span class=\"string\">&quot;xxxxxx&quot;</span></span><br><span class=\"line\">chat_id = <span class=\"string\">&quot;-xxx&quot;</span></span><br><span class=\"line\">bot = telegram.Bot(token=TOKEN)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FilterMsg</span>(<span class=\"title class_ inherited__\">object</span>):</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self, text</span>):</span><br><span class=\"line\">        self.event_value = json.loads(text[<span class=\"string\">&#x27;EventValue&#x27;</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">        self.data = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;kind&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;involvedObject&#x27;</span>][<span class=\"string\">&#x27;kind&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;namespace&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;involvedObject&#x27;</span>][<span class=\"string\">&#x27;namespace&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;reason&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;reason&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;message&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;message&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;first_timestamp&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;firstTimestamp&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;last_timestamp&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;lastTimestamp&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;count&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;count&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;type&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;type&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;event_time&#x27;</span>] = self.event_value[<span class=\"string\">&#x27;eventTime&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;pod_hostname&#x27;</span>] = text[<span class=\"string\">&#x27;EventTags&#x27;</span>][<span class=\"string\">&#x27;hostname&#x27;</span>]</span><br><span class=\"line\">        self.data[<span class=\"string\">&#x27;pod_name&#x27;</span>] = text[<span class=\"string\">&#x27;EventTags&#x27;</span>][<span class=\"string\">&#x27;pod_name&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">convert</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        msg_markdown = <span class=\"string\">f&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">        *Kubernetes Cluster Event*</span></span><br><span class=\"line\"><span class=\"string\">    `Kind: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;kind&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `Namescodeace: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;namespace&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `Reason: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;reason&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `Timestamp: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;first_timestamp&#x27;</span>]&#125;</span> to <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;last_timestamp&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `Count: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;count&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `EventType: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;type&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `EventTime: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;event_time&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `PodHostname: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;pod_hostname&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `PodName: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;pod_name&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">    `Message: <span class=\"subst\">&#123;self.data[<span class=\"string\">&#x27;message&#x27;</span>]&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> msg_markdown</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">send_message</span>(<span class=\"params\">text</span>):</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        <span class=\"comment\"># Core: get message from Kafka,and filter message</span></span><br><span class=\"line\">        convert_text = json.loads(text.decode(<span class=\"string\">&#x27;utf8&#x27;</span>).replace(<span class=\"string\">&#x27;\\\\n&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>))</span><br><span class=\"line\">        msg_instance = FilterMsg(convert_text)</span><br><span class=\"line\">        msg = msg_instance.convert()</span><br><span class=\"line\">        send_result = bot.send_message(chat_id=chat_id, text=msg, parse_mode=<span class=\"string\">&#x27;MarkdownV2&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> send_result</span><br><span class=\"line\">    <span class=\"keyword\">except</span> KeyError <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">        msg = <span class=\"string\">&quot;Unknow message..&quot;</span></span><br><span class=\"line\">        send_result = bot.send_message(chat_id=chat_id, text=msg)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> send_result</span><br><span class=\"line\">    <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(e.__str__())</span><br><span class=\"line\">        <span class=\"comment\">#traceback.print_exc()</span></span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;send message to telegram failed,please check.&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    text = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">    text = json.loads(text.decode(<span class=\"string\">&#x27;utf8&#x27;</span>).replace(<span class=\"string\">&#x27;\\\\n&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>))</span><br><span class=\"line\">    send_result = asyncio.run(send_message(text))</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(send_result)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># get_events.py </span></span><br><span class=\"line\"><span class=\"keyword\">from</span> kafka <span class=\"keyword\">import</span> KafkaConsumer, TopicPartition</span><br><span class=\"line\"><span class=\"keyword\">from</span> telegrambot <span class=\"keyword\">import</span> send_message</span><br><span class=\"line\"><span class=\"keyword\">import</span> asyncio</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">KConsumer</span>(<span class=\"title class_ inherited__\">object</span>):</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;kafka consumer instance&quot;&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self, topic, group_id, bootstrap_servers, auto_offset_reset, enable_auto_commit=<span class=\"literal\">False</span></span>):</span><br><span class=\"line\">        <span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">        :param topic:</span></span><br><span class=\"line\"><span class=\"string\">        :param group_id:</span></span><br><span class=\"line\"><span class=\"string\">        :param bootstrap_servers:</span></span><br><span class=\"line\"><span class=\"string\">        &quot;&quot;&quot;</span></span><br><span class=\"line\">        self.consumer = KafkaConsumer(</span><br><span class=\"line\">            topic,</span><br><span class=\"line\">            bootstrap_servers=bootstrap_servers,</span><br><span class=\"line\">            group_id=group_id,</span><br><span class=\"line\">            auto_offset_reset=auto_offset_reset,</span><br><span class=\"line\">            enable_auto_commit=enable_auto_commit,</span><br><span class=\"line\">            consumer_timeout_ms=<span class=\"number\">10000</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        self.tp = TopicPartition(topic, <span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">start_consumer</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                <span class=\"comment\"># 30s commit  offset</span></span><br><span class=\"line\">                msg_list_dict = self.consumer.poll(timeout_ms=<span class=\"number\">30000</span>)</span><br><span class=\"line\">                <span class=\"keyword\">for</span> tp, msg_list <span class=\"keyword\">in</span> msg_list_dict.items():</span><br><span class=\"line\">                    <span class=\"keyword\">for</span> msg <span class=\"keyword\">in</span> msg_list: </span><br><span class=\"line\">                        <span class=\"comment\">### core operate,send message to telegram</span></span><br><span class=\"line\">                        send_result = asyncio.run(send_message(msg.value))</span><br><span class=\"line\">                        <span class=\"built_in\">print</span>(send_result)</span><br><span class=\"line\">                <span class=\"comment\">#print(f&quot;current offset is &#123;self.consumer.position(tp)&#125;&quot;)</span></span><br><span class=\"line\">                self.consumer.commit()</span><br><span class=\"line\">            <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">                <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;ERROR: get cluster events failed,please check.&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">close_consumer</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            self.consumer.unsubscribe()</span><br><span class=\"line\">            self.consumer.close()</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&quot;consumer stop failed,please check.&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    <span class=\"comment\"># env</span></span><br><span class=\"line\">    topic = <span class=\"string\">&#x27;yakirtopic&#x27;</span></span><br><span class=\"line\">    bootstrap_servers = <span class=\"string\">&#x27;yakir-kafka-headless:9092&#x27;</span></span><br><span class=\"line\">    group_id = <span class=\"string\">&#x27;yakir1.group&#x27;</span></span><br><span class=\"line\">    auto_offset_reset = <span class=\"string\">&#x27;earliest&#x27;</span></span><br><span class=\"line\">    enable_auto_commit = <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># start</span></span><br><span class=\"line\">    consumer = KConsumer(topic, group_id=group_id, bootstrap_servers=bootstrap_servers, auto_offset_reset=auto_offset_reset, enable_auto_commit=enable_auto_commit)</span><br><span class=\"line\">    consumer.start_consumer()</span><br><span class=\"line\">    <span class=\"comment\"># stop</span></span><br><span class=\"line\">    <span class=\"comment\">#consumer.close_consumer()</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Dockerfile </li>\n</ul>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> python:<span class=\"number\">3.8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Set an environment variable </span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> APP /app</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create the directory</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> <span class=\"built_in\">mkdir</span> <span class=\"variable\">$APP</span></span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> <span class=\"variable\">$APP</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Expose the port uWSGI will listen on</span></span><br><span class=\"line\"><span class=\"comment\">#EXPOSE 5000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Copy the requirements file in order to install</span></span><br><span class=\"line\"><span class=\"comment\"># Python dependencies</span></span><br><span class=\"line\"><span class=\"comment\">#COPY requirements.txt .</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> . .</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> pip install --upgrade pip &amp;&amp; pip install --no-cache-dir -r requirements.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Finally, we run uWSGI with the ini file</span></span><br><span class=\"line\"><span class=\"comment\">#CMD [&quot;sleep&quot;, &quot;infinity&quot;]</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;python&quot;</span>, <span class=\"string\">&quot;get_events.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cd /opt/yakir/kube-eventer-py/ &amp;&amp; mkdir APP-META</span><br><span class=\"line\">rm -f APP-META/*.py &amp;&amp; cp *.py APP-META/</span><br><span class=\"line\"></span><br><span class=\"line\">cd APP-META &amp;&amp; build -t kube-eventer-telegrambot:latest .</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">docker  kubectl</span></span><br><span class=\"line\">cat &gt; kube-eventer-telegrambot.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: yakir-kube-eventer</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: yakir-kube-eventer</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: yakir-kube-eventer</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - image: kube-eventer-telegrambot:latest</span><br><span class=\"line\">          name: yakir-kube-eventer</span><br><span class=\"line\">          env:</span><br><span class=\"line\">          - name: TZ</span><br><span class=\"line\">            value: &quot;Asia/Shanghai&quot; </span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: localtime</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /etc/localtime</span><br><span class=\"line\">        - name: zoneinfo</span><br><span class=\"line\">          hostPath:</span><br><span class=\"line\">            path: /usr/share/zoneinfo</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl apply -f kube-eventer-telegrambot.yaml</span><br><span class=\"line\">kubectl get pod                               </span><br><span class=\"line\">NAME                                  READY   STATUS    RESTARTS        AGE</span><br><span class=\"line\">yakir-kube-eventer-589bf867bc-tgs5l   1/1     Running   0               27</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>xxxx</p>"},{"title":"RabbitMQ ","abbrlink":"9bae","date":"2022-06-06T12:33:11.000Z","_content":"### RabbitMQ \n#### \nMessage\n\nMessage Queue MQ  MQ \n\n\n#### \n MQ  MQ MQ MQ  MQ \n\n\n\n<!--more-->\n\n#### RabbitMQ \n\n- \n\nAMQP Advanced Message Queue\n\n- \n   - \n   - Exchange \n   - RabbitMQ Broker\n   - \n   - \n   - \n   - UI \n   - \n   - \n\n\n#### RabbitMQ \n\n- [](https://help.aliyun.com/document_detail/101628.html)\n\nVhostRabbitMQ \nBrokerRabbitMQ \n\nConnectionTCP RabbitMQ 15TCP \nChannelConnection TCP \n\nPublisherExchange \nConsumerQueue \n\nMessage+routing-keyprioritydelivery-mode\nExchangeQueue\nQueueConsumer\nBindingrouting-key Queue Exchange \n{% asset_img rbmq1.png %}\n\n- AMQP \n\nAMQP  Exchange  Binding  Exchange  Binding \n{% asset_img rbmq2.png %}\n\n- Exchange \n\nheaders\n\ndirectMessagerouting-key Binding binding-key Queue\n{% asset_img rbmq3.png %}\n\nfanoutrouting-keyExchange Queue\n{% asset_img rbmq4.png %}\n\ntopicrouting-key Queue \n{% asset_img rbmq5.png %}\n\nJMS Queue Exchangedirect \nJMS topic Exchangetopic \n\n\n#### RabbitMQ \n[https://www.jianshu.com/p/79ca08116d57](https://www.jianshu.com/p/79ca08116d57)\n> \n\n\n\n### \n#### RabbitMQ \n\n- RabbitMQ \n\nRabbitMQ \n{% asset_img rbmq6.png %}\n\n- \n   - \n   - \n   - Exchange\n   - \n\n- ACK RabbitMQ \n   - RabbitMQ StatefulSet \n```yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: camel-k-rabbitmq-test\n  namespace: default\nspec:\n  podManagementPolicy: OrderedReady\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      app: camel-k-rabbitmq-test\n  serviceName: camel-k-rabbitmq-test-svc\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app: camel-k-rabbitmq-test\n    spec:\n      containers:\n      - env:\n        - name: OPENSSL_SOURCE_SHA256\n          value: f89199be8b23ca45fc7cb9f1d8d3ee67312318286ad030f5316aca6462db6c96\n        - name: OPENSSL_PGP_KEY_IDS\n          value: 0x8657ABB260F056B1E5190839D9C4D26D0E604491 0x5B2545DAB21995F4088CEFAA36CEE4DEB00CFE33\n            0xED230BEC4D4F2518B9D7DF41F0DB4D21C1D35231 0xC1F33DD8CE1D4CC613AF14DA9195C48241FBF7DD\n            0x7953AC1FBC3DC8B3B292393ED5E9E43F7DF9EE8C 0xE5E52560DD91C556DDBDA5D02064C53641C25E5D\n        - name: OTP_SOURCE_SHA256\n          value: af0f1928dcd16cd5746feeca8325811865578bf1a110a443d353ea3e509e6d41\n        - name: RABBITMQ_DATA_DIR\n          value: /var/lib/rabbitmq\n        - name: RABBITMQ_PGP_KEY_ID\n          value: 0x0A9AF2115F4687BD29803A206B73A36E6026DFCA\n        - name: RABBITMQ_HOME\n          value: /opt/rabbitmq\n        - name: RABBITMQ_LOGS\n          value: '-'\n        - name: HOME\n          value: /var/lib/rabbitmq\n        - name: LANG\n          value: C.UTF-8\n        - name: LANGUAGE\n          value: C.UTF-8\n        - name: LC_ALL\n          value: C.UTF-8\n        image: rabbitmq:3.9.11-management\n        imagePullPolicy: IfNotPresent\n        name: camel-k-rabbitmq-test\n        ports:\n        - containerPort: 15671\n          name: port1\n          protocol: TCP\n        - containerPort: 15672\n          name: port2\n          protocol: TCP\n        - containerPort: 15691\n          protocol: TCP\n        - containerPort: 15692\n          protocol: TCP\n        - containerPort: 25672\n          protocol: TCP\n        - containerPort: 4369\n          protocol: TCP\n        - containerPort: 5671\n          protocol: TCP\n        - containerPort: 5672\n          protocol: TCP\n        resources:\n          limits:\n            cpu: \"1\"\n            memory: 2Gi\n          requests:\n            cpu: 250m\n            memory: 512Mi\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        volumeMounts:\n        - mountPath: /var/lib/rabbitmq\n          name: volume-image-0\n      dnsPolicy: ClusterFirst\n      restartPolicy: Always\n      schedulerName: default-scheduler\n      securityContext: {}\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - hostPath:\n          path: /var/lib/rabbitmq\n          type: \"\"\n        name: volume-image-0\n  updateStrategy:\n    type: RollingUpdate\n```\n\n   - RabbitMQ UI  5672 serverACK yaml Service SLB\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: rabbitmq-svc\n  namespace: default\nspec:\n  clusterIP: 192.168.87.198\n  clusterIPs:\n  - 192.168.87.198\n  externalTrafficPolicy: Cluster\n  ports:\n  - nodePort: 32166\n    port: 5672\n    protocol: TCP\n    targetPort: 5672\n  selector:\n    app: camel-k-rabbitmq-test\n  sessionAffinity: None\n  type: NodePort\n```\n\n#### \n> Python RabbitMQ [https://www.rabbitmq.com/tutorials/tutorial-one-python.html](https://www.rabbitmq.com/tutorials/tutorial-one-python.html)\n\n1. VhostExchangetopic \n\n{% asset_img rbmq7.png %}\n{% asset_img rbmq8.png %}\n{% asset_img rbmq9.png %}\n\n\n\n2. Python SDK \n\nPublisher\n```python\nimport pika\nimport sys\n\ncredentials = pika.PlainCredentials('xxx', 'xxx')\nconnection = pika.BlockingConnection(pika.ConnectionParameters('xxx.com', 5672,'liyanjun-test', credentials))\nchannel = connection.channel()\n\n#  user.info.test routing key Exchange \nrouting_key = 'user.info.test'\nmessage = 'liyanjun rabbitmq test send...'\n\nchannel.basic_publish(exchange='userinfo_test', routing_key=routing_key, body=message)\nprint(\" [x] Sent %r:%r\" % (routing_key, message))\nconnection.close()\n```\nConsumer\n```python\nimport pika\nimport sys\n\ncredentials = pika.PlainCredentials('xxx', 'xxx')\nconnection = pika.BlockingConnection(pika.ConnectionParameters('amqp-cn-i7m2fw6ry00u.mq-amqp.cn-hangzhou-249959-a.aliyuncs.com', 5672,'liyanjun-test', credentials))\nchannel = connection.channel()\n\n# client 1\nresult = channel.queue_declare('user_info_queue')\n# client 2\nresult = channel.queue_declare('user_account_queue')    \nqueue_name = result.method.queue\n\nbinding_keys = sys.argv[1:]\nif not binding_keys:\n    sys.stderr.write(\"Usage: %s [binding_key]...\\n\" % sys.argv[0])\n    sys.exit(1)\n\nfor binding_key in binding_keys:\n    channel.queue_bind(exchange='userinfo_test', queue=queue_name, routing_key=binding_key)\n\nprint(' [*] Waiting for logs. To exit press CTRL+C')\n\n\ndef callback(ch, method, properties, body):\n    print(\" [x] %r:%r\" % (method.routing_key, body))\n\n\nchannel.basic_consume(queue=queue_name, on_message_callback=callback, auto_ack=True)\n\nchannel.start_consuming()\n```\n```python\n# clientrouting key\npython rabbitmq_client_test1.py user.info.test\npython rabbitmq_client_test2.py user.account.test\n```\n\n3. \n- userinfo_test Exchange binding key\n   - user.info.#           -->  user_info_queue QUEUE \n   - user.account.#     -->  user_account_queue QUEUE \n\n{% asset_img rbmq10.png %}\n\n- Server user.info.test  routing_key client1 \n\n{% asset_img rbmq11.png %}\n{% asset_img rbmq12.png %}\n\n\n> \n> 1[https://www.rabbitmq.com/](https://www.rabbitmq.com/)\n> 2RabbitMQ[https://www.jianshu.com/p/79ca08116d57](https://www.jianshu.com/p/79ca08116d57)\n> 3Alicloud[https://help.aliyun.com/document_detail/141604.html](https://help.aliyun.com/document_detail/141604.html)\n\n","source":"_posts/rabbitmq.md","raw":"---\ntitle: RabbitMQ \ncategories:\n  - Middleware\ntags:\n  - RabbitMQ\nabbrlink: 9bae\ndate: 2022-06-06 20:33:11\n---\n### RabbitMQ \n#### \nMessage\n\nMessage Queue MQ  MQ \n\n\n#### \n MQ  MQ MQ MQ  MQ \n\n\n\n<!--more-->\n\n#### RabbitMQ \n\n- \n\nAMQP Advanced Message Queue\n\n- \n   - \n   - Exchange \n   - RabbitMQ Broker\n   - \n   - \n   - \n   - UI \n   - \n   - \n\n\n#### RabbitMQ \n\n- [](https://help.aliyun.com/document_detail/101628.html)\n\nVhostRabbitMQ \nBrokerRabbitMQ \n\nConnectionTCP RabbitMQ 15TCP \nChannelConnection TCP \n\nPublisherExchange \nConsumerQueue \n\nMessage+routing-keyprioritydelivery-mode\nExchangeQueue\nQueueConsumer\nBindingrouting-key Queue Exchange \n{% asset_img rbmq1.png %}\n\n- AMQP \n\nAMQP  Exchange  Binding  Exchange  Binding \n{% asset_img rbmq2.png %}\n\n- Exchange \n\nheaders\n\ndirectMessagerouting-key Binding binding-key Queue\n{% asset_img rbmq3.png %}\n\nfanoutrouting-keyExchange Queue\n{% asset_img rbmq4.png %}\n\ntopicrouting-key Queue \n{% asset_img rbmq5.png %}\n\nJMS Queue Exchangedirect \nJMS topic Exchangetopic \n\n\n#### RabbitMQ \n[https://www.jianshu.com/p/79ca08116d57](https://www.jianshu.com/p/79ca08116d57)\n> \n\n\n\n### \n#### RabbitMQ \n\n- RabbitMQ \n\nRabbitMQ \n{% asset_img rbmq6.png %}\n\n- \n   - \n   - \n   - Exchange\n   - \n\n- ACK RabbitMQ \n   - RabbitMQ StatefulSet \n```yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: camel-k-rabbitmq-test\n  namespace: default\nspec:\n  podManagementPolicy: OrderedReady\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      app: camel-k-rabbitmq-test\n  serviceName: camel-k-rabbitmq-test-svc\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app: camel-k-rabbitmq-test\n    spec:\n      containers:\n      - env:\n        - name: OPENSSL_SOURCE_SHA256\n          value: f89199be8b23ca45fc7cb9f1d8d3ee67312318286ad030f5316aca6462db6c96\n        - name: OPENSSL_PGP_KEY_IDS\n          value: 0x8657ABB260F056B1E5190839D9C4D26D0E604491 0x5B2545DAB21995F4088CEFAA36CEE4DEB00CFE33\n            0xED230BEC4D4F2518B9D7DF41F0DB4D21C1D35231 0xC1F33DD8CE1D4CC613AF14DA9195C48241FBF7DD\n            0x7953AC1FBC3DC8B3B292393ED5E9E43F7DF9EE8C 0xE5E52560DD91C556DDBDA5D02064C53641C25E5D\n        - name: OTP_SOURCE_SHA256\n          value: af0f1928dcd16cd5746feeca8325811865578bf1a110a443d353ea3e509e6d41\n        - name: RABBITMQ_DATA_DIR\n          value: /var/lib/rabbitmq\n        - name: RABBITMQ_PGP_KEY_ID\n          value: 0x0A9AF2115F4687BD29803A206B73A36E6026DFCA\n        - name: RABBITMQ_HOME\n          value: /opt/rabbitmq\n        - name: RABBITMQ_LOGS\n          value: '-'\n        - name: HOME\n          value: /var/lib/rabbitmq\n        - name: LANG\n          value: C.UTF-8\n        - name: LANGUAGE\n          value: C.UTF-8\n        - name: LC_ALL\n          value: C.UTF-8\n        image: rabbitmq:3.9.11-management\n        imagePullPolicy: IfNotPresent\n        name: camel-k-rabbitmq-test\n        ports:\n        - containerPort: 15671\n          name: port1\n          protocol: TCP\n        - containerPort: 15672\n          name: port2\n          protocol: TCP\n        - containerPort: 15691\n          protocol: TCP\n        - containerPort: 15692\n          protocol: TCP\n        - containerPort: 25672\n          protocol: TCP\n        - containerPort: 4369\n          protocol: TCP\n        - containerPort: 5671\n          protocol: TCP\n        - containerPort: 5672\n          protocol: TCP\n        resources:\n          limits:\n            cpu: \"1\"\n            memory: 2Gi\n          requests:\n            cpu: 250m\n            memory: 512Mi\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        volumeMounts:\n        - mountPath: /var/lib/rabbitmq\n          name: volume-image-0\n      dnsPolicy: ClusterFirst\n      restartPolicy: Always\n      schedulerName: default-scheduler\n      securityContext: {}\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - hostPath:\n          path: /var/lib/rabbitmq\n          type: \"\"\n        name: volume-image-0\n  updateStrategy:\n    type: RollingUpdate\n```\n\n   - RabbitMQ UI  5672 serverACK yaml Service SLB\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: rabbitmq-svc\n  namespace: default\nspec:\n  clusterIP: 192.168.87.198\n  clusterIPs:\n  - 192.168.87.198\n  externalTrafficPolicy: Cluster\n  ports:\n  - nodePort: 32166\n    port: 5672\n    protocol: TCP\n    targetPort: 5672\n  selector:\n    app: camel-k-rabbitmq-test\n  sessionAffinity: None\n  type: NodePort\n```\n\n#### \n> Python RabbitMQ [https://www.rabbitmq.com/tutorials/tutorial-one-python.html](https://www.rabbitmq.com/tutorials/tutorial-one-python.html)\n\n1. VhostExchangetopic \n\n{% asset_img rbmq7.png %}\n{% asset_img rbmq8.png %}\n{% asset_img rbmq9.png %}\n\n\n\n2. Python SDK \n\nPublisher\n```python\nimport pika\nimport sys\n\ncredentials = pika.PlainCredentials('xxx', 'xxx')\nconnection = pika.BlockingConnection(pika.ConnectionParameters('xxx.com', 5672,'liyanjun-test', credentials))\nchannel = connection.channel()\n\n#  user.info.test routing key Exchange \nrouting_key = 'user.info.test'\nmessage = 'liyanjun rabbitmq test send...'\n\nchannel.basic_publish(exchange='userinfo_test', routing_key=routing_key, body=message)\nprint(\" [x] Sent %r:%r\" % (routing_key, message))\nconnection.close()\n```\nConsumer\n```python\nimport pika\nimport sys\n\ncredentials = pika.PlainCredentials('xxx', 'xxx')\nconnection = pika.BlockingConnection(pika.ConnectionParameters('amqp-cn-i7m2fw6ry00u.mq-amqp.cn-hangzhou-249959-a.aliyuncs.com', 5672,'liyanjun-test', credentials))\nchannel = connection.channel()\n\n# client 1\nresult = channel.queue_declare('user_info_queue')\n# client 2\nresult = channel.queue_declare('user_account_queue')    \nqueue_name = result.method.queue\n\nbinding_keys = sys.argv[1:]\nif not binding_keys:\n    sys.stderr.write(\"Usage: %s [binding_key]...\\n\" % sys.argv[0])\n    sys.exit(1)\n\nfor binding_key in binding_keys:\n    channel.queue_bind(exchange='userinfo_test', queue=queue_name, routing_key=binding_key)\n\nprint(' [*] Waiting for logs. To exit press CTRL+C')\n\n\ndef callback(ch, method, properties, body):\n    print(\" [x] %r:%r\" % (method.routing_key, body))\n\n\nchannel.basic_consume(queue=queue_name, on_message_callback=callback, auto_ack=True)\n\nchannel.start_consuming()\n```\n```python\n# clientrouting key\npython rabbitmq_client_test1.py user.info.test\npython rabbitmq_client_test2.py user.account.test\n```\n\n3. \n- userinfo_test Exchange binding key\n   - user.info.#           -->  user_info_queue QUEUE \n   - user.account.#     -->  user_account_queue QUEUE \n\n{% asset_img rbmq10.png %}\n\n- Server user.info.test  routing_key client1 \n\n{% asset_img rbmq11.png %}\n{% asset_img rbmq12.png %}\n\n\n> \n> 1[https://www.rabbitmq.com/](https://www.rabbitmq.com/)\n> 2RabbitMQ[https://www.jianshu.com/p/79ca08116d57](https://www.jianshu.com/p/79ca08116d57)\n> 3Alicloud[https://help.aliyun.com/document_detail/141604.html](https://help.aliyun.com/document_detail/141604.html)\n\n","slug":"rabbitmq","published":1,"updated":"2024-01-21T15:28:43.161Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zr0023s0nje0aahnle","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"RabbitMQ-\"><a href=\"#RabbitMQ-\" class=\"headerlink\" title=\"RabbitMQ \"></a>RabbitMQ </h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Message</p>\n<p>Message Queue MQ  MQ </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> MQ  MQ MQ MQ  MQ </p>\n<p></p>\n<span id=\"more\"></span>\n\n<h4 id=\"RabbitMQ-\"><a href=\"#RabbitMQ-\" class=\"headerlink\" title=\"RabbitMQ \"></a>RabbitMQ </h4><ul>\n<li></li>\n</ul>\n<p>AMQP Advanced Message Queue</p>\n<ul>\n<li><ul>\n<li></li>\n<li>Exchange </li>\n<li>RabbitMQ Broker</li>\n<li></li>\n<li></li>\n<li></li>\n<li>UI </li>\n<li></li>\n<li></li>\n</ul>\n</li>\n</ul>\n<h4 id=\"RabbitMQ-\"><a href=\"#RabbitMQ-\" class=\"headerlink\" title=\"RabbitMQ \"></a>RabbitMQ </h4><ul>\n<li><a href=\"https://help.aliyun.com/document_detail/101628.html\"></a></li>\n</ul>\n<p>VhostRabbitMQ <br>BrokerRabbitMQ </p>\n<p>ConnectionTCP RabbitMQ 15TCP <br>ChannelConnection TCP </p>\n<p>PublisherExchange <br>ConsumerQueue </p>\n<p>Message+routing-keyprioritydelivery-mode<br>ExchangeQueue<br>QueueConsumer<br>Bindingrouting-key Queue Exchange </p>\n<img data-src=\"/posts/9bae/rbmq1.png\" class>\n\n<ul>\n<li>AMQP </li>\n</ul>\n<p>AMQP  Exchange  Binding  Exchange  Binding </p>\n<img data-src=\"/posts/9bae/rbmq2.png\" class>\n\n<ul>\n<li>Exchange </li>\n</ul>\n<p>headers</p>\n<p>directMessagerouting-key Binding binding-key Queue</p>\n<img data-src=\"/posts/9bae/rbmq3.png\" class>\n\n<p>fanoutrouting-keyExchange Queue</p>\n<img data-src=\"/posts/9bae/rbmq4.png\" class>\n\n<p>topicrouting-key Queue </p>\n<img data-src=\"/posts/9bae/rbmq5.png\" class>\n\n<p>JMS Queue Exchangedirect <br>JMS topic Exchangetopic </p>\n<h4 id=\"RabbitMQ-\"><a href=\"#RabbitMQ-\" class=\"headerlink\" title=\"RabbitMQ \"></a>RabbitMQ </h4><p><a href=\"https://www.jianshu.com/p/79ca08116d57\">https://www.jianshu.com/p/79ca08116d57</a></p>\n<blockquote>\n<p></p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"RabbitMQ-\"><a href=\"#RabbitMQ-\" class=\"headerlink\" title=\"RabbitMQ \"></a>RabbitMQ </h4><ul>\n<li>RabbitMQ </li>\n</ul>\n<p>RabbitMQ </p>\n<img data-src=\"/posts/9bae/rbmq6.png\" class>\n\n<ul>\n<li><p></p>\n<ul>\n<li></li>\n<li></li>\n<li>Exchange</li>\n<li></li>\n</ul>\n</li>\n<li><p>ACK RabbitMQ </p>\n<ul>\n<li><p>RabbitMQ StatefulSet </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">camel-k-rabbitmq-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podManagementPolicy:</span> <span class=\"string\">OrderedReady</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">revisionHistoryLimit:</span> <span class=\"number\">10</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">camel-k-rabbitmq-test</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">camel-k-rabbitmq-test-svc</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">camel-k-rabbitmq-test</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">OPENSSL_SOURCE_SHA256</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">f89199be8b23ca45fc7cb9f1d8d3ee67312318286ad030f5316aca6462db6c96</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">OPENSSL_PGP_KEY_IDS</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"number\">0x8657ABB260F056B1E5190839D9C4D26D0E604491</span> <span class=\"number\">0x5B2545DAB21995F4088CEFAA36CEE4DEB00CFE33</span></span><br><span class=\"line\">            <span class=\"number\">0xED230BEC4D4F2518B9D7DF41F0DB4D21C1D35231</span> <span class=\"number\">0xC1F33DD8CE1D4CC613AF14DA9195C48241FBF7DD</span></span><br><span class=\"line\">            <span class=\"number\">0x7953AC1FBC3DC8B3B292393ED5E9E43F7DF9EE8C</span> <span class=\"number\">0xE5E52560DD91C556DDBDA5D02064C53641C25E5D</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">OTP_SOURCE_SHA256</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">af0f1928dcd16cd5746feeca8325811865578bf1a110a443d353ea3e509e6d41</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_DATA_DIR</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_PGP_KEY_ID</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"number\">0x0A9AF2115F4687BD29803A206B73A36E6026DFCA</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_HOME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">/opt/rabbitmq</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_LOGS</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&#x27;-&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">HOME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">LANG</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">C.UTF-8</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">LANGUAGE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">C.UTF-8</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">LC_ALL</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">C.UTF-8</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">rabbitmq:3.9.11-management</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">camel-k-rabbitmq-test</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15671</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">port1</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">port2</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15691</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15692</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">25672</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">4369</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5671</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">2Gi</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">250m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">512Mi</span></span><br><span class=\"line\">        <span class=\"attr\">terminationMessagePath:</span> <span class=\"string\">/dev/termination-log</span></span><br><span class=\"line\">        <span class=\"attr\">terminationMessagePolicy:</span> <span class=\"string\">File</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">volume-image-0</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">schedulerName:</span> <span class=\"string\">default-scheduler</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span> &#123;&#125;</span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">type:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">volume-image-0</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>RabbitMQ UI  5672 serverACK yaml Service SLB</p>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-svc</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"number\">192.168</span><span class=\"number\">.87</span><span class=\"number\">.198</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIPs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"number\">192.168</span><span class=\"number\">.87</span><span class=\"number\">.198</span></span><br><span class=\"line\">  <span class=\"attr\">externalTrafficPolicy:</span> <span class=\"string\">Cluster</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">nodePort:</span> <span class=\"number\">32166</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">camel-k-rabbitmq-test</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>Python RabbitMQ <a href=\"https://www.rabbitmq.com/tutorials/tutorial-one-python.html\">https://www.rabbitmq.com/tutorials/tutorial-one-python.html</a></p>\n</blockquote>\n<ol>\n<li>VhostExchangetopic </li>\n</ol>\n<img data-src=\"/posts/9bae/rbmq7.png\" class>\n<img data-src=\"/posts/9bae/rbmq8.png\" class>\n<img data-src=\"/posts/9bae/rbmq9.png\" class>\n\n\n\n<ol start=\"2\">\n<li>Python SDK </li>\n</ol>\n<p>Publisher</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pika</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\">credentials = pika.PlainCredentials(<span class=\"string\">&#x27;xxx&#x27;</span>, <span class=\"string\">&#x27;xxx&#x27;</span>)</span><br><span class=\"line\">connection = pika.BlockingConnection(pika.ConnectionParameters(<span class=\"string\">&#x27;xxx.com&#x27;</span>, <span class=\"number\">5672</span>,<span class=\"string\">&#x27;liyanjun-test&#x27;</span>, credentials))</span><br><span class=\"line\">channel = connection.channel()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  user.info.test routing key Exchange </span></span><br><span class=\"line\">routing_key = <span class=\"string\">&#x27;user.info.test&#x27;</span></span><br><span class=\"line\">message = <span class=\"string\">&#x27;liyanjun rabbitmq test send...&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">channel.basic_publish(exchange=<span class=\"string\">&#x27;userinfo_test&#x27;</span>, routing_key=routing_key, body=message)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot; [x] Sent %r:%r&quot;</span> % (routing_key, message))</span><br><span class=\"line\">connection.close()</span><br></pre></td></tr></table></figure>\n<p>Consumer</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pika</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\">credentials = pika.PlainCredentials(<span class=\"string\">&#x27;xxx&#x27;</span>, <span class=\"string\">&#x27;xxx&#x27;</span>)</span><br><span class=\"line\">connection = pika.BlockingConnection(pika.ConnectionParameters(<span class=\"string\">&#x27;amqp-cn-i7m2fw6ry00u.mq-amqp.cn-hangzhou-249959-a.aliyuncs.com&#x27;</span>, <span class=\"number\">5672</span>,<span class=\"string\">&#x27;liyanjun-test&#x27;</span>, credentials))</span><br><span class=\"line\">channel = connection.channel()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># client 1</span></span><br><span class=\"line\">result = channel.queue_declare(<span class=\"string\">&#x27;user_info_queue&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\"># client 2</span></span><br><span class=\"line\">result = channel.queue_declare(<span class=\"string\">&#x27;user_account_queue&#x27;</span>)    </span><br><span class=\"line\">queue_name = result.method.queue</span><br><span class=\"line\"></span><br><span class=\"line\">binding_keys = sys.argv[<span class=\"number\">1</span>:]</span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"keyword\">not</span> binding_keys:</span><br><span class=\"line\">    sys.stderr.write(<span class=\"string\">&quot;Usage: %s [binding_key]...\\n&quot;</span> % sys.argv[<span class=\"number\">0</span>])</span><br><span class=\"line\">    sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> binding_key <span class=\"keyword\">in</span> binding_keys:</span><br><span class=\"line\">    channel.queue_bind(exchange=<span class=\"string\">&#x27;userinfo_test&#x27;</span>, queue=queue_name, routing_key=binding_key)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27; [*] Waiting for logs. To exit press CTRL+C&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">callback</span>(<span class=\"params\">ch, method, properties, body</span>):</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot; [x] %r:%r&quot;</span> % (method.routing_key, body))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">channel.basic_consume(queue=queue_name, on_message_callback=callback, auto_ack=<span class=\"literal\">True</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">channel.start_consuming()</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># clientrouting key</span></span><br><span class=\"line\">python rabbitmq_client_test1.py user.info.test</span><br><span class=\"line\">python rabbitmq_client_test2.py user.account.test</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li></li>\n</ol>\n<ul>\n<li>userinfo_test Exchange binding key<ul>\n<li>user.info.#           &gt;  user_info_queue QUEUE </li>\n<li>user.account.#     &gt;  user_account_queue QUEUE </li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/9bae/rbmq10.png\" class>\n\n<ul>\n<li>Server user.info.test  routing_key client1 </li>\n</ul>\n<img data-src=\"/posts/9bae/rbmq11.png\" class>\n<img data-src=\"/posts/9bae/rbmq12.png\" class>\n\n\n<blockquote>\n<p><br>1<a href=\"https://www.rabbitmq.com/\">https://www.rabbitmq.com/</a><br>2RabbitMQ<a href=\"https://www.jianshu.com/p/79ca08116d57\">https://www.jianshu.com/p/79ca08116d57</a><br>3Alicloud<a href=\"https://help.aliyun.com/document_detail/141604.html\">https://help.aliyun.com/document_detail&#x2F;141604.html</a></p>\n</blockquote>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":6399,"excerpt":"<h3 id=\"RabbitMQ-\"><a href=\"#RabbitMQ-\" class=\"headerlink\" title=\"RabbitMQ \"></a>RabbitMQ </h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Message</p>\n<p>Message Queue MQ  MQ </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> MQ  MQ MQ MQ  MQ </p>\n<p></p>","more":"<h4 id=\"RabbitMQ-\"><a href=\"#RabbitMQ-\" class=\"headerlink\" title=\"RabbitMQ \"></a>RabbitMQ </h4><ul>\n<li></li>\n</ul>\n<p>AMQP Advanced Message Queue</p>\n<ul>\n<li><ul>\n<li></li>\n<li>Exchange </li>\n<li>RabbitMQ Broker</li>\n<li></li>\n<li></li>\n<li></li>\n<li>UI </li>\n<li></li>\n<li></li>\n</ul>\n</li>\n</ul>\n<h4 id=\"RabbitMQ-\"><a href=\"#RabbitMQ-\" class=\"headerlink\" title=\"RabbitMQ \"></a>RabbitMQ </h4><ul>\n<li><a href=\"https://help.aliyun.com/document_detail/101628.html\"></a></li>\n</ul>\n<p>VhostRabbitMQ <br>BrokerRabbitMQ </p>\n<p>ConnectionTCP RabbitMQ 15TCP <br>ChannelConnection TCP </p>\n<p>PublisherExchange <br>ConsumerQueue </p>\n<p>Message+routing-keyprioritydelivery-mode<br>ExchangeQueue<br>QueueConsumer<br>Bindingrouting-key Queue Exchange </p>\n<img data-src=\"/posts/9bae/rbmq1.png\" class>\n\n<ul>\n<li>AMQP </li>\n</ul>\n<p>AMQP  Exchange  Binding  Exchange  Binding </p>\n<img data-src=\"/posts/9bae/rbmq2.png\" class>\n\n<ul>\n<li>Exchange </li>\n</ul>\n<p>headers</p>\n<p>directMessagerouting-key Binding binding-key Queue</p>\n<img data-src=\"/posts/9bae/rbmq3.png\" class>\n\n<p>fanoutrouting-keyExchange Queue</p>\n<img data-src=\"/posts/9bae/rbmq4.png\" class>\n\n<p>topicrouting-key Queue </p>\n<img data-src=\"/posts/9bae/rbmq5.png\" class>\n\n<p>JMS Queue Exchangedirect <br>JMS topic Exchangetopic </p>\n<h4 id=\"RabbitMQ-\"><a href=\"#RabbitMQ-\" class=\"headerlink\" title=\"RabbitMQ \"></a>RabbitMQ </h4><p><a href=\"https://www.jianshu.com/p/79ca08116d57\">https://www.jianshu.com/p/79ca08116d57</a></p>\n<blockquote>\n<p></p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"RabbitMQ-\"><a href=\"#RabbitMQ-\" class=\"headerlink\" title=\"RabbitMQ \"></a>RabbitMQ </h4><ul>\n<li>RabbitMQ </li>\n</ul>\n<p>RabbitMQ </p>\n<img data-src=\"/posts/9bae/rbmq6.png\" class>\n\n<ul>\n<li><p></p>\n<ul>\n<li></li>\n<li></li>\n<li>Exchange</li>\n<li></li>\n</ul>\n</li>\n<li><p>ACK RabbitMQ </p>\n<ul>\n<li><p>RabbitMQ StatefulSet </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">camel-k-rabbitmq-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podManagementPolicy:</span> <span class=\"string\">OrderedReady</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">revisionHistoryLimit:</span> <span class=\"number\">10</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">camel-k-rabbitmq-test</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">camel-k-rabbitmq-test-svc</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">camel-k-rabbitmq-test</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">OPENSSL_SOURCE_SHA256</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">f89199be8b23ca45fc7cb9f1d8d3ee67312318286ad030f5316aca6462db6c96</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">OPENSSL_PGP_KEY_IDS</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"number\">0x8657ABB260F056B1E5190839D9C4D26D0E604491</span> <span class=\"number\">0x5B2545DAB21995F4088CEFAA36CEE4DEB00CFE33</span></span><br><span class=\"line\">            <span class=\"number\">0xED230BEC4D4F2518B9D7DF41F0DB4D21C1D35231</span> <span class=\"number\">0xC1F33DD8CE1D4CC613AF14DA9195C48241FBF7DD</span></span><br><span class=\"line\">            <span class=\"number\">0x7953AC1FBC3DC8B3B292393ED5E9E43F7DF9EE8C</span> <span class=\"number\">0xE5E52560DD91C556DDBDA5D02064C53641C25E5D</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">OTP_SOURCE_SHA256</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">af0f1928dcd16cd5746feeca8325811865578bf1a110a443d353ea3e509e6d41</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_DATA_DIR</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_PGP_KEY_ID</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"number\">0x0A9AF2115F4687BD29803A206B73A36E6026DFCA</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_HOME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">/opt/rabbitmq</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_LOGS</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&#x27;-&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">HOME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">LANG</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">C.UTF-8</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">LANGUAGE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">C.UTF-8</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">LC_ALL</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">C.UTF-8</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">rabbitmq:3.9.11-management</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">camel-k-rabbitmq-test</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15671</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">port1</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">port2</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15691</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15692</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">25672</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">4369</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5671</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">2Gi</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">250m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">512Mi</span></span><br><span class=\"line\">        <span class=\"attr\">terminationMessagePath:</span> <span class=\"string\">/dev/termination-log</span></span><br><span class=\"line\">        <span class=\"attr\">terminationMessagePolicy:</span> <span class=\"string\">File</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">volume-image-0</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">schedulerName:</span> <span class=\"string\">default-scheduler</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span> &#123;&#125;</span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">type:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">volume-image-0</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>RabbitMQ UI  5672 serverACK yaml Service SLB</p>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-svc</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"number\">192.168</span><span class=\"number\">.87</span><span class=\"number\">.198</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIPs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"number\">192.168</span><span class=\"number\">.87</span><span class=\"number\">.198</span></span><br><span class=\"line\">  <span class=\"attr\">externalTrafficPolicy:</span> <span class=\"string\">Cluster</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">nodePort:</span> <span class=\"number\">32166</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">camel-k-rabbitmq-test</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>Python RabbitMQ <a href=\"https://www.rabbitmq.com/tutorials/tutorial-one-python.html\">https://www.rabbitmq.com/tutorials/tutorial-one-python.html</a></p>\n</blockquote>\n<ol>\n<li>VhostExchangetopic </li>\n</ol>\n<img data-src=\"/posts/9bae/rbmq7.png\" class>\n<img data-src=\"/posts/9bae/rbmq8.png\" class>\n<img data-src=\"/posts/9bae/rbmq9.png\" class>\n\n\n\n<ol start=\"2\">\n<li>Python SDK </li>\n</ol>\n<p>Publisher</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pika</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\">credentials = pika.PlainCredentials(<span class=\"string\">&#x27;xxx&#x27;</span>, <span class=\"string\">&#x27;xxx&#x27;</span>)</span><br><span class=\"line\">connection = pika.BlockingConnection(pika.ConnectionParameters(<span class=\"string\">&#x27;xxx.com&#x27;</span>, <span class=\"number\">5672</span>,<span class=\"string\">&#x27;liyanjun-test&#x27;</span>, credentials))</span><br><span class=\"line\">channel = connection.channel()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  user.info.test routing key Exchange </span></span><br><span class=\"line\">routing_key = <span class=\"string\">&#x27;user.info.test&#x27;</span></span><br><span class=\"line\">message = <span class=\"string\">&#x27;liyanjun rabbitmq test send...&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">channel.basic_publish(exchange=<span class=\"string\">&#x27;userinfo_test&#x27;</span>, routing_key=routing_key, body=message)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot; [x] Sent %r:%r&quot;</span> % (routing_key, message))</span><br><span class=\"line\">connection.close()</span><br></pre></td></tr></table></figure>\n<p>Consumer</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pika</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\">credentials = pika.PlainCredentials(<span class=\"string\">&#x27;xxx&#x27;</span>, <span class=\"string\">&#x27;xxx&#x27;</span>)</span><br><span class=\"line\">connection = pika.BlockingConnection(pika.ConnectionParameters(<span class=\"string\">&#x27;amqp-cn-i7m2fw6ry00u.mq-amqp.cn-hangzhou-249959-a.aliyuncs.com&#x27;</span>, <span class=\"number\">5672</span>,<span class=\"string\">&#x27;liyanjun-test&#x27;</span>, credentials))</span><br><span class=\"line\">channel = connection.channel()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># client 1</span></span><br><span class=\"line\">result = channel.queue_declare(<span class=\"string\">&#x27;user_info_queue&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\"># client 2</span></span><br><span class=\"line\">result = channel.queue_declare(<span class=\"string\">&#x27;user_account_queue&#x27;</span>)    </span><br><span class=\"line\">queue_name = result.method.queue</span><br><span class=\"line\"></span><br><span class=\"line\">binding_keys = sys.argv[<span class=\"number\">1</span>:]</span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"keyword\">not</span> binding_keys:</span><br><span class=\"line\">    sys.stderr.write(<span class=\"string\">&quot;Usage: %s [binding_key]...\\n&quot;</span> % sys.argv[<span class=\"number\">0</span>])</span><br><span class=\"line\">    sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> binding_key <span class=\"keyword\">in</span> binding_keys:</span><br><span class=\"line\">    channel.queue_bind(exchange=<span class=\"string\">&#x27;userinfo_test&#x27;</span>, queue=queue_name, routing_key=binding_key)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27; [*] Waiting for logs. To exit press CTRL+C&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">callback</span>(<span class=\"params\">ch, method, properties, body</span>):</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot; [x] %r:%r&quot;</span> % (method.routing_key, body))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">channel.basic_consume(queue=queue_name, on_message_callback=callback, auto_ack=<span class=\"literal\">True</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">channel.start_consuming()</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># clientrouting key</span></span><br><span class=\"line\">python rabbitmq_client_test1.py user.info.test</span><br><span class=\"line\">python rabbitmq_client_test2.py user.account.test</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li></li>\n</ol>\n<ul>\n<li>userinfo_test Exchange binding key<ul>\n<li>user.info.#           &gt;  user_info_queue QUEUE </li>\n<li>user.account.#     &gt;  user_account_queue QUEUE </li>\n</ul>\n</li>\n</ul>\n<img data-src=\"/posts/9bae/rbmq10.png\" class>\n\n<ul>\n<li>Server user.info.test  routing_key client1 </li>\n</ul>\n<img data-src=\"/posts/9bae/rbmq11.png\" class>\n<img data-src=\"/posts/9bae/rbmq12.png\" class>\n\n\n<blockquote>\n<p><br>1<a href=\"https://www.rabbitmq.com/\">https://www.rabbitmq.com/</a><br>2RabbitMQ<a href=\"https://www.jianshu.com/p/79ca08116d57\">https://www.jianshu.com/p/79ca08116d57</a><br>3Alicloud<a href=\"https://help.aliyun.com/document_detail/141604.html\">https://help.aliyun.com/document_detail&#x2F;141604.html</a></p>\n</blockquote>"},{"title":" Ubuntu + Containerd  Kubernetes ","abbrlink":"28d6","date":"2022-06-07T14:17:15.000Z","_content":"### \n#### 1. multipass  \n```shell\n# \nssh-keygen -t rsa -b 4096 -f ~/k8s_rsa -C k8s\n\n#  Master \nmultipass launch -c 2 -m 2G -d 20G -n master --cloud-init - << EOF\nssh_authorized_keys:\n- $(cat ~/.ssh/k8s_rsa.pub)\nEOF\n\n#  Node \nmultipass launch -c 1 -m 2G -d 20G -n node1 --cloud-init - << EOF\nssh_authorized_keys:\n- $(cat ~/.ssh/k8s_rsa.pub)\nEOF\n\nmultipass launch -c 1 -m 2G -d 20G -n node2 --cloud-init - << EOF\nssh_authorized_keys:\n- $(cat ~/.ssh/k8s_rsa.pub)\nEOF\n```\n> --cloud-init  SSH\n<!--more-->\n\n\n#### 2. \n| ** IP** | **** | **** | **** |\n| --- | --- | --- | --- |\n| 192.168.64.4 | master1 | 2C/2G | master  |\n| 192.168.64.5 | node1 | 1C/1G | node  |\n| 192.168.64.6 | node2 | 1C/1G | node  |\n\n| ** Subnet** | **CIDR ** |\n| --- | --- |\n| nodeSubnet | 192.168.64.0/24 |\n| PodSubnet | 172.16.0.0/16 |\n| ServiceSubnet | 10.10.0.0/16 |\n\n\n#### 3.\n| **** | **** |\n| --- | --- |\n|  | Ubuntu 20.04.4 LTS |\n|  | 5.4.0-109-generic |\n| containerd | 1.5.10-1 |\n| kubernetes | v1.23.2 |\n| kubeadm | v1.23.2 |\n| kube-apiserver | v1.23.2 |\n| kube-controller-manager | v1.23.2 |\n| kube-scheduler | v1.23.2 |\n| kubectl | v1.23.2 |\n| kubelet | v1.23.2 |\n| kube-proxy |  |\n| etcd | v3.5.1 |\n| CNI calico | v3.18 |\n\n\n### \n#### 1. \n\n-  host \n```shell\nhostnamectl --static set-hostname master    # master \nhostnamectl --static set-hostname node1     # node1 \nhostnamectl --static set-hostname node2     # node2 \n\nsudo tee -a /etc/hosts << EOF\n192.168.64.4 master\n192.168.64.5 node1\n192.168.64.6 node2\nEOF\n```\n\n-  swap \n```shell\nsudo ufw disable && sudo systemctl disable ufw\n\nswapoff -a\nsed -ri 's/.*swap.*/#&/' /etc/fstab\n```\n> k8s swap  swap  kubelet , k8s   kublet  swap \n\n\n- \n```shell\nsudo cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\nsudo timedatectl set-timezone Asia/Shanghai\n\n#  UTC  (UTC)\nsudo timedatectl set-local-rtc 0\n#  NTP \nsudo timedatectl set-ntp yes\n\n# -( chronyc )\nsudo apt-get install chrony -y\nsudo chronyc tracking\n# -\n# chronyc -a makestep\n# \nsudo hwclock -w\n\n# \nsudo systemctl restart rsyslog.service cron.service\n```\n\n- \n```shell\n# 1. ipvs\nsudo apt-get install ipset ipvsadm -y\n\n# 2.\n# \nsudo tee /etc/modules-load.d/k8s.conf << EOF\n# netfilter\nbr_netfilter\n# containerd.\noverlay\n# ipvs\nip_vs\nip_vs_rr\nip_vs_wrr\nip_vs_sh\nnf_conntrack\nEOF\n# \nmod_tmp=(br_netfilter overlay ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack)\nfor m in ${mod_tmp[@]};do sudo modprobe $m; done\nlsmod | egrep \"ip_vs|nf_conntrack_ipv4\"\n\n# 3.\n#  sysctl \nsudo tee /etc/sysctl.d/99-kubernetes-cri.conf << EOF\nnet.bridge.bridge-nf-call-ipv6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\nEOF\n#  sysctl \nsudo sysctl --system\n```\n\n- master \n```shell\n# master \nssh-keygen\nssh-copy-id -i ~/.ssh/id_rsa.pub root@node1\nssh-copy-id -i ~/.ssh/id_rsa.pub root@node2\n```\n\n#### 2. \n```shell\n# 1.\nsudo apt-get remove docker docker-engine docker.io containerd runc\n \n# 2. apt  apt  HTTPS \nsudo apt-get update\nsudo apt-get install \\\n  apt-transport-https \\\n  ca-certificates \\\n  curl \\\n  gnupg \\\n  lsb-release -y\n\n# 3. Docker  GPG \nsudo mkdir -p /etc/apt/keyrings\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg\n\n# 4. nightly  test \necho \"deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\\n $(lsb_release -cs) stable nightly\" | sudo tee /etc/apt/sources.list.d/container.list\n \n# 5. containerd\n# apt  containerd \nsudo apt-get update\n# containerd.io \napt-cache madison containerd.io\n#\nsudo apt install containerd.io=1.5.10-1 -y\n\n# 6. containerd\ncontainerd config default | sudo tee /etc/containerd/config.toml\n# pause \nsudo sed -i \"s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g\"  /etc/containerd/config.toml\n# docker.io & gcr.io & k8s.gcr.io & quay.io \nsudo tee ~/tmp.txt << EOF\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]\n          endpoint = [\"https://taa4w07u.mirror.aliyuncs.com\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"gcr.io\"]\n          endpoint = [\"https://gcr.mirrors.ustc.edu.cn\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]\n          endpoint = [\"https://gcr.mirrors.ustc.edu.cn/google-containers/\", \"https://registry.aliyuncs.com/google-containers/\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"quay.io\"]\n          endpoint = [\"https://quay.mirrors.ustc.edu.cn\"]\nEOF\nsudo sed -i '/registry.mirrors\\]/r ./tmp.txt' /etc/containerd/config.toml\n# SystemdCgroup \nsudo sed -i 's# SystemdCgroup = false# SystemdCgroup = true#g' /etc/containerd/config.toml\n\n# 7. containerd \nsudo systemctl daemon-reload\nsudo systemctl enable containerd\nsudo systemctl restart containerd\n#\nsudo ctr version\n\n\n```\n\n### \n#### 1.\n```shell\n# Alicloud\ncurl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -\nsudo tee /etc/apt/sources.list.d/kubernetes.list << EOF\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\n\n#  apt  & \nsudo apt-get update\napt-cache madison kubeadm |head\nsudo apt install kubeadm=1.23.2-00 kubelet=1.23.2-00 kubectl=1.23.2-00 -y\n# \nsudo apt-mark hold kubelet kubeadm kubectl\n```\n\n```shell\n#  runtime \nsudo crictl config runtime-endpoint /run/containerd/containerd.sock\nsudo tee /etc/crictl.yaml << EOF\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 10\ndebug: false\nEOF\n\n#  systemd  kubelet \nsudo systemctl daemon-reload\nsudo systemctl enable --now kubelet\n#  kubelet  kubeadm \nsystemctl status kubelet \n\n```\n\n#### 2.\n+ Master \n```shell\n# \nkubeadm config print init-defaults > kubeadm.yaml\n\n# \ncat > kubeadm.yaml << EOF\napiVersion: kubeadm.k8s.io/v1beta3\nbootstrapTokens:\n- groups:\n  - system:bootstrappers:kubeadm:default-node-token\n  token: abcdef.0123456789abcdef\n  ttl: 24h0m0s\n  usages:\n  - signing\n  - authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 192.168.64.4 #  master  IP\n  bindPort: 6443\nnodeRegistration:\n  criSocket: /run/containerd/containerd.sock #  containerd\n  imagePullPolicy: IfNotPresent\n  name: master #  master \n  taints: # master \n  - effect: \"NoSchedule\"\n    key: \"node-role.kubernetes.io/master\"\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns: {}\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers # \nkind: ClusterConfiguration\nkubernetesVersion: 1.23.0\nnetworking:\n  dnsDomain: cluster.local\n  podSubnet: 172.16.0.0/16  #  Pod \n  serviceSubnet: 10.10.0.0/16 #  Service CIDR \nscheduler: {}\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmode: ipvs # kube-proxy ipvsiptables\n---\napiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\ncgroupDriver: systemd #  cgroup driver\nEOF\n\n# \nkubeadm config images list --config kubeadm.yaml\nkubeadm config images pull --config kubeadm.yaml\n\n#  master \nsudo kubeadm init --config=kubeadm.yaml\n\n```\n\n+ Node \n```shell\n#Node \nsudo kubeadm join 192.168.64.4:6443 --token abcdef.0123456789abcdef \\\n\t--discovery-token-ca-cert-hash sha256:6e25620c2478e38edfe335761b8dd37dbbe0dc8c1df9b41d539b148732d32718\n# join token \n#kubeadm token create --print-join-command\n\n# kubectl \nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n```\n\n#### 3. CNI calico\n> calico : [https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart](https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart)\n\n```shell\n# calico  calico \nwget https://docs.projectcalico.org/v3.18/manifests/calico.yaml\n#wget https://docs.projectcalico.org/v3.22/manifests/calico.yaml\n\n# \nvim calico.yaml\n- name: CALICO_IPV4POOL_CIDR\n  value: \"172.16.0.0/16\"\n  \n#  calico  Pod \nwatch kubectl get pod -n kube-system\nNAME                                       READY   STATUS    RESTARTS     AGE\ncalico-kube-controllers-6cfb54c7bb-7xdld   1/1     Running   0            2m51s\ncalico-node-sjr6r                          1/1     Running   0            2m52s\ncalico-node-vsczr                          1/1     Running   0            2m51s\n\n\n```\n\n```shell\n# \nkubectl label nodes master node-role.kubernetes.io/control-plane=\nkubectl label nodes node1 node-role.kubernetes.io/work=\nkubectl label nodes node2 node-role.kubernetes.io/work=\nkubectl get nodes\n\n#  kubectl \nsudo apt install -y bash-completion\nsource /usr/share/bash-completion/bash_completion\nsource <(kubectl completion bash)\necho \"source <(kubectl completion bash)\" >> ~/.bashrc\n\n# nerdctl  docker \n#\n# https://github.com/containerd/nerdctl\n#\nwget https://github.com/containerd/nerdctl/releases/download/v0.20.0/nerdctl-0.20.0-linux-amd64.tar.gz\ntar Cxfz /usr/local/bin/ nerdctl-0.20.0-linux-amd64.tar.gz\n#\nsudo nerdctl -n k8s.io images \nsudo nerdctl -n k8s.io ps\nsudo nerdctl -n k8s.io images     #  = sudo ctr -n k8s.io images ls\nsudo nerdctl -n k8s.io pull nginx #  = sudo crictl pull nginx\n```\n\n```shell\n# flannel  calico\nkubeadm reset\nifconfig cni0 down && ip link delete cni0\nifconfig flannel.1 down && ip link delete flannel.1\nrm -rf /var/lib/cni/\n```\n\n#### 4.\n```shell\n#  Nginx Deployment\nkubectl create deployment nginx --image=nginx\n\n#  Nginx  NodePort\nkubectl expose deployment nginx --port=80 --target-port=80 --type=NodePort \n\n# \ncurl 10.10.225.108:80 -I      #  Service port\ncurl 192.168.64.5:31052 -I    #  Node nodePort\ncurl 172.16.166.132:80 -I     #  Pod targetPort\n```\n\n#### 5.Kubernetes \n****\n\n- kube-apiserver\n- etcd\n- kube-scheduler  Pod //\n- kube-controller-manager\n\n****\n\n- kubelet\n- kubeproxy\n- CRcontainerdKubernetes  docker\n\n** Addons**\n\n- calicoflannel\n\n****\n\n- fluentd\n- Prometheus\n\n### Kubernetes Dashboard\n#### 1.Kubernetes \n> [https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/](https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/)\n\n```shell\n# 1. Dashboard \n#wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml\n#kubectl apply -f recommended.yaml\nkubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml\n\n# 2. Dashboard \n#\nkubectl get pod,service -n kubernetes-dashboard\n# nodePort \nkubectl edit service kubernetes-dashboard -n kubernetes-dashboard\n#===\n  ports:\n  - nodePort: 30333  # \n    port: 443\n    protocol: TCP\n    targetPort: 8443\n  selector:\n    k8s-app: kubernetes-dashboard\n  sessionAffinity: None\n  type: NodePort  # \n#### \n\n# 3. RBAC  ClusterRole \n# RBAC https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md\n# Dashboard\nkubectl describe secret -n kubernetes-dashboard $(kubectl get secret -n kubernetes-dashboard |grep kubernetes-dashboard-token |awk '{print $1}')\n#firefox https://192.168.64.4:30333\n# token  token  kubernetes-dashboard \n```\n\n#### 2.K9S \n[https://k9scli.io/](https://k9scli.io/)\n\n### \n1[multipass ](https://multipass.run/)\n2[Kubernetes ](https://kubernetes.io/zh/docs/concepts/overview/components/#container-runtime)\n3[ Kubernetes ](https://blog.weiyigeek.top/2022/5-7-654.html)\n\n","source":"_posts/ubuntuk8sdeploy.md","raw":"---\ntitle:  Ubuntu + Containerd  Kubernetes \ncategories:\n  - CNCF\ntags:\n  - Kubernetes\nabbrlink: 28d6\ndate: 2022-06-07 22:17:15\n---\n### \n#### 1. multipass  \n```shell\n# \nssh-keygen -t rsa -b 4096 -f ~/k8s_rsa -C k8s\n\n#  Master \nmultipass launch -c 2 -m 2G -d 20G -n master --cloud-init - << EOF\nssh_authorized_keys:\n- $(cat ~/.ssh/k8s_rsa.pub)\nEOF\n\n#  Node \nmultipass launch -c 1 -m 2G -d 20G -n node1 --cloud-init - << EOF\nssh_authorized_keys:\n- $(cat ~/.ssh/k8s_rsa.pub)\nEOF\n\nmultipass launch -c 1 -m 2G -d 20G -n node2 --cloud-init - << EOF\nssh_authorized_keys:\n- $(cat ~/.ssh/k8s_rsa.pub)\nEOF\n```\n> --cloud-init  SSH\n<!--more-->\n\n\n#### 2. \n| ** IP** | **** | **** | **** |\n| --- | --- | --- | --- |\n| 192.168.64.4 | master1 | 2C/2G | master  |\n| 192.168.64.5 | node1 | 1C/1G | node  |\n| 192.168.64.6 | node2 | 1C/1G | node  |\n\n| ** Subnet** | **CIDR ** |\n| --- | --- |\n| nodeSubnet | 192.168.64.0/24 |\n| PodSubnet | 172.16.0.0/16 |\n| ServiceSubnet | 10.10.0.0/16 |\n\n\n#### 3.\n| **** | **** |\n| --- | --- |\n|  | Ubuntu 20.04.4 LTS |\n|  | 5.4.0-109-generic |\n| containerd | 1.5.10-1 |\n| kubernetes | v1.23.2 |\n| kubeadm | v1.23.2 |\n| kube-apiserver | v1.23.2 |\n| kube-controller-manager | v1.23.2 |\n| kube-scheduler | v1.23.2 |\n| kubectl | v1.23.2 |\n| kubelet | v1.23.2 |\n| kube-proxy |  |\n| etcd | v3.5.1 |\n| CNI calico | v3.18 |\n\n\n### \n#### 1. \n\n-  host \n```shell\nhostnamectl --static set-hostname master    # master \nhostnamectl --static set-hostname node1     # node1 \nhostnamectl --static set-hostname node2     # node2 \n\nsudo tee -a /etc/hosts << EOF\n192.168.64.4 master\n192.168.64.5 node1\n192.168.64.6 node2\nEOF\n```\n\n-  swap \n```shell\nsudo ufw disable && sudo systemctl disable ufw\n\nswapoff -a\nsed -ri 's/.*swap.*/#&/' /etc/fstab\n```\n> k8s swap  swap  kubelet , k8s   kublet  swap \n\n\n- \n```shell\nsudo cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\nsudo timedatectl set-timezone Asia/Shanghai\n\n#  UTC  (UTC)\nsudo timedatectl set-local-rtc 0\n#  NTP \nsudo timedatectl set-ntp yes\n\n# -( chronyc )\nsudo apt-get install chrony -y\nsudo chronyc tracking\n# -\n# chronyc -a makestep\n# \nsudo hwclock -w\n\n# \nsudo systemctl restart rsyslog.service cron.service\n```\n\n- \n```shell\n# 1. ipvs\nsudo apt-get install ipset ipvsadm -y\n\n# 2.\n# \nsudo tee /etc/modules-load.d/k8s.conf << EOF\n# netfilter\nbr_netfilter\n# containerd.\noverlay\n# ipvs\nip_vs\nip_vs_rr\nip_vs_wrr\nip_vs_sh\nnf_conntrack\nEOF\n# \nmod_tmp=(br_netfilter overlay ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack)\nfor m in ${mod_tmp[@]};do sudo modprobe $m; done\nlsmod | egrep \"ip_vs|nf_conntrack_ipv4\"\n\n# 3.\n#  sysctl \nsudo tee /etc/sysctl.d/99-kubernetes-cri.conf << EOF\nnet.bridge.bridge-nf-call-ipv6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\nEOF\n#  sysctl \nsudo sysctl --system\n```\n\n- master \n```shell\n# master \nssh-keygen\nssh-copy-id -i ~/.ssh/id_rsa.pub root@node1\nssh-copy-id -i ~/.ssh/id_rsa.pub root@node2\n```\n\n#### 2. \n```shell\n# 1.\nsudo apt-get remove docker docker-engine docker.io containerd runc\n \n# 2. apt  apt  HTTPS \nsudo apt-get update\nsudo apt-get install \\\n  apt-transport-https \\\n  ca-certificates \\\n  curl \\\n  gnupg \\\n  lsb-release -y\n\n# 3. Docker  GPG \nsudo mkdir -p /etc/apt/keyrings\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg\n\n# 4. nightly  test \necho \"deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\\n $(lsb_release -cs) stable nightly\" | sudo tee /etc/apt/sources.list.d/container.list\n \n# 5. containerd\n# apt  containerd \nsudo apt-get update\n# containerd.io \napt-cache madison containerd.io\n#\nsudo apt install containerd.io=1.5.10-1 -y\n\n# 6. containerd\ncontainerd config default | sudo tee /etc/containerd/config.toml\n# pause \nsudo sed -i \"s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g\"  /etc/containerd/config.toml\n# docker.io & gcr.io & k8s.gcr.io & quay.io \nsudo tee ~/tmp.txt << EOF\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]\n          endpoint = [\"https://taa4w07u.mirror.aliyuncs.com\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"gcr.io\"]\n          endpoint = [\"https://gcr.mirrors.ustc.edu.cn\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]\n          endpoint = [\"https://gcr.mirrors.ustc.edu.cn/google-containers/\", \"https://registry.aliyuncs.com/google-containers/\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"quay.io\"]\n          endpoint = [\"https://quay.mirrors.ustc.edu.cn\"]\nEOF\nsudo sed -i '/registry.mirrors\\]/r ./tmp.txt' /etc/containerd/config.toml\n# SystemdCgroup \nsudo sed -i 's# SystemdCgroup = false# SystemdCgroup = true#g' /etc/containerd/config.toml\n\n# 7. containerd \nsudo systemctl daemon-reload\nsudo systemctl enable containerd\nsudo systemctl restart containerd\n#\nsudo ctr version\n\n\n```\n\n### \n#### 1.\n```shell\n# Alicloud\ncurl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -\nsudo tee /etc/apt/sources.list.d/kubernetes.list << EOF\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\n\n#  apt  & \nsudo apt-get update\napt-cache madison kubeadm |head\nsudo apt install kubeadm=1.23.2-00 kubelet=1.23.2-00 kubectl=1.23.2-00 -y\n# \nsudo apt-mark hold kubelet kubeadm kubectl\n```\n\n```shell\n#  runtime \nsudo crictl config runtime-endpoint /run/containerd/containerd.sock\nsudo tee /etc/crictl.yaml << EOF\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 10\ndebug: false\nEOF\n\n#  systemd  kubelet \nsudo systemctl daemon-reload\nsudo systemctl enable --now kubelet\n#  kubelet  kubeadm \nsystemctl status kubelet \n\n```\n\n#### 2.\n+ Master \n```shell\n# \nkubeadm config print init-defaults > kubeadm.yaml\n\n# \ncat > kubeadm.yaml << EOF\napiVersion: kubeadm.k8s.io/v1beta3\nbootstrapTokens:\n- groups:\n  - system:bootstrappers:kubeadm:default-node-token\n  token: abcdef.0123456789abcdef\n  ttl: 24h0m0s\n  usages:\n  - signing\n  - authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 192.168.64.4 #  master  IP\n  bindPort: 6443\nnodeRegistration:\n  criSocket: /run/containerd/containerd.sock #  containerd\n  imagePullPolicy: IfNotPresent\n  name: master #  master \n  taints: # master \n  - effect: \"NoSchedule\"\n    key: \"node-role.kubernetes.io/master\"\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns: {}\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers # \nkind: ClusterConfiguration\nkubernetesVersion: 1.23.0\nnetworking:\n  dnsDomain: cluster.local\n  podSubnet: 172.16.0.0/16  #  Pod \n  serviceSubnet: 10.10.0.0/16 #  Service CIDR \nscheduler: {}\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmode: ipvs # kube-proxy ipvsiptables\n---\napiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\ncgroupDriver: systemd #  cgroup driver\nEOF\n\n# \nkubeadm config images list --config kubeadm.yaml\nkubeadm config images pull --config kubeadm.yaml\n\n#  master \nsudo kubeadm init --config=kubeadm.yaml\n\n```\n\n+ Node \n```shell\n#Node \nsudo kubeadm join 192.168.64.4:6443 --token abcdef.0123456789abcdef \\\n\t--discovery-token-ca-cert-hash sha256:6e25620c2478e38edfe335761b8dd37dbbe0dc8c1df9b41d539b148732d32718\n# join token \n#kubeadm token create --print-join-command\n\n# kubectl \nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n```\n\n#### 3. CNI calico\n> calico : [https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart](https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart)\n\n```shell\n# calico  calico \nwget https://docs.projectcalico.org/v3.18/manifests/calico.yaml\n#wget https://docs.projectcalico.org/v3.22/manifests/calico.yaml\n\n# \nvim calico.yaml\n- name: CALICO_IPV4POOL_CIDR\n  value: \"172.16.0.0/16\"\n  \n#  calico  Pod \nwatch kubectl get pod -n kube-system\nNAME                                       READY   STATUS    RESTARTS     AGE\ncalico-kube-controllers-6cfb54c7bb-7xdld   1/1     Running   0            2m51s\ncalico-node-sjr6r                          1/1     Running   0            2m52s\ncalico-node-vsczr                          1/1     Running   0            2m51s\n\n\n```\n\n```shell\n# \nkubectl label nodes master node-role.kubernetes.io/control-plane=\nkubectl label nodes node1 node-role.kubernetes.io/work=\nkubectl label nodes node2 node-role.kubernetes.io/work=\nkubectl get nodes\n\n#  kubectl \nsudo apt install -y bash-completion\nsource /usr/share/bash-completion/bash_completion\nsource <(kubectl completion bash)\necho \"source <(kubectl completion bash)\" >> ~/.bashrc\n\n# nerdctl  docker \n#\n# https://github.com/containerd/nerdctl\n#\nwget https://github.com/containerd/nerdctl/releases/download/v0.20.0/nerdctl-0.20.0-linux-amd64.tar.gz\ntar Cxfz /usr/local/bin/ nerdctl-0.20.0-linux-amd64.tar.gz\n#\nsudo nerdctl -n k8s.io images \nsudo nerdctl -n k8s.io ps\nsudo nerdctl -n k8s.io images     #  = sudo ctr -n k8s.io images ls\nsudo nerdctl -n k8s.io pull nginx #  = sudo crictl pull nginx\n```\n\n```shell\n# flannel  calico\nkubeadm reset\nifconfig cni0 down && ip link delete cni0\nifconfig flannel.1 down && ip link delete flannel.1\nrm -rf /var/lib/cni/\n```\n\n#### 4.\n```shell\n#  Nginx Deployment\nkubectl create deployment nginx --image=nginx\n\n#  Nginx  NodePort\nkubectl expose deployment nginx --port=80 --target-port=80 --type=NodePort \n\n# \ncurl 10.10.225.108:80 -I      #  Service port\ncurl 192.168.64.5:31052 -I    #  Node nodePort\ncurl 172.16.166.132:80 -I     #  Pod targetPort\n```\n\n#### 5.Kubernetes \n****\n\n- kube-apiserver\n- etcd\n- kube-scheduler  Pod //\n- kube-controller-manager\n\n****\n\n- kubelet\n- kubeproxy\n- CRcontainerdKubernetes  docker\n\n** Addons**\n\n- calicoflannel\n\n****\n\n- fluentd\n- Prometheus\n\n### Kubernetes Dashboard\n#### 1.Kubernetes \n> [https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/](https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/)\n\n```shell\n# 1. Dashboard \n#wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml\n#kubectl apply -f recommended.yaml\nkubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml\n\n# 2. Dashboard \n#\nkubectl get pod,service -n kubernetes-dashboard\n# nodePort \nkubectl edit service kubernetes-dashboard -n kubernetes-dashboard\n#===\n  ports:\n  - nodePort: 30333  # \n    port: 443\n    protocol: TCP\n    targetPort: 8443\n  selector:\n    k8s-app: kubernetes-dashboard\n  sessionAffinity: None\n  type: NodePort  # \n#### \n\n# 3. RBAC  ClusterRole \n# RBAC https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md\n# Dashboard\nkubectl describe secret -n kubernetes-dashboard $(kubectl get secret -n kubernetes-dashboard |grep kubernetes-dashboard-token |awk '{print $1}')\n#firefox https://192.168.64.4:30333\n# token  token  kubernetes-dashboard \n```\n\n#### 2.K9S \n[https://k9scli.io/](https://k9scli.io/)\n\n### \n1[multipass ](https://multipass.run/)\n2[Kubernetes ](https://kubernetes.io/zh/docs/concepts/overview/components/#container-runtime)\n3[ Kubernetes ](https://blog.weiyigeek.top/2022/5-7-654.html)\n\n","slug":"ubuntuk8sdeploy","published":1,"updated":"2024-01-21T15:28:43.162Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cm0fat8zr0026s0nj920cab1s","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1-multipass-\"><a href=\"#1-multipass-\" class=\"headerlink\" title=\"1. multipass  \"></a>1. multipass  </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">ssh-keygen -t rsa -b 4096 -f ~/k8s_rsa -C k8s</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Master </span></span><br><span class=\"line\">multipass launch -c 2 -m 2G -d 20G -n master --cloud-init - &lt;&lt; EOF</span><br><span class=\"line\">ssh_authorized_keys:</span><br><span class=\"line\">- $(cat ~/.ssh/k8s_rsa.pub)</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Node </span></span><br><span class=\"line\">multipass launch -c 1 -m 2G -d 20G -n node1 --cloud-init - &lt;&lt; EOF</span><br><span class=\"line\">ssh_authorized_keys:</span><br><span class=\"line\">- $(cat ~/.ssh/k8s_rsa.pub)</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">multipass launch -c 1 -m 2G -d 20G -n node2 --cloud-init - &lt;&lt; EOF</span><br><span class=\"line\">ssh_authorized_keys:</span><br><span class=\"line\">- $(cat ~/.ssh/k8s_rsa.pub)</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>cloud-init  SSH</p>\n</blockquote>\n<span id=\"more\"></span>\n\n\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h4><table>\n<thead>\n<tr>\n<th><strong> IP</strong></th>\n<th><strong></strong></th>\n<th><strong></strong></th>\n<th><strong></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>192.168.64.4</td>\n<td>master1</td>\n<td>2C&#x2F;2G</td>\n<td>master </td>\n</tr>\n<tr>\n<td>192.168.64.5</td>\n<td>node1</td>\n<td>1C&#x2F;1G</td>\n<td>node </td>\n</tr>\n<tr>\n<td>192.168.64.6</td>\n<td>node2</td>\n<td>1C&#x2F;1G</td>\n<td>node </td>\n</tr>\n</tbody></table>\n<table>\n<thead>\n<tr>\n<th><strong> Subnet</strong></th>\n<th><strong>CIDR </strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>nodeSubnet</td>\n<td>192.168.64.0&#x2F;24</td>\n</tr>\n<tr>\n<td>PodSubnet</td>\n<td>172.16.0.0&#x2F;16</td>\n</tr>\n<tr>\n<td>ServiceSubnet</td>\n<td>10.10.0.0&#x2F;16</td>\n</tr>\n</tbody></table>\n<h4 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3.\"></a>3.</h4><table>\n<thead>\n<tr>\n<th><strong></strong></th>\n<th><strong></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td></td>\n<td>Ubuntu 20.04.4 LTS</td>\n</tr>\n<tr>\n<td></td>\n<td>5.4.0-109-generic</td>\n</tr>\n<tr>\n<td>containerd</td>\n<td>1.5.10-1</td>\n</tr>\n<tr>\n<td>kubernetes</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kubeadm</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kube-apiserver</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kube-controller-manager</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kube-scheduler</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kubectl</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kubelet</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kube-proxy</td>\n<td></td>\n</tr>\n<tr>\n<td>etcd</td>\n<td>v3.5.1</td>\n</tr>\n<tr>\n<td>CNI calico</td>\n<td>v3.18</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h4><ul>\n<li><p> host </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hostnamectl --static set-hostname master    # master </span><br><span class=\"line\">hostnamectl --static set-hostname node1     # node1 </span><br><span class=\"line\">hostnamectl --static set-hostname node2     # node2 </span><br><span class=\"line\"></span><br><span class=\"line\">sudo tee -a /etc/hosts &lt;&lt; EOF</span><br><span class=\"line\">192.168.64.4 master</span><br><span class=\"line\">192.168.64.5 node1</span><br><span class=\"line\">192.168.64.6 node2</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n<li><p> swap </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo ufw disable &amp;&amp; sudo systemctl disable ufw</span><br><span class=\"line\"></span><br><span class=\"line\">swapoff -a</span><br><span class=\"line\">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>k8s swap  swap  kubelet , k8s   kublet  swap </p>\n</blockquote>\n</li>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class=\"line\">sudo timedatectl set-timezone Asia/Shanghai</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> UTC  (UTC)</span></span><br><span class=\"line\">sudo timedatectl set-local-rtc 0</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> NTP </span></span><br><span class=\"line\">sudo timedatectl set-ntp yes</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">-( chronyc )</span></span><br><span class=\"line\">sudo apt-get install chrony -y</span><br><span class=\"line\">sudo chronyc tracking</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">-</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">chronyc -a makestep</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">sudo hwclock -w</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">sudo systemctl restart rsyslog.service cron.service</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1. ipvs</span></span><br><span class=\"line\">sudo apt-get install ipset ipvsadm -y</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2.</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">sudo tee /etc/modules-load.d/k8s.conf &lt;&lt; EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">netfilter</span></span><br><span class=\"line\">br_netfilter</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">containerd.</span></span><br><span class=\"line\">overlay</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ipvs</span></span><br><span class=\"line\">ip_vs</span><br><span class=\"line\">ip_vs_rr</span><br><span class=\"line\">ip_vs_wrr</span><br><span class=\"line\">ip_vs_sh</span><br><span class=\"line\">nf_conntrack</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">mod_tmp=(br_netfilter overlay ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack)</span><br><span class=\"line\">for m in $&#123;mod_tmp[@]&#125;;do sudo modprobe $m; done</span><br><span class=\"line\">lsmod | egrep &quot;ip_vs|nf_conntrack_ipv4&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3.</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> sysctl </span></span><br><span class=\"line\">sudo tee /etc/sysctl.d/99-kubernetes-cri.conf &lt;&lt; EOF</span><br><span class=\"line\">net.bridge.bridge-nf-call-ipv6tables = 1</span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 1</span><br><span class=\"line\">net.ipv4.ip_forward = 1</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> sysctl </span></span><br><span class=\"line\">sudo sysctl --system</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>master </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">master </span></span><br><span class=\"line\">ssh-keygen</span><br><span class=\"line\">ssh-copy-id -i ~/.ssh/id_rsa.pub root@node1</span><br><span class=\"line\">ssh-copy-id -i ~/.ssh/id_rsa.pub root@node2</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1.</span></span><br><span class=\"line\">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2. apt  apt  HTTPS </span></span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get install \\</span><br><span class=\"line\">  apt-transport-https \\</span><br><span class=\"line\">  ca-certificates \\</span><br><span class=\"line\">  curl \\</span><br><span class=\"line\">  gnupg \\</span><br><span class=\"line\">  lsb-release -y</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3. Docker  GPG </span></span><br><span class=\"line\">sudo mkdir -p /etc/apt/keyrings</span><br><span class=\"line\">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">4. nightly  <span class=\"built_in\">test</span> </span></span><br><span class=\"line\">echo &quot;deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\</span><br><span class=\"line\"><span class=\"meta prompt_\"> $</span><span class=\"language-bash\">(lsb_release -cs) stable nightly<span class=\"string\">&quot; | sudo tee /etc/apt/sources.list.d/container.list</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">5. containerd</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"> apt  containerd </span></span></span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"> containerd.io </span></span></span><br><span class=\"line\">apt-cache madison containerd.io</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"></span></span></span><br><span class=\"line\">sudo apt install containerd.io=1.5.10-1 -y</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">6. containerd</span></span></span><br><span class=\"line\">containerd config default | sudo tee /etc/containerd/config.toml</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"> pause </span></span></span><br><span class=\"line\">sudo sed -i &quot;s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g&quot;  /etc/containerd/config.toml</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">docker.io &amp; gcr.io &amp; k8s.gcr.io &amp; quay.io </span></span></span><br><span class=\"line\">sudo tee ~/tmp.txt &lt;&lt; EOF</span><br><span class=\"line\">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br><span class=\"line\">          endpoint = [&quot;https://taa4w07u.mirror.aliyuncs.com&quot;]</span><br><span class=\"line\">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;gcr.io&quot;]</span><br><span class=\"line\">          endpoint = [&quot;https://gcr.mirrors.ustc.edu.cn&quot;]</span><br><span class=\"line\">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;k8s.gcr.io&quot;]</span><br><span class=\"line\">          endpoint = [&quot;https://gcr.mirrors.ustc.edu.cn/google-containers/&quot;, &quot;https://registry.aliyuncs.com/google-containers/&quot;]</span><br><span class=\"line\">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;quay.io&quot;]</span><br><span class=\"line\">          endpoint = [&quot;https://quay.mirrors.ustc.edu.cn&quot;]</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sudo sed -i &#x27;/registry.mirrors\\]/r ./tmp.txt&#x27; /etc/containerd/config.toml</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"> SystemdCgroup </span></span></span><br><span class=\"line\">sudo sed -i &#x27;s# SystemdCgroup = false# SystemdCgroup = true#g&#x27; /etc/containerd/config.toml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">7. containerd </span></span></span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl enable containerd</span><br><span class=\"line\">sudo systemctl restart containerd</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"></span></span></span><br><span class=\"line\">sudo ctr version</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1.\"></a>1.</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Alicloud</span></span><br><span class=\"line\">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class=\"line\">sudo tee /etc/apt/sources.list.d/kubernetes.list &lt;&lt; EOF</span><br><span class=\"line\">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> apt  &amp; </span></span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">apt-cache madison kubeadm |head</span><br><span class=\"line\">sudo apt install kubeadm=1.23.2-00 kubelet=1.23.2-00 kubectl=1.23.2-00 -y</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">sudo apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> runtime </span></span><br><span class=\"line\">sudo crictl config runtime-endpoint /run/containerd/containerd.sock</span><br><span class=\"line\">sudo tee /etc/crictl.yaml &lt;&lt; EOF</span><br><span class=\"line\">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class=\"line\">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class=\"line\">timeout: 10</span><br><span class=\"line\">debug: false</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> systemd  kubelet </span></span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl enable --now kubelet</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> kubelet  kubeadm </span></span><br><span class=\"line\">systemctl status kubelet </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2.\"></a>2.</h4><ul>\n<li><p>Master </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubeadm config print init-defaults &gt; kubeadm.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat &gt; kubeadm.yaml &lt;&lt; EOF</span><br><span class=\"line\">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class=\"line\">bootstrapTokens:</span><br><span class=\"line\">- groups:</span><br><span class=\"line\">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class=\"line\">  token: abcdef.0123456789abcdef</span><br><span class=\"line\">  ttl: 24h0m0s</span><br><span class=\"line\">  usages:</span><br><span class=\"line\">  - signing</span><br><span class=\"line\">  - authentication</span><br><span class=\"line\">kind: InitConfiguration</span><br><span class=\"line\">localAPIEndpoint:</span><br><span class=\"line\">  advertiseAddress: 192.168.64.4 #  master  IP</span><br><span class=\"line\">  bindPort: 6443</span><br><span class=\"line\">nodeRegistration:</span><br><span class=\"line\">  criSocket: /run/containerd/containerd.sock #  containerd</span><br><span class=\"line\">  imagePullPolicy: IfNotPresent</span><br><span class=\"line\">  name: master #  master </span><br><span class=\"line\">  taints: # master </span><br><span class=\"line\">  - effect: &quot;NoSchedule&quot;</span><br><span class=\"line\">    key: &quot;node-role.kubernetes.io/master&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiServer:</span><br><span class=\"line\">  timeoutForControlPlane: 4m0s</span><br><span class=\"line\">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class=\"line\">certificatesDir: /etc/kubernetes/pki</span><br><span class=\"line\">clusterName: kubernetes</span><br><span class=\"line\">controllerManager: &#123;&#125;</span><br><span class=\"line\">dns: &#123;&#125;</span><br><span class=\"line\">etcd:</span><br><span class=\"line\">  local:</span><br><span class=\"line\">    dataDir: /var/lib/etcd</span><br><span class=\"line\">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers # </span><br><span class=\"line\">kind: ClusterConfiguration</span><br><span class=\"line\">kubernetesVersion: 1.23.0</span><br><span class=\"line\">networking:</span><br><span class=\"line\">  dnsDomain: cluster.local</span><br><span class=\"line\">  podSubnet: 172.16.0.0/16  #  Pod </span><br><span class=\"line\">  serviceSubnet: 10.10.0.0/16 #  Service CIDR </span><br><span class=\"line\">scheduler: &#123;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class=\"line\">kind: KubeProxyConfiguration</span><br><span class=\"line\">mode: ipvs # kube-proxy ipvsiptables</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class=\"line\">kind: KubeletConfiguration</span><br><span class=\"line\">cgroupDriver: systemd #  cgroup driver</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubeadm config images list --config kubeadm.yaml</span><br><span class=\"line\">kubeadm config images pull --config kubeadm.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> master </span></span><br><span class=\"line\">sudo kubeadm init --config=kubeadm.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Node </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Node </span></span><br><span class=\"line\">sudo kubeadm join 192.168.64.4:6443 --token abcdef.0123456789abcdef \\</span><br><span class=\"line\">\t--discovery-token-ca-cert-hash sha256:6e25620c2478e38edfe335761b8dd37dbbe0dc8c1df9b41d539b148732d32718</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> <span class=\"built_in\">join</span> token </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubeadm token create --print-join-command</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> kubectl </span></span><br><span class=\"line\">mkdir -p $HOME/.kube</span><br><span class=\"line\">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class=\"line\">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"3--CNI-calico\"><a href=\"#3--CNI-calico\" class=\"headerlink\" title=\"3. CNI calico\"></a>3. CNI calico</h4><blockquote>\n<p>calico : <a href=\"https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart\">https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart</a></p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">calico  calico </span></span><br><span class=\"line\">wget https://docs.projectcalico.org/v3.18/manifests/calico.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">wget https://docs.projectcalico.org/v3.22/manifests/calico.yaml</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">vim calico.yaml</span><br><span class=\"line\">- name: CALICO_IPV4POOL_CIDR</span><br><span class=\"line\">  value: &quot;172.16.0.0/16&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\">  </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> calico  Pod </span></span><br><span class=\"line\">watch kubectl get pod -n kube-system</span><br><span class=\"line\">NAME                                       READY   STATUS    RESTARTS     AGE</span><br><span class=\"line\">calico-kube-controllers-6cfb54c7bb-7xdld   1/1     Running   0            2m51s</span><br><span class=\"line\">calico-node-sjr6r                          1/1     Running   0            2m52s</span><br><span class=\"line\">calico-node-vsczr                          1/1     Running   0            2m51s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl label nodes master node-role.kubernetes.io/control-plane=</span><br><span class=\"line\">kubectl label nodes node1 node-role.kubernetes.io/work=</span><br><span class=\"line\">kubectl label nodes node2 node-role.kubernetes.io/work=</span><br><span class=\"line\">kubectl get nodes</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> kubectl </span></span><br><span class=\"line\">sudo apt install -y bash-completion</span><br><span class=\"line\">source /usr/share/bash-completion/bash_completion</span><br><span class=\"line\">source &lt;(kubectl completion bash)</span><br><span class=\"line\">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">nerdctl  docker </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">https://github.com/containerd/nerdctl</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">wget https://github.com/containerd/nerdctl/releases/download/v0.20.0/nerdctl-0.20.0-linux-amd64.tar.gz</span><br><span class=\"line\">tar Cxfz /usr/local/bin/ nerdctl-0.20.0-linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">sudo nerdctl -n k8s.io images </span><br><span class=\"line\">sudo nerdctl -n k8s.io ps</span><br><span class=\"line\">sudo nerdctl -n k8s.io images     #  = sudo ctr -n k8s.io images ls</span><br><span class=\"line\">sudo nerdctl -n k8s.io pull nginx #  = sudo crictl pull nginx</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">flannel  calico</span></span><br><span class=\"line\">kubeadm reset</span><br><span class=\"line\">ifconfig cni0 down &amp;&amp; ip link delete cni0</span><br><span class=\"line\">ifconfig flannel.1 down &amp;&amp; ip link delete flannel.1</span><br><span class=\"line\">rm -rf /var/lib/cni/</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-\"><a href=\"#4-\" class=\"headerlink\" title=\"4.\"></a>4.</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Nginx Deployment</span></span><br><span class=\"line\">kubectl create deployment nginx --image=nginx</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Nginx  NodePort</span></span><br><span class=\"line\">kubectl expose deployment nginx --port=80 --target-port=80 --type=NodePort </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">curl 10.10.225.108:80 -I      #  Service port</span><br><span class=\"line\">curl 192.168.64.5:31052 -I    #  Node nodePort</span><br><span class=\"line\">curl 172.16.166.132:80 -I     #  Pod targetPort</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-Kubernetes-\"><a href=\"#5-Kubernetes-\" class=\"headerlink\" title=\"5.Kubernetes \"></a>5.Kubernetes </h4><p><strong></strong></p>\n<ul>\n<li>kube-apiserver</li>\n<li>etcd</li>\n<li>kube-scheduler  Pod &#x2F;&#x2F;</li>\n<li>kube-controller-manager</li>\n</ul>\n<p><strong></strong></p>\n<ul>\n<li>kubelet</li>\n<li>kubeproxy</li>\n<li>CRcontainerdKubernetes  docker</li>\n</ul>\n<p><strong> Addons</strong></p>\n<ul>\n<li>calicoflannel</li>\n</ul>\n<p><strong></strong></p>\n<ul>\n<li>fluentd</li>\n<li>Prometheus</li>\n</ul>\n<h3 id=\"Kubernetes-Dashboard\"><a href=\"#Kubernetes-Dashboard\" class=\"headerlink\" title=\"Kubernetes Dashboard\"></a>Kubernetes Dashboard</h3><h4 id=\"1-Kubernetes-\"><a href=\"#1-Kubernetes-\" class=\"headerlink\" title=\"1.Kubernetes \"></a>1.Kubernetes </h4><blockquote>\n<p><a href=\"https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/\">https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/</a></p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1. Dashboard </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl apply -f recommended.yaml</span></span><br><span class=\"line\">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2. Dashboard </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get pod,service -n kubernetes-dashboard</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> nodePort </span></span><br><span class=\"line\">kubectl edit service kubernetes-dashboard -n kubernetes-dashboard</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">===</span></span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - nodePort: 30333  # </span><br><span class=\"line\">    port: 443</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 8443</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  type: NodePort  # </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">###</span></span> </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3. RBAC  ClusterRole </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">RBAC https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> Dashboard</span></span><br><span class=\"line\">kubectl describe secret -n kubernetes-dashboard $(kubectl get secret -n kubernetes-dashboard |grep kubernetes-dashboard-token |awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">firefox https://192.168.64.4:30333</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> token  token  kubernetes-dashboard </span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-K9S-\"><a href=\"#2-K9S-\" class=\"headerlink\" title=\"2.K9S \"></a>2.K9S </h4><p><a href=\"https://k9scli.io/\">https://k9scli.io/</a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>1<a href=\"https://multipass.run/\">multipass </a><br>2<a href=\"https://kubernetes.io/zh/docs/concepts/overview/components/#container-runtime\">Kubernetes </a><br>3<a href=\"https://blog.weiyigeek.top/2022/5-7-654.html\"> Kubernetes </a></p>\n","site":{"data":{"footer":"","styles":".post {\n  margin-top: 50px;\n  margin-bottom: 50px;\n  padding: 25px;\n  -webkit-box-shadow: 0 0 5px rgba(202,203,203,0.5);\n  -moz-box-shadow: 0 0 5px rgba(202,203,204,0.5);\n}\n.headband {\n  display: none;\n}\nbody {\n  background: url(\"/images/background.jpeg\");\n  background-repeat: no-repeat;\n  background-attachment: fixed;\n  background-size: cover;\n  background-position: 50% 50%;\n}\n.content-wrap {\n  opacity: 0.9;\n}\n.sidebar {\n  opacity: 0.9;\n}\n.header-inner {\n  background: rgba(255,255,255,0.9);\n}\n.popup {\n  opacity: 0.9;\n}\n.post-block.page {\n  margin-top: 40px;\n}\n.category-all-page {\n  box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);\n  background-color: #797d7f;\n  padding: 20px 30px 60px 30px;\n  border-radius: 25px 25px 25px 25px;\n}\n.category-all-title {\n  font-family: Impact;\n  font-size: 24px;\n  color: #0ff;\n}\n.category-list {\n  overflow: auto;\n}\n.category-list li {\n  height: 100%;\n  float: left;\n  border-right: 3px solid #222;\n  padding: 0 20px;\n}\n.category-all ul li {\n  list-style: none !important;\n}\n.category-list li:last-child {\n  border-right: none;\n}\n.category-list li a {\n  font-size: 16px;\n  text-decoration: none;\n  color: #7fff00;\n  font-family: Helvetica, Verdana, sans-serif;\n  -webkit-transition: all 0.5s ease;\n  -moz-transition: all 0.5s ease;\n  -o-transition: all 0.5s ease;\n  -ms-transition: all 0.5s ease;\n  transition: all 0.5s ease;\n}\n.category-list li a:hover {\n  color: #000;\n}\n.category-list li.active a {\n  font-weight: bold;\n  color: #000;\n}\n.tag-cloud a {\n  box-shadow: 0 1px 3px #6f42c1, 0 1px 2px #d9534f;\n  padding: 2px 10px;\n  margin: 8px;\n  background: rgba(193,66,92,0);\n  border-bottom: none;\n  border-radius: 20px;\n}\ncode {\n  background: #555;\n  color: #fff;\n}\n","variables":""}},"length":10836,"excerpt":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1-multipass-\"><a href=\"#1-multipass-\" class=\"headerlink\" title=\"1. multipass  \"></a>1. multipass  </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">ssh-keygen -t rsa -b 4096 -f ~/k8s_rsa -C k8s</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Master </span></span><br><span class=\"line\">multipass launch -c 2 -m 2G -d 20G -n master --cloud-init - &lt;&lt; EOF</span><br><span class=\"line\">ssh_authorized_keys:</span><br><span class=\"line\">- $(cat ~/.ssh/k8s_rsa.pub)</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Node </span></span><br><span class=\"line\">multipass launch -c 1 -m 2G -d 20G -n node1 --cloud-init - &lt;&lt; EOF</span><br><span class=\"line\">ssh_authorized_keys:</span><br><span class=\"line\">- $(cat ~/.ssh/k8s_rsa.pub)</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">multipass launch -c 1 -m 2G -d 20G -n node2 --cloud-init - &lt;&lt; EOF</span><br><span class=\"line\">ssh_authorized_keys:</span><br><span class=\"line\">- $(cat ~/.ssh/k8s_rsa.pub)</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>cloud-init  SSH</p>\n</blockquote>","more":"<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h4><table>\n<thead>\n<tr>\n<th><strong> IP</strong></th>\n<th><strong></strong></th>\n<th><strong></strong></th>\n<th><strong></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>192.168.64.4</td>\n<td>master1</td>\n<td>2C&#x2F;2G</td>\n<td>master </td>\n</tr>\n<tr>\n<td>192.168.64.5</td>\n<td>node1</td>\n<td>1C&#x2F;1G</td>\n<td>node </td>\n</tr>\n<tr>\n<td>192.168.64.6</td>\n<td>node2</td>\n<td>1C&#x2F;1G</td>\n<td>node </td>\n</tr>\n</tbody></table>\n<table>\n<thead>\n<tr>\n<th><strong> Subnet</strong></th>\n<th><strong>CIDR </strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>nodeSubnet</td>\n<td>192.168.64.0&#x2F;24</td>\n</tr>\n<tr>\n<td>PodSubnet</td>\n<td>172.16.0.0&#x2F;16</td>\n</tr>\n<tr>\n<td>ServiceSubnet</td>\n<td>10.10.0.0&#x2F;16</td>\n</tr>\n</tbody></table>\n<h4 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3.\"></a>3.</h4><table>\n<thead>\n<tr>\n<th><strong></strong></th>\n<th><strong></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td></td>\n<td>Ubuntu 20.04.4 LTS</td>\n</tr>\n<tr>\n<td></td>\n<td>5.4.0-109-generic</td>\n</tr>\n<tr>\n<td>containerd</td>\n<td>1.5.10-1</td>\n</tr>\n<tr>\n<td>kubernetes</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kubeadm</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kube-apiserver</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kube-controller-manager</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kube-scheduler</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kubectl</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kubelet</td>\n<td>v1.23.2</td>\n</tr>\n<tr>\n<td>kube-proxy</td>\n<td></td>\n</tr>\n<tr>\n<td>etcd</td>\n<td>v3.5.1</td>\n</tr>\n<tr>\n<td>CNI calico</td>\n<td>v3.18</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h4><ul>\n<li><p> host </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hostnamectl --static set-hostname master    # master </span><br><span class=\"line\">hostnamectl --static set-hostname node1     # node1 </span><br><span class=\"line\">hostnamectl --static set-hostname node2     # node2 </span><br><span class=\"line\"></span><br><span class=\"line\">sudo tee -a /etc/hosts &lt;&lt; EOF</span><br><span class=\"line\">192.168.64.4 master</span><br><span class=\"line\">192.168.64.5 node1</span><br><span class=\"line\">192.168.64.6 node2</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n</li>\n<li><p> swap </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo ufw disable &amp;&amp; sudo systemctl disable ufw</span><br><span class=\"line\"></span><br><span class=\"line\">swapoff -a</span><br><span class=\"line\">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>k8s swap  swap  kubelet , k8s   kublet  swap </p>\n</blockquote>\n</li>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class=\"line\">sudo timedatectl set-timezone Asia/Shanghai</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> UTC  (UTC)</span></span><br><span class=\"line\">sudo timedatectl set-local-rtc 0</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> NTP </span></span><br><span class=\"line\">sudo timedatectl set-ntp yes</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">-( chronyc )</span></span><br><span class=\"line\">sudo apt-get install chrony -y</span><br><span class=\"line\">sudo chronyc tracking</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">-</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">chronyc -a makestep</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">sudo hwclock -w</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">sudo systemctl restart rsyslog.service cron.service</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1. ipvs</span></span><br><span class=\"line\">sudo apt-get install ipset ipvsadm -y</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2.</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">sudo tee /etc/modules-load.d/k8s.conf &lt;&lt; EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">netfilter</span></span><br><span class=\"line\">br_netfilter</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">containerd.</span></span><br><span class=\"line\">overlay</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ipvs</span></span><br><span class=\"line\">ip_vs</span><br><span class=\"line\">ip_vs_rr</span><br><span class=\"line\">ip_vs_wrr</span><br><span class=\"line\">ip_vs_sh</span><br><span class=\"line\">nf_conntrack</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">mod_tmp=(br_netfilter overlay ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack)</span><br><span class=\"line\">for m in $&#123;mod_tmp[@]&#125;;do sudo modprobe $m; done</span><br><span class=\"line\">lsmod | egrep &quot;ip_vs|nf_conntrack_ipv4&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3.</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> sysctl </span></span><br><span class=\"line\">sudo tee /etc/sysctl.d/99-kubernetes-cri.conf &lt;&lt; EOF</span><br><span class=\"line\">net.bridge.bridge-nf-call-ipv6tables = 1</span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 1</span><br><span class=\"line\">net.ipv4.ip_forward = 1</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> sysctl </span></span><br><span class=\"line\">sudo sysctl --system</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>master </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">master </span></span><br><span class=\"line\">ssh-keygen</span><br><span class=\"line\">ssh-copy-id -i ~/.ssh/id_rsa.pub root@node1</span><br><span class=\"line\">ssh-copy-id -i ~/.ssh/id_rsa.pub root@node2</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1.</span></span><br><span class=\"line\">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2. apt  apt  HTTPS </span></span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get install \\</span><br><span class=\"line\">  apt-transport-https \\</span><br><span class=\"line\">  ca-certificates \\</span><br><span class=\"line\">  curl \\</span><br><span class=\"line\">  gnupg \\</span><br><span class=\"line\">  lsb-release -y</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3. Docker  GPG </span></span><br><span class=\"line\">sudo mkdir -p /etc/apt/keyrings</span><br><span class=\"line\">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">4. nightly  <span class=\"built_in\">test</span> </span></span><br><span class=\"line\">echo &quot;deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\</span><br><span class=\"line\"><span class=\"meta prompt_\"> $</span><span class=\"language-bash\">(lsb_release -cs) stable nightly<span class=\"string\">&quot; | sudo tee /etc/apt/sources.list.d/container.list</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">5. containerd</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"> apt  containerd </span></span></span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"> containerd.io </span></span></span><br><span class=\"line\">apt-cache madison containerd.io</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"></span></span></span><br><span class=\"line\">sudo apt install containerd.io=1.5.10-1 -y</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">6. containerd</span></span></span><br><span class=\"line\">containerd config default | sudo tee /etc/containerd/config.toml</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"> pause </span></span></span><br><span class=\"line\">sudo sed -i &quot;s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g&quot;  /etc/containerd/config.toml</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">docker.io &amp; gcr.io &amp; k8s.gcr.io &amp; quay.io </span></span></span><br><span class=\"line\">sudo tee ~/tmp.txt &lt;&lt; EOF</span><br><span class=\"line\">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br><span class=\"line\">          endpoint = [&quot;https://taa4w07u.mirror.aliyuncs.com&quot;]</span><br><span class=\"line\">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;gcr.io&quot;]</span><br><span class=\"line\">          endpoint = [&quot;https://gcr.mirrors.ustc.edu.cn&quot;]</span><br><span class=\"line\">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;k8s.gcr.io&quot;]</span><br><span class=\"line\">          endpoint = [&quot;https://gcr.mirrors.ustc.edu.cn/google-containers/&quot;, &quot;https://registry.aliyuncs.com/google-containers/&quot;]</span><br><span class=\"line\">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;quay.io&quot;]</span><br><span class=\"line\">          endpoint = [&quot;https://quay.mirrors.ustc.edu.cn&quot;]</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sudo sed -i &#x27;/registry.mirrors\\]/r ./tmp.txt&#x27; /etc/containerd/config.toml</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"> SystemdCgroup </span></span></span><br><span class=\"line\">sudo sed -i &#x27;s# SystemdCgroup = false# SystemdCgroup = true#g&#x27; /etc/containerd/config.toml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">7. containerd </span></span></span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl enable containerd</span><br><span class=\"line\">sudo systemctl restart containerd</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"string\"></span></span></span><br><span class=\"line\">sudo ctr version</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1.\"></a>1.</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Alicloud</span></span><br><span class=\"line\">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class=\"line\">sudo tee /etc/apt/sources.list.d/kubernetes.list &lt;&lt; EOF</span><br><span class=\"line\">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> apt  &amp; </span></span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">apt-cache madison kubeadm |head</span><br><span class=\"line\">sudo apt install kubeadm=1.23.2-00 kubelet=1.23.2-00 kubectl=1.23.2-00 -y</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">sudo apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> runtime </span></span><br><span class=\"line\">sudo crictl config runtime-endpoint /run/containerd/containerd.sock</span><br><span class=\"line\">sudo tee /etc/crictl.yaml &lt;&lt; EOF</span><br><span class=\"line\">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class=\"line\">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class=\"line\">timeout: 10</span><br><span class=\"line\">debug: false</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> systemd  kubelet </span></span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl enable --now kubelet</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> kubelet  kubeadm </span></span><br><span class=\"line\">systemctl status kubelet </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2.\"></a>2.</h4><ul>\n<li><p>Master </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubeadm config print init-defaults &gt; kubeadm.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">cat &gt; kubeadm.yaml &lt;&lt; EOF</span><br><span class=\"line\">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class=\"line\">bootstrapTokens:</span><br><span class=\"line\">- groups:</span><br><span class=\"line\">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class=\"line\">  token: abcdef.0123456789abcdef</span><br><span class=\"line\">  ttl: 24h0m0s</span><br><span class=\"line\">  usages:</span><br><span class=\"line\">  - signing</span><br><span class=\"line\">  - authentication</span><br><span class=\"line\">kind: InitConfiguration</span><br><span class=\"line\">localAPIEndpoint:</span><br><span class=\"line\">  advertiseAddress: 192.168.64.4 #  master  IP</span><br><span class=\"line\">  bindPort: 6443</span><br><span class=\"line\">nodeRegistration:</span><br><span class=\"line\">  criSocket: /run/containerd/containerd.sock #  containerd</span><br><span class=\"line\">  imagePullPolicy: IfNotPresent</span><br><span class=\"line\">  name: master #  master </span><br><span class=\"line\">  taints: # master </span><br><span class=\"line\">  - effect: &quot;NoSchedule&quot;</span><br><span class=\"line\">    key: &quot;node-role.kubernetes.io/master&quot;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiServer:</span><br><span class=\"line\">  timeoutForControlPlane: 4m0s</span><br><span class=\"line\">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class=\"line\">certificatesDir: /etc/kubernetes/pki</span><br><span class=\"line\">clusterName: kubernetes</span><br><span class=\"line\">controllerManager: &#123;&#125;</span><br><span class=\"line\">dns: &#123;&#125;</span><br><span class=\"line\">etcd:</span><br><span class=\"line\">  local:</span><br><span class=\"line\">    dataDir: /var/lib/etcd</span><br><span class=\"line\">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers # </span><br><span class=\"line\">kind: ClusterConfiguration</span><br><span class=\"line\">kubernetesVersion: 1.23.0</span><br><span class=\"line\">networking:</span><br><span class=\"line\">  dnsDomain: cluster.local</span><br><span class=\"line\">  podSubnet: 172.16.0.0/16  #  Pod </span><br><span class=\"line\">  serviceSubnet: 10.10.0.0/16 #  Service CIDR </span><br><span class=\"line\">scheduler: &#123;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class=\"line\">kind: KubeProxyConfiguration</span><br><span class=\"line\">mode: ipvs # kube-proxy ipvsiptables</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class=\"line\">kind: KubeletConfiguration</span><br><span class=\"line\">cgroupDriver: systemd #  cgroup driver</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubeadm config images list --config kubeadm.yaml</span><br><span class=\"line\">kubeadm config images pull --config kubeadm.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> master </span></span><br><span class=\"line\">sudo kubeadm init --config=kubeadm.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Node </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Node </span></span><br><span class=\"line\">sudo kubeadm join 192.168.64.4:6443 --token abcdef.0123456789abcdef \\</span><br><span class=\"line\">\t--discovery-token-ca-cert-hash sha256:6e25620c2478e38edfe335761b8dd37dbbe0dc8c1df9b41d539b148732d32718</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> <span class=\"built_in\">join</span> token </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubeadm token create --print-join-command</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> kubectl </span></span><br><span class=\"line\">mkdir -p $HOME/.kube</span><br><span class=\"line\">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class=\"line\">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"3--CNI-calico\"><a href=\"#3--CNI-calico\" class=\"headerlink\" title=\"3. CNI calico\"></a>3. CNI calico</h4><blockquote>\n<p>calico : <a href=\"https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart\">https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart</a></p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">calico  calico </span></span><br><span class=\"line\">wget https://docs.projectcalico.org/v3.18/manifests/calico.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">wget https://docs.projectcalico.org/v3.22/manifests/calico.yaml</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">vim calico.yaml</span><br><span class=\"line\">- name: CALICO_IPV4POOL_CIDR</span><br><span class=\"line\">  value: &quot;172.16.0.0/16&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\">  </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> calico  Pod </span></span><br><span class=\"line\">watch kubectl get pod -n kube-system</span><br><span class=\"line\">NAME                                       READY   STATUS    RESTARTS     AGE</span><br><span class=\"line\">calico-kube-controllers-6cfb54c7bb-7xdld   1/1     Running   0            2m51s</span><br><span class=\"line\">calico-node-sjr6r                          1/1     Running   0            2m52s</span><br><span class=\"line\">calico-node-vsczr                          1/1     Running   0            2m51s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl label nodes master node-role.kubernetes.io/control-plane=</span><br><span class=\"line\">kubectl label nodes node1 node-role.kubernetes.io/work=</span><br><span class=\"line\">kubectl label nodes node2 node-role.kubernetes.io/work=</span><br><span class=\"line\">kubectl get nodes</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> kubectl </span></span><br><span class=\"line\">sudo apt install -y bash-completion</span><br><span class=\"line\">source /usr/share/bash-completion/bash_completion</span><br><span class=\"line\">source &lt;(kubectl completion bash)</span><br><span class=\"line\">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">nerdctl  docker </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">https://github.com/containerd/nerdctl</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">wget https://github.com/containerd/nerdctl/releases/download/v0.20.0/nerdctl-0.20.0-linux-amd64.tar.gz</span><br><span class=\"line\">tar Cxfz /usr/local/bin/ nerdctl-0.20.0-linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">sudo nerdctl -n k8s.io images </span><br><span class=\"line\">sudo nerdctl -n k8s.io ps</span><br><span class=\"line\">sudo nerdctl -n k8s.io images     #  = sudo ctr -n k8s.io images ls</span><br><span class=\"line\">sudo nerdctl -n k8s.io pull nginx #  = sudo crictl pull nginx</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">flannel  calico</span></span><br><span class=\"line\">kubeadm reset</span><br><span class=\"line\">ifconfig cni0 down &amp;&amp; ip link delete cni0</span><br><span class=\"line\">ifconfig flannel.1 down &amp;&amp; ip link delete flannel.1</span><br><span class=\"line\">rm -rf /var/lib/cni/</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-\"><a href=\"#4-\" class=\"headerlink\" title=\"4.\"></a>4.</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Nginx Deployment</span></span><br><span class=\"line\">kubectl create deployment nginx --image=nginx</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> Nginx  NodePort</span></span><br><span class=\"line\">kubectl expose deployment nginx --port=80 --target-port=80 --type=NodePort </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"></span></span><br><span class=\"line\">curl 10.10.225.108:80 -I      #  Service port</span><br><span class=\"line\">curl 192.168.64.5:31052 -I    #  Node nodePort</span><br><span class=\"line\">curl 172.16.166.132:80 -I     #  Pod targetPort</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-Kubernetes-\"><a href=\"#5-Kubernetes-\" class=\"headerlink\" title=\"5.Kubernetes \"></a>5.Kubernetes </h4><p><strong></strong></p>\n<ul>\n<li>kube-apiserver</li>\n<li>etcd</li>\n<li>kube-scheduler  Pod &#x2F;&#x2F;</li>\n<li>kube-controller-manager</li>\n</ul>\n<p><strong></strong></p>\n<ul>\n<li>kubelet</li>\n<li>kubeproxy</li>\n<li>CRcontainerdKubernetes  docker</li>\n</ul>\n<p><strong> Addons</strong></p>\n<ul>\n<li>calicoflannel</li>\n</ul>\n<p><strong></strong></p>\n<ul>\n<li>fluentd</li>\n<li>Prometheus</li>\n</ul>\n<h3 id=\"Kubernetes-Dashboard\"><a href=\"#Kubernetes-Dashboard\" class=\"headerlink\" title=\"Kubernetes Dashboard\"></a>Kubernetes Dashboard</h3><h4 id=\"1-Kubernetes-\"><a href=\"#1-Kubernetes-\" class=\"headerlink\" title=\"1.Kubernetes \"></a>1.Kubernetes </h4><blockquote>\n<p><a href=\"https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/\">https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/</a></p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1. Dashboard </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">kubectl apply -f recommended.yaml</span></span><br><span class=\"line\">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2. Dashboard </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\">kubectl get pod,service -n kubernetes-dashboard</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> nodePort </span></span><br><span class=\"line\">kubectl edit service kubernetes-dashboard -n kubernetes-dashboard</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">===</span></span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - nodePort: 30333  # </span><br><span class=\"line\">    port: 443</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 8443</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  type: NodePort  # </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">###</span></span> </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3. RBAC  ClusterRole </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">RBAC https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> Dashboard</span></span><br><span class=\"line\">kubectl describe secret -n kubernetes-dashboard $(kubectl get secret -n kubernetes-dashboard |grep kubernetes-dashboard-token |awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">firefox https://192.168.64.4:30333</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"> token  token  kubernetes-dashboard </span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-K9S-\"><a href=\"#2-K9S-\" class=\"headerlink\" title=\"2.K9S \"></a>2.K9S </h4><p><a href=\"https://k9scli.io/\">https://k9scli.io/</a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>1<a href=\"https://multipass.run/\">multipass </a><br>2<a href=\"https://kubernetes.io/zh/docs/concepts/overview/components/#container-runtime\">Kubernetes </a><br>3<a href=\"https://blog.weiyigeek.top/2022/5-7-654.html\"> Kubernetes </a></p>"}],"PostAsset":[{"_id":"source/_posts/alicloud-vpc/vpc1.png","slug":"vpc1.png","post":"cm0fat8zj0007s0nj78qnen2i","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-vpc/vpc2.png","slug":"vpc2.png","post":"cm0fat8zj0007s0nj78qnen2i","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-vpc/vpc3.png","slug":"vpc3.png","post":"cm0fat8zj0007s0nj78qnen2i","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-vpc/vpc4.png","slug":"vpc4.png","post":"cm0fat8zj0007s0nj78qnen2i","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ram-sts/ram1.png","slug":"ram1.png","post":"cm0fat8zh0003s0njgnlk7dhl","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ram-sts/ram2.png","slug":"ram2.png","post":"cm0fat8zh0003s0njgnlk7dhl","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ram-sts/ram3.png","slug":"ram3.png","post":"cm0fat8zh0003s0njgnlk7dhl","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ram-sts/ram4.png","slug":"ram4.png","post":"cm0fat8zh0003s0njgnlk7dhl","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ram-sts/ram5.png","slug":"ram5.png","post":"cm0fat8zh0003s0njgnlk7dhl","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ram-sts/ram6.png","slug":"ram6.png","post":"cm0fat8zh0003s0njgnlk7dhl","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ram-sts/ram7.png","slug":"ram7.png","post":"cm0fat8zh0003s0njgnlk7dhl","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ram-sts/ram8.png","slug":"ram8.png","post":"cm0fat8zh0003s0njgnlk7dhl","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls1.png","slug":"acksls1.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls10.png","slug":"acksls10.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls11.png","slug":"acksls11.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls12.png","slug":"acksls12.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls13.png","slug":"acksls13.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls14.png","slug":"acksls14.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls15.png","slug":"acksls15.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls16.png","slug":"acksls16.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls2.png","slug":"acksls2.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls3.png","slug":"acksls3.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls4.png","slug":"acksls4.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls5.png","slug":"acksls5.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls6.png","slug":"acksls6.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls7.png","slug":"acksls7.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls8.png","slug":"acksls8.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/alicloud-ack-sls-deploy/acksls9.png","slug":"acksls9.png","post":"cm0fat8zg0001s0njgl080pl2","modified":0,"renderable":0},{"_id":"source/_posts/helm-deploy/helm1.png","slug":"helm1.png","post":"cm0fat8zl000ks0nj53b06id7","modified":0,"renderable":0},{"_id":"source/_posts/helm-deploy/helm2.png","slug":"helm2.png","post":"cm0fat8zl000ks0nj53b06id7","modified":0,"renderable":0},{"_id":"source/_posts/helm-deploy/helm3.png","slug":"helm3.png","post":"cm0fat8zl000ks0nj53b06id7","modified":0,"renderable":0},{"_id":"source/_posts/helm-deploy/helm4.png","slug":"helm4.png","post":"cm0fat8zl000ks0nj53b06id7","modified":0,"renderable":0},{"_id":"source/_posts/helm-deploy/helm5.png","slug":"helm5.png","post":"cm0fat8zl000ks0nj53b06id7","modified":0,"renderable":0},{"_id":"source/_posts/k8s-ack-learn/k8s1.png","slug":"k8s1.png","post":"cm0fat8zm000ms0njbhzpcuxw","modified":0,"renderable":0},{"_id":"source/_posts/k8s-ack-learn/k8s2.png","slug":"k8s2.png","post":"cm0fat8zm000ms0njbhzpcuxw","modified":0,"renderable":0},{"_id":"source/_posts/k8s-ack-learn/k8s3.png","slug":"k8s3.png","post":"cm0fat8zm000ms0njbhzpcuxw","modified":0,"renderable":0},{"_id":"source/_posts/k8s-ack-learn/k8s4.png","slug":"k8s4.png","post":"cm0fat8zm000ms0njbhzpcuxw","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf1.png","slug":"gf1.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf10.png","slug":"gf10.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf11.png","slug":"gf11.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf12.png","slug":"gf12.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf13.png","slug":"gf13.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf14.png","slug":"gf14.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf15.png","slug":"gf15.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf2.png","slug":"gf2.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf3.png","slug":"gf3.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf4.png","slug":"gf4.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf5.png","slug":"gf5.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf6.png","slug":"gf6.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf7.png","slug":"gf7.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf8.png","slug":"gf8.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/git-flow/gf9.png","slug":"gf9.png","post":"cm0fat8zl000gs0njfffade4a","modified":0,"renderable":0},{"_id":"source/_posts/k8s-networkpolicy/2afdc3d69fa9.png","slug":"2afdc3d69fa9.png","post":"cm0fat8zn000qs0nj1nkr7p0e","modified":0,"renderable":0},{"_id":"source/_posts/k8s-networkpolicy/6bbe6aab7201.png","slug":"6bbe6aab7201.png","post":"cm0fat8zn000qs0nj1nkr7p0e","modified":0,"renderable":0},{"_id":"source/_posts/k8s-networkpolicy/7b70de99e5f7.png","slug":"7b70de99e5f7.png","post":"cm0fat8zn000qs0nj1nkr7p0e","modified":0,"renderable":0},{"_id":"source/_posts/observability-fluentd-component/fluent1.png","slug":"fluent1.png","post":"cm0fat8zq001ps0njgnra83jk","modified":0,"renderable":0},{"_id":"source/_posts/observability-fluentd-component/fluent2.png","slug":"fluent2.png","post":"cm0fat8zq001ps0njgnra83jk","modified":0,"renderable":0},{"_id":"source/_posts/observability-fluentd-component/fluent3.png","slug":"fluent3.png","post":"cm0fat8zq001ps0njgnra83jk","modified":0,"renderable":0},{"_id":"source/_posts/observability-fluentd-component/fluent4.png","slug":"fluent4.png","post":"cm0fat8zq001ps0njgnra83jk","modified":0,"renderable":0},{"_id":"source/_posts/k8s-rbac/1572c2ebc891.png","slug":"1572c2ebc891.png","post":"cm0fat8zp001ns0nj9rlw9lar","modified":0,"renderable":0},{"_id":"source/_posts/k8s-rbac/21812e1bbfad.png","slug":"21812e1bbfad.png","post":"cm0fat8zp001ns0nj9rlw9lar","modified":0,"renderable":0},{"_id":"source/_posts/k8s-rbac/634be995b5bc.png","slug":"634be995b5bc.png","post":"cm0fat8zp001ns0nj9rlw9lar","modified":0,"renderable":0},{"_id":"source/_posts/k8s-rbac/7528aa1bf3da.png","slug":"7528aa1bf3da.png","post":"cm0fat8zp001ns0nj9rlw9lar","modified":0,"renderable":0},{"_id":"source/_posts/k8s-rbac/ab8f20ce2acc.png","slug":"ab8f20ce2acc.png","post":"cm0fat8zp001ns0nj9rlw9lar","modified":0,"renderable":0},{"_id":"source/_posts/k8s-rbac/c31775e8bbe3.png","slug":"c31775e8bbe3.png","post":"cm0fat8zp001ns0nj9rlw9lar","modified":0,"renderable":0},{"_id":"source/_posts/k8s-rbac/d6da8c845c41.png","slug":"d6da8c845c41.png","post":"cm0fat8zp001ns0nj9rlw9lar","modified":0,"renderable":0},{"_id":"source/_posts/k8s-rbac/de3ebdd4f016.png","slug":"de3ebdd4f016.png","post":"cm0fat8zp001ns0nj9rlw9lar","modified":0,"renderable":0},{"_id":"source/_posts/k8s-rbac/de4222775e67.png","slug":"de4222775e67.png","post":"cm0fat8zp001ns0nj9rlw9lar","modified":0,"renderable":0},{"_id":"source/_posts/k8s-rbac/gaisu.png","slug":"gaisu.png","post":"cm0fat8zp001ns0nj9rlw9lar","modified":0,"renderable":0},{"_id":"source/_posts/k8s-network/k8s-nw1.png","slug":"k8s-nw1.png","post":"cm0fat8zp001ms0nj1dyrabyk","modified":0,"renderable":0},{"_id":"source/_posts/k8s-network/k8s-nw2.png","slug":"k8s-nw2.png","post":"cm0fat8zp001ms0nj1dyrabyk","modified":0,"renderable":0},{"_id":"source/_posts/k8s-network/k8s-nw3.png","slug":"k8s-nw3.png","post":"cm0fat8zp001ms0nj1dyrabyk","modified":0,"renderable":0},{"_id":"source/_posts/k8s-network/k8s-nw4.png","slug":"k8s-nw4.png","post":"cm0fat8zp001ms0nj1dyrabyk","modified":0,"renderable":0},{"_id":"source/_posts/k8s-network/k8s-nw5.png","slug":"k8s-nw5.png","post":"cm0fat8zp001ms0nj1dyrabyk","modified":0,"renderable":0},{"_id":"source/_posts/k8s-network/k8s-nw6.png","slug":"k8s-nw6.png","post":"cm0fat8zp001ms0nj1dyrabyk","modified":0,"renderable":0},{"_id":"source/_posts/k8s-network/k8s-nw7.png","slug":"k8s-nw7.png","post":"cm0fat8zp001ms0nj1dyrabyk","modified":0,"renderable":0},{"_id":"source/_posts/k8s-network/k8s-nw8.png","slug":"k8s-nw8.png","post":"cm0fat8zp001ms0nj1dyrabyk","modified":0,"renderable":0},{"_id":"source/_posts/openssl-basic/openssl-1.jpeg","slug":"openssl-1.jpeg","post":"cm0fat8zq001rs0nj45ma5k69","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq1.png","slug":"rbmq1.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq10.png","slug":"rbmq10.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq11.png","slug":"rbmq11.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq12.png","slug":"rbmq12.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq2.png","slug":"rbmq2.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq3.png","slug":"rbmq3.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq4.png","slug":"rbmq4.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq5.png","slug":"rbmq5.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq6.png","slug":"rbmq6.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq7.png","slug":"rbmq7.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq8.png","slug":"rbmq8.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/rabbitmq/rbmq9.png","slug":"rbmq9.png","post":"cm0fat8zr0023s0nje0aahnle","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/1.png","slug":"1.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/10.png","slug":"10.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/11.png","slug":"11.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/12.png","slug":"12.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/13.png","slug":"13.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/14.png","slug":"14.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/15.png","slug":"15.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/16.png","slug":"16.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/17.png","slug":"17.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/2.png","slug":"2.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/3.png","slug":"3.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/4.png","slug":"4.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/5.png","slug":"5.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/6.png","slug":"6.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/7.png","slug":"7.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/8.png","slug":"8.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0},{"_id":"source/_posts/prometheus-grafana-notice/9.png","slug":"9.png","post":"cm0fat8zq001xs0njexlfbxdk","modified":0,"renderable":0}],"PostCategory":[{"post_id":"cm0fat8zg0001s0njgl080pl2","category_id":"cm0fat8zi0004s0njgieg3w5h","_id":"cm0fat8zl000is0njdmpa3p2a"},{"post_id":"cm0fat8zh0003s0njgnlk7dhl","category_id":"cm0fat8zi0004s0njgieg3w5h","_id":"cm0fat8zn000os0njhbwscr8l"},{"post_id":"cm0fat8zk000bs0nj1p9k5py2","category_id":"cm0fat8zn000ns0njdxr37li7","_id":"cm0fat8zn000vs0nj03yqe1v3"},{"post_id":"cm0fat8zl000gs0njfffade4a","category_id":"cm0fat8zn000ws0njb5pid2pg","_id":"cm0fat8zo0013s0nj4uwd46uz"},{"post_id":"cm0fat8zl000ks0nj53b06id7","category_id":"cm0fat8zn000ss0njdmbp1ahq","_id":"cm0fat8zo0016s0njdbbh33b3"},{"post_id":"cm0fat8zj0007s0nj78qnen2i","category_id":"cm0fat8zi0004s0njgieg3w5h","_id":"cm0fat8zo001as0njhye85sgc"},{"post_id":"cm0fat8zj0007s0nj78qnen2i","category_id":"cm0fat8zo0012s0nj6aop0rhb","_id":"cm0fat8zo001cs0nj0efr05i1"},{"post_id":"cm0fat8zm000ms0njbhzpcuxw","category_id":"cm0fat8zn000ss0njdmbp1ahq","_id":"cm0fat8zo001es0nj3nyidb2g"},{"post_id":"cm0fat8zn000qs0nj1nkr7p0e","category_id":"cm0fat8zi0004s0njgieg3w5h","_id":"cm0fat8zo001is0njenam4q0i"},{"post_id":"cm0fat8zn000qs0nj1nkr7p0e","category_id":"cm0fat8zo0019s0nja09050r2","_id":"cm0fat8zo001js0njexgl9612"},{"post_id":"cm0fat8zl000fs0nj7p6m6d3k","category_id":"cm0fat8zn000ss0njdmbp1ahq","_id":"cm0fat8zo001ks0nj89jcb9e0"},{"post_id":"cm0fat8zl000fs0nj7p6m6d3k","category_id":"cm0fat8zo001fs0nj6mwx7xvx","_id":"cm0fat8zo001ls0nj4oawhfjy"},{"post_id":"cm0fat8zp001ms0nj1dyrabyk","category_id":"cm0fat8zn000ss0njdmbp1ahq","_id":"cm0fat8zq001ss0nj5i4eaiqf"},{"post_id":"cm0fat8zp001ns0nj9rlw9lar","category_id":"cm0fat8zn000ss0njdmbp1ahq","_id":"cm0fat8zq001ws0nj8s5sds3p"},{"post_id":"cm0fat8zq001ps0njgnra83jk","category_id":"cm0fat8zn000ss0njdmbp1ahq","_id":"cm0fat8zq001ys0njfnlu87ss"},{"post_id":"cm0fat8zq001rs0nj45ma5k69","category_id":"cm0fat8zn000ws0njb5pid2pg","_id":"cm0fat8zr0021s0nj7v19el2z"},{"post_id":"cm0fat8zq001vs0nj7ppme6tb","category_id":"cm0fat8zn000ss0njdmbp1ahq","_id":"cm0fat8zr0024s0njdpci42qr"},{"post_id":"cm0fat8zq001xs0njexlfbxdk","category_id":"cm0fat8zi0004s0njgieg3w5h","_id":"cm0fat8zr0027s0njb0vb1ixc"},{"post_id":"cm0fat8zq001xs0njexlfbxdk","category_id":"cm0fat8zo0019s0nja09050r2","_id":"cm0fat8zr002bs0njfbo21lmd"},{"post_id":"cm0fat8zq001zs0nj772x7w9v","category_id":"cm0fat8zn000ss0njdmbp1ahq","_id":"cm0fat8zr002ds0nj1xacazwn"},{"post_id":"cm0fat8zr0026s0nj920cab1s","category_id":"cm0fat8zn000ss0njdmbp1ahq","_id":"cm0fat8zr002fs0nj5hpu3ysi"},{"post_id":"cm0fat8zr0023s0nje0aahnle","category_id":"cm0fat8zr0029s0nj7ukk0alx","_id":"cm0fat8zr002js0nje11w9frc"}],"PostTag":[{"post_id":"cm0fat8zg0001s0njgl080pl2","tag_id":"cm0fat8zj0005s0nj1rknff2g","_id":"cm0fat8zl000es0njgze5euu3"},{"post_id":"cm0fat8zh0003s0njgnlk7dhl","tag_id":"cm0fat8zk000ds0nj14x5edb8","_id":"cm0fat8zm000ls0nj2dbkdeun"},{"post_id":"cm0fat8zj0007s0nj78qnen2i","tag_id":"cm0fat8zl000js0nje6nnhvdl","_id":"cm0fat8zn000rs0nj5oorhbku"},{"post_id":"cm0fat8zk000bs0nj1p9k5py2","tag_id":"cm0fat8zn000ps0njhrgw67ee","_id":"cm0fat8zn000us0nj0bynfuxe"},{"post_id":"cm0fat8zl000fs0nj7p6m6d3k","tag_id":"cm0fat8zn000ts0njdkg38h9s","_id":"cm0fat8zn000ys0nj4jgkbk56"},{"post_id":"cm0fat8zl000gs0njfffade4a","tag_id":"cm0fat8zn000xs0nj4zvzcvf7","_id":"cm0fat8zo0011s0nj3kk390yx"},{"post_id":"cm0fat8zl000ks0nj53b06id7","tag_id":"cm0fat8zo0010s0nj4ksx7d1q","_id":"cm0fat8zo0015s0nja3rsgdpd"},{"post_id":"cm0fat8zm000ms0njbhzpcuxw","tag_id":"cm0fat8zo0014s0njbi04ea5p","_id":"cm0fat8zo001ds0nj9zk59q17"},{"post_id":"cm0fat8zm000ms0njbhzpcuxw","tag_id":"cm0fat8zo0010s0nj4ksx7d1q","_id":"cm0fat8zo001gs0nj67c81iwz"},{"post_id":"cm0fat8zn000qs0nj1nkr7p0e","tag_id":"cm0fat8zo0014s0njbi04ea5p","_id":"cm0fat8zo001hs0nj0guxc71t"},{"post_id":"cm0fat8zp001ms0nj1dyrabyk","tag_id":"cm0fat8zo0014s0njbi04ea5p","_id":"cm0fat8zq001os0nj38xrcocm"},{"post_id":"cm0fat8zp001ns0nj9rlw9lar","tag_id":"cm0fat8zo0010s0nj4ksx7d1q","_id":"cm0fat8zq001qs0nj1nach562"},{"post_id":"cm0fat8zp001ns0nj9rlw9lar","tag_id":"cm0fat8zo0014s0njbi04ea5p","_id":"cm0fat8zq001us0njhpes1fu8"},{"post_id":"cm0fat8zq001xs0njexlfbxdk","tag_id":"cm0fat8zo0014s0njbi04ea5p","_id":"cm0fat8zr0022s0nj0pt6hgxl"},{"post_id":"cm0fat8zq001ps0njgnra83jk","tag_id":"cm0fat8zq001ts0nj7cwj7kyj","_id":"cm0fat8zr0025s0njhwoe1t4e"},{"post_id":"cm0fat8zq001zs0nj772x7w9v","tag_id":"cm0fat8zo0014s0njbi04ea5p","_id":"cm0fat8zr002as0nj0x9ybtrj"},{"post_id":"cm0fat8zr0026s0nj920cab1s","tag_id":"cm0fat8zo0014s0njbi04ea5p","_id":"cm0fat8zr002cs0nj8kga4jdt"},{"post_id":"cm0fat8zq001rs0nj45ma5k69","tag_id":"cm0fat8zr0020s0njgtrm085k","_id":"cm0fat8zr002gs0nje8ua3qny"},{"post_id":"cm0fat8zq001rs0nj45ma5k69","tag_id":"cm0fat8zr0028s0nj8szm4z3l","_id":"cm0fat8zr002hs0nj56pv8hpa"},{"post_id":"cm0fat8zq001vs0nj7ppme6tb","tag_id":"cm0fat8zq001ts0nj7cwj7kyj","_id":"cm0fat8zr002ks0nj81zp12jr"},{"post_id":"cm0fat8zr0023s0nje0aahnle","tag_id":"cm0fat8zr002is0njbmxl4e1f","_id":"cm0fat8zr002ls0nj9fwv4oa4"}],"Tag":[{"name":"ACK","_id":"cm0fat8zj0005s0nj1rknff2g"},{"name":"RAM","_id":"cm0fat8zk000ds0nj14x5edb8"},{"name":"VPC","_id":"cm0fat8zl000js0nje6nnhvdl"},{"name":"Docker","_id":"cm0fat8zn000ps0njhrgw67ee"},{"name":"Istio","_id":"cm0fat8zn000ts0njdkg38h9s"},{"name":"git","_id":"cm0fat8zn000xs0nj4zvzcvf7"},{"name":"Alicloud","_id":"cm0fat8zo0010s0nj4ksx7d1q"},{"name":"Kubernetes","_id":"cm0fat8zo0014s0njbi04ea5p"},{"name":"Observability","_id":"cm0fat8zq001ts0nj7cwj7kyj"},{"name":"openssl","_id":"cm0fat8zr0020s0njgtrm085k"},{"name":"Linux","_id":"cm0fat8zr0028s0nj8szm4z3l"},{"name":"RabbitMQ","_id":"cm0fat8zr002is0njbmxl4e1f"}]}}