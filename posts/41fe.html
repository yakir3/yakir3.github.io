<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"359sun.top","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","always":true,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-2}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="一、组件说明Fluentd负责从 Kubernetes 搜集日志，每个 node 节点上面的 fluentd 监控并收集该节点上面的系统+容器日志，并将处理过后的日志信息发送给 Elasticsearch。   fluentd 数据流逻辑：source –&gt; parser –&gt; filter –&gt; output  Elasticsearch搜索引擎，负责存储日志并提供查询接口。">
<meta property="og:type" content="article">
<meta property="og:title" content="可观测性-Fluentd 日志组件">
<meta property="og:url" content="https://359sun.top/posts/41fe.html">
<meta property="og:site_name" content="Yakir Blog">
<meta property="og:description" content="一、组件说明Fluentd负责从 Kubernetes 搜集日志，每个 node 节点上面的 fluentd 监控并收集该节点上面的系统+容器日志，并将处理过后的日志信息发送给 Elasticsearch。   fluentd 数据流逻辑：source –&gt; parser –&gt; filter –&gt; output  Elasticsearch搜索引擎，负责存储日志并提供查询接口。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://359sun.top/posts/41fe/fluent1.png">
<meta property="og:image" content="https://359sun.top/posts/41fe/fluent2.png">
<meta property="og:image" content="https://359sun.top/posts/41fe/fluent3.png">
<meta property="og:image" content="https://359sun.top/posts/41fe/fluent4.png">
<meta property="article:published_time" content="2022-07-11T13:56:17.000Z">
<meta property="article:modified_time" content="2022-07-11T14:04:01.239Z">
<meta property="article:author" content="Yakir">
<meta property="article:tag" content="Observability">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://359sun.top/posts/41fe/fluent1.png">

<link rel="canonical" href="https://359sun.top/posts/41fe.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>可观测性-Fluentd 日志组件 | Yakir Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Yakir Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Yakir Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-musiclist">

    <a href="/musiclist/" rel="section"><i class="fa fa-music fa-fw"></i>歌单</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/yakir3" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://359sun.top/posts/41fe.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Yakir">
      <meta itemprop="description" content="Yakir Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yakir Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          可观测性-Fluentd 日志组件
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-07-11 21:56:17 / 修改时间：22:04:01" itemprop="dateCreated datePublished" datetime="2022-07-11T21:56:17+08:00">2022-07-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cncf/" itemprop="url" rel="index"><span itemprop="name">CNCF</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>37k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>34 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="一、组件说明"><a href="#一、组件说明" class="headerlink" title="一、组件说明"></a>一、组件说明</h3><p><strong>Fluentd</strong><br>负责从 Kubernetes 搜集日志，每个 node 节点上面的 fluentd 监控并收集该节点上面的系统+容器日志，并将处理过后的日志信息发送给 Elasticsearch。</p>
<img data-src="/posts/41fe/fluent1.png" class>
<blockquote>
<p>fluentd 数据流逻辑：source –&gt; parser –&gt; filter –&gt; output</p>
</blockquote>
<p><strong>Elasticsearch</strong><br>搜索引擎，负责存储日志并提供查询接口。</p>
<p><strong>Kibana</strong><br>提供了一个 Web GUI，用户可以浏览和搜索存储在 Elasticsearch 中的日志。 </p>
<blockquote>
<p>主要的日志收集方案：</p>
<ul>
<li>在节点上运行一个 agent 来收集日志（daemonSet）</li>
<li>在 Pod 中包含一个 sidecar 容器来收集应用日志</li>
<li>直接在应用程序中将日志信息推送到采集后端（一般不采用该方式）</li>
</ul>
</blockquote>
<span id="more"></span>

<h3 id="二、二进制方式-x2F-容器方式部署"><a href="#二、二进制方式-x2F-容器方式部署" class="headerlink" title="二、二进制方式 &#x2F; 容器方式部署"></a>二、二进制方式 &#x2F; 容器方式部署</h3><h4 id="二进制方式"><a href="#二进制方式" class="headerlink" title="二进制方式"></a>二进制方式</h4><p>官网安装方式：<a target="_blank" rel="noopener" href="https://docs.fluentd.org/installation/before-install">https://docs.fluentd.org/installation/before-install</a></p>
<h4 id="容器方式"><a href="#容器方式" class="headerlink" title="容器方式"></a>容器方式</h4><p>仓库地址：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/fluent/fluentd">https://hub.docker.com/r/fluent/fluentd</a></p>
<h3 id="三、配置与使用"><a href="#三、配置与使用" class="headerlink" title="三、配置与使用"></a>三、配置与使用</h3><blockquote>
<p>数据流逻辑：fluentd 以 tag 值为基准，决定数据的流经哪些处理器。<br>数据的流向：source -&gt; parser -&gt; filter -&gt; output</p>
</blockquote>
<h4 id="input-配置"><a href="#input-配置" class="headerlink" title="input 配置"></a>input 配置</h4><ul>
<li><p><strong>http：从 http 接口获取日志来源</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建配置文件</span></span><br><span class="line">mkdir /tmp/fluentd &amp;&amp; cd /tmp/fluentd</span><br><span class="line">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class="line">&lt;source&gt;</span><br><span class="line">  @type http</span><br><span class="line">  port 9880</span><br><span class="line">  bind 0.0.0.0</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;match **&gt;</span><br><span class="line">  @type stdout</span><br><span class="line">&lt;/match&gt;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动镜像，将 fluentd 目录挂载进容器，默认使用 fluent.conf 配置文件</span></span><br><span class="line">docker run -p 9880:9880 --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试请求 http 接口生成日志</span></span><br><span class="line">curl -X POST 127.0.0.1:9880/yakir.test -d &#x27;json=&#123;&quot;a&quot;:&quot;aaa&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>tail：增量读取日志文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class="line">&lt;source&gt;</span><br><span class="line">  @type tail</span><br><span class="line">  path /var/log/httpd-access.log</span><br><span class="line">  path_key tailed_path</span><br><span class="line">  pos_file /var/log/td-agent/httpd-access.log.pos</span><br><span class="line">  tag apache.access</span><br><span class="line">  &lt;parse&gt;</span><br><span class="line">    @type apache2</span><br><span class="line">  &lt;/parse&gt;</span><br><span class="line">&lt;/source&gt;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动镜像并测试日志</span></span><br><span class="line">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>exec：周期性执行命令，获取命令输出为 event</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class="line">&lt;source&gt;</span><br><span class="line">  @type exec</span><br><span class="line">  tag yakir.test</span><br><span class="line">  command cat /proc/loadavg | cut -d &#x27; &#x27; -f 1,2,3</span><br><span class="line">  run_interval 10s</span><br><span class="line"></span><br><span class="line">  &lt;parse&gt;</span><br><span class="line">    @type tsv</span><br><span class="line">    keys avg1,avg5,avg15</span><br><span class="line">    delimiter &quot; &quot;</span><br><span class="line">  &lt;/parse&gt;</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;match **&gt;</span><br><span class="line">  @type stdout</span><br><span class="line">&lt;/match&gt;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动镜像，验证日志</span></span><br><span class="line">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class="line">2022-06-30 08:43:20.377146682 +0000 yakir.test: &#123;&quot;avg1&quot;:&quot;0.12&quot;,&quot;avg5&quot;:&quot;0.16&quot;,&quot;avg15&quot;:&quot;0.17&quot;&#125;</span><br><span class="line">2022-06-30 08:43:30.347891525 +0000 yakir.test: &#123;&quot;avg1&quot;:&quot;0.10&quot;,&quot;avg5&quot;:&quot;0.15&quot;,&quot;avg15&quot;:&quot;0.17&quot;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>syslog：连接 rsyslog 系统日志，作为 rsyslog 接收端</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; fluent.conf &lt;&lt; EOF</span><br><span class="line">&lt;source&gt;</span><br><span class="line">    @type syslog</span><br><span class="line">    port 5140</span><br><span class="line">    bind 0.0.0.0</span><br><span class="line">    tag system</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;match **&gt;</span><br><span class="line">  @type stdout</span><br><span class="line">&lt;/match&gt;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动镜像，转发 udp 端口</span></span><br><span class="line">docker run -p 5140:5140/udp --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 rsyslog 配置，转发日志到 fluent</span></span><br><span class="line">cat &gt;&gt; /etc/rsyslog.d/50-default.conf &lt;&lt; &quot;EOF&quot;</span><br><span class="line">*.* @127.0.0.1:5140</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">logger 产生日志，验证日志生成</span></span><br><span class="line">logger -p mail.info &#x27;this is info message&#x27;</span><br><span class="line">logger -p mail.warning &#x27;this is warning message&#x27;</span><br><span class="line">2022-07-04 10:27:48.000000000 +0000 system.mail.info: &#123;&quot;host&quot;:&quot;minikube&quot;,&quot;ident&quot;:&quot;root&quot;,&quot;message&quot;:&quot;this is info message&quot;&#125;</span><br><span class="line">2022-07-04 10:28:11.000000000 +0000 system.mail.warn: &#123;&quot;host&quot;:&quot;minikube&quot;,&quot;ident&quot;:&quot;root&quot;,&quot;message&quot;:&quot;this is warning message&quot;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>dummy：测试用数据源，周期生成假数据</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class="line">&lt;source&gt;</span><br><span class="line">    @type dummy</span><br><span class="line">    dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class="line">    size 3</span><br><span class="line">    rate 1</span><br><span class="line">    tag yakir.test</span><br><span class="line">    auto_increment_key primary_key</span><br><span class="line">    suspend true</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;match **&gt;</span><br><span class="line">  @type stdout</span><br><span class="line">&lt;/match&gt;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">参数说明</span></span><br><span class="line">size     #每次发送的 event 数量</span><br><span class="line">rate     #每秒产生多少个 event</span><br><span class="line">auto_increment_key   #自增键名</span><br><span class="line">suspend              #重启后自增值是否重新开始</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动镜像，验证日志</span></span><br><span class="line">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class="line">2022-07-04 02:51:37.044796145 +0000 yakir.test: &#123;&quot;foo&quot;:&quot;bar&quot;,&quot;primary_key&quot;:0&#125;</span><br><span class="line">2022-07-04 02:51:37.044834743 +0000 yakir.test: &#123;&quot;foo&quot;:&quot;bar&quot;,&quot;primary_key&quot;:1&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>forward：接收其他 fluentd forward 的 event</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;source&gt;</span><br><span class="line">  @type forward</span><br><span class="line">  port 24224</span><br><span class="line">  bind 0.0.0.0</span><br><span class="line">&lt;/source&gt;</span><br></pre></td></tr></table></figure>
<h4 id="output-配置"><a href="#output-配置" class="headerlink" title="output 配置"></a>output 配置</h4></li>
<li><p><strong>file：输出 event 为文件，默认每天输出一个日志文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class="line">&lt;source&gt;</span><br><span class="line">  @type dummy</span><br><span class="line">  dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class="line">  tag yakir.test</span><br><span class="line">  size 1</span><br><span class="line">  rate 1</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;match yakir.**&gt;</span><br><span class="line">  @type file</span><br><span class="line">  path /tmp/fluent/yakir</span><br><span class="line">  compress gzip</span><br><span class="line">  &lt;buffer&gt;</span><br><span class="line">    timekey 1d</span><br><span class="line">    timekey_use_utc true</span><br><span class="line">    timekey_wait 10m</span><br><span class="line">  &lt;/buffer&gt;</span><br><span class="line">  </span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">@<span class="built_in">type</span> file</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">path /tmp/<span class="variable">$&#123;tag[0]&#125;</span>/file.%Y-%m-%d-%H-%M-%S</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">&lt;buffer tag,time&gt;</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash"> timekey 10</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash"> timekey_wait 10</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash"> timekey_use_utc <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">&lt;/buffer&gt;</span></span><br><span class="line">&lt;/match&gt;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数说明</span></span><br><span class="line">path：支持 placeholder，可以在日志路径中嵌入时间，tag 和 record 中的字段值。例如：/path/to/$&#123;tag&#125;/$&#123;key1&#125;/file.%Y%m%d</span><br><span class="line">append：flush 的 chuck 是否追加到已存在的文件后。默认为 false，便于文件的并行处理。</span><br><span class="line">format 标签，用来规定文件内容的格式，默认值为 out_file。</span><br><span class="line">inject 标签，用来为 event 增加 time 和 tag 等字段。</span><br><span class="line">add_path_suffix：是否增加 path 后缀</span><br><span class="line">path_suffix：path 后缀内容，默认为.log。</span><br><span class="line">compress：采用什么压缩格式，默认不压缩。</span><br><span class="line">recompress：是否在 buffer chunk 已经压缩的情况再次压缩，默认为 false。</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动镜像验证日志</span></span><br><span class="line">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class="line">docker exec -it fluent /bin/sh</span><br><span class="line">tail -2 /tmp/fluent/yakir/buffer.b5e2f5e063d4389bd9304563cf7f07656.log</span><br><span class="line">2022-07-04T07:42:34+00:00	yakir.test	&#123;&quot;foo&quot;:&quot;bar&quot;&#125;</span><br><span class="line">2022-07-04T07:42:35+00:00	yakir.test	&#123;&quot;foo&quot;:&quot;bar&quot;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>buffer 标签</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;buffer&gt;</span><br><span class="line">  @type file</span><br><span class="line">&lt;/buffer&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">@<span class="built_in">type</span> 值：file（存文件）、memory（存内存，默认值）</span></span><br><span class="line"></span><br><span class="line">&lt;buffer ARGUMENT_CHUNK_KEYS&gt;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">...</span></span><br><span class="line">&lt;/buffer&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">buffer chunk keys（buffer 已 record 的什么字段分段存放），没有配置 chunk key，所有 event 写入同一个 chunk file 直到 buffer 滚动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 time 为 chunk key，按照时间对 buffer 进行分段。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">timekey：时间跨度   timekey_wait：flush 延迟时间，用于等待迟到的数据</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">常用参数</span></span><br><span class="line">timekey_use_utc：使用国际标准时间还是当地时间，默认是使用当地时间。</span><br><span class="line">timekey_zone：指定时区。</span><br><span class="line">chunk_limit_size：chunk 大小限制，默认 8MB。</span><br><span class="line">chunk_limit_records：chunk event 条数限制。</span><br><span class="line">total_limit_size：总 buffer 大小限制。</span><br><span class="line">chunk_full_threshold：chunk 大小超过 chunk_limit_size * chunk_full_threshold 时会自动 flush。</span><br><span class="line">queued_chunks_limit_size：限制队列中的 chunk 数目，防止频繁 flush 产生过多的 chunk。</span><br><span class="line">compress：压缩格式，可使用 text 或 gzip。默认为 text。</span><br><span class="line">flush_at_shutdown：关闭时候是否 flush。对于非持久化 buffer 默认值为 true，持久化 buffer 默认值为 false。</span><br><span class="line">flush_interval：多长时间 flush 一次。</span><br><span class="line">retry_timeout：重试 flush 的超时时间。在这个时间后不再会 retry。</span><br><span class="line">retry_forever：是否永远尝试 flush。如果设置为 true 会忽略 retry_timeout 的配置。</span><br><span class="line">retry_max_times：重试最大次数。</span><br><span class="line">retry_type：有两个配置值：retry 时间间隔，指数级增长或者是固定周期重试。</span><br><span class="line">retry_wait：每次重试等待时间。</span><br><span class="line">retry_exponential_backoff_base：retry 时间指数扩大倍数。</span><br><span class="line">retry_max_interval：最长 retry 时间间隔。</span><br><span class="line">retry_randomize：是否随机 retry 时间间隔。</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>format 标签</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;match&gt;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  &lt;format&gt;</span><br><span class="line">    @type json</span><br><span class="line">  &lt;/format&gt;</span><br><span class="line"></span><br><span class="line">  &lt;buffer&gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/buffer&gt;</span><br><span class="line">  </span><br><span class="line">&lt;/match&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>forward：转发 event 到其他 fluentd 节点。配置多个 fluentd 节点时，使用负载均衡方式发送。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;match yakir.*&gt;</span><br><span class="line">  @type forward</span><br><span class="line">  send_timeout 60s</span><br><span class="line">  recover_wait 10s</span><br><span class="line">  hard_timeout 60s</span><br><span class="line"></span><br><span class="line">  &lt;server&gt;</span><br><span class="line">    name myserver1</span><br><span class="line">    host 192.168.1.3</span><br><span class="line">    port 24224</span><br><span class="line">    weight 60</span><br><span class="line">  &lt;/server&gt;</span><br><span class="line">  &lt;server&gt;</span><br><span class="line">    name myserver2</span><br><span class="line">    host 192.168.1.4</span><br><span class="line">    port 24224</span><br><span class="line">    weight 60</span><br><span class="line">  &lt;/server&gt;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  &lt;secondary&gt;</span><br><span class="line">    @type file</span><br><span class="line">    path /var/log/fluent/forward-failed</span><br><span class="line">  &lt;/secondary&gt;</span><br><span class="line">&lt;/match&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">server 标签参数说明</span></span><br><span class="line">host</span><br><span class="line">name</span><br><span class="line">port</span><br><span class="line">shared_key</span><br><span class="line">username</span><br><span class="line">password</span><br><span class="line">standby 标记 server 为备用，只有其他 node 不可用的时候才会启用 standby 的 node</span><br><span class="line">weight 负载均衡的权重配置</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>copy：多路输出，复制 event 到多个输出端</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class="line">&lt;source&gt;</span><br><span class="line">  @type dummy</span><br><span class="line">  dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class="line">  tag yakir.test</span><br><span class="line">  size 1</span><br><span class="line">  rate 1</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;match yakir.**&gt;</span><br><span class="line">  @type copy</span><br><span class="line">  &lt;store&gt;</span><br><span class="line">    @type file</span><br><span class="line">    path /tmp/yakir/file.%Y%m%d</span><br><span class="line">    compress gzip</span><br><span class="line">  &lt;/store&gt;</span><br><span class="line">  &lt;store ignore_error&gt;</span><br><span class="line">    @type stdout</span><br><span class="line">  &lt;/store&gt;</span><br><span class="line">&lt;/match&gt;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数说明</span></span><br><span class="line">copy_mode 复制模式可选值</span><br><span class="line">  no_copy：每路输出共享 event。</span><br><span class="line">  shallow：浅拷贝，如果不修改嵌套字段可以使用。</span><br><span class="line">  deep：深拷贝，使用msgpack-ruby方式。</span><br><span class="line">  marshal：深拷贝，使用marshal方式。</span><br><span class="line">store 标签 ignore_error 参数：标记的 store 出现错误时，不影响其他</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>http：通过 http 请求方式发送 event，payload 格式由 format 标签决定。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;match pattern&gt;</span><br><span class="line">  @type http</span><br><span class="line">  endpoint http://logserver.com:9000/api</span><br><span class="line">  open_timeout 2</span><br><span class="line"></span><br><span class="line">  &lt;format&gt;</span><br><span class="line">    @type json</span><br><span class="line">  &lt;/format&gt;</span><br><span class="line">  &lt;buffer&gt;</span><br><span class="line">    flush_interval 10s</span><br><span class="line">  &lt;/buffer&gt;</span><br><span class="line">&lt;/match&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 post 方式，连接超时2s，输出格式为 json，每10s 输出一次到 endpoint。（content-type 为 application/x-ndjson）</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>stdout：标准输出，后台运行时输出到 fluentd 日志。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;source&gt;</span><br><span class="line">  @type dummy</span><br><span class="line">  dummy &#123;&quot;foo&quot;: &quot;bar&quot;&#125;</span><br><span class="line">  tag yakir.test</span><br><span class="line">  size 1</span><br><span class="line">  rate 1</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;match yakir.**&gt;</span><br><span class="line">  @type stdout</span><br><span class="line">&lt;/match&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>第三方存储：Elasticsearch、Kafka</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">elasticsearch 关键配置</span></span><br><span class="line">&lt;match yakir.logs&gt;</span><br><span class="line">  @type elasticsearch</span><br><span class="line">  host localhost</span><br><span class="line">  port 9200</span><br><span class="line">  logstash_format true</span><br><span class="line">&lt;/match&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数</span></span><br><span class="line">host：单个 elasticsearch 节点地址</span><br><span class="line">port：单个 elasticsearch 节点的端口号</span><br><span class="line">hosts：elasticsearch 集群地址。格式为 ip1:port1,ip2:port2...</span><br><span class="line">user、password：elasticsearch 的认证信息</span><br><span class="line">scheme：使用 https 还是 http。默认为 http 模式</span><br><span class="line">path：REST 接口路径，默认为空</span><br><span class="line">index_name：index 名称</span><br><span class="line">logstash_format：index 是否使用 logstash 命名方式（logstash-%Y.%m.%d），默认不启用</span><br><span class="line">logstash_prefix：logstash_format 启用的时候，index 命名前缀是什么。默认为logstash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kafka 关键配置</span></span><br><span class="line">&lt;match pattern&gt;</span><br><span class="line">  @type kafka2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">list of seed brokers</span></span><br><span class="line">  brokers &lt;broker1_host&gt;:&lt;broker1_port&gt;,&lt;broker2_host&gt;:&lt;broker2_port&gt;</span><br><span class="line">  use_event_time true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">buffer settings</span></span><br><span class="line">  &lt;buffer topic&gt;</span><br><span class="line">    @type file</span><br><span class="line">    path /var/log/td-agent/buffer/td</span><br><span class="line">    flush_interval 3s</span><br><span class="line">  &lt;/buffer&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">data <span class="built_in">type</span> settings</span></span><br><span class="line">  &lt;format&gt;</span><br><span class="line">    @type json</span><br><span class="line">  &lt;/format&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">topic settings</span></span><br><span class="line">  topic_key topic</span><br><span class="line">  default_topic messages</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">producer settings</span></span><br><span class="line">  required_acks -1</span><br><span class="line">  compression_codec gzip</span><br><span class="line">&lt;/match&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数</span></span><br><span class="line">brokers：Kafka brokers 的地址和端口号</span><br><span class="line">topic_key：record 中哪个 key 对应的值用作 Kafka 消息的 key</span><br><span class="line">default_topic：如果没有配置 topic_key，默认使用的 topic 名字</span><br><span class="line">format 标签：确定发送的数据格式</span><br><span class="line">use_event_time：是否使用 fluentd event 的时间作为 Kafka 消息的时间。默认为 false。意思为使用当前时间作为发送消息的时间</span><br><span class="line">required_acks：producer acks 的值</span><br><span class="line">compression_codec：压缩编码方式</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>webhdfs：通过 REST 方式写入 event 到 HDFS（配合 Hadoop）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;store&gt;</span><br><span class="line">  @type webhdfs</span><br><span class="line">  host 1.1.1.1</span><br><span class="line">  port 50070</span><br><span class="line">  path &quot;/history/access.log.%Y%m%d_%H.#&#123;Socket.gethostname&#125;.log&quot;</span><br><span class="line">  &lt;buffer&gt;</span><br><span class="line">      flush_interval 60s</span><br><span class="line">  &lt;/buffer&gt;</span><br><span class="line">&lt;/store&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="parser-配置"><a href="#parser-配置" class="headerlink" title="parser 配置"></a>parser 配置</h4><ul>
<li><strong>regexp：正则表达式解析信息，可通过 time_key 指定 event 的 time 字段</strong><blockquote>
<p>在线测试正则语法工具：<a target="_blank" rel="noopener" href="http://fluentular.herokuapp.com/">http://fluentular.herokuapp.com/</a></p>
</blockquote>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关键配置</span></span><br><span class="line">&lt;parse&gt;</span><br><span class="line">  @type regexp</span><br><span class="line">  expression /^\[(?&lt;logtime&gt;[^\]]*)\] (?&lt;name&gt;[^ ]*) (?&lt;title&gt;[^ ]*) (?&lt;id&gt;\d*)$/</span><br><span class="line">  time_key logtime</span><br><span class="line">  time_format %Y-%m-%d %H:%M:%S %z</span><br><span class="line">  types id:integer</span><br><span class="line">&lt;/parse&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据解析</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">原日志</span></span><br><span class="line">[2013-02-28 12:00:00 +0900] alice engineer 1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解析后</span></span><br><span class="line">time:</span><br><span class="line">1362020400 (2013-02-28 12:00:00 +0900)</span><br><span class="line"></span><br><span class="line">record:</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;alice&quot;,</span><br><span class="line">  &quot;title&quot;: &quot;engineer&quot;,</span><br><span class="line">  &quot;id&quot;   : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="filter-配置"><a href="#filter-配置" class="headerlink" title="filter 配置"></a>filter 配置</h4><ul>
<li><p><strong>record_transformer：修改 event 结构，增加或修改字段</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新增字段，使用 ruby 表达式</span></span><br><span class="line">cat &gt; fluent.conf &lt;&lt; &quot;EOF&quot;</span><br><span class="line">&lt;source&gt;</span><br><span class="line">  @type dummy</span><br><span class="line">  dummy &#123;&quot;foo&quot;:&quot;bar&quot;, &quot;id1&quot;: 100, &quot;id2&quot;: 50&#125;</span><br><span class="line">  tag yakir.test</span><br><span class="line">  size 1</span><br><span class="line">  rate 1</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;filter&gt;</span><br><span class="line">  @type record_transformer</span><br><span class="line">  enable_ruby true</span><br><span class="line">  &lt;record&gt;</span><br><span class="line">    hostname &quot;#&#123;Socket.gethostname&#125;&quot;</span><br><span class="line">    tag $&#123;tag&#125;</span><br><span class="line">    avg $&#123;record[&quot;id1&quot;] / record[&quot;id2&quot;]&#125;</span><br><span class="line">  &lt;/record&gt;</span><br><span class="line">&lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">&lt;match yakir.**&gt;</span><br><span class="line">  @type stdout</span><br><span class="line">&lt;/match&gt;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动镜像，验证日志</span></span><br><span class="line">docker run --rm --name fluent -v /tmp/fluentd:/fluentd/etc fluent/fluentd</span><br><span class="line">2022-07-04 10:12:53.028623276 +0000 yakir.test: &#123;&quot;foo&quot;:&quot;bar&quot;,&quot;id1&quot;:100,&quot;id2&quot;:50,&quot;hostname&quot;:&quot;7d5e83c528c7&quot;,&quot;tag&quot;:&quot;yakir.test&quot;,&quot;avg&quot;:2&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改字段内容</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关键配置</span></span><br><span class="line">&lt;filter foo.bar&gt;</span><br><span class="line">  @type record_transformer</span><br><span class="line">  &lt;record&gt;</span><br><span class="line">    message yay, $&#123;record[&quot;message&quot;]&#125;</span><br><span class="line">  &lt;/record&gt;</span><br><span class="line">&lt;/filter&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据解析</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">原日志</span></span><br><span class="line">&#123; &quot;message&quot;: &quot;hello world!&quot; &#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解析后</span></span><br><span class="line">time:</span><br><span class="line">&#123; &quot;message&quot;: &quot;yay, hello world!&quot; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>record 标签</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置</span></span><br><span class="line">&lt;record&gt;</span><br><span class="line">  NEW_FIELD NEW_VALUE</span><br><span class="line">&lt;/record&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数说明</span></span><br><span class="line">record：获取 record 中某些字段的内容。例如record[&quot;count&quot;]</span><br><span class="line">tag：获取 tag 的内容</span><br><span class="line">time：获取日志的时间戳</span><br><span class="line">hostname：获取主机名字，和#&#123;Socket.gethostname&#125;作用一样</span><br><span class="line">tag_parts[N]：tag 以.分隔，获取 tag 的第 N 部分</span><br><span class="line">tag_prefix[N]：获取 tag 的 0-N 部分</span><br><span class="line">tag_suffix[N]：获取 tag 的 N-结尾部分</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="四、DaemonSet-方式部署"><a href="#四、DaemonSet-方式部署" class="headerlink" title="四、DaemonSet 方式部署"></a>四、DaemonSet 方式部署</h3><img data-src="/posts/41fe/fluent2.png" class>
<h4 id="部署-Elasticsearch-和-Kibana"><a href="#部署-Elasticsearch-和-Kibana" class="headerlink" title="部署 Elasticsearch 和 Kibana"></a>部署 Elasticsearch 和 Kibana</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建日志 namespace，方便清理</span></span><br><span class="line">kubectl create ns logging</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署 Elasticsearch（StatefulSet 和 Service，service 资源使用无头服务）</span></span><br><span class="line">cat &gt; elasticsearch.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: es</span><br><span class="line">  namespace: logging</span><br><span class="line">spec:</span><br><span class="line">  serviceName: elasticsearch</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: elasticsearch</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: elasticsearch</span><br><span class="line">    spec:</span><br><span class="line">      # 初始化容器，调整内核参数</span><br><span class="line">      initContainers:</span><br><span class="line">      - name: increase-vm-max-map</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sysctl&quot;, &quot;-w&quot;, &quot;vm.max_map_count=262144&quot;]</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: true</span><br><span class="line">      - name: increase-fd-ulimit</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;ulimit -n 65536&quot;]</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: true</span><br><span class="line">      containers:</span><br><span class="line">      - name: elasticsearch</span><br><span class="line">        image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9200</span><br><span class="line">          name: rest</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9300</span><br><span class="line">          name: inter-node</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: data</span><br><span class="line">          mountPath: /usr/share/elasticsearch/data</span><br><span class="line">        env:</span><br><span class="line">          - name: cluster.name</span><br><span class="line">            value: k8s-logs</span><br><span class="line">          - name: node.name</span><br><span class="line">            valueFrom:</span><br><span class="line">              fieldRef:</span><br><span class="line">                fieldPath: metadata.name</span><br><span class="line">          #多 ES 节点时注意以下配置</span><br><span class="line">          - name: cluster.initial_master_nodes</span><br><span class="line">            value: &quot;es-0&quot;</span><br><span class="line">          - name: discovery.zen.minimum_master_nodes</span><br><span class="line">            value: &quot;1&quot;</span><br><span class="line">          - name: discovery.seed_hosts</span><br><span class="line">            value: &quot;elasticsearch&quot;</span><br><span class="line">          - name: ES_JAVA_OPTS</span><br><span class="line">            value: &quot;-Xms512m -Xmx512m&quot;</span><br><span class="line">          - name: network.host</span><br><span class="line">            value: &quot;0.0.0.0&quot;</span><br><span class="line">      # 持久化存储，线上环境建议使用 StorageClass 等存储资源对象</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    app: elasticsearch</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: elasticsearch</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">使用无头服务，确保 StatefulSet 中 Pod 固定 DNS 地址，如 es-0.elasticsearch.logging.svc.cluster.local</span></span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">    - port: 9200</span><br><span class="line">      name: rest</span><br><span class="line">    - port: 9300</span><br><span class="line">      name: inter-node</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署 Kibana 资源</span></span><br><span class="line">cat &gt; kibana.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    app: kibana</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: kibana</span><br><span class="line">  ports:</span><br><span class="line">  - port: 5601</span><br><span class="line">  type: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    app: kibana</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kibana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kibana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana</span><br><span class="line">        image: docker.elastic.co/kibana/kibana:7.6.2</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 200m</span><br><span class="line">        env:</span><br><span class="line">        - name: ELASTICSEARCH_HOSTS</span><br><span class="line">          value: http://elasticsearch:9200</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5601</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署并查看部署结果</span></span><br><span class="line">kubectl apply -f elasticsearch.yaml</span><br><span class="line">kubectl apply -f kibana.yaml</span><br><span class="line">kubectl get pod,svc -n logging -owide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/es-0                      1/1     Running   0          4h54m   172.17.0.6   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/kibana-6c84594848-mdp76   1/1     Running   0          158m    172.17.0.5   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE     SELECTOR</span><br><span class="line">service/elasticsearch   ClusterIP   None           &lt;none&gt;        9200/TCP,9300/TCP   4h50m   app=elasticsearch</span><br><span class="line">service/kibana          ClusterIP   10.106.67.32   &lt;none&gt;        5601/TCP            158m    app=kibana</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问验证</span></span><br><span class="line">kubectl port-forward services/elasticsearch -n logging --address 127.0.0.1 9200:9200</span><br><span class="line">curl http://127.0.0.1:9200/_cluster/state?pretty</span><br><span class="line">curl 10.106.67.32:5601/app/kibana -I</span><br></pre></td></tr></table></figure>

<h4 id="部署-Fluentd"><a href="#部署-Fluentd" class="headerlink" title="部署 Fluentd"></a>部署 Fluentd</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">源码方式</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/fluent/fluentd-kubernetes-daemonset.git</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自定义安装方式</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Fluentd 配置文件</span></span><br><span class="line">cat &gt; fluentd-cfg.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-config</span><br><span class="line">  namespace: logging</span><br><span class="line">data:</span><br><span class="line">  system.conf: |-</span><br><span class="line">    &lt;system&gt;</span><br><span class="line">      root_dir /tmp/fluentd-buffers/</span><br><span class="line">    &lt;/system&gt;</span><br><span class="line">  containers.input.conf: |-</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id fluentd-containers.log</span><br><span class="line">      @type tail                              # Fluentd 内置的输入方式，其原理是不停地从源文件中获取新的日志。</span><br><span class="line">      path /var/log/containers/*.log          # 挂载的服务器Docker容器日志地址</span><br><span class="line">      pos_file /var/log/es-containers.log.pos</span><br><span class="line">      tag raw.kubernetes.*                    # 设置日志标签</span><br><span class="line">      read_from_head true</span><br><span class="line">      &lt;parse&gt;                                 # 多行格式化成JSON</span><br><span class="line">        @type multi_format                    # 使用 multi-format-parser 解析器插件</span><br><span class="line">        &lt;pattern&gt;</span><br><span class="line">          format json                         # JSON解析器</span><br><span class="line">          time_key time                       # 指定事件时间的时间字段</span><br><span class="line">          time_format %Y-%m-%dT%H:%M:%S.%NZ   # 时间格式</span><br><span class="line">        &lt;/pattern&gt;</span><br><span class="line">        &lt;pattern&gt;</span><br><span class="line">          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/</span><br><span class="line">          time_format %Y-%m-%dT%H:%M:%S.%N%:z</span><br><span class="line">        &lt;/pattern&gt;</span><br><span class="line">      &lt;/parse&gt;</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line">    # 在日志输出中检测异常，并将其作为一条日志转发</span><br><span class="line">    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions</span><br><span class="line">    &lt;match raw.kubernetes.**&gt;           # 匹配tag为raw.kubernetes.**日志信息</span><br><span class="line">      @id raw.kubernetes</span><br><span class="line">      @type detect_exceptions           # 使用detect-exceptions插件处理异常栈信息</span><br><span class="line">      remove_tag_prefix raw             # 移除 raw 前缀</span><br><span class="line">      message log</span><br><span class="line">      stream stream</span><br><span class="line">      multiline_flush_interval 5</span><br><span class="line">      max_bytes 500000</span><br><span class="line">      max_lines 1000</span><br><span class="line">    &lt;/match&gt;</span><br><span class="line"></span><br><span class="line">    &lt;filter **&gt;  # 拼接日志</span><br><span class="line">      @id filter_concat</span><br><span class="line">      @type concat                # Fluentd Filter 插件，用于连接多个事件中分隔的多行日志。</span><br><span class="line">      key message</span><br><span class="line">      multiline_end_regexp /\n$/  # 以换行符“\n”拼接</span><br><span class="line">      separator &quot;&quot;</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">    # 添加 Kubernetes metadata 数据</span><br><span class="line">    &lt;filter kubernetes.**&gt;</span><br><span class="line">      @id filter_kubernetes_metadata</span><br><span class="line">      @type kubernetes_metadata</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">    # 修复 ES 中的 JSON 字段</span><br><span class="line">    # 插件地址：https://github.com/repeatedly/fluent-plugin-multi-format-parser</span><br><span class="line">    &lt;filter kubernetes.**&gt;</span><br><span class="line">      @id filter_parser</span><br><span class="line">      @type parser                # multi-format-parser多格式解析器插件</span><br><span class="line">      key_name log                # 在要解析的记录中指定字段名称。</span><br><span class="line">      reserve_data true           # 在解析结果中保留原始键值对。</span><br><span class="line">      remove_key_name_field true  # key_name 解析成功后删除字段。</span><br><span class="line">      &lt;parse&gt;</span><br><span class="line">        @type multi_format</span><br><span class="line">        &lt;pattern&gt;</span><br><span class="line">          format json</span><br><span class="line">        &lt;/pattern&gt;</span><br><span class="line">        &lt;pattern&gt;</span><br><span class="line">          format none</span><br><span class="line">        &lt;/pattern&gt;</span><br><span class="line">      &lt;/parse&gt;</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">    # 删除一些多余的属性</span><br><span class="line">    &lt;filter kubernetes.**&gt;</span><br><span class="line">      @type record_transformer</span><br><span class="line">      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">    # 只保留具有logging=true标签的Pod日志</span><br><span class="line">    &lt;filter kubernetes.**&gt;</span><br><span class="line">      @id filter_log</span><br><span class="line">      @type grep</span><br><span class="line">      &lt;regexp&gt;</span><br><span class="line">        key $.kubernetes.labels.logging</span><br><span class="line">        pattern ^true$</span><br><span class="line">      &lt;/regexp&gt;</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">##### 监听配置，一般用于日志聚合用 ######</span></span></span><br><span class="line">  forward.input.conf: |-</span><br><span class="line">    # 监听通过TCP发送的消息</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id forward</span><br><span class="line">      @type forward</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">  output.conf: |-</span><br><span class="line">    &lt;match **&gt;</span><br><span class="line">      @id elasticsearch</span><br><span class="line">      @type elasticsearch</span><br><span class="line">      @log_level info</span><br><span class="line">      include_tag_key true</span><br><span class="line">      host elasticsearch</span><br><span class="line">      port 9200</span><br><span class="line">      logstash_format true</span><br><span class="line">      logstash_prefix k8s  # 设置 index 前缀为 k8s</span><br><span class="line">      request_timeout    30s</span><br><span class="line">      &lt;buffer&gt;</span><br><span class="line">        @type file</span><br><span class="line">        path /var/log/fluentd-buffers/kubernetes.system.buffer</span><br><span class="line">        flush_mode interval</span><br><span class="line">        retry_type exponential_backoff</span><br><span class="line">        flush_thread_count 2</span><br><span class="line">        flush_interval 5s</span><br><span class="line">        retry_forever</span><br><span class="line">        retry_max_interval 30</span><br><span class="line">        chunk_limit_size 2M</span><br><span class="line">        queue_limit_length 8</span><br><span class="line">        overflow_action block</span><br><span class="line">      &lt;/buffer&gt;</span><br><span class="line">    &lt;/match&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; fluentd-daemonset.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - &quot;namespaces&quot;</span><br><span class="line">  - &quot;pods&quot;</span><br><span class="line">  verbs:</span><br><span class="line">  - &quot;get&quot;</span><br><span class="line">  - &quot;watch&quot;</span><br><span class="line">  - &quot;list&quot;</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: logging</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: fluentd-es</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: fluentd-es</span><br><span class="line">        kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">      # 此注释确保如果节点被驱逐，fluentd不会被驱逐，支持关键的基于 pod 注释的优先级方案。</span><br><span class="line">      annotations:</span><br><span class="line">        priorityClassName: system-cluster-critical</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: fluentd-es</span><br><span class="line">      containers:</span><br><span class="line">      - name: fluentd-es</span><br><span class="line">        image: quay.io/fluentd_elasticsearch/fluentd:v3.0.1</span><br><span class="line">        #image: fluent/fluentd-kubernetes-daemonset:v1.14.6-debian-elasticsearch7-1.1</span><br><span class="line">        env:</span><br><span class="line">        - name: FLUENTD_ARGS</span><br><span class="line">          value: --no-supervisor -q</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: varlog</span><br><span class="line">          mountPath: /var/log</span><br><span class="line">        - name: varlibdockercontainers</span><br><span class="line">          mountPath: /var/lib/docker/containers</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/fluent/config.d</span><br><span class="line">      # 打上 master 节点污点，收集 master 节点</span><br><span class="line">      tolerations:</span><br><span class="line">      - operator: Exists</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      # 挂载需要收集日志的目录</span><br><span class="line">      volumes:</span><br><span class="line">      - name: varlog</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/log</span><br><span class="line">      - name: varlibdockercontainers</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/lib/docker/containers</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: fluentd-config</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署并查看部署结果</span></span><br><span class="line">kubectl apply -f fluentd-cfg.yaml</span><br><span class="line">kubectl apply -f fluentd-daemonset.yaml</span><br><span class="line">kubectl get pod -n logging -owide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS        AGE     IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/fluentd-es-cfdcx          1/1     Running   0               91m     172.17.0.7   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="部署测试应用，输出日志容器"><a href="#部署测试应用，输出日志容器" class="headerlink" title="部署测试应用，输出日志容器"></a>部署测试应用，输出日志容器</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直接标准输出日志容器</span></span><br><span class="line">cat &gt; stdin.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: counter1</span><br><span class="line">  labels:</span><br><span class="line">    # 配置该标签，日志才能进行收集</span><br><span class="line">    logging: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - image: busybox</span><br><span class="line">      args: [&quot;/bin/sh&quot;,&quot;-c&quot;, &#x27;i=0; while true; do echo &quot;$i: $(date)&quot;; i=$((i+1)); sleep 5; done&#x27;]</span><br><span class="line">      name: counter</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sidecar 方式获取输出到文件的容器日志</span></span><br><span class="line">cat &gt; sidecar.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: counter2</span><br><span class="line">  labels:</span><br><span class="line">    logging: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: counter2</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">    - /bin/sh</span><br><span class="line">    - -c</span><br><span class="line">    - &gt;</span><br><span class="line">      i=0;</span><br><span class="line">      while true;</span><br><span class="line">      do</span><br><span class="line">        echo &quot;$i: $(date)&quot; &gt;&gt; /var/log/1.log;</span><br><span class="line">        echo &quot;$(date) INFO $i&quot; &gt;&gt; /var/log/2.log;</span><br><span class="line">        i=$((i+1));</span><br><span class="line">        sleep 3;</span><br><span class="line">      done</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: varlog</span><br><span class="line">      mountPath: /var/log</span><br><span class="line">  - name: count-log-1</span><br><span class="line">    image: busybox</span><br><span class="line">    args: [/bin/sh, -c, &#x27;tail -n 1 -f /var/log/1.log&#x27;]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: varlog</span><br><span class="line">      mountPath: /var/log</span><br><span class="line">  - name: count-log-2</span><br><span class="line">    image: busybox</span><br><span class="line">    args: [/bin/sh, -c, &#x27;tail -n 1 -f /var/log/2.log&#x27;]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: varlog</span><br><span class="line">      mountPath: /var/log</span><br><span class="line">  restartPolicy: Never</span><br><span class="line">  volumes:</span><br><span class="line">  - name: varlog</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取日志方式：kubectl logs counter2 count-log-2 -f --<span class="built_in">tail</span> 3</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出 JSON 格式日志，用于分析</span></span><br><span class="line">cat &gt; dummylogs.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: dummylogs</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: dummylogs</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: dummylogs</span><br><span class="line">        logging: &quot;true&quot;  # 要采集日志需要加上该标签</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dummy</span><br><span class="line">        image: cnych/dummylogs:latest</span><br><span class="line">        args:</span><br><span class="line">        - msg-processor</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: dummylogs2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: dummylogs2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: dummylogs2</span><br><span class="line">        logging: &quot;true&quot;  # 要采集日志需要加上该标签</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dummy</span><br><span class="line">        image: cnych/dummylogs:latest</span><br><span class="line">        args:</span><br><span class="line">        - msg-receiver-api</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署</span></span><br><span class="line">kubectl apply -f counter.yaml</span><br><span class="line">kubectl apply -f dummylogs.yaml</span><br></pre></td></tr></table></figure>
<h4 id="Kibana-amp-Elasticsearch-查询数据验证"><a href="#Kibana-amp-Elasticsearch-查询数据验证" class="headerlink" title="Kibana  &amp; Elasticsearch 查询数据验证"></a>Kibana  &amp; Elasticsearch 查询数据验证</h4><ul>
<li><p>暴露 Kibana  &amp; Elasticsearch 服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl port-forward services/kibana -n logging --address 127.0.0.1 5601:5601</span><br><span class="line">kubectl port-forward services/elasticsearch -n logging --address 127.0.0.1 9200:9200</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问验证</p>
</li>
</ul>
<img data-src="/posts/41fe/fluent3.png" class>
<img data-src="/posts/41fe/fluent4.png" class>

<ul>
<li>Kibana 图表聚合展示<h4 id="日志告警功能"><a href="#日志告警功能" class="headerlink" title="日志告警功能"></a>日志告警功能</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; elastalert.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: elastalert-config</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    app: elastalert</span><br><span class="line">data:</span><br><span class="line">  elastalert_config: |-</span><br><span class="line">    ---</span><br><span class="line">    rules_folder: /opt/rules       # 指定规则的目录</span><br><span class="line">    scan_subdirectories: false</span><br><span class="line">    run_every:                     # 多久从 ES 中查询一次</span><br><span class="line">      minutes: 1</span><br><span class="line">    buffer_time:</span><br><span class="line">      minutes: 15</span><br><span class="line">    es_host: elasticsearch</span><br><span class="line">    es_port: 9200</span><br><span class="line">    writeback_index: elastalert</span><br><span class="line">    use_ssl: False</span><br><span class="line">    verify_certs: True</span><br><span class="line">    alert_time_limit:             # 失败重试限制</span><br><span class="line">      minutes: 720</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: elastalert-rules</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    app: elastalert</span><br><span class="line">data:</span><br><span class="line">  rule_config.yaml: |-</span><br><span class="line">    name: dummylogs error     # 规则名字，唯一值</span><br><span class="line">    es_host: elasticsearch</span><br><span class="line">    es_port: 9200</span><br><span class="line">    type: any                 # 报警类型</span><br><span class="line">    index: k8s-*              # es索引</span><br><span class="line">    filter:                   # 过滤</span><br><span class="line">    - query:</span><br><span class="line">        query_string:</span><br><span class="line">          query: &quot;LOGLEVEL:ERROR&quot;  # 报警条件</span><br><span class="line">    alert:                         # 报警类型</span><br><span class="line">    - &quot;email&quot;</span><br><span class="line">    smtp_host: 127.0.0.1</span><br><span class="line">    smtp_port: 587</span><br><span class="line">    smtp_auth_file: /opt/auth/smtp_auth_file.yaml</span><br><span class="line">    email_reply_to: xxx@gmail.com</span><br><span class="line">    from_addr: xxx@gmail.com</span><br><span class="line">    email:                  # 接受邮箱</span><br><span class="line">    - &quot;xxx@gmail.com&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: elastalert</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    app: elastalert</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: elastalert</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: elastalert</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: elastalert</span><br><span class="line">        image: jertel/elastalert-docker:0.2.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config</span><br><span class="line">          mountPath: /opt/config</span><br><span class="line">        - name: rules</span><br><span class="line">          mountPath: /opt/rules</span><br><span class="line">        - name: auth</span><br><span class="line">          mountPath: /opt/auth</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 256Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 256Mi</span><br><span class="line">      volumes:</span><br><span class="line">      - name: auth</span><br><span class="line">        secret:</span><br><span class="line">          secretName: smtp-auth</span><br><span class="line">      - name: rules</span><br><span class="line">        configMap:</span><br><span class="line">          name: elastalert-rules</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: elastalert-config</span><br><span class="line">          items:</span><br><span class="line">          - key: elastalert_config</span><br><span class="line">            path: elastalert_config.yaml</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">邮箱认证信息</span></span><br><span class="line">cat &gt; smtp_auth_file.yaml &lt;&lt; EOF</span><br><span class="line">user: &quot;xxxxx@gmail.com&quot;</span><br><span class="line">password: &quot;123xxx&quot;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署验证</span></span><br><span class="line">kubectl create secret generic smtp-auth --from-file=smtp_auth_file.yaml -n logging</span><br><span class="line">kubectl apply -f elastalert.yaml</span><br><span class="line">kubectl get pods -n logging -l app=elastalert</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看 Kibana 是否生成对应索引</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="五、fluentd-operator-方式部署"><a href="#五、fluentd-operator-方式部署" class="headerlink" title="五、fluentd-operator 方式部署"></a>五、fluentd-operator 方式部署</h3><h4 id="CRD-资源"><a href="#CRD-资源" class="headerlink" title="CRD 资源"></a>CRD 资源</h4><p><strong>fluentbit.fluent.io 资源</strong></p>
<ul>
<li>FluentBit：定义 Fluent Bit 属性，如镜像版本、污点、亲和性等参数。</li>
<li>ClusterFluentBitConfig：定义 Fluent Bit 的配置文件。</li>
<li>ClusterInput：：定义 Fluent Bit 的 input 插件。</li>
<li>ClusterFilter：：定义 Fluent Bit 的 filter 插件。</li>
<li>ClusterParser：定义 Fluent Bit 的 parser 插件。</li>
<li>ClusterOutput：定义 Fluent Bit 的 output 插件。</li>
</ul>
<p><strong>fluentd.fluent.io 资源</strong></p>
<ul>
<li>Fluentd：定义 Fluentd 属性，如镜像版本、污点、亲和性等参数。</li>
<li>FluentdConfig：定义 Fluentd namespace 级别配置文件。</li>
<li>ClusterFluentdConfig：定义 Fluentd 集群级别配置文件。</li>
<li>Filter：定义 Fluentd namespace 级别的 filter 插件。</li>
<li>ClusterFilter：定义 Fluentd 集群级别的 filter 插件。</li>
<li>Output：定义 Fluentd namespace 级别的 output 插件。</li>
<li>ClusterOutput：定义 Fluentd 集群级别的 output 插件。</li>
</ul>
<h4 id="部署-CRD-资源与-fluent-operator"><a href="#部署-CRD-资源与-fluent-operator" class="headerlink" title="部署 CRD 资源与 fluent-operator"></a>部署 CRD 资源与 fluent-operator</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载源码，创建 CRD 资源与部署 fluent-operator</span></span><br><span class="line">git clone https://github.com/fluent/fluent-operator</span><br><span class="line">cd fluent-operator &amp;&amp; kubectl apply -f manifests/setup/setup.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证资源</span></span><br><span class="line">kubectl get pod,crd -n fluent</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS        AGE</span><br><span class="line">pod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (5h20m ago)   22h</span><br><span class="line"></span><br><span class="line">NAME                                                                                        CREATED AT</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterfilters.fluentbit.fluent.io            2022-07-05T07:45:26Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterfilters.fluentd.fluent.io              2022-07-05T07:45:26Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterfluentbitconfigs.fluentbit.fluent.io   2022-07-05T07:45:26Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterfluentdconfigs.fluentd.fluent.io       2022-07-05T07:45:26Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterinputs.fluentbit.fluent.io             2022-07-05T07:45:26Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusteroutputs.fluentbit.fluent.io            2022-07-05T07:45:26Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusteroutputs.fluentd.fluent.io              2022-07-05T07:45:26Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterparsers.fluentbit.fluent.io            2022-07-05T07:45:26Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/filters.fluentd.fluent.io                     2022-07-05T07:45:27Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/fluentbits.fluentbit.fluent.io                2022-07-05T07:45:27Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/fluentdconfigs.fluentd.fluent.io              2022-07-05T07:45:27Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/fluentds.fluentd.fluent.io                    2022-07-05T07:45:27Z</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/outputs.fluentd.fluent.io                     2022-07-05T07:45:28Z</span><br></pre></td></tr></table></figure>

<h4 id="Fluent-Bit-Only-模式"><a href="#Fluent-Bit-Only-模式" class="headerlink" title="Fluent Bit Only 模式"></a>Fluent Bit Only 模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署 Fluent Bit 收集日志</span></span><br><span class="line">cat &gt; fluent-bit.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class="line">kind: FluentBit</span><br><span class="line">metadata:</span><br><span class="line">  name: fluent-bit</span><br><span class="line">  namespace: fluent</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: fluent-bit</span><br><span class="line">spec:</span><br><span class="line">  image: kubesphere/fluent-bit:v1.8.11</span><br><span class="line">  positionDB:</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /var/lib/fluent-bit/</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      cpu: 10m</span><br><span class="line">      memory: 25Mi</span><br><span class="line">    limits:</span><br><span class="line">      cpu: 500m</span><br><span class="line">      memory: 200Mi</span><br><span class="line">  fluentBitConfigName: fluent-bit-config</span><br><span class="line">  tolerations:</span><br><span class="line">    - operator: Exists</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class="line">kind: ClusterFluentBitConfig</span><br><span class="line">metadata:</span><br><span class="line">  name: fluent-bit-config</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: fluent-bit</span><br><span class="line">spec:</span><br><span class="line">  service:</span><br><span class="line">    parsersFile: parsers.conf</span><br><span class="line">  inputSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">      fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class="line">  filterSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">      fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class="line">  outputSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">      fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class="line">kind: ClusterInput</span><br><span class="line">metadata:</span><br><span class="line">  name: tail</span><br><span class="line">  labels:</span><br><span class="line">    fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">    fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class="line">spec:</span><br><span class="line">  tail:</span><br><span class="line">    tag: kube.*</span><br><span class="line">    path: /var/log/containers/*.log</span><br><span class="line">    parser: docker</span><br><span class="line">    refreshIntervalSeconds: 10</span><br><span class="line">    memBufLimit: 5MB</span><br><span class="line">    skipLongLines: true</span><br><span class="line">    db: /fluent-bit/tail/pos.db</span><br><span class="line">    dbSync: Normal</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class="line">kind: ClusterOutput</span><br><span class="line">metadata:</span><br><span class="line">  name: es</span><br><span class="line">  labels:</span><br><span class="line">    fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">    fluentbit.fluent.io/mode: &quot;k8s&quot;</span><br><span class="line">spec:</span><br><span class="line">  matchRegex: (?:kube|service)\.(.*)</span><br><span class="line">  es:</span><br><span class="line">    host: elasticsearch</span><br><span class="line">    port: 9200</span><br><span class="line">    generateID: true</span><br><span class="line">    logstashPrefix: fluent-log-fb-only</span><br><span class="line">    logstashFormat: true</span><br><span class="line">    timeKey: &quot;@timestamp&quot;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要先部署最后端日志 output 层 elasticsearch 资源</span></span><br><span class="line">kubectl apply -f elasticsearch.yaml</span><br><span class="line">kubectl apply -f fluent-bit.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看部署资源</span></span><br><span class="line">kubectl get pod,svc -n fluent</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS      AGE</span><br><span class="line">pod/es-0                               1/1     Running   1 (56m ago)   17h</span><br><span class="line">pod/fluent-bit-rjqsd                   1/1     Running   0             2m34s</span><br><span class="line">pod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (56m ago)   17h</span><br><span class="line">NAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service/elasticsearch   ClusterIP   None         &lt;none&gt;        9200/TCP,9300/TCP   17h</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">请求 Elasticsearch 搜索验证日志内容</span></span><br><span class="line">kubectl port-forward services/elasticsearch -n fluent --address 127.0.0.1 9200:9200</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看所有索引</span></span><br><span class="line">curl &quot;127.0.0.1:9200/_cat/indices?pretty&quot;</span><br><span class="line">yellow open fluent-log-fb-only-2022.07.06 lLmstFnwQLa89Jb7TFe-0Q 1 1 152 0 155.2kb 155.2kb </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看索引所有文档</span></span><br><span class="line">curl &quot;127.0.0.1:9200/fluent-log-fb-only-2022.07.06/_search?pretty&quot;</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">根据文档 ID 搜索具体日志</span></span><br><span class="line">curl &quot;127.0.0.1:9200/fluent-log-fb-only-2022.07.06/_doc/b641529e-255c-f260-f911-f7d00d84e3fe?pretty&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;fluent-log-fb-only-2022.07.06&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;b641529e-255c-f260-f911-f7d00d84e3fe&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;_seq_no&quot; : 94,</span><br><span class="line">  &quot;_primary_term&quot; : 1,</span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line">    &quot;@timestamp&quot; : &quot;2022-07-06T02:57:38.035Z&quot;,</span><br><span class="line">    &quot;log&quot; : &quot;[2022/07/06 02:57:38] [ info] [input:tail:tail.0] inotify_fs_add(): inode=2050771 watch_fd=3 name=/var/log/containers/dashboard-metrics-scraper-58549894f-q9lpg_kubernetes-dashboard_dashboard-metrics-scraper-51061ac5d9c2c7c2da734ab35b9252edb29f4101ade5679a22181d0d735dc364.log\n&quot;,</span><br><span class="line">    &quot;time&quot; : &quot;2022-07-06T02:57:38.035319145Z&quot;,</span><br><span class="line">    &quot;kubernetes&quot; : &#123;</span><br><span class="line">      &quot;pod_name&quot; : &quot;fluent-bit-8v2qn&quot;,</span><br><span class="line">      &quot;namespace_name&quot; : &quot;fluent&quot;,</span><br><span class="line">      &quot;container_name&quot; : &quot;fluent-bit&quot;,</span><br><span class="line">      &quot;docker_id&quot; : &quot;098d8ac65b201686b7a2945df6ee1a919b7220b637aea4de6490d92569c9c455&quot;,</span><br><span class="line">      &quot;container_image&quot; : &quot;kubesphere/fluent-bit:v1.8.11&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Fluent-Bit-Fluentd-模式"><a href="#Fluent-Bit-Fluentd-模式" class="headerlink" title="Fluent Bit + Fluentd 模式"></a>Fluent Bit + Fluentd 模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 Fluent Bit output 资源配置，启用 forward 插件，转发到 Fluentd</span></span><br><span class="line">cat &gt;&gt; fluent-bit.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: fluentbit.fluent.io/v1alpha2</span><br><span class="line">kind: ClusterOutput</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd</span><br><span class="line">  labels:</span><br><span class="line">    fluentbit.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">    fluentbit.fluent.io/component: logging</span><br><span class="line">spec:</span><br><span class="line">  matchRegex: (?:kube|service)\.(.*)</span><br><span class="line">  forward:</span><br><span class="line">    host: fluentd.fluent.svc</span><br><span class="line">    port: 24224</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署 Fluentd</span> </span><br><span class="line">cat &gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: Fluentd</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd</span><br><span class="line">  namespace: fluent</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: fluentd</span><br><span class="line">spec:</span><br><span class="line">  globalInputs:</span><br><span class="line">  - forward:</span><br><span class="line">      bind: 0.0.0.0</span><br><span class="line">      port: 24224</span><br><span class="line">  replicas: 1</span><br><span class="line">  image: kubesphere/fluentd:v1.14.4</span><br><span class="line">  fluentdCfgSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 Fluentd</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.使用 ClusterFluentdConfig 配置，发送 kube-system 与 default 下 namesapce 日志到 ClusterOutput</span></span><br><span class="line">cat &gt;&gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: ClusterFluentdConfig</span><br><span class="line">metadata:</span><br><span class="line">  name: cluster-fluentd-config</span><br><span class="line">  labels:</span><br><span class="line">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  watchedNamespaces:</span><br><span class="line">  - kube-system</span><br><span class="line">  - default</span><br><span class="line">  clusterOutputSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      output.fluentd.fluent.io/scope: &quot;cluster&quot;</span><br><span class="line">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: ClusterOutput</span><br><span class="line">metadata:</span><br><span class="line">  name: cluster-fluentd-output-es</span><br><span class="line">  labels:</span><br><span class="line">    output.fluentd.fluent.io/scope: &quot;cluster&quot;</span><br><span class="line">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  outputs:</span><br><span class="line">  - elasticsearch:</span><br><span class="line">      host: elasticsearch-master.elastic.svc</span><br><span class="line">      port: 9200</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: fluent-log-cluster-fd</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.使用 FluentdConfig + ClusterFluentdConfig 配置，发送集群范围和 namespace 范围日志到 Output 或 ClusterOutput</span></span><br><span class="line">cat &gt;&gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: FluentdConfig</span><br><span class="line">metadata:</span><br><span class="line">  name: namespace-fluentd-config-user1</span><br><span class="line">  namespace: fluent</span><br><span class="line">  labels:</span><br><span class="line">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  outputSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">      output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class="line">  clusterOutputSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">      output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: ClusterFluentdConfig</span><br><span class="line">metadata:</span><br><span class="line">  name: cluster-fluentd-config-cluster-only</span><br><span class="line">  labels:</span><br><span class="line">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  watchedNamespaces:</span><br><span class="line">  - kube-system</span><br><span class="line">  - kubesphere-system</span><br><span class="line">  clusterOutputSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">      output.fluentd.fluent.io/scope: &quot;cluster-only&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: Output</span><br><span class="line">metadata:</span><br><span class="line">  name: namespace-fluentd-output-user1</span><br><span class="line">  namespace: fluent</span><br><span class="line">  labels:</span><br><span class="line">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">    output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class="line">spec:</span><br><span class="line">  outputs:</span><br><span class="line">  - elasticsearch:</span><br><span class="line">      host: elasticsearch-master.elastic.svc</span><br><span class="line">      port: 9200</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: fluent-log-user1-fd</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: ClusterOutput</span><br><span class="line">metadata:</span><br><span class="line">  name: cluster-fluentd-output-user1</span><br><span class="line">  labels:</span><br><span class="line">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">    output.fluentd.fluent.io/user: &quot;user1&quot;</span><br><span class="line">spec:</span><br><span class="line">  outputs:</span><br><span class="line">  - elasticsearch:</span><br><span class="line">      host: elasticsearch-master.elastic.svc</span><br><span class="line">      port: 9200</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: fluent-log-cluster-user1-fd</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: ClusterOutput</span><br><span class="line">metadata:</span><br><span class="line">  name: cluster-fluentd-output-cluster-only</span><br><span class="line">  labels:</span><br><span class="line">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">    output.fluentd.fluent.io/scope: &quot;cluster-only&quot;</span><br><span class="line">spec:</span><br><span class="line">  outputs:</span><br><span class="line">  - elasticsearch:</span><br><span class="line">      host: elasticsearch-master.elastic.svc</span><br><span class="line">      port: 9200</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: fluent-log-cluster-only-fd</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Fluentd 输出使用 buffer 缓冲区</span></span><br><span class="line">cat &gt;&gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: ClusterOutput</span><br><span class="line">metadata:</span><br><span class="line">  name: cluster-fluentd-output-buffer</span><br><span class="line">  labels:</span><br><span class="line">    output.fluentd.fluent.io/type: &quot;buffer&quot;</span><br><span class="line">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  outputs:</span><br><span class="line">  - stdout: &#123;&#125;</span><br><span class="line">    buffer:</span><br><span class="line">      type: file</span><br><span class="line">      path: /buffers/stdout.log</span><br><span class="line">  - elasticsearch:</span><br><span class="line">      host: elasticsearch-master.elastic.svc</span><br><span class="line">      port: 9200</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: fluent-log-buffer-fd</span><br><span class="line">    buffer:</span><br><span class="line">      type: file</span><br><span class="line">      path: /buffers/es.log</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Fluentd-Only-模式"><a href="#Fluentd-Only-模式" class="headerlink" title="Fluentd Only 模式"></a>Fluentd Only 模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; fluentd.yaml &lt;&lt; &quot;EOF&quot;</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: Fluentd</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-http</span><br><span class="line">  namespace: fluent</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: fluentd</span><br><span class="line">spec:</span><br><span class="line">  globalInputs:</span><br><span class="line">    - http:</span><br><span class="line">        bind: 0.0.0.0</span><br><span class="line">        port: 9880</span><br><span class="line">  replicas: 1</span><br><span class="line">  image: kubesphere/fluentd:v1.14.4</span><br><span class="line">  fluentdCfgSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: FluentdConfig</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-only-config</span><br><span class="line">  namespace: fluent</span><br><span class="line">  labels:</span><br><span class="line">    config.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  filterSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      filter.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class="line">      filter.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">  outputSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      output.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class="line">      output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: Filter</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-only-filter</span><br><span class="line">  namespace: fluent</span><br><span class="line">  labels:</span><br><span class="line">    filter.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class="line">    filter.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  filters:</span><br><span class="line">    - stdout: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: fluentd.fluent.io/v1alpha1</span><br><span class="line">kind: Output</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-only-stdout</span><br><span class="line">  namespace: fluent</span><br><span class="line">  labels:</span><br><span class="line">    output.fluentd.fluent.io/mode: &quot;fluentd-only&quot;</span><br><span class="line">    output.fluentd.fluent.io/enabled: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  outputs:</span><br><span class="line">    - stdout: &#123;&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看部署资源</span></span><br><span class="line">kubectl get all -n fluent</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS       AGE</span><br><span class="line">pod/es-0                               1/1     Running   1 (163m ago)   19h</span><br><span class="line">pod/fluent-operator-86858cfc87-cg4ct   1/1     Running   1 (163m ago)   19h</span><br><span class="line">pod/fluentd-http-0                     1/1     Running   0              2m53s</span><br><span class="line"></span><br><span class="line">NAME                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service/elasticsearch   ClusterIP   None         &lt;none&gt;        9200/TCP,9300/TCP   19h</span><br><span class="line">service/fluentd-http    ClusterIP   10.97.96.1   &lt;none&gt;        9880/TCP            2m54s</span><br><span class="line"></span><br><span class="line">NAME                              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/fluent-operator   1/1     1            1           19h</span><br><span class="line"></span><br><span class="line">NAME                                         DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/fluent-operator-86858cfc87   1         1         1       19h</span><br><span class="line"></span><br><span class="line">NAME                            READY   AGE</span><br><span class="line">statefulset.apps/es             1/1     19h</span><br><span class="line">statefulset.apps/fluentd-http   1/1     2m54s</span><br></pre></td></tr></table></figure>


<blockquote>
<p>参考文档：<br>1、<a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/install-efk-stack-on-k8s/">https://www.qikqiak.com/post/install-efk-stack-on-k8s/</a><br>2、fluentd 官网：<a target="_blank" rel="noopener" href="https://docs.fluentd.org/">https://docs.fluentd.org/</a><br>3、fluentd-operator 官网：<a target="_blank" rel="noopener" href="https://github.com/fluent/fluent-operator">https://github.com/fluent/fluent-operator</a><br>4、fluent-operator-walkthrough：<a target="_blank" rel="noopener" href="https://github.com/kubesphere-sigs/fluent-operator-walkthrough">https://github.com/kubesphere-sigs/fluent-operator-walkthrough</a><br>5、KubeSphere：<a target="_blank" rel="noopener" href="https://kubesphere.com.cn/blogs/fluent-operator-logging">https://kubesphere.com.cn/blogs/fluent-operator-logging</a></p>
</blockquote>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Yakir
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://359sun.top/posts/41fe.html" title="可观测性-Fluentd 日志组件">https://359sun.top/posts/41fe.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <!-- <a href="/tags/observability/" rel="tag"><i class="fa fa-tag"></i> Observability</a> -->
              <a href="/tags/observability/" rel="tag"><i class="fa fa-tag"></i> Observability</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/6bfb.html" rel="prev" title="可观测性-监控组件 Prometheus">
      <i class="fa fa-chevron-left"></i> 可观测性-监控组件 Prometheus
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/2ead.html" rel="next" title="K8S - kube-eventer 事件中心组件">
      K8S - kube-eventer 事件中心组件 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="nav-text">一、组件说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F-x2F-%E5%AE%B9%E5%99%A8%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2"><span class="nav-text">二、二进制方式 &#x2F; 容器方式部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F"><span class="nav-text">二进制方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E6%96%B9%E5%BC%8F"><span class="nav-text">容器方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="nav-text">三、配置与使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#input-%E9%85%8D%E7%BD%AE"><span class="nav-text">input 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#output-%E9%85%8D%E7%BD%AE"><span class="nav-text">output 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#parser-%E9%85%8D%E7%BD%AE"><span class="nav-text">parser 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filter-%E9%85%8D%E7%BD%AE"><span class="nav-text">filter 配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E3%80%81DaemonSet-%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2"><span class="nav-text">四、DaemonSet 方式部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-Elasticsearch-%E5%92%8C-Kibana"><span class="nav-text">部署 Elasticsearch 和 Kibana</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-Fluentd"><span class="nav-text">部署 Fluentd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E6%B5%8B%E8%AF%95%E5%BA%94%E7%94%A8%EF%BC%8C%E8%BE%93%E5%87%BA%E6%97%A5%E5%BF%97%E5%AE%B9%E5%99%A8"><span class="nav-text">部署测试应用，输出日志容器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kibana-amp-Elasticsearch-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81"><span class="nav-text">Kibana  &amp; Elasticsearch 查询数据验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%91%8A%E8%AD%A6%E5%8A%9F%E8%83%BD"><span class="nav-text">日志告警功能</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94%E3%80%81fluentd-operator-%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2"><span class="nav-text">五、fluentd-operator 方式部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CRD-%E8%B5%84%E6%BA%90"><span class="nav-text">CRD 资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-CRD-%E8%B5%84%E6%BA%90%E4%B8%8E-fluent-operator"><span class="nav-text">部署 CRD 资源与 fluent-operator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fluent-Bit-Only-%E6%A8%A1%E5%BC%8F"><span class="nav-text">Fluent Bit Only 模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fluent-Bit-Fluentd-%E6%A8%A1%E5%BC%8F"><span class="nav-text">Fluent Bit + Fluentd 模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fluentd-Only-%E6%A8%A1%E5%BC%8F"><span class="nav-text">Fluentd Only 模式</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yakir"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Yakir</p>
  <div class="site-description" itemprop="description">Yakir Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/yakir3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yakir3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>



  <div class="links-of-blogroll motion-element links-of-blogroll-block">
    <div class="links-of-blogroll-title">
      <!-- modify icon to fire by szw -->
      <i class="fa fa-history fa-" aria-hidden="true"></i>
      近期文章
    </div>
    <ul class="links-of-blogroll-list">
      
      
        <li class="recent_posts_li">
          <!--<a href="/" title="" target="_blank"></a>-->
        </li>
      
        <li class="recent_posts_li">
          <!--<a href="/" title="" target="_blank"></a>-->
        </li>
      
        <li class="recent_posts_li">
          <!--<a href="/" title="" target="_blank"></a>-->
        </li>
      
    </ul>
  </div>




      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yakir</span>
</div>
  <div class="powered-by">Powered by Hexo Next
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'dc69ab400b19bd3a1bab',
      clientSecret: '5a20b4b4faa303672257572d4df0be83b97061cb',
      repo        : 'yakir3.github.io',
      owner       : 'yakir3',
      admin       : ['yakir3'],
      id          : '58a50083355eeced42dd8f8a63eb4ba9',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
